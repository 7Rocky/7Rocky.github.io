<!doctype html><html lang="es"><head><title>Orbital | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="HTB CA 2023. Inyecci贸n de c贸digo SQL. Navegaci贸n de directorios. Lectura de archivos locales"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2023. Inyecci贸n de c贸digo SQL. Navegaci贸n de directorios. Lectura de archivos locales"><meta itemprop="keywords" content><meta itemprop="name" content="Orbital"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="HTB CA 2023. Inyecci贸n de c贸digo SQL. Navegaci贸n de directorios. Lectura de archivos locales"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Orbital"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/orbital/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="HTB CA 2023. Inyecci贸n de c贸digo SQL. Navegaci贸n de directorios. Lectura de archivos locales"><meta name="twitter:description" content="HTB CA 2023. Inyecci贸n de c贸digo SQL. Navegaci贸n de directorios. Lectura de archivos locales"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Orbital"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/orbital/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><script>alert("Buy me a beer plz")</script><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/htb-cyber-apocalypse/orbital/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/orbital/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/orbital/&amp;text=Orbital" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/orbital/&amp;title=Orbital" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Orbital</h1><p class="mb4 f6 dib tracked">4 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</a></li><li><a href="#explotaci贸n-de-sqli">Explotaci贸n de SQLi</a></li><li><a href="#explotaci贸n-de-lfr">Explotaci贸n de LFR</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un sitio web como este:</p><p><img alt="Orbital 1" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-1.webp"></p><p>Tambi茅n tenemos el c贸digo fuente en Python.</p><h2 id="an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</h2><p>La aplicaci贸n web est谩 construida con Flask. Se puede encontrar una vulnerabilidad clara de inyecci贸n SQL (SQLi) en <code>database.py</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">colorama</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">Cursor</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">application</span><span class="mtk1">.</span><span class="mtk8 mtku">util</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">createJWT</span><span class="mtk1">, </span><span class="mtk8">passwordVerify</span>
<span class="mtk5">from</span><span class="mtk1"> flask_mysqldb </span><span class="mtk5">import</span><span class="mtk1"> MySQL</span>

<span class="mtk1">mysql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> MySQL()</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">query</span><span class="mtk1">(</span><span class="mtk9 mtki">query</span><span class="mtk1">, </span><span class="mtk9 mtki">args</span><span class="mtk5">=</span><span class="mtk1">(), </span><span class="mtk9 mtki">one</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">mysql</span><span class="mtk1">.connection.cursor()</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk9 mtki">query</span><span class="mtk1">, </span><span class="mtk9 mtki">args</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">rv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8 mtku">dict</span><span class="mtk1">((</span><span class="mtk1">cursor</span><span class="mtk1">.description[</span><span class="mtk1">idx</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk1">value</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1">, </span><span class="mtk1">value</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk1">row</span><span class="mtk1">)) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">row</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()]</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk1">rv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">rv</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">) </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">one</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk1">rv</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">login</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># I don't think it's not possible to bypass login </span><span class="mtk3">because I'm verifying the password later.</span>
<span class="mtk1">    </span><span class="mtk1">user</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">query</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'SELECT username, password FROM users WHERE userna</span><span class="mtk4">me = "</span><span class="mtk6">{</span><span class="mtk9 mtki">username</span><span class="mtk6">}</span><span class="mtk4">"'</span><span class="mtk1">, </span><span class="mtk9 mtki">one</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">user</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">passwordCheck</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">passwordVerify</span><span class="mtk1">(</span><span class="mtk1">user</span><span class="mtk1">[</span><span class="mtk4">'password'</span><span class="mtk1">], </span><span class="mtk9 mtki">password</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">passwordCheck</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createJWT</span><span class="mtk1">(</span><span class="mtk1">user</span><span class="mtk1">[</span><span class="mtk4">'username'</span><span class="mtk1">])</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">token</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">getCommunication</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">query</span><span class="mtk1">(</span><span class="mtk4">'SELECT * from communication'</span><span class="mtk1">)</span>
</code></pre></div><p>Adem谩s, la contrase帽a se verifica contra un <em>hash</em> MD5:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">passwordVerify</span><span class="mtk1">(</span><span class="mtk9 mtki">hashPassword</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">md5Hash</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1">.</span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk9 mtki">password</span><span class="mtk1">.encode())</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">md5Hash</span><span class="mtk1">.</span><span class="mtk8">hexdigest</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">hashPassword</span><span class="mtk1">: </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">: </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">isAuthenticated</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk8">@</span><span class="mtk8">wraps</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decorator</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk9 mtki">args</span><span class="mtk1">, </span><span class="mtk5">**</span><span class="mtk9 mtki">kwargs</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">session</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'auth'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">abort</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">, </span><span class="mtk4">'Unauthorised access detected!'</span><span class="mtk1">)</span>  

<span class="mtk1">        </span><span class="mtk8">verifyJWT</span><span class="mtk1">(</span><span class="mtk1">token</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">f</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk9 mtki">args</span><span class="mtk1">, </span><span class="mtk5">**</span><span class="mtk9 mtki">kwargs</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">decorator</span>
</code></pre></div><p>Si analizamos <code>blueprints/routes.py</code> vemos que mientras estemos autenticados, podremos acceder a <code>/export</code>, que es un <em>endpoint</em> que nos permite descargar archivos del servidor. Aqu铆 podemos realizar un ataque de navegaci贸n de directorios (<code>../</code>) y obtener una vulnerabilidad de lectura de archivo locales (<em>Local File Read</em>). Esto nos sirve para exfiltrar archivos confidenciales del servidor (por ejemplo, la <em>flag</em>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">@</span><span class="mtk1">api</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/export'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'POST'</span><span class="mtk1">])</span>
<span class="mtk8">@</span><span class="mtk8">isAuthenticated</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">exportFile</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">is_json</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Invalid JSON!'</span><span class="mtk1">), </span><span class="mtk6">400</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk8">get_json</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">communicationName</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">.get(</span><span class="mtk4">'name'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk3"># Everyone is saying I should escape specific char</span><span class="mtk3">acters in the filename. I don't know why.</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">send_file</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'/communications/</span><span class="mtk6">{</span><span class="mtk1">communicationName</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk9 mtki">as_attachment</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Unable to retrieve the communication'</span><span class="mtk1">), </span><span class="mtk6">400</span>
</code></pre></div><h2 id="explotaci贸n-de-sqli">Explotaci贸n de SQLi</h2><p>La vulnerabilidad existe porque el servidor ingresa a la variable <code>username</code> directamente en la consulta, suponiendo que la variable no contiene nada malicioso. Si usamos una comilla doble, la sintaxis de consulta se modificar谩 y podr铆amos controlar la base de datos completa.</p><p>Observe que la consulta debe devolver un nombre de usuario y un <em>hash</em> que coincida con el <em>hash</em> de la contrase帽a introducida en el formulario de inicio de sesi贸n (debido al comentario y el m茅todo de autenticaci贸n implementado).</p><p>Podemos hacer esto usando una consulta <code>UNION</code> como esta:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">SELECT</span><span class="mtk1"> username, </span><span class="mtk5">password</span><span class="mtk1"> </span><span class="mtk5">FROM</span><span class="mtk1"> users </span><span class="mtk5">WHERE</span><span class="mtk1"> username </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> </span><span class="mtk5">UNION</span><span class="mtk1"> </span><span class="mtk5">SELECT</span><span class="mtk1"> </span><span class="mtk4">"&lt;user&gt;"</span><span class="mtk1">, </span><span class="mtk4">"&lt;password-hash&gt;"</span>  
</code></pre></div><p>Echando un vistazo a <code>entrypoint.sh</code>, vemos que hay un usuario llamado <code>admin</code>. Esta ser谩 nuestra v铆ctima. La contrase帽a que estableceremos es <code>asdf</code>. Por lo tanto, ingresaremos la siguiente cadena en el campo de usuario:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">" UNION SELECT "admin", "912ec803b2ce49e4a541068d495ab570  
</code></pre></div><p>Observe que el <em>hash</em> MD5 para <code>asdf</code> es:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n asdf | <span class="code-dark-green">md5sum</span>
912ec803b2ce49e4a541068d495ab570  -  
</code></pre></div><p><img alt="Orbital 2" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-2.webp"></p><p>Y estamos dentro:</p><p><img alt="Orbital 3" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-3.webp"></p><h2 id="explotaci贸n-de-lfr">Explotaci贸n de LFR</h2><p>La funcionalidad de exportaci贸n est谩 en la parte inferior de la p谩gina:</p><p><img alt="Orbital 4" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-4.webp"></p><p>Podemos usar Burp Suite (Repeater) para analizar la petici贸n y la respuesta:</p><p><img alt="Orbital 5" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-5.webp"></p><p>Como prueba de concepto, podemos leer el archivo <code>/etc/passwd</code> usando la navegaci贸n de directorios (<em>Directory Traversal</em>):</p><p><img alt="Orbital 6" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-6.webp"></p><p>Antes de solicitar la <em>flag</em>, debemos verificar cu谩l es el nombre de archivo exacto. En el <code>Dockerfile</code>, vemos que se copia como <code>signal_sleuth_firmware</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> </span><span class="mtk8 mtku detected-link">python</span><span class="mtk1">:</span><span class="mtk1">3.8-alpine</span>

<span class="mtk3"># Install packages</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">apk</span><span class="mtk1"> </span><span class="mtk9 mtki">add</span><span class="mtk1"> </span><span class="mtk9 mtki">--no-cache</span><span class="mtk1"> </span><span class="mtk9 mtki">--update</span><span class="mtk1"> </span><span class="mtk9 mtki">mariadb</span><span class="mtk1"> </span><span class="mtk9 mtki">mariadb-client</span><span class="mtk1"> </span><span class="mtk9 mtki">supervisor</span><span class="mtk1"> </span><span class="mtk9 mtki">gcc</span><span class="mtk1"> </span><span class="mtk9 mtki">musl-dev</span><span class="mtk1"> </span><span class="mtk9 mtki">mariadb-connector-c-dev</span>  

<span class="mtk3"># Upgrade pip</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">python</span><span class="mtk1"> </span><span class="mtk9 mtki">-m</span><span class="mtk1"> </span><span class="mtk9 mtki">pip</span><span class="mtk1"> </span><span class="mtk9 mtki">install</span><span class="mtk1"> </span><span class="mtk9 mtki">--upgrade</span><span class="mtk1"> </span><span class="mtk9 mtki">pip</span>

<span class="mtk3"># Install dependencies</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">pip</span><span class="mtk1"> </span><span class="mtk9 mtki">install</span><span class="mtk1"> </span><span class="mtk9 mtki">Flask</span><span class="mtk1"> </span><span class="mtk9 mtki">flask_mysqldb</span><span class="mtk1"> </span><span class="mtk9 mtki">pyjwt</span><span class="mtk1"> </span><span class="mtk9 mtki">colorama</span>

<span class="mtk3"># Setup app</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">mkdir</span><span class="mtk1"> </span><span class="mtk9 mtki">-p</span><span class="mtk1"> </span><span class="mtk9 mtki">/app</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">mkdir</span><span class="mtk1"> </span><span class="mtk9 mtki">-p</span><span class="mtk1"> </span><span class="mtk9 mtki">/communication</span>

<span class="mtk3"># Switch working environment</span>
<span class="mtk5">WORKDIR</span><span class="mtk1"> </span><span class="mtk9 mtki">/app</span>

<span class="mtk3"># Add application</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">challenge</span><span class="mtk1"> </span><span class="mtk9 mtki">.</span>

<span class="mtk3"># Setup supervisor</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">config/supervisord.conf</span><span class="mtk1"> </span><span class="mtk9 mtki">/etc/supervisord.conf</span>

<span class="mtk3"># Expose port the server is reachable on</span>
<span class="mtk5">EXPOSE</span><span class="mtk1"> </span><span class="mtk9 mtki">1337</span>

<span class="mtk3"># Disable pycache</span>
<span class="mtk5">ENV</span><span class="mtk1"> </span><span class="mtk1">PYTHONDONTWRITEBYTECODE</span><span class="mtk5">=</span><span class="mtk9 mtki">1</span>

<span class="mtk3"># copy flag</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">flag.txt</span><span class="mtk1"> </span><span class="mtk9 mtki">/signal_sleuth_firmware</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">files</span><span class="mtk1"> </span><span class="mtk9 mtki">/communications/</span>

<span class="mtk3"># create database and start supervisord</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">--chown</span><span class="mtk5">=</span><span class="mtk1">root</span><span class="mtk1"> </span><span class="mtk9 mtki">entrypoint.sh</span><span class="mtk1"> </span><span class="mtk9 mtki">/entrypoint.sh</span>
<span class="mtk5">RUN</span><span class="mtk1"> </span><span class="mtk9 mtki">chmod</span><span class="mtk1"> </span><span class="mtk9 mtki">+x</span><span class="mtk1"> </span><span class="mtk9 mtki">/entrypoint.sh</span>
<span class="mtk5">ENTRYPOINT</span><span class="mtk1"> </span><span class="mtk9 mtki">[</span><span class="mtk4">"/entrypoint.sh"</span><span class="mtk9 mtki">]</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Entonces, leamos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">HTB{T1m3_b4$3d_$ql1_4r3_fun!!!}  
</code></pre></div><p><img alt="Orbital 7" src="/images/other/HTB%20Cyber%20Apocalypse%202023/Orbital-7.webp"></p><p>En realidad, la <em>flag</em> hace referencia a SQLi basado en tiempo, que es una t茅cnica utilizada para volcar campos de la base de datos por caracteres (uno por uno) usando un or谩culo de tiempo. Es posible usar herramientas como <code>sqlmap</code> para automatizar el ataque. Sin embargo, el enfoque de <em>Union-based</em> SQLi tambi茅n es v谩lido e incluso m谩s inteligente.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</a></li><li><a href="#explotaci贸n-de-sqli">Explotaci贸n de SQLi</a></li><li><a href="#explotaci贸n-de-lfr">Explotaci贸n de LFR</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de res煤menes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>