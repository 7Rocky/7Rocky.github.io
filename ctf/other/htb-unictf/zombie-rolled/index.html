<!doctype html><html lang="es"><head><title>Zombie Rolled | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="HTB UniCTF 2023. Fracciones. GCD. Firma RSA. Método de Coppersmith en polinomio de dos variables"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB UniCTF 2023. Fracciones. GCD. Firma RSA. Método de Coppersmith en polinomio de dos variables"><meta itemprop="keywords" content><meta itemprop="name" content="Zombie Rolled"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="HTB UniCTF 2023. Fracciones. GCD. Firma RSA. Método de Coppersmith en polinomio de dos variables"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Zombie Rolled"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/htb-unictf/zombie-rolled/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="HTB UniCTF 2023. Fracciones. GCD. Firma RSA. Método de Coppersmith en polinomio de dos variables"><meta name="twitter:description" content="HTB UniCTF 2023. Fracciones. GCD. Firma RSA. Método de Coppersmith en polinomio de dos variables"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Zombie Rolled"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/htb-unictf/zombie-rolled/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/htb-unictf/zombie-rolled/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/htb-unictf/zombie-rolled/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/htb-unictf/zombie-rolled/&amp;text=Zombie%20Rolled" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/htb-unictf/zombie-rolled/&amp;title=Zombie%20Rolled" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Zombie Rolled</h1><p class="mb4 f6 dib tracked">10 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#generación-de-claves-públicas">Generación de claves públicas</a></li><li><a href="#cifrado-y-descifrado">Cifrado y descifrado</a></li><li><a href="#firma-y-proceso-de-verificación">Firma y proceso de verificación</a></li></ul></li><li><a href="#solución">Solución</a></li><li><a href="#implementación-en-sagemath">Implementación en SageMath</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el código fuente en Python para cifrar la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">, </span><span class="mtk8">bytes_to_long</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">fractions</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">math</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">prod</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">sha256</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secrets</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">randbelow</span>

<span class="mtk3"># I hope no one cares about Kerckhoff's principle </span><span class="mtk3">:)</span>
<span class="mtk5">from</span><span class="mtk1"> secret </span><span class="mtk5">import</span><span class="mtk1"> derive_public_key, </span><span class="mtk6">FLAG</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">f</span><span class="mtk1">.numerator </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">.denominator, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PublicKey</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pub</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">8</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">s1</span><span class="mtk1">, </span><span class="mtk1">s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span>
<span class="mtk1">        </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.to_bytes(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">, </span><span class="mtk4">"big"</span><span class="mtk1">)).</span><span class="mtk8">digest</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk1">h</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">s1</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">s2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">((</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)), </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">r</span>  

<span class="mtk1">    </span><span class="mtk8">@</span><span class="mtk8 mtku">staticmethod</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">ar</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">ar</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">) </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PrivateKey</span><span class="mtk1">(</span><span class="mtk8 mtku">PublicKey</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">priv</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8 mtku">super</span><span class="mtk1">().</span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">priv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">raise</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">(</span><span class="mtk4">"Invalid key pair"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk8">prod</span><span class="mtk1">([</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span><span class="mtk1">]))</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">c</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.to_bytes(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">, </span><span class="mtk4">"big"</span><span class="mtk1">)).</span><span class="mtk8">digest</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk1">h</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">((</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)), </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">s1</span><span class="mtk1">, </span><span class="mtk1">s2</span>

<span class="mtk1">    </span><span class="mtk8">@</span><span class="mtk8 mtku">staticmethod</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">nbits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">tuple</span><span class="mtk1">([</span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">nbits</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">)])</span>
<span class="mtk1">                </span><span class="mtk1">pub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> derive_public_key(</span><span class="mtk1">priv</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">PrivateKey</span><span class="mtk1">(</span><span class="mtk1">priv</span><span class="mtk1">, </span><span class="mtk1">pub</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk6">FLAG</span><span class="mtk1">) </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">64</span>
<span class="mtk1">    </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk6">FLAG</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">PrivateKey</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk6">1024</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"pub = </span><span class="mtk6">{</span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk1">pub</span><span class="mtk6">}\n</span><span class="mtk4">"</span>

<span class="mtk1">    </span><span class="mtk3"># make sure it really works</span>
<span class="mtk1">    </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">m</span>
<span class="mtk1">    </span><span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">sig</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk3"># mixing them :)</span>
<span class="mtk1">    </span><span class="mtk1">mix</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]]</span>
<span class="mtk1">    </span><span class="mtk1">mix</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">mix</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"mix = </span><span class="mtk6">{</span><span class="mtk1">mix</span><span class="mtk6">}</span><span class="mtk4">"</span>

<span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"output.txt"</span><span class="mtk1">, </span><span class="mtk4">"w"</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">)</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"__main__"</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Y tenemos el resultado en <code>output.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">pub = (-679149827688896546432684514781159016843208241259733038415608446794483893865137935606244643075224614588255514670703135466975466970913232919448971056463765967267932205245723609028669700790327888053737513173004906874791948794706164874163000233242663467112356684022940655151358257782991132383407917101800634477163967250047209128395271227452766580073122831277123102243705154267181506512402418039719173720827696442606604970528063168565779813124052546633103006687964589521475168208905582555230534709754318532234948569155566965251016769141273474050547777208930826949494111933369822606247918218189742785296490363879808413854798453415486721083351760540440727104905848109665720749305468099771944894375713469720303756620101486771358570935901473647573434771209918671576552610105681029288935780171889489032033021940200657122568137703155744190258342713712412791279147013204380608939099412456303268575877533613186703629403608506029153274825614231950222036769768440858686468414798013424323765200986740221652787739657510451377763752151261173701557996570807100005672113902309356835881522886670894124683065117547063607171455016275575226133973000898546626428525316423640294588059582425678225307973026140509236726222895277593502658123536454581741258241350319709620218946214665277722917625163484143287737560990362641167985157948128093478633332215687808673326510025966928820082371826010204772434810834908522239370003521927141674940923107924718589020116481655436804371698576313448620651274568714018039959665606305466508336068792512300330447079049391998121903628542300433666064229921580215835067999800174889123776199641564914760737600821953293714498453721075798275047009255942697608822458887368884228615671991262750899422262693397993810261279502497616420217291365257434988696383465213630804193810674969275499135895349396517300341694326130217329147937575188985044945549854453507141533817669145401648967346307076924815850188448842044898686784928539015228772201838211426957234107261809629639488140342429501192224120877838900600824055655563831019772958581350347081393942024086716044621385448218128870528968546874044728000006962970494893355352673283507468842799994294656025864551101856509528014985899203160260433154506345617010883888392862375738238905192516684056280710225432696655387350661830299769543107006018477779636761481812001885777307338070488998064732654317341303970152707374877928275562177058710127753099319277046999346991319018270073503529254012239006330090621492580837121246383935, -62076393535220713230211372773016154819776973272085279510651810925567779949353129946722665324346680014266486318715153201960740792449256110092242298637141869182191301801348471698842750492673269805386405258903922775271516275959471007270470783319809938344980989030858451767810558937769006054050097442784355926821230070379192555314422288851726919132047206078443630648828611342794053179031715333055698280449463491394083273880477510623203232349139229518535496279365263598613132079698328994631219260929529014155663831397189773051194410051588749692352737665469175569662944453505412436038259868251153299961933349760369897472364513246615362132669886696823052680175413762753451532554603896709930434997447861155715656069046149639262746319959746238179869888630675350046188185867904504017641487194302334327723755607524433514488406681046596968802669158589535873655500657057147028422069215178280598799698023523842357762349312690981167196137904038634376059163646848305423446194854985523208266633269733804799399607579721802215740994923964998077749276376011664190442983045021233328860583431325491398740404717916957583624416525249155775990424790364048060223994351310834002052812950138181225201366866314173709814344726454058400929651246654127831150461139153521780070432541564467256212600334416658092578286615407601260752708323965051595729545763555521745630970189873094019504197470499857463907805936270010647572788276449685684281797985033841971693243345694540270555091524839897049609610694927649006414175285808616559721550306026476105719357460921592355959150692653059587214522745084239909633381558412919917765258331958067109432311999676460754436818201240023311791169802096388297862219517745888298152485206376817292783209092101414045488990410966964411575840592166475524123368782667715013887175556663844953274929494297381264202051980047425186510319292378252632808136510156368067796082090881873863176619957188519245758562409606283750005034060349233190765189422774601110274372976258448740486162640303554541285690390642874100570657406690134508272681549727638076837266298852607372446728482637226932907561200761597573567176950238238261414346592107964949875193908993522612254840698757416962124520050724327233377985303460697496676181895430294259015494830416056429816116680627673230428123227550005209799526871524994673920145445281764352654447538983391735348123813851971146216997750793741632897137346289689048299843427272709114665386119324590006011517253390435055796456069897547662246663469050, 7830486145829508377558227408290134666403414818680891369176645894657730719560462345413647777035691365258303368067215176543275998927964954949936712360465415742305180023074796925974228987920346807337046972890048193675380148777690313974213732587383856306544481992804522271933234142582135631837143021763752036371144162337258022513117655962693146611295672219977744995976478481618309460588961678471875936477345228279163041888319063508894362501867902730894177063341454634424454782062634032617628985824505983759212857299828749995752235758280573881085074326788874659358083585790319249788052723728978677280818302159890013608215097544022503686764809254320162354127388898310054146477537454655331114752144580956313131601466170634129721047436217501010686515461442226299103956329529388095001070391385189826814864746360320333918929686149324974844514612649731799514398645742580625276435924292653289878873850265379360271050603859206438004883855432886650553014115919828422317294957226985270768975519537120458232477529774162488973095316791366021139626153997771391194348622350835846276300080551743631687665470499546808409919692234446116541139972549724015591941496221132694347053824568526998941915494190313922421141792712177850635304804853629529860738709134170021521102700328604628927875567294032063066171031633521264813050524393039049915547228949811888603458908961700972119089383547482638110428947454915597289453149684921808588155575892869551719408017163519505152564311034805403584244791464453674297092713220925531618514351406361895037695504970845118751396728421079695580995084470838685511076186640881628743480208128654755986540162228797182203097429878571055580982419910698271318560371375725624590383889293031827343721601921283218257563981664825233636121202430668321472633600201081855377049584327600961474706457007803948936824801776548939412019028877381656854352042881659133167174502453362966793813997989646037370005971535903722675701268453950616768210577721799262016472978512795971976360288455246627122308235526400041892494207712587655624310348101802715615388185255043745377008056152447575197765696754537890671347192620664952431667401070828663411172784617836559669320812607668877073449814900939924918858434664371233944816438544081459935797541138873496291375791704149531348074915907756350500006241339201669154574473335111528050064627331874217370202929428747238792910498913366471880111057711710182734506773946328772476941505432386559666283038340899500750365525879310436221464632932)  
mix = [320097670159304209872309549471930993417143388077612479497520462342663934977666619462544724222917378443968580805422580825361629081490271425796180005007150747981294833573665302687843134857904098195466433204039058015530152552325684827139190765614362244643766711802006240778166882116884363374725459551909065104305033828828854239454604753713577854447476580313858442898211797176449603725270483947895282965175447381948570185109212852155846189091780576621552251326144055737198080348963003230356855332599698331598994549981281612662608348841085666739363070407550100107611043508427316142601784200258788876751333421411315222696828075445887895455540798110282831853710380354729703219505108629359197051336831375142595785378662848001960222878291497005997865756885831339332471275732796885611507451753622271015336628712225776167393560183733898486530850953580390452793438185371865569655507768389802668508433717577899938841236692983646823027361, 349362680724100439001784418744128033820777004106762219940030797663423035126842789961301765825984790980690057949860749399355278228450692377224412215897507215190015109832483673402204604232784701242900565985678019980900605960003183528535025133581067044874804468687010880739758605406077761031350401248992459970793003097988643424534679899913404629630391199540164124586883472387639995010304310446530364782969667797609685774685940403053235307671556459857310584515167273597080744839887558160920716970032955099943334650018552259294137522684003806871855045036984303040298988654317845297423677227040203951111165862748444474516781528350286768742283071330157900311167729282004019891879048809487509974878771126244472706852271120669147203065908414503160273025384004067262219422586521719641783916408458322110103608436662590492232330298616191719127365835397875038644290248233827642595125378514596518087399154247594983235918109876187387712452]
</code></pre></div><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>El servidor genera 3 números primos $p$, $q$ y $r$, que forman la clave privada.</p><h3 id="generación-de-claves-públicas">Generación de claves públicas</h3><p>Hay una función desconocida llamada <code>derive_public_key</code> que se usa para obtener una clave pública a partir de la privada. El comentario sobre los <a target="_blank" href="https://es.wikipedia.org/wiki/Principios_de_Kerckhoffs">principios de Kerckhoff</a> es relevante aquí porque este enfoque es de seguridad a través de la oscuridad, lo que no siempre es seguro. Los principios de Kerckhoff establecen que la seguridad debe confiar en las claves, en lugar de los algoritmos.</p><p>El resultado de <code>derive_public_key</code> es una lista de 3 números, dados a nosotros.</p><p>Estos números de clave pública se transforman con <code>magic</code>:</p><p class="scroll">$$
\mathrm{magic}(a, b, c) = \frac{a}{b} + \frac{b}{c} + \frac{c}{a} = \frac{a^2 c + b^2 a + c^2 b}{abc}
$$</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">ar</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">ar</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">) </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk8 mtku">Fraction</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">)</span>  
</code></pre></div><p>Podemos aplicar <code>magic</code> a los 3 números de la clave pública y obtener una fracción $f$ con numerator $N$ y denominador $D$. Estos dos valores se utilizan en el resto del <em>script</em>.</p><h3 id="cifrado-y-descifrado">Cifrado y descifrado</h3><p>Para cifrar un mensaje, el servidor toma el mensaje $m$ en formato decimal y calcula $\mathrm{ct}$:</p><p class="scroll">$$
\mathrm{ct} = m^N \mod{D}
$$</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>  
</code></pre></div><p>Para descifrar, el servidor calcula</p><p class="scroll">$$
m = \mathrm{ct}^d \mod{D} \qquad d = N^{-1} \mod{(p - 1) (q - 1) (r - 1)}
$$</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk8">prod</span><span class="mtk1">([</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span><span class="mtk1">]))</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">c</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>
</code></pre></div><p>El código también nos muestra que ambas funciones tienen el comportamiento esperado, y que son inversas:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk3"># make sure it really works</span>
<span class="mtk1">    </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">m</span>  
<span class="mtk1">    </span><span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">sig</span><span class="mtk1">)</span>
</code></pre></div><h3 id="firma-y-proceso-de-verificación">Firma y proceso de verificación</h3><p>Como se puede ver, también hay una firma y rutinas de verificación que funcionan como se esperaba.</p><p>Para firmar, el servidor toma el mensaje $m$, su <em>hash</em> SHA256 $h$ y un valor aleatorio $c$ para calcular $\mathrm{magic}(m, h, c) = \frac{A}{B}$.</p><p>Los valores $A$ y $B$ se utilizan para calcular $R = A \cdot B^{-1} \mod{D}$ con <code>fraction_mod</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">f</span><span class="mtk1">.numerator </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">f</span><span class="mtk1">.denominator, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span>  
</code></pre></div><p>La firma es solo un par de valores:</p><p class="scroll">$$
(s_1, s_2) = (R^d, c^d) \mod{D}
$$</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.to_bytes(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">, </span><span class="mtk4">"big"</span><span class="mtk1">)).</span><span class="mtk8">digest</span><span class="mtk1">())</span>  
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk1">h</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">((</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)), </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">s1</span><span class="mtk1">, </span><span class="mtk1">s2</span>
</code></pre></div><p>La función de verificación toma el mensaje y los valores $(s_1, s_2)$ para realizar casi las mismas operaciones. Primero, encuentra $R = s_1^N \mod{D}$ y $c = s_2^N \mod{D}$, luego lo compara con el valor esperado de $R$ usando $m$, $h$ y $c$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">s1</span><span class="mtk1">, </span><span class="mtk1">s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span>
<span class="mtk1">        </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.to_bytes(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1">, </span><span class="mtk4">"big"</span><span class="mtk1">)).</span><span class="mtk8">digest</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk1">h</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">s1</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">s2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">fraction_mod</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">((</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)), </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">r</span>  
</code></pre></div><p>Se nos dan algunos valores relacionados con la firma de la <em>flag</em>. Específicamente, tenemos $(s_1 + s_2)^N \mod{D}$ y $(s_1 - s_2)^N \mod{D}$, donde $(s_1, s_2)$ es la firma de la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk3"># mixing them :)</span>
<span class="mtk1">    </span><span class="mtk1">mix</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">sig</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]]</span>  
<span class="mtk1">    </span><span class="mtk1">mix</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">mix</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"mix = </span><span class="mtk6">{</span><span class="mtk1">mix</span><span class="mtk6">}</span><span class="mtk4">"</span>
</code></pre></div><h2 id="solución">Solución</h2><p>Ya que sabemos que <code>encrypt</code> y <code>decrypt</code> son funciones inversas y que funciona bien. En comparación con un RSA clásico, tenemos $N$ como el exponente público y $D$ como el módulo público. Por lo tanto, para descifrar, necesitamos encontrar el exponente privado, que debe ser $d = N^{-1} \mod{\phi(D)}$. El servidor realmente calcula $d = N^{-1} \mod{(p - 1) (q - 1) (r - 1)}$. Este hecho determina que $\phi(D) = (p - 1) (q - 1) (r - 1)$ y por tanto $D = pqr$.</p><p>Por otro lado, el método estático <code>generate_key</code> de <code>PrivateKey</code> genera la clave privada y deriva la pública. Luego, devuelve una instancia de <code>PrivateKey</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">@</span><span class="mtk8 mtku">staticmethod</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">nbits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">tuple</span><span class="mtk1">([</span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">nbits</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">)])</span>  
<span class="mtk1">                </span><span class="mtk1">pub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> derive_public_key(</span><span class="mtk1">priv</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">PrivateKey</span><span class="mtk1">(</span><span class="mtk1">priv</span><span class="mtk1">, </span><span class="mtk1">pub</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>
</code></pre></div><p>El constructor hace lo siguiente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PrivateKey</span><span class="mtk1">(</span><span class="mtk8 mtku">PublicKey</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">priv</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8 mtku">super</span><span class="mtk1">().</span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">priv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">raise</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">(</span><span class="mtk4">"Invalid key pair"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk8">prod</span><span class="mtk1">([</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span><span class="mtk1">]))</span>  
</code></pre></div><p>La clase <code>PrivateKey</code> hereda de <code>PublicKey</code>, y su constructor se llama con la clave pública:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PublicKey</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pub</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nb</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">8</span>  
</code></pre></div><p>Aquí, el valor de la fracción <code>f</code> se calcula, que contiene numerador $N$ y denominador $D$.</p><p>Pero mira esta comprobación:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk9 mtki">priv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">raise</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">(</span><span class="mtk4">"Invalid key pair"</span><span class="mtk1">)</span>  
</code></pre></div><p>Este hecho nos dice que $N$ y $D$, que son el resultado de <code>magic</code> y la clave pública (digamos $P$, $Q$, $R$) debe satisfacer que</p><p class="scroll">$$
f = \mathrm{magic}(P, Q, R) = \frac{P}{Q} + \frac{Q}{R} + \frac{R}{Q} = \frac{P^2 R + Q^2 P + R^2 Q}{PQR} = \frac{N}{D}
$$</p><p>Pero recordemos que $D = pqr$, que significa que $PQR = k \cdot pqr$ para algún $k \in \mathbb{Z}$. Por otro lado,</p><p class="scroll">$$
\mathrm{magic}(p, q, r) = \frac{p^2 r + q^2 p + r^2 q}{pqr} = \frac{N}{D}
$$</p><p>Como resultado, tenemos eso</p><p class="scroll">$$
\begin{cases}
N = p^2 r + q^2 p + r^2 q \\
D = pqr
\end{cases}
$$</p><p>Mientras hacía pruebas en en Python, descubrí que</p><p class="scroll">$$
\begin{cases}
PQR \equiv 0 \pmod{D} \\
PQR \equiv 0 \pmod{D^2} \\
PQR \not\equiv 0 \pmod{D^3}
\end{cases}
$$</p><p>También, $P, Q, R \not\equiv 0 \pmod{D}$, pero</p><p class="scroll">$$
\begin{cases}
PQ \equiv 0 \pmod{D} \\
QR \equiv 0 \pmod{D} \\
RP \equiv 0 \pmod{D}
\end{cases} \qquad \begin{cases}
PQ \not\equiv 0 \pmod{D^2} \\
QR \not\equiv 0 \pmod{D^2} \\
RP \not\equiv 0 \pmod{D^2}
\end{cases}
$$</p><p>Esto significa que $PQR$ es un múltiplo de $(pqr)^2$, pero en cada par $PQ$, $QR$, $RP$, solo podemos factorizar $(pqr)$. Después de algunos intentos, podemos encontrar la siguiente estructura:</p><p class="scroll">$$
P = \alpha \cdot p q \qquad Q = \beta \cdot q r \qquad R = \gamma \cdot r p
$$</p><p>para algunos enteros $\alpha$ $\beta$ y $\gamma$. Las relaciones anteriores funcionan ya que</p><p class="scroll">$$
\begin{cases}
PQR = \alpha\beta\gamma \cdot p^2 q^2 r^2 \equiv 0 \pmod{D^2} \\
PQ = \alpha\beta \cdot p q^2 r \equiv 0 \pmod{D} \\
QR = \beta\gamma \cdot p q r^2 \equiv 0 \pmod{D} \\
RP = \gamma\alpha \cdot p^2 q r \equiv 0 \pmod{D}
\end{cases}
$$</p><p>Por lo tanto, tenemos</p><p class="scroll">$$
\begin{cases}
\gcd{(Q, D)} = \gcd{(\beta \cdot q r, p q r)} = q r \\
\gcd{(R, D)} = \gcd{(\gamma \cdot r p, p q r)} = p r
\end{cases}
$$</p><p>Y así, $r = \gcd{(\gcd{(Q, D)}, \gcd{(R, D)})}$. Trivialmente, encontramos $p$ y $q$.</p><p>Una vez que tenemos $p$, $q$ y $r$ podemos calcular $d = N^{-1} \mod{\phi(D)}$ y descifrar el <code>mix</code> que tenemos. Además, podemos encontrar $s_1$ y $s_2$. Recordemos los valores de $s_1$ y $s_2$:</p><p class="scroll">$$
s_1 = R^d \mod{D} \qquad s_2 = c^d \mod{D}
$$</p><p>En este punto, podemos tener las firmas $R$ y $c$, y podemos verificar que sus longitudes en bits son correctas. Démonos cuenta de que $R = A \cdot B^{-1} \mod{D}$, donde</p><p class="scroll">$$
\frac{A}{B} = \mathrm{magic}(m, h, c) = \frac{m}{h} + \frac{h}{c} + \frac{c}{m} = \frac{m^2 c + m h^2 + h c^2}{m h c}
$$</p><p>Aquí, es posible que necesitemos aplicar el <a target="_blank" href="https://en.wikipedia.org/wiki/Coppersmith_method">método de Coppersmith</a> o una técnica basada en retículos, ya que la <em>flag</em> tiene como máximo 64 bytes (512 bits) y el <em>hash</em> SHA256 es un número entero de 256 bits, mientras que $D$ es de alrededor de 3072 bits.</p><p>Como sabemos $c$, solo tenemos que encontrar $m$ y $h$, que se pueden suponer que son valores pequeños. Tenemos</p><p class="scroll">$$
\begin{align*}
R & = A \cdot B^{-1} \mod{D} \\
  & = (m^2 c + m h^2 + h c^2) \cdot (m h c)^{-1} \mod{D} \\
\end{align*}
$$</p><p>Vamos a deshacernos de los inversos multiplicando por $(m h c)$:</p><p class="scroll">$$
(m h c) R = m^2 c + m h^2 + h c^2 \mod{D}
$$</p><p>Como resultado, podemos definir un polinomio:</p><p class="scroll">$$
P(x, y) = c \, x^2 + x y^2 + c^2 \, y - c R \, x y \pmod{D}
$$</p><p>Donde $P(m, h) \equiv 0 \pmod{D}$. Como $m$ y $h$ son valores pequeños, podemos tratar de encontrar raíces pequeñas de este polinomio bivariado utilizando el <a target="_blank" href="https://en.wikipedia.org/wiki/Coppersmith_method">método de Coppersmith</a>.</p><h2 id="implementación-en-sagemath">Implementación en SageMath</h2><p>En primer lugar, tomamos los valores de <code>output.txt</code> y encontramos $N$ y $D$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'output.txt'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">fp</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">pub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">literal_eval</span><span class="mtk1">(</span><span class="mtk1">fp</span><span class="mtk1">.</span><span class="mtk8">readline</span><span class="mtk1">().</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">' = '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">])</span>  
<span class="mtk1">    </span><span class="mtk1">mix</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">literal_eval</span><span class="mtk1">(</span><span class="mtk1">fp</span><span class="mtk1">.</span><span class="mtk8">readline</span><span class="mtk1">().</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">' = '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1">, </span><span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">pub</span>
<span class="mtk1">f</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">magic</span><span class="mtk1">(</span><span class="mtk1">pub</span><span class="mtk1">)</span>
<span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">numerator</span><span class="mtk1">, </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span>
<span class="mtk1">nb</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk1">denominator</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">8</span>
</code></pre></div><p>A continuación, encontramos la clave privada $p$, $q$, $r$ y afirmamos que los valores son correctos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> gcd(gcd(</span><span class="mtk1">Q</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">), gcd(</span><span class="mtk1">R</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">))</span>
<span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> gcd(</span><span class="mtk1">Q</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">r</span>
<span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> gcd(</span><span class="mtk1">R</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">r</span>

<span class="mtk5">assert</span><span class="mtk1"> is_prime(</span><span class="mtk1">p</span><span class="mtk1">) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">1024</span>  
<span class="mtk5">assert</span><span class="mtk1"> is_prime(</span><span class="mtk1">q</span><span class="mtk1">) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">q</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">1024</span>
<span class="mtk5">assert</span><span class="mtk1"> is_prime(</span><span class="mtk1">r</span><span class="mtk1">) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">1024</span>

<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">N</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">D</span>
</code></pre></div><p>Una vez que tenemos la clave privada, podemos descifrar el <code>mix</code>, hallar la firma $(s_1, s_2)$ y calcular $R$ y $c$. La longitud de $c$ también la verificamos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">))</span>
<span class="mtk1">s1_p_s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">mix</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">)</span>
<span class="mtk1">s1_m_s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">mix</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">)</span>

<span class="mtk1">s1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">s1_p_s2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">s1_m_s2</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">D</span>  
<span class="mtk1">s2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">s1_p_s2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">s1_m_s2</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">D</span>

<span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">s1</span><span class="mtk1">, </span><span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">)</span>
<span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">s2</span><span class="mtk1">, </span><span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk1">D</span><span class="mtk1">)</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk1">nb</span>
</code></pre></div><p>Finalmente, necesitamos definir el polinomio de dos variables y usar el método de Coppersmith para encontrar $m$ y $h$. Una buena implementación del método de Coppersmith multivariado es la de <a target="_blank" href="https://github.com/defund/coppersmith">defund</a>. Podemos descargar el <em>script</em> y cargarlo en SageMath para usar la función <code>small_roots</code>. Una vez encontrada una solución, podemos confirmar que el <em>hash</em> SHA256 coincide y luego simplemente imprimimos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">load(</span><span class="mtk4">'coppersmith.sage'</span><span class="mtk1">)</span>

<span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PolynomialRing(Zmod(</span><span class="mtk1">D</span><span class="mtk1">), </span><span class="mtk4">'m, h'</span><span class="mtk1">).gens()</span>
<span class="mtk1">PP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">h</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">R</span>
<span class="mtk1">roots</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> small_roots(</span><span class="mtk1">PP</span><span class="mtk1">, </span><span class="mtk9 mtki">bounds</span><span class="mtk5">=</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">512</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">))</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">root</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">roots</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">root</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> (</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">root</span>
<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">).</span><span class="mtk8">to_bytes</span><span class="mtk1">(</span><span class="mtk1">nb</span><span class="mtk1">, </span><span class="mtk4">'big'</span><span class="mtk1">)).</span><span class="mtk8">hexdigest</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">h</span>  
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:]).</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Y aquí tenemos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sage</span> <span class="mtku">solve.sage</span>
HTB{4_s3cur3_crypt0syst3m_sh0u1d_n0t_c0nt41n_s3cr3t_c0mp0n3nts!}  
</code></pre></div><p>El <em>script</em> completo se puede encontrar aquí: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20UniCTF/Crypto/Zombie%20Rolled/solve.sage"><code>solve.sage</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#generación-de-claves-públicas">Generación de claves públicas</a></li><li><a href="#cifrado-y-descifrado">Cifrado y descifrado</a></li><li><a href="#firma-y-proceso-de-verificación">Firma y proceso de verificación</a></li></ul></li><li><a href="#solución">Solución</a></li><li><a href="#implementación-en-sagemath">Implementación en SageMath</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>