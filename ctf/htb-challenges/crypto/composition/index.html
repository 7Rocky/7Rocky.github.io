<!doctype html><html lang="es"><head><title>Composition | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Primos cercanos. RSA y ECC. Encontrando los par谩metros de la curva. Curva el铆ptica sobre m贸dulo compuesto"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Primos cercanos. RSA y ECC. Encontrando los par谩metros de la curva. Curva el铆ptica sobre m贸dulo compuesto"><meta itemprop="keywords" content><meta itemprop="name" content="Composition"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Primos cercanos. RSA y ECC. Encontrando los par谩metros de la curva. Curva el铆ptica sobre m贸dulo compuesto"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Composition"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/crypto/composition/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Primos cercanos. RSA y ECC. Encontrando los par谩metros de la curva. Curva el铆ptica sobre m贸dulo compuesto"><meta name="twitter:description" content="Primos cercanos. RSA y ECC. Encontrando los par谩metros de la curva. Curva el铆ptica sobre m贸dulo compuesto"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Composition"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/crypto/composition/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/crypto/composition/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/crypto/composition/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/crypto/composition/&amp;text=Composition" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/crypto/composition/&amp;title=Composition" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Composition</h1><p class="mb4 f6 dib tracked">8 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</a><ul><li><a href="#rsa">RSA</a></li><li><a href="#ecc">ECC</a></li></ul></li><li><a href="#soluci贸n">Soluci贸n</a><ul><li><a href="#implementaci贸n">Implementaci贸n</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el c贸digo fuente del servidor en Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">, </span><span class="mtk8">getPrime</span><span class="mtk1">, </span><span class="mtk8">GCD</span><span class="mtk1">, </span><span class="mtk8">long_to_bytes</span><span class="mtk1">, </span><span class="mtk8">bytes_to_long</span>  
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Cipher</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">Padding</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">pad</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secret</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">flag</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">ecc</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">EllipticCurve</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">md5</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Welcome to the ECRSA test center. Your encrypted </span><span class="mtk4">data will be sent soon."</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Please check the logs for the parameters."</span><span class="mtk1">)</span>
<span class="mtk1">legendre</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">lambda</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">: </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">x</span><span class="mtk1">,(</span><span class="mtk9 mtki">p</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span><span class="mtk5">//</span><span class="mtk6">2</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">num</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk9 mtki">num</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk9 mtki">num</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">num</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">num</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">getrandpoint</span><span class="mtk1">(</span><span class="mtk9 mtki">ec</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">num</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk5">*</span><span class="mtk9 mtki">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">legendre</span><span class="mtk1">(</span><span class="mtk1">expr</span><span class="mtk1">(</span><span class="mtk1">num</span><span class="mtk1">),</span><span class="mtk9 mtki">p</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk1">legendre</span><span class="mtk1">(</span><span class="mtk1">expr</span><span class="mtk1">(</span><span class="mtk1">num</span><span class="mtk1">),</span><span class="mtk9 mtki">q</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">num</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk5">*</span><span class="mtk9 mtki">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">ec</span><span class="mtk1">.lift_x(</span><span class="mtk1">num</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">)</span>
<span class="mtk3"># Calculate discriminant(ensures elliptic curve is</span><span class="mtk3"> non-singular)</span>
<span class="mtk1">calc_discrim</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">lambda</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1">,</span><span class="mtk9 mtki">b</span><span class="mtk1">,</span><span class="mtk9 mtki">n</span><span class="mtk1">: (</span><span class="mtk5">-</span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk5">**</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">27</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span><span class="mtk5">**</span><span class="mtk6">2</span><span class="mtk1">)) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># Returns RSA key in form ((e,n),(p,q))</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">bits</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">50</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">q</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">bits</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">),(</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Generating your key..."</span><span class="mtk1">)</span>
<span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk6">512</span><span class="mtk1">)</span>
<span class="mtk1">e</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Creating ECC params"</span><span class="mtk1">)</span>
<span class="mtk3"># Gotta make sure the params are valid</span>
<span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">),</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">)</span>
<span class="mtk1">discrim</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">calc_discrim</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">expr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">lambda</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk1">: </span><span class="mtk9 mtki">x</span><span class="mtk5">**</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk5">*</span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">discrim</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">),</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">discrim</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">calc_discrim</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">ec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">EllipticCurve</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">g</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getrandpoint</span><span class="mtk1">(</span><span class="mtk1">ec</span><span class="mtk1">,</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">ec</span><span class="mtk1">.</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">g</span><span class="mtk1">,</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk3"># Use key that has been shared with ECRSA</span>
<span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">g</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">iv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">,</span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">,</span><span class="mtk1">iv</span><span class="mtk1">)</span>
<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">,</span><span class="mtk6">16</span><span class="mtk1">))</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"Encrypted flag: </span><span class="mtk6">{</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"IV: </span><span class="mtk6">{</span><span class="mtk1">iv</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"N: </span><span class="mtk6">{</span><span class="mtk1">n</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"ECRSA Ciphertext: </span><span class="mtk6">{</span><span class="mtk1">A</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Would you like to test the ECRSA curve?"</span><span class="mtk1">)</span>
<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"[y/n]&gt; "</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'n'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Generating random point..."</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">getrandpoint</span><span class="mtk1">(</span><span class="mtk1">ec</span><span class="mtk1">,</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">))</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Thanks for testing!"</span><span class="mtk1">)</span>
</code></pre></div><p>Esta cifrando la <em>flag</em> usando ECC, con una librer铆a personalizada (<code>ecc.py</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">collections</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">namedtuple</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">functools</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">reduce</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">operator</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">mul</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">inverse</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span>
<span class="mtk1">Point</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">namedtuple</span><span class="mtk1">(</span><span class="mtk4">"Point"</span><span class="mtk1">,</span><span class="mtk4">"x y"</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">moddiv</span><span class="mtk1">(</span><span class="mtk9 mtki">x</span><span class="mtk1">,</span><span class="mtk9 mtki">y</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">inverse</span><span class="mtk1">(</span><span class="mtk9 mtki">y</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">)) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">crt</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk9 mtki">args</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># Takes a bunch of lists in form [value,modulus]</span>
<span class="mtk1">    </span><span class="mtk1">values</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">row</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">row</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">args</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">ns</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">row</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">row</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">args</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">N</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">reduce</span><span class="mtk1">(</span><span class="mtk8">mul</span><span class="mtk1">,</span><span class="mtk1">ns</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">_sum</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">)):</span>
<span class="mtk1">        </span><span class="mtk1">yi</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">N</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">ns</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">zi</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">inverse</span><span class="mtk1">(</span><span class="mtk1">yi</span><span class="mtk1">,</span><span class="mtk1">ns</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">])</span>
<span class="mtk1">        </span><span class="mtk1">_sum</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">values</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span><span class="mtk5">*</span><span class="mtk1">yi</span><span class="mtk5">*</span><span class="mtk1">zi</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">_sum</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">N</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">composite_square_root</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># Only works if num is a quadratic residue mod p a</span><span class="mtk3">nd q AND p and q are 3 mod 4</span>  
<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">q</span>
<span class="mtk1">    </span><span class="mtk1">root1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">,(</span><span class="mtk9 mtki">p</span><span class="mtk5">+</span><span class="mtk6">1</span><span class="mtk1">)</span><span class="mtk5">//</span><span class="mtk6">4</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">root2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">num</span><span class="mtk1">,(</span><span class="mtk9 mtki">q</span><span class="mtk5">+</span><span class="mtk6">1</span><span class="mtk1">)</span><span class="mtk5">//</span><span class="mtk6">4</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">ans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">crt</span><span class="mtk1">([</span><span class="mtk1">root1</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">],[</span><span class="mtk1">root2</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">ans</span><span class="mtk1">,</span><span class="mtk6">2</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> (</span><span class="mtk9 mtki">num</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">ans</span>
<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">EllipticCurve</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">INF</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Point</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span><span class="mtk9 mtki">P</span><span class="mtk1">,</span><span class="mtk9 mtki">Q</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">INF</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">Q</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk9 mtki">Q</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">INF</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.x </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">Q</span><span class="mtk1">.x </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.y </span><span class="mtk5">==</span><span class="mtk1"> (</span><span class="mtk5">-</span><span class="mtk9 mtki">Q</span><span class="mtk1">.y </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">INF</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">Q</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">Lambda</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">moddiv</span><span class="mtk1">(</span><span class="mtk9 mtki">Q</span><span class="mtk1">.y </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.y, </span><span class="mtk9 mtki">Q</span><span class="mtk1">.x </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.x, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">Lambda</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">moddiv</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.x</span><span class="mtk5">**</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.y , </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">Rx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">Lambda</span><span class="mtk5">**</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.x </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">Q</span><span class="mtk1">.x) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span>
<span class="mtk1">        </span><span class="mtk1">Ry</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">Lambda</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk9 mtki">P</span><span class="mtk1">.x </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">Rx</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">P</span><span class="mtk1">.y) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">Point</span><span class="mtk1">(</span><span class="mtk1">Rx</span><span class="mtk1">,</span><span class="mtk1">Ry</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span><span class="mtk9 mtki">P</span><span class="mtk1">,</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">%=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">abs</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">ans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk9 mtki">P</span><span class="mtk1">,</span><span class="mtk8">abs</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">Point</span><span class="mtk1">(</span><span class="mtk1">ans</span><span class="mtk1">.x, </span><span class="mtk5">-</span><span class="mtk1">ans</span><span class="mtk1">.y </span><span class="mtk5">%</span><span class="mtk1"> p)</span>
<span class="mtk1">        </span><span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">INF</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">R</span><span class="mtk1">,</span><span class="mtk9 mtki">P</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">P</span><span class="mtk1">,</span><span class="mtk9 mtki">P</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">R</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">lift_x</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span><span class="mtk9 mtki">x</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">expr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk5">**</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk5">*</span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">b</span>
<span class="mtk1">        </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">composite_square_root</span><span class="mtk1">(</span><span class="mtk1">expr</span><span class="mtk1">,</span><span class="mtk9 mtki">p</span><span class="mtk1">,</span><span class="mtk9 mtki">q</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">Point</span><span class="mtk1">(</span><span class="mtk9 mtki">x</span><span class="mtk1">,</span><span class="mtk1">y</span><span class="mtk1">)</span>
</code></pre></div><h2 id="an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</h2><p>El servidor crea una clave p煤blica de RSA $(e, n)$, aunque no nos dan $e$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Generating your key..."</span><span class="mtk1">)</span>  
<span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk6">512</span><span class="mtk1">)</span>
<span class="mtk1">e</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">key</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk3"># ...</span>

<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"N: </span><span class="mtk6">{</span><span class="mtk1">n</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
</code></pre></div><h3 id="rsa">RSA</h3><p>El m贸dulo p煤blico $n = p \cdot p$, donde $p$ y $q$ son dos n煤meros primos grandes:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># Returns RSA key in form ((e,n),(p,q))</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">bits</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">50</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">next_prime</span><span class="mtk1">(</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">q</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk9 mtki">bits</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">keygen</span><span class="mtk1">(</span><span class="mtk9 mtki">bits</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">),(</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">)</span>
</code></pre></div><p>Como se puede ver, $p$ es un n煤mero primo de 256 bits, pero $q$ est谩 bastante cerca de $p$, porque se calcula usando <code>next_prime</code>. Al menos, hay una distancia de 50 n煤meros primos entre $p$ y $q$, pero la diferencia sigue siendo corta, por lo que podemos decir</p><p class="scroll">$$
q = p + k
$$</p><p>Para alg煤n $k \in \mathbb{Z}$ peque帽o. Entonces tenemos</p><p class="scroll">$$
n = p \cdot q = p^2 + p \cdot k
$$</p><p>Como resultado, tenemos una aproximaci贸n de $p$ usando la ra铆z cuadrada:</p><p class="scroll">$$
p \approx \sqrt{n}
$$</p><p>El resultado no ser谩 exactamente $p$, pero podemos usar <code>next_prime</code> hasta que encontremos $q$ (y por tanto tambi茅n tendremos $p$). El exponente p煤blico $e$ depende de $p$, por lo que tambi茅n tendr铆amos $e$ en este momento.</p><h3 id="ecc">ECC</h3><p>Despu茅s de eso, el servidor crea una curva el铆ptica sobre $\mathbb{Z}/n\mathbb{Z}$ con par谩metros aleatorios $a$ y $b$, que no se nos dan:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Creating ECC params"</span><span class="mtk1">)</span>
<span class="mtk3"># Gotta make sure the params are valid</span>
<span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">),</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">)</span>
<span class="mtk1">discrim</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">calc_discrim</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">expr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">lambda</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk1">: </span><span class="mtk9 mtki">x</span><span class="mtk5">**</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk5">*</span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">discrim</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">),</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">128</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">discrim</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">calc_discrim</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">ec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">EllipticCurve</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">,</span><span class="mtk1">n</span><span class="mtk1">)</span>
</code></pre></div><p>Luego, genera un punto aleatorio $G$, que se utiliza para derivar una clave de AES para cifrar la <em>flag</em>, y se nos da $A = e \cdot G$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">g</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getrandpoint</span><span class="mtk1">(</span><span class="mtk1">ec</span><span class="mtk1">,</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">)</span>
<span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">ec</span><span class="mtk1">.</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">g</span><span class="mtk1">,</span><span class="mtk1">e</span><span class="mtk1">)</span>
<span class="mtk3"># Use key that has been shared with ECRSA</span>  
<span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">g</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">iv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">,</span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">,</span><span class="mtk1">iv</span><span class="mtk1">)</span>
<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">,</span><span class="mtk6">16</span><span class="mtk1">))</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"Encrypted flag: </span><span class="mtk6">{</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"IV: </span><span class="mtk6">{</span><span class="mtk1">iv</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"N: </span><span class="mtk6">{</span><span class="mtk1">n</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"ECRSA Ciphertext: </span><span class="mtk6">{</span><span class="mtk1">A</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
</code></pre></div><p>Por 煤ltimo, pero no menos importante, tenemos la oportunidad de obtener otro punto aleatorio $R$ dentro de la curva:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Would you like to test the ECRSA curve?"</span><span class="mtk1">)</span>  
<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"[y/n]&gt; "</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'n'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Generating random point..."</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">getrandpoint</span><span class="mtk1">(</span><span class="mtk1">ec</span><span class="mtk1">,</span><span class="mtk1">p</span><span class="mtk1">,</span><span class="mtk1">q</span><span class="mtk1">))</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Thanks for testing!"</span><span class="mtk1">)</span>
</code></pre></div><p>Esto es importante para recuperar los par谩metros de la curva, porque tanto $A$ como $R$ se encuentran en la curva, por lo que</p><p class="scroll">$$
\begin{cases}
A_y^2 = A_x^3 + a A_x + b \mod{n} \\
R_y^2 = R_y^3 + a R_y + b \mod{n}
\end{cases}
$$</p><p>Restando ambas ecuaciones, tenemos:</p><p class="scroll">$$
A_y^2 - R_y^2 = A_x^3 - R_y^3 + a (A_x - R_y) \mod{n}
$$</p><p>Entonces, podemos despejar $a$:</p><p class="scroll">$$
a = (A_y^2 - R_y^2 - A_x^3 + R_y^3) \cdot (A_x - R_y)^{-1} \mod{n}
$$</p><p>Y luego es trivial hallar $b$:</p><p class="scroll">$$
b = A_y^2 - A_x^3 - a A_x \mod{n}
$$</p><h2 id="soluci贸n">Soluci贸n</h2><p>Entonces, hasta este punto, sabemos c贸mo factorizar $n = p \cdot q$, c贸mo obtener $e$ y c贸mo recuperar los par谩metros de la curva.</p><p>Lo 煤ltimo que necesitamos es encontrar $G$ tal que $A = e \cdot G$. La forma de hacerlo es encontrar un valor $d$ tal que $G = d \cdot A$, por lo que $e$ y $d$ son inversos de alg煤n modo. El problema es que no podemos calcular el orden de la curva porque est谩 definida sobre un m贸dulo compuesto, por lo que no podemos encontrar el inverso de $e$ f谩cilmente.</p><p>Lo que podemos hacer es aplicar el <a target="_blank" href="https://es.wikipedia.org/wiki/Teorema_chino_del_resto">Teorema Chino del Resto</a> de una manera peculiar. Ciertamente, podemos encontrar el inverso de un escalar cuando la curva se define sobre un m贸dulo primo. Como resultado, podemos encontrar el inverso de $e$ en las curvas definidas sobre $\mathbb{F}_p$ y $\mathbb{F}_q$, obtener el punto $G$ en ambas curvas, y luego aplicar el CRT de las coordenadas $\mathrm{x}$ para obtener el punto $G$ sobre $\mathbb{Z}/n\mathbb{Z}$.</p><h3 id="implementaci贸n">Implementaci贸n</h3><p>En primer lugar, obtenemos toda la informaci贸n necesaria de la instancia de reto:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Encrypted flag: '</span><span class="mtk1">)</span>
<span class="mtk1">flag_enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>  

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'IV: '</span><span class="mtk1">)</span>
<span class="mtk1">iv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'N: '</span><span class="mtk1">)</span>
<span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'ECRSA Ciphertext: Point(x='</span><span class="mtk1">)</span>
<span class="mtk1">Ax</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">','</span><span class="mtk1">)[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y='</span><span class="mtk1">)</span>
<span class="mtk1">Ay</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">')'</span><span class="mtk1">)[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[y/n]&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'y'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Point(x='</span><span class="mtk1">)</span>
<span class="mtk1">Rx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">','</span><span class="mtk1">)[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y='</span><span class="mtk1">)</span>
<span class="mtk1">Ry</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">')'</span><span class="mtk1">)[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><p>Luego, factoramos $n$ como se explic贸 anteriormente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">isqrt</span><span class="mtk1">(</span><span class="mtk1">n</span><span class="mtk1">)</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> next_prime(</span><span class="mtk1">q</span><span class="mtk1">)</span>  

<span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">q</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">p</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">q</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>En este punto, tambi茅n tenemos $e$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> next_prime(</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">))</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">e</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>A continuaci贸n, encontramos los par谩metros de la curva resolviendo el sistema de ecuaciones:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ay</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ry</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Rx</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">Rx</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">)) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">n</span>  
<span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ay</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Ax</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">n</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">a</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">b</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Despu茅s de eso, podemos definir las curvas sobre $\mathbb{Z}/n\mathbb{Z}$, $\mathbb{F}_p$ y $\mathbb{F}_q$ Para obtener el punto $G$ en las 煤ltimas dos curvas y encontrar $G$ sobre la primera usando el CRT:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">En</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">EllipticCurve</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">)</span>
<span class="mtk1">Ep</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(GF(</span><span class="mtk1">p</span><span class="mtk1">), [</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">])</span>
<span class="mtk1">Eq</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(GF(</span><span class="mtk1">q</span><span class="mtk1">), [</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">])</span>

<span class="mtk1">Ap</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Ep</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1">, </span><span class="mtk1">Ay</span><span class="mtk1">)</span>
<span class="mtk1">Aq</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Eq</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1">, </span><span class="mtk1">Ay</span><span class="mtk1">)</span>

<span class="mtk1">Gp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">Ep</span><span class="mtk1">.order()) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Ap</span>
<span class="mtk1">Gq</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">Eq</span><span class="mtk1">.order()) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Aq</span>
<span class="mtk1">Gn_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> crt([</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span>Gp.x()]), </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span>Gq.x()])], [</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">q</span><span class="mtk1">])</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">En</span><span class="mtk1">.</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">En</span><span class="mtk1">.</span><span class="mtk8">lift_x</span><span class="mtk1">(</span><span class="mtk1">Gn_x</span><span class="mtk1">, </span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">q</span><span class="mtk1">), </span><span class="mtk1">e</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8 mtku">ecc</span><span class="mtk1">.</span><span class="mtk1">Point</span><span class="mtk1">(</span><span class="mtk1">Ax</span><span class="mtk1">, </span><span class="mtk1">Ay</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">Gn_x</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>En este punto, podemos derivar la clave de AES y obtener la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">Gn_x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">, </span><span class="mtk1">iv</span><span class="mtk1">)</span>
<span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unpad</span><span class="mtk1">(</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">flag_enc</span><span class="mtk1">), </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">block_size</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">)</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Si ejecutamos el <em>script</em>, obtendremos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.63.83:33306
[<span class="code-green">+</span>] Opening connection to 94.237.63.83 on port 33306: Done
[<span class="code-blue">*</span>] p = 106858941313638767991828235567490821200125820455933241643545899194829771009579
[<span class="code-blue">*</span>] q = 106858941313638767991828235567490821200125820455933241643545899194829771018591
[<span class="code-blue">*</span>] e = 314030204622581805680811063725039822717
[<span class="code-blue">*</span>] a = 37753997141981190002907126778194883468
[<span class="code-blue">*</span>] b = 37744197496150834695308441384696040008
[<span class="code-green">+</span>] Gn_x = 4174411158930651296922645398385284926646467052831144880881853434751972793707369366842219778664803546408964829711287940023692621868869243079343630800011414  
[<span class="code-green">+</span>] HTB{Pr1M3_Pr0x1mIty_@nD_C0mP0s1T3_CuRv3?????=&gt;s0_1nS3cUr3!!!}
[<span class="code-blue">*</span>] Closed connection to 94.237.63.83 port 33306
</code></pre></div><p>El <em>script</em> completo se puede encontrar aqu铆: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/blob/main/Challenges/Crypto/Composition/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#an谩lisis-del-c贸digo-fuente">An谩lisis del c贸digo fuente</a><ul><li><a href="#rsa">RSA</a></li><li><a href="#ecc">ECC</a></li></ul></li><li><a href="#soluci贸n">Soluci贸n</a><ul><li><a href="#implementaci贸n">Implementaci贸n</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de res煤menes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>