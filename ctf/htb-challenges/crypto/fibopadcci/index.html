<!doctype html><html lang="es"><head><title>Fibopadcci | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="_Padding Oracle Attack_. Cifrado y relleno personalizados"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="_Padding Oracle Attack_. Cifrado y relleno personalizados"><meta itemprop="keywords" content><meta itemprop="name" content="Fibopadcci"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="_Padding Oracle Attack_. Cifrado y relleno personalizados"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Fibopadcci"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/crypto/fibopadcci/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="_Padding Oracle Attack_. Cifrado y relleno personalizados"><meta name="twitter:description" content="_Padding Oracle Attack_. Cifrado y relleno personalizados"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Fibopadcci"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/crypto/fibopadcci/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/crypto/fibopadcci/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/crypto/fibopadcci/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/crypto/fibopadcci/&amp;text=Fibopadcci" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/crypto/fibopadcci/&amp;title=Fibopadcci" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Fibopadcci</h1><p class="mb4 f6 dib tracked">13 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-cifrado">Análisis del cifrado</a><ul><li><a href="#_padding-oracle-attack_"><em>Padding Oracle Attack</em></a></li><li><a href="#pruebas">Pruebas</a></li><li><a href="#descifrado">Descifrado</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el código fuente en Python del servidor:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">socketserver</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Cipher</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>
<span class="mtk5">from</span><span class="mtk1"> secret </span><span class="mtk5">import</span><span class="mtk1"> flag, key</span>

<span class="mtk1">fib</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">, </span><span class="mtk6">21</span><span class="mtk1">, </span><span class="mtk6">34</span><span class="mtk1">, </span><span class="mtk6">55</span><span class="mtk1">, </span><span class="mtk6">89</span><span class="mtk1">, </span><span class="mtk6">144</span><span class="mtk1">, </span><span class="mtk6">233</span><span class="mtk1">, </span><span class="mtk6">121</span><span class="mtk1">, </span><span class="mtk6">98</span><span class="mtk1">, </span><span class="mtk6">219</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">]</span>

<span class="mtk1">wlc_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"""</span>
<span class="mtk4">--------------------------------------------------</span><span class="mtk4">-----------------------</span>
<span class="mtk4">|           Welcome to my Super Secure Encryption </span><span class="mtk4">service!              |</span>
<span class="mtk4">|        We use AES along with custom padding for </span><span class="mtk4">authentication        |</span>
<span class="mtk4">|         for extra security, so only admins shoul</span><span class="mtk4">d be able to          |</span>
<span class="mtk4">|          decrypt the flag with the key I have pr</span><span class="mtk4">ovided them!          |</span>
<span class="mtk4">|       Admins: Feel free to send me messages that</span><span class="mtk4"> you have             |</span>
<span class="mtk4">|       encrypted with my key, but make sure they </span><span class="mtk4">are padded            |</span>
<span class="mtk4">|       correctly with my custom padding I showed </span><span class="mtk4">you (fibopadcci)      |</span>
<span class="mtk4">|          Also, please use the a value I gave you</span><span class="mtk4"> last time,           |</span>
<span class="mtk4">|   if you need it, ask a fellow admin, I don't wa</span><span class="mtk4">nt some random        |</span>
<span class="mtk4">|               outsiders decrypting our secret fl</span><span class="mtk4">ag.                   |</span>
<span class="mtk4">--------------------------------------------------</span><span class="mtk4">-----------------------</span>
<span class="mtk4">"""</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">:]</span>

<span class="mtk1">menu_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"""</span><span class="mtk6">\n</span>
<span class="mtk4">-------------------------</span>
<span class="mtk4">| Menu                  |</span>
<span class="mtk4">-------------------------</span>
<span class="mtk4">|[0] Encrypt flag.      |</span>
<span class="mtk4">|[1] Send me a message! |</span>
<span class="mtk4">-------------------------</span>
<span class="mtk4">"""</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">:]</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">_a</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">_b</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_a</span><span class="mtk1">, </span><span class="mtk1">_b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">zip</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">)])</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">): </span><span class="mtk3">#Custom padding, should be fine!</span>
<span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">pad</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk1">c</span><span class="mtk1">] </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">255</span><span class="mtk1">))[</span><span class="mtk6">2</span><span class="mtk1">:]</span>
<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk4">"0"</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk6">2</span><span class="mtk5">-</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">pad</span><span class="mtk1">)) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">pad</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">checkpad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">start</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk1">char</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk1">newfib</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[:</span><span class="mtk1">start</span><span class="mtk1">][::</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">newfib</span><span class="mtk1">)):</span>
<span class="mtk1">        </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">2</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">newfib</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperSecureEncryption</span><span class="mtk1">: </span><span class="mtk3"># This should be unbreakable!</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">key</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x00</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1">) </span>
<span class="mtk1">        </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x00</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">a</span>
<span class="mtk1">        </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">        </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>

<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">:</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)]</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">:</span>
<span class="mtk1">    </span>
<span class="mtk1">            </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">lb_cipher</span><span class="mtk1">, </span><span class="mtk1">block</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">, </span><span class="mtk1">lb_plain</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">enc</span>
<span class="mtk1">            </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">block</span>
<span class="mtk1">            </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">enc</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">output</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span>
<span class="mtk1">        </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span>
<span class="mtk1">        </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">:</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">block</span><span class="mtk1">, </span><span class="mtk1">lb_plain</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">, </span><span class="mtk1">lb_cipher</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">block</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">checkpad</span><span class="mtk1">(</span><span class="mtk1">output</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">output</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">None</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encryptFlag</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">encrypted</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperSecureEncryption</span><span class="mtk1">(key).</span><span class="mtk8">encrypt</span><span class="mtk1">(flag)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'encrypted_flag: </span><span class="mtk6">{</span><span class="mtk1">encrypted</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}\n</span><span class="mtk4">a: </span><span class="mtk6">{</span><span class="mtk1">a</span><span class="mtk6">}\n</span><span class="mtk4">b: </span><span class="mtk6">{</span><span class="mtk1">b</span><span class="mtk6">}</span><span class="mtk4">'</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: Ciphertext length must be a multiple of th</span><span class="mtk4">e block length (16)!"</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: a and b must have lengths of 16 bytes!"</span>
<span class="mtk1">    </span><span class="mtk1">decrypted</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperSecureEncryption</span><span class="mtk1">(key).</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">decrypted</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Message successfully sent!"</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: Message padding incorrect, not sent."</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">handle</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk1">wlc_msg</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk1">menu_msg</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.query(</span><span class="mtk4">"Your option: "</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"0"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk8">encryptFlag</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"1"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.query(</span><span class="mtk4">"Enter your ciphertext in hex: "</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.query(</span><span class="mtk4">"Enter the B used during encryption in hex: "</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'HTB{th3_s3crt_A}'</span><span class="mtk1"> </span><span class="mtk3"># My secret A! Only admins know it, and plus, othe</span><span class="mtk3">r people won't be able to work out my key anyway!</span>  
<span class="mtk1">                </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">,</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">:</span>
<span class="mtk1">              </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk4">"Provided input is not hex!"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk4">"Invalid input, please try again."</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">RequestHandler</span><span class="mtk1">(</span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">BaseRequestHandler</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">handle</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">handle</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">until</span><span class="mtk5">=</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">out</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">''</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">out</span><span class="mtk1">.</span><span class="mtk8">endswith</span><span class="mtk1">(</span><span class="mtk9 mtki">until</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">out</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.recv(</span><span class="mtk6">1</span><span class="mtk1">).decode()</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">out</span><span class="mtk1">[:</span><span class="mtk5">-</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">until</span><span class="mtk1">)]</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">query</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk5">=</span><span class="mtk4">''</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk9 mtki">string</span><span class="mtk1">, </span><span class="mtk9 mtki">newline</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk1">, </span><span class="mtk9 mtki">newline</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.sendall(</span><span class="mtk8 mtku">str</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">(</span><span class="mtk9 mtki">string</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">newline</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.sendall(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">close</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.close()</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Server</span><span class="mtk1">(</span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">ForkingTCPServer</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk1">allow_reuse_address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">handle_error</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">request</span><span class="mtk1">, </span><span class="mtk9 mtki">client_address</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.request.close()</span>

<span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1337</span>
<span class="mtk1">server</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Server</span><span class="mtk1">((</span><span class="mtk4">'0.0.0.0'</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">), </span><span class="mtk8 mtku">RequestHandler</span><span class="mtk1">)</span>
<span class="mtk1">server</span><span class="mtk1">.</span><span class="mtk8">serve_forever</span><span class="mtk1">()</span>
</code></pre></div><h2 id="análisis-del-cifrado">Análisis del cifrado</h2><p>Se nos proporcionan estas dos opciones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 206.189.114.209 31967
-------------------------------------------------------------------------  
|           Welcome to my Super Secure Encryption service!              |
|        We use AES along with custom padding for authentication        |
|         for extra security, so only admins should be able to          |
|          decrypt the flag with the key I have provided them!          |
|       Admins: Feel free to send me messages that you have             |
|       encrypted with my key, but make sure they are padded            |
|       correctly with my custom padding I showed you (fibopadcci)      |
|          Also, please use the a value I gave you last time,           |
|   if you need it, ask a fellow admin, I don't want some random        |
|               outsiders decrypting our secret flag.                   |
-------------------------------------------------------------------------


-------------------------
| Menu                  |
-------------------------
|[0] Encrypt flag.      |
|[1] Send me a message! |
-------------------------

Your option:
</code></pre></div><p>La primera solo envía la <em>flag</em> cifrada y dos valores <code>a</code> y <code>b</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Your option: 0
encrypted_flag: 18a6cae6493d67b7d35180499b9db145e33abdfb5a265dc6f5cf257ac6dfde78211ff6bc21399f605790cc6a0b67c9bc  
a: ae9b722fd54f1a40526252a1d8f2da17
b: c304b05b0725ce2e93f6ef2b4bd0a73f
</code></pre></div><p>La segunda opción intenta descifrar el mensaje cifrado, pero muestra un error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">-------------------------
| Menu                  |
-------------------------
|[0] Encrypt flag.      |
|[1] Send me a message! |
-------------------------

Your option: 1
Enter your ciphertext in hex: 18a6cae6493d67b7d35180499b9db145e33abdfb5a265dc6f5cf257ac6dfde78211ff6bc21399f605790cc6a0b67c9bc  
Enter the B used during encryption in hex: c304b05b0725ce2e93f6ef2b4bd0a73f
Error: Message padding incorrect, not sent.
</code></pre></div><p>El error dice &ldquo;<em>padding incorrect</em>&rdquo;, por lo que probablemente realizaremos un <em>Padding Oracle Attack</em>. Esta es la clase que implementa el algoritmo de cifrado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperSecureEncryption</span><span class="mtk1">: </span><span class="mtk3"># This should be unbreakable!</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">key</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x00</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1">) </span>
<span class="mtk1">        </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x00</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">a</span>
<span class="mtk1">        </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">        </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>

<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">:</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)]</span>  

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">lb_cipher</span><span class="mtk1">, </span><span class="mtk1">block</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">, </span><span class="mtk1">lb_plain</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">enc</span>
<span class="mtk1">            </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">block</span>
<span class="mtk1">            </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">enc</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">output</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span>
<span class="mtk1">        </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span>
<span class="mtk1">        </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>

<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">:</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)]</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">block</span><span class="mtk1">, </span><span class="mtk1">lb_plain</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">, </span><span class="mtk1">lb_cipher</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">output</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">lb_plain</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">lb_cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">block</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">checkpad</span><span class="mtk1">(</span><span class="mtk1">output</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">output</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">None</span>
</code></pre></div><p>Vale la pena dibujar los procesos de cifrado y descifrado en diagramas de bloques:</p><ul><li>Cifrado:</li></ul><p><img alt="Fibopadcci 1" src="/images/HTB-Challenges/HTB-Crypto-Fibopadcci-1.webp"></p><ul><li>Descifrado:</li></ul><p><img alt="Fibopadcci 2" src="/images/HTB-Challenges/HTB-Crypto-Fibopadcci-2.webp"></p><p>En realidad, este esquema de cifrado se conoce como <em>Infinite Garble Extension</em> (entonces, en realidad no es un cifrado en bloque personalizado).</p><p>En primer lugar, recuperaremos la <em>flag</em> cifrada, que envía el texto cifrado y los dos valores <code>a</code> y <code>b</code> usados para eso (son aleatorios).</p><p>No podemos descifrar el mensaje nosotros mismos porque no tenemos la clave AES para los bloques de descifrado&mldr; y no podemos decirle al servidor que lo descifre porque el servidor usa un valor <code>a</code> fijo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"1"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.query(</span><span class="mtk4">"Enter your ciphertext in hex: "</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.query(</span><span class="mtk4">"Enter the B used during encryption in hex: "</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'HTB{th3_s3crt_A}'</span><span class="mtk1"> </span><span class="mtk3"># My secret A! Only admins know it, and plus, othe</span><span class="mtk3">r people won't be able to work out my key anyway!</span>  
<span class="mtk1">                </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">,</span><span class="mtk1">a</span><span class="mtk1">,</span><span class="mtk1">b</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">:</span>
<span class="mtk1">              </span><span class="mtk9 mtki">self</span><span class="mtk1">.write(</span><span class="mtk4">"Provided input is not hex!"</span><span class="mtk1">)</span>
</code></pre></div><p>Además, el servidor no envía el texto descifrado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: Ciphertext length must be a multiple of th</span><span class="mtk4">e block length (16)!"</span>  
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: a and b must have lengths of 16 bytes!"</span>
<span class="mtk1">    </span><span class="mtk1">decrypted</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperSecureEncryption</span><span class="mtk1">(key).</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">decrypted</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Message successfully sent!"</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"Error: Message padding incorrect, not sent."</span>
</code></pre></div><h3 id="_padding-oracle-attack_"><em>Padding Oracle Attack</em></h3><p>Si el relleno del mensaje descifrado es correcto, se muestra <code>"Message successfully sent!"</code>. De lo contrario, el servidor devuelve <code>"Error: Message padding incorrect, not sent."</code>. Ese es el oráculo (de relleno) que tenemos.</p><p>La implementación del relleno está personalizada (relacionada con la secuencia de Fibonacci), pero eso no es un problema:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">fib</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">, </span><span class="mtk6">21</span><span class="mtk1">, </span><span class="mtk6">34</span><span class="mtk1">, </span><span class="mtk6">55</span><span class="mtk1">, </span><span class="mtk6">89</span><span class="mtk1">, </span><span class="mtk6">144</span><span class="mtk1">, </span><span class="mtk6">233</span><span class="mtk1">, </span><span class="mtk6">121</span><span class="mtk1">, </span><span class="mtk6">98</span><span class="mtk1">, </span><span class="mtk6">219</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">]</span>  

<span class="mtk3"># ...</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">): </span><span class="mtk3">#Custom padding, should be fine!</span>
<span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">pad</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk1">c</span><span class="mtk1">] </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">255</span><span class="mtk1">))[</span><span class="mtk6">2</span><span class="mtk1">:]</span>
<span class="mtk1">        </span><span class="mtk9 mtki">data</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">unhex</span><span class="mtk1">(</span><span class="mtk4">"0"</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk6">2</span><span class="mtk5">-</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">pad</span><span class="mtk1">)) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">pad</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span>
</code></pre></div><p>Probémoslo por si acaso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; fib = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 121, 98, 219, 61]  
&gt;&gt;&gt;
&gt;&gt;&gt; def unhex(data):
...     return bytes.fromhex(data)
...
&gt;&gt;&gt; def pad(data): #Custom padding, should be fine!
...     c = 0
...     while len(data) % 16:
...         pad = str(hex(fib[c] % 255))[2:]
...         data += unhex("0" * (2-len(pad)) + pad)
...         c += 1
...     return data
...
&gt;&gt;&gt; pad(b'A')
b'A\x01\x02\x03\x05\x08\r\x15"7Y\x90\xe9yb\xdb'
&gt;&gt;&gt; pad(b'ABCD')
b'ABCD\x01\x02\x03\x05\x08\r\x15"7Y\x90\xe9'
&gt;&gt;&gt; pad(b'ABCDEFGHI')
b'ABCDEFGHI\x01\x02\x03\x05\x08\r\x15'
&gt;&gt;&gt; pad(b'ABCDEFGHIJKLM')
b'ABCDEFGHIJKLM\x01\x02\x03'
&gt;&gt;&gt; pad(b'ABCDEFGHIJKLMNO')
b'ABCDEFGHIJKLMNO\x01'
&gt;&gt;&gt; pad(b'ABCDEFGHIJKLMNOP')
b'ABCDEFGHIJKLMNOP'
</code></pre></div><p>El relleno se comprueba en <code>checkpad</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">checkpad</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">start</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk1">char</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk1">newfib</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[:</span><span class="mtk1">start</span><span class="mtk1">][::</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">newfib</span><span class="mtk1">)):</span>  
<span class="mtk1">        </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">2</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">char</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">newfib</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">1</span>
</code></pre></div><p>Básicamente, toma el último byte y verifica que la secuencia de relleno es correcta. Hay un error menor, porque los mensajes con longitud un múltiplo de 16 no están rellenados y devolverán un error de relleno incorrecto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">>>> def checkpad(data):
...     if len(data) % 16 != 0:
...         return 0
...     char = data[-1]
...     try:
...         start = fib.index(char)
...     except ValueError:
...         return 0
...     newfib = fib[:start][::-1]
...     for i in range(len(newfib)):  
...         char = data[-(i+2)]
...         if char != newfib[i]:
...             return 0
...     return 1
...
>>> pad(b'A' * 16)
b'AAAAAAAAAAAAAAAA'
>>> pad(b'A' * 15)
b'AAAAAAAAAAAAAAA\x01'
>>> checkpad(pad(b'A' * 16))
0
>>> checkpad(pad(b'A' * 15))
1
>>> checkpad(pad(b'A' * 32))
0
</code></pre></div><p>Un <em>Padding Oracle Attack</em> funciona de la siguiente manera:</p><p><img alt="Fibopadcci 3" src="/images/HTB-Challenges/HTB-Crypto-Fibopadcci-3.webp"></p><p>Podemos ajustar el segundo bloque de texto cifrado, que afecta directamente al último bloque de texto claro. La idea es iterar el último byte desde <code>0x00</code> hasta <code>0xff</code> Hasta que encontremos uno que resulte en <code>0x01</code> (el primer byte de la secuencia de relleno). En este punto, el servidor mostrará un mensaje exitoso.</p><p>Sin embargo, este no es un <em>Padding Oracle Attack</em> típico contra AES CBC. En tal caso, encontraríamos un byte &ldquo;mágico&rdquo; ($B_i$) que no da error de relleno y se cumplen estas condiciones:</p><p class="scroll">$$
B_i \oplus \mathrm{pt}_i = \mathrm{pad}_i \iff B_i \oplus \mathrm{AES.dec}(\mathrm{ct}_i) = \mathrm{pad}_i
$$</p><p>Entonces, el byte de texto claro $\mathrm{pt}_i$ se calcula como:</p><p class="scroll">$$
\mathrm{pt}_i = \mathrm{AES.dec}(\mathrm{ct}_i) = \mathrm{pad}_i \oplus B_i
$$</p><p>Esta vez, el texto cifrado no se envía directamente al descifrador, hay una operación XOR con el bloque anterior de texto claro. Sin embargo, es necesario comprender los conceptos detrás del <em>Padding Oracle Attack</em> clásico para comprender el proceso para resolver este reto. Haremos lo siguiente:</p><p><img alt="Fibopadcci 4" src="/images/HTB-Challenges/HTB-Crypto-Fibopadcci-4.webp"></p><p>Con esta configuración, si usamos el valor proporcionado de <code>b</code>, el mensaje se descifraría correctamente. Entonces, si obligamos al último byte a ser <code>0x01</code> (en este caso concreto), el servidor no dará error y podremos hacer los cálculos anteriores para encontrar el byte de texto sin formato.</p><h3 id="pruebas">Pruebas</h3><p>Vamos a mostrar cómo funciona localmente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">cat</span> &gt; secret.py
from os import urandom
flag = b'HTB{ABCDEFGHIJKLM}'  
key = urandom(16)
^C

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">server.py</span>
</code></pre></div><p>Ahora, usaremos el siguiente <em>script</em> de Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">, </span><span class="mtk8 mtku">sys</span><span class="mtk1">, </span><span class="mtk8">xor</span>

<span class="mtk1">fib</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">, </span><span class="mtk6">21</span><span class="mtk1">, </span><span class="mtk6">34</span><span class="mtk1">, </span><span class="mtk6">55</span><span class="mtk1">, </span><span class="mtk6">89</span><span class="mtk1">, </span><span class="mtk6">144</span><span class="mtk1">, </span><span class="mtk6">233</span><span class="mtk1">, </span><span class="mtk6">121</span><span class="mtk1">, </span><span class="mtk6">98</span><span class="mtk1">, </span><span class="mtk6">219</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">]</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'encrypted_flag: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">encrypted_flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'a: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">flag_a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'b: '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">flag_b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">encrypted_flag</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk1">flag_a</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk1">flag_b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">secret_a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'HTB{th3_s3crt_A}'</span>

<span class="mtk1">    </span><span class="mtk1">ct_block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">encrypted_flag</span><span class="mtk1">[:</span><span class="mtk6">16</span><span class="mtk1">], </span><span class="mtk1">secret_a</span><span class="mtk1">, </span><span class="mtk1">flag_a</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your ciphertext in hex: '</span><span class="mtk1">, </span><span class="mtk1">ct_block</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">15</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1">])</span>

<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter the B used during encryption in hex: '</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>  

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Message successfully sent!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">flag_b</span><span class="mtk1">[</span><span class="mtk6">15</span><span class="mtk1">]]</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">break</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
3aafe4279ec56dee1235644f384574877fb67096164ee5e5b65b44c937dff0ba 50d773e13822ea33ae90049f27c5836f f973da5793d1143b3c59c54fa14bf882  
b'L'
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
ca4789bffdb992e84441b81a99b072488d55466a133f5ed28b762cab27b9e85f 5d4ba3db381b3b4818251fa763302bbf 6d53ac073b59a7402f9f6e74beb1ff20
b'L'
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
5a683e63568c6cdcc37604da5c5f2415f42129d6fc7c730986121f6dcf16a7f1 6e86d0b25520672f6db8bf8dc133aba9 30635516c74992dd35b08bb363727da3
b'L'
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337
</code></pre></div><p>Como se puede ver, estamos obteniendo <code>L</code>, que es el carácter en la posición <code>16</code> de la <em>flag</em> en texto claro (<code>HTB{ABCDEFGHIJKLM}</code>). Actualicemos el <em>script</em> para extraer el byte en la posición <code>15</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">ct_block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">encrypted_flag</span><span class="mtk1">[:</span><span class="mtk6">16</span><span class="mtk1">], </span><span class="mtk1">secret_a</span><span class="mtk1">, </span><span class="mtk1">flag_a</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your ciphertext in hex: '</span><span class="mtk1">, </span><span class="mtk1">ct_block</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">15</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1">])</span>

<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span>(<span class="mtk7 mtki">b</span><span class="mtk4">'Enter the B used during encryption in hex: '</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>  

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Message successfully sent!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">dec</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">flag_b</span><span class="mtk1">[</span><span class="mtk6">15</span><span class="mtk1">]]) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">pt</span>
<span class="mtk1">            </span><span class="mtk5">break</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your ciphertext in hex: '</span><span class="mtk1">, </span><span class="mtk1">ct_block</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">14</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1">]) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">), </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">: </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">]))</span>

<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter the B used during encryption in hex: '</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Message successfully sent!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">            </span><span class="mtk1">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">dec</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">flag_b</span><span class="mtk1">[</span><span class="mtk6">14</span><span class="mtk1">]]) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">pt</span>
<span class="mtk1">            </span><span class="mtk5">break</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">pt</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
92fedbc7fb035693f5e8a9e5214f2829a645ce32cb462be33717082f961fa15d e1962d917c48723e6a3acc448bef370f 3ced7fab3844130b748f6445b4e6990b  
b'KL'
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337
</code></pre></div><h3 id="descifrado">Descifrado</h3><p>Ahora, Lo automatizamos para obtener todos los 16 bytes de texto claro para un bloque usando un bucle <code>for</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">ct_block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">encrypted_flag</span><span class="mtk1">[:</span><span class="mtk6">16</span><span class="mtk1">], </span><span class="mtk1">secret_a</span><span class="mtk1">, </span><span class="mtk1">flag_a</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your ciphertext in hex: '</span><span class="mtk1">,</span> <span class="mtk1">ct_block</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">            </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk6">15</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1">]) </span><span class="mtk5">+</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">), </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">: </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">]))</span>  

<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter the B used during encryption in hex: '</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Message successfully sent!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">                </span><span class="mtk1">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">dec</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">flag_b</span><span class="mtk1">[</span><span class="mtk6">15</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">]]) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">pt</span>
<span class="mtk1">                </span><span class="mtk5">break</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">pt</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
31b0b9118dd27c5e97631bcf2fe708d270744b65306d721740e447fe9212278c cae439e59417b4c0576e5a45a2c3883a df41ffc451fd4b257f3615168ac540c3  
b'HTB{ABCDEFGHIJKL'
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337
</code></pre></div><p>Lo siguiente que hacemos es poner el bucle <code>for</code> en una función para descifrar todos los bloques. Para esto, debemos tener en cuenta que los valores correspondientes para <code>a</code> y <code>b</code> son los bloques anteriores de texto claro y texto cifrado, respectivamente (si es necesario, véase el esquema aislando los bloques centralres). También modifiqué un poco el <em>script</em> para mostrar información sobre el progreso del proceso de descifrado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">flag_prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Flag'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">poa</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Bytes'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">decrypt_block</span><span class="mtk1">(</span><span class="mtk9 mtki">ct_block</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">        </span><span class="mtk1">poa</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk4">'0 / 16'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Your option: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your ciphertext in hex: '</span><span class="mtk1">, </span><span class="mtk9 mtki">ct_block</span><span class="mtk1">.hex().encode())</span>
<span class="mtk1">                </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk6">15</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1">]) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">), </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">: </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">]))</span>  

<span class="mtk1">                </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter the B used during encryption in hex: '</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Message successfully sent!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">poa</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1}</span><span class="mtk4"> / 16'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b_byte</span><span class="mtk1"> </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk1">fib</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">dec</span>
<span class="mtk1">                    </span><span class="mtk5">break</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">dec</span>

<span class="mtk1">    </span><span class="mtk1">encrypted_flag_blocks</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">encrypted_flag</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">:</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">encrypted_flag</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)]</span>

<span class="mtk1">    </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">flag_a</span><span class="mtk1">, </span><span class="mtk1">flag_b</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">encrypted_flag_blocks</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">ct_block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">block</span><span class="mtk1">, </span><span class="mtk1">secret_a</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">dec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decrypt_block</span><span class="mtk1">(</span><span class="mtk1">ct_block</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">dec</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x01</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">flag_prog</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">16</span><span class="mtk1">:], </span><span class="mtk1">block</span>

<span class="mtk1">    </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1">[:</span><span class="mtk1">flag</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x01</span><span class="mtk4">'</span><span class="mtk1">)]</span>
<span class="mtk1">    </span><span class="mtk1">flag_prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">poa</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done  
[<span class="code-green">+</span>] Flag: HTB{ABCDEFGHIJKLM}
[<span class="code-green">+</span>] Bytes: Done
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Si lo ejecutamos en la instancia remota, encontraremos la <em>flag</em> después de unos 15 minutos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.71.137.186:32286
[<span class="code-green">+</span>] Opening connection to 167.71.137.186 on port 32286: Done  
[<span class="code-green">+</span>] Flag: HTB{cU5t0m_p4dd1Ng_w0nT_s4v3_y0u_tH1s_T1m3_:(!@}
[<span class="code-green">+</span>] Bytes: Done
[<span class="code-blue">*</span>] Closed connection to 167.71.137.186 port 32286
</code></pre></div><p>El <em>script</em> completo se puede encontrar aquí: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Crypto/Fibopadcci/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-cifrado">Análisis del cifrado</a><ul><li><a href="#_padding-oracle-attack_"><em>Padding Oracle Attack</em></a></li><li><a href="#pruebas">Pruebas</a></li><li><a href="#descifrado">Descifrado</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>