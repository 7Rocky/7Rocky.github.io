<!doctype html><html lang="es"><head><title>AbraCryptabra | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="LCG truncado. AES. _Knapsack_. Reducción de retículo mediante LLL"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="LCG truncado. AES. _Knapsack_. Reducción de retículo mediante LLL"><meta itemprop="keywords" content><meta itemprop="name" content="AbraCryptabra"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="LCG truncado. AES. _Knapsack_. Reducción de retículo mediante LLL"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="AbraCryptabra"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/crypto/abracryptabra/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="LCG truncado. AES. _Knapsack_. Reducción de retículo mediante LLL"><meta name="twitter:description" content="LCG truncado. AES. _Knapsack_. Reducción de retículo mediante LLL"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="AbraCryptabra"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/crypto/abracryptabra/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/crypto/abracryptabra/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/crypto/abracryptabra/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/crypto/abracryptabra/&amp;text=AbraCryptabra" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/crypto/abracryptabra/&amp;title=AbraCryptabra" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">AbraCryptabra</h1><p class="mb4 f6 dib tracked">15 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#_hidden-number-problem_"><em>Hidden Number Problem</em></a></li><li><a href="#problema-del-_knapsack_">Problema del <em>knapsack</em></a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Se nos proporciona el código fuente del servidor en Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">, </span><span class="mtk8">GCD</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">Padding</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">pad</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Cipher</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">socketserver</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">signal</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secret</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">FLAG</span>

<span class="mtk1">LOGO</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk4">"""</span>
<span class="mtk4">╭━━━┳╮╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭╮╱╱╱╭╮</span>
<span class="mtk4">┃╭━╮┃┃╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭╯╰╮╱╱┃┃</span>
<span class="mtk4">┃┃╱┃┃╰━┳━┳━━┳━━┳━┳╮╱╭┳━┻╮╭╋━━┫╰━┳━┳━━╮</span>
<span class="mtk4">┃╰━╯┃╭╮┃╭┫╭╮┃╭━┫╭┫┃╱┃┃╭╮┃┃┃╭╮┃╭╮┃╭┫╭╮┃</span>
<span class="mtk4">┃╭━╮┃╰╯┃┃┃╭╮┃╰━┫┃┃╰━╯┃╰╯┃╰┫╭╮┃╰╯┃┃┃╭╮┃</span>
<span class="mtk4">╰╯╱╰┻━━┻╯╰╯╰┻━━┻╯╰━╮╭┫╭━┻━┻╯╰┻━━┻╯╰╯╰╯</span>
<span class="mtk4">╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭━╯┃┃┃</span>
<span class="mtk4">╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╰━━╯╰╯</span><span class="mtk6">\n</span><span class="mtk4">"""</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Handler</span><span class="mtk1">(</span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">BaseRequestHandler</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">handle</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8 mtku">signal</span><span class="mtk1">.</span><span class="mtk8">alarm</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">ReusableTCPServer</span><span class="mtk1">(</span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">ForkingMixIn</span><span class="mtk1">, </span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">TCPServer</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">pass</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk9 mtki">msg</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">s</span><span class="mtk1">.send(</span><span class="mtk9 mtki">msg</span><span class="mtk1">.encode())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">receiveMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk9 mtki">msg</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk9 mtki">msg</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">s</span><span class="mtk1">.recv(</span><span class="mtk6">4096</span><span class="mtk1">).decode().strip()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">bytes_to_bits</span><span class="mtk1">(</span><span class="mtk9 mtki">input</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk4">'08b'</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">input</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">DisruptionSpell</span><span class="mtk1">(</span><span class="mtk8 mtku">object</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">spawnScroll</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">intList</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">        </span><span class="mtk1">intList</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">n</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">intList</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">intList</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">intList</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk1">x1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">sum</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">x2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">x1</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">GCD</span><span class="mtk1">(</span><span class="mtk1">x2</span><span class="mtk1">, </span><span class="mtk1">x1</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">break</span>

<span class="mtk1">        </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">x2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">intList</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">x1</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">scrollOfWorthiness</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">disrupt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">scrollOfWorthiness</span><span class="mtk1">, </span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">)):</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">: </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk9 mtki">scrollOfWorthiness</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk1">disruptedFlag</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">()</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Wizard</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">108314726549199134030277012155370097074</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">31157724864730593494380966212158801467</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">attack</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span>
<span class="mtk1">        </span><span class="mtk1">spellAttack</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">spellAttack</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">dontAcceptDefeat</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">playerHealth</span><span class="mtk1">, </span><span class="mtk9 mtki">flag</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">flag</span><span class="mtk1">.lstrip(</span><span class="mtk4">'HTB{'</span><span class="mtk1">).rstrip(</span><span class="mtk4">'}'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">flag_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_bits</span><span class="mtk1">(</span><span class="mtk9 mtki">flag</span><span class="mtk1">.encode())</span>

<span class="mtk1">        </span><span class="mtk1">distruptionSpell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">DisruptionSpell</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">flag_bits</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">distruptionSpell</span><span class="mtk1">.</span><span class="mtk8">spawnScroll</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">distruptionSpell</span><span class="mtk1">.</span><span class="mtk8">disrupt</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">, </span><span class="mtk1">flag_bits</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">playerHealth</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">                          </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span>

<span class="mtk1">        </span><span class="mtk1">finalSpellIngredient</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span>
<span class="mtk1">                                                  </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1">)).</span><span class="mtk8">encode</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">finalSpellIngredient</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1">.</span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk1">finalSpellIngredient</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">finalSpell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">finalSpellIngredient</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">finalSpell</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk4">"You're a wizard Harry, "</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">disruptedFlag</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">(),</span>
<span class="mtk1">                </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">block_size</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">disruptedFlag</span><span class="mtk1">, </span><span class="mtk1">scrollOfWorthiness</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">encryptionWizard</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Wizard</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">100</span>
<span class="mtk1">    </span><span class="mtk1">wizardHealth</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">200</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk1">LOGO</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" * The Basilisk is approaching... *</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - You think you're a wizard?"</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">wizardHealth</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">receiveMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4"> &gt; "</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">spellAttack</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">encryptionWizard</span><span class="mtk1">.</span><span class="mtk8">attack</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">block</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">spellAttack</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - This is too easy...</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">spellAttack</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">wizardHealth</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - You won't be so lucky next time!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - You can't even save your self!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">s</span><span class="mtk1">.close()</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">disruptedFlag</span><span class="mtk1">, </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">encryptionWizard</span><span class="mtk1">.</span><span class="mtk8">dontAcceptDefeat</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk1">playerHealth</span><span class="mtk1">, </span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">scrollOfWorthinessSize</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4"> </span><span class="mtk6">{</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthinessSize</span><span class="mtk1">)</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">disruptedFlag</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk9 mtki">s</span><span class="mtk1">.close()</span>

<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">"Unexpected error occured.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">s</span><span class="mtk1">.close()</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">pass</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">TCPServer</span><span class="mtk1">.</span><span class="mtk1">allow_reuse_address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">    </span><span class="mtk1">server</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ReusableTCPServer</span><span class="mtk1">((</span><span class="mtk4">"0.0.0.0"</span><span class="mtk1">, </span><span class="mtk6">1337</span><span class="mtk1">), </span><span class="mtk8 mtku">Handler</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">server</span><span class="mtk1">.</span><span class="mtk8">serve_forever</span><span class="mtk1">()</span>
</code></pre></div><p>El servidor simula un juego en el que nosotros (como jugadores) debemos adivinar el número que ha generado el mago (<em>wizard</em>). Si nuestra suposición es correcta, el mago pierde un punto de salud; de lo contrario, nosotros perdemos un punto de salud:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 165.227.237.190 31839

╭━━━┳╮╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭╮╱╱╱╭╮
┃╭━╮┃┃╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭╯╰╮╱╱┃┃
┃┃╱┃┃╰━┳━┳━━┳━━┳━┳╮╱╭┳━┻╮╭╋━━┫╰━┳━┳━━╮  
┃╰━╯┃╭╮┃╭┫╭╮┃╭━┫╭┫┃╱┃┃╭╮┃┃┃╭╮┃╭╮┃╭┫╭╮┃
┃╭━╮┃╰╯┃┃┃╭╮┃╰━┫┃┃╰━╯┃╰╯┃╰┫╭╮┃╰╯┃┃┃╭╮┃
╰╯╱╰┻━━┻╯╰╯╰┻━━┻╯╰━╮╭┫╭━┻━┻╯╰┻━━┻╯╰╯╰╯
╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╭━╯┃┃┃
╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╱╰━━╯╰╯
 * The Basilisk is approaching... *
 - You think you're a wizard?
 &gt; 1234
 - This is too easy...
1053715130
 &gt; 1337
 - This is too easy...
751145160
 &gt;
</code></pre></div><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>El juego se implementa en este bucle <code>while</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">wizardHealth</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">block</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">receiveMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4"> &gt; "</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">spellAttack</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">encryptionWizard</span><span class="mtk1">.</span><span class="mtk8">attack</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">block</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">spellAttack</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">playerHealth</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - This is too easy...</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">spellAttack</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">wizardHealth</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk4">" - You won't be so lucky next time!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>  
</code></pre></div><p>Y el método <code>encryptionWizard.attack()</code> es este:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">attack</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span>
<span class="mtk1">        </span><span class="mtk1">spellAttack</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">spellAttack</span>
</code></pre></div><p>La expresión anterior es un generador lineal congruencial (<em>Linear Congruential Generator</em>, LCG):</p><p class="scroll">$$
s_{i + 1} = a \cdot s_i + c \mod{m}
$$</p><p>Sin embargo, las salidas $s_i$ se truncan. En la expresión anterior, ya sabemos $a$ (<code>self.armor</code>) y $m$ (<code>self.magicka</code>). Estos son los valores:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">108314726549199134030277012155370097074</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">31157724864730593494380966212158801467</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
</code></pre></div><p>Entonces, el problema aquí es que no se nos dan las salidas $s_i$, sino los 32 bits más significativos (<code>self.stamina = 32</code>). Sean $z_i$ los bits más significativos de $s_i$.</p><p>Encontré un <a target="_blank" href="https://jsur.in/posts/2020-09-20-downunderctf-2020-writeups#lsb-msb-calculation-game"><em>write-up</em> excelente de DownUnder CTF 2020</a> que tenía un LCG truncado, pero no es adaptable para este reto. Sin embargo, es un buen recurso para aprender más sobre LCG y el criptoanálisis basado en retículos (<em>lattices</em>).</p><h2 id="_hidden-number-problem_"><em>Hidden Number Problem</em></h2><p>Leyendo código de <a target="_blank" href="https://github.com/jvdsn/crypto-attacks">crypto-attacks</a> sobre LCG truncado, encontré una función que intenta recuperar los parámetros del LCG a partir de las salidas. Afortunadamente, ya tenemos $m$ y $a$, por lo que nos gustaría encontrar $c$ y $s_0$ (la semilla inicial).</p><p>Es extremadamente difícil encontrar los valores exactos de $c$ y $s_0$, pero hay que tener en cuenta que solo estamos interesados en los bits más significativos de $s_i$ para ganar el juego. Entonces, tal vez haya una manera de encontrar algunos valores que dan los resultados esperados en la mayoría de las rondas.</p><p>El código de <a target="_blank" href="https://github.com/jvdsn/crypto-attacks">crypto-attacks</a> utiliza un retículo para resolver el <em>Hidden Number Problem</em> (pero con dos números ocultos). Este problema se enuncia como $x_i = \alpha_i \cdot y - \beta_i \pmod{m}$, donde $y$ es el número oculto. Esta vez, podemos adaptarlo a $x_i = \alpha_{ij} \cdot y_j + \beta_i \pmod{m}$, y nos interesa $y_j$.</p><p>Supongamos que tomamos 10 salidas del juego. Entonces, sea $y_j = \begin{pmatrix} s_0 \\ c \end{pmatrix}$. Sea $\alpha_{ij}$:</p><p class="scroll">$$
\alpha_{ij} = \begin{pmatrix}
a &                                  1 \\
a^2 &                                  a + 1 \\
a^3 &                                  a^2 + a + 1 \\
a^4 &                                  a^3 + a^2 + a + 1 \\
a^5 &                               a^4 + a^3 + a^2 + a + 1 \\
a^6 &                         a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^7 &                   a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^8 &             a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^9 &       a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^{10} & a^9 + a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
\end{pmatrix}
$$</p><p>Y definimos $\beta_i$ como:</p><p class="scroll">$$
\beta_i = - \begin{pmatrix}
X \, z_1 \\
X \, z_2 \\
X \, z_3 \\
X \, z_4 \\
X \, z_5 \\
X \, z_6 \\
X \, z_7 \\
X \, z_8 \\
X \, z_9 \\
X \, z_{10} \\
\end{pmatrix}
$$</p><p>Donde $X$ es una cota superior de $x_i$. Por ejemplo, $2^{L - s}$, donde $L - s$ es la cantidad de bits ocultos para nosotros ($L$ es la longitud en bits de $m$ y $s = 32$).</p><p>Por tanto,</p><p class="scroll">$$
x_i = \alpha_{ij} \cdot y_j + \beta_i =
$$</p><p class="scroll">$$
\begin{pmatrix}
a &                                  1 \\
a^2 &                                  a + 1 \\
a^3 &                                  a^2 + a + 1 \\
a^4 &                                  a^3 + a^2 + a + 1 \\
a^5 &                               a^4 + a^3 + a^2 + a + 1 \\
a^6 &                         a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^7 &                   a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^8 &             a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^9 &       a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
a^{10} & a^9 + a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1 \\
\end{pmatrix} \begin{pmatrix} s_0 \\ c \end{pmatrix} - \begin{pmatrix}
X \, z_1 \\
X \, z_2 \\
X \, z_3 \\
X \, z_4 \\
X \, z_5 \\
X \, z_6 \\
X \, z_7 \\
X \, z_8 \\
X \, z_9 \\
X \, z_{10} \\
\end{pmatrix}
$$</p><p>Si operamos las matrices anteriores, tenemos este vector:</p><p class="scroll">$$
\begin{pmatrix}
a s_0 + c - X \, z_1 \\
a^2 s_0 + (a + 1) c - X \, z_2 \\
a^3 s_0 + (a^2 + a + 1) c - X \, z_3 \\
a^4 s_0 + (a^3 + a^2 + a + 1) c - X \, z_4 \\
a^5 s_0 + (a^4 + a^3 + a^2 + a + 1) c - X \, z_5 \\
a^6 s_0 + (a^5 + a^4 + a^3 + a^2 + a + 1) c - X \, z_6 \\
a^7 s_0 + (a^6 + a^5 + a^4 + a^3 + a^2 + a + 1) c - X \, z_7 \\
a^8 s_0 + (a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1) c - X \, z_8 \\
a^9 s_0 + (a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1) c - X \, z_9 \\
a^{10} s_0 + (a^9 + a^8 + a^7 + a^6 + a^5 + a^4 + a^3 + a^2 + a + 1) c - X \, z_{10} \\
\end{pmatrix}
$$</p><p>Y simplificando un poco más, tenemos lo siguiente:</p><p class="scroll">$$
x_i = \alpha_{ij} \cdot y_j + \beta_i = \begin{pmatrix}
a s_0 + c - X \, z_1 \\
a s_1 + c - X \, z_2 \\
a s_2 + c - X \, z_3 \\
a s_3 + c - X \, z_4 \\
a s_4 + c - X \, z_5 \\
a s_5 + c - X \, z_6 \\
a s_6 + c - X \, z_7 \\
a s_7 + c - X \, z_8 \\
a s_8 + c - X \, z_9 \\
a s_9 + c - X \, z_{10} \\
\end{pmatrix}
$$</p><p>Resumiendo, si podemos resolver el <em>Hidden Number Problem</em>, encontraremos $x_i$ (que son los bits ocultos de $s_i$) e $y_j$ (la semilla inicial $s_0$ y el incremento $c$).</p><p>El ataque funciona definiendo un retículo generado por las columnas de</p><p class="scroll">$$
\begin{pmatrix}
m &   &   &   &   &   &   &   &   &  &  \alpha_{1,1} &  \alpha_{1,2} &  \beta_1 - \frac{X}{2} \\
& m &   &   &   &   &   &   &   &  &  \alpha_{2,1} &  \alpha_{2,2} &  \beta_2 - \frac{X}{2} \\
&   & m &   &   &   &   &   &   &  &  \alpha_{3,1} &  \alpha_{3,2} &  \beta_3 - \frac{X}{2} \\
&   &   & m &   &   &   &   &   &  &  \alpha_{4,1} &  \alpha_{4,2} &  \beta_4 - \frac{X}{2} \\
&   &   &   & m &   &   &   &   &  &  \alpha_{5,1} &  \alpha_{5,2} &  \beta_5 - \frac{X}{2} \\
&   &   &   &   & m &   &   &   &  &  \alpha_{6,1} &  \alpha_{6,2} &  \beta_6 - \frac{X}{2} \\
&   &   &   &   &   & m &   &   &  &  \alpha_{7,1} &  \alpha_{7,2} &  \beta_7 - \frac{X}{2} \\
&   &   &   &   &   &   & m &   &  &  \alpha_{8,1} &  \alpha_{8,2} &  \beta_8 - \frac{X}{2} \\
&   &   &   &   &   &   &   & m &  &  \alpha_{9,1} &  \alpha_{9,2} &  \beta_9 - \frac{X}{2} \\
&   &   &   &   &   &   &   &   & m & \alpha_{10,1} & \alpha_{10,2} & \beta_{10} - \frac{X}{2} \\
&   &   &   &   &   &   &   &   &  &   \frac{X}{m} &               &  \\
&   &   &   &   &   &   &   &   &  &               &   \frac{X}{m} &  \\
&   &   &   &   &   &   &   &   &  &               &               &  X \\
\end{pmatrix}
$$</p><p>Nótese que el vector $\left(x_1 - \frac{X}{2}, \dots, x_{10} - \frac{X}{2}, s_0 \frac{X}{m}, c \frac{X}{m}, X\right)$ está dentro del retículo. Dado que puede considerarse un vector corto, podemos usar LLL para reducir la base y ver si está dentro de la nueva base. Luego, tomaremos las posiciones que corresponden a $ Y_1 $ y $ Y_2 $, que son las que son útiles para el reto.</p><p>Para más información, puedes leer <a target="_blank" href="https://eprint.iacr.org/2020/1540.pdf">este artículo</a> y el código de <a target="_blank" href="https://github.com/jvdsn/crypto-attacks">crypto-attacks</a>.</p><p>Esta es la implementación de esta parte del reto:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_round</span><span class="mtk1">(</span><span class="mtk9 mtki">io</span><span class="mtk1">, </span><span class="mtk9 mtki">guess</span><span class="mtk5">=</span><span class="mtk6">1337</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">io</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">guess</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">io</span><span class="mtk1">.recvline()</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk9 mtki">io</span><span class="mtk1">.recvline().decode()) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">hidden_number_problem</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">X</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">n2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> matrix(</span><span class="mtk6">QQ</span><span class="mtk1">, </span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">n1</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">n2</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">B</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">][</span><span class="mtk1">j</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk1">B</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span>
<span class="mtk1">        </span><span class="mtk1">B</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">n2</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">B</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1">, </span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> QQ(</span><span class="mtk9 mtki">m</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1">, </span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span>

<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">B</span><span class="mtk1">.LLL()</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">B</span><span class="mtk1">.rows():</span>
<span class="mtk1">        </span><span class="mtk1">xs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">n1</span><span class="mtk1">)]</span>
<span class="mtk1">        </span><span class="mtk1">ys</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">n2</span><span class="mtk1">)]</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">ys</span><span class="mtk1">) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">v</span><span class="mtk1">[</span><span class="mtk1">n1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">n2</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">X</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">xs</span><span class="mtk1">, </span><span class="mtk1">ys</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">crack_tlcg</span><span class="mtk1">(</span><span class="mtk9 mtki">yj</span><span class="mtk1">, </span><span class="mtk9 mtki">k</span><span class="mtk1">, </span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">X</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> (</span><span class="mtk9 mtki">k</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">s</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">alpha</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [[</span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">]]</span>
<span class="mtk1">    </span><span class="mtk1">beta</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk5">-</span><span class="mtk1">X</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">yj</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">alpha</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">beta</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">alpha</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">([</span><span class="mtk1">alpha</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, (</span><span class="mtk1">alpha</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">])</span>

<span class="mtk1">    </span><span class="mtk1">_</span><span class="mtk1">, (</span><span class="mtk1">s0</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">hidden_number_problem</span><span class="mtk1">(</span><span class="mtk1">alpha</span><span class="mtk1">, </span><span class="mtk1">beta</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk1">X</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">, </span><span class="mtk1">s0</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">LCG</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk9 mtki">c</span><span class="mtk1">, </span><span class="mtk9 mtki">s0</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">s</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">c</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">state</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">s0</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">state</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">state</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">state</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">s</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">M</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">108314726549199134030277012155370097074</span><span class="mtk1">, </span><span class="mtk6">31157724864730593494380966212158801467</span>  
<span class="mtk1">    </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">M</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">32</span>

<span class="mtk1">    </span><span class="mtk1">Y</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8">do_round</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">)]</span>

<span class="mtk1">    </span><span class="mtk1">_</span><span class="mtk1">, </span><span class="mtk1">_</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">, </span><span class="mtk1">s0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">crack_tlcg</span><span class="mtk1">(</span><span class="mtk1">Y</span><span class="mtk1">, </span><span class="mtk1">k</span><span class="mtk1">, </span><span class="mtk1">s</span><span class="mtk1">, </span><span class="mtk1">M</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">lcg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">LCG</span><span class="mtk1">(</span><span class="mtk1">M</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">s</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">, </span><span class="mtk1">s0</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">Y</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">lcg</span><span class="mtk1">.</span><span class="mtk8">next</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">AssertionError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">warning</span><span class="mtk1">(</span><span class="mtk4">'LCG failed. Trying again...'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk8">main</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'LCG cracked'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">player_health</span><span class="mtk1">, </span><span class="mtk1">wizard_health</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">90</span><span class="mtk1">, </span><span class="mtk6">200</span>

<span class="mtk1">    </span><span class="mtk1">prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Health'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">wizard_health</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">prog</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Player: </span><span class="mtk6">{</span><span class="mtk1">player_health</span><span class="mtk6">}</span><span class="mtk4"> | Wizard </span><span class="mtk6">{</span><span class="mtk1">wizard_health</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">do_round</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">, </span><span class="mtk1">lcg</span><span class="mtk1">.</span><span class="mtk8">next</span><span class="mtk1">()) </span><span class="mtk5">is</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">wizard_health</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">player_health</span><span class="mtk1"> </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk1">prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Player: </span><span class="mtk6">{</span><span class="mtk1">player_health</span><span class="mtk6">}</span><span class="mtk4"> | Wizard </span><span class="mtk6">{</span><span class="mtk1">wizard_health</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Obsérvese que usamos 10 rondas para obtener las salidas truncadas del LCG y luego nos aseguramos de que funcionan los parámetros del LCG. De lo contrario, comenzamos de nuevo.</p><h2 id="problema-del-_knapsack_">Problema del <em>knapsack</em></h2><p>Cuando el mago pierde el juego, se niega a perder y cifra la <em>flag</em> usando AES. La clave para este cifrado se toma del LCG, realizando tantas rondas como puntos de salud del jugador:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">dontAcceptDefeat</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">playerHealth</span><span class="mtk1">, </span><span class="mtk9 mtki">flag</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">flag</span><span class="mtk1">.lstrip(</span><span class="mtk4">'HTB{'</span><span class="mtk1">).rstrip(</span><span class="mtk4">'}'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">flag_bits</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_bits</span><span class="mtk1">(</span><span class="mtk9 mtki">flag</span><span class="mtk1">.encode())</span>

<span class="mtk1">        </span><span class="mtk1">distruptionSpell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">DisruptionSpell</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">flag_bits</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">distruptionSpell</span><span class="mtk1">.</span><span class="mtk8">spawnScroll</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">distruptionSpell</span><span class="mtk1">.</span><span class="mtk8">disrupt</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">, </span><span class="mtk1">flag_bits</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">playerHealth</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">armor</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">                          </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">critChance</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span>

<span class="mtk1">        </span><span class="mtk1">finalSpellIngredient</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">spell</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">magicka</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span>  
<span class="mtk1">                                                  </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">stamina</span><span class="mtk1">)).</span><span class="mtk8">encode</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">finalSpellIngredient</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1">.</span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk1">finalSpellIngredient</span><span class="mtk1">).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">finalSpell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">finalSpellIngredient</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">finalSpell</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk4">"You're a wizard Harry, "</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">disruptedFlag</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">(),</span>
<span class="mtk1">                </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">block_size</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">disruptedFlag</span><span class="mtk1">, </span><span class="mtk1">scrollOfWorthiness</span>
</code></pre></div><p>Como ya hemos roto el LCG, podemos encontrar esa clave fácilmente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">player_health</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">lcg</span><span class="mtk1">.</span><span class="mtk8">next</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">lcg</span><span class="mtk1">.</span><span class="mtk8">next</span><span class="mtk1">()).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>  
<span class="mtk1">    </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_CBC</span><span class="mtk1">)</span>
</code></pre></div><p>El mago usa AES para cifrar este mensaje: <code>You're a wizard Harry, &lt;enc_flag></code>. El modo de operación es AES CBC, con un IV desconocido. Sin embargo, esto no es un problema, ya que solo el primer bloque no se descifrará correctamente. El resto de los bloques serán correctos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">message</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unpad</span><span class="mtk1">(</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">enc_message</span><span class="mtk1">), </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">block_size</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">warning</span><span class="mtk1">(</span><span class="mtk4">'Padding error. Trying again...'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">main</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Encrypted message: </span><span class="mtk6">{</span><span class="mtk1">message</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">enc_flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">message</span><span class="mtk1">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Harry, '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
</code></pre></div><p>Nos importa el número que aparece en <code>&lt;enc_flag></code>, el cual es el resultado de un cifrado de <em>knapsack</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">disrupt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">scrollOfWorthiness</span><span class="mtk1">, </span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">)):</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">flag_bits</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">: </span><span class="mtk1">disruptedFlag</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk9 mtki">scrollOfWorthiness</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>  

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk1">disruptedFlag</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">()</span>
</code></pre></div><p>Particularmente, está utilizando un <a target="_blank" href="https://es.wikipedia.org/wiki/Criptosistema_de_Merkle-Hellman">criptosistema <em>knapsack</em> de Merkle-Hellman</a>. Básicamente, toma el texto a cifrar en formato binario, multiplica cada bit por el índice correspondiente de la clave pública y suma todos los resultados intermedios (que son 32 números). Sea $u_n$ una secuencia de $0$ y $1$ tal que $m = \displaystyle\sum_{i = 0}^{31} u_i \cdot 2^i$, donde $m$ es el número que se cifrará. Entonces, el número cifrado es $b$:</p><p class="scroll">$$
b = \sum_{i = 0}^{31} a_i \cdot u_i
$$</p><p>Donde $a_i$ es la clave pública configurada por el servidor.</p><p>Antes de enviar el mensaje cifrado con AES, se nos da la clave pública del <em>knapsack</em> y la longitud de la <em>flag</em> en bits:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk1">disruptedFlag</span><span class="mtk1">, </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">encryptionWizard</span><span class="mtk1">.</span><span class="mtk8">dontAcceptDefeat</span><span class="mtk1">(</span>  
<span class="mtk1">                </span><span class="mtk1">playerHealth</span><span class="mtk1">, </span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">scrollOfWorthinessSize</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4"> </span><span class="mtk6">{</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">scrollOfWorthinessSize</span><span class="mtk1">)</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">scrollOfWorthiness</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk8">sendMessage</span><span class="mtk1">(</span><span class="mtk9 mtki">s</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">disruptedFlag</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
</code></pre></div><p>Tomaremos todos los parámetros con este trozo de código usando un pequeño truco:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">length</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Flag length: </span><span class="mtk6">{</span><span class="mtk1">length</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">8}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">public_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk1">length</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">public_key</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">()))</span>  
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">enc_message</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><p>Dado que el objeto cifrado es la <em>flag</em>, todos los caracteres son códigos ASCII válidos (menos de <code>0x7f</code>). Por lo tanto, los bits en índices múltiplo de 8 serán siempre <code>0</code> (por eso omitimos esos índices y no los metemos en la lista de clave pública).</p><p>En este punto, resolveremos el problema del <em>knapsack</em> utilizando un ataque basado en retículo y LLL (para obtener más información sobre esta técnica, eche un vistazo a <a target="_blank" href="../infinite-knapsack">Infinite Knapsack</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">knapsack</span><span class="mtk1">(</span><span class="mtk9 mtki">a_i</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">], </span><span class="mtk9 mtki">b</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">int</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">M</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> matrix(</span><span class="mtk6">ZZ</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a_i</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">a_i</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk9 mtki">a_i</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">M</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">        </span><span class="mtk1">M</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">a</span>

<span class="mtk1">    </span><span class="mtk1">M</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk9 mtki">b</span>

<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">M</span><span class="mtk1">.LLL()</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">u_i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">B</span><span class="mtk1">.rows():</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> {</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">} </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">u_i</span><span class="mtk1">[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">sum</span><span class="mtk1">(</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">u</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">zip</span><span class="mtk1">(</span><span class="mtk9 mtki">a_i</span><span class="mtk1">, </span><span class="mtk1">u_i</span><span class="mtk1">)):</span>  
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">u_i</span><span class="mtk1">[:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">bin2dec</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">]) -&gt; </span><span class="mtk8 mtku">int</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">)), </span><span class="mtk6">2</span><span class="mtk1">)</span>
</code></pre></div><p>Y una vez que obtenemos todos los bits, necesitamos agregar el <code>0</code> que nos saltamos antes:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk8">knapsack</span><span class="mtk1">(</span><span class="mtk1">public_key</span><span class="mtk1">, </span><span class="mtk1">enc_flag</span><span class="mtk1">)):</span>
<span class="mtk1">        </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8">bin2dec</span><span class="mtk1">([</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">r</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1"> : </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1">]]) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">), </span><span class="mtk6">7</span><span class="mtk1">)]</span>  
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'HTB{'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(</span><span class="mtk8">chr</span><span class="mtk1">, </span><span class="mtk1">flag</span><span class="mtk1">)) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">'}'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">warning</span><span class="mtk1">(</span><span class="mtk4">'Knapsack failed. Trying again...'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Ahora podemos unir todas las partes y esperar que el ataque sea exitoso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 139.59.184.45:30535
[<span class="code-green">+</span>] Opening connection to 139.59.184.45 on port 30535: Done
[<span class="code-green">+</span>] LCG cracked
[<span class="code-green">+</span>] Health: Player: 74 | Wizard 0
[<span class="code-blue">*</span>] Flag length: 36
[<span class="code-blue">*</span>] Closed connection to 139.59.184.45 port 30535
[<span class="code-yellow">!</span>] Padding error. Trying again...
[<span class="code-green">+</span>] Opening connection to 139.59.184.45 on port 30535: Done
[<span class="code-green">+</span>] LCG cracked
[<span class="code-green">+</span>] Health: Player: 59 | Wizard 0
[<span class="code-blue">*</span>] Flag length: 36
[<span class="code-blue">*</span>] Closed connection to 139.59.184.45 port 30535
[<span class="code-blue">*</span>] Encrypted message: b'\xe9\xcb=\x81+&\x1c\x7f\x17\rS\x84\xd2\xec\x90\xbdHarry, 531241055385a8abb32946e08f3b84a8f891fe86d22d03d540cd0028b6ad738f3b802d05dc5eff2c6ddcb71bfdfa5216af'
[<span class="code-yellow">!</span>] Knapsack failed. Trying again...
[<span class="code-green">+</span>] Opening connection to 139.59.184.45 on port 30535: Done
[<span class="code-green">+</span>] LCG cracked
[<span class="code-green">+</span>] Health: Player: 74 | Wizard 0
[<span class="code-blue">*</span>] Flag length: 36
[<span class="code-blue">*</span>] Closed connection to 139.59.184.45 port 30535
[<span class="code-blue">*</span>] Encrypted message: b'\x07\x98}\x9c*\x1e\x99u\x0f\x07\x8ak\xbe\xa8\xc00Harry, 1600d8f64cd991497e4f47d4a4ab48abf25b04c0fa20be5a5da40ad956b4be17d51b023aabbea7d20ea4a12b73ecbc176f91'  
[<span class="code-yellow">!</span>] Knapsack failed. Trying again...
[<span class="code-green">+</span>] Opening connection to 139.59.184.45 on port 30535: Done
[<span class="code-yellow">!</span>] LCG failed. Trying again...
[<span class="code-blue">*</span>] Closed connection to 139.59.184.45 port 30535
[<span class="code-green">+</span>] Opening connection to 139.59.184.45 on port 30535: Done
[<span class="code-green">+</span>] LCG cracked
[<span class="code-green">+</span>] Health: Player: 72 | Wizard 0
[<span class="code-blue">*</span>] Flag length: 36
[<span class="code-blue">*</span>] Closed connection to 139.59.184.45 port 30535
[<span class="code-blue">*</span>] Encrypted message: b':(B\x98\xd7\xa8|\xa8,\xb8\x14z\xfe\x07q\x9aHarry, 02a4c39eb0e2eea5e01fc259e630e06377275e81801cc21d8b5b3ab1b35e403eceeb0676a7dd5d9c0a4d7c9bff648beccbd4'
[<span class="code-green">+</span>] HTB{2_14771c3_ch4113n935_837732_7h4n_0n3}
</code></pre></div><p>El <em>script</em> completo se puede encontrar aquí: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Crypto/AbraCryptabra/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a></li><li><a href="#_hidden-number-problem_"><em>Hidden Number Problem</em></a></li><li><a href="#problema-del-_knapsack_">Problema del <em>knapsack</em></a></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>