<!doctype html><html lang="es"><head><title>Blessed | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="BLS12-381. Firmas BLS. Ataque de _rogue key_. Prueba de conocimiento cero. EC-LCG. Reducción de retículo mediante LLL"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="BLS12-381. Firmas BLS. Ataque de _rogue key_. Prueba de conocimiento cero. EC-LCG. Reducción de retículo mediante LLL"><meta itemprop="keywords" content><meta itemprop="name" content="Blessed"><meta property="article:published_time" content><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="BLS12-381. Firmas BLS. Ataque de _rogue key_. Prueba de conocimiento cero. EC-LCG. Reducción de retículo mediante LLL"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Blessed"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/ctf/htb-challenges/crypto/blessed/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="BLS12-381. Firmas BLS. Ataque de _rogue key_. Prueba de conocimiento cero. EC-LCG. Reducción de retículo mediante LLL"><meta name="twitter:description" content="BLS12-381. Firmas BLS. Ataque de _rogue key_. Prueba de conocimiento cero. EC-LCG. Reducción de retículo mediante LLL"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Blessed"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/ctf/htb-challenges/crypto/blessed/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/ctf/htb-challenges/crypto/blessed/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/ctf/htb-challenges/crypto/blessed/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/ctf/htb-challenges/crypto/blessed/&amp;text=Blessed" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/ctf/htb-challenges/crypto/blessed/&amp;title=Blessed" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Blessed</h1><p class="mb4 f6 dib tracked">23 minutos de lectura</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#firmas-bls">Firmas BLS</a></li><li><a href="#prueba-de-conocimiento-cero">Prueba de conocimiento cero</a></li><li><a href="#ec-lcg">EC-LCG</a></li></ul></li><li><a href="#solución">Solución</a><ul><li><a href="#implementación">Implementación</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>Este es un reto que diseñé para Hack the Box. Se nos proporciona el código fuente en Python del servidor que contiene la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">eth_typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">, </span><span class="mtk1">BLSPubkey</span><span class="mtk1">, </span><span class="mtk1">BLSSignature</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secrets</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">randbelow</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">Dict</span><span class="mtk1">, </span><span class="mtk8 mtku">Generator</span><span class="mtk1">, </span><span class="mtk1">List</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">PublicKey</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">ciphersuites</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">G2ProofOfPossession</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">g2_primitives</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">point_compression</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">G1Compressed</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">optimized_bls12_381</span><span class="mtk1">.</span><span class="mtk8 mtku">optimized_curve</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">curve_order</span><span class="mtk1">, </span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk8">multiply</span><span class="mtk1">, </span><span class="mtk8">neg</span><span class="mtk1">, </span><span class="mtk8">normalize</span>


<span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'flag.txt'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">()</span>
<span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">FileNotFoundError</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'HTB</span><span class="mtk6">{f4k3_fl4g_f0r_t3st1ng}</span><span class="mtk4">'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">verified</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">:       </span><span class="mtk1">BLSPubkey</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">:      </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">json</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()}</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">:   </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">Robot</span><span class="mtk1">]                </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">Robot</span><span class="mtk1"> </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">r</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Do not lose your secret key!'</span><span class="mtk1">, </span><span class="mtk4">'sk'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk5">**</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">()}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pk</span><span class="mtk1">: </span><span class="mtk1">BLSPubkey</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a public key'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">), </span><span class="mtk9 mtki">verified</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot joined but not verified'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:]}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Verify</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'list'</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">agg_pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires an aggregated signature'</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">FastAggregateVerify</span><span class="mtk1">(</span><span class="mtk1">agg_pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Secrets have been unveiled!'</span><span class="mtk1">, </span><span class="mtk4">'flag'</span><span class="mtk1">: </span><span class="mtk1">FLAG</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid aggregated signature'</span><span class="mtk1">}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">help</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">'help'</span><span class="mtk1">:           </span><span class="mtk4">'Show this panel'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'create'</span><span class="mtk1">:         </span><span class="mtk4">'Generate a new robot, already verified'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'join'</span><span class="mtk1">:           </span><span class="mtk4">'Add a new robot, given a public key and a signatu</span><span class="mtk4">re'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'verify'</span><span class="mtk1">:         </span><span class="mtk4">'Start interactive process to verify a robot given</span><span class="mtk4"> an ID'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'list'</span><span class="mtk1">:           </span><span class="mtk4">'Return a list of all existing robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">: </span><span class="mtk4">'Show the secrets given an aggregated signature of</span><span class="mtk4"> all registered robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'exit'</span><span class="mtk1">:           </span><span class="mtk4">'Shutdown the SuperComputer'</span><span class="mtk1">,</span>
<span class="mtk1">        }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">run_cmd</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">: </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>
<span class="mtk1">        </span><span class="mtk1">cmd</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'cmd'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">pk</span><span class="mtk1">       </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'pk'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk1">sig</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSSignature</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'sig'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'robot_id'</span><span class="mtk1">, </span><span class="mtk4">'0'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'create'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'join'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">pk</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'verify'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'list'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">, </span><span class="mtk1">sig</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk1">sig</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'exit'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'exit'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">help</span><span class="mtk1">()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Welcome! You have been invited to use our SuperCo</span><span class="mtk4">mputer, which is very powerful and totally secure.</span><span class="mtk4"> Only sophisticated robots are able to use it, so </span><span class="mtk4">you need to create a robot to interact with the Su</span><span class="mtk4">perComputer or maybe join an existing one. The key</span><span class="mtk4"> to our success is that critical operations need t</span><span class="mtk4">he approval of all registered robots. Hackers cann</span><span class="mtk4">ot beat our security!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk4">'Architects/Engineers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Explosives Experts/Demolition Specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Hackers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Stealth/Infiltration specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Scavengers'</span><span class="mtk1">,</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">sc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> {</span><span class="mtk4">'Hackers'</span><span class="mtk1">}))  </span><span class="mtk3"># No hackers here...</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk1">sc</span><span class="mtk1">.</span><span class="mtk8">help</span><span class="mtk1">(), </span><span class="mtk9 mtki">indent</span><span class="mtk5">=</span><span class="mtk6">2</span><span class="mtk1">), </span><span class="mtk9 mtki">end</span><span class="mtk5">=</span><span class="mtk4">'</span><span class="mtk6">\n\n</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">sc</span><span class="mtk1">.</span><span class="mtk8">run_cmd</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'&gt; '</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">), </span><span class="mtk9 mtki">end</span><span class="mtk5">=</span><span class="mtk4">'</span><span class="mtk6">\n\n</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">'error'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">res</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">break</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><h2 id="análisis-del-código-fuente">Análisis del código fuente</h2><p>El servidor define una instancia de <code>SuperComputer</code>, y nos permite interactuar con él usando estos comandos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">help</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">'help'</span><span class="mtk1">:           </span><span class="mtk4">'Show this panel'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'create'</span><span class="mtk1">:         </span><span class="mtk4">'Generate a new robot, already verified'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'join'</span><span class="mtk1">:           </span><span class="mtk4">'Add a new robot, given a public key and a signatu</span><span class="mtk4">re'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'verify'</span><span class="mtk1">:         </span><span class="mtk4">'Start interactive process to verify a robot given</span><span class="mtk4"> an ID'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'list'</span><span class="mtk1">:           </span><span class="mtk4">'Return a list of all existing robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">: </span><span class="mtk4">'Show the secrets given an aggregated signature of</span><span class="mtk4"> all registered robots'</span><span class="mtk1">,</span>  
<span class="mtk1">            </span><span class="mtk4">'exit'</span><span class="mtk1">:           </span><span class="mtk4">'Shutdown the SuperComputer'</span><span class="mtk1">,</span>
<span class="mtk1">        }</span>
</code></pre></div><p>Para eso, necesitaremos crear un robot, ya que necesitamos una clave secreta para firmar nuestros comandos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Do not lose your secret key!'</span><span class="mtk1">, </span><span class="mtk4">'sk'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk5">**</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">()}</span>  
</code></pre></div><p>El método anterior devuelve una instancia de <code>Robot</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">verified</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">:       </span><span class="mtk1">BLSPubkey</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">:      </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">json</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()}</span>  
</code></pre></div><p>Observe que el ID del robot es el resultado de este PRNG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>  
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
</code></pre></div><p>Además, observe que el <code>SuperComputer</code> ya tiene un total de 4 robots:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">:   </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">()</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">Robot</span><span class="mtk1">]                </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>
</code></pre></div><p>Porque se crea de la siguiente manera:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk4">'Architects/Engineers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Explosives Experts/Demolition Specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Hackers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Stealth/Infiltration specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Scavengers'</span><span class="mtk1">,</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">sc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> {</span><span class="mtk4">'Hackers'</span><span class="mtk1">}))  </span><span class="mtk3"># No hackers here...</span>  
</code></pre></div><p>Una vez que tenemos un robot, podemos usar la clave secreta para firmar un comando. Por ejemplo, podemos ejecutar <code>list</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Verify</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'list'</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">]</span>
</code></pre></div><p>Este método devolverá la identificación de todos los robots registrados en el <code>SuperComputer</code>. Esto podría ser necesario para romper el PRNG.</p><p>Además, podemos ejecutar <code>join</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pk</span><span class="mtk1">: </span><span class="mtk1">BLSPubkey</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a public key'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">), </span><span class="mtk9 mtki">verified</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot joined but not verified'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:]}</span>  
</code></pre></div><p>Con este método podemos agregar un robot existente al <code>SuperComputer</code> usando su clave pública. La diferencia con <code>create</code> es que el nuevo robot no se verifica, por lo que necesitamos ejecutar <code>verify</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>  

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>
</code></pre></div><p>Este método ejecuta un proceso de verificación interactivo para garantizar que la clave pública del robot sea válida, pero sin revelar la clave secreta asociada. Esto se conoce como <a target="_blank" href="https://es.wikipedia.org/wiki/Prueba_de_conocimiento_cero">prueba de conocimiento cero</a> (ZKP, <em>zero-knowledge proof</em>).</p><p>El comando objetivo que queremos ejecutar para resolver el reto es <code>unveil_secrets</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">agg_pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires an aggregated signature'</span><span class="mtk1">}</span>  
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">FastAggregateVerify</span><span class="mtk1">(</span><span class="mtk1">agg_pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Secrets have been unveiled!'</span><span class="mtk1">, </span><span class="mtk4">'flag'</span><span class="mtk1">: </span><span class="mtk1">FLAG</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid aggregated signature'</span><span class="mtk1">}</span>
</code></pre></div><p>Para esto, necesitamos una firma agregada de todos los robots verificados, lo que significa que cada robot debe haber firmado este comando. De lo contrario, la verificación fallará y no ejecutaremos el comando con éxito.</p><h3 id="firmas-bls">Firmas BLS</h3><p>El servidor usa <a target="_blank" href="https://en.wikipedia.org/wiki/BLS_digital_signature">firmas BLS</a>, que implican criptografía basada en emparejamientos. La librería <a target="_blank" href="https://pypi.org/project/py-ecc/"><code>py-ecc</code></a> hace una buena abstracción de lo que sucede por detrás.</p><p>Básicamente, la firma BLS está utilizando dos curvas elípticas $\mathbb{G}_1$ y $\mathbb{G}_2$ (conocidas como BLS12-381), cuyos puntos generadores son $G_1$ y $G_2$. Estas curvas son <em>pairing-friendly</em>, lo que significa que se puede definir una función de emparejamiento aquí.</p><p>La idea es que se pueden asociar dos puntos de las curvas elípticas para devolver otro punto de otra curva elíptica, que es $\mathbb{G}_T$. Particularmente, un emparejamiento es una función bilineal:</p><p class="scroll">$$
e: \mathbb{G}_1 \times \mathbb{G}_2 \to \mathbb{G}_T
$$</p><p>La propiedad bilineal significa que las siguientes expresiones se mantienen para $P, R \in \mathbb{G}_1$ y $Q, S \in \mathbb{G}_2$:</p><p class="scroll">$$
\begin{align*}
e(P + R, Q) = e(P, Q) \cdot e(R, Q) \\
e(P, Q + S) = e(P, Q) \cdot e(P, S)
\end{align*}
$$</p><p>Como resultado, para cualesquiera escalares $a$ y $b$, las siguientes expresiones también se mantienen:</p><p class="scroll">$$
\begin{align*}
e(a \cdot P, b \cdot Q) & = e(P, b \cdot Q)^a \\
          & = e(a \cdot P, Q)^b \\
          & = e(P, Q)^{ab} \\
               & = e(b \cdot P, Q)^a \\
          & = e(P, a \cdot Q)^b \\
          & = e(b \cdot P, a \cdot Q) \\
    & = e(ab \cdot P, Q) \\
           & = e(P, ab \cdot Q)
\end{align*}
$$</p><p>Esta propiedad bilineal permite definir el esquema de firma BLS:</p><ul><li>Un usuario toma un entero aleatorio $\mathrm{sk}$ y calcula su clave pública como $\mathrm{Pk} = \mathrm{sk} \cdot G_1$</li><li>Para firmar un mensaje $m$, el mensaje debe ser transformado a un punto de la curva mediante una función de <em>hash</em> (hay varios métodos para hacer esto), por lo que $H(m) \in \mathbb{G}_2$</li><li>La firma es $\sigma = \mathrm{sk} \cdot H(m) \in \mathbb{G}_2$</li></ul><p>Es el proceso de verificación el que implica el emparejamiento. El verificador solo necesita calcular $e(\mathrm{Pk}, H(m))$ y compararlo con $e(G_1, \sigma)$. Esto funciona porque:</p><p class="scroll">$$
\begin{align*}
e(\mathrm{Pk}, H(m)) & = e(\mathrm{sk} \cdot G_1, H(m)) \\
& = e(G_1, H(m))^{\mathrm{sk}} \\
 & = e(G_1, \mathrm{sk} \cdot H(m)) \\
& = e(G_1, \sigma)
\end{align*}
$$</p><p>La relevancia de las firmas BLS viene con el hecho de que las firmas pueden agregarse. Entonces, en lugar de verificar la firma de un mensaje contra varias claves públicas, es suficiente para verificar una sola firma agregada contra una sola clave pública agregada:</p><p class="scroll">$$
\begin{align*}
\sigma_{\mathrm{agg}} = \sigma_1 + \sigma_2 + \dots + \sigma_n \\
\mathrm{Pk}_{\mathrm{agg}} = \mathrm{Pk}_1 + \mathrm{Pk}_2 + \dots + \mathrm{Pk}_n \\ \\
e(\mathrm{Pk}_{\text{agg}}, H(m)) \stackrel{?}{=} e(G_1, \sigma_{\text{agg}})
\end{align*}
$$</p><p>Sin embargo, hay un problema con la agregación si un atacante puede usar una clave pública arbitraria. El atacante puede forjar una firma agregada para un mensaje determinado, esto es, decir que algún usuario víctima ha firmado un mensaje:</p><ul><li>El atacante usa la siguiente clave pública: $\mathrm{Pk}_\text{attacker} = \mathrm{sk}_\text{attacker} \cdot G_1 - \mathrm{Pk}_\text{victim}$</li><li>La firma agregada forjada es: $\sigma_\text{forged} = \mathrm{sk}_\text{attacker} \cdot H(m)$</li><li>El verificador comprobará que $e(\mathrm{Pk}_\text{victim} + \mathrm{Pk}_\text{attacker}, H(m))$ es igual que $e(G_1, \sigma_{\text{forged}})$</li></ul><p>Y funciona porque</p><p class="scroll">$$
\begin{align*}
e(\mathrm{Pk}_\text{victim} + \mathrm{Pk}_\text{attacker}, H(m)) & = e(\mathrm{Pk}_\text{victim} + \mathrm{sk}_\text{attacker} \cdot G_1 - \mathrm{Pk}_\text{victim}, H(m)) \\
& = e(\mathrm{sk}_\text{attacker} \cdot G_1, H(m)) \\
& = e(G_1, H(m))^{\mathrm{sk}_\text{attacker}} \\
& = e(G_1, \mathrm{sk}_\text{attacker} \cdot H(m)) \\
& = e(G_1, \sigma_{\text{forged}})
\end{align*}
$$</p><p>Esto se conoce como ataque de <em>rogue key</em>. La forma de evitarlo es usando una &ldquo;prueba de posesión&rdquo;, que es verificar que el usuario que tiene una clave pública conoce la clave secreta asociada. Normalmente, el usuario debe proporcionar una firma de la propia clave pública, lo que demuestra que el usuario conoce la clave secreta asociada a la clave pública. Otros métodos pueden involucrar pruebas de conocimiento cero.</p><p>Para obtener más información sobre las curvas BLS12-381 y las firmas BLS, consulte <a target="_blank" href="https://hackmd.io/@benjaminion/bls12-381">BLS12-381 For The Rest Of Us</a> o <a target="_blank" href="https://medium.com/nethermind-eth/bls-signatures-withdrawals-bbf38658c242">BLS Signatures & Withdrawals</a>.</p><h3 id="prueba-de-conocimiento-cero">Prueba de conocimiento cero</h3><p>La forma de evitar el ataque de <em>rogue key</em> en este reto es mediante una prueba de conocimiento cero interactiva: se pretende que el usuario demuestre que sabe $\mathrm{sk}$ tal que $\mathrm{Pk} = \mathrm{sk} \cdot G_1$, pero sin revelar $\mathrm{sk}$.</p><p>Para lograr esto, el servidor le dice al usuario que elija un entero aleatorio $x$ y que envíe $C = x \cdot G_1$. Luego, el servidor elige al azar una de estas dos preguntas:</p><ol><li>Muéstrame $x$</li><li>Muéstrame el resultado de $(\mathrm{sk} + x)$</li></ol><p>Si la pregunta es la 1., entonces el servidor puede verificar fácilmente que el valor $x$ satisface que $C = x \cdot G_1$.</p><p>Si la pregunta es la 2., entonces el servidor puede verificar que el valor dado $(\mathrm{sk} + x$) satisface que $\mathrm{Pk} + C = (\mathrm{sk} + x) \cdot G_1$.</p><p>Si este experimento se repite varias veces y el usuario no puede predecir la pregunta, entonces es prácticamente imposible mentir en el protocolo de ZKP:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>  

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>
</code></pre></div><p>Si el atacante puede predecir la pregunta, entonces el atacante puede engañar al protocolo de ZKP (es decir, demostrar que sabe $\mathrm{sk}$ tal que $\mathrm{Pk}_\text{attacker} = \mathrm{sk} \cdot G_1$, cuando no es verdad):</p><ul><li>Para la pregunta 1., el atacante simplemente envía el valor de $x$ tal que $C = x \cdot G_1$</li><li>Pero para la pregunta 2., puede calcular un valor especial de $C = \mathrm{sk}_x \cdot G_1 - \mathrm{Pk}_\text{attacker}$, enviarlo, y después usar $\mathrm{sk}_x$ como si fuera $(\mathrm{sk} + x)$. El servidor verificará que $\mathrm{Pk}_\text{attacker} + C = \mathrm{sk}_x \cdot G_1$, que es cierto porque</li></ul><p class="scroll">$$
\mathrm{Pk}_\text{attacker} + C = \mathrm{Pk}_\text{attacker} + \mathrm{sk}_x \cdot G_1 - \mathrm{Pk}_\text{attacker} = \mathrm{sk}_x \cdot G_1
$$</p><h3 id="ec-lcg">EC-LCG</h3><p>El servidor utiliza esta instancia PRNG para elegir la pregunta para el protocolo de ZKP. Entonces, tendremos que romper el PRNG para predecir preguntas y, por lo tanto, engañar al protocolo de ZKP:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>  
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
</code></pre></div><p>Este algoritmo es un EC-LCG que usa la curva <a target="_blank" href="https://neuromancer.sk/std/nist/P-256">P256</a>, denotada por $E(\mathbb{F}_p)$, de la siguiente manera:</p><p class="scroll">$$
\begin{cases}
W_0 & = \mathrm{seed} \cdot G + B \\
  W_n & = W_{n - 1} + G \\
  r_{2 n - 1} & = (W_n)_\mathrm{x} \gg 32 \\
  r_{2 n} & = (W_n)_\mathrm{y} \gg 32 \\
\end{cases}
$$</p><p>Donde $B, G \in E(\mathbb{F}_p)$, $\mathrm{seed} \in \mathbb{Z}$ y $n > 0$. Las salidas del PRNG son $r_i$:</p><p class="scroll">$$
\begin{cases}
r_1 & = (W_1)_\mathrm{x} \gg 32 \\
  r_2 & = (W_1)_\mathrm{y} \gg 32 \\
  r_3 & = (W_2)_\mathrm{x} \gg 32 \\
  r_4 & = (W_2)_\mathrm{y} \gg 32 \\
  \dots
\end{cases}
$$</p><p>Lo mismo se puede expresar de la siguiente manera:</p><p class="scroll">$$
\begin{cases}
W_n & = (\mathrm{seed} + n) \cdot G + B \\
r_{2 n - 1} & = (W_n)_\mathrm{x} \gg 32 \\
  r_{2 n} & = (W_n)_\mathrm{y} \gg 32
\end{cases}
$$</p><p>La clave para romper esta implementación de EC-LCG es que $W_{n + 1} - W_n = G$. Sin embargo, no se nos dan los valores exactos de $(W_n)_\text{x}$ y $(W_n)_\text{y}$, Entonces no podemos simplemente encontrar un punto $W_n$ para romper el EC-LCG. En cambio, podemos escribir algunas ecuaciones con la información que conocemos.</p><p>Usemos la siguiente notación para las salidas conocidas:</p><p class="scroll">$$
u_n = r_{2n - 1} = (W_n)_\mathrm{x} \gg 32 \qquad v_n = r_{2n} = (W_n)_\mathrm{y} \gg 32
$$</p><p>Y estos para las incógnitas:</p><p class="scroll">$$
a_n = W_n - \big((W_n)_\mathrm{x} \gg 32\big) \ll 32 \qquad b_n = W_n - \big((W_n)_\mathrm{y} \gg 32\big) \ll 32
$$</p><p>Conocemos los parámetros de la curva y el punto del generador $G$ (<a target="_blank" href="https://neuromancer.sk/std/nist/P-256">P256</a>). Sabemos que $(u_n + a_n, v_n + b_n) \in E(\mathbb{F}_p)$, por lo que:</p><p class="scroll">$$
(v_n + b_n)^2 = (u_n + a_n)^3 + a \cdot (u_n + a_n) + b \mod{p}
$$</p><p>Además, sabemos que</p><p class="scroll">$$
G = W_{n + 1} - W_n = (u_{n + 1} + a_{n + 1}, v_{n + 1} + b_{n + 1}) - (u_n + a_n, v_n + b_n)
$$</p><p>Esto se puede expresar utilizando fórmulas de suma de puntos:</p><p class="scroll">$$
\begin{cases}
(x_1, y_1) + (x_2, y_2) = (x_3, y_3) \\ \\
\lambda = (y_2 - y_1) \cdot (x_2 - x_1)^{-1} \mod{p} \\
x_3 = \lambda^2 - x_1 - x_2 \\
y_3 = \lambda \cdot (x_1 - x_3) - y_1
\end{cases}
$$</p><p>Nosotras podemos deshacernos de $\lambda$ en la fórmula de $x_3$:</p><p class="scroll">$$
\begin{align*}
x_3 & = \lambda^2 - x_1 - x_2 \iff \\
 x_3 & = \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big)^2 - x_1 - x_2 \iff \\
x_3 & = (y_2 - y_1)^2 \cdot (x_2 - x_1)^{-2} - x_1 - x_2 \iff \\
0 & = x_3 - (y_2 - y_1)^2 \cdot (x_2 - x_1)^{-2} + x_1 + x_2 \iff \\
0 & = x_3 \cdot (x_2 - x_1)^2 - (y_2 - y_1)^2 + (x_1 + x_2) \cdot (x_2 - x_1)^2 \iff \\
0 & = (x_1 + x_2 + x_3) \cdot (x_2 - x_1)^2 - (y_2 - y_1)^2
\end{align*}
$$</p><p>Y lo mismo con la fórmula de $y_3$:</p><p class="scroll">$$
\begin{align*}
y_3 & = \lambda \cdot (x_1 - x_3) - y_1 \iff \\
y_3 & = \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big) \cdot (x_1 - x_3) - y_1 \iff \\
0 & = y_3 - \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big) \cdot (x_1 - x_3) + y_1 \iff \\
0 & = y_3 - (y_2 - y_1) \cdot (x_2 - x_1)^{-1} \cdot (x_1 - x_3) + y_1 \iff \\
0 & = y_3 \cdot (x_2 - x_1) - (y_2 - y_1) \cdot (x_1 - x_3) + y_1 \cdot (x_2 - x_1) \iff \\
0 & = (y_3 + y_1) \cdot (x_2 - x_1) - (y_2 - y_1) \cdot (x_1 - x_3)
\end{align*}
$$</p><p>Dado que tenemos más incógnitas que ecuaciones, pero las incógnitas lineales están acotadas a $2^{32}$, podemos usar un retículo (<em>lattice</em>) para resolver el problema del vector más corto usando LLL.</p><p>Usaremos un total de 6 salidas del PRNG ($u_1$, $v_1$, $u_2$, $v_2$, $u_3$, y $v_3$), es decir, 3 puntos ($W_1$, $W_2$ y $W_3$), y podemos obtener 7 ecuaciones independientes:</p><p class="scroll">$$
\begin{cases}
W_1 \in E(\mathbb{F}_p) \\
W_2 \in E(\mathbb{F}_p) \\
W_3 \in E(\mathbb{F}_p) \\
\\
W_2 - W_1 = G \quad \text{(for x and y)} \\
W_3 - W_2 = G \quad \text{(for x and y)}
\end{cases}
$$</p><p class="scroll">$$
\begin{cases}
(u_1 + a_1)^3 + a \cdot (u_1 + a_1) + b - (v_1 + b_1)^2 = 0 \mod{p} \\
(u_2 + a_2)^3 + a \cdot (u_2 + a_2) + b - (v_2 + b_2)^2 = 0 \mod{p} \\
(u_3 + a_3)^3 + a \cdot (u_3 + a_3) + b - (v_3 + b_3)^2 = 0 \mod{p} \\
\\
((u_1 + a_1) + (u_2 + a_2) + G_\mathrm{x}) \cdot ((u_2 + a_2) - (u_1 + a_1))^2 - ((v_2 + b_2) \color{red}{+} (v_1 + b_1))^2 = 0 \mod{p} \\
((u_2 + a_2) + (u_3 + a_3) + G_\mathrm{x}) \cdot ((u_3 + a_3) - (u_2 + a_2))^2 - ((v_3 + b_3) \color{red}{+} (v_2 + b_2))^2 = 0 \mod{p} \\
\\
(G_\mathrm{y} \color{red}{-} (v_1 + b_1)) \cdot ((u_2 + a_2) - (u_1 + a_1)) - ((v_2 + b_2) \color{red}{+} (v_1 + b_1)) \cdot ((u_1 + a_1) - G_\mathrm{x}) = 0 \mod{p} \\
(G_\mathrm{y} \color{red}{-} (v_2 + b_2)) \cdot ((u_3 + a_3) - (u_2 + a_2)) - ((v_3 + b_3) \color{red}{+} (v_2 + b_2)) \cdot ((u_2 + a_2) - G_\mathrm{x}) = 0 \mod{p}
\end{cases}
$$</p><p>Los signos coloreados en rojo son para indicar que estamos expresando $W_{n + 1} - W_n = G$, por lo que $-W_n = (u_n + a_n, -v_n - b_n)$.</p><p>Podemos deshacernos de $\mod{p}$ agregando algunos enteros $k_1, \dots, k_7$ multiplicados por $p$:</p><p class="scroll">$$
\begin{cases}
(u_1 + a_1)^3 + a \cdot (u_1 + a_1) + b - (v_1 + b_1)^2 + k_1 \cdot p = 0 \\
(u_2 + a_2)^3 + a \cdot (u_2 + a_2) + b - (v_2 + b_2)^2 + k_2 \cdot p = 0 \\
(u_3 + a_3)^3 + a \cdot (u_3 + a_3) + b - (v_3 + b_3)^2 + k_3 \cdot p = 0 \\
\\
((u_1 + a_1) + (u_2 + a_2) + G_\mathrm{x}) \cdot ((u_2 + a_2) - (u_1 + a_1))^2 - ((v_2 + b_2) \color{red}{+} (v_1 + b_1))^2 + k_4 \cdot p = 0 \\
((u_2 + a_2) + (u_3 + a_3) + G_\mathrm{x}) \cdot ((u_3 + a_3) - (u_2 + a_2))^2 - ((v_3 + b_3) \color{red}{+} (v_2 + b_2))^2 + k_5 \cdot p = 0 \\
\\
(G_\mathrm{y} \color{red}{-} (v_1 + b_1)) \cdot ((u_2 + a_2) - (u_1 + a_1)) - ((v_2 + b_2) \color{red}{+} (v_1 + b_1)) \cdot ((u_1 + a_1) - G_\mathrm{x}) + k_6 \cdot p = 0 \\
(G_\mathrm{y} \color{red}{-} (v_2 + b_2)) \cdot ((u_3 + a_3) - (u_2 + a_2)) - ((v_3 + b_3) \color{red}{+} (v_2 + b_2)) \cdot ((u_2 + a_2) - G_\mathrm{x}) + k_7 \cdot p = 0
\end{cases}
$$</p><p>Obviamente, no tenemos solo 6 incógnitas, porque hay interacciones entre las variables (por ejemplo, $a_1 \cdot a_2$ or $a_1^3$). Sin embargo, estas variables también están limitadas y cortas en comparación con $p$. Como resultado, podemos usar una base de retículo como esta para determinar el valor de $a_1$, $b_1$, $a_2$, $b_2$, $a_3$ y $b_3$:</p><p class="scroll">$$
\begin{bmatrix}
{\begin{pmatrix}
p &   &        &   \\
      & p &    &   \\
      &   & \ddots &   \\
  &   &        & p
  \end{pmatrix}} & {\begin{pmatrix}
    \mathrm{eq}_1 \quad \mathrm{coefficients} \\
\mathrm{eq}_2 \quad \mathrm{coefficients} \\
\dots \\
\mathrm{eq}_7 \quad \mathrm{coefficients}
\end{pmatrix}} \\ \\
& {\begin{pmatrix}
      1 &   &   &   &         \\
        & 1 &     &   &         \\
        &   & \ddots &   &         \\
        &   &     & 1 &         \\
        &   &     &   & 2^{256}
  \end{pmatrix}}
\end{bmatrix}
$$</p><p>Y el vector objetivo es $(k_1, \dots, k_7,\dots, a_1, b_1, a_2, b_2, a_3, b_3, 2^{256})$, que se puede obtener aplicando LLL en la matriz de base del retículo.</p><p>Una vez que tengamos $a_1$, $b_1$, $a_2$, $b_2$, $a_3$ y $b_3$, podemos encontrar $W_1$, $W_2$ y $W_3$ para romper el PRNG.</p><h2 id="solución">Solución</h2><p>Entonces, este es el esquema para resolver el reto:</p><ul><li>Debemos ejecutar <code>unveil_secrets</code>, que necesita una firma agregada de todos los robots verificados</li><li>Podemos usar un ataque <em>rogue key</em> para forjar la firma</li><li>Para esto, debemos proporcionar una clave pública maliciosa, por lo que estaremos ejecutando <code>join</code></li><li>Necesitamos verificar el robot, es decir, debemos demostrar que tenemos la clave secreta asociada a la clave pública maliciosa</li><li>No es fácil encontrar una clave secreta que pueda generar la clave pública maliciosa, por lo que debemos hacer trampa para completar la prueba de conocimiento cero</li><li>Para esto, necesitamos saber exactamente qué pregunta va a hacer el servidor, por lo que necesitamos romper el PRNG de EC-LCG</li><li>Necesitamos $6$ salidas, por lo que podemos crear un nuevo robot ($5^\text{a}$ salida), usarlo para listar los robots existentes y luego añadir otro robot con la clave pública maliciosa ($6^\text{a}$ salida)</li></ul><h3 id="implementación">Implementación</h3><p>La interacción con el servidor está utilizando JSON (excepto el proceso de verificación), por lo que podemos usar esta función para enviar y recibir datos en JSON:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><p>Primero, creamos un robot y lo usamos para listar el resto:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'create'</span><span class="mtk1">})</span>
<span class="mtk1">sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'sk'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'list'</span>
<span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Sign</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">, </span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk1">cmd</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">), </span><span class="mtk4">'sig'</span><span class="mtk1">: </span><span class="mtk1">sig</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  

<span class="mtk1">ids</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [], []</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">res</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">ids</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">Pks</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.get(</span><span class="mtk4">'pk'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">))))</span>
</code></pre></div><p>Con las claves públicas, podemos elaborar la clave pública maliciosa para el ataque de <em>rogue key</em> (<a target="_blank" href="https://pypi.org/project/py-ecc/"><code>py-ecc</code></a> hace que sea muy fácil de implementar):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1337</span>
<span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'ss'</span>
<span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">)</span>
<span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Sign</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">, </span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">Pk_prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">, </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk8">reduce</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1">, </span><span class="mtk1">Z1</span><span class="mtk1">)))</span>
<span class="mtk1">pk_prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">)</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">reduce</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1">), </span><span class="mtk1">Pk_prime</span><span class="mtk1">)) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'Forged signature!'</span><span class="mtk1">)</span>
</code></pre></div><p>Ahora, añadimos a esta clave pública maliciosa y obtenemos la 6$^\mathrm{a}$ salida del PRNG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'join'</span><span class="mtk1">, </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk1">pk_prime</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  
<span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">ids</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">ids</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">6</span>
</code></pre></div><p>Luego, rompemos el PRNG de EC-LCG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000001000000000000000000000000ffffffffff</span><span class="mtk6">ffffffffffffff</span>
<span class="mtk1">K</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">K</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000001000000000000000000000000ffffffffff</span><span class="mtk6">fffffffffffffc</span><span class="mtk1">)</span>
<span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">K</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63b</span><span class="mtk6">ce3c3e27d2604b</span><span class="mtk1">)</span>
<span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(</span><span class="mtk1">K</span><span class="mtk1">, (</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">))</span>
<span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span><span class="mtk1">)</span>  
<span class="mtk1">E</span><span class="mtk1">.set_order(</span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000000ffffffffffffffffbce6faada7179e84f3</span><span class="mtk6">b9cac2fc632551</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">crack_ec_lcg</span><span class="mtk1">(</span><span class="mtk9 mtki">values</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">values</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">u1</span><span class="mtk1">, </span><span class="mtk1">v1</span><span class="mtk1">, </span><span class="mtk1">u2</span><span class="mtk1">, </span><span class="mtk1">v2</span><span class="mtk1">, </span><span class="mtk1">u3</span><span class="mtk1">, </span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">values</span>
<span class="mtk1">    </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">b1</span><span class="mtk1">, </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">b2</span><span class="mtk1">, </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">b3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PolynomialRing(</span><span class="mtk1">K</span><span class="mtk1">, </span><span class="mtk4">'a1, b1, a2, b2, a3, b3'</span><span class="mtk1">).gens()</span>

<span class="mtk1">    </span><span class="mtk1">ec1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">    </span><span class="mtk1">ec2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">    </span><span class="mtk1">ec3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>

<span class="mtk1">    </span><span class="mtk1">ec4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x()) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">ec5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x()) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">ec6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">G</span><span class="mtk1">.y() </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x())</span>
<span class="mtk1">    </span><span class="mtk1">ec7</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">G</span><span class="mtk1">.y() </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x())</span>

<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1">, </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Sequence([</span><span class="mtk1">ec1</span><span class="mtk1">, </span><span class="mtk1">ec2</span><span class="mtk1">, </span><span class="mtk1">ec3</span><span class="mtk1">, </span><span class="mtk1">ec4</span><span class="mtk1">, </span><span class="mtk1">ec5</span><span class="mtk1">, </span><span class="mtk1">ec6</span><span class="mtk1">, </span><span class="mtk1">ec7</span><span class="mtk1">]).coefficients_monomials(</span><span class="mtk9 mtki">sparse</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.change_ring(</span><span class="mtk6">ZZ</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (identity_matrix(</span><span class="mtk6">7</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">).augment(</span><span class="mtk1">A</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.stack(zero_matrix(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">), </span><span class="mtk6">7</span><span class="mtk1">).augment(identity_matrix(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">))))</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span>

<span class="mtk1">    </span><span class="mtk1">L</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.T.LLL()</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">L</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span>
<span class="mtk1">    </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">b1</span><span class="mtk1">, </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">b2</span><span class="mtk1">, </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">b3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">L</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk5">-</span><span class="mtk6">7</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">W1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">W2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">W3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">W3</span>
</code></pre></div><p>Con esto, podemos engañar al protocolo de ZKP para verificar la clave pública maliciosa:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">crack_ec_lcg</span><span class="mtk1">([</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk6">32</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">ids</span><span class="mtk1">])</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'Cracked EC-LCG!'</span><span class="mtk1">)</span>

<span class="mtk1">prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Cheating ZKP'</span><span class="mtk1">)</span>
<span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'verify'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)})</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.xy():</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">, </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">))) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">) </span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">, </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">sk_x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">()</span>
</code></pre></div><p>Finalmente, ejecutamos el comando <code>unveil_secrets</code>, con la firma agregada maliciosa:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk1">cmd</span><span class="mtk1">, </span><span class="mtk4">'sig'</span><span class="mtk1">: </span><span class="mtk1">sig</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  
<span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'exit'</span><span class="mtk1">})</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'flag'</span><span class="mtk1">))</span>
</code></pre></div><h2 id="_flag_"><em>Flag</em></h2><p>Si ejecutamos el <em>script</em>, resolveremos el reto y obtendremos la <em>flag</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.59.199:57607
[<span class="code-green">+</span>] Opening connection to 94.237.59.199 on port 57607: Done
[<span class="code-green">+</span>] Forged signature!
[<span class="code-green">+</span>] Cracked EC-LCG!
[<span class="code-green">+</span>] Cheating ZKP: Done
[<span class="code-green">+</span>] HTB{EC-LCG_cr4ck3r_z3r0_kn0wl3dg3_ch34t3r_4nd_r0gue_k3y_4tt4ck3r!!}  
[<span class="code-blue">*</span>] Closed connection to 94.237.59.199 port 57607
</code></pre></div><p>El <em>script</em> completo se puede encontrar aquí: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Crypto/Blessed/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#análisis-del-código-fuente">Análisis del código fuente</a><ul><li><a href="#firmas-bls">Firmas BLS</a></li><li><a href="#prueba-de-conocimiento-cero">Prueba de conocimiento cero</a></li><li><a href="#ec-lcg">EC-LCG</a></li></ul></li><li><a href="#solución">Solución</a><ul><li><a href="#implementación">Implementación</a></li></ul></li><li><a href="#_flag_"><em>Flag</em></a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>