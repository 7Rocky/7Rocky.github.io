<!doctype html><html lang="en"><head><title>Alien Saboteaur | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Virtual machine. Custom _opcode_ instructions. `sys_ptrace`. XOR cipher"><meta name="image" content="https://7rocky.github.io/images/reversing.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Virtual machine. Custom _opcode_ instructions. `sys_ptrace`. XOR cipher"><meta itemprop="keywords" content><meta itemprop="name" content="Alien Saboteaur"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Virtual machine. Custom _opcode_ instructions. `sys_ptrace`. XOR cipher"><meta property="og:image" content="https://7rocky.github.io/images/reversing.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Alien Saboteaur"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Virtual machine. Custom _opcode_ instructions. `sys_ptrace`. XOR cipher"><meta name="twitter:description" content="Virtual machine. Custom _opcode_ instructions. `sys_ptrace`. XOR cipher"><meta name="twitter:image" content="https://7rocky.github.io/images/reversing.png"><meta name="twitter:title" content="Alien Saboteaur"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE 2023</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/&amp;text=Alien%20Saboteaur" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/alien-saboteaur/&amp;title=Alien%20Saboteaur" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Alien Saboteaur</h1><p class="mb4 f6 dib tracked">29 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#program-parsing">Program parsing</a></li></ul></li><li><a href="#program-analysis">Program analysis</a><ul><li><a href="#first-stage">First stage</a></li><li><a href="#second-stage">Second stage</a></li><li><a href="#third-stage">Third stage</a></li></ul></li><li><a href="#python-implementation">Python implementation</a><ul><li><a href="#reversing-the-algorithm">Reversing the algorithm</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a binary file called <code>vm</code> and a program called <code>bin</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="code-dark-blue">*</span>
bin: data
vm:  ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=10fb238b19d3a82b46536b51e47396525086a09c, for GNU/Linux 3.2.0, not stripped  
</code></pre></div><h2 id="setup-environment">Setup environment</h2><p>The binary needs a recent version of Glibc in order to run:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./vm</span>
./vm: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.34' not found (required by ./vm)  
</code></pre></div><p>To solve this issue, we can run Ubuntu 22.04 in a Docker container and take the library and loader and patch the binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-cyan">${PWD}</span>:/opt"</span> --rm -it ubuntu:22.04 bash
root@8ffbddd2ded9:/# /lib64/ld-linux-x86-64.so.2 /lib/x86_64-linux-gnu/libc.so.6
GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 11.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
root@8ffbddd2ded9:/# cp /lib64/ld-linux-x86-64.so.2 /lib/x86_64-linux-gnu/libc.so.6 /opt  
root@8ffbddd2ded9:/# exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">vm</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">vm</span>

<span class="code-cyan">$</span> <span class="code-dark-green">./vm</span>
Usage: ./chall file
</code></pre></div><p>Now we are able to run the provided program:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./vm</span> <span class="mtku">bin</span>
[Main Vessel Terminal]  
&lt; Enter keycode
&gt;
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>Let&rsquo;s open the binary in Ghidra. This is <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">argc</span><span class="mtk1">, </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk9 mtki">argv</span><span class="mtk1">) {</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> size;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_instructions;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">program;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (argc </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Usage: ./chall file"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(argv[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk4">"rb"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">fseek</span><span class="mtk1">(fp, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">  size </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">ftell</span><span class="mtk1">(fp);</span>
<span class="mtk1">  </span><span class="mtk8">rewind</span><span class="mtk1">(fp);</span>
<span class="mtk1">  p_instructions </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">(size);</span>
<span class="mtk1">  </span><span class="mtk8">fread</span><span class="mtk1">(p_instructions, size, </span><span class="mtk6">1</span><span class="mtk1">, fp);</span>
<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk1">  program </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">vm_create</span><span class="mtk1">(p_instructions, size);</span>
<span class="mtk1">  </span><span class="mtk8">vm_run</span><span class="mtk1">(program);</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>As can be seen, the program creates a virtual machine and runs the specified program (<code>bin</code>) there. This is <code>vm_create</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined4 </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">vm_create</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">p_instructions</span><span class="mtk1">, </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">size</span><span class="mtk1">) {</span>
<span class="mtk1">  undefined4 </span><span class="mtk5">*</span><span class="mtk1">vm;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">program;</span>
<span class="mtk1">  </span>
<span class="mtk1">  vm </span><span class="mtk5">=</span><span class="mtk1"> (undefined4 </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">a8</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">memset</span><span class="mtk1">(vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">80</span><span class="mtk1">);</span>
<span class="mtk1">  program </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">calloc</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">10000</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> program;</span>
<span class="mtk1">  </span><span class="mtk8">memcpy</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">), (</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (p_instructions </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">), size </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">);</span>  
<span class="mtk1">  program </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">calloc</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">200</span><span class="mtk1">, </span><span class="mtk6">4</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">26</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> program;</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> vm;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The variable names might be confusing. The important thing is that there are three chunks in memory (on the heap).</p><p>This is <code>vm_run</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_run</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">program</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (program[</span><span class="mtk6">4</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">) {</span>  
<span class="mtk1">    </span><span class="mtk8">vm_step</span><span class="mtk1">(program);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>It is calling <code>vm_step</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_step</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">0x</span><span class="mtk6">19</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(byte </span><span class="mtk5">*</span><span class="mtk1">) ((ulong) </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">90</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"dead"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  (</span><span class="mtk5">**</span><span class="mtk1">(code </span><span class="mtk5">**</span><span class="mtk1">) (original_ops </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1">(byte </span><span class="mtk5">*</span><span class="mtk1">) ((ulong) </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">90</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)(param_1);</span>  
<span class="mtk1">}</span>
</code></pre></div><p>It is a bit unreadable. Basically, it is taking a byte from the input <code>char</code> array and using it as an offset to <code>original_ops</code>. Looking at the available functions, we can guess that the program executes one of these (the order is intended):</p><ol start="0"><li><code>vm_add</code></li><li><code>vm_addi</code></li><li><code>vm_sub</code></li><li><code>vm_subi</code></li><li><code>vm_mul</code></li><li><code>vm_muli</code></li><li><code>vm_div</code></li><li><code>vm_cmp</code></li><li><code>vm_cmp</code></li><li><code>vm_inv</code></li><li><code>vm_push</code></li><li><code>vm_pop</code></li><li><code>vm_mov</code></li><li><code>vm_nop</code></li><li><code>vm_exit</code></li><li><code>vm_print</code></li><li><code>vm_putc</code></li><li><code>vm_je</code></li><li><code>vm_jne</code></li><li><code>vm_jle</code></li><li><code>vm_jge</code></li><li><code>vm_xor</code></li><li><code>vm_store</code></li><li><code>vm_load</code></li><li><code>vm_input</code></li></ol><h3 id="program-parsing">Program parsing</h3><p>Let&rsquo;s take a look at one of these low-level functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_addi</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar1;</span>
<span class="mtk1">  byte bVar2;</span>
<span class="mtk1">  byte bVar3;</span>

<span class="mtk1">  bVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>  
<span class="mtk1">  uVar1 </span><span class="mtk5">=</span><span class="mtk1"> param_1[(</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) bVar2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  bVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>
<span class="mtk1">  bVar3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>
<span class="mtk1">  param_1[(</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) bVar3 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> uVar1 </span><span class="mtk5">+</span><span class="mtk1"> bVar2;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>For the moment, let&rsquo;s focus on the fact that the <code>param_1</code> pointer is increased in <code>6</code> (this is the program counter). So, we can guess that the instructions are 6-byte long. Moreover, in <code>vm_create</code>, the actual instructions start at offset <code>3</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">  </span><span class="mtk8">memcpy</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">), (</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (p_instructions </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">), size </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">);</span>  
</code></pre></div><p>Actually, if we read <code>original_ops</code> as <code>undefined8[25]</code>, we will see the addresses of the <code>vm_*</code> functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">                     original_ops                                    XREF[3]:     Entry Point(*),
                                                                                  vm_step:00102400(*),
                                                                                  vm_step:00102407(R)
00105020 64 1a 10        undefined8[25]
         00 00 00
         00 00 24
   00105020 64 1a 10 00 00  undefined8  0000000000101A64h     [0]           ?  ->  00101a64     XREF[3]:     Entry Point(*),
            00 00 00                                                                                         vm_step:00102400(*),  
                                                                                                             vm_step:00102407(R)
   00105028 24 1b 10 00 00  undefined8  0000000000101B24h     [1]           ?  ->  00101b24
            00 00 00
   00105030 d9 1b 10 00 00  undefined8  0000000000101BD9h     [2]           ?  ->  00101bd9
            00 00 00
   00105038 99 1c 10 00 00  undefined8  0000000000101C99h     [3]           ?  ->  00101c99
            00 00 00
   00105040 4e 1d 10 00 00  undefined8  0000000000101D4Eh     [4]           ?  ->  00101d4e
            00 00 00
   00105048 0f 1e 10 00 00  undefined8  0000000000101E0Fh     [5]           ?  ->  00101e0f
            00 00 00
   00105050 60 1f 10 00 00  undefined8  0000000000101F60h     [6]           ?  ->  00101f60
            00 00 00
   00105058 c5 1e 10 00 00  undefined8  0000000000101EC5h     [7]           ?  ->  00101ec5
            00 00 00
   00105060 7c 21 10 00 00  undefined8  000000000010217Ch     [8]           ?  ->  0010217c
            00 00 00
   00105068 25 20 10 00 00  undefined8  0000000000102025h     [9]           ?  ->  00102025
            00 00 00
   00105070 0c 22 10 00 00  undefined8  000000000010220Ch     [10]          ?  ->  0010220c
            00 00 00
   00105078 95 22 10 00 00  undefined8  0000000000102295h     [11]          ?  ->  00102295
            00 00 00
   00105080 27 23 10 00 00  undefined8  0000000000102327h     [12]          ?  ->  00102327
            00 00 00
   00105088 15 14 10 00 00  undefined8  0000000000101415h     [13]          ?  ->  00101415
            00 00 00
   00105090 e2 21 10 00 00  undefined8  00000000001021E2h     [14]          ?  ->  001021e2
            00 00 00
   00105098 fc 19 10 00 00  undefined8  00000000001019FCh     [15]          ?  ->  001019fc
            00 00 00
   001050a0 ae 19 10 00 00  undefined8  00000000001019AEh     [16]          ?  ->  001019ae
            00 00 00
   001050a8 92 16 10 00 00  undefined8  0000000000101692h     [17]          ?  ->  00101692
            00 00 00
   001050b0 59 17 10 00 00  undefined8  0000000000101759h     [18]          ?  ->  00101759
            00 00 00
   001050b8 20 18 10 00 00  undefined8  0000000000101820h     [19]          ?  ->  00101820
            00 00 00
   001050c0 e7 18 10 00 00  undefined8  00000000001018E7h     [20]          ?  ->  001018e7
            00 00 00
   001050c8 d2 15 10 00 00  undefined8  00000000001015D2h     [21]          ?  ->  001015d2
            00 00 00
   001050d0 93 14 10 00 00  undefined8  0000000000101493h     [22]          ?  ->  00101493
            00 00 00
   001050d8 31 15 10 00 00  undefined8  0000000000101531h     [23]          ?  ->  00101531
            00 00 00
   001050e0 33 14 10 00 00  undefined8  0000000000101433h     [24]          ?  ->  00101433
            00 00 00
</code></pre></div><p>The offsets are shown in the previous list.</p><p>Let&rsquo;s take a look at the <code>bin</code> file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">xxd</span> <span class="mtku">bin</span> | <span class="code-dark-green">head</span>
00000000: 5577 5510 5b00 0000 0010 4d00 0000 0010  UwU.[.....M.....
00000010: 6100 0000 0010 6900 0000 0010 6e00 0000  a.....i.....n...
00000020: 0010 2000 0000 0010 5600 0000 0010 6500  .. .....V.....e.
00000030: 0000 0010 7300 0000 0010 7300 0000 0010  ....s.....s.....
00000040: 6500 0000 0010 6c00 0000 0010 2000 0000  e.....l..... ...
00000050: 0010 5400 0000 0010 6500 0000 0010 7200  ..T.....e.....r.
00000060: 0000 0010 6d00 0000 0010 6900 0000 0010  ....m.....i.....
00000070: 6e00 0000 0010 6100 0000 0010 6c00 0000  n.....a.....l...
00000080: 0010 5d00 0000 0010 0a00 0000 0010 3c00  ..]...........&lt;.  
00000090: 0000 0010 2000 0000 0010 4500 0000 0010  .... .....E.....
</code></pre></div><p>The first three characters are skipped (<code>UwU</code>). Next, we have a <code>10</code> (<code>16</code> in decimal format). This means that the program will execute <code>vm_putc</code>. Taking a look at the following characters, the program will print the banner (<code>[Main Vessel Terminal]...</code>) and the prompt character by character with <code>vm_putc</code>.</p><p>Let&rsquo;s format the <code>bin</code> file a bit:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">dd</span> bs=1 skip=3 if=bin 2&gt;<span class="mtku">/dev/null</span> | <span class="code-dark-green">xxd</span> -g 6 -c 6  
00000000: 105b00000000  .[....
00000006: 104d00000000  .M....
0000000c: 106100000000  .a....
00000012: 106900000000  .i....
00000018: 106e00000000  .n....
0000001e: 102000000000  . ....
00000024: 105600000000  .V....
0000002a: 106500000000  .e....
00000030: 107300000000  .s....
00000036: 107300000000  .s....
0000003c: 106500000000  .e....
00000042: 106c00000000  .l....
00000048: 102000000000  . ....
0000004e: 105400000000  .T....
00000054: 106500000000  .e....
0000005a: 107200000000  .r....
00000060: 106d00000000  .m....
00000066: 106900000000  .i....
0000006c: 106e00000000  .n....
00000072: 106100000000  .a....
00000078: 106c00000000  .l....
0000007e: 105d00000000  .]....
00000084: 100a00000000  ......
0000008a: 103c00000000  .&lt;....
00000090: 102000000000  . ....
00000096: 104500000000  .E....
0000009c: 106e00000000  .n....
000000a2: 107400000000  .t....
000000a8: 106500000000  .e....
000000ae: 107200000000  .r....
000000b4: 102000000000  . ....
000000ba: 106b00000000  .k....
000000c0: 106500000000  .e....
000000c6: 107900000000  .y....
000000cc: 106300000000  .c....
000000d2: 106f00000000  .o....
000000d8: 106400000000  .d....
000000de: 106500000000  .e....
000000e4: 102000000000  . ....
000000ea: 100a00000000  ......
000000f0: 103e00000000  .&gt;....
000000f6: 102000000000  . ....
000000fc: 0c1ea00f0000  ......
00000102: 0c1c00000000  ......
00000108: 0c1d11000000  ......
0000010e: 181900000000  ......
00000114: 161e19000000  ......
0000011a: 011e1e010000  ......
00000120: 011c1c010000  ......
00000126: 131c1d2d0000  ...-..
0000012c: 0c1e04100000  ......
00000132: 0c1fa00f0000  ......
00000138: 0c1c00000000  ......
0000013e: 0c1d0a000000  ......
00000144: 0c1ba9000000  ......
0000014a: 0c1700000000  ......
00000150: 17191e000000  ......
00000156: 17181f000000  ......
0000015c: 1519191b0000  ......
00000162: 1119184e0000  ...N..
00000168: 105500000000  .U....
0000016e: 106e00000000  .n....
00000174: 106b00000000  .k....
0000017a: 106e00000000  .n....
00000180: 106f00000000  .o....
00000186: 107700000000  .w....
0000018c: 106e00000000  .n....
00000192: 102000000000  . ....
00000198: 106b00000000  .k....
0000019e: 106500000000  .e....
000001a4: 107900000000  .y....
000001aa: 106300000000  .c....
000001b0: 106f00000000  .o....
000001b6: 106400000000  .d....
000001bc: 106500000000  .e....
000001c2: 102100000000  .!....
000001c8: 100a00000000  ......
000001ce: 0e0000000000  ......
000001d4: 011e1e010000  ......
000001da: 011f1f010000  ......
000001e0: 011c1c010000  ......
000001e6: 131c1d380000  ...8..
000001ec: 0c0f00000000  ......
000001f2: 0a0f00000000  ......
000001f8: 0a0f00000000  ......
000001fe: 0a0f00000000  ......
00000204: 096503000000  .e....
0000020a: 0c1000000000  ......
00000210: 111f106c0000  ...l..
00000216: 105400000000  .T....
0000021c: 106500000000  .e....
00000222: 107200000000  .r....
00000228: 106d00000000  .m....
0000022e: 106900000000  .i....
00000234: 106e00000000  .n....
0000023a: 106100000000  .a....
00000240: 106c00000000  .l....
00000246: 102000000000  . ....
0000024c: 106200000000  .b....
00000252: 106c00000000  .l....
00000258: 106f00000000  .o....
0000025e: 106300000000  .c....
00000264: 106b00000000  .k....
0000026a: 106500000000  .e....
00000270: 106400000000  .d....
00000276: 102100000000  .!....
0000027c: 100a00000000  ......
00000282: 0e0000000000  ......
00000288: 0c1e77000000  ..w...
0000028e: 051e1e060000  ......
00000294: 0c1c00000000  ......
0000029a: 0c1ddc050000  ......
000002a0: 0c1b45000000  ..E...
000002a6: 17191e000000  ......
000002ac: 1519191b0000  ......
000002b2: 161e19000000  ......
000002b8: 011e1e010000  ......
000002be: 011c1c010000  ......
000002c4: 131c1d710000  ...q..
000002ca: 557945454545  UyEEEE
000002d0: 556545454545  UeEEEE
000002d6: 550045454545  U.EEEE
000002dc: 552b45454545  U+EEEE
000002e2: 553145454545  U1EEEE
000002e8: 552045454545  U EEEE
...
</code></pre></div><h2 id="program-analysis">Program analysis</h2><p>So, after the <code>vm_putc</code> instructions we have this:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000000ba: 106b00000000  .k....  putc  'k'
000000c0: 106500000000  .e....  putc  'e'
000000c6: 107900000000  .y....  putc  'y'
000000cc: 106300000000  .c....  putc  'c'
000000d2: 106f00000000  .o....  putc  'o'
000000d8: 106400000000  .d....  putc  'd'
000000de: 106500000000  .e....  putc  'e'
000000e4: 102000000000  . ....  putc  ' '
000000ea: 100a00000000  ......  putc  '\n'
000000f0: 103e00000000  .&gt;....  putc  '&gt;'
000000f6: 102000000000  . ....  putc  ' '
000000fc: 0c1ea00f0000  ......  mov   0x1e 0x0fa0
00000102: 0c1c00000000  ......  mov   0x1c 0x0000
00000108: 0c1d11000000  ......  mov   0x1d 0x0011
0000010e: 181900000000  ......  input 0x19
00000114: 161e19000000  ......  store 0x1e 0x19
0000011a: 011e1e010000  ......  addi  0x1e 0x1e 0x01  
00000120: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000126: 131c1d2d0000  ...-..  jle   0x1c 0x1d 0x2d
0000012c: 0c1e04100000  ......  mov   0x1e 0x1004
00000132: 0c1fa00f0000  ......  mov   0x1f 0x0fa0
00000138: 0c1c00000000  ......  mov   0x1c 0x0000
0000013e: 0c1d0a000000  ......  mov   0x1d 0x000a
00000144: 0c1ba9000000  ......  mov   0x1b 0x90ba
0000014a: 0c1700000000  ......  mov   0x17 0x0000
00000150: 17191e000000  ......  load  0x19 0x1e
00000156: 17181f000000  ......  load  0x18 0x1f
0000015c: 1519191b0000  ......  xor   0x19 0x19 0x1b
00000162: 1119184e0000  ...N..  je    0x19 0x18 0x4e
00000168: 105500000000  .U....  putc  'U'
0000016e: 106e00000000  .n....  putc  'n'
00000174: 106b00000000  .k....  putc  'k'
0000017a: 106e00000000  .n....  putc  'n'
00000180: 106f00000000  .o....  putc  'o'
00000186: 107700000000  .w....  putc  'w'
0000018c: 106e00000000  .n....  putc  'n'
00000192: 102000000000  . ....  putc  ' '
00000198: 106b00000000  .k....  putc  'k'
0000019e: 106500000000  .e....  putc  'e'
000001a4: 107900000000  .y....  putc  'y'
000001aa: 106300000000  .c....  putc  'c'
000001b0: 106f00000000  .o....  putc  'o'
000001b6: 106400000000  .d....  putc  'd'
000001bc: 106500000000  .e....  putc  'e'
000001c2: 102100000000  .!....  putc  '!'
000001c8: 100a00000000  ......  putc  '\n'
000001ce: 0e0000000000  ......  exit
</code></pre></div><p>To analyze how some <em>opcodes</em> work, we can use GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">vm</span>
Reading symbols from <span class="code-dark-green">vm</span>...
(No debugging symbols found in <span class="code-dark-green">vm</span>)
<span class="code-red">gef➤  </span>break vm_input
Breakpoint 1 at <span class="code-dark-blue">0x1433</span>
<span class="code-red">gef➤  </span>run bin
Starting program: ./vm bin
[Main Vessel Terminal]
&lt; Enter keycode

Breakpoint 1, <span class="code-dark-blue">0x0000555555555433</span> in <span class="code-dark-yellow">vm_input</span> ()  
</code></pre></div><p>At this point, we can search for the program instructions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep UwU
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">UwU</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[heap]</span>'(0x55555555c000-0x55555557d000), permission=rw-  
  0x55555555d490 - 0x55555555d493  →   "<span class="code-dark-magenta">UwU[...]</span>"
<span class="code-green">gef➤  </span>x/30gx 0x55555555d490
<span class="code-dark-blue">0x55555555d490</span>: 0x0000005b10557755      0x10000000004d1000
<span class="code-dark-blue">0x55555555d4a0</span>: 0x0069100000000061      0x0000006e10000000
<span class="code-dark-blue">0x55555555d4b0</span>: 0x1000000000201000      0x0065100000000056
<span class="code-dark-blue">0x55555555d4c0</span>: 0x0000007310000000      0x1000000000731000
<span class="code-dark-blue">0x55555555d4d0</span>: 0x006c100000000065      0x0000002010000000
<span class="code-dark-blue">0x55555555d4e0</span>: 0x1000000000541000      0x0072100000000065
<span class="code-dark-blue">0x55555555d4f0</span>: 0x0000006d10000000      0x1000000000691000
<span class="code-dark-blue">0x55555555d500</span>: 0x006110000000006e      0x0000006c10000000
<span class="code-dark-blue">0x55555555d510</span>: 0x10000000005d1000      0x003c10000000000a
<span class="code-dark-blue">0x55555555d520</span>: 0x0000002010000000      0x1000000000451000
<span class="code-dark-blue">0x55555555d530</span>: 0x007410000000006e      0x0000006510000000
<span class="code-dark-blue">0x55555555d540</span>: 0x1000000000721000      0x006b100000000020
<span class="code-dark-blue">0x55555555d550</span>: 0x0000006510000000      0x1000000000791000
<span class="code-dark-blue">0x55555555d560</span>: 0x006f100000000063      0x0000006410000000
<span class="code-dark-blue">0x55555555d570</span>: 0x1000000000651000      0x000a100000000020
</code></pre></div><p>Then we can search for some of the values from <code>vm_mov</code> instructions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep 0x0fa0
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">\xa0\x0f</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[heap]</span>'(0x55555555c000-0x55555557d000), permission=rw-
  0x55555555c500 - 0x55555555c508  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
  0x55555555d591 - 0x55555555d599  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
  0x55555555d5c7 - 0x55555555d5cf  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
  0x55555556159e - 0x5555555615a6  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
  0x5555555615d4 - 0x5555555615dc  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
<span class="code-green">[+]</span> In '<span class="code-dark-blue">./libc.so.6</span>'(0x7ffff7dbb000-0x7ffff7f50000), permission=r-x  
  0x7ffff7dbdcdf - 0x7ffff7dbdce7  →   "<span class="code-dark-magenta">\xa0\x0f[...]</span>"
  ...
<span class="code-green">gef➤  </span>x/20gx 0x55555555c4b0
<span class="code-dark-blue">0x55555555c4b0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4c0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4d0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4e0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4f0</span>: 0x0000000000000000      0x0000001100000000
<span class="code-dark-blue">0x55555555c500</span>: 0x0000000000000fa0      0x0000000000000000
<span class="code-dark-blue">0x55555555c510</span>: 0x00005555555614a0      0x000055555555c530
<span class="code-dark-blue">0x55555555c520</span>: 0x0000000000000000      0x0000000000000811
<span class="code-dark-blue">0x55555555c530</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c540</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>After a lot of debugging, we can figure out that the above memory layout is used as registers (<code>0x1f</code> stores <code>0x0000</code>, <code>0x1e</code> stores <code>0x0fa0</code>, <code>0x1e</code> stores <code>0x0011</code>, <code>0x1d</code> stores <code>0x0000</code> and so on). Moreover, we have a pointer to the <em>opcode</em> instructions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/20gx 0x00005555555614a0
<span class="code-dark-blue">0x5555555614a0</span>: 0x4d10000000005b10      0x0000611000000000  
<span class="code-dark-blue">0x5555555614b0</span>: 0x0000000069100000      0x2010000000006e10
<span class="code-dark-blue">0x5555555614c0</span>: 0x0000561000000000      0x0000000065100000
<span class="code-dark-blue">0x5555555614d0</span>: 0x7310000000007310      0x0000651000000000
<span class="code-dark-blue">0x5555555614e0</span>: 0x000000006c100000      0x5410000000002010
<span class="code-dark-blue">0x5555555614f0</span>: 0x0000651000000000      0x0000000072100000
<span class="code-dark-blue">0x555555561500</span>: 0x6910000000006d10      0x00006e1000000000
<span class="code-dark-blue">0x555555561510</span>: 0x0000000061100000      0x5d10000000006c10
<span class="code-dark-blue">0x555555561520</span>: 0x00000a1000000000      0x000000003c100000
<span class="code-dark-blue">0x555555561530</span>: 0x4510000000002010      0x00006e1000000000
</code></pre></div><p>The other pointer points right below the registers area (probably it is the stack, which is not used for the moment).</p><p>Let&rsquo;s analyze this part of the program:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000000fc: 0c1ea00f0000  ......  mov   0x1e 0x0fa0
00000102: 0c1c00000000  ......  mov   0x1c 0x0000
00000108: 0c1d11000000  ......  mov   0x1d 0x0011
0000010e: 181900000000  ......  input 0x19
00000114: 161e19000000  ......  store 0x1e 0x19
0000011a: 011e1e010000  ......  addi  0x1e 0x1e 0x01  
00000120: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000126: 131c1d2d0000  ...-..  jle   0x1c 0x1d 0x2d
</code></pre></div><p>Basically, it moves the values to the registers (as shown previously). Then it uses <code>vm_input</code>, which reads a single character from <code>stdin</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_input</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  byte bVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar2;</span>

<span class="mtk1">  uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">  bVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>  
<span class="mtk1">  param_1[(</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) bVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> uVar2;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Then, it uses <code>vm_store</code> to store the character in the address pointed to by <code>0x1e</code>. After that, registers <code>0x1e</code> and <code>0x1c</code> are increased in <code>1</code> (register <code>0x1c</code> is used as a counter).</p><p>Then it uses <code>vm_jle</code> to test if value at <code>0x1c</code> is less than or equal to the value at <code>0x1d</code>. If so, it jumps to <code>0x2d</code>? Let&rsquo;s analyze <code>vm_jle</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_jle</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">vm</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar1;</span>
<span class="mtk1">  byte bVar2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">ushort</span><span class="mtk1"> uVar3;</span>
<span class="mtk1">  </span>
<span class="mtk1">  bVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>
<span class="mtk1">  uVar1 </span><span class="mtk5">=</span><span class="mtk1"> vm[(</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">)bVar2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  bVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (vm[(</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) bVar2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">&lt;</span><span class="mtk1"> uVar1) {</span>
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    uVar3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u16</span><span class="mtk1">((ulong) </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>  
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk7 mtki">uint</span><span class="mtk1">) uVar3 </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) uVar3) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>We can see that in the case the condition matches, the program returns to the third argument times <code>2</code> and times <code>3</code>. Therefore, <code>jle 0x1c 0x1d 0x2d</code> will jump to <code>0x2d * 6 = 0x010e</code> if the condition matches. In fact, it makes sense. Let&rsquo;s update the assembly code:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000000fc: 0c1ea00f0000  ......  mov   0x1e 0x0fa0
00000102: 0c1c00000000  ......  mov   0x1c 0x0000
00000108: 0c1d11000000  ......  mov   0x1d 0x0011
0000010e: 181900000000  ......  input 0x19
00000114: 161e19000000  ......  store 0x1e 0x19
0000011a: 011e1e010000  ......  addi  0x1e 0x1e 0x01
00000120: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000126: 131c1d2d0000  ...-..  jle   0x1c 0x1d 0x010e  
</code></pre></div><h3 id="first-stage">First stage</h3><p>So, the program executes a loop to read a total of <code>0x11</code> (<code>17</code> in decimal) characters from <code>stdin</code>.</p><p>Let&rsquo;s set a breakpoint at <code>vm_load</code> and enter some data:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>del
<span class="code-green">gef➤  </span>break vm_load
Breakpoint 2 at <span class="code-dark-blue">0x555555555531</span>
<span class="code-green">gef➤  </span>run
Starting program: ./vm bin
[Main Vessel Terminal]
&lt; Enter keycode
&gt; AAAAAAAAAAAAAAAAA

Breakpoint 2, <span class="code-dark-blue">0x0000555555555531</span> in <span class="code-dark-yellow">vm_load</span> ()  
</code></pre></div><p>Let&rsquo;s see where it is stored:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep AAAAAAAAAAAAAAAA
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">AAAAAAAAAAAAAAAA</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[heap]</span>'(0x55555555c000-0x55555557d000), permission=rw-  
  0x555555562440 - 0x555555562453  →   "<span class="code-dark-magenta">AAAAAAAAAAAAAAAAA\n</span>"
  0x5555555714b0 - 0x5555555714c3  →   "<span class="code-dark-magenta">AAAAAAAAAAAAAAAAA\n</span>"
<span class="code-green">gef➤  </span>x/20gx 0x555555562440
<span class="code-dark-blue">0x555555562440</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x555555562450</span>: 0x0000000000000a41      0x0000000000000000
<span class="code-dark-blue">0x555555562460</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x555555562470</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x555555562480</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x555555562490</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x5555555624a0</span>: 0x9acd99ca00000000      0xdcc19cf6cd9adbf6
<span class="code-dark-blue">0x5555555624b0</span>: 0x000000c7de99cddd      0x0000000000000000
<span class="code-dark-blue">0x5555555624c0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x5555555624d0</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>Alright. Moreover, these are the registers:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/20gx 0x55555555c4b0
<span class="code-dark-blue">0x55555555c4b0</span>: 0x0000000000000000      0x0000000000000000  
<span class="code-dark-blue">0x55555555c4c0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4d0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c4e0</span>: 0x0000000000000000      0x0000000a00000000
<span class="code-dark-blue">0x55555555c4f0</span>: 0x000000a900000000      0x0000000a00000000
<span class="code-dark-blue">0x55555555c500</span>: 0x00000fa000001004      0x0000000000000000
<span class="code-dark-blue">0x55555555c510</span>: 0x00005555555614a0      0x000055555555c530
<span class="code-dark-blue">0x55555555c520</span>: 0x0000000000000000      0x0000000000000811
<span class="code-dark-blue">0x55555555c530</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x55555555c540</span>: 0x0000000000000000      0x0000000000000000
</code></pre></div><p>Actually, the values at <code>0x1f</code> and <code>0x1e</code> are offsets to the two buffers (taking the program instructions address as reference):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/4gx 0x00005555555614a0 + 0x0fa0
<span class="code-dark-blue">0x555555562440</span>: 0x4141414141414141      0x4141414141414141  
<span class="code-dark-blue">0x555555562450</span>: 0x0000000000000a41      0x0000000000000000
<span class="code-green">gef➤  </span>x/4gx 0x00005555555614a0 + 0x1004
<span class="code-dark-blue">0x5555555624a4</span>: 0xcd9adbf69acd99ca      0xde99cddddcc19cf6
<span class="code-dark-blue">0x5555555624b4</span>: 0x00000000000000c7      0x0000000000000000
</code></pre></div><p>So, after entering some input data, these instructions are executed:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000012c: 0c1e04100000  ......  mov   0x1e 0x1004
00000132: 0c1fa00f0000  ......  mov   0x1f 0x0fa0
00000138: 0c1c00000000  ......  mov   0x1c 0x0000
0000013e: 0c1d0a000000  ......  mov   0x1d 0x000a
00000144: 0c1ba9000000  ......  mov   0x1b 0x00a9
0000014a: 0c1700000000  ......  mov   0x17 0x0000
00000150: 17191e000000  ......  load  0x19 0x1e
00000156: 17181f000000  ......  load  0x18 0x1f
0000015c: 1519191b0000  ......  xor   0x19 0x19 0x1b
00000162: 1119184e0000  ...N..  je    0x19 0x18 0x01d4  
00000168: 105500000000  .U....  putc  'U'
0000016e: 106e00000000  .n....  putc  'n'
00000174: 106b00000000  .k....  putc  'k'
0000017a: 106e00000000  .n....  putc  'n'
00000180: 106f00000000  .o....  putc  'o'
00000186: 107700000000  .w....  putc  'w'
0000018c: 106e00000000  .n....  putc  'n'
00000192: 102000000000  . ....  putc  ' '
00000198: 106b00000000  .k....  putc  'k'
0000019e: 106500000000  .e....  putc  'e'
000001a4: 107900000000  .y....  putc  'y'
000001aa: 106300000000  .c....  putc  'c'
000001b0: 106f00000000  .o....  putc  'o'
000001b6: 106400000000  .d....  putc  'd'
000001bc: 106500000000  .e....  putc  'e'
000001c2: 102100000000  .!....  putc  '!'
000001c8: 100a00000000  ......  putc  '\n'
000001ce: 0e0000000000  ......  exit
000001d4: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000001da: 011f1f010000  ......  addi  0x1f 0x1f 0x01
000001e0: 011c1c010000  ......  addi  0x1c 0x1c 0x01
000001e6: 131c1d380000  ...8..  jle   0x1c 0x1d 0x0150
</code></pre></div><p>Here we have another loop. It takes a character from a buffer (at the address stored in <code>0x1e</code>) and loads it into register <code>0x19</code>. Then it takes a character from the address at register <code>0x1f</code> (our input) and stores it into register <code>0x18</code>. Then it computes a XOR operation between registers <code>0x19</code> and <code>0x1b</code> (value <code>0xa9</code>) and stores the result at <code>0x19</code>. If the result matches with the character at register <code>0x18</code> (our input character), then it jumps to the bottom of the code snippet (which increases counters and loops again). Otherwise, it prints an error message and exits.</p><p>Since it is using XOR and we know the key and the expected result, let&rsquo;s see what is the expected input:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from pwn import p64, p8, xor
&gt;&gt;&gt; res = p64(0xcd9adbf69acd99ca) + p64(0xde99cddddcc19cf6) + p8(0xc7)  
&gt;&gt;&gt; key = p8(0xa9)
&gt;&gt;&gt; xor(res, key)
b'c0d3_r3d_5hutd0wn'
</code></pre></div><p>With this password, we pass to another stage of the program:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./vm</span> <span class="mtku">bin</span>
[Main Vessel Terminal]
&lt; Enter keycode
&gt; c0d3_r3d_5hutd0wn
&lt; Enter secret phrase  
&gt;
</code></pre></div><p>Curiously, the program uses a counter until <code>0x0a</code>, so we only need to enter a total of <code>11</code> correct characters:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./vm</span> <span class="mtku">bin</span>
[Main Vessel Terminal]
&lt; Enter keycode
&gt; c0d3_r3d_5haaaaaa
&lt; Enter secret phrase  
&gt;
</code></pre></div><h3 id="second-stage">Second stage</h3><p>The program continues with these instructions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000001ec: 0c0f00000000  ......  mov   0x0f 0x0000
000001f2: 0a0f00000000  ......  push  0x0f
000001f8: 0a0f00000000  ......  push  0x0f
000001fe: 0a0f00000000  ......  push  0x0f
00000204: 096503000000  .e....  inv   0x65 0x03
0000020a: 0c1000000000  ......  mov   0x10 0x0000
00000210: 111f106c0000  ...l..  je    0x1f 0x10 0x0288  
00000216: 105400000000  .T....  putc  'T'
0000021c: 106500000000  .e....  putc  'e'
00000222: 107200000000  .r....  putc  'r'
00000228: 106d00000000  .m....  putc  'm'
0000022e: 106900000000  .i....  putc  'i'
00000234: 106e00000000  .n....  putc  'n'
0000023a: 106100000000  .a....  putc  'a'
00000240: 106c00000000  .l....  putc  'l'
00000246: 102000000000  . ....  putc  ' '
0000024c: 106200000000  .b....  putc  'b'
00000252: 106c00000000  .l....  putc  'l'
00000258: 106f00000000  .o....  putc  'o'
0000025e: 106300000000  .c....  putc  'c'
00000264: 106b00000000  .k....  putc  'k'
0000026a: 106500000000  .e....  putc  'e'
00000270: 106400000000  .d....  putc  'd'
00000276: 102100000000  .!....  putc  '!'
0000027c: 100a00000000  ......  putc  '\n'
00000282: 0e0000000000  ......  exit
</code></pre></div><p>It is interesting how the program is pushing <code>NULL</code> values onto the stack. Then it uses <code>vm_inv</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vm_inv</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">vm</span><span class="mtk1">) {</span>
<span class="mtk1">  byte a;</span>
<span class="mtk1">  byte b;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> uVar3;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> lVar4;</span>

<span class="mtk1">  a </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong)</span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)(vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>
<span class="mtk1">  b </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">u8</span><span class="mtk1">((ulong)</span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)(vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">24</span><span class="mtk1">));</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (b </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    uVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    uVar1 </span><span class="mtk5">=</span><span class="mtk1"> vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">];</span>
<span class="mtk1">    vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> uVar1 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    uVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) ((ulong) (uVar1 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">26</span><span class="mtk1">));</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (b </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">    uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    uVar2 </span><span class="mtk5">=</span><span class="mtk1"> vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">];</span>
<span class="mtk1">    vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> uVar2 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) ((ulong) (uVar2 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">26</span><span class="mtk1">));</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (b </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) {</span>
<span class="mtk1">    uVar3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    uVar3 </span><span class="mtk5">=</span><span class="mtk1"> vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">];</span>
<span class="mtk1">    vm[</span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> uVar3 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    uVar3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) ((ulong) (uVar3 </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">26</span><span class="mtk1">));</span>
<span class="mtk1">  }</span>

<span class="mtk1">  lVar4 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">syscall</span><span class="mtk1">((ulong) a, (ulong) uVar1, (ulong) uVar2, (ulong) </span><span class="mtk1">uVar3);</span>  
<span class="mtk1">  vm[</span><span class="mtk5">0x</span><span class="mtk6">21</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) lVar4;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">vm </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The function looks a bit difficult to understand. The key here is the <code>syscall</code> function. Basically, <code>vm_inv</code> will run a <code>syscall</code> instruction. In this case, it is running <code>sys_ptrace</code> because <code>$rax = 0x65</code> (more information at <a href="https://x64.syscall.sh">x64.syscall.sh</a>). This <code>syscall</code> instruction will tell if the current program is being debugged:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>del
<span class="code-green">gef➤  </span>run
Starting program: ./vm bin
[Main Vessel Terminal]
&lt; Enter keycode
&gt; c0d3_r3d_5hutd0wn
Terminal blocked!
[Inferior 1 (process 187597) exited normally]  
<span class="code-red">gef➤
</code></pre></div><p>It will block us if we are in a debugger&mldr; Actually, the program just checks that the error code of the <code>syscall</code> instruction is <code>0</code> or not. So, let&rsquo;s bypass this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">gef➤  </span>disassemble vm_inv
Dump of assembler code for function vm_inv:
   <span class="code-dark-blue">0x0000000000002025</span> &lt;+0&gt;:     endbr64
   <span class="code-dark-blue">0x0000000000002029</span> &lt;+4&gt;:     push   rbp
   <span class="code-dark-blue">0x000000000000202a</span> &lt;+5&gt;:     mov    rbp,rsp
   <span class="code-dark-blue">0x000000000000202d</span> &lt;+8&gt;:     sub    rsp,0x30
   <span class="code-dark-blue">0x0000000000002031</span> &lt;+12&gt;:    mov    QWORD PTR [rbp-0x28],rdi
   ...
   <span class="code-dark-blue">0x0000000000002151</span> &lt;+300&gt;:   mov    rdi,rax
   <span class="code-dark-blue">0x0000000000002154</span> &lt;+303&gt;:   mov    eax,0x0
   <span class="code-dark-blue">0x0000000000002159</span> &lt;+308&gt;:   call   <span class="code-dark-blue">0x11d0</span> &lt;<span class="code-dark-yellow">syscall@plt</span>&gt;  
   <span class="code-dark-blue">0x000000000000215e</span> &lt;+313&gt;:   mov    edx,eax
   <span class="code-dark-blue">0x0000000000002160</span> &lt;+315&gt;:   mov    rax,QWORD PTR [rbp-0x28]
   <span class="code-dark-blue">0x0000000000002164</span> &lt;+319&gt;:   mov    DWORD PTR [rax+0x84],edx
   <span class="code-dark-blue">0x000000000000216a</span> &lt;+325&gt;:   mov    rax,QWORD PTR [rbp-0x28]
   <span class="code-dark-blue">0x000000000000216e</span> &lt;+329&gt;:   mov    eax,DWORD PTR [rax]
   <span class="code-dark-blue">0x0000000000002170</span> &lt;+331&gt;:   lea    edx,[rax+0x6]
   <span class="code-dark-blue">0x0000000000002173</span> &lt;+334&gt;:   mov    rax,QWORD PTR [rbp-0x28]
   <span class="code-dark-blue">0x0000000000002177</span> &lt;+338&gt;:   mov    DWORD PTR [rax],edx
   <span class="code-dark-blue">0x0000000000002179</span> &lt;+340&gt;:   nop
   <span class="code-dark-blue">0x000000000000217a</span> &lt;+341&gt;:   leave
   <span class="code-dark-blue">0x000000000000217b</span> &lt;+342&gt;:   ret
End of assembler dump.
<span class="code-red">gef➤  </span>break *vm_inv+313
Breakpoint 1 at <span class="code-dark-blue">0x215e</span>
<span class="code-red">gef➤  </span>run bin
Starting program: ./vm bin
[Main Vessel Terminal]
&lt; Enter keycode
&gt; c0d3_r3d_5hutd0wn

Breakpoint 1, <span class="code-dark-blue">0x000055555555615e</span> in <span class="code-dark-yellow">vm_inv</span> ()
</code></pre></div><p>This is the value of <code>$rax</code> (<code>-1</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>p/x $rax
$1 = 0xffffffffffffffff  
</code></pre></div><p>But inside the debugger we got the power:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>set $rax = 0
<span class="code-green">gef➤  </span>continue
Continuing.
&lt; Enter secret phrase  
&gt;
</code></pre></div><p>As easy as that! This is the code after the <code>sys_ptrace</code> check:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">00000288: 0c1e77000000  ..w...  mov   0x1e 0x0077
0000028e: 051e1e060000  ......  muli  0x1e 0x1e 0x06
00000294: 0c1c00000000  ......  mov   0x1c 0x0000
0000029a: 0c1ddc050000  ......  mov   0x1d 0x05dc
000002a0: 0c1b45000000  ..E...  mov   0x1b 0x0045
000002a6: 17191e000000  ......  load  0x19 0x1e
000002ac: 1519191b0000  ......  xor   0x19 0x19 0x1b
000002b2: 161e19000000  ......  store 0x1e 0x19
000002b8: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000002be: 011c1c010000  ......  addi  0x1c 0x1c 0x01
000002c4: 131c1d710000  ...q..  jle   0x1c 0x1d 0x02a6  
</code></pre></div><p>With the above code, register <code>0x1e</code> will be set to <code>0x02ca</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; hex(0x77 * 0x6)  
'0x2ca'
</code></pre></div><p>Then, <code>0x1c</code> to <code>0x0000</code>, <code>0x1d</code> to <code>0x05dc</code> and <code>0x1b</code> to <code>0x45</code>. After that, the program takes a byte at the address stored in register <code>0x1e</code> and saves it at register <code>0x19</code>, uses XOR with key at register <code>0x1b</code> (<code>0x45</code>) and stores back the result from register <code>0x19</code> to the address in register <code>0x1e</code>.</p><p>Notice that the target address refers to part of the program:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 0x55555555d490 + 0x2ca
<span class="code-dark-blue">0x55555555d75a</span>: 0x4545457955000071      0x5545454545655545  
<span class="code-dark-blue">0x55555555d76a</span>: 0x452b554545454500      0x4545453155454545
<span class="code-dark-blue">0x55555555d77a</span>: 0x5545454545205545      0x4565554545454537
<span class="code-dark-blue">0x55555555d78a</span>: 0x4545453655454545      0x5545454545205545
<span class="code-dark-blue">0x55555555d79a</span>: 0x4537554545454526      0x4545452055454545
<span class="code-dark-blue">0x55555555d7aa</span>: 0x5545454545315545      0x4535554545454565
<span class="code-dark-blue">0x55555555d7ba</span>: 0x4545452d55454545      0x5545454545375545
<span class="code-dark-blue">0x55555555d7ca</span>: 0x4536554545454524      0x4545452055454545
<span class="code-dark-blue">0x55555555d7da</span>: 0x55454545454f5545      0x456555454545457b
<span class="code-dark-blue">0x55555555d7ea</span>: 0x4554755b49454545      0x4945454545594945
<span class="code-dark-blue">0x55555555d7fa</span>: 0x455c5d4545456158      0x45455c5b53454545
<span class="code-dark-blue">0x55555555d80a</span>: 0x444545445b5b4445      0x5859564545445959
<span class="code-dark-blue">0x55555555d81a</span>: 0x45454559494545d7      0x4945454566584945
<span class="code-dark-blue">0x55555555d82a</span>: 0xd15a49454554755b      0x4545455f49454554
<span class="code-dark-blue">0x55555555d83a</span>: 0x52454545665e4945      0x5a50524545455b51
</code></pre></div><p>Obviously, they are not valid <em>opcode</em> instructions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000002ca: 557945454545  UyEEEE  
000002d0: 556545454545  UeEEEE
000002d6: 550045454545  U.EEEE
000002dc: 552b45454545  U+EEEE
000002e2: 553145454545  U1EEEE
000002e8: 552045454545  U EEEE
000002ee: 553745454545  U7EEEE
000002f4: 556545454545  UeEEEE
000002fa: 553645454545  U6EEEE
00000300: 552045454545  U EEEE
00000306: 552645454545  U&EEEE
0000030c: 553745454545  U7EEEE
...
</code></pre></div><p>But using XOR on these, the program decrypts a ciphertext that will transform into valid <em>opcode</em> instructions. Let&rsquo;s do it in Python:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from pwn import xor
&gt;&gt;&gt;
&gt;&gt;&gt; with open('bin', 'rb') as f:
...     program = f.read()
...
&gt;&gt;&gt; program = program[3:]
&gt;&gt;&gt;
&gt;&gt;&gt; key = b'\x45'
&gt;&gt;&gt; ct = program[0x2ca : 0x2ca + 0x5dc]
&gt;&gt;&gt; instructions = xor(ct, key)
&gt;&gt;&gt; instructions.hex()
'103c00000000102000000000104500000000106e00000000107400000000106500000000107200000000102000000000107300000000106500000000106300000000107200000000106500000000107400000000102000000000107000000000106800000000107200000000106100000000107300000000106500000000100a00000000103e000000001020000000000c1e301100000c1c000000000c1d24000000181900000000161e19000000011e1e010000011c1c010000131c1d9200000c1c000000000c1d230000000c1e301100000c1f941100000c1a000000000c1b2300000017141e00000017151f0000000a14000000000b13000000000c1230110000001212150000171112000000161e11000000161213000000011a1a010000011e1e010000011f1f010000131a1b9d00000c1e301100000c1ff81100000c1a000000000c1b2300000017141e0000000a1f000000000b0f00000000000f0f1c000017100f000000151414100000161e14000000011a1a010000011e1e010000131a1bae0000011c1c010000131c1d9900000c1e301100000c1f5c1200000c1a000000000c1b23000000170f1e00000017101f000000110f10c90000105700000000107200000000106f00000000106e00000000106700000000102100000000100a000000000e0000000000011a1a010000011e1e010000011f1f010000131a1bbe0000104100000000106300000000106300000000106500000000107300000000107300000000102000000000106700000000107200000000106100000000106e00000000107400000000106500000000106400000000102c00000000102000000000107300000000106800000000107500000000107400000000107400000000106900000000106e00000000106700000000102000000000106400000000106f00000000107700000000106e00000000102100000000100a000000000e0000000000454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545'  
&gt;&gt;&gt; print('\n'.join(instructions[i : i + 6].hex() for i in range(0, len(instructions), 6)))
103c00000000
102000000000
104500000000
106e00000000
107400000000
106500000000
107200000000
102000000000
107300000000
106500000000
106300000000
107200000000
106500000000
107400000000
102000000000
107000000000
106800000000
107200000000
106100000000
107300000000
106500000000
100a00000000
103e00000000
102000000000
0c1e30110000
0c1c00000000
0c1d24000000
181900000000
161e19000000
011e1e010000
011c1c010000
131c1d920000
0c1c00000000
0c1d23000000
0c1e30110000
0c1f94110000
0c1a00000000
0c1b23000000
17141e000000
17151f000000
0a1400000000
0b1300000000
0c1230110000
001212150000
171112000000
161e11000000
161213000000
011a1a010000
011e1e010000
011f1f010000
131a1b9d0000
0c1e30110000
0c1ff8110000
0c1a00000000
0c1b23000000
17141e000000
0a1f00000000
0b0f00000000
000f0f1c0000
17100f000000
151414100000
161e14000000
011a1a010000
011e1e010000
131a1bae0000
011c1c010000
131c1d990000
0c1e30110000
0c1f5c120000
0c1a00000000
0c1b23000000
170f1e000000
17101f000000
110f10c90000
105700000000
107200000000
106f00000000
106e00000000
106700000000
102100000000
100a00000000
0e0000000000
011a1a010000
011e1e010000
011f1f010000
131a1bbe0000
104100000000
106300000000
106300000000
106500000000
107300000000
107300000000
102000000000
106700000000
107200000000
106100000000
106e00000000
107400000000
106500000000
106400000000
102c00000000
102000000000
107300000000
106800000000
107500000000
107400000000
107400000000
106900000000
106e00000000
106700000000
102000000000
106400000000
106f00000000
107700000000
106e00000000
102100000000
100a00000000
0e0000000000
454545454545
454545454545
454545454545
...
</code></pre></div><p>So, we have more code to analyze.</p><h3 id="third-stage">Third stage</h3><p>These are the instructions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000002ca: 103c00000000  .<....  putc  '<'
000002d0: 102000000000  . ....  putc  ' '
000002d6: 104500000000  .E....  putc  'E'
000002dc: 106e00000000  .n....  putc  'n'
000002e2: 107400000000  .t....  putc  't'
000002e8: 106500000000  .e....  putc  'e'
000002ee: 107200000000  .r....  putc  'r'
000002f4: 102000000000  . ....  putc  ' '
000002fa: 107300000000  .s....  putc  's'
00000300: 106500000000  .e....  putc  'e'
00000306: 106300000000  .c....  putc  'c'
0000030c: 107200000000  .r....  putc  'r'
00000312: 106500000000  .e....  putc  'e'
00000318: 107400000000  .t....  putc  't'
0000031e: 102000000000  . ....  putc  ' '
00000324: 107000000000  .p....  putc  'p'
0000032a: 106800000000  .h....  putc  'h'
00000330: 107200000000  .r....  putc  'r'
00000336: 106100000000  .a....  putc  'a'
0000033c: 107300000000  .s....  putc  's'
00000342: 106500000000  .e....  putc  'e'
00000348: 100a00000000  ......  putc  '\n'
0000034e: 103e00000000  .>....  putc  '>'
00000354: 102000000000  . ....  putc  ' '
0000035a: 0c1e30110000  ..0...  mov   0x1e 0x1130
00000360: 0c1c00000000  ......  mov   0x1c 0x0000
00000366: 0c1d24000000  ..$...  mov   0x1d 0x0024
0000036c: 181900000000  ......  input 0x19
00000372: 161e19000000  ......  store 0x1e 0x19
00000378: 011e1e010000  ......  addi  0x1e 0x1e 0x01
0000037e: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000384: 131c1d920000  ......  jle   0x1c 0x1d 0x36c  
0000038a: 0c1c00000000  ......  mov   0x1c 0x0000
00000390: 0c1d23000000  ..#...  mov   0x1d 0x0023
00000396: 0c1e30110000  ..0...  mov   0x1e 0x1130
0000039c: 0c1f94110000  ......  mov   0x1f 0x1194
000003a2: 0c1a00000000  ......  mov   0x1a 0x0000
000003a8: 0c1b23000000  ..#...  mov   0x1b 0x0023
000003ae: 17141e000000  ......  load  0x14 0x1e
000003b4: 17151f000000  ......  load  0x15 0x1f
000003ba: 0a1400000000  ......  push  0x14
000003c0: 0b1300000000  ......  pop   0x13
000003c6: 0c1230110000  ..0...  mov   0x12 0x1130
000003cc: 001212150000  ......  add   0x12 0x12 0x15
000003d2: 171112000000  ......  load  0x11 0x12
000003d8: 161e11000000  ......  store 0x1e 0x11
000003de: 161213000000  ......  store 0x12 0x13
000003e4: 011a1a010000  ......  addi  0x1a 0x1a 0x01
000003ea: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000003f0: 011f1f010000  ......  addi  0x1f 0x1f 0x01
000003f6: 131a1b9d0000  ......  jle   0x1a 0x1b 0x3ae
000003fc: 0c1e30110000  ..0...  mov   0x1e 0x1130
00000402: 0c1ff8110000  ......  mov   0x1f 0x11f8
00000408: 0c1a00000000  ......  mov   0x1a 0x0000
0000040e: 0c1b23000000  ..#...  mov   0x1b 0x0023
00000414: 17141e000000  ......  load  0x14 0x1e
0000041a: 0a1f00000000  ......  push  0x1f
00000420: 0b0f00000000  ......  pop   0x0f
00000426: 000f0f1c0000  ......  add   0x0f 0x0f 0x1c
0000042c: 17100f000000  ......  load  0x10 0x0f
00000432: 151414100000  ......  xor   0x14 0x14 0x10
00000438: 161e14000000  ......  store 0x1e 0x14
0000043e: 011a1a010000  ......  addi  0x1a 0x1a 0x01
00000444: 011e1e010000  ......  addi  0x1e 0x1e 0x01
0000044a: 131a1bae0000  ......  jle   0x1a 0x1b 0x414
00000450: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000456: 131c1d990000  ......  jle   0x1c 0x1d 0x396
0000045c: 0c1e30110000  ..0...  mov   0x1e 0x1130
00000462: 0c1f5c120000  ..\...  mov   0x1f 0x125c
00000468: 0c1a00000000  ......  mov   0x1a 0x0000
0000046e: 0c1b23000000  ..#...  mov   0x1b 0x0023
00000474: 170f1e000000  ......  load  0x0f 0x1e
0000047a: 17101f000000  ......  load  0x10 0x1f
00000480: 110f10c90000  ......  je    0x0f 0x10 0x4b6
00000486: 105700000000  .W....  putc  'W'
0000048c: 107200000000  .r....  putc  'r'
00000492: 106f00000000  .o....  putc  'o'
00000498: 106e00000000  .n....  putc  'n'
0000049e: 106700000000  .g....  putc  'g'
000004a4: 102100000000  .!....  putc  '!'
000004aa: 100a00000000  ......  putc  '\n'
000004b0: 0e0000000000  ......  exit
000004b6: 011a1a010000  ......  addi  0x1a 0x1a 0x01
000004bc: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000004c2: 011f1f010000  ......  addi  0x1f 0x1f 0x01
000004c8: 131a1bbe0000  ......  jle   0x1a 0x1b 0x474
000004ce: 104100000000  .A....  putc  'A'
000004d4: 106300000000  .c....  putc  'c'
000004da: 106300000000  .c....  putc  'c'
000004e0: 106500000000  .e....  putc  'e'
000004e6: 107300000000  .s....  putc  's'
000004ec: 107300000000  .s....  putc  's'
000004f2: 102000000000  . ....  putc  ' '
000004f8: 106700000000  .g....  putc  'g'
000004fe: 107200000000  .r....  putc  'r'
00000504: 106100000000  .a....  putc  'a'
0000050a: 106e00000000  .n....  putc  'n'
00000510: 107400000000  .t....  putc  't'
00000516: 106500000000  .e....  putc  'e'
0000051c: 106400000000  .d....  putc  'd'
00000522: 102c00000000  .,....  putc  ','
00000528: 102000000000  . ....  putc  ' '
0000052e: 107300000000  .s....  putc  's'
00000534: 106800000000  .h....  putc  'h'
0000053a: 107500000000  .u....  putc  'u'
00000540: 107400000000  .t....  putc  't'
00000546: 107400000000  .t....  putc  't'
0000054c: 106900000000  .i....  putc  'i'
00000552: 106e00000000  .n....  putc  'n'
00000558: 106700000000  .g....  putc  'g'
0000055e: 102000000000  . ....  putc  ' '
00000564: 106400000000  .d....  putc  'd'
0000056a: 106f00000000  .o....  putc  'o'
00000570: 107700000000  .w....  putc  'w'
00000576: 106e00000000  .n....  putc  'n'
0000057c: 102100000000  .!....  putc  '!'
00000582: 100a00000000  ......  putc  '\n'
00000588: 0e0000000000  ......  exit
</code></pre></div><p>This part should be clear:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000035a: 0c1e30110000  ..0...  mov   0x1e 0x1130
00000360: 0c1c00000000  ......  mov   0x1c 0x0000
00000366: 0c1d24000000  ..$...  mov   0x1d 0x0024
0000036c: 181900000000  ......  input 0x19
00000372: 161e19000000  ......  store 0x1e 0x19
00000378: 011e1e010000  ......  addi  0x1e 0x1e 0x01
0000037e: 011c1c010000  ......  addi  0x1c 0x1c 0x01
00000384: 131c1d920000  ......  jle   0x1c 0x1d 0x36c  
</code></pre></div><p>It is just taking user input again (size <code>0x24</code> bytes). The rest of the code is worth drawing it into a graph:</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202023/Alien-Saboteaur-1.webp" alt="Alien Saboteaur 1"></p><p>As can be seen, there is a loop on register <code>0x1c</code> that contains two inner loops (on register <code>0x1a</code>). Notice that register <code>0x1e</code> contains the address where our input data is stored at (<code>0x1130</code>).</p><h2 id="python-implementation">Python implementation</h2><p>Let&rsquo;s analyze the first inner loop. First of all, register <code>0x1f</code> contains <code>0x1194</code>, which represents this buffer:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/6gx 0x00005555555614a0 + 0x1194
<span class="code-dark-blue">0x555555562634</span>: 0x0e1d00070a0f1913      0x14181f0b010c1016  
<span class="code-dark-blue">0x555555562644</span>: 0x122204211a1c0908      0x1715020620111b05
<span class="code-dark-blue">0x555555562654</span>: 0x0000000003231e0d      0x0000000000000000
</code></pre></div><p>This is the code for the first inner loop:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003ae: 17141e000000  ......  load  0x14 0x1e
000003b4: 17151f000000  ......  load  0x15 0x1f
000003ba: 0a1400000000  ......  push  0x14
000003c0: 0b1300000000  ......  pop   0x13
000003c6: 0c1230110000  ..0...  mov   0x12 0x1130
000003cc: 001212150000  ......  add   0x12 0x12 0x15
000003d2: 171112000000  ......  load  0x11 0x12
000003d8: 161e11000000  ......  store 0x1e 0x11
000003de: 161213000000  ......  store 0x12 0x13
000003e4: 011a1a010000  ......  addi  0x1a 0x1a 0x01
000003ea: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000003f0: 011f1f010000  ......  addi  0x1f 0x1f 0x01
000003f6: 131a1b9d0000  ......  jle   0x1a 0x1b 0x3ae  
</code></pre></div><p>Let&rsquo;s break it into pieces:</p><ul><li>Loads bytes from user input (<code>0x1130</code>) and stored buffer (<code>0x1194</code>) into registers <code>0x14</code> and <code>0x15</code>, respectively:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003ae: 17141e000000  ......  load  0x14 0x1e
000003b4: 17151f000000  ......  load  0x15 0x1f
</code></pre></div><ul><li>Copies <code>0x14</code> to <code>0x13</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003ba: 0a1400000000  ......  push  0x14  
000003c0: 0b1300000000  ......  pop   0x13
</code></pre></div><ul><li>Uses register <code>0x15</code> as an offset to the user data (<code>0x1130</code>) and stores the position in <code>0x12</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003c6: 0c1230110000  ..0...  mov   0x12 0x1130
000003cc: 001212150000  ......  add   0x12 0x12 0x15  
</code></pre></div><ul><li>Stores the character at address pointed to by <code>0x12</code> into <code>0x11</code> and stores this character in the address pointed to by <code>0x1e</code>. Also, replaces the character at offset the value of register <code>0x12</code> with the original character (stored in <code>0x13</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003d2: 171112000000  ......  load  0x11 0x12  
000003d8: 161e11000000  ......  store 0x1e 0x11
000003de: 161213000000  ......  store 0x12 0x13
</code></pre></div><ul><li>Increases counters and checks the loop condition:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000003e4: 011a1a010000  ......  addi  0x1a 0x1a 0x01
000003ea: 011e1e010000  ......  addi  0x1e 0x1e 0x01
000003f0: 011f1f010000  ......  addi  0x1f 0x1f 0x01
000003f6: 131a1b9d0000  ......  jle   0x1a 0x1b 0x3ae  
</code></pre></div><p>In breaf, it is a swap, so our input data will be shuffled according to a fix pattern. We can translate into Python code, which will be much more readable:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pos</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">orders</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>  
</code></pre></div><p>Let&rsquo;s move on to the second loop. Now <code>0x1f</code> points to another buffer (<code>0x11f8</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/6gx 0x00005555555614a0 + 0x11f8
<span class="code-dark-blue">0x555555562698</span>: 0xebdefb01b247b016      0x216e7c105d5b5d82  
<span class="code-dark-blue">0x5555555626a8</span>: 0xd7d423362a45e75f      0xcb5ee7ed11a3d526
<span class="code-dark-blue">0x5555555626b8</span>: 0x00000000e2dd9fdb      0x0000000000000000
</code></pre></div><p>This is the relevant code:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">00000414: 17141e000000  ......  load  0x14 0x1e
0000041a: 0a1f00000000  ......  push  0x1f
00000420: 0b0f00000000  ......  pop   0x0f
00000426: 000f0f1c0000  ......  add   0x0f 0x0f 0x1c
0000042c: 17100f000000  ......  load  0x10 0x0f
00000432: 151414100000  ......  xor   0x14 0x14 0x10
00000438: 161e14000000  ......  store 0x1e 0x14
0000043e: 011a1a010000  ......  addi  0x1a 0x1a 0x01
00000444: 011e1e010000  ......  addi  0x1e 0x1e 0x01
0000044a: 131a1bae0000  ......  jle   0x1a 0x1b 0x414  
</code></pre></div><p>This one should be easier to understand, but let&rsquo;s break it into pieces again:</p><ul><li>Loads a shuffled character:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">00000414: 17141e000000  ......  load  0x14 0x1e  
</code></pre></div><ul><li>Copies the address of the second buffer from <code>0x1f</code> to <code>0x0f</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000041a: 0a1f00000000  ......  push  0x1f  
00000420: 0b0f00000000  ......  pop   0x0f
</code></pre></div><ul><li>Increases the address stored at <code>0x0f</code> in an offset equal to the value in <code>0x1c</code> (the outer loop&rsquo;s counter):</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">00000426: 000f0f1c0000  ......  add   0x0f 0x0f 0x1c  
</code></pre></div><ul><li>Loads the character at <code>0x0f</code> into <code>0x10</code> and applies XOR to the value at <code>0x14</code>. The result is stored at <code>0x14</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000042c: 17100f000000  ......  load  0x10 0x0f
00000432: 151414100000  ......  xor   0x14 0x14 0x10  
</code></pre></div><ul><li>Stores the value at <code>0x14</code> in the address pointed to by <code>0x1e</code> (user data):</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">00000438: 161e14000000  ......  store 0x1e 0x14  
</code></pre></div><ul><li>Increases counters and checks loop conditions:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000043e: 011a1a010000  ......  addi  0x1a 0x1a 0x01
00000444: 011e1e010000  ......  addi  0x1e 0x1e 0x01
0000044a: 131a1bae0000  ......  jle   0x1a 0x1b 0x414  
</code></pre></div><p>In Python, this loop can be written as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">^=</span><span class="mtk1"> </span><span class="mtk1">xors</span><span class="mtk1">[</span><span class="mtk1">k</span><span class="mtk1">]</span>  
</code></pre></div><p>Notice that the inner loops are within another loop. So, summarizing, this is how tihs part looks like in Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">orders</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">0e1d00070a0f1913</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">14181f0b010c1016</span><span class="mtk1">,</span>
<span class="mtk1">                  </span><span class="mtk7 mtki">0x</span><span class="mtk6">122204211a1c0908</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">1715020620111b05</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">0000000003231e0d</span><span class="mtk1">]))</span>  

<span class="mtk1">xors</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">ebdefb01b247b016</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">216e7c105d5b5d82</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk7 mtki">0x</span><span class="mtk6">d7d423362a45e75f</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">cb5ee7ed11a3d526</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">00000000e2dd9fdb</span><span class="mtk1">]))</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pos</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">orders</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">^=</span><span class="mtk1"> </span><span class="mtk1">xors</span><span class="mtk1">[</span><span class="mtk1">k</span><span class="mtk1">]</span>
</code></pre></div><p>After these loops, the program takes another buffer (<code>0x125c</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/6gx 0x00005555555614a0 + 0x125c
<span class="code-dark-blue">0x5555555626fc</span>: 0x6c5640334a775d65      0x36666e6e355d3775  
<span class="code-dark-blue">0x55555556270c</span>: 0x79316a776570366c      0x32336e6c7f70315d
<span class="code-dark-blue">0x55555556271c</span>: 0x000000005d313636      0x0000000000000000
</code></pre></div><p>It is just comparing the result of all the operations on the user buffer (<code>0x1130</code>) with the above one. If everything matches, the program will succeed; otherwise, the program will say <code>Wrong!</code>.</p><p>Just to complete the Python implementation, this is the code for the third stage:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> p64</span>


<span class="mtk1">orders</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">0e1d00070a0f1913</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">14181f0b010c1016</span><span class="mtk1">,</span>
<span class="mtk1">                  </span><span class="mtk7 mtki">0x</span><span class="mtk6">122204211a1c0908</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">1715020620111b05</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">0000000003231e0d</span><span class="mtk1">]))</span>

<span class="mtk1">xors</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">ebdefb01b247b016</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">216e7c105d5b5d82</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk7 mtki">0x</span><span class="mtk6">d7d423362a45e75f</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">cb5ee7ed11a3d526</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">00000000e2dd9fdb</span><span class="mtk1">]))</span>

<span class="mtk1">expected_result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">6c5640334a775d65</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">36666e6e355d3775</span><span class="mtk1">,</span>
<span class="mtk1">                           </span><span class="mtk7 mtki">0x</span><span class="mtk6">79316a776570366c</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">32336e6c7f70315d</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">000000005d313636</span><span class="mtk1">]))</span>  

<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'&lt; Enter secret phrase</span><span class="mtk6">\n</span><span class="mtk4">&gt; '</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pos</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">orders</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">^=</span><span class="mtk1"> </span><span class="mtk1">xors</span><span class="mtk1">[</span><span class="mtk1">k</span><span class="mtk1">]</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">expected_result</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Wrong!'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">()</span>

<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Access granted, shutting down!'</span><span class="mtk1">)</span>
<span class="mtk8">exit</span><span class="mtk1">()</span>
</code></pre></div><h3 id="reversing-the-algorithm">Reversing the algorithm</h3><p>Great, now we only need to reverse the algorithm. This is relatively easy, since all operations involved are reversible (XOR and swap), so we can take the expected output and find the expected input. We only need to &ldquo;reverse&rdquo; all operations:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> p64</span>


<span class="mtk1">orders</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">0e1d00070a0f1913</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">14181f0b010c1016</span><span class="mtk1">,</span>
<span class="mtk1">                  </span><span class="mtk7 mtki">0x</span><span class="mtk6">122204211a1c0908</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">1715020620111b05</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">0000000003231e0d</span><span class="mtk1">]))</span>

<span class="mtk1">xors</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">ebdefb01b247b016</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">216e7c105d5b5d82</span><span class="mtk1">,</span>
<span class="mtk1">                </span><span class="mtk7 mtki">0x</span><span class="mtk6">d7d423362a45e75f</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">cb5ee7ed11a3d526</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">00000000e2dd9fdb</span><span class="mtk1">]))</span>

<span class="mtk1">expected_result</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8 mtku">map</span><span class="mtk1">(p64, [</span><span class="mtk7 mtki">0x</span><span class="mtk6">6c5640334a775d65</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">36666e6e355d3775</span><span class="mtk1">,</span>
<span class="mtk1">                           </span><span class="mtk7 mtki">0x</span><span class="mtk6">79316a776570366c</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">32336e6c7f70315d</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">000000005d313636</span><span class="mtk1">]))</span>  

<span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">expected_result</span><span class="mtk1">)</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">^=</span><span class="mtk1"> </span><span class="mtk1">xors</span><span class="mtk1">[</span><span class="mtk1">k</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">24</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">pos</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">orders</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">pos</span><span class="mtk1">], </span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>

<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">data</span><span class="mtk1">))</span>
</code></pre></div><h2 id="flag">Flag</h2><p>If we run the above code, we will find the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
b'HTB{5w1rl_4r0und_7h3_4l13n_l4ngu4g3}\x00\x00\x00\x00'  
</code></pre></div><p>Obviously, it also works in the Python implementation and in the original <code>vm</code> binary and <code>bin</code> program:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">test.py</span>
&lt; Enter secret phrase
&gt; HTB{5w1rl_4r0und_7h3_4l13n_l4ngu4g3}  
Access granted, shutting down!

<span class="code-cyan">$</span> <span class="code-dark-green">./vm</span> <span class="mtku">bin</span>
[Main Vessel Terminal]
&lt; Enter keycode
&gt; c0d3_r3d_5hutd0wn
&lt; Enter secret phrase
&gt; HTB{5w1rl_4r0und_7h3_4l13n_l4ngu4g3}
Access granted, shutting down!
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#program-parsing">Program parsing</a></li></ul></li><li><a href="#program-analysis">Program analysis</a><ul><li><a href="#first-stage">First stage</a></li><li><a href="#second-stage">Second stage</a></li><li><a href="#third-stage">Third stage</a></li></ul></li><li><a href="#python-implementation">Python implementation</a><ul><li><a href="#reversing-the-algorithm">Reversing the algorithm</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>