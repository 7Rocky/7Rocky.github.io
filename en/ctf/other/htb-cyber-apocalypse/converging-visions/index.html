<!doctype html><html lang="en"><head><title>Converging Visions | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB CA 2023. ECC. Binary search. Finding curve parameters. Smart's attack. PRNG"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB CA 2023. ECC. Binary search. Finding curve parameters. Smart's attack. PRNG"><meta itemprop="keywords" content><meta itemprop="name" content="Converging Visions"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB CA 2023. ECC. Binary search. Finding curve parameters. Smart's attack. PRNG"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Converging Visions"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/converging-visions/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB CA 2023. ECC. Binary search. Finding curve parameters. Smart's attack. PRNG"><meta name="twitter:description" content="HTB CA 2023. ECC. Binary search. Finding curve parameters. Smart's attack. PRNG"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Converging Visions"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/converging-visions/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-cyber-apocalypse/converging-visions/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB CYBER APOCALYPSE</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/converging-visions/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/converging-visions/&amp;text=Converging%20Visions" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/converging-visions/&amp;title=Converging%20Visions" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Converging Visions</h1><p class="mb4 f6 dib tracked">9 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#ecc-background">ECC background</a></li><li><a href="#finding-curve-parameters">Finding curve parameters</a></li><li><a href="#understanding-the-challenge">Understanding the challenge</a></li><li><a href="#smarts-attack">Smart&rsquo;s attack</a></li><li><a href="#analyzing-the-prng">Analyzing the PRNG</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are provided with the server source code in Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> secret </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">FLAG</span><span class="mtk1">, p, a, b</span>
<span class="mtk5">from</span><span class="mtk1"> sage.all_cmdline </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PRNG</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">mul1</span><span class="mtk1">, </span><span class="mtk9 mtki">mul2</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">60897882583250395019290734183554677148448130569594</span><span class="mtk6">43481824909430411674443639248386564763122373451773</span><span class="mtk6">38158266041105992233408699669643665700905532400804</span><span class="mtk6">1039</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">exp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">mul1</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">mul2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">inc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">.</span><span class="mtk8">from_bytes</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Coordinates lost in space'</span><span class="mtk1">, </span><span class="mtk4">'big'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> randint(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rotate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul1</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">                     </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">inc</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">exp</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1">)</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Relic</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(GF(</span><span class="mtk9 mtki">p</span><span class="mtk1">), [</span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">])</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">None</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">None</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">PRNG</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk9 mtki">b</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">setupPoints</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">x</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">'Coordinate greater than curve modulus'</span>

<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">E</span><span class="mtk1">.lift_x(Integer(</span><span class="mtk9 mtki">x</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">'Point not on curve'</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">'Point confirmed on curve'</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">nextPoints</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk1">enc_seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1">.</span><span class="mtk8">rotate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">*=</span><span class="mtk1"> </span><span class="mtk1">seed</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">*=</span><span class="mtk1"> </span><span class="mtk1">enc_seed</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">'New Points'</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Options:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'1. Setup Point'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'2. Receive new point'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'3. Find true point'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'&gt; '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">option</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">artifact</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Relic</span><span class="mtk1">(p, a, b)</span>
<span class="mtk1">    </span><span class="mtk1">setup</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Enter x coordinate'</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'x: '</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">setupPoints</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'Point confirmed on curve'</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">setup</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">setup</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">nextPoints</span><span class="mtk1">()</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Response'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">((</span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]))</span>
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Configure origin point first'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'3'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">setup</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Input x,y'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'x: '</span><span class="mtk1">))</span>
<span class="mtk1">                    </span><span class="mtk1">Py</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'y: '</span><span class="mtk1">))</span>
<span class="mtk1">                    </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">nextPoints</span><span class="mtk1">()</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">4</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">Py</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk8">print</span><span class="mtk1">(</span>
<span class="mtk1">                            </span><span class="mtk4">'You have confirmed the location. It</span><span class="mtk6">\'</span><span class="mtk4">s dangerous however to go alone. Take this: '</span><span class="mtk1">,</span>
<span class="mtk1">                            </span><span class="mtk6">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'The vessels will never be found...'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Configure origin point first'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Invalid option, sutting down"</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">Exception</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'An error occured: </span><span class="mtk6">{</span><span class="mtk1">e</span><span class="mtk6">}</span><span class="mtk4">'</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> p.bit_length() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">256</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>The server uses Elliptic Curve Cryptography (ECC) with secret parameters (<code>p</code>, <code>a</code>, <code>b</code>). It also uses a custom pseudo-random number generator (PRNG) with the same unknown parameters and a certain formula.</p><h2 id="ecc-background">ECC background</h2><p>Elliptic Curve Cryptography is a public-key cryptosystem, so there is a public key and a private key.</p><p>Let $E$ be an elliptic curve defined in Weierstrass form as:</p><p class="scroll">$$
E: \; y^2 = x^3 + ax + b
$$</p><p>Where $(x, y)$ are points within the curve.</p><p>In ECC, the above elliptic curve is considered under a finite field (for example, $\mathbb{F}_p$, with $p$ a prime number). Hence, the curve can be renamed as $E(\mathbb{F}_p)$.</p><p>As a result, the points in the curve form an abelian group under addition:</p><ul><li>The operation is internal (i.e. $P + Q \in E(\mathbb{F}_p) \; \forall P, Q \in E(\mathbb{F}_p)$)</li><li>There is a unique identity element usually called $O$, such that $P + O = O + P = P$. This is also known as &ldquo;point at infinity&rdquo;</li><li>Every point has a unique inverse point, that is $\exists! Q \in E(\mathbb{F}_p) \;|\; P + Q = O \;\; \forall P \in E(\mathbb{F}_p)$. We can also say that $Q = -P$ abusing additive notation</li><li>The operation is associative (and also commutative)</li></ul><p>The addition operation has a certain algorithm, which is implemented in the above source code. Once the addition is defined, we can express the product of a point by a scalar like this:</p><p class="scroll">$$
kP = \underbrace{P + \dots + P}_{k\; \text{times}}
$$</p><p>In order to use ECC, we must take a generator point $G$ of the curve, then take a number $n$ and multiply $n$ by $G$. The public key is formed by the points $G$ and $nG$ (apart from the curve parameters $a$, $b$ and the finite field $\mathbb{F}_p$); and the private key is the number $n$.</p><p>ECC can be used for Diffie-Hellman key exchange protocol (ECDH), Digital Signature Algorithm (ECDSA) or encryption (ECIES), among others. This cryptosystem relies on the difficulty to solve the Elliptic Curve Discrete Logarithm Problem (ECDLP), that is, find $n$ given $G$ and $nG$.</p><h2 id="finding-curve-parameters">Finding curve parameters</h2><p>In option <code>1</code>, we are allowed to enter a number $x$ and the server will try to give us the corresponding $y$ so that the point $(x, y)$ belongs to the curve:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Enter x coordinate'</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'x: '</span><span class="mtk1">))</span>
<span class="mtk1">                </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">setupPoints</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'Point confirmed on curve'</span><span class="mtk1">:</span>  
<span class="mtk1">                    </span><span class="mtk1">setup</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">response</span><span class="mtk1">)</span>
</code></pre></div><p>However, let&rsquo;s take a look at method <code>setupPoints</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">setupPoints</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">x</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">x</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">'Coordinate greater than curve modulus'</span>

<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">E</span><span class="mtk1">.lift_x(Integer(</span><span class="mtk9 mtki">x</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">'Point not on curve'</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">'Point confirmed on curve'</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>  
</code></pre></div><p>Here we have an oracle to find $p$ using binary search, because we can test values of $x$ and approximate to $p$ depending on the response (<code>'Coordinate greater than curve modulus'</code> vs. other message). This is the code to find $p$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">left</span><span class="mtk1">, </span><span class="mtk1">right</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span>
<span class="mtk1">    </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">left</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">right</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">left</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">right</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">left</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">right</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span>

<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'x: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Coordinate greater than curve modulus'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">:</span>  
<span class="mtk1">            </span><span class="mtk1">right</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">left</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Got modulus </span><span class="mtk6">{</span><span class="mtk1">p</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Then we can find $a$ and $b$ by taking two random points of the curve (options <code>1</code> or <code>2</code>). The process is the same as in <a href="../elliptic-labyrinth">Elliptic Labyrinth</a>: solve a system of two modular equations on variables $a$ and $b$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">points</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">    </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">points</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'x: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Point confirmed on curve'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">data</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">point</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">tuple</span><span class="mtk1">(</span>
<span class="mtk1">                </span><span class="mtk8 mtku">map</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">')'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">).</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">', '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">:]))</span>  
<span class="mtk1">            </span><span class="mtk1">points</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">point</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    (</span><span class="mtk1">x1</span><span class="mtk1">, </span><span class="mtk1">y1</span><span class="mtk1">), (</span><span class="mtk1">x2</span><span class="mtk1">, </span><span class="mtk1">y2</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">points</span>
<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">y1</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">y2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">x1</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">x2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">x1</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">x2</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">p</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">p</span>
<span class="mtk1">    </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">y1</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">x1</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">x1</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">p</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Got parameters </span><span class="mtk6">{</span><span class="mtk1">a</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4"> and </span><span class="mtk6">{</span><span class="mtk1">b</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><h2 id="understanding-the-challenge">Understanding the challenge</h2><p>Now that we have recovered the curve parameters, let&rsquo;s review the challenge again to see how we must capture the flag.</p><p>In option <code>3</code>, we must provide the coordinates of a point <code>P</code> correctly to see the flag (we only have one chance):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'3'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">setup</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Input x,y'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'x: '</span><span class="mtk1">))</span>
<span class="mtk1">                    </span><span class="mtk1">Py</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'y: '</span><span class="mtk1">))</span>
<span class="mtk1">                    </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">nextPoints</span><span class="mtk1">()</span>
<span class="mtk1">                    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">4</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">Py</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk8">print</span><span class="mtk1">(</span>
<span class="mtk1">                            </span><span class="mtk4">'You have confirmed the location. It</span><span class="mtk6">\'</span><span class="mtk4">s dangerous however to go alone. Take this: '</span><span class="mtk1">,</span>  
<span class="mtk1">                            </span><span class="mtk6">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'The vessels will never be found...'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Configure origin point first'</span><span class="mtk1">)</span>
</code></pre></div><p>This point <code>P</code> comes from the last two entries of <code>response</code>, which is a tuple returned by <code>nextPoints</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">nextPoints</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk1">enc_seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1">.</span><span class="mtk8">rotate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">*=</span><span class="mtk1"> </span><span class="mtk1">seed</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">*=</span><span class="mtk1"> </span><span class="mtk1">enc_seed</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">'New Points'</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">EP</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>  
</code></pre></div><p>Using option <code>2</code> we are given the point <code>EP</code>, whose coordinates are in positions <code>1</code> and <code>2</code> of the tuple returned by <code>nextPoints</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">setup</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">response</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">artifact</span><span class="mtk1">.</span><span class="mtk8">nextPoints</span><span class="mtk1">()</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Response'</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">((</span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk1">response</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]))</span>  
<span class="mtk1">                </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Configure origin point first'</span><span class="mtk1">)</span>
</code></pre></div><p>Notice that we can control the value of <code>P</code> and <code>EP</code> in <code>setupPoints</code>, but we don&rsquo;t know the values of <code>seed</code> and <code>enc_seed</code>. So, given that we know point $\mathrm{EP}$ and $\mathrm{enc\_seed} \cdot \mathrm{EP}$, we must somehow find $\mathrm{enc\_seed}$, that is, solve the ECDLP.</p><h2 id="smarts-attack">Smart&rsquo;s attack</h2><p>The key to solve the ECDLP is that the curve&rsquo;s order is prime (actually, $|E(\mathbb{F}_p)| = p$). So we have an anomalous curve, which might be vulnerable to Smart&rsquo;s attack to solve the ECDLP easily.</p><p>Smart&rsquo;s attack is a complex method that requires knowledge on algebraic number theory, Hensel&rsquo;s Lemma and $p$-adic numbers. For more information, read these resources (I found them useful to understand the attack from a high-level perspective):</p><ul><li><a href="https://link.springer.com/content/pdf/10.1007/s001459900052.pdf">The Discrete Logarithm Problem on Elliptic Curves of Trace One</a></li><li><a href="https://wstein.org/edu/2010/414/projects/novotney.pdf">Weak Curves In Elliptic Curve Cryptography</a></li><li><a href="http://elliptic.group/curious_curves/Anomalous_curves_updated.pdf">Characterization of Smart-proof curves</a></li><li><a href="https://brilliant.org/wiki/hensels-lemma/">Hensel&rsquo;s Lemma</a></li><li><a href="https://en.wikipedia.org/wiki/P-adic_number">$p$-adic number</a></li></ul><p>I found an implementation of Smart&rsquo;s attack in SageMath in <a href="https://blog.cryptohack.org/cryptoctf2021-hard#ecchimera">this write-up from a CryptoHack challenge</a>. Using this implementation, we can find <code>enc_seed</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">x2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'x: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">x2</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(GF(</span><span class="mtk1">p</span><span class="mtk1">), [</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">.gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'x: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(EP[</span><span class="mtk6">0</span><span class="mtk1">]).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">point</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">tuple</span><span class="mtk1">(</span>
        <span class="mtk8 mtku">map</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">')'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">).</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">', '</span><span class="mtk1">)[</span><span class="mtk6">1</span><span class="mtk1">:]))</span>  
<span class="mtk1">    </span><span class="mtk1">enc_seed_EP</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">point</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">], </span><span class="mtk1">point</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">    </span><span class="mtk1">enc_seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">SmartAttack</span><span class="mtk1">(</span><span class="mtk1">EP</span><span class="mtk1">, </span><span class="mtk1">enc_seed_EP</span><span class="mtk1">, </span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Smart Attack -&gt; </span><span class="mtk6">{</span><span class="mtk1">enc_seed</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><h2 id="analyzing-the-prng">Analyzing the PRNG</h2><p>Alright, so we have <code>enc_seed</code>. Let&rsquo;s take a look at the class <code>PRNG</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">PRNG</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">mul1</span><span class="mtk1">, </span><span class="mtk9 mtki">mul2</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">60897882583250395019290734183554677148448130569594</span><span class="mtk6">43481824909430411674443639248386564763122373451773</span><span class="mtk6">38158266041105992233408699669643665700905532400804</span><span class="mtk6">1039</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">exp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">mul1</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">mul2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">inc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">.</span><span class="mtk8">from_bytes</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Coordinates lost in space'</span><span class="mtk1">, </span><span class="mtk4">'big'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> randint(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rotate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul1</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mul2</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">+</span>
<span class="mtk1">                     </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">inc</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">exp</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">mod</span><span class="mtk1">)</span>
</code></pre></div><p>We can express the <code>rotate</code> method using mathematical terms (notice that the class is instantiated as <code>self.prng = PRNG(p, a, b)</code> in class <code>Relic</code>):</p><p class="scroll">$$
s_{j + 1} = a s_j^3 + b s_j + i \mod{p q}
$$</p><p>Then, $\mathrm{enc\_seed} = s_{j + 1}^2 \mod{p q}$. Curiously, the formula looks like another eliptic curve.</p><p>The pseudo-random numbers $s_j$ are considered $\mod{p q}$. However, when multiplying these numbers by a point of the elliptic curve, they will be reduced to $\mod{p}$, since the curve is defined over $\mathbb{F}_p$. Hence, the PRNG formula can be considered just $\mod{p}$.</p><p>Since we know $\mathrm{enc\_seed}$ from Smart&rsquo;s attack, we can compute the square root $\mod{p}$ (not $\mod{p q}$ because of the previous fact). Once having the seed $s_{j + 1}$, we will be able to find $s_{j + 2}$ applying the formula and predict the output of <code>nextPoints</code>, so that we can find the flag. This is the implementation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(GF(</span><span class="mtk1">p</span><span class="mtk1">)(</span><span class="mtk1">enc_seed</span><span class="mtk1">).nth_root(</span><span class="mtk6">2</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">.</span><span class="mtk8">from_bytes</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Coordinates lost in space'</span><span class="mtk1">, </span><span class="mtk4">'big'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">next_seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">p</span>

<span class="mtk1">    </span><span class="mtk1">curr_P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">EP</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">seed</span>
<span class="mtk1">    </span><span class="mtk1">next_P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">curr_P</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">next_seed</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Trying next point </span><span class="mtk6">{</span><span class="mtk1">next_P</span><span class="mtk6">}</span><span class="mtk4">...'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'x: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">next_P</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">next_P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><h2 id="flag">Flag</h2><p>If we run the script, we will see the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 209.97.134.50:31201
[<span class="code-green">+</span>] Opening connection to 209.97.134.50 on port 31201: Done
[<span class="code-blue">*</span>] Got modulus p = 91720173941422125335466921700213991383508377854521057423162397714341988797837
[<span class="code-blue">*</span>] Got parameters a = 57186237363769678415558546920636910250184560730836527033755705455333464722170 and b = 47572366756434660406002599832623767973471965640106574131304711893212728437629
[<span class="code-blue">*</span>] Smart Attack -&gt; enc_seed = 1574017221831123415886137346110982781503978446261518027146689940530621647822
[<span class="code-blue">*</span>] Trying next point (49394339834628750389338231331407606443777974829314059591423185069522974190491 : 36805735502973307035372435592237049388682732097929498134528467141686272904173 : 1)...  
[<span class="code-green">+</span>] You have confirmed the location. It's dangerous however to go alone. Take this:  HTB{0Racl3_AS_a_f3A7Ur3_0n_W3aK_CURV3_aND_PRN9??_7H3_s3cur17Y_0F_0uR_CRyP70Sys73M_w1LL_c0LLAp53!!!}
[<span class="code-blue">*</span>] Closed connection to 209.97.134.50 port 31201
</code></pre></div><p>The full script can be found in here: <a href="https://github.com/7Rocky/CTF-scripts/blob/main/HTB%20Cyber%20Apocalypse/Crypto/Converging%20Visions/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#ecc-background">ECC background</a></li><li><a href="#finding-curve-parameters">Finding curve parameters</a></li><li><a href="#understanding-the-challenge">Understanding the challenge</a></li><li><a href="#smarts-attack">Smart&rsquo;s attack</a></li><li><a href="#analyzing-the-prng">Analyzing the PRNG</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>