<!doctype html><html lang="en"><head><title>Prime | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Balsn CTF 2023. AKS primality test. Carmichael numbers. Euler totient function"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Balsn CTF 2023. AKS primality test. Carmichael numbers. Euler totient function"><meta itemprop="keywords" content><meta itemprop="name" content="Prime"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Balsn CTF 2023. AKS primality test. Carmichael numbers. Euler totient function"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Prime"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/balsn-ctf/prime/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Balsn CTF 2023. AKS primality test. Carmichael numbers. Euler totient function"><meta name="twitter:description" content="Balsn CTF 2023. AKS primality test. Carmichael numbers. Euler totient function"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Prime"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/balsn-ctf/prime/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><script>alert("Buy me a beer plz")</script><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/balsn-ctf/prime/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- BALSN CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/balsn-ctf/prime/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/balsn-ctf/prime/&amp;text=Prime" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/balsn-ctf/prime/&amp;title=Prime" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Prime</h1><p class="mb4 f6 dib tracked">9 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#aks-primality-test">AKS primality test</a></li><li><a href="#the-implementation-mistake">The implementation mistake</a></li></ul></li><li><a href="#breaking-the-aks-implementation">Breaking the AKS implementation</a><ul><li><a href="#finding-carmichael-numbers">Finding Carmichael numbers</a></li></ul></li><li><a href="#solution">Solution</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given the source code of the server in SageMath:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">gmpy2</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secret</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">FLAG</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"prime: "</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"No mystiz trick"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">512</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Not in range"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">is_prime</span><span class="mtk1">(</span><span class="mtk1">n</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Not prime"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"factor: "</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"You got me"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"gg"</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">is_prime</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># check if n = a^b for some a, b &gt; 1</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">.bit_length()):</span>
<span class="mtk1">        </span><span class="mtk1">root</span><span class="mtk1">, </span><span class="mtk1">is_exact</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">gmpy2</span><span class="mtk1">.iroot(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">is_exact</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk1">    </span><span class="mtk1">rs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, </span><span class="mtk6">7</span><span class="mtk1">, </span><span class="mtk6">11</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">, </span><span class="mtk6">17</span><span class="mtk1">, </span><span class="mtk6">19</span><span class="mtk1">, </span><span class="mtk6">23</span><span class="mtk1">, </span><span class="mtk6">29</span><span class="mtk1">, </span><span class="mtk6">31</span><span class="mtk1">, </span><span class="mtk6">37</span><span class="mtk1">, </span><span class="mtk6">41</span><span class="mtk1">, </span><span class="mtk6">43</span><span class="mtk1">, </span><span class="mtk6">47</span><span class="mtk1">, </span><span class="mtk6">53</span><span class="mtk1">, </span><span class="mtk6">59</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">, </span><span class="mtk6">67</span><span class="mtk1">, </span><span class="mtk6">71</span><span class="mtk1">, </span><span class="mtk6">73</span><span class="mtk1">, </span><span class="mtk6">79</span><span class="mtk1">, </span><span class="mtk6">83</span><span class="mtk1">, </span><span class="mtk6">89</span><span class="mtk1">, </span><span class="mtk6">97</span><span class="mtk1">]</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk8">test</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk1">r</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">rs</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">test</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk9 mtki">r</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk4">"""</span>
<span class="mtk4">    check whether `(x + a) ^ n = x ^ n + a (mod x ^ r</span><span class="mtk4"> - 1)` in Z/nZ for some `a`.</span>
<span class="mtk4">    """</span>
<span class="mtk1">    R.</span><span class="mtk5">&lt;</span><span class="mtk1">x</span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Zmod(n)[]</span>
<span class="mtk1">    </span><span class="mtk1">S</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> R.quotient_ring(x </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk9 mtki">r</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">(x </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">) </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">(x </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">r</span><span class="mtk1">)) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>

<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"__main__"</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>The script implements the AKS primality test, and asks for a prime number that has a factor different than $1$ and the same number:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"prime: "</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"No mystiz trick"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1"> </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">512</span><span class="mtk1">:</span>  
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Not in range"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">is_prime</span><span class="mtk1">(</span><span class="mtk1">n</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Not prime"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"factor: "</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"You got me"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"gg"</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">is_prime</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># check if n = a^b for some a, b &gt; 1</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">.bit_length()):</span>
<span class="mtk1">        </span><span class="mtk1">root</span><span class="mtk1">, </span><span class="mtk1">is_exact</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">gmpy2</span><span class="mtk1">.iroot(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">is_exact</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
</code></pre></div><p>If so happens, the server will show the flag. But this is a contradiction, since a prime number is only divisible by $1$ and itself. Therefore, the objective of the challenge is to send a special composite number that is considered a prime number by the AKS primality test implementation. In short, we need to break this primality test.</p><h3 id="aks-primality-test">AKS primality test</h3><p>First of all, we need to do a bit of research on the AKS primality test. I found good information on these resources:</p><ul><li><a target="_blank" href="https://en.wikipedia.org/wiki/AKS_primality_test">Wikipedia</a></li><li><a target="_blank" href="https://annals.math.princeton.edu/wp-content/uploads/annals-v160-n2-p12.pdf">PRIMES is in P</a></li><li><a target="_blank" href="https://depts.washington.edu/uwmxl/wordpress/wp-content/uploads/2017/05/AKS_Final_Report.pdf">WXML Final Report: AKS Primality Test</a></li></ul><p>Basically, the test is built from Fermat&rsquo;s Little Theorem, where $a^p \equiv a \pmod{p}$. This holds for all prime numbers, but there are other special numbers that also satisfy the condition (Carmichael numbers, more on this later). To overcome this, the AKS test considers the $p$-th power of a mononial $X + a$, and it holds that</p><p class="scroll">$$
\begin{align}
(X + a)^p & = X^p + {p \choose 1} X^{p - 1} a + {p \choose 2} X^{p - 2} a^2 + \dots + {p \choose p - 1} X a^{p - 1} + a^p \\ & \equiv X^p + a^p \\ & \equiv X^p + a \pmod{p}
\end{align}
$$</p><p>Because $\displaystyle{p \choose i} \equiv 0 \pmod{p} \quad\forall\; i \in \{1, \dots, p - 1\}$. The above congruence holds true only for prime numbers. As a result, given a number $n$, the AKS test takes a monomial $X + a$ for some $a$ and computes $(X + a)^n$. Only if reducing modulo $n$ results in $X^n + a$, then $n$ is prime.</p><p>The AKS test uses also an irreducible polynomial to make computation more efficient, that is:</p><p class="scroll">$$
(X + a)^p \equiv X^p + a \pmod{X^r - 1, p}
$$</p><p>Applying modulo $X^r - 1$ does not change the result of the test, it only reduces the degree of $(X + a)^p$ on each iteration to be more efficient.</p><p>According to <a target="_blank" href="https://annals.math.princeton.edu/wp-content/uploads/annals-v160-n2-p12.pdf">PRIMES is in P</a>, these are the steps of the AKS algorithm:</p><blockquote><p>Input: integer $n > 1$.</p><ol><li>If $n = a^b$ for $a \in \mathbb{N}$ and $b > 1$, output COMPOSITE.</li><li>Find the smallest $r$ such that $\phi_r(n) > \log^2{n}$.</li><li>If $1 &lt; \gcd(a, n) &lt; n$ for some $a \leqslant r$, output COMPOSITE.</li><li>If $n \leqslant r$, output PRIME.</li><li>For $a = 1$ to $\lfloor\sqrt{\phi(r)} \log{n}\rfloor$ do
if $(X + a)^n = X^n + a \pmod{X^r − 1, n}$, output COMPOSITE;</li><li>Output PRIME.</li></ol></blockquote><h3 id="the-implementation-mistake">The implementation mistake</h3><p>We have seen that AKS test is deterministic, so how are we going to break it? Well, this is just a vulnerable implementation:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">is_prime</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># check if n = a^b for some a, b &gt; 1</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">.bit_length()):</span>
<span class="mtk1">        </span><span class="mtk1">root</span><span class="mtk1">, </span><span class="mtk1">is_exact</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">gmpy2</span><span class="mtk1">.iroot(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">is_exact</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk1">    </span><span class="mtk1">rs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk6">5</span><span class="mtk1">, </span><span class="mtk6">7</span><span class="mtk1">, </span><span class="mtk6">11</span><span class="mtk1">, </span><span class="mtk6">13</span><span class="mtk1">, </span><span class="mtk6">17</span><span class="mtk1">, </span><span class="mtk6">19</span><span class="mtk1">, </span><span class="mtk6">23</span><span class="mtk1">, </span><span class="mtk6">29</span><span class="mtk1">, </span><span class="mtk6">31</span><span class="mtk1">, </span><span class="mtk6">37</span><span class="mtk1">, </span><span class="mtk6">41</span><span class="mtk1">, </span><span class="mtk6">43</span><span class="mtk1">, </span><span class="mtk6">47</span><span class="mtk1">, </span><span class="mtk6">53</span><span class="mtk1">, </span><span class="mtk6">59</span><span class="mtk1">, </span><span class="mtk6">61</span><span class="mtk1">, </span><span class="mtk6">67</span><span class="mtk1">, </span><span class="mtk6">71</span><span class="mtk1">, </span><span class="mtk6">73</span><span class="mtk1">, </span><span class="mtk6">79</span><span class="mtk1">, </span><span class="mtk6">83</span><span class="mtk1">, </span><span class="mtk6">89</span><span class="mtk1">, </span><span class="mtk6">97</span><span class="mtk1">]</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">(</span><span class="mtk8">test</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk1">r</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">rs</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">test</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">, </span><span class="mtk9 mtki">r</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk4">"""</span>
<span class="mtk4">    check whether `(x + a) ^ n = x ^ n + a (mod x ^ r</span><span class="mtk4"> - 1)` in Z/nZ for some `a`.</span>
<span class="mtk4">    """</span>
<span class="mtk1">    R.</span><span class="mtk5">&lt;</span><span class="mtk1">x</span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Zmod(n)[]</span>
<span class="mtk1">    </span><span class="mtk1">S</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> R.quotient_ring(x </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk9 mtki">r</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">(x </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">) </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">(x </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk9 mtki">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">r</span><span class="mtk1">)) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>
</code></pre></div><p>There are two things in this implementation that differ from the algorithm:</p><ul><li>The SageMath script tests several $r$ values (all prime numbers lower than $100$), whereas the AKS algorithm suggests looking for a specific value of $r$ (step 2)</li><li>The SageMath script takes a random $a \in [1, 256]$ for the test, whereas the AKS algorithm iterates from $a = 1$ to $a = \lfloor\sqrt{\phi(r)} \log{n}\rfloor$ (step 5)</li></ul><h2 id="breaking-the-aks-implementation">Breaking the AKS implementation</h2><p>It is not clear what can happen if $a$ or $r$ are not correctly chosen, or how dangerous it is for the test to fail.</p><p>After researching on how to break primality tests, we can find <a target="_blank" href="https://en.wikipedia.org/wiki/Carmichael_number">Carmichael numbers</a>. These are composite numbers that satisfy Fermat&rsquo;s Little Theorem. In other words, $n$ is a Carmichael number if $n$ is composite and $b^n \equiv b \pmod{n}$ for all integers $b$ that are coprime with $n$.</p><p>Let&rsquo;s try it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sage</span> -q
<span class="code-dark-blue">sage:</span> <span class="sage-green">import</span> <span class="sage-magenta">gmpy2</span>
<span class="code-dark-blue">....:</span> <span class="sage-green">import</span> <span class="sage-magenta">random</span>
<span class="code-dark-blue">sage:</span>
<span class="code-dark-blue">sage:</span> <span class="sage-green">def</span> <span class="sage-turkish">test</span>(n, r):
<span class="code-dark-blue">....: </span>    <span class="sage-red bg-white">"""</span>
<span class="code-dark-blue">....:</span> <span class="sage-red bg-white">    check whether `(x + a) ^ n = x ^ n + a (mod x ^ r - 1)` in Z/nZ for some `a`.</span>  
<span class="code-dark-blue">....:</span> <span class="sage-red bg-white">    """</span>
<span class="code-dark-blue">....: </span>    R.&lt;x&gt; = Zmod(n)[]
<span class="code-dark-blue">....: </span>    S = R.quotient_ring(x ^ r - <span class="sage-blue">1</span>)
<span class="code-dark-blue">....:</span>
<span class="code-dark-blue">....: </span>    a = <span class="sage-blue">1</span> + random.getrandbits(<span class="sage-blue">8</span>)
<span class="code-dark-blue">....: </span>    <span class="sage-green">if</span> S(x + a) ^ n != S(x ^ (n % r)) + a:
<span class="code-dark-blue">....: </span>        <span class="sage-green">return</span> <span class="sage-green">False</span>
<span class="code-dark-blue">....: </span>    <span class="sage-green">return</span> <span class="sage-green">True</span>
<span class="code-dark-blue">....:</span>
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">561</span>, <span class="sage-blue">2</span>)
True
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">561</span>, <span class="sage-blue">3</span>)
False
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">561</span>, <span class="sage-blue">4</span>)
False
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">561</span>, <span class="sage-blue">5</span>)
False
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">1105</span>, <span class="sage-blue">2</span>)
True
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">1105</span>, <span class="sage-blue">3</span>)
False
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">1729</span>, <span class="sage-blue">2</span>)
True
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">1729</span>, <span class="sage-blue">3</span>)
True
<span class="code-dark-blue">sage: </span>test(<span class="sage-blue">1729</span>, <span class="sage-blue">5</span>)
False
</code></pre></div><h3 id="finding-carmichael-numbers">Finding Carmichael numbers</h3><p>Some Carmichael numbers output <code>True</code>, we might be on the right track. There is a way to generate some Carmichael numbers: If $6k + 1$ and $12k + 1$ and $18k + 1$ are prime numbers for some integer $k$, then $n = (6k + 1) (12k + 1) (18k + 1)$ is a Carmichael number. Let&rsquo;s generate a bunch of them:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from Crypto.Util.number import isPrime
&gt;&gt;&gt;
&gt;&gt;&gt; for k in range(1000):
...     if isPrime(6 * k + 1) and isPrime(12 * k + 1) and isPrime(18 * k + 1):  
...         print(k, (6 * k + 1) * (12 * k + 1) * (18 * k + 1))
...
1 1729
6 294409
35 56052361
45 118901521
51 172947529
55 216821881
56 228842209
100 1299963601
121 2301745249
195 9624742921
206 11346205609
216 13079177569
255 21515221081
276 27278026129
370 65700513721
380 71171308081
426 100264053529
506 168003672409
510 172018713961
511 173032371289
710 464052305161
741 527519713969
800 663805468801
825 727993807201
871 856666552249
930 1042789205881
975 1201586232601
</code></pre></div><p>Let&rsquo;s try the last one with all $r$ values of the implementation:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-blue">sage: </span>rs = [<span class="sage-blue">2</span>, <span class="sage-blue">3</span>, <span class="sage-blue">5</span>, <span class="sage-blue">7</span>, <span class="sage-blue">11</span>, <span class="sage-blue">13</span>, <span class="sage-blue">17</span>, <span class="sage-blue">19</span>, <span class="sage-blue">23</span>, <span class="sage-blue">29</span>, <span class="sage-blue">31</span>, <span class="sage-blue">37</span>, <span class="sage-blue">41</span>, <span class="sage-blue">43</span>, <span class="sage-blue">47</span>, <span class="sage-blue">53</span>, <span class="sage-blue">59</span>, <span class="sage-blue">61</span>, <span class="sage-blue">67</span>, <span class="sage-blue">71</span>, <span class="sage-blue">73</span>, <span class="sage-blue">79</span>, <span class="sage-blue">83</span>, <span class="sage-blue">89</span>, <span class="sage-blue">97</span>]  
<span class="code-dark-blue">sage: </span>[(r, test(<span class="sage-blue">1201586232601</span>, r)) <span class="sage-green">for</span> r <span class="sage-green">in</span> rs]
[(2, True),
 (3, True),
 (5, True),
 (7, False),
 (11, False),
 (13, True),
 (17, False),
 (19, False),
 (23, False),
 (29, False),
 (31, False),
 (37, False),
 (41, False),
 (43, False),
 (47, False),
 (53, False),
 (59, False),
 (61, False),
 (67, False),
 (71, False),
 (73, False),
 (79, False),
 (83, False),
 (89, False),
 (97, False)]
</code></pre></div><p>As can be seen, for $r \in \{2, 3, 5, 13\}$, the test fails. Now we need to figure out why.</p><p>After a lot of tests with bigger Carmichael numbers, I found out that the test fails when $r$ divides $\phi(n)$. Since $n = (6k + 1) (12k + 1) (18k + 1)$ and the three factors are prime numbers, then $\phi(n) = (6k)(12k)(18k) = 2^4 \cdot 3^4 \cdot k^3$.</p><p>In the previous example, $n = 1201586232601$ is the Carmichael number with $k = 975 = 3 \cdot 5^2 \cdot 13$, so $\phi(n) = 2^4 \cdot 3^7 \cdot 5^6 \cdot 13^3$, which is divisible by every $r \in \{2, 3, 5, 13\}$.</p><h2 id="solution">Solution</h2><p>So, we need a number $n$ such that $\phi(n) = 2^4 \cdot 3^4 \cdot k^3$ is divisible by all prime numbers less than $100$. This can be easily achieved by setting $k_0 = 5 \cdot 7 \cdots 97$ and then $k = m \cdot k_0$ for some integer $m$. As a result, since $k_0$ is divisible by every $r$ in the AKS implementation, so will be $k$ and we will break the test.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; from math import prod
&gt;&gt;&gt;
&gt;&gt;&gt; rs = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97]
&gt;&gt;&gt; k_0 = prod(rs[2:])
&gt;&gt;&gt; k_0
384261327324253070792183691221959345
&gt;&gt;&gt;
&gt;&gt;&gt; m = 1
&gt;&gt;&gt; while True:
...     k = m * k_0
...     m += 1
...     if isPrime(6 * k + 1) and isPrime(12 * k + 1) and isPrime(18 * k + 1):
...         print(k, (6 * k + 1) * (12 * k + 1) * (18 * k + 1))
...         break
...
141792429782649383122315782060902998305 3694572010169851255631956434046586025725603891058582291439147359413655694039141973775417050450842378469305302694178881  
</code></pre></div><p>There we have one candidate, and it breaks the test:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-blue">sage: </span>[(r, test(<span class="sage-blue">3694572010169851255631956434046586025725603891058582291439147359413655694039141973775417050450842378469305302694178881</span>, r)) <span class="sage-green">for</span> r <span class="sage-green">in</span> rs]  
[(2, True),
 (3, True),
 (5, True),
 (7, True),
 (11, True),
 (13, True),
 (17, True),
 (19, True),
 (23, True),
 (29, True),
 (31, True),
 (37, True),
 (41, True),
 (43, True),
 (47, True),
 (53, True),
 (59, True),
 (61, True),
 (67, True),
 (71, True),
 (73, True),
 (79, True),
 (83, True),
 (89, True),
 (97, True)]
</code></pre></div><h2 id="flag">Flag</h2><p>Now that we have a Carmichael number that breaks the test and the corresponding $k$ value, we must enter the number and a factor (for instance, $6k + 1$) to get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> prime.balsnctf.com 10003
prime: 3694572010169851255631956434046586025725603891058582291439147359413655694039141973775417050450842378469305302694178881  
factor: 850754578695896298733894692365417989831
You got me
BALSN{th3_imp1_15_bR0k3n_4nd_mUch_sL0W3r_tH4n_pycrypto_is_prime_qwq}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#aks-primality-test">AKS primality test</a></li><li><a href="#the-implementation-mistake">The implementation mistake</a></li></ul></li><li><a href="#breaking-the-aks-implementation">Breaking the AKS implementation</a><ul><li><a href="#finding-carmichael-numbers">Finding Carmichael numbers</a></li></ul></li><li><a href="#solution">Solution</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>