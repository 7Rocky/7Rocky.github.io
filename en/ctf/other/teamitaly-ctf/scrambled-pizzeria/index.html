<!doctype html><html lang="en"><head><title>Scrambled Pizzeria | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="TeamItaly CTF 2023. XOR. Permutations and substitutions"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="TeamItaly CTF 2023. XOR. Permutations and substitutions"><meta itemprop="keywords" content><meta itemprop="name" content="Scrambled Pizzeria"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="TeamItaly CTF 2023. XOR. Permutations and substitutions"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Scrambled Pizzeria"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/teamitaly-ctf/scrambled-pizzeria/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="TeamItaly CTF 2023. XOR. Permutations and substitutions"><meta name="twitter:description" content="TeamItaly CTF 2023. XOR. Permutations and substitutions"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Scrambled Pizzeria"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/teamitaly-ctf/scrambled-pizzeria/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/teamitaly-ctf/scrambled-pizzeria/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- TEAMITALY CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/teamitaly-ctf/scrambled-pizzeria/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/teamitaly-ctf/scrambled-pizzeria/&amp;text=Scrambled%20Pizzeria" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/teamitaly-ctf/scrambled-pizzeria/&amp;title=Scrambled%20Pizzeria" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Scrambled Pizzeria</h1><p class="mb4 f6 dib tracked">6 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#cipher-analysis">Cipher analysis</a></li></ul></li><li><a href="#solution">Solution</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given the source code of the server in Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">numpy</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">numpy</span><span class="mtk1">.</span><span class="mtk8 mtku">typing</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">npt</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">PIL</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Image</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk9 mtki">img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">], </span><span class="mtk9 mtki">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">]</span>
<span class="mtk1">) -&gt; </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">height</span><span class="mtk1">, </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">img</span><span class="mtk1">.</span><span class="mtk1">shape</span>
<span class="mtk1">    </span><span class="mtk1">cm</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">c</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">arange</span><span class="mtk1">(</span><span class="mtk8">max</span><span class="mtk1">(</span><span class="mtk1">height</span><span class="mtk1">, </span><span class="mtk1">width</span><span class="mtk1">)) </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk7">len</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">)]</span>
<span class="mtk1">    </span><span class="mtk1">rows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">argsort</span><span class="mtk1">(</span><span class="mtk1">cm</span><span class="mtk1">[:</span><span class="mtk1">height</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">cols</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">argsort</span><span class="mtk1">(</span><span class="mtk1">cm</span><span class="mtk1">[:</span><span class="mtk1">width</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">img</span><span class="mtk1">[</span><span class="mtk1">rows</span><span class="mtk1">, :][:, </span><span class="mtk1">cols</span><span class="mtk1">]</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk9 mtki">con</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">], </span><span class="mtk9 mtki">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">]</span>
<span class="mtk1">) -&gt; </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">ids</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">arange</span><span class="mtk1">(</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">prod</span><span class="mtk1">(</span><span class="mtk9 mtki">con</span><span class="mtk1">.</span><span class="mtk1">shape</span><span class="mtk1">)) </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk7">len</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">con</span><span class="mtk1"> </span><span class="mtk7">^</span><span class="mtk1"> (</span><span class="mtk9 mtki">c</span><span class="mtk1"> </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">).</span><span class="mtk8">astype</span><span class="mtk1">(</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">)[</span><span class="mtk1">ids</span><span class="mtk1">].</span><span class="mtk8">reshape</span><span class="mtk1">(</span><span class="mtk9 mtki">con</span><span class="mtk1">.</span><span class="mtk1">shape</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">frombuffer</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">), </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk4">"Hi, I'm here to take your order! Can you give me </span><span class="mtk4">an image of the type of pizza you want me to cook?</span><span class="mtk4">"</span>  
<span class="mtk1">    )</span>
<span class="mtk1">    </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"What's the height of the image? "</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"What's the width of the image? "</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">img_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"Now send me the image and I'll do the rest!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">height</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">width</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">400</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">400</span>

<span class="mtk1">        </span><span class="mtk1">img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">array</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Image</span><span class="mtk1">.</span><span class="mtk8">frombytes</span><span class="mtk1">(</span><span class="mtk4">"L"</span><span class="mtk1">, (</span><span class="mtk1">width</span><span class="mtk1">, </span><span class="mtk1">height</span><span class="mtk1">), </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">img_hex</span><span class="mtk1">))</span>
<span class="mtk1">        )</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Uh oh! You're trying to trick me? Out of my pizze</span><span class="mtk4">ria!"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">con</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span><span class="mtk1">img</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span><span class="mtk1">con</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Oh mamma mia! I've scrambled all of your ingredie</span><span class="mtk4">nts, look!"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">.</span><span class="mtk8">tobytes</span><span class="mtk1">().</span><span class="mtk8">hex</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk1">flag_img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">array</span><span class="mtk1">(</span><span class="mtk8 mtku">Image</span><span class="mtk1">.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"flag.jpg"</span><span class="mtk1">).</span><span class="mtk8">convert</span><span class="mtk1">(</span><span class="mtk4">"L"</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">flag_con</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span><span class="mtk1">flag_img</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">flag_enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span><span class="mtk1">flag_con</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"What a disaster! To make it up to me, here's a gi</span><span class="mtk4">ft..."</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">flag_enc</span><span class="mtk1">.</span><span class="mtk8">tobytes</span><span class="mtk1">().</span><span class="mtk8">hex</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"My job here is done!"</span><span class="mtk1">)</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"__main__"</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>The flag is stored inside a JPEG image called <code>flag.jpg</code> and it is encrypted using some XOR based cipher. We are allowed to enter an image as a matrix that will be encrypted with a random key. Then, the server will give us the corresponding ciphertext and also the ciphertext for <code>flag.jpg</code> encrypted with the same key.</p><p>Therefore, we must somehow find how our input image is being encrypted to guess the plaintext bytes of <code>flag.jpg</code>.</p><h2 id="source-code-analysis">Source code analysis</h2><p>First, the server defines the random encryption key as a $400 \times 8$ bytes array:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">frombuffer</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">), </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">)</span>  
</code></pre></div><p>Then, the server takes our image from hexadecimal data:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span>
<span class="mtk1">        </span><span class="mtk4">"Hi, I'm here to take your order! Can you give me </span><span class="mtk4">an image of the type of pizza you want me to cook?</span><span class="mtk4">"</span>  
<span class="mtk1">    )</span>
<span class="mtk1">    </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"What's the height of the image? "</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"What's the width of the image? "</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">img_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"Now send me the image and I'll do the rest!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">height</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">width</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">height</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">400</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">400</span>

<span class="mtk1">        </span><span class="mtk1">img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">array</span><span class="mtk1">(</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Image</span><span class="mtk1">.</span><span class="mtk8">frombytes</span><span class="mtk1">(</span><span class="mtk4">"L"</span><span class="mtk1">, (</span><span class="mtk1">width</span><span class="mtk1">, </span><span class="mtk1">height</span><span class="mtk1">), </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk1">img_hex</span><span class="mtk1">))</span>
<span class="mtk1">        )</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Uh oh! You're trying to trick me? Out of my pizze</span><span class="mtk4">ria!"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">()</span>
</code></pre></div><p>After that, our image is encrypted and given to us:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">con</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span><span class="mtk1">img</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span><span class="mtk1">con</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Oh mamma mia! I've scrambled all of your ingredie</span><span class="mtk4">nts, look!"</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">enc</span><span class="mtk1">.</span><span class="mtk8">tobytes</span><span class="mtk1">().</span><span class="mtk8">hex</span><span class="mtk1">())</span>
</code></pre></div><p>Then, the server loads <code>flag.jpg</code> and encrypts it with the same key <code>c</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">flag_img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">array</span><span class="mtk1">(</span><span class="mtk8 mtku">Image</span><span class="mtk1">.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"flag.jpg"</span><span class="mtk1">).</span><span class="mtk8">convert</span><span class="mtk1">(</span><span class="mtk4">"L"</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk1">flag_con</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span><span class="mtk1">flag_img</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">flag_enc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span><span class="mtk1">flag_con</span><span class="mtk1">, </span><span class="mtk1">c</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"What a disaster! To make it up to me, here's a gi</span><span class="mtk4">ft..."</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">flag_enc</span><span class="mtk1">.</span><span class="mtk8">tobytes</span><span class="mtk1">().</span><span class="mtk8">hex</span><span class="mtk1">())</span>
</code></pre></div><h3 id="cipher-analysis">Cipher analysis</h3><p>The cipher is composed of two functions: <code>permutation</code> and <code>substitution</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">permutation</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk9 mtki">img</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">], </span><span class="mtk9 mtki">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">]</span>
<span class="mtk1">) -&gt; </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">height</span><span class="mtk1">, </span><span class="mtk1">width</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">img</span><span class="mtk1">.</span><span class="mtk1">shape</span>
<span class="mtk1">    </span><span class="mtk1">cm</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">c</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">arange</span><span class="mtk1">(</span><span class="mtk8">max</span><span class="mtk1">(</span><span class="mtk1">height</span><span class="mtk1">, </span><span class="mtk1">width</span><span class="mtk1">)) </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk7">len</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">)]</span>
<span class="mtk1">    </span><span class="mtk1">rows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">argsort</span><span class="mtk1">(</span><span class="mtk1">cm</span><span class="mtk1">[:</span><span class="mtk1">height</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">cols</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">argsort</span><span class="mtk1">(</span><span class="mtk1">cm</span><span class="mtk1">[:</span><span class="mtk1">width</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">img</span><span class="mtk1">[</span><span class="mtk1">rows</span><span class="mtk1">, :][:, </span><span class="mtk1">cols</span><span class="mtk1">]</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">substitution</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk9 mtki">con</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">], </span><span class="mtk9 mtki">c</span><span class="mtk1">: </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint64</span><span class="mtk1">]</span>
<span class="mtk1">) -&gt; </span><span class="mtk8 mtku">npt</span><span class="mtk1">.</span><span class="mtk1">NDArray</span><span class="mtk1">[</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">ids</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">arange</span><span class="mtk1">(</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">prod</span><span class="mtk1">(</span><span class="mtk9 mtki">con</span><span class="mtk1">.</span><span class="mtk1">shape</span><span class="mtk1">)) </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk7">len</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">con</span><span class="mtk1"> </span><span class="mtk7">^</span><span class="mtk1"> (</span><span class="mtk9 mtki">c</span><span class="mtk1"> </span><span class="mtk7">%</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">).</span><span class="mtk8">astype</span><span class="mtk1">(</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk1">uint8</span><span class="mtk1">)[</span><span class="mtk1">ids</span><span class="mtk1">].</span><span class="mtk8">reshape</span><span class="mtk1">(</span><span class="mtk9 mtki">con</span><span class="mtk1">.</span><span class="mtk1">shape</span><span class="mtk1">)</span>  
</code></pre></div><p>From now on, let&rsquo;s assume all images are $400 \times 400$ matrices with 8-bit integer entries.</p><p>In <code>permutation</code>, the server takes the encryption matrix <code>c</code> and computes <code>cm</code> by limiting to the maximum rows or columns of the image matrix (nothing changes if we use $400 \times 400$ matrices).</p><p>Then, the <code>rows</code> variable is the list indices of <code>cm</code> if they were sorted:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; help(np.argsort)
<span>Help on _ArrayFunctionDispatcher in module numpy:</span>  

<span class="code-py-orange">argsort(a, axis=-1, kind=None, order=None)</span>
<span>    Returns the indices that would sort an array.
</code></pre></div><p>Notice that <code>cols</code> is the exact same thing as <code>rows</code>. Then, the result is <code>img[rows, :][:, cols]</code>.</p><p>For <code>substitution</code>, the server just uses element-wise XOR with the values of <code>c</code> modulo 256 (8 bits).</p><h2 id="solution">Solution</h2><p>One clear thing is that: if we send a null matrix, the output will contain the values of <code>c</code> modulo 256 because of XOR properties. Moreover, the XOR operation is applied by columns. We can easily test this:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; c: npt.NDArray[np.uint64] = np.frombuffer(os.urandom(3 * 8), np.uint64)
&gt;&gt;&gt; img: npt.NDArray[np.uint8] = np.array([[1, 2, 3], [4, 5, 6], [7, 8, 9]])  
&gt;&gt;&gt; permutation(img, c)
array([[5, 4, 6],
       [2, 1, 3],
       [8, 7, 9]])
&gt;&gt;&gt; substitution(permutation(img, c), c)
array([[214, 252,  82],
       [209, 249,  87],
       [219, 255,  93]])
&gt;&gt;&gt;
&gt;&gt;&gt; img: npt.NDArray[np.uint8] = np.array([[0, 0, 0], [0, 0, 0], [0, 0, 0]])
&gt;&gt;&gt; permutation(img, c)
array([[0, 0, 0],
       [0, 0, 0],
       [0, 0, 0]])
&gt;&gt;&gt; substitution(permutation(img, c), c)
array([[211, 248,  84],
       [211, 248,  84],
       [211, 248,  84]])
</code></pre></div><p>Therefore, taking into account that the plaintext <code>flag.jpg</code> is always the same, we can plan this strategy:</p><ul><li>We will send a matrix that contains all zeros but for 200 values from <code>1</code> to <code>200</code> in the upper half part of the first column</li><li>The server will permute these non-zero values and then apply XOR by columns</li><li>We can easily determine the XOR key of every column since there are exactly 200 null plaintext values, so there will be exactly 200 key values in the ciphertext columns. Using those, we can decrypt the full matrix and find out a mapping between the plaintext non-zero values and their ciphertext position</li><li>Having found this mapping, we can take the encrypted <code>flag.jpeg</code>, decrypt its columns with the corresponding XOR key and finally permute the pixels we know from the mapping</li><li>Then, we do the same process with the lower half part of the first column</li><li>And then we repeat the process until we complete all 400 columns</li></ul><p>Let&rsquo;s illustrate it with a $6 \times 6$ matrix:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; img = np.zeros([6, 6], np.uint8)
&gt;&gt;&gt; img[:3, 0] = np.array([1, 2, 3])
&gt;&gt;&gt; img
array([[1, 0, 0, 0, 0, 0],
       [2, 0, 0, 0, 0, 0],
       [3, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 0, 0]], dtype=uint8)
&gt;&gt;&gt; enc = substitution(permutation(img, c), c)  
&gt;&gt;&gt; enc
array([[184, 227,  77, 167, 165,  86],
       [184, 227,  77, 167, 166,  86],
       [184, 227,  77, 167, 165,  86],
       [184, 227,  77, 167, 165,  86],
       [184, 227,  77, 167, 164,  86],
       [184, 227,  77, 167, 167,  86]], dtype=uint8)
&gt;&gt;&gt; k = np.array([184, 227, 77, 167, 165, 86])
&gt;&gt;&gt; enc ^ k
array([[0, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 3, 0],
       [0, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 0, 0],
       [0, 0, 0, 0, 1, 0],
       [0, 0, 0, 0, 2, 0]])
</code></pre></div><p>Now we could see that <code>1 (0, 0)</code> -> <code>1 (4, 4)</code>, <code>2 (1, 0)</code> -> <code>2 (5, 4)</code> and <code>3 (2, 0)</code> -> <code>3 (1, 4)</code> and we would apply the inverse mapping to the encrypted <code>flag.jpg</code> image and the same XOR key. This XOR key can be obtained automatically using <code>Counter</code> in Python:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; from collections import Counter
&gt;&gt;&gt; k = np.array([Counter(enc[:, i]).most_common(1)[0][0] for i in range(6)])  
&gt;&gt;&gt; k
array([184, 227, 77, 167, 165, 86], dtype=uint8)
</code></pre></div><p>Therefore, we onlye need ro implement the above procedure in Python and start querying the server.</p><h2 id="flag">Flag</h2><p>Once we run the script, we will get the flag inside the JPEG image:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve_scrambled_pizzeria.py</span>  
[<span class="code-blue">|</span>] Row/Col: 1/399
</code></pre></div><p>The full script can be found in here: <a href="https://github.com/7Rocky/CTF-scripts/tree/main/TeamItaly%20CTF/Scrambled%20Pizzeria/solve.py"><code>solve.py</code></a>.</p><p><img src="/images/other/TeamItaly-pizzeria.jpg" alt="Scrambled Pizzeria 1"></p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#cipher-analysis">Cipher analysis</a></li></ul></li><li><a href="#solution">Solution</a></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>