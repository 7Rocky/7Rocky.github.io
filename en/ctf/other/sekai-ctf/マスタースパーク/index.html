<!doctype html><html lang="en"><head><title>„Éû„Çπ„Çø„Éº„Çπ„Éë„Éº„ÇØ | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Sekai CTF 2024. Isogeny-based cryptography. CSIDH. Discrete logarithm. CRT"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Sekai CTF 2024. Isogeny-based cryptography. CSIDH. Discrete logarithm. CRT"><meta itemprop="keywords" content><meta itemprop="name" content="„Éû„Çπ„Çø„Éº„Çπ„Éë„Éº„ÇØ"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Sekai CTF 2024. Isogeny-based cryptography. CSIDH. Discrete logarithm. CRT"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="„Éû„Çπ„Çø„Éº„Çπ„Éë„Éº„ÇØ"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Sekai CTF 2024. Isogeny-based cryptography. CSIDH. Discrete logarithm. CRT"><meta name="twitter:description" content="Sekai CTF 2024. Isogeny-based cryptography. CSIDH. Discrete logarithm. CRT"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="„Éû„Çπ„Çø„Éº„Çπ„Éë„Éº„ÇØ"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- SEKAI CTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/&amp;text=%e3%83%9e%e3%82%b9%e3%82%bf%e3%83%bc%e3%82%b9%e3%83%91%e3%83%bc%e3%82%af" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/sekai-ctf/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/&amp;title=%e3%83%9e%e3%82%b9%e3%82%bf%e3%83%bc%e3%82%b9%e3%83%91%e3%83%bc%e3%82%af" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">„Éû„Çπ„Çø„Éº„Çπ„Éë„Éº„ÇØ</h1><p class="mb4 f6 dib tracked">11 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#csidh">CSIDH</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#isogenies">Isogenies</a></li><li><a href="#discrete-logarithm">Discrete logarithm</a></li><li><a href="#prime-generation">Prime generation</a></li><li><a href="#crt">CRT</a></li><li><a href="#implementation">Implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a SageMath script called <code>challenge.sage</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">timeout_decorator</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">timeout</span><span class="mtk1">, </span><span class="mtk8 mtku">TimeoutError</span>

<span class="mtk1">load(</span><span class="mtk4">"GA.sage"</span><span class="mtk1">)</span>

<span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">getenv</span><span class="mtk1">(</span><span class="mtk4">"FLAG"</span><span class="mtk1">)</span>
<span class="mtk1">secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">)</span>
<span class="mtk1">choice</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">set</span><span class="mtk1">()</span>


<span class="mtk8">@</span><span class="mtk8">timeout</span><span class="mtk1">(</span><span class="mtk6">60</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">T_T</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">3</span>

<span class="mtk1">    </span><span class="mtk1">Fp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    Fp2.</span><span class="mtk5">&lt;</span><span class="mtk1">j</span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1">  GF(p </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">modulus</span><span class="mtk5">=</span><span class="mtk1">x </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">ls</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(factor(</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">2</span>

<span class="mtk1">    </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ceil((sqrt(</span><span class="mtk9 mtki">p</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk1">ls</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">alice_priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [randrange(</span><span class="mtk5">-</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">))]</span>
<span class="mtk1">    </span><span class="mtk1">bob_priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [randrange(</span><span class="mtk5">-</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">))]</span>
<span class="mtk1">    </span><span class="mtk1">EC</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> montgomery(Fp2, </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">EC</span><span class="mtk1">.gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_bob</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Q</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_alice</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.bit_length() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">96</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> ((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">prime_list</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">    </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> factor((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">choice</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">            </span><span class="mtk1">choice</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">prime_list</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">choice</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">([</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">prime_list</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">prime_list</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"input your prime number or secret &gt; "</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">secret</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"not flag T_T"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">prime_list</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">T_T</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">prime_list</span><span class="mtk1">, </span><span class="mtk1">secret</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">P</span><span class="mtk1">.xy())</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">Q</span><span class="mtk1">.xy())</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"T_T"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Moreover, we have <code>GA.sage</code> with some functions used by the main script:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">randint</span>

<span class="mtk3"># I received advice from Mitsu to write this progr</span><span class="mtk3">am. I appreciate it very much</span>  

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">A</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> EllipticCurve(</span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, [</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk9 mtki">A</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">])</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">to_montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">E</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">Ep</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">E</span><span class="mtk1">.change_ring(</span><span class="mtk9 mtki">Fp</span><span class="mtk1">).short_weierstrass_model()</span>
<span class="mtk1">    </span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Ep</span><span class="mtk1">.a4(), </span><span class="mtk1">Ep</span><span class="mtk1">.a6()</span>
<span class="mtk1">    P.</span><span class="mtk5">&lt;</span><span class="mtk1">x</span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PolynomialRing(Fp)</span>
<span class="mtk1">    </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (x</span><span class="mtk5">^</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk5">*</span><span class="mtk1">x </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1">).roots()[</span><span class="mtk6">0</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> sqrt(</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk5">^</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> is_square(</span><span class="mtk1">s</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">s</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk1">s</span>
<span class="mtk1">    </span><span class="mtk1">phi</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">E</span><span class="mtk1">.isomorphism_to(EllipticCurve(</span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, [</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">A</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">]))</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">Fp</span><span class="mtk1">(</span><span class="mtk1">A</span><span class="mtk1">), </span><span class="mtk1">phi</span><span class="mtk1">(</span><span class="mtk9 mtki">G</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">group_action</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">, </span><span class="mtk9 mtki">priv</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">es</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span><span class="mtk1">[:]</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">any</span><span class="mtk1">(</span><span class="mtk1">es</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">Fp</span><span class="mtk1">.random_element()</span>
<span class="mtk1">        </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">.lift_x(</span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">Fp</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span>
<span class="mtk1">        </span><span class="mtk1">S</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk1">es</span><span class="mtk1">) </span><span class="mtk5">if</span><span class="mtk1"> sign(</span><span class="mtk1">e</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> prod([</span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">])</span>
<span class="mtk1">        </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">k</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">P</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Q</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">R</span><span class="mtk1">.is_zero():</span>
<span class="mtk1">                </span><span class="mtk5">continue</span>
<span class="mtk1">            </span><span class="mtk1">phi</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">.isogeny(</span><span class="mtk1">R</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">phi</span><span class="mtk1">.codomain()</span>
<span class="mtk1">            </span><span class="mtk1">Q</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">phi</span><span class="mtk1">(</span><span class="mtk1">Q</span><span class="mtk1">), </span><span class="mtk1">phi</span><span class="mtk1">(</span><span class="mtk9 mtki">G</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">es</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk1">s</span>
<span class="mtk1">            </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">//=</span><span class="mtk1"> </span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">to_montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk1">E</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1">)</span>
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>In this challenge, we are allowed to enter prime numbers, with some properties, that will be used for a key exchange protocol:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"input your prime number or secret &gt; "</span><span class="mtk1">))</span>  
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">secret</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"not flag T_T"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">prime_list</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">T_T</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk1">prime_list</span><span class="mtk1">, </span><span class="mtk1">secret</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">P</span><span class="mtk1">.xy())</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">Q</span><span class="mtk1">.xy())</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"T_T"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">()</span>
</code></pre></div><p>The key exchange protocol is implemented in <code>T_T</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">@</span><span class="mtk8">timeout</span><span class="mtk1">(</span><span class="mtk6">60</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">T_T</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">):</span>

<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">3</span>

<span class="mtk1">    </span><span class="mtk1">Fp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    Fp2.</span><span class="mtk5">&lt;</span><span class="mtk1">j</span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1">  GF(p </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">modulus</span><span class="mtk5">=</span><span class="mtk1">x </span><span class="mtk5">^</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">ls</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(factor(</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">2</span>

<span class="mtk1">    </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ceil((sqrt(</span><span class="mtk9 mtki">p</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> (</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk1">ls</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">/</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">alice_priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [randrange(</span><span class="mtk5">-</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">))]</span>
<span class="mtk1">    </span><span class="mtk1">bob_priv</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [randrange(</span><span class="mtk5">-</span><span class="mtk1">m</span><span class="mtk1">, </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">))]</span>
<span class="mtk1">    </span><span class="mtk1">EC</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> montgomery(Fp2, </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">EC</span><span class="mtk1">.gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_bob</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Q</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_alice</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span>
</code></pre></div><h3 id="csidh">CSIDH</h3><p>As can be seen, it defines an elliptic curve over $\mathbb{F}_{p^2}$. Specifically, this is a supersingular elliptic curve. Then, the key exchange protocol is based on group actions. Therefore, this is a CSIDH protocol. In fact, the <code>group_action</code> function is the same CSIDH uses:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">group_action</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">, </span><span class="mtk9 mtki">priv</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk9 mtki">pub</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">es</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">priv</span><span class="mtk1">[:]</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">any</span><span class="mtk1">(</span><span class="mtk1">es</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">Fp</span><span class="mtk1">.random_element()</span>
<span class="mtk1">        </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">.lift_x(</span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">Fp</span><span class="mtk1"> </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span>
<span class="mtk1">        </span><span class="mtk1">S</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk1">es</span><span class="mtk1">) </span><span class="mtk5">if</span><span class="mtk1"> sign(</span><span class="mtk1">e</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">]</span>  
<span class="mtk1">        </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> prod([</span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">])</span>
<span class="mtk1">        </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">k</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">P</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">S</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">R</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Q</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">R</span><span class="mtk1">.is_zero():</span>
<span class="mtk1">                </span><span class="mtk5">continue</span>
<span class="mtk1">            </span><span class="mtk1">phi</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">.isogeny(</span><span class="mtk1">R</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">phi</span><span class="mtk1">.codomain()</span>
<span class="mtk1">            </span><span class="mtk1">Q</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">phi</span><span class="mtk1">(</span><span class="mtk1">Q</span><span class="mtk1">), </span><span class="mtk1">phi</span><span class="mtk1">(</span><span class="mtk9 mtki">G</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">es</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">] </span><span class="mtk5">-=</span><span class="mtk1"> </span><span class="mtk1">s</span>
<span class="mtk1">            </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">//=</span><span class="mtk1"> </span><span class="mtk9 mtki">primes</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">to_montgomery</span><span class="mtk1">(</span><span class="mtk9 mtki">Fp</span><span class="mtk1">, </span><span class="mtk9 mtki">Fp2</span><span class="mtk1">, </span><span class="mtk1">E</span><span class="mtk1">, </span><span class="mtk9 mtki">G</span><span class="mtk1">)</span>
</code></pre></div><p>To learn more about isogeny-based cryptography, I definitely recommend <a target="_blank" href="https://cryptohack.org/challenges/isogenies/">CryptoHack</a>.</p><p>In brief, Alice&rsquo;s private key is a list of random integers between $-m$ and $m$. The CSIDH protocol uses this list to walk from a base elliptic curve $E_0$ to another elliptic curve $E_a$ by computing several isogenies. Bob does the same with his private key to walk from $E_0$ to $E_b$. The public keys are the Montgomery coefficient of the elliptic curves $E_a$ and $E_b$. Then, Alice can use her private key to walk from $E_b$ to $E_{ba}$, whereas Bob uses his private key to walk from $E_a$ to $E_{ab}$. Both end elliptic curves are the same, so the shared secret is the Montgomery coefficient of the curves.</p><p>I have left a lot of concepts to explain about CSIDH and isogenies, but we don&rsquo;t need to have them to solve this challenge. Just keep in mind that an isogeny is a homomorphism between two supersingular elliptic curves.</p><h2 id="solution">Solution</h2><p>If we take a closer look at <code>T_T</code>, we see that the actual CSIDH public values from Alice and Bob are not returned from the function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">EC</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> montgomery(Fp2, </span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">EC</span><span class="mtk1">.gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">k</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_bob</span><span class="mtk1">, </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">alice_pub</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">Q</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">bob_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">share_alice</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> group_action(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk1">Fp</span><span class="mtk1">, Fp2, </span><span class="mtk1">bob_pub</span><span class="mtk1">, </span><span class="mtk1">alice_priv</span><span class="mtk1">, </span><span class="mtk1">P</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">P</span><span class="mtk1">, </span><span class="mtk1">Q</span>
</code></pre></div><p>Instead, we are given two points $P$ and $Q$ that are transformed by the isogenies. Let&rsquo;s define the isogenies:</p><p class="scroll">$$
\phi_a: E_0 \to E_a \qquad \phi_b: E_0 \to E_b
$$</p><h3 id="isogenies">Isogenies</h3><p>Following the key exchange protocol, the above lines of SageMath code can be expressed in math terms as:</p><p class="scroll">$$
\begin{split}
{}^{(1)} \quad & Q \leftarrow \phi_a(k \cdot P) \\
{}^{(2)} \quad & Q \leftarrow \phi_b(\mathrm{secret} \cdot Q) \\ \\
{}^{(3)} \quad & P \leftarrow \phi_b(P) \\
{}^{(4)} \quad & P \leftarrow \phi_a(P) \\
\end{split}
$$</p><ul><li>In ${}^{(1)}$, we know that $k = 1$ and that $P$ is a generator of $E_0$; therefore, $Q \in E_a$</li><li>In ${}^{(2)}$, since $Q \in E_a$, then $\mathrm{secret} \cdot Q \in E_a$ as well. Then, after applying $\phi_b$, we get $Q \in E_{ab}$</li><li>In ${}^{(3)}$, we know $P \in E_0$, so when applying $\phi_b$, we get $P \in E_b$</li><li>In ${}^{(4)}$, we know $P \in E_b$, so when applying $\phi_a$, we get $P \in E_{ab}$</li></ul><p>So, in the end, the points $P$ and $Q$ that are given to us belong to $E_{ab}$. As a result, we are able to compute the parameters of the curve equation. Specifically, we can use a single point to get the Montgomery coefficient $A$:</p><p class="scroll">$$
P_\mathrm{y}^2 = P_\mathrm{x}^3 + A P_\mathrm{x}^2 + P_\mathrm{x} \iff A = (P_\mathrm{y}^2 - P_\mathrm{x}^3 - P_\mathrm{x}) \cdot (P_\mathrm{x}^2)^{-1}
$$</p><p>Therefore, we can define $E_{ab}$. Now, we are interested in finding $\mathrm{secret}$, which is a value we need ti know in order to get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">getenv</span><span class="mtk1">(</span><span class="mtk4">"FLAG"</span><span class="mtk1">)</span>
<span class="mtk1">secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">)</span>

<span class="mtk3"># ...</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"input your prime number or secret &gt; "</span><span class="mtk1">))</span>  
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">secret</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8">exit</span><span class="mtk1">()</span>
</code></pre></div><p>Notice that the $Q$ we have from the <code>T_T</code> function is related to the initial $P$ point (the generator of $E_0$), let&rsquo;s actually label it as $P_G$:</p><p class="scroll">$$
Q = \phi_b(\mathrm{secret} \cdot \phi_a(k \cdot P_G))
$$</p><p>Since $\phi_a$ and $\phi_b$ are isogenies (group homomorphisms), point addition is preserved (and also multiplication by scalar), so</p><p class="scroll">$$
\begin{split}
Q & = \phi_b(\mathrm{secret} \cdot \phi_a(k \cdot P_G)) \\
& = \phi_b(\mathrm{secret} \cdot k \cdot \phi_a(P_G)) \\
& = (\mathrm{secret} \cdot k) \cdot \phi_b(\phi_a(P_G)) \\
\end{split}
$$</p><p>Further, since $k = 1$ we can simplify it to $Q = \mathrm{secret} \cdot \phi_b(\phi_a(P_G))$.</p><p>Then, notice that the $P$ returned by <code>T_T</code> is just $P = \phi_a(\phi_b(P_G))$. It looks similar to the previous $Q$ expression, but the order of the isogenies is reversed. However, we are talking about CSIDH, where the &ldquo;C&rdquo; stands for commutative, so $\phi_a(\phi_b(P_G)) = \phi_b(\phi_a(P_G))$.</p><h3 id="discrete-logarithm">Discrete logarithm</h3><p>As a result, we have:</p><p class="scroll">$$
\begin{cases}
P = \phi_a(\phi_b(P_G)) \\
Q = \mathrm{secret} \cdot \phi_b(\phi_a(P_G))
\end{cases} \quad \Longrightarrow Q = \mathrm{secret} \cdot P
$$</p><p>So, the challenge to solving a discrete logarithm over $E_{ab}$! This one is easy to solve because the curve is supersingular, so the order of the curve is smooth (it has many small factors). An algorithm like Pohlig-Hellman will find the solution pretty quickly.</p><h3 id="prime-generation">Prime generation</h3><p>We have skipped one part of the challenge, that has to do with the primes we can send to the server:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.bit_length() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">96</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> ((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">    </span><span class="mtk1">prime_list</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">    </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> factor((</span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">choice</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>
<span class="mtk1">            </span><span class="mtk1">choice</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">prime_list</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">choice</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">all</span><span class="mtk1">([</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">&lt;=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">prime_list</span><span class="mtk1">])</span>  
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">cnt</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">prime_list</span>
</code></pre></div><p>As can be seen, the primes must be $p &lt; 2^{96}$ and also $\frac{p + 1}{4} \mod{2} = 1$. This means that</p><p class="scroll">$$
\frac{p + 1}{4} = 2 \cdot n + 1 \iff p + 1 = 8 n + 4 \iff p = 8n + 3
$$</p><p>Then, the server takes the prime factors of $\frac{p + 1}{4}$ and adds them to a set called <code>choice</code>. For prime factors that appear more than once (exponent greater than $1$), che counter <code>cnt</code> is increased and the prime factor must be less than $2^{32}$. On the other hand, it the prime factor appears once, it is appended to <code>prime_list</code>. At the end, the function checks that all primes in <code>prime_list</code> are less than $2^{16}$ and that <code>cnt</code> equals <code>1</code>.</p><p>So, we see that the prime $p$ must have the following structure (a bit more restrictive than before):</p><p class="scroll">$$
p = 4 \cdot q_1 \cdot q_2 \cdots q_l \cdot r^e - 1
$$</p><p>Where all $q_i$ and $r$ are odd prime numbers and $e$ is some exponent greater than $1$, so that</p><p>$$
\frac{p + 1}{4} = q_1 \cdot q_2 \cdots q_l \cdot r^e \equiv 1 \pmod{2}
$$</p><p>Notice also that $l > 3$, because it is verified in <code>T_T</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">@</span><span class="mtk8">timeout</span><span class="mtk1">(</span><span class="mtk6">60</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">T_T</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">primes</span><span class="mtk1">, </span><span class="mtk9 mtki">secret</span><span class="mtk1">):</span>  

<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">primes</span><span class="mtk1">) </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">3</span>

<span class="mtk3">    # ...</span>
</code></pre></div><p>The way I generated this prime numbers is not so interesting, since I just used random prime numbers within the range we are allowed and checked if the prime factors were already in the <code>choice</code> set. I also used $l = 4$ and $e = 2$ for simplicity:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">gen_prime</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">global</span><span class="mtk1"> </span><span class="mtk1">choice</span>
<span class="mtk1">    </span><span class="mtk1">prev_choice</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">set</span><span class="mtk1">(</span><span class="mtk1">choice</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> prod(random_prime(</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">4</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> random_prime(</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">14</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span>  
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">check</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">p</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">AssertionError</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">choice</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">set</span><span class="mtk1">(</span><span class="mtk1">prev_choice</span><span class="mtk1">)</span>
</code></pre></div><h3 id="crt">CRT</h3><p>Finally, we are able to send a known prime and solve the discrete logarithm $Q = \mathrm{secret} \cdot P$ on the curve $E_{ab}$, which we can recover using one point.</p><p>However, $\mathrm{secret}$ is a 256-bit number, whereas the primes we are sending are at most 96-bit numbers. Therefore, we will need to solve several discrete logarithms using different primes. With all the intermediate results, we can use the CRT to join them all and find the $\mathrm{secret}$ value.</p><h3 id="implementation">Implementation</h3><p>First, we connect to the instance, define some constants, send a prime number and get the points $P$ and $Q$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">dlogs</span><span class="mtk1">, </span><span class="mtk1">mods</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [], []</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">gen_prime</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">Fp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Fp2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk9 mtki">modulus</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk9 mtki">names</span><span class="mtk5">=</span><span class="mtk4">'j'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Fp2</span><span class="mtk1">.gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'input your prime number or secret &gt; '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'('</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'*j + '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">', '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk1">Py</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'*j + '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">')'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'('</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Qx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'*j + '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">', '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">Qy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">j</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'*j + '</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">')'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><p>Now, we find the curve $E_{ab}$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">Py</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">Px</span><span class="mtk1">) </span><span class="mtk5">/</span><span class="mtk1"> (</span><span class="mtk1">Px</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Eab</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(</span><span class="mtk1">Fp2</span><span class="mtk1">, [</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk1">A</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">])</span>  

<span class="mtk1">    </span><span class="mtk1">P</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Eab</span><span class="mtk1">(</span><span class="mtk1">Px</span><span class="mtk1">, </span><span class="mtk1">Py</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">Eab</span><span class="mtk1">(</span><span class="mtk1">Qx</span><span class="mtk1">, </span><span class="mtk1">Qy</span><span class="mtk1">)</span>
</code></pre></div><p>After that, we can solve the discrete logarithm and append the result and the order to <code>dlogs</code> and <code>mods</code> for later use with the CRT:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">dlogs</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">Q</span><span class="mtk1">.log(</span><span class="mtk1">P</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk1">mods</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">P</span><span class="mtk1">.order())</span>
</code></pre></div><p>At this point, we can compute the CRT. Notice that we need to consider positive and negative values of the intermediate results:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">signs</span><span class="mtk1"> </span><span class="mtk7">in</span><span class="mtk1"> </span><span class="mtk8 mtku">product</span><span class="mtk1">((</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">), </span><span class="mtk9 mtki">repeat</span><span class="mtk5">=</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">dlogs</span><span class="mtk1">)):</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">secret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> crt([</span><span class="mtk1">s</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">s</span><span class="mtk1">, </span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">zip</span><span class="mtk1">(</span><span class="mtk1">signs</span><span class="mtk1">, </span><span class="mtk1">dlogs</span><span class="mtk1">)], </span><span class="mtk1">mods</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">secret</span><span class="mtk1">.bit_length() </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">continue</span>

<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Testing </span><span class="mtk6">{</span><span class="mtk1">secret</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'input your prime number or secret &gt; '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">secret</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">'not flag T_T'</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> (</span><span class="mtk1">msg</span><span class="mtk1"> </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.recvlineS()):</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">msg</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">break</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">ValueError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">pass</span>
</code></pre></div><p>I&rsquo;m not very sure why this is necessary, but I believe it is because $\phi_a(\phi_b(P))$ is not always the same as $\phi_b(\phi_a(P))$, just with a sign difference.</p><h2 id="flag">Flag</h2><p>If we run the script, we will get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> master-spark.chals.sekai.team 1337
[<span class="code-green">+</span>] Opening connection to master-spark.chals.sekai.team on port 1337: Done
[<span class="code-green">+</span>] Starting local process '/usr/bin/bash': pid 109
[<span class="code-blue">*</span>] Stopped process '/usr/bin/bash' (pid 109)
[<span class="code-blue">*</span>] Testing secret = 92697392149653184017438929759734443022953789135986999376605724801638735010341
[<span class="code-green">+</span>] SEKAI{(h0w_4b0u7_70uh0u_pr0j3c7??_OH_WAIT_Help_me,ERINNNNNNNNNNNN!!_https://youtu.be/X8z23t428kU?si=4ufTbouKxwQ6Lbhm}  
[<span class="code-blue">*</span>] Closed connection to master-spark.chals.sekai.team port 1337
</code></pre></div><p>The full script can be found in here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/Sekai%20CTF/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%82%AF/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#csidh">CSIDH</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#isogenies">Isogenies</a></li><li><a href="#discrete-logarithm">Discrete logarithm</a></li><li><a href="#prime-generation">Prime generation</a></li><li><a href="#crt">CRT</a></li><li><a href="#implementation">Implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>