<!doctype html><html lang="en"><head><title>Inside The Matrix | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Matrix operations. Chinese Remainder Theorem"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Matrix operations. Chinese Remainder Theorem"><meta itemprop="keywords" content><meta itemprop="name" content="Inside The Matrix"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Matrix operations. Chinese Remainder Theorem"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Inside The Matrix"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/crypto/inside-the-matrix/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Matrix operations. Chinese Remainder Theorem"><meta name="twitter:description" content="Matrix operations. Chinese Remainder Theorem"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Inside The Matrix"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/crypto/inside-the-matrix/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script>
<script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/crypto/inside-the-matrix/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/crypto/inside-the-matrix/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/inside-the-matrix/&amp;text=Inside%20The%20Matrix" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/inside-the-matrix/&amp;title=Inside%20The%20Matrix" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Inside The Matrix</h1><p class="mb4 f6 dib tracked">7 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#encryption-analysis">Encryption analysis</a></li><li><a href="#decryption">Decryption</a><ul><li><a href="#sagemath-implementation">SageMath implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given the source code of the server in Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">utils</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">ascii_print</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>
<span class="mtk5">from</span><span class="mtk1"> secret </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">FLAG</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">getPrime</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">matrix</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Matrix</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">sympy</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">randprime</span>

<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk6">FLAG</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">25</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Book</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">5</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">None</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pt</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">pt</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Matrix</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prime</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk1">, </span><span class="mtk9 mtki">pt</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk5">**</span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rotate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randprime</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk5">**</span><span class="mtk6">4</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk5">**</span><span class="mtk6">6</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">message</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">rotate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">message</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk9 mtki">message</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">ciphertext</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">message</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">key</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">ciphertext</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk1">M</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Options:</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"[L]ook at page"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"[T]urn page"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"[C]heat</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">option</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">book</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Book</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">ciphertext</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">book</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk6">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">page_number</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"L"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">ascii_print</span><span class="mtk1">(</span><span class="mtk1">ciphertext</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">, </span><span class="mtk1">page_number</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"T"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">ciphertext</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">book</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk6">FLAG</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">page_number</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">option</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"C"</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">\n{</span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">ciphertext</span><span class="mtk1">)</span><span class="mtk6">}\n{</span><span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">)</span><span class="mtk6">}\n</span><span class="mtk4">"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Invalid option!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">)</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"__main__"</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">main</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">Exception</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">e</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"An error occurred: </span><span class="mtk6">{</span><span class="mtk1">e</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>
</code></pre></div><p>There is another file called <code>matrix.py</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">numpy</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Matrix</span><span class="mtk1">:</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">rows</span><span class="mtk1">, </span><span class="mtk9 mtki">cols</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nrows</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">rows</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">ncols</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">cols</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">M</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">unflatten</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">).</span><span class="mtk8">tolist</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__mul__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">mat</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">dot</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">M</span><span class="mtk1">, </span><span class="mtk9 mtki">mat</span><span class="mtk1">.M) </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">).tolist()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unflatten</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8 mtku">ndarray</span><span class="mtk1">(</span><span class="mtk9 mtki">shape</span><span class="mtk5">=</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">nrows</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">ncols</span><span class="mtk1">), </span><span class="mtk9 mtki">dtype</span><span class="mtk5">=</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">buffer</span><span class="mtk5">=</span><span class="mtk8 mtku">np</span><span class="mtk1">.</span><span class="mtk8">array</span><span class="mtk1">([</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1">]))</span>  
</code></pre></div><p>Last, there is a file called <code>utils.py</code>, but it is not relevant to solve the challenge.</p><h2 id="encryption-analysis">Encryption analysis</h2><p>The server uses a custom function named <code>ascii_print</code> that is not available (option <code>L</code>), but the only thing that does is print numbers like if they were inside a book:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 138.68.153.165 32679
Options:

[L]ook at page
[T]urn page
[C]heat

&gt; L

          _________   _________
   ______/        1\ /       2 \_______
 /| --------------- |  --------------- |\
|| Ciphertext:--- - | Key:------------ |||  
|| ---------------- | ------  -------- |||
|| ---------- ----- | ---------------- |||
|| [54,27,58,9,13]- | [48,11,2,8,19]-- |||
|| [58,42,27,38,51] | [20,0,46,52,18]- |||
|| [53,55,59,59,2]- | [33,0,9,18,52]-- |||
|| [28,40,21,0,22]- | [58,56,17,18,55] |||
|| [57,49,21,34,36] | [28,35,13,36,43] |||
|| ---------------- | ------ ----- --- |||
|| --- - ---------- | ---------------- |||
||______________ _  |  ________________|||
L/______/---------\\_//W--------\_______\J
</code></pre></div><p>Not having this function is not a problem because we have option <code>C</code>, which prints just the relevant information:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Options:

[L]ook at page
[T]urn page
[C]heat

&gt; C

[[54, 27, 58, 9, 13], [58, 42, 27, 38, 51], [53, 55, 59, 59, 2], [28, 40, 21, 0, 22], [57, 49, 21, 34, 36]]  
[[48, 11, 2, 8, 19], [20, 0, 46, 52, 18], [33, 0, 9, 18, 52], [58, 56, 17, 18, 55], [28, 35, 13, 36, 43]]
</code></pre></div><p>To encrypt information, the server uses $5 \times 5$ matrices. Let $F$ be the flag in matrix form (there&rsquo;s a method called <code>parse</code> for that. Also, the flag contains exactly 25 bytes due to an assertion at the beginning):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pt</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">pt</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">pt</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Matrix</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prime</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk1">, </span><span class="mtk9 mtki">pt</span><span class="mtk1">)</span>  
</code></pre></div><p>The key is generated randomly on each encryption:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">size</span><span class="mtk5">**</span><span class="mtk6">2</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk1">key</span><span class="mtk1">)</span>
</code></pre></div><p>And the subsequent operations are performed modulo a prime number $p$, which is different on each encryption:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rotate</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randprime</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk5">**</span><span class="mtk6">4</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk5">**</span><span class="mtk6">6</span><span class="mtk1">)</span>  
</code></pre></div><p>This prime number satisfies $2^4 &lt; p &lt; 2^6$ (see <code>randprime</code> documentation in <code>sympy</code> for more information). Therefore, there are only a few possible prime numbers:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from sympy import randprime
&gt;&gt;&gt; { randprime(2 ** 4, 2 ** 6) for _ in range(100) }  
{37, 41, 43, 47, 17, 29, 19, 53, 23, 59, 61, 31}
</code></pre></div><p>The way to encrypt is the following:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">message</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">rotate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">message</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">parse</span><span class="mtk1">(</span><span class="mtk9 mtki">message</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">ciphertext</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">message</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">key</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">ciphertext</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk1">M</span>
</code></pre></div><p>So, in mathematical terms:</p><p class="scroll">$$
C = F \cdot K \mod{p}
$$</p><p>Where all matrices are $5 \times 5$.</p><h2 id="decryption">Decryption</h2><p>Notice that we are given both $C$ and $K$ as lists. Therefore, we can find $F$ multiplying $C$ by the inverse of $K$:</p><p class="scroll">$$
F = C \cdot K^{-1} \mod{p}
$$</p><p>Notice that we don&rsquo;t know the prime number $p$, but it is easy to spot since there are only a few possible primes and all matrix entries will be less than $p$. For instance, in the above lists, the prime number $p$ is likely to be $61$, since the biggest entries are $59$:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[[54, 27, 58, 9, 13], [58, 42, 27, 38, 51], [53, 55, 59, 59, 2], [28, 40, 21, 0, 22], [57, 49, 21, 34, 36]]  
[[48, 11, 2, 8, 19], [20, 0, 46, 52, 18], [33, 0, 9, 18, 52], [58, 56, 17, 18, 55], [28, 35, 13, 36, 43]]
</code></pre></div><p>Once we have $p$, we can find $F$ as told above. However, that matrix $F$ will be modulo $p$, and the flag characters are ASCII (8 bits, so modulo $256$).</p><p>But notice that the server is always encrypting the same flag, although using different keys and prime moduli. This is perfect to apply the Chinese Remainder Theorem (CRT). Considering only one character ($c_1$), we can build a system of congruences as follows:</p><p class="scroll">$$
\begin{cases}
c_1 \equiv f_1 \pmod{p_1} \newline
c_1 \equiv f_2 \pmod{p_2} \newline
\end{cases}
$$</p><p>Where $f_1$ and $f_2$ are the residues modulo $p_1$ and $p_2$ respectively of the top-left entry of matrix $F$ (in two different encryptions).</p><p>The CRT states that if $p_i$ are coprime (which are, because all $p_i$ are prime numbers), then the system of congruences has a solution $\mod{\prod p_i}$. Two pairs of samples is enough because all $p_i > 2^4$, so $p_i \cdot p_j > 2^4 \cdot 2^4 = 256$. Therefore, the solution $c_1$ of the CRT will be exactly the ASCII value of $c_1$.</p><h3 id="sagemath-implementation">SageMath implementation</h3><p>So, let&rsquo;s take two pairs of ciphertexts and keys to apply the above theory:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 138.68.153.165 32679
Options:

[L]ook at page
[T]urn page
[C]heat

&gt; C

[[17, 8, 6, 5, 3], [30, 33, 48, 33, 12], [58, 1, 55, 0, 26], [17, 0, 26, 54, 51], [25, 28, 5, 56, 7]]
[[15, 9, 14, 46, 48], [29, 35, 15, 11, 26], [57, 51, 15, 8, 0], [13, 24, 4, 13, 6], [17, 47, 40, 47, 11]]

Options:

[L]ook at page
[T]urn page
[C]heat

&gt; T

Options:

[L]ook at page
[T]urn page
[C]heat

&gt; C

[[22, 0, 18, 2, 35], [16, 1, 30, 10, 36], [29, 33, 10, 36, 1], [14, 22, 23, 20, 34], [27, 36, 19, 25, 28]]  
[[19, 21, 28, 35, 14], [4, 27, 18, 22, 7], [26, 7, 25, 6, 20], [32, 22, 0, 32, 30], [6, 31, 22, 30, 35]]
</code></pre></div><p>Alright. Looking at the numbers, it looks like $p_1 = 59$ and $p_2 = 37$. Then, we must find $F_1$ and $F_2$:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sage</span> -q
<span class="code-dark-blue">sage: </span>p1 = <span class="sage-blue">59</span>
<span class="code-dark-blue">sage: </span>p2 = <span class="sage-blue">37</span>
<span class="code-dark-blue">sage:</span>
<span class="code-dark-blue">sage: </span>C1 = matrix(GF(p1), [[<span class="sage-blue">17</span>, <span class="sage-blue">8</span>, <span class="sage-blue">6</span>, <span class="sage-blue">5</span>, <span class="sage-blue">3</span>], [<span class="sage-blue">30</span>, <span class="sage-blue">33</span>, <span class="sage-blue">48</span>, <span class="sage-blue">33</span>, <span class="sage-blue">12</span>], [<span class="sage-blue">58</span>, <span class="sage-blue">1</span>, <span class="sage-blue">55</span>, <span class="sage-blue">0</span>, <span class="sage-blue">26</span>], [<span class="sage-blue">17</span>, <span class="sage-blue">0</span>, <span class="sage-blue">26</span>, <span class="sage-blue">54</span>, <span class="sage-blue">51</span>], [<span class="sage-blue">25</span>, <span class="sage-blue">28</span>, <span class="sage-blue">5</span>, <span class="sage-blue">56</span>, <span class="sage-blue">7</span>]])
<span class="code-dark-blue">sage: </span>K1 = matrix(GF(p1), [[<span class="sage-blue">15</span>, <span class="sage-blue">9</span>, <span class="sage-blue">14</span>, <span class="sage-blue">46</span>, <span class="sage-blue">48</span>], [<span class="sage-blue">29</span>, <span class="sage-blue">35</span>, <span class="sage-blue">15</span>, <span class="sage-blue">11</span>, <span class="sage-blue">26</span>], [<span class="sage-blue">57</span>, <span class="sage-blue">51</span>, <span class="sage-blue">15</span>, <span class="sage-blue">8</span>, <span class="sage-blue">0</span>], [<span class="sage-blue">13</span>, <span class="sage-blue">24</span>, <span class="sage-blue">4</span>, <span class="sage-blue">13</span>, <span class="sage-blue">6</span>], [<span class="sage-blue">17</span>, <span class="sage-blue">47</span>, <span class="sage-blue">40</span>, <span class="sage-blue">47</span>, <span class="sage-blue">11</span>]])
<span class="code-dark-blue">sage:</span>
<span class="code-dark-blue">sage: </span>C2 = matrix(GF(p2), [[<span class="sage-blue">22</span>, <span class="sage-blue">0</span>, <span class="sage-blue">18</span>, <span class="sage-blue">2</span>, <span class="sage-blue">35</span>], [<span class="sage-blue">16</span>, <span class="sage-blue">1</span>, <span class="sage-blue">30</span>, <span class="sage-blue">10</span>, <span class="sage-blue">36</span>], [<span class="sage-blue">29</span>, <span class="sage-blue">33</span>, <span class="sage-blue">10</span>, <span class="sage-blue">36</span>, <span class="sage-blue">1</span>], [<span class="sage-blue">14</span>, <span class="sage-blue">22</span>, <span class="sage-blue">23</span>, <span class="sage-blue">20</span>, <span class="sage-blue">34</span>], [<span class="sage-blue">27</span>, <span class="sage-blue">36</span>, <span class="sage-blue">19</span>, <span class="sage-blue">25</span>, <span class="sage-blue">28</span>]])  
<span class="code-dark-blue">sage: </span>K2 = matrix(GF(p2), [[<span class="sage-blue">19</span>, <span class="sage-blue">21</span>, <span class="sage-blue">28</span>, <span class="sage-blue">35</span>, <span class="sage-blue">14</span>], [<span class="sage-blue">4</span>, <span class="sage-blue">27</span>, <span class="sage-blue">18</span>, <span class="sage-blue">22</span>, <span class="sage-blue">7</span>], [<span class="sage-blue">26</span>, <span class="sage-blue">7</span>, <span class="sage-blue">25</span>, <span class="sage-blue">6</span>, <span class="sage-blue">20</span>], [<span class="sage-blue">32</span>, <span class="sage-blue">22</span>, <span class="sage-blue">0</span>, <span class="sage-blue">32</span>, <span class="sage-blue">30</span>], [<span class="sage-blue">6</span>, <span class="sage-blue">31</span>, <span class="sage-blue">22</span>, <span class="sage-blue">30</span>, <span class="sage-blue">35</span>]])
<span class="code-dark-blue">sage:</span>
<span class="code-dark-blue">sage: </span>F1 = C1 * K1.inverse()
<span class="code-dark-blue">sage: </span>F2 = C2 * K2.inverse()
<span class="code-dark-blue">sage:</span>
<span class="code-dark-blue">sage: </span>F1
[13 25  7  5 48]
[58 57 36 48 43]
[36 36 36 36 57]
[45 51 36 50 52]
[57 55 46  2  7]
<span class="code-dark-blue">sage: </span>F2
[35 10 29 12 11]
[ 6  5 21 11 28]
[21 21 21 21  5]
[30 14 21 35 15]
[ 5  3 31  9 14]
</code></pre></div><p>Now it&rsquo;s time to apply the CRT to each pair of entries of the matrices:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="sage-blue">sage: </span>flag = []
<span class="sage-blue">sage: </span>
<span class="sage-blue">sage: </span><span class="sage-green">for</span> r1, r2 <span class="sage-green">in</span> <span class="sage-turkish">zip</span>(F1.rows(), F2.rows()):
<span class="sage-blue">....: </span>    <span class="sage-green">for</span> f1, f2 <span class="sage-green">in</span> <span class="sage-turkish">zip</span>(r1, r2):
<span class="sage-blue">....: </span>        flag.append(crt([<span class="sage-turkish">int</span>(f1), <span class="sage-turkish">int</span>(f2)], [p1, p2]) % <span class="sage-blue">256</span>)  
</code></pre></div><h2 id="flag">Flag</h2><p>And here&rsquo;s the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="sage-blue">sage: </span><span class="sage-turkish">bytes</span>(flag)
b'HTB{0ut_0f____th3_m4trix}'  
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#encryption-analysis">Encryption analysis</a></li><li><a href="#decryption">Decryption</a><ul><li><a href="#sagemath-implementation">SageMath implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>