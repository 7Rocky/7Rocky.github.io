<!doctype html><html lang="en"><head><title>Interception | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="RSA. GCD. Coppersmith method. Euler's Theorem"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="RSA. GCD. Coppersmith method. Euler's Theorem"><meta itemprop="keywords" content><meta itemprop="name" content="Interception"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="RSA. GCD. Coppersmith method. Euler's Theorem"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Interception"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/crypto/interception/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="RSA. GCD. Coppersmith method. Euler's Theorem"><meta name="twitter:description" content="RSA. GCD. Coppersmith method. Euler's Theorem"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Interception"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/crypto/interception/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><script>alert("Buy me a beer plz")</script><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/crypto/interception/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/crypto/interception/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/interception/&amp;text=Interception" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/interception/&amp;title=Interception" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Interception</h1><p class="mb4 f6 dib tracked">12 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#option-s">Option <code>S</code></a><ul><li><a href="#gcd">GCD</a></li></ul></li><li><a href="#option-f">Option <code>F</code></a><ul><li><a href="#coppersmith-method">Coppersmith method</a></li></ul></li><li><a href="#option-r">Option <code>R</code></a><ul><li><a href="#eulers-theorem">Euler&rsquo;s Theorem</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given the Python source code of the server. This is <code>server.py</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">signal</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">, </span><span class="mtk8 mtku">os</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">sha256</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">number</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">isPrime</span><span class="mtk1">, </span><span class="mtk8">getPrime</span><span class="mtk1">, </span><span class="mtk8">long_to_bytes</span><span class="mtk1">, </span><span class="mtk8">bytes_to_long</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Util</span><span class="mtk1">.</span><span class="mtk8 mtku">Padding</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">pad</span><span class="mtk1">, </span><span class="mtk8">unpad</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">Cipher</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pool</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">GREET</span><span class="mtk1">, </span><span class="mtk1">ANS</span>
<span class="mtk5">from</span><span class="mtk1"> secret </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk6">RESTRICTED</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">GRAS</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">q</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">deadbeef</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">q</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_key</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1337</span>
<span class="mtk1">        </span><span class="mtk3"># this loop runs in milliseconds in our super comp</span><span class="mtk3">uter</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">)[:</span><span class="mtk6">16</span><span class="mtk1">]</span>

<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">OumaraSystem</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">bits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">bits</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">LIMIT</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk5">//</span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk5">//</span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10001</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">GRAS</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.encode())</span>
<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span>
<span class="mtk1">        </span><span class="mtk1">enc_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">enc_msg</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt_plans</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">symmetric_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1">.</span><span class="mtk8">generate_key</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">symmetric_key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">enc_plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.encode(), </span><span class="mtk6">16</span><span class="mtk1">)) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk6">RESTRICTED</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">enc_plans</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">send_encrypted_message</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">c</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">c</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">c</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk1">m</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">()</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">False</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">reveal_internal_plans</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">encrypted_plans</span><span class="mtk1">, </span><span class="mtk9 mtki">key</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8">unpad</span><span class="mtk1">(</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">ep</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">ep</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">encrypted_plans</span><span class="mtk1">]</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">plans</span>
<span class="mtk1">        </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">hash_verified</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">h</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">h</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>
<span class="mtk1">    </span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_token</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">643</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> ((</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">) </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">) </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk1">d</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">show_banner</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'''</span>
<span class="mtk4">   ___                                    ____    </span><span class="mtk4">                          ____ _                  </span><span class="mtk4">          _ </span>
<span class="mtk4">  / _ \ _   _ _ __ ___   __ _ _ __ __ _  / ___|  _</span><span class="mtk4">__  ___ _   _ _ __ ___   / ___| |__   __ _ _ __  _</span><span class="mtk4"> __   ___| |</span>
<span class="mtk4"> | | | | | | | '_ ` _ \ / _` | '__/ _` | \___ \ / </span><span class="mtk4">_ \/ __| | | | '__/ _ \ | |   | '_ \ / _` | '_ \| </span><span class="mtk4">'_ \ / _ \ |</span>
<span class="mtk4"> | |_| | |_| | | | | | | (_| | | | (_| |  ___) |  </span><span class="mtk4">__/ (__| |_| | | |  __/ | |___| | | | (_| | | | | </span><span class="mtk4">| | |  __/ |</span>
<span class="mtk4">  \___/ \__,_|_| |_| |_|\__,_|_|  \__,_| |____/ \_</span><span class="mtk4">__|\___|\__,_|_|  \___|  \____|_| |_|\__,_|_| |_|_</span><span class="mtk4">| |_|\___|_|</span>
<span class="mtk4">'''</span><span class="mtk1">)</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'======================================='</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'||                                   ||'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'||   [S]end your encrypted message   ||'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'||   [R]eveal internal plans         ||'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'||   [F]orgot decryption key         ||'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'||                                   ||'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'======================================='</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'&gt; '</span><span class="mtk1">).</span><span class="mtk8">upper</span><span class="mtk1">()[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">print_plans</span><span class="mtk1">(</span><span class="mtk9 mtki">plans</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'==================== CLASSIFIED CONTENT! DO NOT S</span><span class="mtk4">HARE! ===================='</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1">, </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">enumerate</span><span class="mtk1">(</span><span class="mtk9 mtki">plans</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Plan </span><span class="mtk6">{</span><span class="mtk1">i</span><span class="mtk5">+</span><span class="mtk6">1}</span><span class="mtk4"> : </span><span class="mtk6">{</span><span class="mtk1">p</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'=================================================</span><span class="mtk4">=========================='</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">crypto</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PopperSystem(</span><span class="mtk6">2048</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">encrypted_plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.encrypt_plans()</span>

<span class="mtk1">    </span><span class="mtk8">show_banner</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'This channel aims at secure communication via asy</span><span class="mtk4">mmetric encryption.'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'We say : </span><span class="mtk6">{</span><span class="mtk1">crypto</span><span class="mtk1">.encrypt(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">choice</span><span class="mtk1">(</span><span class="mtk1">GREET</span><span class="mtk1">)).hex()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'S'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">enc_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'You say : '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.send_encrypted_message(</span><span class="mtk1">enc_msg</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Nice! We say : </span><span class="mtk6">{</span><span class="mtk1">crypto</span><span class="mtk1">.encrypt(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">choice</span><span class="mtk1">(</span><span class="mtk1">ANS</span><span class="mtk1">)).hex()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Nice! We say : </span><span class="mtk6">{</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'R'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Our plans are encrypted via symmetric encryption </span><span class="mtk4">and protected with our unique super computer that </span><span class="mtk4">will take us to the Red Planet!'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Enter decryption key : '</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.reveal_internal_plans(</span><span class="mtk1">encrypted_plans</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">print_plans</span><span class="mtk1">(</span><span class="mtk1">plans</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">        </span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'F'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">h</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Before giving you the token, you must prove me th</span><span class="mtk4">at you know the public key : '</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.hash_verified(</span><span class="mtk1">h</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.generate_token()</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Here is your token : </span><span class="mtk6">{</span><span class="mtk1">token</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Make sure you do not forget it next time!'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Get out!'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Hey, this is suspicious! Terminating the channel.</span><span class="mtk4">..'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8 mtku">signal</span><span class="mtk1">.</span><span class="mtk8">alarm</span><span class="mtk1">(</span><span class="mtk6">900</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>And this is <code>pool.py</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">GREET</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span>
<span class="mtk1">    </span><span class="mtk4">'Is there an emergency?'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">'How you doing?'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">'Hey!'</span>
<span class="mtk1">]</span>

<span class="mtk1">ANS</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span>
<span class="mtk1">    </span><span class="mtk4">'Great news, but use this channel responsibly.'</span><span class="mtk1">,</span>  
<span class="mtk1">    </span><span class="mtk4">'I will inform the governor.'</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">'Bye!'</span>
<span class="mtk1">]</span>
</code></pre></div><p>We are given three options:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 94.237.62.195 47360

   ___                                    ____                              ____ _                            _
  / _ \ _   _ _ __ ___   __ _ _ __ __ _  / ___|  ___  ___ _   _ _ __ ___   / ___| |__   __ _ _ __  _ __   ___| |
 | | | | | | | '_ ` _ \ / _` | '__/ _` | \___ \ / _ \/ __| | | | '__/ _ \ | |   | '_ \ / _` | '_ \| '_ \ / _ \ |
 | |_| | |_| | | | | | | (_| | | | (_| |  ___) |  __/ (__| |_| | | |  __/ | |___| | | | (_| | | | | | | |  __/ |
  \___/ \__,_|_| |_| |_|\__,_|_|  \__,_| |____/ \___|\___|\__,_|_|  \___|  \____|_| |_|\__,_|_| |_|_| |_|\___|_|

This channel aims at secure communication via asymmetric encryption.
We say : 5753adf1fb98f6dadd29631df780b6af712f99681b234da1598251a155d7549ecd8661355a2449fe341258b391225a1dc10f85e775311b5b56f07e678eea89ebce581e1badc7472c09e8639d0b406f314aaf603bc7674a17725546d1dfaeec93ace74b69c876e0d524709bd7d751939a1f6caaebd0ac5b410e4c4f409d71ffb9cf5a9ccd78eefed3174bdf5a5f715c1beb5a4ab578e20ca25e389514db9905905b298a8f84f1b5157b94241c0c22c196effe6563f3b20af1be6afde29eedceddea550d552a2fbb7fe105a0bc3d2254049d7ba204fe9db5f595b38bc73236c8ae832888f7ded43d05e179715839326c6ded91e2d62dacb2304bf544a2b364d4b0  
=======================================
||                                   ||
||   [S]end your encrypted message   ||
||   [R]eveal internal plans         ||
||   [F]orgot decryption key         ||
||                                   ||
=======================================
&gt;
</code></pre></div><p>To use option <code>F</code> we need to have the public key, and to use option <code>R</code> we need to have a decryption key, so, we need to use option <code>S</code> first.</p><h2 id="option-s">Option <code>S</code></h2><p>In this option, we will be given a random <code>ANS</code> encrypted message or just 256 random bytes depending on the message we input:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'S'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">enc_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'You say : '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.send_encrypted_message(</span><span class="mtk1">enc_msg</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Nice! We say : </span><span class="mtk6">{</span><span class="mtk1">crypto</span><span class="mtk1">.encrypt(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">choice</span><span class="mtk1">(</span><span class="mtk1">ANS</span><span class="mtk1">)).hex()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Nice! We say : </span><span class="mtk6">{</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>The <code>crypto</code> object is an instance of class <code>OumaraSystem</code> (although the code shows <code>PopperSystem</code>). We see that the <code>encrypt</code> method uses RSA to encrypt a given message <code>m</code>. All RSA parameters are correct:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">OumaraSystem</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">bits</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">bits</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">LIMIT</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk5">//</span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getPrime</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">BITS</span><span class="mtk5">//</span><span class="mtk6">2</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10001</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, (</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">))</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">GRAS</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">.encode())</span>
<span class="mtk1">        </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span>
<span class="mtk1">        </span><span class="mtk1">enc_msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">e</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">enc_msg</span>
</code></pre></div><p>Notice that we are not given any RSA parameters. We only have a ciphertext from a random <code>GREET</code> message:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'This channel aims at secure communication via asy</span><span class="mtk4">mmetric encryption.'</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'We say : </span><span class="mtk6">{</span><span class="mtk1">crypto</span><span class="mtk1">.encrypt(</span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">choice</span><span class="mtk1">(</span><span class="mtk1">GREET</span><span class="mtk1">)).hex()</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>For option <code>S</code> to work we need to send an message encrypted with their RSA public key. So, we can simply send back the ciphertext we already have. With this, the server will send us a random <code>ANS</code> message encrypted and not just 256 random bytes.</p><p>As a result, for some indices $0 \leqslant i, j \leqslant 2$ we have this:</p><p class="scroll">$$
\begin{cases}
c_1 = (\mathrm{GREET}[i]) ^ e \mod{n} \\
c_2 = (\mathrm{ANS}[j]) ^ e \mod{n}
\end{cases}
$$</p><h3 id="gcd">GCD</h3><p>The idea is to pre-compute $(\mathrm{GREET}[2]) ^ e$ and $(\mathrm{ANS}[2]) ^ e$, which are the smallest messages, and connect to the server until the server encrypts $\mathrm{GREET}[2]$.</p><p>The aim is to find $n$, which can be done using the Greatest Common Divisor (GCD), because:</p><p class="scroll">$$
\begin{cases}
(\mathrm{GREET}[2]) ^ e - c_1 \equiv 0 \pmod{n} \\
(\mathrm{ANS}[2]) ^ e - c_2 \equiv 0 \pmod{n}
\end{cases}
$$</p><p>So,</p><p class="scroll">$$
n = \gcd{\Big((\mathrm{GREET}[2]) ^ e - c_1, \quad (\mathrm{ANS}[2]) ^ e - c_2\Big)}
$$</p><p>Actually, it is possible that we don&rsquo;t get exactly $n$ but some small number times $n$. We can overcome this by trying to divide the GCD result with some few prime numbers.</p><p>As a result, we can guess that the server is sending us the encrypted $\mathrm{GREET}[2]$ and we just need to use option <code>S</code> several times until we have all the three possible encrypted $\mathrm{ANS}[j]$. Then, we compute the GCD with all combinations using the pre-computed $\mathrm{ANS}[2]) ^ e$ until we find $n$, which is an odd 2048-bit number. If we don&rsquo;t find $n$, then we repeat the process because the server has not sent the encrypted $\mathrm{GREET}[2]$:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">65537</span>

<span class="mtk1">guessed_greet</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Hey!'</span><span class="mtk1">)</span>
<span class="mtk1">guessed_greet_e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">guessed_greet</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk1">e</span>

<span class="mtk1">guessed_ans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">bytes_to_long</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Bye!'</span><span class="mtk1">)</span>
<span class="mtk1">guessed_ans_e</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">guessed_ans</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk1">e</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'We say : '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">enc_greet</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">enc_anss</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">set</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">enc_anss</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'S'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'You say : '</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">enc_greet</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Nice! We say : '</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">enc_anss</span><span class="mtk1">.</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">max</span><span class="mtk1">(</span><span class="mtk8">gcd</span><span class="mtk1">(</span><span class="mtk1">guessed_greet_e</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">enc_greet</span><span class="mtk1">, </span><span class="mtk1">guessed_ans_e</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">enc_ans</span><span class="mtk1">) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">enc_ans</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">enc_anss</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> primes(</span><span class="mtk6">100</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">//=</span><span class="mtk1"> </span><span class="mtk1">p</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2048</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Found </span><span class="mtk6">{</span><span class="mtk1">n</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">break</span>

<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><h2 id="option-f">Option <code>F</code></h2><p>Once we have the RSA public key $(n, e)$, we can use option <code>F</code>, because it asks for the SHA256 hash of $n$ as a decimal string:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.hash_verified(</span><span class="mtk1">h</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.generate_token()</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Here is your token : </span><span class="mtk6">{</span><span class="mtk1">token</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Make sure you do not forget it next time!'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Get out!'</span><span class="mtk1">)</span>
</code></pre></div><p>The <code>hash_verified</code> method just checks the hash:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">hash_verified</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">h</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">h</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">N</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">digest</span><span class="mtk1">()</span>  
</code></pre></div><p>We already have $n$, so there is not issue with the verification process. After that, we are given a token, which is the output of <code>generate_token</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_token</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1">.</span><span class="mtk8">bit_length</span><span class="mtk1">() </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">643</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> ((</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">) </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">) </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span><span class="mtk1">.</span><span class="mtk1">getrandbits</span><span class="mtk1">(</span><span class="mtk1">d</span><span class="mtk1">)</span>  
</code></pre></div><p>This token contains some information about the prime number $q$ (which is part of the RSA private key). Actually, we are given $643$ bits of information (they hide $381$ bits).</p><h3 id="coppersmith-method">Coppersmith method</h3><p>To recover $q$ we can use <a target="_blank" href="https://en.wikipedia.org/wiki/Coppersmith_method">Coppersmith method</a>. For this, we create a polynomial $f(x) = x + q_H \pmod{p}$. Let $q_L = q - q_H$, then $f(q_L) = 0$, so $q_L$ is a root. Moreover, the root is small because it must be a 381-bit number. For more information on the implementation, you can take a look at <a target="_blank" href="../bank-er-smith">Bank-er-smith</a>.</p><p>To implement the attack, SageMath has a method called <code>small_roots</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'F'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span>
<span class="mtk1">    </span><span class="mtk7 mtki">b</span><span class="mtk4">'Before giving you the token, you must prove me th</span><span class="mtk4">at you know the public key : '</span><span class="mtk1">,</span>  
<span class="mtk1">    </span><span class="mtk8">sha256</span><span class="mtk1">(</span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">n</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()).</span><span class="mtk8">hexdigest</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">(),</span>
<span class="mtk1">)</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Here is your token : '</span><span class="mtk1">)</span>
<span class="mtk1">d</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1024</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">643</span>
<span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
<span class="mtk1">q_H</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">) </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk1">d</span>

<span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PolynomialRing(Zmod(</span><span class="mtk1">n</span><span class="mtk1">), </span><span class="mtk9 mtki">names</span><span class="mtk5">=</span><span class="mtk4">'x'</span><span class="mtk1">).gens()[</span><span class="mtk6">0</span><span class="mtk1">]</span>

<span class="mtk1">q_L</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">((</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">q_H</span><span class="mtk1">).small_roots(</span><span class="mtk9 mtki">X</span><span class="mtk5">=</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk1">d</span><span class="mtk1">, </span><span class="mtk9 mtki">beta</span><span class="mtk5">=</span><span class="mtk6">0.5</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">])</span>

<span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">q_H</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">q_L</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk1">n</span>
<span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">n</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk1">q</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Found </span><span class="mtk6">{</span><span class="mtk1">p</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Found </span><span class="mtk6">{</span><span class="mtk1">q</span><span class="mtk1"> = </span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>We need to specify the upper bound for the small root ($2^{381}$) and $\beta = 0.5$ because $q \approx n^{0.5}$.</p><p>Once we have $q$ it is trivial to find $p$, so we have the RSA private key.</p><h2 id="option-r">Option <code>R</code></h2><p>For this option, we need to provide a decryption key:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">ch</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'R'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Our plans are encrypted via symmetric encryption </span><span class="mtk4">and protected with our unique super computer that </span><span class="mtk4">will take us to the Red Planet!'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Enter decryption key : '</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk1">plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">crypto</span><span class="mtk1">.reveal_internal_plans(</span><span class="mtk1">encrypted_plans</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">print_plans</span><span class="mtk1">(</span><span class="mtk1">plans</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>
</code></pre></div><p>This key is used to decrypt some plans using AES:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">reveal_internal_plans</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">encrypted_plans</span><span class="mtk1">, </span><span class="mtk9 mtki">key</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk8">unpad</span><span class="mtk1">(</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">decrypt</span><span class="mtk1">(</span><span class="mtk1">ep</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">decode</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">ep</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">encrypted_plans</span><span class="mtk1">]</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">plans</span>
</code></pre></div><p>We know how these plans were encrypted:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">encrypt_plans</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">symmetric_key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">prng</span><span class="mtk1">.</span><span class="mtk8">generate_key</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">cipher</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">symmetric_key</span><span class="mtk1">, </span><span class="mtk8 mtku">AES</span><span class="mtk1">.</span><span class="mtk1">MODE_ECB</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">enc_plans</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">cipher</span><span class="mtk1">.</span><span class="mtk8">encrypt</span><span class="mtk1">(</span><span class="mtk8">pad</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.encode(), </span><span class="mtk6">16</span><span class="mtk1">)) </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk6">RESTRICTED</span><span class="mtk1">]</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">enc_plans</span>
</code></pre></div><p>And <code>self.symmetric_key</code> comes from <code>self.prng.generate_key</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">generate_key</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1337</span>
<span class="mtk1">        </span><span class="mtk3"># this loop runs in milliseconds in our super comp</span><span class="mtk3">uter</span>  
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">ct</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk1">ct</span><span class="mtk1">)[:</span><span class="mtk6">16</span><span class="mtk1">]</span>
</code></pre></div><p>Remember that <code>prng</code> is an instance of <code>GRAS</code>, initialized as <code>GRAS(self.N, self.p, self.q)</code> from <code>OumaraSystem</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">GRAS</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">m</span><span class="mtk1">, </span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">q</span><span class="mtk1">):</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">m</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">m</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">deadbeef</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">q</span>
</code></pre></div><p>So, the symmetric AES key is the result of performing this recurrence relation:</p><p class="scroll">$$
\begin{cases}
\mathrm{ct}_0 = \mathtt{0x1337} \\
\mathrm{ct}_{i + 1} = (\mathrm{ct}_i) ^ \mathtt{0xdeadbeef} \mod{n}, \quad 0 \leqslant i < n
\end{cases}
$$</p><p>This recurrence relation is not affordable to do it as such, because $n$ iterations are just too much to handle. But we can try to transform the recurrence relation into into a closed expression. Let&rsquo;s start with the first rounds:</p><p class="scroll">$$
\begin{cases}
\mathrm{ct}_0 & = \mathtt{0x1337} \\
  \mathrm{ct}_1 & = (\mathrm{ct}_0) ^ \mathtt{0xdeadbeef} \mod{n} \\
& \quad = \mathtt{0x1337} ^ \mathtt{0xdeadbeef} \mod{n} \\
\mathrm{ct}_2 & = (\mathrm{ct}_1) ^ \mathtt{0xdeadbeef} \mod{n} \\
& \quad = (\mathtt{0x1337} ^ \mathtt{0xdeadbeef}) ^ \mathtt{0xdeadbeef} \mod{n} \\
& \quad = \mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ 2} \mod{n} \\
\mathrm{ct}_3 & = (\mathrm{ct}_2) ^ \mathtt{0xdeadbeef} \mod{n} \\
& \quad = (\mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ 2}) ^ \mathtt{0xdeadbeef} \mod{n} \\
& \quad = \mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ 3} \mod{n} \\
\dots
\end{cases}
$$</p><p>So, by induction, we see that</p><p class="scroll">$$
\mathrm{ct}_i = \mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ i} \mod{n}
$$</p><p>Hence, the symmetric key is the value of $\mathrm{ct}_n$, which is</p><p class="scroll">$$
\mathrm{ct}_n = \mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ n} \mod{n}
$$</p><h3 id="eulers-theorem">Euler&rsquo;s Theorem</h3><p>Again, computing $\mathtt{0xdeadbeef} ^ n$ is not affordable. However, we know from <a target="_blank" href="https://en.wikipedia.org/wiki/Euler%27s_theorem">Euler&rsquo;s Theorem</a> that:</p><p class="scroll">$$
a^{\phi(n)} \equiv 1 \pmod{n}
$$</p><p>For all $a$ that is coprime with $n$. Notice that in our case, $\phi(n) = (p - 1) \cdot (q - 1)$, we know its value.</p><p>As a result, we can express $\mathtt{0xdeadbeef} ^ n = k \cdot \phi(n) + r$ for some $r, k \in \mathbb{Z}$ with $0 \leqslant r &lt; \phi(n)$. This means that</p><p class="scroll">$$
\begin{align}
\mathrm{ct}_n & = \mathtt{0x1337} ^ {\mathtt{0xdeadbeef} ^ n} \mod{n} \\
& = \mathtt{0x1337} ^ {k \cdot \phi(n) + r} \mod{n} \\
& = \mathtt{0x1337} ^ {k \cdot \phi(n)} \cdot \mathtt{0x1337} ^ r \mod{n} \\
& = (\mathtt{0x1337} ^ {\phi(n)})^k \cdot \mathtt{0x1337} ^ r \mod{n} \\
& = 1^k \cdot \mathtt{0x1337} ^ r \mod{n} \\
& = \mathtt{0x1337} ^ r \mod{n} \\
\end{align}
$$</p><p>So, we can easily find $\mathrm{ct}_n$ by calculating $\mathtt{0x1337} ^ r \mod{n}$, where $r = \mathtt{0xdeadbeef} ^ n \mod{\phi(n)}$.</p><p>Finally, we compute the value to get the AES key and send it to the server to get the decrypted plans, where we will get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">phi_n</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">q</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>

<span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">deadbeef</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">, </span><span class="mtk1">phi_n</span><span class="mtk1">)</span>
<span class="mtk1">key</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">long_to_bytes</span><span class="mtk1">(</span><span class="mtk8">pow</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">1337</span><span class="mtk1">, </span><span class="mtk1">r</span><span class="mtk1">, </span><span class="mtk1">n</span><span class="mtk1">))[:</span><span class="mtk6">16</span><span class="mtk1">]</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'R'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter decryption key : '</span><span class="mtk1">, </span><span class="mtk1">key</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvall</span><span class="mtk1">())</span>
</code></pre></div><h2 id="flag">Flag</h2><p>If we run the script, we will eventually get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.62.195:47360
[<span class="code-green">+</span>] Opening connection to 94.237.62.195 on port 47360: Done
[<span class="code-blue">*</span>] Closed connection to 94.237.62.195 port 47360
[<span class="code-green">+</span>] Opening connection to 94.237.62.195 on port 47360: Done
[<span class="code-green">+</span>] Found n = 21828146529253275647528009268961483917051427953072577306400212670783019877630592727742182289463031611647097861086320726593126769979528665193048139486760894654690438277251180052193057515070370801418498585589171513684267978232583787004127360151128840623431139630252021535654195838570606968632681095031823079824965797727053272091392851725752523879162831055146384238685312134668411531994622000792062370758867536394634102913088089786880545130192783530519953571718954658995201918458155388045089276232631781288844941398393317786447871785850810213239753970564827735726630395643445385451025512627762738759777002612894573124779  
[<span class="code-green">+</span>] Found p = 138914161634423579755973890643073661570844937467514466292807268924640588600508463767512520820631207681003342696298915409507816838560655431962752418410182732334881168218381565403199082791198460278491813223075820718287282969472364968722297813493964939725554441884621069455843858556284476182996052034694182305499
[<span class="code-green">+</span>] Found q = 157134062304589100449250495092477382712810341772835720236404481783671949518284747291908024847223653945202337368600411462252602380456101761563657012208023722487110626000059267031658199648905100702047735660944313210898947637050045958141628827881758216447663733390406115171560673050045606192734569616598139140721
[<span class="code-green">+</span>] Receiving all data: Done (590B)
[<span class="code-blue">*</span>] Closed connection to 94.237.62.195 port 47360
[<span class="code-green">+</span>] ==================== CLASSIFIED CONTENT! DO NOT SHARE! ====================
    Plan 1 : Their governor goes to sleep at 23:30 PM. We can then break in their warehouses tomorrow night and steal some fuels and water.
    Plan 2 : Listen to the plan carefully! When you are done with the aforementioned invasion, make sure you come back silently and whisper the passphrase HTB{0ur_c0mput3r_1s_t00_f4st___w3_d0nt_3v3n_n33d_3u13r!} to the guards so you can enter.
    Plan 3 : WE will conquer the red planet and get the Vitalium!
    ===========================================================================
</code></pre></div><p>The full script can be found in here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Crypto/Interception/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#option-s">Option <code>S</code></a><ul><li><a href="#gcd">GCD</a></li></ul></li><li><a href="#option-f">Option <code>F</code></a><ul><li><a href="#coppersmith-method">Coppersmith method</a></li></ul></li><li><a href="#option-r">Option <code>R</code></a><ul><li><a href="#eulers-theorem">Euler&rsquo;s Theorem</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>