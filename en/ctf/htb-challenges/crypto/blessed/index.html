<!doctype html><html lang="en"><head><title>Blessed | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="BLS12-381. BLS signatures. Rogue key attack. Zero-knowledge proof. EC-LCG. LLL lattice reduction"><meta name="image" content="https://7rocky.github.io/images/cryptography.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="BLS12-381. BLS signatures. Rogue key attack. Zero-knowledge proof. EC-LCG. LLL lattice reduction"><meta itemprop="keywords" content><meta itemprop="name" content="Blessed"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="BLS12-381. BLS signatures. Rogue key attack. Zero-knowledge proof. EC-LCG. LLL lattice reduction"><meta property="og:image" content="https://7rocky.github.io/images/cryptography.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Blessed"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/crypto/blessed/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="BLS12-381. BLS signatures. Rogue key attack. Zero-knowledge proof. EC-LCG. LLL lattice reduction"><meta name="twitter:description" content="BLS12-381. BLS signatures. Rogue key attack. Zero-knowledge proof. EC-LCG. LLL lattice reduction"><meta name="twitter:image" content="https://7rocky.github.io/images/cryptography.png"><meta name="twitter:title" content="Blessed"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/crypto/blessed/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script><script>MathJax={loader:{load:["[tex]/noerrors"]},options:{ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process",skipHtmlTags:["noscript","pre","script","style","textarea"]},tex:{autoload:{color:[],colorv2:["color"]},displayMath:[["$$","$$"]],inlineMath:[["$","$"]],packages:{"[+]":["noerrors"]},processEnvironments:!0,processEscapes:!0}}</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><div id="math-consts" style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\lcm}{\mathop{\mathrm{lcm}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script><script>(async()=>await typeset(()=>[`#math-consts`]))()</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/crypto/blessed/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- CRYPTO</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/crypto/blessed/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/blessed/&amp;text=Blessed" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/crypto/blessed/&amp;title=Blessed" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Blessed</h1><p class="mb4 f6 dib tracked">22 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#bls-signatures">BLS signatures</a></li><li><a href="#zero-knowledge-proof">Zero-knowledge proof</a></li><li><a href="#ec-lcg">EC-LCG</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#implementation">Implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>This challenge was made by me for Hack The Box. We are given the Python source of the server that contains the flag:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">eth_typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">, </span><span class="mtk1">BLSPubkey</span><span class="mtk1">, </span><span class="mtk1">BLSSignature</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">secrets</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">randbelow</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">Dict</span><span class="mtk1">, </span><span class="mtk8 mtku">Generator</span><span class="mtk1">, </span><span class="mtk1">List</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">Crypto</span><span class="mtk1">.</span><span class="mtk8 mtku">PublicKey</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">ciphersuites</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">G2ProofOfPossession</span><span class="mtk1"> </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">g2_primitives</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">point_compression</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8 mtku">typing</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">G1Compressed</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">py_ecc</span><span class="mtk1">.</span><span class="mtk8 mtku">optimized_bls12_381</span><span class="mtk1">.</span><span class="mtk8 mtku">optimized_curve</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">curve_order</span><span class="mtk1">, </span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk8">multiply</span><span class="mtk1">, </span><span class="mtk8">neg</span><span class="mtk1">, </span><span class="mtk8">normalize</span>


<span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'flag.txt'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">()</span>
<span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">FileNotFoundError</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">FLAG</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'HTB</span><span class="mtk6">{f4k3_fl4g_f0r_t3st1ng}</span><span class="mtk4">'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">verified</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">:       </span><span class="mtk1">BLSPubkey</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">:      </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">json</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()}</span>


<span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">:   </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">Robot</span><span class="mtk1">]                </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">Robot</span><span class="mtk1"> </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk6">None</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">r</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Do not lose your secret key!'</span><span class="mtk1">, </span><span class="mtk4">'sk'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk5">**</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">()}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pk</span><span class="mtk1">: </span><span class="mtk1">BLSPubkey</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a public key'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">), </span><span class="mtk9 mtki">verified</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot joined but not verified'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:]}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Verify</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'list'</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">agg_pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires an aggregated signature'</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">FastAggregateVerify</span><span class="mtk1">(</span><span class="mtk1">agg_pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Secrets have been unveiled!'</span><span class="mtk1">, </span><span class="mtk4">'flag'</span><span class="mtk1">: </span><span class="mtk1">FLAG</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid aggregated signature'</span><span class="mtk1">}</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">help</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">'help'</span><span class="mtk1">:           </span><span class="mtk4">'Show this panel'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'create'</span><span class="mtk1">:         </span><span class="mtk4">'Generate a new robot, already verified'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'join'</span><span class="mtk1">:           </span><span class="mtk4">'Add a new robot, given a public key and a signatu</span><span class="mtk4">re'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'verify'</span><span class="mtk1">:         </span><span class="mtk4">'Start interactive process to verify a robot given</span><span class="mtk4"> an ID'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'list'</span><span class="mtk1">:           </span><span class="mtk4">'Return a list of all existing robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">: </span><span class="mtk4">'Show the secrets given an aggregated signature of</span><span class="mtk4"> all registered robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'exit'</span><span class="mtk1">:           </span><span class="mtk4">'Shutdown the SuperComputer'</span><span class="mtk1">,</span>
<span class="mtk1">        }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">run_cmd</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">data</span><span class="mtk1">: </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>
<span class="mtk1">        </span><span class="mtk1">cmd</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'cmd'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">pk</span><span class="mtk1">       </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'pk'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk1">sig</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSSignature</span><span class="mtk1">(</span><span class="mtk8 mtku">bytes</span><span class="mtk1">.</span><span class="mtk8">fromhex</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'sig'</span><span class="mtk1">, </span><span class="mtk4">''</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'robot_id'</span><span class="mtk1">, </span><span class="mtk4">'0'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'create'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'join'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk1">pk</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'verify'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'list'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">, </span><span class="mtk1">sig</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk1">sig</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'exit'</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'exit'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">help</span><span class="mtk1">()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Welcome! You have been invited to use our SuperCo</span><span class="mtk4">mputer, which is very powerful and totally secure.</span><span class="mtk4"> Only sophisticated robots are able to use it, so </span><span class="mtk4">you need to create a robot to interact with the Su</span><span class="mtk4">perComputer or maybe join an existing one. The key</span><span class="mtk4"> to our success is that critical operations need t</span><span class="mtk4">he approval of all registered robots. Hackers cann</span><span class="mtk4">ot beat our security!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk4">'Architects/Engineers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Explosives Experts/Demolition Specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Hackers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Stealth/Infiltration specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Scavengers'</span><span class="mtk1">,</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">sc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> {</span><span class="mtk4">'Hackers'</span><span class="mtk1">}))  </span><span class="mtk3"># No hackers here...</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk1">sc</span><span class="mtk1">.</span><span class="mtk8">help</span><span class="mtk1">(), </span><span class="mtk9 mtki">indent</span><span class="mtk5">=</span><span class="mtk6">2</span><span class="mtk1">), </span><span class="mtk9 mtki">end</span><span class="mtk5">=</span><span class="mtk4">'</span><span class="mtk6">\n\n</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">sc</span><span class="mtk1">.</span><span class="mtk8">run_cmd</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'&gt; '</span><span class="mtk1">)))</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">), </span><span class="mtk9 mtki">end</span><span class="mtk5">=</span><span class="mtk4">'</span><span class="mtk6">\n\n</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">'error'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">res</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">break</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><h2 id="source-code-analysis">Source code analysis</h2><p>The server defines an instance of <code>SuperComputer</code>, and we are allowed to interact with it using these commands:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">help</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk4">'help'</span><span class="mtk1">:           </span><span class="mtk4">'Show this panel'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'create'</span><span class="mtk1">:         </span><span class="mtk4">'Generate a new robot, already verified'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'join'</span><span class="mtk1">:           </span><span class="mtk4">'Add a new robot, given a public key and a signatu</span><span class="mtk4">re'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'verify'</span><span class="mtk1">:         </span><span class="mtk4">'Start interactive process to verify a robot given</span><span class="mtk4"> an ID'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'list'</span><span class="mtk1">:           </span><span class="mtk4">'Return a list of all existing robots'</span><span class="mtk1">,</span>
<span class="mtk1">            </span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">: </span><span class="mtk4">'Show the secrets given an aggregated signature of</span><span class="mtk4"> all registered robots'</span><span class="mtk1">,</span>  
<span class="mtk1">            </span><span class="mtk4">'exit'</span><span class="mtk1">:           </span><span class="mtk4">'Shutdown the SuperComputer'</span><span class="mtk1">,</span>
<span class="mtk1">        }</span>
</code></pre></div><p>For that, we will need to create a robot, because we need a secret key to sign our commands:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Do not lose your secret key!'</span><span class="mtk1">, </span><span class="mtk4">'sk'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk5">**</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">()}</span>  
</code></pre></div><p>The previous method returns an instance of <code>Robot</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">class</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">           </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">robot_id</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">: </span><span class="mtk8 mtku">bool</span><span class="mtk1">          </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">verified</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">:       </span><span class="mtk1">BLSPubkey</span><span class="mtk1">     </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPubkey</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">:      </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">BLSPrivateKey</span><span class="mtk1">(</span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">_sk</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">json</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:], </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()}</span>  
</code></pre></div><p>Observe that the robot ID is the output of this PRNG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>  
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
</code></pre></div><p>Also, notice that the <code>SuperComputer</code> already has a total of 4 robots:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">n</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">:   </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">()</span>  
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">: </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">Robot</span><span class="mtk1">]                </span><span class="mtk5">=</span><span class="mtk1"> []</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk9 mtki">n</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">create</span><span class="mtk1">()</span>
</code></pre></div><p>Because it is created as follows:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk4">'Architects/Engineers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Explosives Experts/Demolition Specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Hackers'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Stealth/Infiltration specialists'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'Scavengers'</span><span class="mtk1">,</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk1">sc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">SuperComputer</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">crew</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> {</span><span class="mtk4">'Hackers'</span><span class="mtk1">}))  </span><span class="mtk3"># No hackers here...</span>  
</code></pre></div><p>Once we have a robot, we can use the secret key to sign a command. For instance, we can run <code>list</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">] </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]]:</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Verify</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'list'</span><span class="mtk1">, </span><span class="mtk9 mtki">sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid signature'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk8">json</span><span class="mtk1">() </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">]</span>
</code></pre></div><p>This method will return the ID of all robots registered in the <code>SuperComputer</code>. This could be needed to crack the PRNG.</p><p>Moreover, we can run <code>join</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">pk</span><span class="mtk1">: </span><span class="mtk1">BLSPubkey</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires a public key'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Robot</span><span class="mtk1">(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">), </span><span class="mtk9 mtki">verified</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">pk</span>
<span class="mtk1">        </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot joined but not verified'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">robot_id</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:]}</span>  
</code></pre></div><p>With this method we can add an existing robot to the <code>SuperComputer</code> using its public key. The difference with <code>create</code> is that the new robot is not verified, so we need to run <code>verify</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>  

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>
</code></pre></div><p>This method runs an interactive verification process to ensure that the public key of the robot is valid, but without disclosing the associated secret key. This is known as <a target="_blank" href="https://en.wikipedia.org/wiki/Zero-knowledge_proof">zero-knowledge proof</a> (ZKP).</p><p>The target command we want to run to solve the challenge is <code>unveil_secrets</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">unveil_secrets</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">: </span><span class="mtk1">BLSSignature</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">agg_pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">robots</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'This command requires an aggregated signature'</span><span class="mtk1">}</span>  
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">FastAggregateVerify</span><span class="mtk1">(</span><span class="mtk1">agg_pk</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'unveil_secrets'</span><span class="mtk1">, </span><span class="mtk9 mtki">agg_sig</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Secrets have been unveiled!'</span><span class="mtk1">, </span><span class="mtk4">'flag'</span><span class="mtk1">: </span><span class="mtk1">FLAG</span><span class="mtk1">}</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Invalid aggregated signature'</span><span class="mtk1">}</span>
</code></pre></div><p>For this, we need a aggregated signature of all verified robots, which means that every robot must have signed this command. Otherwise, the verification will fail and we will not execute the command successfully.</p><h3 id="bls-signatures">BLS signatures</h3><p>The server uses <a target="_blank" href="https://en.wikipedia.org/wiki/BLS_digital_signature">BLS signatures</a>, which involve pairing-based cryptography. The library <a target="_blank" href="https://pypi.org/project/py-ecc/"><code>py-ecc</code></a> makes a nice abstraction of what happens under the hood.</p><p>Basically, the BLS signature is using two elliptic curves $\mathbb{G}_1$ and $\mathbb{G}_2$ (known as BLS12-381), whose generator points are $G_1$ and $G_2$. These curves are pairing-friendly, which means that a pairing function can be defined here.</p><p>The idea is that two points of the elliptic curves can be associated to return another point of another elliptic curve, which is $\mathbb{G}_T$. Particularly, a pairing is a bilinear function:</p><p class="scroll">$$
e: \mathbb{G}_1 \times \mathbb{G}_2 \to \mathbb{G}_T
$$</p><p>The bilinear property means that the following expressions hold for $P, R \in \mathbb{G}_1$ and $Q, S \in \mathbb{G}_2$:</p><p class="scroll">$$
\begin{align*}
e(P + R, Q) = e(P, Q) \cdot e(R, Q) \\
e(P, Q + S) = e(P, Q) \cdot e(P, S)
\end{align*}
$$</p><p>As a result, for scalars $a$ and $b$, the following expressions also hold:</p><p class="scroll">$$
\begin{align*}
e(a \cdot P, b \cdot Q) & = e(P, b \cdot Q)^a \\
          & = e(a \cdot P, Q)^b \\
          & = e(P, Q)^{ab} \\
               & = e(b \cdot P, Q)^a \\
          & = e(P, a \cdot Q)^b \\
          & = e(b \cdot P, a \cdot Q) \\
    & = e(ab \cdot P, Q) \\
           & = e(P, ab \cdot Q)
\end{align*}
$$</p><p>This bilinear property allows to define the BLS signature scheme:</p><ul><li>A user takes a random integer $\mathrm{sk}$ and computes its public key as $\mathrm{Pk} = \mathrm{sk} \cdot G_1$</li><li>In order to sign a message $m$, the message must be hashed to a point (there are several methods to do this), so $H(m) \in \mathbb{G}_2$</li><li>The signature is $\sigma = \mathrm{sk} \cdot H(m) \in \mathbb{G}_2$</li></ul><p>The verification process involves the pairing. The verifier only needs to compute $e(\mathrm{Pk}, H(m))$ and compare it to $e(G_1, \sigma)$. This works because:</p><p class="scroll">$$
\begin{align*}
e(\mathrm{Pk}, H(m)) & = e(\mathrm{sk} \cdot G_1, H(m)) \\
& = e(G_1, H(m))^{\mathrm{sk}} \\
 & = e(G_1, \mathrm{sk} \cdot H(m)) \\
& = e(G_1, \sigma)
\end{align*}
$$</p><p>The relevance of BLS signatures comes with the fact that signatures can be aggregated. So, instead of verifying a message signature against several public keys, it suffices to verify only an aggregated signature against an aggregated public key:</p><p class="scroll">$$
\begin{align*}
\sigma_{\mathrm{agg}} = \sigma_1 + \sigma_2 + \dots + \sigma_n \\
\mathrm{Pk}_{\mathrm{agg}} = \mathrm{Pk}_1 + \mathrm{Pk}_2 + \dots + \mathrm{Pk}_n \\ \\
e(\mathrm{Pk}_{\text{agg}}, H(m)) \stackrel{?}{=} e(G_1, \sigma_{\text{agg}})
\end{align*}
$$</p><p>However, there is a problem with the aggregation if an attacker can use an arbitrary public key. The attacker is able to forge an aggregated signature for a given message, that is, tell that some victim user has signed a message:</p><ul><li>The attacker uses the following public key: $\mathrm{Pk}_\text{attacker} = \mathrm{sk}_\text{attacker} \cdot G_1 - \mathrm{Pk}_\text{victim}$</li><li>The forged aggregated signature is: $\sigma_\text{forged} = \mathrm{sk}_\text{attacker} \cdot H(m)$</li><li>The verifier will check that $e(\mathrm{Pk}_\text{victim} + \mathrm{Pk}_\text{attacker}, H(m))$ equals $e(G_1, \sigma_{\text{forged}})$</li></ul><p>And it works because</p><p class="scroll">$$
\begin{align*}
e(\mathrm{Pk}_\text{victim} + \mathrm{Pk}_\text{attacker}, H(m)) & = e(\mathrm{Pk}_\text{victim} + \mathrm{sk}_\text{attacker} \cdot G_1 - \mathrm{Pk}_\text{victim}, H(m)) \\
& = e(\mathrm{sk}_\text{attacker} \cdot G_1, H(m)) \\
& = e(G_1, H(m))^{\mathrm{sk}_\text{attacker}} \\
& = e(G_1, \mathrm{sk}_\text{attacker} \cdot H(m)) \\
& = e(G_1, \sigma_{\text{forged}})
\end{align*}
$$</p><p>This is known as rogue key attack. The way to prevent it is using a &ldquo;Proof of Posession&rdquo;, which is to verify that the user that has a public key knows the associated secret key. Normally, the user should provide a signature of the public key, which proves that the user knows the secret key associated to the public key. Other methods might involve zero-knowledge proofs.</p><p>For more information about BLS12-381 curves and BLS signatures, refer to <a target="_blank" href="https://hackmd.io/@benjaminion/bls12-381">BLS12-381 For The Rest Of Us</a> or <a target="_blank" href="https://medium.com/nethermind-eth/bls-signatures-withdrawals-bbf38658c242">BLS Signatures & Withdrawals</a>.</p><h3 id="zero-knowledge-proof">Zero-knowledge proof</h3><p>The way to prevent the rogue key attack in this challenge is using an interactive zero-knowledge proof: We want the user to prove that they know $\mathrm{sk}$ such that $\mathrm{Pk} = \mathrm{sk} \cdot G_1$, but without disclosing $\mathrm{sk}$.</p><p>To achieve this, the server tells the user to pick a random integer $x$ and send $C = x \cdot G_1$. Then, the server chooses randomly one of these two questions:</p><ol><li>Show me $x$</li><li>Show me the result of $(\mathrm{sk} + x)$</li></ol><p>If the question is 1., then the server can easily check that the given $x$ satisfies that $C = x \cdot G_1$.</p><p>If the question is 2., then the server can check that the given value $(\mathrm{sk} + x$) satisfies that $\mathrm{Pk} + C = (\mathrm{sk} + x) \cdot G_1$.</p><p>If this experiment is repeated several times and the user is not able to predict the question, then it is practically impossible to lie on the ZKP protocol:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">verify</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">, </span><span class="mtk9 mtki">robot_id</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk1">Dict</span><span class="mtk1">[</span><span class="mtk8 mtku">str</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">_find_robot_by_id</span><span class="mtk1">(</span><span class="mtk9 mtki">robot_id</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'No robot found'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'User already verified'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">({</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Prove that you have the secret key that correspon</span><span class="mtk4">ds to your public key: pk = sk * G1'</span><span class="mtk1">}))</span>  

<span class="mtk1">        </span><span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">C_hex</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">C_hex</span><span class="mtk1">, </span><span class="mtk6">16</span><span class="mtk1">)))</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rand</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8">input</span><span class="mtk1">(</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">))) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'error'</span><span class="mtk1">: </span><span class="mtk4">'Proof failed!'</span><span class="mtk1">}</span>

<span class="mtk1">        </span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">verified</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">True</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> {</span><span class="mtk4">'msg'</span><span class="mtk1">: </span><span class="mtk4">'Robot verified'</span><span class="mtk1">}</span>
</code></pre></div><p>If the attacker is able to predict the question, then the attacker is able to cheat the ZKP protocol (that is, show that they know $\mathrm{sk}$ such that $\mathrm{Pk}_\text{attacker} = \mathrm{sk} \cdot G_1$, when it is false):</p><ul><li>For question 1., the attacker simply sends the value of $x$ such that $C = x \cdot G_1$</li><li>But for question 2., they can compute a special $C = \mathrm{sk}_x \cdot G_1 - \mathrm{Pk}_\text{attacker}$, send it, and then use $\mathrm{sk}_x$ as $(\mathrm{sk} + x)$. The server will check that $\mathrm{Pk}_\text{attacker} + C = \mathrm{sk}_x \cdot G_1$, which is true because</li></ul><p class="scroll">$$
\mathrm{Pk}_\text{attacker} + C = \mathrm{Pk}_\text{attacker} + \mathrm{sk}_x \cdot G_1 - \mathrm{Pk}_\text{attacker} = \mathrm{sk}_x \cdot G_1
$$</p><h3 id="ec-lcg">EC-LCG</h3><p>The server uses this PRNG instance to choose the question for the ZKP protocol. So, we will need to crack the PRNG to predict questions and thus cheat the ZKP protocol:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">rng</span><span class="mtk1">() -&gt; </span><span class="mtk8 mtku">Generator</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">, </span><span class="mtk6">None</span><span class="mtk1">]:</span>
<span class="mtk1">    </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">randbelow</span><span class="mtk1">(</span><span class="mtk1">curve_order</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">Gx</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span>  
<span class="mtk1">    </span><span class="mtk1">Gy</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span>
<span class="mtk1">    </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8 mtku">EccPoint</span><span class="mtk1">(</span><span class="mtk1">Gx</span><span class="mtk1">, </span><span class="mtk1">Gy</span><span class="mtk1">, </span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">B</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ECC</span><span class="mtk1">.</span><span class="mtk8">generate</span><span class="mtk1">(</span><span class="mtk9 mtki">curve</span><span class="mtk5">=</span><span class="mtk4">'p256'</span><span class="mtk1">).</span><span class="mtk1">pointQ</span>
<span class="mtk1">    </span><span class="mtk1">W0</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk7">*</span><span class="mtk1"> </span><span class="mtk1">seed</span><span class="mtk1"> </span><span class="mtk7">+</span><span class="mtk1"> </span><span class="mtk1">B</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">W0</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk6">True</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk7">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
<span class="mtk1">        </span><span class="mtk5">yield</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.</span><span class="mtk1">y</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span>
</code></pre></div><p>This algorithm is an EC-LCG that uses curve <a target="_blank" href="https://neuromancer.sk/std/nist/P-256">P256</a>, denoted by $E(\mathbb{F}_p)$, in the following way:</p><p class="scroll">$$
\begin{cases}
W_0 & = \mathrm{seed} \cdot G + B \\
  W_n & = W_{n - 1} + G \\
  r_{2 n - 1} & = (W_n)_\mathrm{x} \gg 32 \\
  r_{2 n} & = (W_n)_\mathrm{y} \gg 32 \\
\end{cases}
$$</p><p>Where $B, G \in E(\mathbb{F}_p)$, $\mathrm{seed} \in \mathbb{Z}$ and $n > 0$. The outputs of the PRNG are $r_i$:</p><p class="scroll">$$
\begin{cases}
r_1 & = (W_1)_\mathrm{x} \gg 32 \\
  r_2 & = (W_1)_\mathrm{y} \gg 32 \\
  r_3 & = (W_2)_\mathrm{x} \gg 32 \\
  r_4 & = (W_2)_\mathrm{y} \gg 32 \\
  \dots
\end{cases}
$$</p><p>The same can be expressed as follows:</p><p class="scroll">$$
\begin{cases}
W_n & = (\mathrm{seed} + n) \cdot G + B \\
r_{2 n - 1} & = (W_n)_\mathrm{x} \gg 32 \\
  r_{2 n} & = (W_n)_\mathrm{y} \gg 32
\end{cases}
$$</p><p>The key to break this EC-LCG implementation is that $W_{n + 1} - W_n = G$. However, we are not given the exact values of $(W_n)_\text{x}$ and $(W_n)_\text{y}$, so we cannot simply find a point $W_n$ to crack the EC-LCG. Instead, we can write some equations with the information we know.</p><p>Let&rsquo;s use the following notation for the known outputs:</p><p class="scroll">$$
u_n = r_{2n - 1} = (W_n)_\mathrm{x} \gg 32 \qquad v_n = r_{2n} = (W_n)_\mathrm{y} \gg 32
$$</p><p>And these for the unknowns:</p><p class="scroll">$$
a_n = W_n - \big((W_n)_\mathrm{x} \gg 32\big) \ll 32 \qquad b_n = W_n - \big((W_n)_\mathrm{y} \gg 32\big) \ll 32
$$</p><p>We know the curve parameters and the generator point $G$ (<a target="_blank" href="https://neuromancer.sk/std/nist/P-256">P256</a>). We know that $(u_n + a_n, v_n + b_n) \in E(\mathbb{F}_p)$, so:</p><p class="scroll">$$
(v_n + b_n)^2 = (u_n + a_n)^3 + a \cdot (u_n + a_n) + b \mod{p}
$$</p><p>Moreover, we know that</p><p class="scroll">$$
G = W_{n + 1} - W_n = (u_{n + 1} + a_{n + 1}, v_{n + 1} + b_{n + 1}) - (u_n + a_n, v_n + b_n)
$$</p><p>This can be expressed using point addition formulas:</p><p class="scroll">$$
\begin{cases}
(x_1, y_1) + (x_2, y_2) = (x_3, y_3) \\ \\
\lambda = (y_2 - y_1) \cdot (x_2 - x_1)^{-1} \mod{p} \\
x_3 = \lambda^2 - x_1 - x_2 \\
y_3 = \lambda \cdot (x_1 - x_3) - y_1
\end{cases}
$$</p><p>We can get rid of $\lambda$ in the formula for $x_3$:</p><p class="scroll">$$
\begin{align*}
x_3 & = \lambda^2 - x_1 - x_2 \iff \\
 x_3 & = \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big)^2 - x_1 - x_2 \iff \\
x_3 & = (y_2 - y_1)^2 \cdot (x_2 - x_1)^{-2} - x_1 - x_2 \iff \\
0 & = x_3 - (y_2 - y_1)^2 \cdot (x_2 - x_1)^{-2} + x_1 + x_2 \iff \\
0 & = x_3 \cdot (x_2 - x_1)^2 - (y_2 - y_1)^2 + (x_1 + x_2) \cdot (x_2 - x_1)^2 \iff \\
0 & = (x_1 + x_2 + x_3) \cdot (x_2 - x_1)^2 - (y_2 - y_1)^2
\end{align*}
$$</p><p>And the same with the formula for $y_3$:</p><p class="scroll">$$
\begin{align*}
y_3 & = \lambda \cdot (x_1 - x_3) - y_1 \iff \\
y_3 & = \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big) \cdot (x_1 - x_3) - y_1 \iff \\
0 & = y_3 - \big((y_2 - y_1) \cdot (x_2 - x_1)^{-1}\big) \cdot (x_1 - x_3) + y_1 \iff \\
0 & = y_3 - (y_2 - y_1) \cdot (x_2 - x_1)^{-1} \cdot (x_1 - x_3) + y_1 \iff \\
0 & = y_3 \cdot (x_2 - x_1) - (y_2 - y_1) \cdot (x_1 - x_3) + y_1 \cdot (x_2 - x_1) \iff \\
0 & = (y_3 + y_1) \cdot (x_2 - x_1) - (y_2 - y_1) \cdot (x_1 - x_3)
\end{align*}
$$</p><p>Given the fact that we have more unknowns than equations, but the linear unknowns are bounded to $2^{32}$, we can use a lattice to solve a Shortest Vector Problem using LLL.</p><p>We will use a total of 6 PRNG outputs ($u_1$, $v_1$, $u_2$, $v_2$, $u_3$, and $v_3$), that is, 3 points ($W_1$, $W_2$ and $W_3$), and we can get 7 independent equations:</p><p class="scroll">$$
\begin{cases}
W_1 \in E(\mathbb{F}_p) \\
W_2 \in E(\mathbb{F}_p) \\
W_3 \in E(\mathbb{F}_p) \\
\\
W_2 - W_1 = G \quad \text{(for x and y)} \\
W_3 - W_2 = G \quad \text{(for x and y)}
\end{cases}
$$</p><p class="scroll">$$
\begin{cases}
(u_1 + a_1)^3 + a \cdot (u_1 + a_1) + b - (v_1 + b_1)^2 = 0 \mod{p} \\
(u_2 + a_2)^3 + a \cdot (u_2 + a_2) + b - (v_2 + b_2)^2 = 0 \mod{p} \\
(u_3 + a_3)^3 + a \cdot (u_3 + a_3) + b - (v_3 + b_3)^2 = 0 \mod{p} \\
\\
((u_1 + a_1) + (u_2 + a_2) + G_\mathrm{x}) \cdot ((u_2 + a_2) - (u_1 + a_1))^2 - ((v_2 + b_2) \color{red}{+} (v_1 + b_1))^2 = 0 \mod{p} \\
((u_2 + a_2) + (u_3 + a_3) + G_\mathrm{x}) \cdot ((u_3 + a_3) - (u_2 + a_2))^2 - ((v_3 + b_3) \color{red}{+} (v_2 + b_2))^2 = 0 \mod{p} \\
\\
(G_\mathrm{y} \color{red}{-} (v_1 + b_1)) \cdot ((u_2 + a_2) - (u_1 + a_1)) - ((v_2 + b_2) \color{red}{+} (v_1 + b_1)) \cdot ((u_1 + a_1) - G_\mathrm{x}) = 0 \mod{p} \\
(G_\mathrm{y} \color{red}{-} (v_2 + b_2)) \cdot ((u_3 + a_3) - (u_2 + a_2)) - ((v_3 + b_3) \color{red}{+} (v_2 + b_2)) \cdot ((u_2 + a_2) - G_\mathrm{x}) = 0 \mod{p}
\end{cases}
$$</p><p>The signs colored in red are to indicate that we are expressing $W_{n + 1} - W_n = G$, therefore $-W_n = (u_n + a_n, -v_n - b_n)$.</p><p>We can get rid of $\mod{p}$ by adding some integers $k_1, \dots, k_7$ multiplied by $p$:</p><p class="scroll">$$
\begin{cases}
(u_1 + a_1)^3 + a \cdot (u_1 + a_1) + b - (v_1 + b_1)^2 + k_1 \cdot p = 0 \\
(u_2 + a_2)^3 + a \cdot (u_2 + a_2) + b - (v_2 + b_2)^2 + k_2 \cdot p = 0 \\
(u_3 + a_3)^3 + a \cdot (u_3 + a_3) + b - (v_3 + b_3)^2 + k_3 \cdot p = 0 \\
\\
((u_1 + a_1) + (u_2 + a_2) + G_\mathrm{x}) \cdot ((u_2 + a_2) - (u_1 + a_1))^2 - ((v_2 + b_2) \color{red}{+} (v_1 + b_1))^2 + k_4 \cdot p = 0 \\
((u_2 + a_2) + (u_3 + a_3) + G_\mathrm{x}) \cdot ((u_3 + a_3) - (u_2 + a_2))^2 - ((v_3 + b_3) \color{red}{+} (v_2 + b_2))^2 + k_5 \cdot p = 0 \\
\\
(G_\mathrm{y} \color{red}{-} (v_1 + b_1)) \cdot ((u_2 + a_2) - (u_1 + a_1)) - ((v_2 + b_2) \color{red}{+} (v_1 + b_1)) \cdot ((u_1 + a_1) - G_\mathrm{x}) + k_6 \cdot p = 0 \\
(G_\mathrm{y} \color{red}{-} (v_2 + b_2)) \cdot ((u_3 + a_3) - (u_2 + a_2)) - ((v_3 + b_3) \color{red}{+} (v_2 + b_2)) \cdot ((u_2 + a_2) - G_\mathrm{x}) + k_7 \cdot p = 0
\end{cases}
$$</p><p>Obviously, we don&rsquo;t have only 6 unknowns, because there are interactions between variables (i.e. $a_1 \cdot a_2$ or $a_1^3$). However, these variables are also bounded and short when compared to $p$. As a result, we can use a lattice basis like this to determine the value of $a_1$, $b_1$, $a_2$, $b_2$, $a_3$ and $b_3$:</p><p class="scroll">$$
\begin{bmatrix}
{\begin{pmatrix}
p &   &        &   \\
      & p &    &   \\
      &   & \ddots &   \\
  &   &        & p
  \end{pmatrix}} & {\begin{pmatrix}
    \mathrm{eq}_1 \quad \mathrm{coefficients} \\
\mathrm{eq}_2 \quad \mathrm{coefficients} \\
\dots \\
\mathrm{eq}_7 \quad \mathrm{coefficients}
\end{pmatrix}} \\ \\
& {\begin{pmatrix}
      1 &   &   &   &         \\
        & 1 &     &   &         \\
        &   & \ddots &   &         \\
        &   &     & 1 &         \\
        &   &     &   & 2^{256}
  \end{pmatrix}}
\end{bmatrix}
$$</p><p>And the target vector is $(k_1, \dots, k_7,\dots, a_1, b_1, a_2, b_2, a_3, b_3, 2^{256})$, which is possible to get using LLL on the lattice basis matrix.</p><p>Once we have $a_1$, $b_1$, $a_2$, $b_2$, $a_3$ and $b_3$, we can find $W_1$, $W_2$ and $W_3$ to crack the PRNG.</p><h2 id="solution">Solution</h2><p>So, this is the outline to solve the challenge:</p><ul><li>We must run <code>unveil_secrets</code>, which needs an aggregated signature of all verified robots</li><li>We can use a rogue key attack to forge the signature</li><li>For this, we must provide a malicious public key, so we will be running <code>join</code></li><li>We need to verify the robot, that is, we need to prove that we have the secret key associated to the malicious public key</li><li>It is not easy to find a secret key that can generate the malicious public key, so we need to cheat in order to complete the zero-knowledge proof</li><li>For this, we need to know exactly what question is the server going to ask, so we need to crack the EC-LCG PRNG</li><li>We need $6$ outputs, so we can create a new robot ($5^\text{th}$ output), use it to list existing robots, and then join another robot with the malicious public key ($6^\text{th}$ output)</li></ul><h3 id="implementation">Implementation</h3><p>The interaction with the server is using JSON (except for the verification process), so we can use this function to send and receive JSON data:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">dumps</span><span class="mtk1">(</span><span class="mtk9 mtki">data</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">json</span><span class="mtk1">.</span><span class="mtk8">loads</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">())</span>
</code></pre></div><p>First, we create a robot and use it to list the rest:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'create'</span><span class="mtk1">})</span>
<span class="mtk1">sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'sk'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>

<span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'list'</span>
<span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Sign</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">, </span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk1">cmd</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">), </span><span class="mtk4">'sig'</span><span class="mtk1">: </span><span class="mtk1">sig</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  

<span class="mtk1">ids</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [], []</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">res</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">ids</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">Pks</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk8">decompress_G1</span><span class="mtk1">(</span><span class="mtk1">G1Compressed</span><span class="mtk1">(</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.get(</span><span class="mtk4">'pk'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">))))</span>
</code></pre></div><p>With the public keys, we can craft the malicious public key for the rogue key attack (<a target="_blank" href="https://pypi.org/project/py-ecc/"><code>py-ecc</code></a> makes it very easy to implement):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">sk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1337</span>
<span class="mtk1">cmd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'unveil_secrets'</span>
<span class="mtk1">pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">SkToPk</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">)</span>
<span class="mtk1">sig</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">bls</span><span class="mtk1">.</span><span class="mtk8">Sign</span><span class="mtk1">(</span><span class="mtk1">sk</span><span class="mtk1">, </span><span class="mtk1">cmd</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">Pk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">pubkey_to_G1</span><span class="mtk1">(</span><span class="mtk1">pk</span><span class="mtk1">)</span>

<span class="mtk1">Pk_prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">, </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk8">reduce</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1">, </span><span class="mtk1">Z1</span><span class="mtk1">)))</span>
<span class="mtk1">pk_prime</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">)</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">reduce</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">, </span><span class="mtk1">Pks</span><span class="mtk1">), </span><span class="mtk1">Pk_prime</span><span class="mtk1">)) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">Pk</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'Forged signature!'</span><span class="mtk1">)</span>
</code></pre></div><p>Now, we join this malicious public key and get the 6$^\mathrm{th}$ PRNG output:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'join'</span><span class="mtk1">, </span><span class="mtk4">'pk'</span><span class="mtk1">: </span><span class="mtk1">pk_prime</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  
<span class="mtk1">robot_id</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'robot_id'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">ids</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)</span>
<span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">ids</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">6</span>
</code></pre></div><p>Then, we crack the EC-LCG PRNG:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000001000000000000000000000000ffffffffff</span><span class="mtk6">ffffffffffffff</span>
<span class="mtk1">K</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> GF(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">K</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000001000000000000000000000000ffffffffff</span><span class="mtk6">fffffffffffffc</span><span class="mtk1">)</span>
<span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">K</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63b</span><span class="mtk6">ce3c3e27d2604b</span><span class="mtk1">)</span>
<span class="mtk1">E</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> EllipticCurve(</span><span class="mtk1">K</span><span class="mtk1">, (</span><span class="mtk1">a</span><span class="mtk1">, </span><span class="mtk1">b</span><span class="mtk1">))</span>
<span class="mtk1">G</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4</span><span class="mtk6">a13945d898c296</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececb</span><span class="mtk6">b6406837bf51f5</span><span class="mtk1">)</span>  
<span class="mtk1">E</span><span class="mtk1">.set_order(</span><span class="mtk7 mtki">0x</span><span class="mtk6">ffffffff00000000ffffffffffffffffbce6faada7179e84f3</span><span class="mtk6">b9cac2fc632551</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">crack_ec_lcg</span><span class="mtk1">(</span><span class="mtk9 mtki">values</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">values</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">u1</span><span class="mtk1">, </span><span class="mtk1">v1</span><span class="mtk1">, </span><span class="mtk1">u2</span><span class="mtk1">, </span><span class="mtk1">v2</span><span class="mtk1">, </span><span class="mtk1">u3</span><span class="mtk1">, </span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">values</span>
<span class="mtk1">    </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">b1</span><span class="mtk1">, </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">b2</span><span class="mtk1">, </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">b3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> PolynomialRing(</span><span class="mtk1">K</span><span class="mtk1">, </span><span class="mtk4">'a1, b1, a2, b2, a3, b3'</span><span class="mtk1">).gens()</span>

<span class="mtk1">    </span><span class="mtk1">ec1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">    </span><span class="mtk1">ec2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>
<span class="mtk1">    </span><span class="mtk1">ec3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">b</span>

<span class="mtk1">    </span><span class="mtk1">ec4</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x()) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">ec5</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x()) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">ec6</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">G</span><span class="mtk1">.y() </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x())</span>
<span class="mtk1">    </span><span class="mtk1">ec7</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk1">G</span><span class="mtk1">.y() </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> (</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">)) </span><span class="mtk5">-</span><span class="mtk1"> ((</span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)) </span><span class="mtk5">*</span><span class="mtk1"> ((</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">G</span><span class="mtk1">.x())</span>

<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1">, </span><span class="mtk1">v</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> Sequence([</span><span class="mtk1">ec1</span><span class="mtk1">, </span><span class="mtk1">ec2</span><span class="mtk1">, </span><span class="mtk1">ec3</span><span class="mtk1">, </span><span class="mtk1">ec4</span><span class="mtk1">, </span><span class="mtk1">ec5</span><span class="mtk1">, </span><span class="mtk1">ec6</span><span class="mtk1">, </span><span class="mtk1">ec7</span><span class="mtk1">]).coefficients_monomials(</span><span class="mtk9 mtki">sparse</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.change_ring(</span><span class="mtk6">ZZ</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (identity_matrix(</span><span class="mtk6">7</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">).augment(</span><span class="mtk1">A</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.stack(zero_matrix(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">), </span><span class="mtk6">7</span><span class="mtk1">).augment(identity_matrix(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">v</span><span class="mtk1">))))</span>
<span class="mtk1">    </span><span class="mtk1">A</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span>

<span class="mtk1">    </span><span class="mtk1">L</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">A</span><span class="mtk1">.T.LLL()</span>
<span class="mtk1">    </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk1">L</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1"> </span><span class="mtk6">256</span>
<span class="mtk1">    </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">b1</span><span class="mtk1">, </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">b2</span><span class="mtk1">, </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">b3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">L</span><span class="mtk1">[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk5">-</span><span class="mtk6">7</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">W1</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a1</span><span class="mtk1">, </span><span class="mtk1">v1</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">W2</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a2</span><span class="mtk1">, </span><span class="mtk1">v2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b2</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">W3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">E</span><span class="mtk1">(</span><span class="mtk1">u3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">a3</span><span class="mtk1">, </span><span class="mtk1">v3</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">b3</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">W3</span>
</code></pre></div><p>With this, we can cheat the ZKP protocol to verify the malicious public key:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">crack_ec_lcg</span><span class="mtk1">([</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk6">32</span><span class="mtk1"> </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">ids</span><span class="mtk1">])</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk4">'Cracked EC-LCG!'</span><span class="mtk1">)</span>

<span class="mtk1">prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Cheating ZKP'</span><span class="mtk1">)</span>
<span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'verify'</span><span class="mtk1">, </span><span class="mtk4">'robot_id'</span><span class="mtk1">: </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">robot_id</span><span class="mtk1">)})</span>

<span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">_</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">64</span><span class="mtk1"> </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk1">Wn</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">G</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">Wn</span><span class="mtk1">.xy():</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">c</span><span class="mtk1">) </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">32</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">x</span><span class="mtk1">)) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">, </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Give me x (hex): '</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">sk_x</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">urandom</span><span class="mtk1">(</span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">hex</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">C</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">))</span>
<span class="mtk1">            </span><span class="mtk5">assert</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk8">add</span><span class="mtk1">(</span><span class="mtk8">multiply</span><span class="mtk1">(</span><span class="mtk1">G1</span><span class="mtk1">, </span><span class="mtk1">sk_x</span><span class="mtk1">), </span><span class="mtk8">neg</span><span class="mtk1">(</span><span class="mtk1">Pk_prime</span><span class="mtk1">))) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk8">normalize</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">) </span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Take a random value x and send me C = x * G1 (hex</span><span class="mtk4">): '</span><span class="mtk1">, </span><span class="mtk8 mtku">bytes</span><span class="mtk1">(</span><span class="mtk8">G1_to_pubkey</span><span class="mtk1">(</span><span class="mtk1">C</span><span class="mtk1">)).</span><span class="mtk8">hex</span><span class="mtk1">().</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">            </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Give me (sk + x) (hex): '</span><span class="mtk1">, </span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">sk_x</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>

<span class="mtk1">prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">()</span>
</code></pre></div><p>Finally, we run the <code>unveil_secrets</code> command, with the malicious aggregated signature:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">res</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk1">cmd</span><span class="mtk1">, </span><span class="mtk4">'sig'</span><span class="mtk1">: </span><span class="mtk1">sig</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">()})</span>  
<span class="mtk8">sr</span><span class="mtk1">({</span><span class="mtk4">'cmd'</span><span class="mtk1">: </span><span class="mtk4">'exit'</span><span class="mtk1">})</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">res</span><span class="mtk1">.get(</span><span class="mtk4">'flag'</span><span class="mtk1">))</span>
</code></pre></div><h2 id="flag">Flag</h2><p>If we run the script, we will solve the challenge and get the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.59.199:57607
[<span class="code-green">+</span>] Opening connection to 94.237.59.199 on port 57607: Done
[<span class="code-green">+</span>] Forged signature!
[<span class="code-green">+</span>] Cracked EC-LCG!
[<span class="code-green">+</span>] Cheating ZKP: Done
[<span class="code-green">+</span>] HTB{EC-LCG_cr4ck3r_z3r0_kn0wl3dg3_ch34t3r_4nd_r0gue_k3y_4tt4ck3r!!}  
[<span class="code-blue">*</span>] Closed connection to 94.237.59.199 port 57607
</code></pre></div><p>The full script can be found in here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Crypto/Blessed/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#bls-signatures">BLS signatures</a></li><li><a href="#zero-knowledge-proof">Zero-knowledge proof</a></li><li><a href="#ec-lcg">EC-LCG</a></li></ul></li><li><a href="#solution">Solution</a><ul><li><a href="#implementation">Implementation</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>